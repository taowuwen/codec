cscope 15 $HOME/company/ems_client -q 0000003737 0000740062
	@inc/ems.h

3 #iâdeà
EMS_NET_HEADER___


4 
	#EMS_NET_HEADER___


	)

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

9 
	~<ùy³.h
>

11 #ifdeà
WIN32


12 
	~<wšdows.h
>

13 
	~<sys/ty³s.h
>

15 
	~<sys/ty³s.h
>

16 
	~<sys/sock‘.h
>

17 
	~<sys/un.h
>

18 
	~<uni¡d.h
>

19 
	~<Ãtš‘/š.h
>

20 
	~<Ãtš‘/tı.h
>

21 
	~<¬·/š‘.h
>

22 
	~<Ãtdb.h
>

23 
	~<¬·/Çme£r.h
>

24 
	~<»sŞv.h
>

25 
	~<”ºo.h
>

26 
	~<fú.h
>

30 
	~"ems_ty³s.h
"

31 
	~"ems_¡r.h
"

32 
	~"ems_queue.h
"

33 
	~"ems_uts.h
"

34 
	~"ems_block.h
"

36 #ifdeà
WIN32


37 
	~"ems_g‘İt.h
"

38 
	#g‘İt
 
ems_g‘İt


	)

41 
	#ems_m®loc
 
M®loc


	)

42 
	#ems_ä“
 
F»e


	)

43 
	#ems_¡rdup
 
STRDup


	)

44 
	#ems_»®loc
 
R—Îoc


	)

45 
	#ems_memdup
 
MEMDup


	)

46 
	#ems_as£¹
 
As£¹


	)

47 
	#ems_v®idblock
 
v®idBlock


	)

50 #ifdeà
WIN32


51 
	#ems_¦“p
(
x
è
	`SË•
((x)*1000)

	)

53 
	#ems_¦“p
 
¦“p


	)

	@inc/ems_block.h

2 #iâdeà
MEMERYMAP_BLOCK_INEWV


3 
	#MEMERYMAP_BLOCK_INEWV


	)

5 
	~<¡dio.h
>

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

10 #ifdeà
WIN32


11 
	tu32_t
;

12 
	tu8block_t
;

13 
	#SŒdup
 
_¡rdup


	)

15 
	tu32_t
;

16 
	tu8block_t
;

17 
	#SŒdup
 
¡rdup


	)

20 #iâdeà
YES


21 
	#YES
 1

	)

24 #iâdeà
NO


25 
	#NO
 0

	)

28 #iâdeà
ERR


29 
	#ERR
 -1

	)

32 #iâdeà
OK


33 
	#OK
 0

	)

36 #ifdeà
WIN32


38 #ià
defšed
 (
_MSC_VER
) && (_MSC_VER >= 1500)

39 
	#¢´štf
(
A
, 
B
, 
C
, ...è
	`_¢´štf_s
(A, B, 
_TRUNCATE
, C, ##
__VA_ARGS__
)

	)

40 
	#v¢´štf
(
A
,
B
,
C
,...è
	`_v¢´štf_s
(A, B, 
_TRUNCATE
, C, ##
__VA_ARGS__
)

	)

42 
	#¢´štf
 
_¢´štf


	)

43 
	#v¢´štf
 
_v¢´štf


	)

46 
	#¡ºÿ£cmp
 
_¡ºicmp


	)

49 #ifdeà
DEBUG


51 
	#G¬bage
 0x«

	)

52 
m_as£¹
(cÚ¡ *
func
, 
lše
);

53 *
m_m®loc
(
u32_t
 
sz
, cÚ¡ *
æ
, 
l
);

54 *
m_»Îoc
(*
bOld
, 
u32_t
 
sz
, cÚ¡ *
æ
, 
l
);

55 
m_ä“
(*
b
, cÚ¡ *
æ
, 
l
);

56 *
m_¡rdup
(cÚ¡ *
s
, cÚ¡ *
æ
, 
l
);

57 *
m_memdup
(
u8block_t
 *
b
, 
u32_t
 
Ën
, cÚ¡ *
æ
, 
l
);

59 #iâdeà
__FUNCTION__


60 
	#__FUNCTION__
 
__FILE__


	)

63 
	#M®loc
(
A
è
	`m_m®loc
(A, 
__FILE__
, 
__LINE__
)

	)

64 
	#R—Îoc
(
A
,
B
è
	`m_»Îoc
((*)A, B, 
__FILE__
, 
__LINE__
)

	)

65 
	#F»e
(
A
è
	`m_ä“
((*)(A), 
__FILE__
, 
__LINE__
)

	)

66 
	#As£¹
(
A
è\

	)

67 ià(
	gA
) {} \

69 
m_as£¹
(
__FUNCTION__
, 
__LINE__
);\

72 
	#STRDup
(
A
è
	`m_¡rdup
(A, 
__FILE__
, 
__LINE__
)

	)

73 
	#MEMDup
(
A
, 
L’
è
	`m_memdup
((
u8block_t
*)A, (
u32_t
èL’, 
__FILE__
, 
__LINE__
)

	)

75 
m_v®id_block
(*
b
, cÚ¡ *
func
, 
lše
);

76 
u32_t
 
sizeofBlock
(*
b
);

77 
£tRefBlock
(*
b
);

78 cÚ¡ *
descBlock
(*
b
);

80 
	#v®idBlock
(
A
è
	`m_v®id_block
((*)A, 
__FUNCTION__
, 
__LINE__
)

	)

84 
	#G¬bage
 0x00

	)

85 *
m_m®loc
(
u32_t
 
sz
);

86 *
m_»Îoc
(*
bOld
, 
u32_t
 
sz
);

87 
m_ä“
(*
b
);

88 *
m_memdup
(
u8block_t
 *
b
, 
u32_t
 
Ën
);

90 
	#M®loc
 
m_m®loc


	)

91 
	#R—Îoc
(
A
,
B
è
	`m_»Îoc
((*)A, B)

	)

92 
	#F»e
(
A
è
	`m_ä“
((*)A)

	)

93 
	#As£¹
(
A
)

	)

95 
	#STRDup
 
SŒdup


	)

96 
	#MEMDup
(
A
,
B
è
	`m_memdup
((
u8block_t
*)A, (
u32_t
)B)

	)

100 
¡¬tMemÜyT¿û
(
u£_th»ad_§ã
);

101 
checkMemÜyL—k
();

102 
¡İMemÜyT¿û
();

	@inc/ems_getopt.h

1 #iâdeà
EMS_GETOPT_H


2 
	#EMS_GETOPT_H


	)

5 #ifdeà
WIN32


6 
ems_g‘İt
(
Çrgc
, * cÚ¡ 
Çrgv
[], cÚ¡ *
o¡r
);

7 *
	gİrg
;

	@inc/ems_queue.h

2 #iâdeà
_EMS_QUEUE_H_INCLUDED_


3 
	#_EMS_QUEUE_H_INCLUDED_


	)

5 
	~<¡ddef.h
>

8 
ems_queue_s
 
	tems_queue_t
, 
	tems_li¡
, 
	tems_queue
;

10 
	sems_queue_s
 {

11 
ems_queue_t
 *
	m´ev
;

12 
ems_queue_t
 *
	mÃxt
;

16 
	#ems_queue_š™
(
q
) \

17 (
q
)->
´ev
 = q; \

18 (
q
)->
Ãxt
 = 
	)
q

21 
	#ems_queue_em±y
(
h
) \

22 (
h
 =ğ(h)->
´ev
)

	)

25 
	#ems_queue_š£¹_h—d
(
h
, 
x
) \

26 (
x
)->
Ãxt
 = (
h
)->next; \

27 (
x
)->
Ãxt
->
´ev
 = x; \

28 (
x
)->
´ev
 = 
h
; \

29 (
h
)->
Ãxt
 = 
x


	)

32 
	#ems_queue_š£¹_aá”
 
ems_queue_š£¹_h—d


	)

35 
	#ems_queue_š£¹_
(
h
, 
x
) \

36 (
x
)->
´ev
 = (
h
)->prev; \

37 (
x
)->
´ev
->
Ãxt
 = x; \

38 (
x
)->
Ãxt
 = 
h
; \

39 (
h
)->
´ev
 = 
x


	)

42 
	#ems_queue_h—d
(
h
) \

43 (
h
)->
Ãxt


	)

46 
	#ems_queue_Ï¡
(
h
) \

47 (
h
)->
´ev


	)

50 
	#ems_queue_£Áš–
(
h
) \

51 (
h
)

	)

54 
	#ems_queue_Ãxt
(
q
) \

55 (
q
)->
Ãxt


	)

58 
	#ems_queue_´ev
(
q
) \

59 (
q
)->
´ev


	)

62 #ià(
DEBUG
)

64 
	#ems_queue_»move
(
x
) \

65 (
x
)->
Ãxt
->
´ev
 = (x)->prev; \

66 (
x
)->
´ev
->
Ãxt
 = (x)->next; \

67 (
x
)->
´ev
 = 
NULL
; \

68 (
x
)->
Ãxt
 = 
NULL


	)

72 
	#ems_queue_»move
(
x
) \

73 (
x
)->
Ãxt
->
´ev
 = (x)->prev; \

74 (
x
)->
´ev
->
Ãxt
 = (x)->
	)
next

79 
	#ems_queue_¥l™
(
h
, 
q
, 
n
) \

80 (
n
)->
´ev
 = (
h
)->prev; \

81 (
n
)->
´ev
->
Ãxt
 =‚; \

82 (
n
)->
Ãxt
 = 
q
; \

83 (
h
)->
´ev
 = (
q
)->prev; \

84 (
h
)->
´ev
->
Ãxt
 = h; \

85 (
q
)->
´ev
 = 
n
;

	)

88 
	#ems_queue_add
(
h
, 
n
) \

89 (
h
)->
´ev
->
Ãxt
 = (
n
)->next; \

90 (
n
)->
Ãxt
->
´ev
 = (
h
)->prev; \

91 (
h
)->
´ev
 = (
n
)->prev; \

92 (
h
)->
´ev
->
Ãxt
 = h;

	)

95 
	#ems_queue_d©a
(
q
, 
ty³
, 
lšk
) \

96 (
ty³
 *è((*è
q
 - 
	`off£tof
Ñy³, 
lšk
))

	)

98 
	#ems_queue_Ën
(
li¡
, 
Ën
) do{ \

99 
ems_queue
 *
p
; \

100 
Ën
 = 0; \

101 
	`ems_queue_fÜ—ch
(
li¡
, 
p
è{ 
Ën
++; } \

102 } 0)

	)

105 
	#ems_cÚš”_of
 
ems_queue_d©a


	)

107 
	#ems_queue_ş—r
(
queue
, 
ty³
, 
lšk
, 
de¡roy
) do { \

108 
ems_queue
 *
n
; \

109 !
	`ems_queue_em±y
(
queue
)) { \

110 
n
 = 
	`ems_queue_h—d
(
queue
); \

111 
	`ems_queue_»move
(
n
); \

112 
	`de¡roy
(
	`ems_queue_d©a
(
n
, 
ty³
, 
lšk
)); \

114 }0)

	)

117 
	#ems_queue_ş—n
(
queue
) do { \

118 
ems_queue
 *
n
; \

119 !
	`ems_queue_em±y
(
queue
)) { \

120 
n
 = 
	`ems_queue_h—d
(
queue
); \

121 
	`ems_queue_»move
(
n
); \

123 } 0)

	)

129 
	#ems_queue_fÜ—ch
(
q
, 
n
) \

130 
n
 = 
	`ems_queue_h—d
(
q
); \

131 
n
 !ğ
	`ems_queue_£Áš–
(
q
); \

132 
n
 = 
	`ems_queue_Ãxt
Ò))

	)

134 
	#ems_queue_fÜ—ch_§ã
(
q
, 
cur
, 
Ãxt
) \

135 
cur
 = 
	`ems_queue_h—d
(
q
), 
Ãxt
 = 
	`ems_queue_Ãxt
(cur); \

136 
cur
 !ğ
	`ems_queue_£Áš–
(
q
); \

137 
cur
 = 
Ãxt
,‚exˆğ
	`ems_queue_Ãxt
(cur))

	)

	@inc/ems_str.h

2 #iâdeà
EMS_NET_STRING_CONTROL_HEADER___


3 
	#EMS_NET_STRING_CONTROL_HEADER___


	)

5 
	~"ems_ty³s.h
"

8 
ems_ušt
 
	mËn
;

9 
ems_uch¬
 *
	md©a
;

10 } 
	tems_¡r
;

13 #ifdeà
WIN32


15 #ià
defšed
 (
_MSC_VER
) && (_MSC_VER >= 1500)

16 
	#¢´štf
(
A
, 
B
, 
C
, ...è\

	)

17 
_¢´štf_s
(
A
, 
B
, 
_TRUNCATE
, 
C
, ##
__VA_ARGS__
)

18 
	#v¢´štf
(
A
,
B
,
C
,...è\

	)

19 
_v¢´štf_s
(
A
, 
B
, 
_TRUNCATE
, 
C
, ##
__VA_ARGS__
)

21 
	#¢´štf
 
_¢´štf


	)

22 
	#v¢´štf
 
_v¢´štf


	)

25 
	#¡ºÿ£cmp
 
_¡ºicmp


	)

26 
	#¡rÿ£cmp
 
_¡ricmp


	)

30 
ems_št
 
¡r_£t
(
ems_¡r
 *
¡r
, 
ems_cch¬
 *
‹xt
);

31 
ems_void
 
¡r_ş—r
(
ems_¡r
 *
¡r
);

33 
	#¡r_unš™
 
¡r_ş—r


	)

34 
	#¡r_š™
(
¡r
è(¡r)->
Ën
 = 0; (¡r)->
d©a
 = 
NULL


	)

35 
	#¡r_‹xt
(
¡r
è(
ems_cch¬
 *)((¡r)->
d©a
)

	)

36 
	#¡r_Ën
(
¡r
è(¡r)->
Ën


	)

38 
	#¡r_ıy
(
d¡
, 
¤c
è
	`¡r_£t
(d¡, 
	`¡r_‹xt
(¤c))

	)

43 
	#ems_¡ršg
(
¡r
è{ (¡rè- 1, (
ems_uch¬
 *)¡¸}

	)

44 
	#ems_nuÎ_¡ršg
 {0, 
NULL
}

	)

45 
	#ems_¡r_£t
(
¡r
, 
‹xt
è\

	)

46 (
	g¡r
)->
	gËn
 = 
¡¾’
(
‹xt
); (¡r)->
	gd©a
 =(
ems_uch¬
 *)text

	@inc/ems_types.h

2 #iâdeà
EMS_NET_TYPES_HEADERS___


3 
	#EMS_NET_TYPES_HEADERS___


	)

7 
	tems_št
;

8 
	tems_ušt
;

9 
	tems_void
;

10 
	tems_uch¬
;

11 cÚ¡ 
	tems_cch¬
;

12 
	tems_ch¬
;

13 
	tems_ulÚg
;

14 
	tems_lÚg
;

15 
	tems_ushÜt
;

16 
	tems_shÜt
;

20 
	#EMS_ERR_SUCCESS
 0

	)

21 
	#EMS_ERR_UNKNOWN
 -1

	)

22 
	#EMS_ERR_TICKET_EXIST
 -2

	)

23 
	#EMS_ERR_TICKET_NOT_EXIST
 -3

	)

24 
	#EMS_ERR_ACTIVE_CODD_ALREADY_REGISTED
 -4

	)

25 
	#EMS_ERR_CONNECT_TIMEOUT
 -5

	)

26 
	#EMS_ERR_WAIT_TIMEOUT
 -6

	)

27 
	#EMS_ERR_HANDLE_OVERTIME
 -7

	)

28 
	#EMS_ERR_INVALID_ARG
 -8

	)

32 
	#EMS_OK
 
EMS_ERR_SUCCESS


	)

33 
	#EMS_ERR
 
EMS_ERR_UNKNOWN


	)

35 
ems_cch¬
 *
ems_g‘”rmsg
(
ems_št
 
”r
);

36 
	#ems_Ï¡”r
(è
”ºo


	)

37 
	#ems_Ï¡”rmsg
(è
	`ems_g‘”rmsg
(
	`ems_Ï¡”r
())

	)

	@inc/ems_utils.h

2 #iâdeà 
EMS_NETWORK_UTILS__HEADER___


3 
	#EMS_NETWORK_UTILS__HEADER___


	)

6 #ifdeà
WIN32


7 
	~<wšdows.h
>

9 
	~<sys/time.h
>

10 
	~<uni¡d.h
>

11 
	~<±h»ad.h
>

12 
	~<sys/ty³s.h
>

13 
	~<sys/wa™.h
>

16 #ifdeà
WIN32


17 
DWORD
 
	tems_th»adid
;

18 
PVOID
 
	tems_th»ad¬g
;

19 
DWORD
 
	tems_´oûssid
;

21 
±h»ad_t
 
	tems_th»adid
;

22 * 
	tems_th»ad¬g
;

23 
	tems_´oûssid
;

27 #ifdeà
WIN32


28 
	#ems_g‘pid
(è(()
	`G‘Cu¼’tProûssId
())

	)

29 
	#ems_g‘tid
(è(()
	`G‘Cu¼’tTh»adId
())

	)

30 #–ià
defšed
 (
__APPLE__
)

31 
	#ems_g‘pid
(è(()
	`g‘pid
())

	)

32 
	#ems_g‘tid
(è()
	`±h»ad_£lf
()

	)

34 
	#ems_g‘pid
(è(()
	`g‘pid
())

	)

35 
	#ems_g‘tid
(è()
	`±h»ad_£lf
()

	)

39 #ifdeà
WIN32


40 
	#ems_mtx
 
HANDLE


	)

42 
	#ems_mtx
 
±h»ad_mu‹x_t


	)

45 #ifdeà
WIN32


46 
	#ems_mtx_lock
(
A
è
	`Wa™FÜSšgËObjeù
(A, 
INFINITE
)

	)

47 
	#ems_mtx_uÆock
(
A
è
	`R–—£Mu‹x
(A)

	)

48 
	#ems_mtx_š™
(
A
è(A = 
	`C»©eMu‹x
(
NULL
, 
FALSE
, NULL))

	)

49 
	#ems_mtx_de¡roy
(
A
è
	`Clo£HªdË
(A)

	)

51 
	#ems_mtx_lock
(
A
è
	`±h»ad_mu‹x_lock
(&A)

	)

52 
	#ems_mtx_uÆock
(
A
è
	`±h»ad_mu‹x_uÆock
(&A)

	)

53 
	#ems_mtx_š™
(
A
è
	`±h»ad_mu‹x_š™
(&A, 
NULL
)

	)

54 
	#ems_mtx_de¡roy
(
A
è
	`±h»ad_mu‹x_de¡roy
(&A)

	)

57 
	#OK
 0

	)

58 
	#ERR
 -1

	)

59 
	#YES
 1

	)

60 
	#NO
 0

	)

62 
ems_ch¬
 *
ems_Œim
Óms_ch¬ *
¤c
);

68 *(*
	tth»ad_’Œy
)(
	tems_th»ad¬g
);

69 
ems_št
 
ems_th»adü—‹
(
ems_th»adid
 *
tid
, 
th»ad_’Œy
 
func
, 
ems_th»ad¬g
 
¬g
);

70 
ems_št
 
ems_th»adjoš
(
ems_th»adid
 
tid
);

71 
ems_št
 
ems_£ŠÚblockšg
Óms_šˆ
sockfd
,ƒms_šˆ
yes
);

72 
ems_št
 
ems_g‘ho¡byÇme
(
ems_cch¬
 *
domaš
, 
sockaddr_š
 *
d¡
);

74 
ems_št
 
ems_bš2¡r
(
ems_cch¬
 *
s
,ƒms_šˆ
Ën
, 
ems_ch¬
 *
d
,ƒms_šˆ
d_l
);

75 
ems_št
 
ems_¡r2bš
(
ems_cch¬
 *
s
, 
ems_ch¬
 *
d
,ƒms_šˆ
d_l
);

77 
ems_št
 
ems_ıucÜe
();

78 
ems_št
 
ems_·gesize
();

79 
ems_void
 
ems_´šthex
(
ems_cch¬
 *
s
, 
ems_št
 
Ën
);

80 
ems_št
 
ems_memu§ge
();

81 
ems_št
 
ems_ıuu§ge
();

82 
ems_št
 
ems_»£t_¾im™
();

84 
ems_cch¬
 *
ems_™ß
(
ems_št
 
i
);

85 
ems_št
 
ems_©oi
(
ems_cch¬
 *
a
);

87 
ems_ch¬
 *
u¾_’code
(
ems_cch¬
 *
¤c
, 
ems_št
 
l¡r
);

88 
ems_ch¬
 *
u¾_decode
Óms_ch¬ *
¤c
, 
ems_št
 
l¡r
);

	@json/arraylist.c

12 
	~"jcÚfig.h
"

14 #ifdeà
STDC_HEADERS


15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

19 #ià
defšed
(
HAVE_STRINGS_H
è&& !defšed(
_STRING_H
è&& !defšed(
__USE_BSD
)

20 
	~<¡ršgs.h
>

23 
	~"b™s.h
"

24 
	~"¬¿yli¡.h
"

26 
¬¿y_li¡
*

27 
	$¬¿y_li¡_Ãw
(
¬¿y_li¡_ä“_â
 *
ä“_â
)

29 
¬¿y_li¡
 *
¬r
;

31 
¬r
 = (
¬¿y_li¡
*)
	`ÿÎoc
(1, (array_list));

32 if(!
¬r
è 
NULL
;

33 
¬r
->
size
 = 
ARRAY_LIST_DEFAULT_SIZE
;

34 
¬r
->
Ëngth
 = 0;

35 
¬r
->
ä“_â
 = free_fn;

36 if(!(
¬r
->
¬¿y
 = (**)
	`ÿÎoc
((*),‡¼->
size
))) {

37 
	`ä“
(
¬r
);

38  
NULL
;

40  
¬r
;

41 
	}
}

44 
	$¬¿y_li¡_ä“
(
¬¿y_li¡
 *
¬r
)

46 
i
;

47 
i
 = 0; i < 
¬r
->
Ëngth
; i++)

48 if(
¬r
->
¬¿y
[
i
]è¬r->
	`ä“_â
(arr->array[i]);

49 
	`ä“
(
¬r
->
¬¿y
);

50 
	`ä“
(
¬r
);

51 
	}
}

54 
	$¬¿y_li¡_g‘_idx
(
¬¿y_li¡
 *
¬r
, 
i
)

56 if(
i
 >ğ
¬r
->
Ëngth
è 
NULL
;

57  
¬r
->
¬¿y
[
i
];

58 
	}
}

60 
	$¬¿y_li¡_ex·nd_š‹º®
(
¬¿y_li¡
 *
¬r
, 
max
)

62 *
t
;

63 
Ãw_size
;

65 if(
max
 < 
¬r
->
size
)  0;

66 
Ãw_size
 = 
	`jsÚ_max
(
¬r
->
size
 << 1, 
max
);

67 if(!(
t
 = 
	`»®loc
(
¬r
->
¬¿y
, 
Ãw_size
*(*))))  -1;

68 
¬r
->
¬¿y
 = (**)
t
;

69 ()
	`mem£t
(
¬r
->
¬¿y
 +‡¼->
size
, 0, (
Ãw_size
-arr->size)*(*));

70 
¬r
->
size
 = 
Ãw_size
;

72 
	}
}

75 
	$¬¿y_li¡_put_idx
(
¬¿y_li¡
 *
¬r
, 
idx
, *
d©a
)

77 if(
	`¬¿y_li¡_ex·nd_š‹º®
(
¬r
, 
idx
+1))  -1;

78 if(
¬r
->
¬¿y
[
idx
]è¬r->
	`ä“_â
(arr->array[idx]);

79 
¬r
->
¬¿y
[
idx
] = 
d©a
;

80 if(
¬r
->
Ëngth
 <ğ
idx
)‡rr->length = idx + 1;

82 
	}
}

85 
	$¬¿y_li¡_add
(
¬¿y_li¡
 *
¬r
, *
d©a
)

87  
	`¬¿y_li¡_put_idx
(
¬r
,‡¼->
Ëngth
, 
d©a
);

88 
	}
}

91 
¬¿y_li¡_sÜt
(
¬¿y_li¡
 *
¬r
, (*
sÜt_â
)(const *, const *))

93 
	`qsÜt
(
¬r
->
¬¿y
,‡¼->
Ëngth
, (arr->array[0]),

94 ((*)(cÚ¡ *, cÚ¡ *))
sÜt_â
);

95 
	}
}

98 
	$¬¿y_li¡_Ëngth
(
¬¿y_li¡
 *
¬r
)

100  
¬r
->
Ëngth
;

101 
	}
}

	@json/arraylist.h

12 #iâdeà
_¬¿yli¡_h_


13 
	#_¬¿yli¡_h_


	)

15 #ifdeà
__ılu¥lus


19 
	#ARRAY_LIST_DEFAULT_SIZE
 32

	)

21 (
¬¿y_li¡_ä“_â
è(*
	td©a
);

23 
	s¬¿y_li¡


25 **
¬¿y
;

26 
Ëngth
;

27 
size
;

28 
¬¿y_li¡_ä“_â
 *
ä“_â
;

31 
¬¿y_li¡
*

32 
¬¿y_li¡_Ãw
(
¬¿y_li¡_ä“_â
 *
ä“_â
);

35 
¬¿y_li¡_ä“
(
¬¿y_li¡
 *
®
);

38 
¬¿y_li¡_g‘_idx
(
¬¿y_li¡
 *
®
, 
i
);

41 
¬¿y_li¡_put_idx
(
¬¿y_li¡
 *
®
, 
i
, *
d©a
);

44 
¬¿y_li¡_add
(
¬¿y_li¡
 *
®
, *
d©a
);

47 
¬¿y_li¡_Ëngth
(
¬¿y_li¡
 *
®
);

50 
¬¿y_li¡_sÜt
(
¬¿y_li¡
 *
¬r
, (*
com·r
)(const *, const *));

52 #ifdeà
__ılu¥lus


	@json/bits.h

12 #iâdeà
_b™s_h_


13 
	#_b™s_h_


	)

15 #iâdeà
jsÚ_mš


16 
	#jsÚ_mš
(
a
,
b
è(×è< (bè? (aè: (b))

	)

19 #iâdeà
jsÚ_max


20 
	#jsÚ_max
(
a
,
b
è(×è> (bè? (aè: (b))

	)

23 
	#hexdig™
(
x
è(((xè<ğ'9'è? (xè- '0' : ((xè& 7è+ 9)

	)

24 
	#”rÜ_±r
(
”rÜ
è((*ë¼Ü)

	)

25 
	#”rÜ_desütiÚ
(
”rÜ
è(
jsÚ_tok’”_”rÜs
[”rÜ])

	)

26 
	#is_”rÜ
(
±r
èÕŒ =ğ
NULL
)

	)

	@json/debug.c

12 
	~"jcÚfig.h
"

14 
	~<¡dio.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

17 
	~<¡d¬g.h
>

19 #ià
HAVE_SYSLOG_H


20 
	~<sy¦og.h
>

23 #ià
HAVE_UNISTD_H


24 
	~<uni¡d.h
>

27 #ià
HAVE_SYS_PARAM_H


28 
	~<sys/·¿m.h
>

31 
	~"debug.h
"

33 
	g_sy¦og
 = 0;

34 
	g_debug
 = 0;

36 
	$mc_£t_debug
(
debug
è{ 
_debug
 = debug; 
	}
}

37 
	$mc_g‘_debug
(è{  
_debug
; 
	}
}

39 
	$mc_£t_sy¦og
(
sy¦og
)

41 
_sy¦og
 = 
sy¦og
;

42 
	}
}

44 
	$mc_abÜt
(cÚ¡ *
msg
, ...)

46 
va_li¡
 
­
;

47 
	`va_¡¬t
(
­
, 
msg
);

48 #ià
HAVE_VSYSLOG


49 if(
_sy¦og
) {

50 
	`vsy¦og
(
LOG_ERR
, 
msg
, 
­
);

53 
	`v´štf
(
msg
, 
­
);

54 
	`va_’d
(
­
);

55 
	`ex™
(1);

56 
	}
}

59 
	$mc_debug
(cÚ¡ *
msg
, ...)

61 
va_li¡
 
­
;

62 if(
_debug
) {

63 
	`va_¡¬t
(
­
, 
msg
);

64 #ià
HAVE_VSYSLOG


65 if(
_sy¦og
) {

66 
	`vsy¦og
(
LOG_DEBUG
, 
msg
, 
­
);

69 
	`v´štf
(
msg
, 
­
);

70 
	`va_’d
(
­
);

72 
	}
}

74 
	$mc_”rÜ
(cÚ¡ *
msg
, ...)

76 
va_li¡
 
­
;

77 
	`va_¡¬t
(
­
, 
msg
);

78 #ià
HAVE_VSYSLOG


79 if(
_sy¦og
) {

80 
	`vsy¦og
(
LOG_ERR
, 
msg
, 
­
);

83 
	`vårštf
(
¡d”r
, 
msg
, 
­
);

84 
	`va_’d
(
­
);

85 
	}
}

87 
	$mc_šfo
(cÚ¡ *
msg
, ...)

89 
va_li¡
 
­
;

90 
	`va_¡¬t
(
­
, 
msg
);

91 #ià
HAVE_VSYSLOG


92 if(
_sy¦og
) {

93 
	`vsy¦og
(
LOG_INFO
, 
msg
, 
­
);

96 
	`vårštf
(
¡d”r
, 
msg
, 
­
);

97 
	`va_’d
(
­
);

98 
	}
}

	@json/debug.h

13 #iâdeà
_DEBUG_H_


14 
	#_DEBUG_H_


	)

16 
	~<¡dlib.h
>

18 #ifdeà
__ılu¥lus


22 
mc_£t_debug
(
debug
);

23 
mc_g‘_debug
();

25 
mc_£t_sy¦og
(
sy¦og
);

26 
mc_abÜt
(cÚ¡ *
msg
, ...);

27 
mc_debug
(cÚ¡ *
msg
, ...);

28 
mc_”rÜ
(cÚ¡ *
msg
, ...);

29 
mc_šfo
(cÚ¡ *
msg
, ...);

31 #iâdeà
__STRING


32 
	#__STRING
(
x
è#x

	)

35 #iâdeà
PARSER_BROKEN_FIXED


37 
	#JASSERT
(
cÚd
èdØ{} 0)

	)

41 
	#JASSERT
(
cÚd
) do { \

42 ià(!(
cÚd
)) { \

43 
	`mc_”rÜ
("cjsÚ‡s£¹ fau» %s:%d : cÚd \"" 
	`__STRING
(
cÚd
è"çed\n", 
__FILE__
, 
__LINE__
); \

45 
	`abÜt
(); \

47 } 0)

	)

51 
	#MC_ABORT
(
x
, ...è
	`mc_abÜt
(x, ##
__VA_ARGS__
)

	)

52 
	#MC_ERROR
(
x
, ...è
	`mc_”rÜ
(x, ##
__VA_ARGS__
)

	)

54 #ifdeà
MC_MAINTAINER_MODE


55 
	#MC_SET_DEBUG
(
x
è
	`mc_£t_debug
(x)

	)

56 
	#MC_GET_DEBUG
(è
	`mc_g‘_debug
()

	)

57 
	#MC_SET_SYSLOG
(
x
è
	`mc_£t_sy¦og
(x)

	)

58 
	#MC_DEBUG
(
x
, ...è
	`mc_debug
(x, ##
__VA_ARGS__
)

	)

59 
	#MC_INFO
(
x
, ...è
	`mc_šfo
(x, ##
__VA_ARGS__
)

	)

61 
	#MC_SET_DEBUG
(
x
èià(0è
	`mc_£t_debug
(x)

	)

62 
	#MC_GET_DEBUG
(è(0)

	)

63 
	#MC_SET_SYSLOG
(
x
èià(0è
	`mc_£t_sy¦og
(x)

	)

64 
	#MC_DEBUG
(
x
, ...èià(0è
	`mc_debug
(x, ##
__VA_ARGS__
)

	)

65 
	#MC_INFO
(
x
, ...èià(0è
	`mc_šfo
(x, ##
__VA_ARGS__
)

	)

68 #ifdeà
__ılu¥lus


	@json/example/test1.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ddef.h
>

4 
	~<¡ršg.h
>

6 
	~"jsÚ.h
"

8 
	$maš
(
¬gc
, **
¬gv
)

10 
jsÚ_tok’”
 *
tok
;

11 
jsÚ_objeù
 *
my_¡ršg
, *
my_št
, *
my_objeù
, *
my_¬¿y
;

12 
jsÚ_objeù
 *
Ãw_obj
;

13 
i
;

15 
	`MC_SET_DEBUG
(1);

17 
my_¡ršg
 = 
	`jsÚ_objeù_Ãw_¡ršg
("\t");

18 
	`´štf
("my_¡ršg=%s\n", 
	`jsÚ_objeù_g‘_¡ršg
(
my_¡ršg
));

19 
	`´štf
("my_¡ršg.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_¡ršg
));

20 
	`jsÚ_objeù_put
(
my_¡ršg
);

22 
my_¡ršg
 = 
	`jsÚ_objeù_Ãw_¡ršg
("\\");

23 
	`´štf
("my_¡ršg=%s\n", 
	`jsÚ_objeù_g‘_¡ršg
(
my_¡ršg
));

24 
	`´štf
("my_¡ršg.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_¡ršg
));

25 
	`jsÚ_objeù_put
(
my_¡ršg
);

27 
my_¡ršg
 = 
	`jsÚ_objeù_Ãw_¡ršg
("foo");

28 
	`´štf
("my_¡ršg=%s\n", 
	`jsÚ_objeù_g‘_¡ršg
(
my_¡ršg
));

29 
	`´štf
("my_¡ršg.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_¡ršg
));

31 
my_št
 = 
	`jsÚ_objeù_Ãw_št
(9);

32 
	`´štf
("my_št=%d\n", 
	`jsÚ_objeù_g‘_št
(
my_št
));

33 
	`´štf
("my_št.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_št
));

35 
my_¬¿y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

36 
	`jsÚ_objeù_¬¿y_add
(
my_¬¿y
, 
	`jsÚ_objeù_Ãw_št
(1));

37 
	`jsÚ_objeù_¬¿y_add
(
my_¬¿y
, 
	`jsÚ_objeù_Ãw_št
(2));

38 
	`jsÚ_objeù_¬¿y_add
(
my_¬¿y
, 
	`jsÚ_objeù_Ãw_št
(3));

39 
	`jsÚ_objeù_¬¿y_put_idx
(
my_¬¿y
, 4, 
	`jsÚ_objeù_Ãw_št
(5));

40 
	`´štf
("my_array=\n");

41 
i
=0; i < 
	`jsÚ_objeù_¬¿y_Ëngth
(
my_¬¿y
); i++) {

42 
jsÚ_objeù
 *
obj
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
my_¬¿y
, 
i
);

43 
	`´štf
("\t[%d]=%s\n", 
i
, 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
obj
));

45 
	`´štf
("my_¬¿y.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_¬¿y
));

47 
my_objeù
 = 
	`jsÚ_objeù_Ãw_objeù
();

48 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "abc", 
	`jsÚ_objeù_Ãw_št
(12));

49 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "foo", 
	`jsÚ_objeù_Ãw_¡ršg
("bar"));

50 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "boŞ0", 
	`jsÚ_objeù_Ãw_boŞ—n
(0));

51 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "boŞ1", 
	`jsÚ_objeù_Ãw_boŞ—n
(1));

52 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "baz", 
	`jsÚ_objeù_Ãw_¡ršg
("bang"));

53 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "baz", 
	`jsÚ_objeù_Ãw_¡ršg
("fark"));

54 
	`jsÚ_objeù_objeù_d–
(
my_objeù
, "baz");

56 
	`´štf
("my_object=\n");

57 
	`jsÚ_objeù_objeù_fÜ—ch
(
my_objeù
, 
key
, 
v®
) {

58 
	`´štf
("\t%s: %s\n", 
key
, 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
v®
));

60 
	`´štf
("my_objeù.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_objeù
));

62 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("\"\003\"");

63 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

64 
	`jsÚ_objeù_put
(
Ãw_obj
);

66 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("/* hello */\"foo\"");

67 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

68 
	`jsÚ_objeù_put
(
Ãw_obj
);

70 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("// hello\n\"foo\"");

71 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

72 
	`jsÚ_objeù_put
(
Ãw_obj
);

74 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("\"\\u0041\\u0042\\u0043\"");

75 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

76 
	`jsÚ_objeù_put
(
Ãw_obj
);

78 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("null");

79 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

80 
	`jsÚ_objeù_put
(
Ãw_obj
);

82 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("True");

83 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

84 
	`jsÚ_objeù_put
(
Ãw_obj
);

86 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("12");

87 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

88 
	`jsÚ_objeù_put
(
Ãw_obj
);

90 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("12.3");

91 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

92 
	`jsÚ_objeù_put
(
Ãw_obj
);

94 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[\"\\n\"]");

95 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

96 
	`jsÚ_objeù_put
(
Ãw_obj
);

98 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[\"\\nabc\\n\"]");

99 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

100 
	`jsÚ_objeù_put
(
Ãw_obj
);

102 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[null]");

103 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

104 
	`jsÚ_objeù_put
(
Ãw_obj
);

106 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[]");

107 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

108 
	`jsÚ_objeù_put
(
Ãw_obj
);

110 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[false]");

111 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

112 
	`jsÚ_objeù_put
(
Ãw_obj
);

114 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[\"abc\",null,\"def\",12]");

115 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

116 
	`jsÚ_objeù_put
(
Ãw_obj
);

118 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{}");

119 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

120 
	`jsÚ_objeù_put
(
Ãw_obj
);

122 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ \"foo\": \"bar\" }");

123 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

124 
	`jsÚ_objeù_put
(
Ãw_obj
);

126 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ \"foo\": \"bar\", \"baz\":‚ull, \"bool0\":rue }");

127 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

128 
	`jsÚ_objeù_put
(
Ãw_obj
);

130 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ \"foo\": [null, \"foo\"] }");

131 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

132 
	`jsÚ_objeù_put
(
Ãw_obj
);

134 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ \"abc\": 12, \"foo\": \"bar\", \"bool0\": false, \"bool1\":rue, \"arr\": [ 1, 2, 3,‚ull, 5 ] }");

135 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

136 
	`jsÚ_objeù_put
(
Ãw_obj
);

138 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ foo }");

139 if(
	`is_”rÜ
(
Ãw_obj
)è
	`´štf
("gotƒrror‡sƒxpected\n");

141 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("foo");

142 if(
	`is_”rÜ
(
Ãw_obj
)è
	`´štf
("gotƒrror‡sƒxpected\n");

144 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ \"foo");

145 if(
	`is_”rÜ
(
Ãw_obj
)è
	`´štf
("gotƒrror‡sƒxpected\n");

148 
tok
 = 
	`jsÚ_tok’”_Ãw
();

149 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£_ex
(
tok
, "{ \"foo", 6);

150 if(
	`is_”rÜ
(
Ãw_obj
)è
	`´štf
("gotƒrror‡sƒxpected\n");

151 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£_ex
(
tok
, "\": {\"bar", 8);

152 if(
	`is_”rÜ
(
Ãw_obj
)è
	`´štf
("gotƒrror‡sƒxpected\n");

153 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£_ex
(
tok
, "\":13}}", 6);

154 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

155 
	`jsÚ_objeù_put
(
Ãw_obj
);

156 
	`jsÚ_tok’”_ä“
(
tok
);

158 
	`jsÚ_objeù_put
(
my_¡ršg
);

159 
	`jsÚ_objeù_put
(
my_št
);

160 
	`jsÚ_objeù_put
(
my_objeù
);

164 
	}
}

	@json/example/test2.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ddef.h
>

4 
	~<¡ršg.h
>

6 
	~"jsÚ.h
"

9 
	$maš
(
¬gc
, **
¬gv
)

11 
jsÚ_objeù
 *
Ãw_obj
;

13 
	`MC_SET_DEBUG
(1);

15 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("/* more difficultest case */ { \"glossary\": { \"title\": \"example glossary\", \"GlossDiv\": { \"title\": \"S\", \"GlossList\": [ { \"ID\": \"SGML\", \"SortAs\": \"SGML\", \"GlossTerm\": \"Standard Generalized Markup Language\", \"Acronym\": \"SGML\", \"Abbrev\": \"ISO 8879:1986\", \"GlossDef\": \"A meta-markup†anguage, usedo create markup†anguages such‡s DocBook.\", \"GlossSeeAlso\": [\"GML\", \"XML\", \"markup\"] } ] } } }");

16 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

17 
	`jsÚ_objeù_put
(
Ãw_obj
);

20 
	}
}

	@json/example/test3.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

4 
	~"jsÚ.h
"

7 
	$maš
()

9 
jsÚ_objeù
 *
jobj
;

10 *
šput
 = (*)
	`m®loc
(1024);

12 
	`fg‘s
(
šput
, 1024, 
¡dš
è!ğ
NULL
) {

13 
jobj
 = 
	`jsÚ_tok’”_·r£
(
šput
);

14 ià(
	`is_”rÜ
(
jobj
)) {

15 
	`´štf
("error…arsing json: %s\n",

16 
jsÚ_tok’”_”rÜs
[-()
jobj
]);

18 
	`´štf
("%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
jobj
));

19 
	`jsÚ_objeù_put
(
jobj
);

23 
	}
}

	@json/example/tests/parse_flags.c

1 
	~"jcÚfig.h
"

3 
	~<¡dio.h
>

4 
	~<¡ršg.h
>

6 
	~"jsÚ.h
"

7 
	~"·r£_æags.h
"

9 #ià!
defšed
(
HAVE_STRCASECMP
è&& defšed(
_MSC_VER
)

10 
	#¡rÿ£cmp
 
_¡ricmp


	)

11 #–ià!
defšed
(
HAVE_STRCASECMP
)

12 #”rÜ 
You
 dØ
nÙ
 
have
 
¡rÿ£cmp
 
Ú
 
your
 
sy¡em
.

16 cÚ¡ *
	m¬g
;

17 
	mæag
;

18 } 
	gfÜm©_¬gs
[] = {

19 { "¶aš", 
JSON_C_TO_STRING_PLAIN
 },

20 { "¥aûd", 
JSON_C_TO_STRING_SPACED
 },

21 { "´‘ty", 
JSON_C_TO_STRING_PRETTY
 },

24 #iâdeà
NELEM


25 
	#NELEM
(
x
è((xè/ (&x[0]))

	)

28 
	$·r£_æags
(
¬gc
, **
¬gv
)

30 
¬g_idx
;

31 
sæags
 = 0;

32 
¬g_idx
 = 1;‡rg_idx < 
¬gc
 ;‡rg_idx++)

34 
jj
;

35 
jj
 = 0; jj < ()
	`NELEM
(
fÜm©_¬gs
); jj++)

37 ià(
	`¡rÿ£cmp
(
¬gv
[
¬g_idx
], 
fÜm©_¬gs
[
jj
].
¬g
) == 0)

39 
sæags
 |ğ
fÜm©_¬gs
[
jj
].
æag
;

43 ià(
jj
 =ğ
	`NELEM
(
fÜm©_¬gs
))

45 
	`´štf
("UnknowÀ¬g: %s\n", 
¬gv
[
¬g_idx
]);

46 
	`ex™
(1);

49  
sæags
;

50 
	}
}

	@json/example/tests/parse_flags.h

1 #iâdeà
__·r£_æags_h


2 
	#__·r£_æags_h


	)

3 
·r£_æags
(
¬gc
, **
¬gv
);

	@json/example/tests/test1.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ddef.h
>

4 
	~<¡ršg.h
>

5 
	~<as£¹.h
>

7 
	~"jsÚ.h
"

8 
	~"·r£_æags.h
"

10 
	$sÜt_â
 (cÚ¡ *
j1
, cÚ¡ *
j2
)

12 
jsÚ_objeù
 * cÚ¡ *
jso1
, * cÚ¡ *
jso2
;

13 
i1
, 
i2
;

15 
jso1
 = (
jsÚ_objeù
* cÚ¡*)
j1
;

16 
jso2
 = (
jsÚ_objeù
* cÚ¡*)
j2
;

17 ià(!*
jso1
 && !*
jso2
)

19 ià(!*
jso1
)

21 ià(!*
jso2
)

24 
i1
 = 
	`jsÚ_objeù_g‘_št
(*
jso1
);

25 
i2
 = 
	`jsÚ_objeù_g‘_št
(*
jso2
);

27  
i1
 - 
i2
;

28 
	}
}

30 #ifdeà
TEST_FORMATTED


31 
	#jsÚ_objeù_to_jsÚ_¡ršg
(
obj
è
	`jsÚ_objeù_to_jsÚ_¡ršg_ext
(obj,
sæags
)

	)

36 
	$maš
(
¬gc
, **
¬gv
)

38 
jsÚ_objeù
 *
my_¡ršg
, *
my_št
, *
my_objeù
, *
my_¬¿y
;

39 
i
;

40 #ifdeà
TEST_FORMATTED


41 
sæags
 = 0;

44 
	`MC_SET_DEBUG
(1);

46 #ifdeà
TEST_FORMATTED


47 
sæags
 = 
	`·r£_æags
(
¬gc
, 
¬gv
);

50 
my_¡ršg
 = 
	`jsÚ_objeù_Ãw_¡ršg
("\t");

51 
	`´štf
("my_¡ršg=%s\n", 
	`jsÚ_objeù_g‘_¡ršg
(
my_¡ršg
));

52 
	`´štf
("my_¡ršg.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_¡ršg
));

53 
	`jsÚ_objeù_put
(
my_¡ršg
);

55 
my_¡ršg
 = 
	`jsÚ_objeù_Ãw_¡ršg
("\\");

56 
	`´štf
("my_¡ršg=%s\n", 
	`jsÚ_objeù_g‘_¡ršg
(
my_¡ršg
));

57 
	`´štf
("my_¡ršg.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_¡ršg
));

58 
	`jsÚ_objeù_put
(
my_¡ršg
);

60 
my_¡ršg
 = 
	`jsÚ_objeù_Ãw_¡ršg
("foo");

61 
	`´štf
("my_¡ršg=%s\n", 
	`jsÚ_objeù_g‘_¡ršg
(
my_¡ršg
));

62 
	`´štf
("my_¡ršg.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_¡ršg
));

64 
my_št
 = 
	`jsÚ_objeù_Ãw_št
(9);

65 
	`´štf
("my_št=%d\n", 
	`jsÚ_objeù_g‘_št
(
my_št
));

66 
	`´štf
("my_št.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_št
));

68 
my_¬¿y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

69 
	`jsÚ_objeù_¬¿y_add
(
my_¬¿y
, 
	`jsÚ_objeù_Ãw_št
(1));

70 
	`jsÚ_objeù_¬¿y_add
(
my_¬¿y
, 
	`jsÚ_objeù_Ãw_št
(2));

71 
	`jsÚ_objeù_¬¿y_add
(
my_¬¿y
, 
	`jsÚ_objeù_Ãw_št
(3));

72 
	`jsÚ_objeù_¬¿y_put_idx
(
my_¬¿y
, 4, 
	`jsÚ_objeù_Ãw_št
(5));

73 
	`´štf
("my_array=\n");

74 
i
=0; i < 
	`jsÚ_objeù_¬¿y_Ëngth
(
my_¬¿y
); i++)

76 
jsÚ_objeù
 *
obj
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
my_¬¿y
, 
i
);

77 
	`´štf
("\t[%d]=%s\n", 
i
, 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
obj
));

79 
	`´štf
("my_¬¿y.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_¬¿y
));

81 
	`jsÚ_objeù_put
(
my_¬¿y
);

83 
my_¬¿y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

84 
	`jsÚ_objeù_¬¿y_add
(
my_¬¿y
, 
	`jsÚ_objeù_Ãw_št
(3));

85 
	`jsÚ_objeù_¬¿y_add
(
my_¬¿y
, 
	`jsÚ_objeù_Ãw_št
(1));

86 
	`jsÚ_objeù_¬¿y_add
(
my_¬¿y
, 
	`jsÚ_objeù_Ãw_št
(2));

87 
	`jsÚ_objeù_¬¿y_put_idx
(
my_¬¿y
, 4, 
	`jsÚ_objeù_Ãw_št
(0));

88 
	`´štf
("my_array=\n");

89 
i
=0; i < 
	`jsÚ_objeù_¬¿y_Ëngth
(
my_¬¿y
); i++)

91 
jsÚ_objeù
 *
obj
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
my_¬¿y
, 
i
);

92 
	`´štf
("\t[%d]=%s\n", 
i
, 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
obj
));

94 
	`´štf
("my_¬¿y.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_¬¿y
));

95 
	`jsÚ_objeù_¬¿y_sÜt
(
my_¬¿y
, 
sÜt_â
);

96 
	`´štf
("my_array=\n");

97 
i
=0; i < 
	`jsÚ_objeù_¬¿y_Ëngth
(
my_¬¿y
); i++)

99 
jsÚ_objeù
 *
obj
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
my_¬¿y
, 
i
);

100 
	`´štf
("\t[%d]=%s\n", 
i
, 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
obj
));

102 
	`´štf
("my_¬¿y.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_¬¿y
));

104 
my_objeù
 = 
	`jsÚ_objeù_Ãw_objeù
();

105 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "abc", 
	`jsÚ_objeù_Ãw_št
(12));

106 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "foo", 
	`jsÚ_objeù_Ãw_¡ršg
("bar"));

107 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "boŞ0", 
	`jsÚ_objeù_Ãw_boŞ—n
(0));

108 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "boŞ1", 
	`jsÚ_objeù_Ãw_boŞ—n
(1));

109 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "baz", 
	`jsÚ_objeù_Ãw_¡ršg
("bang"));

111 
jsÚ_objeù
 *
baz_obj
 = 
	`jsÚ_objeù_Ãw_¡ršg
("fark");

112 
	`jsÚ_objeù_g‘
(
baz_obj
);

113 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "baz", 
baz_obj
);

114 
	`jsÚ_objeù_objeù_d–
(
my_objeù
, "baz");

117 
	`´štf
("baz_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
baz_obj
));

118 
	`jsÚ_objeù_put
(
baz_obj
);

121 
	`´štf
("my_object=\n");

122 
	`jsÚ_objeù_objeù_fÜ—ch
(
my_objeù
, 
key
, 
v®
)

124 
	`´štf
("\t%s: %s\n", 
key
, 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
v®
));

126 
	`´štf
("my_objeù.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_objeù
));

128 
	`jsÚ_objeù_put
(
my_¡ršg
);

129 
	`jsÚ_objeù_put
(
my_št
);

130 
	`jsÚ_objeù_put
(
my_objeù
);

131 
	`jsÚ_objeù_put
(
my_¬¿y
);

134 
	}
}

	@json/example/tests/test2.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ddef.h
>

4 
	~<¡ršg.h
>

6 
	~"jsÚ.h
"

7 
	~"·r£_æags.h
"

9 #ifdeà
TEST_FORMATTED


10 
	#jsÚ_objeù_to_jsÚ_¡ršg
(
obj
è
	`jsÚ_objeù_to_jsÚ_¡ršg_ext
(obj,
sæags
)

	)

16 
	$maš
(
¬gc
, **
¬gv
)

18 
jsÚ_objeù
 *
Ãw_obj
;

19 #ifdeà
TEST_FORMATTED


20 
sæags
 = 0;

23 
	`MC_SET_DEBUG
(1);

25 #ifdeà
TEST_FORMATTED


26 
sæags
 = 
	`·r£_æags
(
¬gc
, 
¬gv
);

29 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("/* more difficultest case */ { \"glossary\": { \"title\": \"example glossary\", \"GlossDiv\": { \"title\": \"S\", \"GlossList\": [ { \"ID\": \"SGML\", \"SortAs\": \"SGML\", \"GlossTerm\": \"Standard Generalized Markup Language\", \"Acronym\": \"SGML\", \"Abbrev\": \"ISO 8879:1986\", \"GlossDef\": \"A meta-markup†anguage, usedo create markup†anguages such‡s DocBook.\", \"GlossSeeAlso\": [\"GML\", \"XML\", \"markup\"] } ] } } }");

30 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

31 
	`jsÚ_objeù_put
(
Ãw_obj
);

34 
	}
}

	@json/example/tests/test4.c

5 
	~<¡dio.h
>

6 
	~<¡ršg.h
>

7 
	~"jcÚfig.h
"

9 
	~"jsÚ_š‰y³s.h
"

10 
	~"jsÚ_objeù.h
"

11 
	~"jsÚ_tok’”.h
"

13 
	$´št_hex
ĞcÚ¡ * 
s
)

15 cÚ¡ *
™”
 = 
s
;

16 
ch
;

17 (
ch
 = *
™”
++) != 0)

19 ifĞ',' !ğ
ch
)

20 
	`´štf
("%x ", 
ch
);

22 
	`´štf
( ",");

24 
	`´štf
("\n");

25 
	}
}

27 
	$maš
()

29 cÚ¡ *
šput
 = "\"\\ud840\\udd26,\\ud840\\udd27,\\ud800\\udd26,\\ud800\\udd27\"";

30 cÚ¡ *
ex³ùed
 = "\xF0\xA0\x84\xA6,\xF0\xA0\x84\xA7,\xF0\x90\x84\xA6,\xF0\x90\x84\xA7";

31 
jsÚ_objeù
 *
·r£_»suÉ
 = 
	`jsÚ_tok’”_·r£
((*)
šput
);

32 cÚ¡ *
unjsÚ
 = 
	`jsÚ_objeù_g‘_¡ršg
(
·r£_»suÉ
);

34 
	`´štf
("šput: %s\n", 
šput
);

36 
¡ršgs_m©ch
 = !
	`¡rcmp
Ğ
ex³ùed
, 
unjsÚ
);

37 
»tv®
 = 0;

38 ià(
¡ršgs_m©ch
)

40 
	`´štf
("JSON…¬£„esuÉ i cÜ»ù: %s\n", 
unjsÚ
);

41 
	`´štf
("PASS\n");

43 
	`´štf
("JSON…arse„esult doesn't matchƒxpected string\n");

44 
	`´štf
("expected string bytes: ");

45 
	`´št_hex
Ğ
ex³ùed
);

46 
	`´štf
("parsed string bytes: ");

47 
	`´št_hex
Ğ
unjsÚ
);

48 
	`´štf
("FAIL\n");

49 
»tv®
 = 1;

51 
	`jsÚ_objeù_put
(
·r£_»suÉ
);

52  
»tv®
;

53 
	}
}

	@json/example/tests/testReplaceExisting.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ddef.h
>

4 
	~<¡ršg.h
>

6 
	~"jsÚ.h
"

8 
	$maš
(
¬gc
, **
¬gv
)

10 
	`MC_SET_DEBUG
(1);

16 
jsÚ_objeù
 *
my_objeù
 = 
	`jsÚ_objeù_Ãw_objeù
();

17 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "foo1", 
	`jsÚ_objeù_Ãw_¡ršg
("bar1"));

18 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "foo2", 
	`jsÚ_objeù_Ãw_¡ršg
("bar2"));

19 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "d–‘eme", 
	`jsÚ_objeù_Ãw_¡ršg
("bar2"));

20 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "foo3", 
	`jsÚ_objeù_Ãw_¡ršg
("bar3"));

22 
	`´štf
("==== delete-in-loopest starting ====\n");

24 
Üig_couÁ
 = 0;

25 
	`jsÚ_objeù_objeù_fÜ—ch
(
my_objeù
, 
key0
, 
v®0
)

27 
	`´štf
("Key‡ˆšdex %d i [%s]", 
Üig_couÁ
, 
key0
);

28 ià(
	`¡rcmp
(
key0
, "deleteme") == 0)

30 
	`jsÚ_objeù_objeù_d–
(
my_objeù
, 
key0
);

31 
	`´štf
(" (deleted)\n");

34 
	`´štf
(" (kept)\n");

35 
Üig_couÁ
++;

38 
	`´štf
("====„eplace-value first†oop starting ====\n");

40 cÚ¡ *
Üigš®_key
 = 
NULL
;

41 
Üig_couÁ
 = 0;

42 
	`jsÚ_objeù_objeù_fÜ—ch
(
my_objeù
, 
key
, 
v®
)

44 
	`´štf
("Key‡ˆšdex %d i [%s]\n", 
Üig_couÁ
, 
key
);

45 
Üig_couÁ
++;

46 ià(
	`¡rcmp
(
key
, "foo2") != 0)

48 
	`´štf
("»¶acšg v®ufÜ key [%s]\n", 
key
);

49 
Üigš®_key
 = 
key
;

50 
	`jsÚ_objeù_objeù_add
(
my_objeù
, 
key
, 
	`jsÚ_objeù_Ãw_¡ršg
("zzz"));

53 
	`´štf
("==== second†oop starting ====\n");

55 
Ãw_couÁ
 = 0;

56 
»tv®
 = 0;

57 
	`jsÚ_objeù_objeù_fÜ—ch
(
my_objeù
, 
key2
, 
v®2
)

59 
	`´štf
("Key‡ˆšdex %d i [%s]\n", 
Ãw_couÁ
, 
key2
);

60 
Ãw_couÁ
++;

61 ià(
	`¡rcmp
(
key2
, "foo2") != 0)

63 
	`´štf
("poš‹¸fÜ key [%s] dÛ %sm©ch\n", 
key2
,

64 (
key2
 =ğ
Üigš®_key
) ? "" : "NOT ");

65 ià(
key2
 !ğ
Üigš®_key
)

66 
»tv®
 = 1;

68 ià(
Ãw_couÁ
 !ğ
Üig_couÁ
)

70 
	`´štf
("mismatch between original count (%d)‡nd‚ew count (%d)\n",

71 
Üig_couÁ
, 
Ãw_couÁ
);

72 
»tv®
 = 1;

75 
	`jsÚ_objeù_put
Ğ
my_objeù
 );

77  
»tv®
;

78 
	}
}

	@json/example/tests/test_cast.c

6 
	~<¡dio.h
>

7 
	~<¡ršg.h
>

8 
	~<¡dlib.h
>

9 
	~"jcÚfig.h
"

11 
	~"jsÚ_š‰y³s.h
"

12 
	~"jsÚ_objeù.h
"

13 
	~"jsÚ_tok’”.h
"

14 
	~"jsÚ_ut.h
"

16 
g‘™
(
jsÚ_objeù
 *
Ãw_obj
, cÚ¡ *
f›ld
);

17 
checkty³_h—d”
();

18 
checkty³
(
jsÚ_objeù
 *
Ãw_obj
, cÚ¡ *
f›ld
);

20 
	$maš
(
¬gc
, **
¬gv
)

22 cÚ¡ *
šput
 = "{\n\
\"string_of_digits\": \"123\",\n\
\"regular_number\": 222,\n\
\"decimal_number\": 99.55,\n\
\"boolean_true\":rue,\n\
\"boolean_false\": false,\n\
\"big_number\": 2147483649,\n\
\"a_null\":‚ull,\n\
}";

33 
jsÚ_objeù
 *
Ãw_obj
;

35 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
(
šput
);

36 
	`´štf
("P¬£d iÅut: %s\n", 
šput
);

37 
	`´štf
("ResuÉ i %s\n", (
Ãw_obj
 =ğ
NULL
) ? "NULL (error!)" : "not NULL");

38 ià(!
Ãw_obj
)

41 
	`g‘™
(
Ãw_obj
, "string_of_digits");

42 
	`g‘™
(
Ãw_obj
, "regular_number");

43 
	`g‘™
(
Ãw_obj
, "decimal_number");

44 
	`g‘™
(
Ãw_obj
, "boolean_true");

45 
	`g‘™
(
Ãw_obj
, "boolean_false");

46 
	`g‘™
(
Ãw_obj
, "big_number");

47 
	`g‘™
(
Ãw_obj
, "a_null");

50 
	`´štf
("\n================================\n");

51 
	`checkty³_h—d”
();

52 
	`checkty³
(
Ãw_obj
, 
NULL
);

53 
	`checkty³
(
Ãw_obj
, "string_of_digits");

54 
	`checkty³
(
Ãw_obj
, "regular_number");

55 
	`checkty³
(
Ãw_obj
, "decimal_number");

56 
	`checkty³
(
Ãw_obj
, "boolean_true");

57 
	`checkty³
(
Ãw_obj
, "boolean_false");

58 
	`checkty³
(
Ãw_obj
, "big_number");

59 
	`checkty³
(
Ãw_obj
, "a_null");

61 
	`jsÚ_objeù_put
(
Ãw_obj
);

64 
	}
}

66 
	$g‘™
(
jsÚ_objeù
 *
Ãw_obj
, cÚ¡ *
f›ld
)

68 
jsÚ_objeù
 *
o
 = 
	`jsÚ_objeù_objeù_g‘
(
Ãw_obj
, 
f›ld
);

70 
jsÚ_ty³
 
o_ty³
 = 
	`jsÚ_objeù_g‘_ty³
(
o
);

71 
	`´štf
("Ãw_obj.% jsÚ_objeù_g‘_ty³()=%s\n", 
f›ld
,

72 
	`jsÚ_ty³_to_Çme
(
o_ty³
));

73 
	`´štf
("Ãw_obj.% jsÚ_objeù_g‘_št()=%d\n", 
f›ld
,

74 
	`jsÚ_objeù_g‘_št
(
o
));

75 
	`´štf
("Ãw_obj.% jsÚ_objeù_g‘_št64()=%" 
PRId64
 "\n", 
f›ld
,

76 
	`jsÚ_objeù_g‘_št64
(
o
));

77 
	`´štf
("Ãw_obj.% jsÚ_objeù_g‘_boŞ—n()=%d\n", 
f›ld
,

78 
	`jsÚ_objeù_g‘_boŞ—n
(
o
));

79 
	`´štf
("Ãw_obj.% jsÚ_objeù_g‘_doubË()=%f\n", 
f›ld
,

80 
	`jsÚ_objeù_g‘_doubË
(
o
));

81 
	}
}

83 
	$checkty³_h—d”
()

85 
	`´štf
("json_object_is_type: %s,%s,%s,%s,%s,%s,%s\n",

86 
	`jsÚ_ty³_to_Çme
(
jsÚ_ty³_nuÎ
),

87 
	`jsÚ_ty³_to_Çme
(
jsÚ_ty³_boŞ—n
),

88 
	`jsÚ_ty³_to_Çme
(
jsÚ_ty³_doubË
),

89 
	`jsÚ_ty³_to_Çme
(
jsÚ_ty³_št
),

90 
	`jsÚ_ty³_to_Çme
(
jsÚ_ty³_objeù
),

91 
	`jsÚ_ty³_to_Çme
(
jsÚ_ty³_¬¿y
),

92 
	`jsÚ_ty³_to_Çme
(
jsÚ_ty³_¡ršg
));

93 
	}
}

94 
	$checkty³
(
jsÚ_objeù
 *
Ãw_obj
, cÚ¡ *
f›ld
)

96 
jsÚ_objeù
 *
o
 = 
f›ld
 ? 
	`jsÚ_objeù_objeù_g‘
(
Ãw_obj
, field) :‚ew_obj;

97 
	`´štf
("new_obj%s%-18s: %d,%d,%d,%d,%d,%d,%d\n",

98 
f›ld
 ? "." : " ", field ? field : "",

99 
	`jsÚ_objeù_is_ty³
(
o
, 
jsÚ_ty³_nuÎ
),

100 
	`jsÚ_objeù_is_ty³
(
o
, 
jsÚ_ty³_boŞ—n
),

101 
	`jsÚ_objeù_is_ty³
(
o
, 
jsÚ_ty³_doubË
),

102 
	`jsÚ_objeù_is_ty³
(
o
, 
jsÚ_ty³_št
),

103 
	`jsÚ_objeù_is_ty³
(
o
, 
jsÚ_ty³_objeù
),

104 
	`jsÚ_objeù_is_ty³
(
o
, 
jsÚ_ty³_¬¿y
),

105 
	`jsÚ_objeù_is_ty³
(
o
, 
jsÚ_ty³_¡ršg
));

106 
	}
}

	@json/example/tests/test_locale.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ddef.h
>

4 
	~<¡ršg.h
>

5 
	~<as£¹.h
>

7 
	~"jcÚfig.h
"

8 
	~"jsÚ.h
"

9 
	~"jsÚ_tok’”.h
"

11 #ifdeà
HAVE_LOCALE_H


12 
	~<loÿË.h
>

15 
	$maš
(
¬gc
, **
¬gv
)

17 
jsÚ_objeù
 *
Ãw_obj
;

18 #ifdeà
HAVE_SETLOCALE


19 
	`£oÿË
(
LC_NUMERIC
, "de_DE");

21 
	`´štf
("No†ocale\n");

24 
	`MC_SET_DEBUG
(1);

26 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[1.2,3.4,123456.78,5.0,2.3e10]");

27 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

28 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg_ext
(
Ãw_obj
,
JSON_C_TO_STRING_NOZERO
));

29 
	`jsÚ_objeù_put
(
Ãw_obj
);

30 
	}
}

	@json/example/tests/test_null.c

5 
	~<¡dio.h
>

6 
	~<¡ršg.h
>

7 
	~"jcÚfig.h
"

9 
	~"jsÚ_š‰y³s.h
"

10 
	~"jsÚ_objeù.h
"

11 
	~"jsÚ_tok’”.h
"

13 
	$maš
()

16 cÚ¡ *
šput
 = " \0 ";

17 cÚ¡ *
ex³ùed
 = "\" \\u0000 \"";

18 
jsÚ_objeù
 *
¡ršg
 = 
	`jsÚ_objeù_Ãw_¡ršg_Ën
(
šput
, 3);

19 cÚ¡ *
jsÚ
 = 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
¡ršg
);

21 
¡ršgs_m©ch
 = !
	`¡rcmp
Ğ
ex³ùed
, 
jsÚ
);

22 
»tv®
 = 0;

23 ià(
¡ršgs_m©ch
)

25 
	`´štf
("JSON wr™»suÉ i cÜ»ù: %s\n", 
jsÚ
);

26 
	`´štf
("PASS\n");

28 
	`´štf
("JSON write„esult doesn't matchƒxpected string\n");

29 
	`´štf
("expected string: ");

30 
	`´štf
("%s\n", 
ex³ùed
);

31 
	`´štf
("parsed string: ");

32 
	`´štf
("%s\n", 
jsÚ
);

33 
	`´štf
("FAIL\n");

34 
»tv®
=1;

36 
	`jsÚ_objeù_put
(
¡ršg
);

38 
jsÚ_objeù
 *
·r£d_¡r
 = 
	`jsÚ_tok’”_·r£
(
ex³ùed
);

39 ià(
·r£d_¡r
)

41 
·r£d_Ën
 = 
	`jsÚ_objeù_g‘_¡ršg_Ën
(
·r£d_¡r
);

42 cÚ¡ *
·r£d_c¡r
 = 
	`jsÚ_objeù_g‘_¡ršg
(
·r£d_¡r
);

43 
ii
;

44 
	`´štf
("Re-·r£d objeù sŒšg†’=%d, ch¬s=[", 
·r£d_Ën
);

45 
ii
 = 0; i˜< 
·r£d_Ën
 ; ii++)

47 
	`´štf
("%s%d", (
ii
 ? ", " : ""), ()
·r£d_c¡r
[ii]);

49 
	`´štf
("]\n");

50 
	`jsÚ_objeù_put
(
·r£d_¡r
);

54 
	`´štf
("ERROR: failedo…arse\n");

56  
»tv®
;

57 
	}
}

	@json/example/tests/test_parse.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ddef.h
>

4 
	~<¡ršg.h
>

5 
	~<as£¹.h
>

7 
	~"jsÚ.h
"

8 
	~"jsÚ_tok’”.h
"

10 
‹¡_basic_·r£
();

11 
‹¡_v”bo£_·r£
();

12 
‹¡_šüem’l_·r£
();

14 
	$maš
(
¬gc
, **
¬gv
)

16 
	`MC_SET_DEBUG
(1);

18 
	`‹¡_basic_·r£
();

19 
	`´štf
("==================================\n");

20 
	`‹¡_v”bo£_·r£
();

21 
	`´štf
("==================================\n");

22 
	`‹¡_šüem’l_·r£
();

23 
	`´štf
("==================================\n");

24 
	}
}

26 
	$‹¡_basic_·r£
()

28 
jsÚ_objeù
 *
Ãw_obj
;

30 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("\"\003\"");

31 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

32 
	`jsÚ_objeù_put
(
Ãw_obj
);

34 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("/* hello */\"foo\"");

35 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

36 
	`jsÚ_objeù_put
(
Ãw_obj
);

38 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("// hello\n\"foo\"");

39 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

40 
	`jsÚ_objeù_put
(
Ãw_obj
);

42 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("\"\\u0041\\u0042\\u0043\"");

43 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

44 
	`jsÚ_objeù_put
(
Ãw_obj
);

46 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("null");

47 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

48 
	`jsÚ_objeù_put
(
Ãw_obj
);

50 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("True");

51 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

52 
	`jsÚ_objeù_put
(
Ãw_obj
);

54 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("12");

55 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

56 
	`jsÚ_objeù_put
(
Ãw_obj
);

58 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("12.3");

59 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

60 
	`jsÚ_objeù_put
(
Ãw_obj
);

62 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[\"\\n\"]");

63 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

64 
	`jsÚ_objeù_put
(
Ãw_obj
);

66 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[\"\\nabc\\n\"]");

67 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

68 
	`jsÚ_objeù_put
(
Ãw_obj
);

70 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[null]");

71 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

72 
	`jsÚ_objeù_put
(
Ãw_obj
);

74 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[]");

75 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

76 
	`jsÚ_objeù_put
(
Ãw_obj
);

78 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[false]");

79 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

80 
	`jsÚ_objeù_put
(
Ãw_obj
);

82 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("[\"abc\",null,\"def\",12]");

83 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

84 
	`jsÚ_objeù_put
(
Ãw_obj
);

86 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{}");

87 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

88 
	`jsÚ_objeù_put
(
Ãw_obj
);

90 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ \"foo\": \"bar\" }");

91 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

92 
	`jsÚ_objeù_put
(
Ãw_obj
);

94 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ \"foo\": \"bar\", \"baz\":‚ull, \"bool0\":rue }");

95 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

96 
	`jsÚ_objeù_put
(
Ãw_obj
);

98 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ \"foo\": [null, \"foo\"] }");

99 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

100 
	`jsÚ_objeù_put
(
Ãw_obj
);

102 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ \"abc\": 12, \"foo\": \"bar\", \"bool0\": false, \"bool1\":rue, \"arr\": [ 1, 2, 3,‚ull, 5 ] }");

103 
	`´štf
("Ãw_obj.to_¡ršg()=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

104 
	`jsÚ_objeù_put
(
Ãw_obj
);

105 
	}
}

107 
	$‹¡_v”bo£_·r£
()

109 
jsÚ_objeù
 *
Ãw_obj
;

110 
jsÚ_tok’”_”rÜ
 
”rÜ
 = 
jsÚ_tok’”_sucûss
;

112 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£_v”bo£
("{ foØ}", &
”rÜ
);

113 
	`as£¹
 (
”rÜ
 =ğ
jsÚ_tok’”_”rÜ_·r£_objeù_key_Çme
);

114 
	`as£¹
 (
Ãw_obj
 =ğ
NULL
);

116 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("{ foo }");

117 
	`as£¹
 (
Ãw_obj
 =ğ
NULL
);

119 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
("foo");

120 
	`as£¹
 (
Ãw_obj
 =ğ
NULL
);

121 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£_v”bo£
("foo", &
”rÜ
);

122 
	`as£¹
 (
Ãw_obj
 =ğ
NULL
);

125 
	`as£¹
 (
”rÜ
 =ğ
jsÚ_tok’”_”rÜ_·r£_boŞ—n
);

127 
	`´štf
("json_tokener_parse_versbose() OK\n");

128 
	}
}

130 
	sšüem’l_¡•
 {

131 cÚ¡ *
	m¡ršg_to_·r£
;

132 
	mËngth
;

133 
	mch¬_off£t
;

134 
jsÚ_tok’”_”rÜ
 
	mex³ùed_”rÜ
;

135 
	m»£t_tok’”
;

136 } 
	gšüem’l_¡•s
[] = {

139 { "{ \"foo\": 123 }", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

140 { "{ \"foo\": 456 }", -1, -1, 
jsÚ_tok’”_sucûss
, 1 },

141 { "{ \"foo\": 789 }", -1, -1, 
jsÚ_tok’”_sucûss
, 1 },

144 { "{ \"foo", -1, -1, 
jsÚ_tok’”_cÚtšue
, 0 },

145 { "\": {\"b¬", -1, -1, 
jsÚ_tok’”_cÚtšue
, 0 },

146 { "\":13}}", -1, -1, 
jsÚ_tok’”_sucûss
, 1 },

149 { "{ \"foo", -1, -1, 
jsÚ_tok’”_cÚtšue
, 1 },

150 { ": \"b¬\"}", -1, 0, 
jsÚ_tok’”_”rÜ_·r£_uÃx³ùed
, 1 },

153 { "{ \"foo", -1, -1, 
jsÚ_tok’”_cÚtšue
, 0 },

154 { "\": {\"b¬", -1, -1, 
jsÚ_tok’”_cÚtšue
, 0 },

155 { "\":13}}XXXX", 10, 6, 
jsÚ_tok’”_sucûss
, 0 },

156 { "XXXX", 4, 0, 
jsÚ_tok’”_”rÜ_·r£_uÃx³ùed
, 1 },

159 { "{\"x\": 123 }\"X\"", -1, 11, 
jsÚ_tok’”_sucûss
, 0 },

160 { "\"Y\"", -1, -1, 
jsÚ_tok’”_sucûss
, 1 },

163 { "1", 1, 1, 
jsÚ_tok’”_cÚtšue
, 0 },

164 { "2", 2, 1, 
jsÚ_tok’”_sucûss
, 0 },

167 { "\"blue\"", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

170 { "\"\\\"\"", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

171 { "\"\\\\\"", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

172 { "\"\\b\"", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

173 { "\"\\f\"", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

174 { "\"\\n\"", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

175 { "\"\\r\"", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

176 { "\"\\t\"", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

178 { "[1,2,3]", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

183 { "[1,2,3,]", -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

184 { "[1,2,,3,]", -1, 5, 
jsÚ_tok’”_”rÜ_·r£_uÃx³ùed
, 0 },

186 { "[1,2,3,]", -1, 7, 
jsÚ_tok’”_”rÜ_·r£_uÃx³ùed
, 3 },

187 { "{\"a\":1,}", -1, 7, 
jsÚ_tok’”_”rÜ_·r£_uÃx³ùed
, 3 },

189 { 
NULL
, -1, -1, 
jsÚ_tok’”_sucûss
, 0 },

192 
	$‹¡_šüem’l_·r£
()

194 
jsÚ_objeù
 *
Ãw_obj
;

195 
jsÚ_tok’”_”rÜ
 
j”r
;

196 
jsÚ_tok’”
 *
tok
;

197 cÚ¡ *
¡ršg_to_·r£
;

198 
ii
;

199 
num_ok
, 
num_”rÜ
;

201 
num_ok
 = 0;

202 
num_”rÜ
 = 0;

204 
	`´štf
("Starting incrementalests.\n");

205 
	`´štf
("Note: quotes‡nd backslashes seen inhe output here‡re†iteral values…assed\n");

206 
	`´štf
("ohe…arse functions.ƒ.g.his is 4 characters: \"\\f\"\n");

208 
¡ršg_to_·r£
 = "{ \"foo";

209 
	`´štf
("jsÚ_tok’”_·r£(%sè... ", 
¡ršg_to_·r£
);

210 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£
(
¡ršg_to_·r£
);

211 ià(
Ãw_obj
 =ğ
NULL
è
	`´štf
("gotƒrror‡sƒxpected\n");

214 
tok
 = 
	`jsÚ_tok’”_Ãw
();

215 
ii
 = 0; 
šüem’l_¡•s
[ii].
¡ršg_to_·r£
 !ğ
NULL
; ii++)

217 
this_¡•_ok
 = 0;

218 
šüem’l_¡•
 *
¡•
 = &
šüem’l_¡•s
[
ii
];

219 
Ëngth
 = 
¡•
->length;

220 
ex³ùed_ch¬_off£t
 = 
¡•
->
ch¬_off£t
;

222 ià(
¡•
->
»£t_tok’”
 & 2)

223 
	`jsÚ_tok’”_£t_æags
(
tok
, 
JSON_TOKENER_STRICT
);

225 
	`jsÚ_tok’”_£t_æags
(
tok
, 0);

227 ià(
Ëngth
 == -1)

228 
Ëngth
 = 
	`¡¾’
(
¡•
->
¡ršg_to_·r£
);

229 ià(
ex³ùed_ch¬_off£t
 == -1)

230 
ex³ùed_ch¬_off£t
 = 
Ëngth
;

232 
	`´štf
("json_tokener_parse_ex(tok, %-12s, %3d) ... ",

233 
¡•
->
¡ršg_to_·r£
, 
Ëngth
);

234 
Ãw_obj
 = 
	`jsÚ_tok’”_·r£_ex
(
tok
, 
¡•
->
¡ršg_to_·r£
, 
Ëngth
);

236 
j”r
 = 
	`jsÚ_tok’”_g‘_”rÜ
(
tok
);

237 ià(
¡•
->
ex³ùed_”rÜ
 !ğ
jsÚ_tok’”_sucûss
)

239 ià(
Ãw_obj
 !ğ
NULL
)

240 
	`´štf
("ERROR: invalid object„eturned: %s\n",

241 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

242 ià(
j”r
 !ğ
¡•
->
ex³ùed_”rÜ
)

243 
	`´štf
("ERROR: got wrongƒrror: %s\n",

244 
	`jsÚ_tok’”_”rÜ_desc
(
j”r
));

245 ià(
tok
->
ch¬_off£t
 !ğ
ex³ùed_ch¬_off£t
)

246 
	`´štf
("ERROR: wrong char_offset %d !=ƒxpected %d\n",

247 
tok
->
ch¬_off£t
,

248 
ex³ùed_ch¬_off£t
);

251 
	`´štf
("OK: gÙ cÜ»ùƒ¼Ü: %s\n", 
	`jsÚ_tok’”_”rÜ_desc
(
j”r
));

252 
this_¡•_ok
 = 1;

257 ià(
Ãw_obj
 =ğ
NULL
)

258 
	`´štf
("ERROR:ƒxpected valid object, instead: %s\n",

259 
	`jsÚ_tok’”_”rÜ_desc
(
j”r
));

260 ià(
tok
->
ch¬_off£t
 !ğ
ex³ùed_ch¬_off£t
)

261 
	`´štf
("ERROR: wrong char_offset %d !=ƒxpected %d\n",

262 
tok
->
ch¬_off£t
,

263 
ex³ùed_ch¬_off£t
);

266 
	`´štf
("OK: got object ofype [%s]: %s\n",

267 
	`jsÚ_ty³_to_Çme
(
	`jsÚ_objeù_g‘_ty³
(
Ãw_obj
)),

268 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
Ãw_obj
));

269 
this_¡•_ok
 = 1;

273 ià(
Ãw_obj
)

274 
	`jsÚ_objeù_put
(
Ãw_obj
);

276 ià(
¡•
->
»£t_tok’”
 & 1)

277 
	`jsÚ_tok’”_»£t
(
tok
);

279 ià(
this_¡•_ok
)

280 
num_ok
++;

282 
num_”rÜ
++;

285 
	`jsÚ_tok’”_ä“
(
tok
);

287 
	`´štf
("End Inüem’ÈTe¡ OK=%d ERROR=%d\n", 
num_ok
, 
num_”rÜ
);

290 
	}
}

	@json/example/tests/test_parse_int64.c

2 
	~<¡dio.h
>

3 
	~<¡ršg.h
>

5 
	~"jcÚfig.h
"

7 
	~"jsÚ_š‰y³s.h
"

8 
	~"jsÚ_ut.h
"

10 
	$check™
(cÚ¡ *
buf
)

12 
št64_t
 
cšt64
 = -666;

14 
»tv®
 = 
	`jsÚ_·r£_št64
(
buf
, &
cšt64
);

15 
	`´štf
("buf=% ·r£™=%d, v®ue=%" 
PRId64
 " \n", 
buf
, 
»tv®
, 
cšt64
);

16 
	}
}

26 
	$maš
()

28 
buf
[100];

30 
	`check™
("x");

32 
	`check™
("0");

33 
	`check™
("-0");

35 
	`check™
("00000000");

36 
	`check™
("-00000000");

38 
	`check™
("1");

40 
	`¡rıy
(
buf
, "2147483647");

41 
	`check™
(
buf
);

43 
	`¡rıy
(
buf
, "-1");

44 
	`check™
(
buf
);

46 
	`¡rıy
(
buf
, " -1");

47 
	`check™
(
buf
);

49 
	`¡rıy
(
buf
, "00001234");

50 
	`check™
(
buf
);

52 
	`¡rıy
(
buf
, "0001234x");

53 
	`check™
(
buf
);

55 
	`¡rıy
(
buf
, "-00001234");

56 
	`check™
(
buf
);

58 
	`¡rıy
(
buf
, "-00001234x");

59 
	`check™
(
buf
);

61 
	`¡rıy
(
buf
, "4294967295");

63 
	`¥rštf
(
buf
, "4294967296");

65 
	`¡rıy
(
buf
, "21474836470");

66 
	`check™
(
buf
);

68 
	`¡rıy
(
buf
, "31474836470");

69 
	`check™
(
buf
);

71 
	`¡rıy
(
buf
, "-2147483647");

72 
	`check™
(
buf
);

74 
	`¡rıy
(
buf
, "-2147483648");

75 
	`check™
(
buf
);

77 
	`¡rıy
(
buf
, "-2147483649");

78 
	`check™
(
buf
);

80 
	`¡rıy
(
buf
, "-21474836480");

81 
	`check™
(
buf
);

83 
	`¡rıy
(
buf
, "9223372036854775806");

84 
	`check™
(
buf
);

86 
	`¡rıy
(
buf
, "9223372036854775807");

87 
	`check™
(
buf
);

89 
	`¡rıy
(
buf
, "9223372036854775808");

90 
	`check™
(
buf
);

92 
	`¡rıy
(
buf
, "-9223372036854775808");

93 
	`check™
(
buf
);

95 
	`¡rıy
(
buf
, "-9223372036854775809");

96 
	`check™
(
buf
);

98 
	`¡rıy
(
buf
, "18446744073709551614");

99 
	`check™
(
buf
);

101 
	`¡rıy
(
buf
, "18446744073709551615");

102 
	`check™
(
buf
);

104 
	`¡rıy
(
buf
, "18446744073709551616");

105 
	`check™
(
buf
);

107 
	`¡rıy
(
buf
, "-18446744073709551616");

108 
	`check™
(
buf
);

111 
	`¡rıy
(
buf
, "123");

112 
	`check™
(
buf
);

115 
	}
}

	@json/example/tests/test_printbuf.c

1 
	~<as£¹.h
>

2 
	~<¡ddef.h
>

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<¡ršg.h
>

6 
	~<lim™s.h
>

8 
	~"debug.h
"

9 
	~"´štbuf.h
"

11 
‹¡_basic_´štbuf_mem£t
();

12 
‹¡_´štbuf_mem£t_Ëngth
();

14 
	$‹¡_basic_´štbuf_mem£t
()

16 
´štbuf
 *
pb
;

18 
	`´štf
("%s: s¹šge¡\n", 
__func__
);

19 
pb
 = 
	`´štbuf_Ãw
();

20 
	`¥rštbuf
(
pb
, "blue:%d", 1);

21 
	`´štbuf_mem£t
(
pb
, -1, 'x', 52);

22 
	`´štf
("Bufã¸cÚ‹Ás:%.*s\n", 
	`´štbuf_Ëngth
(
pb
),…b->
buf
);

23 
	`´štbuf_ä“
(
pb
);

24 
	`´štf
("%s:ƒnde¡\n", 
__func__
);

25 
	}
}

27 
	$‹¡_´štbuf_mem£t_Ëngth
()

29 
´štbuf
 *
pb
;

31 
	`´štf
("%s: s¹šge¡\n", 
__func__
);

32 
pb
 = 
	`´štbuf_Ãw
();

33 
	`´štbuf_mem£t
(
pb
, -1, ' ', 0);

34 
	`´štbuf_mem£t
(
pb
, -1, ' ', 0);

35 
	`´štbuf_mem£t
(
pb
, -1, ' ', 0);

36 
	`´štbuf_mem£t
(
pb
, -1, ' ', 0);

37 
	`´štbuf_mem£t
(
pb
, -1, ' ', 0);

38 
	`´štf
("Bufã¸Ëngth: %d\n", 
	`´štbuf_Ëngth
(
pb
));

39 
	`´štbuf_mem£t
(
pb
, -1, ' ', 2);

40 
	`´štbuf_mem£t
(
pb
, -1, ' ', 4);

41 
	`´štbuf_mem£t
(
pb
, -1, ' ', 6);

42 
	`´štf
("Bufã¸Ëngth: %d\n", 
	`´štbuf_Ëngth
(
pb
));

43 
	`´štbuf_mem£t
(
pb
, -1, ' ', 6);

44 
	`´štf
("Bufã¸Ëngth: %d\n", 
	`´štbuf_Ëngth
(
pb
));

45 
	`´štbuf_mem£t
(
pb
, -1, ' ', 8);

46 
	`´štbuf_mem£t
(
pb
, -1, ' ', 10);

47 
	`´štbuf_mem£t
(
pb
, -1, ' ', 10);

48 
	`´štbuf_mem£t
(
pb
, -1, ' ', 10);

49 
	`´štbuf_mem£t
(
pb
, -1, ' ', 20);

50 
	`´štf
("Bufã¸Ëngth: %d\n", 
	`´štbuf_Ëngth
(
pb
));

53 
	`´štbuf_mem£t
(
pb
, 0, 'x', 30);

54 
	`´štf
("Bufã¸Ëngth: %d\n", 
	`´štbuf_Ëngth
(
pb
));

57 
	`´štbuf_mem£t
(
pb
, 0, 'x', 
	`´štbuf_Ëngth
(pb) + 1);

58 
	`´štf
("Bufã¸Ëngth: %d\n", 
	`´štbuf_Ëngth
(
pb
));

60 
	`´štbuf_ä“
(
pb
);

61 
	`´štf
("%s:ƒnde¡\n", 
__func__
);

62 
	}
}

64 
‹¡_´štbuf_mem­³nd
(*
befÜe_»size
);

65 
	$‹¡_´štbuf_mem­³nd
(*
befÜe_»size
)

67 
´štbuf
 *
pb
;

68 
š™Ÿl_size
;

70 
	`´štf
("%s: s¹šge¡\n", 
__func__
);

71 
pb
 = 
	`´štbuf_Ãw
();

72 
	`´štf
("Bufã¸Ëngth: %d\n", 
	`´štbuf_Ëngth
(
pb
));

74 
š™Ÿl_size
 = 
pb
->
size
;

76 
pb
->
size
 =ğ
š™Ÿl_size
)

78 
	`´štbuf_mem­³nd_ç¡
(
pb
, "x", 1);

80 *
befÜe_»size
 = 
	`´štbuf_Ëngth
(
pb
) - 1;

81 
	`´štf
("Aµ’ded %d by‹ fÜ„esize: [%s]\n", *
befÜe_»size
 + 1, 
pb
->
buf
);

83 
	`´štbuf_»£t
(
pb
);

84 
	`´štbuf_mem­³nd_ç¡
(
pb
, "bluexyz123", 3);

85 
	`´štf
("P¬tŸÈ­³nd: %d, [%s]\n", 
	`´štbuf_Ëngth
(
pb
),…b->
buf
);

87 
w™h_nuÎs
[] = { 'a', 'b', '\0', 'c' };

88 
	`´štbuf_»£t
(
pb
);

89 
	`´štbuf_mem­³nd_ç¡
(
pb
, 
w™h_nuÎs
, ()(with_nulls));

90 
	`´štf
("W™hƒmbedded \\0 ch¬aù”: %d, [%s]\n", 
	`´štbuf_Ëngth
(
pb
),…b->
buf
);

92 
	`´štbuf_ä“
(
pb
);

93 
pb
 = 
	`´štbuf_Ãw
();

94 *
d©a
 = 
	`m®loc
(*
befÜe_»size
);

95 
	`mem£t
(
d©a
, 'X', *
befÜe_»size
);

96 
	`´štbuf_mem­³nd_ç¡
(
pb
, 
d©a
, *
befÜe_»size
);

97 
	`´štf
("Aµ’dØju¡ befÜ»size: %d, [%s]\n", 
	`´štbuf_Ëngth
(
pb
),…b->
buf
);

99 
	`ä“
(
d©a
);

100 
	`´štbuf_ä“
(
pb
);

102 
pb
 = 
	`´štbuf_Ãw
();

103 
d©a
 = 
	`m®loc
(*
befÜe_»size
 + 1);

104 
	`mem£t
(
d©a
, 'X', *
befÜe_»size
 + 1);

105 
	`´štbuf_mem­³nd_ç¡
(
pb
, 
d©a
, *
befÜe_»size
 + 1);

106 
	`´štf
("Aµ’dØju¡‡á”„esize: %d, [%s]\n", 
	`´štbuf_Ëngth
(
pb
),…b->
buf
);

108 
	`ä“
(
d©a
);

110 
	`´štbuf_ä“
(
pb
);

111 
	`´štf
("%s:ƒnde¡\n", 
__func__
);

112 
	}
}

114 
‹¡_¥rštbuf
(
befÜe_»size
);

115 
	$‹¡_¥rštbuf
(
befÜe_»size
)

117 
´štbuf
 *
pb
;

119 
	`´štf
("%s: s¹šge¡\n", 
__func__
);

120 
pb
 = 
	`´štbuf_Ãw
();

121 
	`´štf
("Bufã¸Ëngth: %d\n", 
	`´štbuf_Ëngth
(
pb
));

123 *
d©a
 = 
	`m®loc
(
befÜe_»size
 + 1 + 1);

124 
	`mem£t
(
d©a
, 'X', 
befÜe_»size
 + 1 + 1);

125 
d©a
[
befÜe_»size
 + 1] = '\0';

126 
	`¥rštbuf
(
pb
, "%s", 
d©a
);

127 
	`ä“
(
d©a
);

128 
	`´štf
("¥rštbuàtØju¡‡á”„esize(%d+1): %d, [%s], sŒËn(buf)=%d\n", 
befÜe_»size
, 
	`´štbuf_Ëngth
(
pb
),…b->
buf
, ()
	`¡¾’
(pb->buf));

130 
	`´štbuf_»£t
(
pb
);

131 
	`¥rštbuf
(
pb
, "plain");

132 
	`´štf
("%d, [%s]\n", 
	`´štbuf_Ëngth
(
pb
),…b->
buf
);

134 
	`¥rštbuf
(
pb
, "%d", 1);

135 
	`´štf
("%d, [%s]\n", 
	`´štbuf_Ëngth
(
pb
),…b->
buf
);

137 
	`¥rštbuf
(
pb
, "%d", 
INT_MAX
);

138 
	`´štf
("%d, [%s]\n", 
	`´štbuf_Ëngth
(
pb
),…b->
buf
);

140 
	`¥rštbuf
(
pb
, "%d", 
INT_MIN
);

141 
	`´štf
("%d, [%s]\n", 
	`´štbuf_Ëngth
(
pb
),…b->
buf
);

143 
	`¥rštbuf
(
pb
, "%s", "%s");

144 
	`´štf
("%d, [%s]\n", 
	`´štbuf_Ëngth
(
pb
),…b->
buf
);

146 
	`´štbuf_ä“
(
pb
);

147 
	`´štf
("%s:ƒnde¡\n", 
__func__
);

148 
	}
}

150 
	$maš
(
¬gc
, **
¬gv
)

152 
befÜe_»size
 = 0;

154 
	`mc_£t_debug
(1);

156 
	`‹¡_basic_´štbuf_mem£t
();

157 
	`´štf
("========================================\n");

158 
	`‹¡_´štbuf_mem£t_Ëngth
();

159 
	`´štf
("========================================\n");

160 
	`‹¡_´štbuf_mem­³nd
(&
befÜe_»size
);

161 
	`´štf
("========================================\n");

162 
	`‹¡_¥rštbuf
(
befÜe_»size
);

163 
	`´štf
("========================================\n");

166 
	}
}

	@json/example/tests/test_set_serializer.c

1 
	~<as£¹.h
>

2 
	~<¡dio.h
>

3 
	~<¡ršg.h
>

5 
	~"jsÚ.h
"

6 
	~"´štbuf.h
"

8 
	smyšfo
 {

9 
	mv®ue
;

12 
	gä“™_was_ÿÎed
 = 0;

13 
	$ä“™
(
jsÚ_objeù
 *
jso
, *
u£rd©a
)

15 
myšfo
 *
šfo
 = 
u£rd©a
;

16 
	`´štf
("ä“™, v®ue=%d\n", 
šfo
->
v®ue
);

18 
ä“™_was_ÿÎed
 = 1;

19 
	}
}

20 
	$cu¡om_£rŸliz”
(
jsÚ_objeù
 *
o
,

21 
´štbuf
 *
pb
,

22 
Ëv–
,

23 
æags
)

25 
	`¥rštbuf
(
pb
, "Custom Output");

27 
	}
}

29 
	$maš
(
¬gc
, **
¬gv
)

31 
jsÚ_objeù
 *
my_objeù
;

33 
	`MC_SET_DEBUG
(1);

35 
	`´štf
("Test setting,hen„esetting‡ custom serializer:\n");

36 
my_objeù
 = 
	`jsÚ_objeù_Ãw_objeù
();

37 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "abc", 
	`jsÚ_objeù_Ãw_št
(12));

38 
	`jsÚ_objeù_objeù_add
(
my_objeù
, "foo", 
	`jsÚ_objeù_Ãw_¡ršg
("bar"));

40 
	`´štf
("my_objeù.to_¡ršg(¡ªd¬d)=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_objeù
));

42 
myšfo
 
u£rd©a
 = { .
v®ue
 = 123 };

43 
	`jsÚ_objeù_£t_£rŸliz”
(
my_objeù
, 
cu¡om_£rŸliz”
, &
u£rd©a
, 
ä“™
);

45 
	`´štf
("my_objeù.to_¡ršg(cu¡om s”Ÿliz”)=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_objeù
));

47 
	`´štf
("Next†ine of output should be fromhe custom freeit function:\n");

48 
ä“™_was_ÿÎed
 = 0;

49 
	`jsÚ_objeù_£t_£rŸliz”
(
my_objeù
, 
NULL
, NULL, NULL);

50 
	`as£¹
(
ä“™_was_ÿÎed
);

52 
	`´štf
("my_objeù.to_¡ršg(¡ªd¬d)=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_objeù
));

54 
	`jsÚ_objeù_put
(
my_objeù
);

58 
my_objeù
 = 
	`jsÚ_objeù_Ãw_objeù
();

59 
	`´štf
("Checkhathe custom serializer isn't free'd untilhe†ast json_object_put:\n");

60 
	`jsÚ_objeù_£t_£rŸliz”
(
my_objeù
, 
cu¡om_£rŸliz”
, &
u£rd©a
, 
ä“™
);

61 
	`jsÚ_objeù_g‘
(
my_objeù
);

62 
	`jsÚ_objeù_put
(
my_objeù
);

63 
	`´štf
("my_objeù.to_¡ršg(cu¡om s”Ÿliz”)=%s\n", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
my_objeù
));

64 
	`´štf
("Next†ine of output should be fromhe custom freeit function:\n");

66 
ä“™_was_ÿÎed
 = 0;

67 
	`jsÚ_objeù_put
(
my_objeù
);

68 
	`as£¹
(
ä“™_was_ÿÎed
);

71 
	}
}

	@json/jconfig.h

8 
	#HAVE_DLFCN_H
 1

	)

14 
	#HAVE_FCNTL_H
 1

	)

17 
	#HAVE_INTTYPES_H
 1

	)

20 
	#HAVE_LIMITS_H
 1

	)

23 
	#HAVE_LOCALE_H
 1

	)

27 
	#HAVE_MALLOC
 1

	)

30 
	#HAVE_MEMORY_H
 1

	)

33 
	#HAVE_OPEN
 1

	)

37 
	#HAVE_REALLOC
 1

	)

40 
	#HAVE_SETLOCALE
 1

	)

43 
	#HAVE_SNPRINTF
 1

	)

46 
	#HAVE_STDARG_H
 1

	)

49 
	#HAVE_STDINT_H
 1

	)

52 
	#HAVE_STDLIB_H
 1

	)

55 
	#HAVE_STRCASECMP
 1

	)

58 
	#HAVE_STRDUP
 1

	)

61 
	#HAVE_STRERROR
 1

	)

64 
	#HAVE_STRINGS_H
 1

	)

67 
	#HAVE_STRING_H
 1

	)

70 
	#HAVE_STRNCASECMP
 1

	)

73 
	#HAVE_STRNDUP
 1

	)

76 
	#HAVE_SYSLOG_H
 1

	)

79 
	#HAVE_SYS_CDEFS_H
 1

	)

82 
	#HAVE_SYS_PARAM_H
 1

	)

85 
	#HAVE_SYS_STAT_H
 1

	)

88 
	#HAVE_SYS_TYPES_H
 1

	)

91 
	#HAVE_UNISTD_H
 1

	)

94 
	#HAVE_VASPRINTF
 1

	)

97 
	#HAVE_VPRINTF
 1

	)

100 
	#HAVE_VSNPRINTF
 1

	)

103 
	#HAVE_VSYSLOG
 1

	)

106 
	#JSON_C_HAVE_INTTYPES_H
 1

	)

110 
	#LT_OBJDIR
 ".libs/"

	)

113 
	#PACKAGE
 "jsÚ-c"

	)

116 
	#PACKAGE_BUGREPORT
 "jsÚ-c@googËgroups.com"

	)

119 
	#PACKAGE_NAME
 "jsÚ-c"

	)

122 
	#PACKAGE_STRING
 "jsÚ-ø0.11"

	)

125 
	#PACKAGE_TARNAME
 "jsÚ-c"

	)

128 
	#PACKAGE_URL
 ""

	)

131 
	#PACKAGE_VERSION
 "0.11"

	)

134 
	#STDC_HEADERS
 1

	)

137 
	#VERSION
 "0.11"

	)

	@json/json.h

13 #iâdeà
_jsÚ_h_


14 
	#_jsÚ_h_


	)

16 #ifdeà
__ılu¥lus


20 
	~"b™s.h
"

21 
	~"debug.h
"

22 
	~"lškhash.h
"

23 
	~"¬¿yli¡.h
"

24 
	~"jsÚ_ut.h
"

25 
	~"jsÚ_objeù.h
"

26 
	~"jsÚ_tok’”.h
"

27 
	~"jsÚ_objeù_™”©Ü.h
"

28 
	~"jsÚ_c_v”siÚ.h
"

30 #ifdeà
__ılu¥lus


	@json/json_c_version.c

7 
	~"jcÚfig.h
"

9 
	~"jsÚ_c_v”siÚ.h
"

11 cÚ¡ *
	$jsÚ_c_v”siÚ
()

13  
JSON_C_VERSION
;

14 
	}
}

16 
	$jsÚ_c_v”siÚ_num
()

18  
JSON_C_VERSION_NUM
;

19 
	}
}

	@json/json_c_version.h

8 #iâdeà
_jsÚ_c_v”siÚ_h_


9 
	#_jsÚ_c_v”siÚ_h_


	)

11 
	#JSON_C_MAJOR_VERSION
 0

	)

12 
	#JSON_C_MINOR_VERSION
 11

	)

13 
	#JSON_C_MICRO_VERSION
 0

	)

14 
	#JSON_C_VERSION_NUM
 ((
JSON_C_MAJOR_VERSION
 << 16) | \

15 (
JSON_C_MINOR_VERSION
 << 8) | \

16 
JSON_C_MICRO_VERSION
)

	)

17 
	#JSON_C_VERSION
 "0.11"

	)

19 cÚ¡ *
jsÚ_c_v”siÚ
();

20 
jsÚ_c_v”siÚ_num
();

	@json/json_config.h

4 
	#JSON_C_HAVE_INTTYPES_H
 1

	)

	@json/json_inttypes.h

2 #iâdeà
_jsÚ_š‰y³s_h_


3 
	#_jsÚ_š‰y³s_h_


	)

5 
	~"jsÚ_cÚfig.h
"

7 #ià
defšed
(
_MSC_VER
) && _MSC_VER < 1700

10 
__št32
 
	tšt32_t
;

11 
	#INT32_MIN
 ((
št32_t
)
_I32_MIN
)

	)

12 
	#INT32_MAX
 ((
št32_t
)
_I32_MAX
)

	)

13 
__št64
 
	tšt64_t
;

14 
	#INT64_MIN
 ((
št64_t
)
_I64_MIN
)

	)

15 
	#INT64_MAX
 ((
št64_t
)
_I64_MAX
)

	)

16 
	#PRId64
 "I64d"

	)

17 
	#SCNd64
 "I64d"

	)

21 #ifdeà
JSON_C_HAVE_INTTYPES_H


22 
	~<š‰y³s.h
>

	@json/json_object.c

13 
	~"jcÚfig.h
"

15 
	~<¡dio.h
>

16 
	~<¡dlib.h
>

17 
	~<¡ddef.h
>

18 
	~<¡ršg.h
>

20 
	~"debug.h
"

21 
	~"´štbuf.h
"

22 
	~"lškhash.h
"

23 
	~"¬¿yli¡.h
"

24 
	~"jsÚ_š‰y³s.h
"

25 
	~"jsÚ_objeù.h
"

26 
	~"jsÚ_objeù_´iv©e.h
"

27 
	~"jsÚ_ut.h
"

29 #ià!
defšed
(
HAVE_STRDUP
è&& defšed(
_MSC_VER
)

31 
	#¡rdup
 
_¡rdup


	)

32 #–ià!
defšed
(
HAVE_STRDUP
)

33 #”rÜ 
You
 dØ
nÙ
 
have
 
¡rdup
 
Ú
 
your
 
sy¡em
.

36 #ià!
defšed
(
HAVE_STRNDUP
)

37 * 
¡ºdup
(cÚ¡ * 
¡r
, 
size_t
 
n
);

43 cÚ¡ *
	gjsÚ_numb”_ch¬s
 = "0123456789.+-eE";

44 cÚ¡ *
	gjsÚ_hex_ch¬s
 = "0123456789abcdefABCDEF";

46 
jsÚ_objeù_g’”ic_d–‘e
(
jsÚ_objeù
* 
jso
);

47 
jsÚ_objeù
* 
jsÚ_objeù_Ãw
(
jsÚ_ty³
 
o_ty³
);

49 
jsÚ_objeù_to_jsÚ_¡ršg_â
 
	gjsÚ_objeù_objeù_to_jsÚ_¡ršg
;

50 
jsÚ_objeù_to_jsÚ_¡ršg_â
 
	gjsÚ_objeù_boŞ—n_to_jsÚ_¡ršg
;

51 
jsÚ_objeù_to_jsÚ_¡ršg_â
 
	gjsÚ_objeù_št_to_jsÚ_¡ršg
;

52 
jsÚ_objeù_to_jsÚ_¡ršg_â
 
	gjsÚ_objeù_doubË_to_jsÚ_¡ršg
;

53 
jsÚ_objeù_to_jsÚ_¡ršg_â
 
	gjsÚ_objeù_¡ršg_to_jsÚ_¡ršg
;

54 
jsÚ_objeù_to_jsÚ_¡ršg_â
 
	gjsÚ_objeù_¬¿y_to_jsÚ_¡ršg
;

59 #ifdeà
REFCOUNT_DEBUG


61 
lh_bË
 *
	gjsÚ_objeù_bË
;

63 
	$jsÚ_objeù_š™
(è
	`__©Œibu‹__
 ((
cÚ¡ruùÜ
));

64 
	$jsÚ_objeù_š™
() {

65 
	`MC_DEBUG
("json_object_init: creating objectable\n");

66 
jsÚ_objeù_bË
 = 
	`lh_k±r_bË_Ãw
(128, "jsÚ_objeù_bË", 
NULL
);

67 
	}
}

69 
	$jsÚ_objeù_fši
(è
	`__©Œibu‹__
 ((
de¡ruùÜ
));

70 
	$jsÚ_objeù_fši
() {

71 
lh_’Œy
 *
’t
;

72 if(
	`MC_GET_DEBUG
()) {

73 ià(
jsÚ_objeù_bË
->
couÁ
) {

74 
	`MC_DEBUG
("json_object_fini: %d„eferenced objects‡tƒxit\n",

75 
jsÚ_objeù_bË
->
couÁ
);

76 
	`lh_fÜ—ch
(
jsÚ_objeù_bË
, 
’t
) {

77 
jsÚ_objeù
* 
obj
 = (jsÚ_objeù*)
’t
->
v
;

78 
	`MC_DEBUG
("\t%s:%p\n", 
	`jsÚ_ty³_to_Çme
(
obj
->
o_ty³
), obj);

82 
	`MC_DEBUG
("json_object_fini: freeing objectable\n");

83 
	`lh_bË_ä“
(
jsÚ_objeù_bË
);

84 
	}
}

90 
	$jsÚ_esÿ³_¡r
(
´štbuf
 *
pb
, *
¡r
, 
Ën
)

92 
pos
 = 0, 
¡¬t_off£t
 = 0;

93 
c
;

94 
Ën
--) {

95 
c
 = 
¡r
[
pos
];

96 
c
) {

105 if(
pos
 - 
¡¬t_off£t
 > 0)

106 
	`´štbuf_mem­³nd
(
pb
, 
¡r
 + 
¡¬t_off£t
, 
pos
 - start_offset);

107 if(
c
 =ğ'\b'è
	`´štbuf_mem­³nd
(
pb
, "\\b", 2);

108 if(
c
 =ğ'\n'è
	`´štbuf_mem­³nd
(
pb
, "\\n", 2);

109 if(
c
 =ğ'\r'è
	`´štbuf_mem­³nd
(
pb
, "\\r", 2);

110 if(
c
 =ğ'\t'è
	`´štbuf_mem­³nd
(
pb
, "\\t", 2);

111 if(
c
 =ğ'\f'è
	`´štbuf_mem­³nd
(
pb
, "\\f", 2);

112 if(
c
 =ğ'"'è
	`´štbuf_mem­³nd
(
pb
, "\\\"", 2);

113 if(
c
 =ğ'\\'è
	`´štbuf_mem­³nd
(
pb
, "\\\\", 2);

114 if(
c
 =ğ'/'è
	`´štbuf_mem­³nd
(
pb
, "\\/", 2);

115 
¡¬t_off£t
 = ++
pos
;

118 if(
c
 < ' ') {

119 if(
pos
 - 
¡¬t_off£t
 > 0)

120 
	`´štbuf_mem­³nd
(
pb
, 
¡r
 + 
¡¬t_off£t
, 
pos
 - start_offset);

121 
	`¥rštbuf
(
pb
, "\\u00%c%c",

122 
jsÚ_hex_ch¬s
[
c
 >> 4],

123 
jsÚ_hex_ch¬s
[
c
 & 0xf]);

124 
¡¬t_off£t
 = ++
pos
;

125 } 
pos
++;

128 if(
pos
 - 
¡¬t_off£t
 > 0)

129 
	`´štbuf_mem­³nd
(
pb
, 
¡r
 + 
¡¬t_off£t
, 
pos
 - start_offset);

131 
	}
}

136 
jsÚ_objeù
* 
	$jsÚ_objeù_g‘
(
jsÚ_objeù
 *
jso
)

138 if(
jso
) {

139 
jso
->
_»f_couÁ
++;

141  
jso
;

142 
	}
}

144 
	$jsÚ_objeù_put
(
jsÚ_objeù
 *
jso
)

146 if(
jso
)

148 
jso
->
_»f_couÁ
--;

149 if(!
jso
->
_»f_couÁ
)

151 ià(
jso
->
_u£r_d–‘e
)

152 
jso
->
	`_u£r_d–‘e
(jso, jso->
_u£rd©a
);

153 
jso
->
	`_d–‘e
(jso);

158 
	}
}

163 
	$jsÚ_objeù_g’”ic_d–‘e
(
jsÚ_objeù
* 
jso
)

165 #ifdeà
REFCOUNT_DEBUG


166 
	`MC_DEBUG
("json_object_delete_%s: %p\n",

167 
	`jsÚ_ty³_to_Çme
(
jso
->
o_ty³
), jso);

168 
	`lh_bË_d–‘e
(
jsÚ_objeù_bË
, 
jso
);

170 
	`´štbuf_ä“
(
jso
->
_pb
);

171 
	`ä“
(
jso
);

172 
	}
}

174 
jsÚ_objeù
* 
	$jsÚ_objeù_Ãw
(
jsÚ_ty³
 
o_ty³
)

176 
jsÚ_objeù
 *
jso
;

178 
jso
 = (
jsÚ_objeù
*)
	`ÿÎoc
((json_object), 1);

179 if(!
jso
è 
NULL
;

180 
jso
->
o_ty³
 = o_type;

181 
jso
->
_»f_couÁ
 = 1;

182 
jso
->
_d–‘e
 = &
jsÚ_objeù_g’”ic_d–‘e
;

183 #ifdeà
REFCOUNT_DEBUG


184 
	`lh_bË_š£¹
(
jsÚ_objeù_bË
, 
jso
, jso);

185 
	`MC_DEBUG
("jsÚ_objeù_Ãw_%s: %p\n", 
	`jsÚ_ty³_to_Çme
(
jso
->
o_ty³
), jso);

187  
jso
;

188 
	}
}

193 
	$jsÚ_objeù_is_ty³
(
jsÚ_objeù
 *
jso
, 
jsÚ_ty³
 
ty³
)

195 ià(!
jso
)

196  (
ty³
 =ğ
jsÚ_ty³_nuÎ
);

197  (
jso
->
o_ty³
 =ğ
ty³
);

198 
	}
}

200 
jsÚ_ty³
 
	$jsÚ_objeù_g‘_ty³
(
jsÚ_objeù
 *
jso
)

202 ià(!
jso
)

203  
jsÚ_ty³_nuÎ
;

204  
jso
->
o_ty³
;

205 
	}
}

209 
	$jsÚ_objeù_£t_£rŸliz”
(
jsÚ_objeù
 *
jso
,

210 
jsÚ_objeù_to_jsÚ_¡ršg_â
 
to_¡ršg_func
,

211 *
u£rd©a
,

212 
jsÚ_objeù_d–‘e_â
 *
u£r_d–‘e
)

215 ià(
jso
->
_u£r_d–‘e
)

217 
jso
->
	`_u£r_d–‘e
(jso, jso->
_u£rd©a
);

219 
jso
->
_u£rd©a
 = 
NULL
;

220 
jso
->
_u£r_d–‘e
 = 
NULL
;

222 ià(
to_¡ršg_func
 =ğ
NULL
)

225 
jso
->
o_ty³
)

227 
jsÚ_ty³_nuÎ
:

228 
jso
->
_to_jsÚ_¡ršg
 = 
NULL
;

230 
jsÚ_ty³_boŞ—n
:

231 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_boŞ—n_to_jsÚ_¡ršg
;

233 
jsÚ_ty³_doubË
:

234 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_doubË_to_jsÚ_¡ršg
;

236 
jsÚ_ty³_št
:

237 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_št_to_jsÚ_¡ršg
;

239 
jsÚ_ty³_objeù
:

240 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_objeù_to_jsÚ_¡ršg
;

242 
jsÚ_ty³_¬¿y
:

243 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_¬¿y_to_jsÚ_¡ršg
;

245 
jsÚ_ty³_¡ršg
:

246 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_¡ršg_to_jsÚ_¡ršg
;

252 
jso
->
_to_jsÚ_¡ršg
 = 
to_¡ršg_func
;

253 
jso
->
_u£rd©a
 = 
u£rd©a
;

254 
jso
->
_u£r_d–‘e
 = 
u£r_d–‘e
;

255 
	}
}

260 cÚ¡ * 
	$jsÚ_objeù_to_jsÚ_¡ršg_ext
(
jsÚ_objeù
 *
jso
, 
æags
)

262 ià(!
jso
)

265 ià((!
jso
->
_pb
è&& !(jso->_pb = 
	`´štbuf_Ãw
()))

266  
NULL
;

268 
	`´štbuf_»£t
(
jso
->
_pb
);

270 if(
jso
->
	`_to_jsÚ_¡ršg
(jso, jso->
_pb
, 0, 
æags
) < 0)

271  
NULL
;

273  
jso
->
_pb
->
buf
;

274 
	}
}

278 cÚ¡ * 
	$jsÚ_objeù_to_jsÚ_¡ršg
(
jsÚ_objeù
 *
jso
)

280  
	`jsÚ_objeù_to_jsÚ_¡ršg_ext
(
jso
, 
JSON_C_TO_STRING_SPACED
);

281 
	}
}

283 
	$šd’t
(
´štbuf
 *
pb
, 
Ëv–
, 
æags
)

285 ià(
æags
 & 
JSON_C_TO_STRING_PRETTY
)

287 
	`´štbuf_mem£t
(
pb
, -1, ' ', 
Ëv–
 * 2);

289 
	}
}

293 
	$jsÚ_objeù_objeù_to_jsÚ_¡ršg
(
jsÚ_objeù
* 
jso
,

294 
´štbuf
 *
pb
,

295 
Ëv–
,

296 
æags
)

298 
had_chd»n
 = 0;

299 
jsÚ_objeù_™”
 
™”
;

301 
	`¥rštbuf
(
pb
, "{" );

302 ià(
æags
 & 
JSON_C_TO_STRING_PRETTY
)

303 
	`¥rštbuf
(
pb
, "\n");

304 
	`jsÚ_objeù_objeù_fÜ—chC
(
jso
, 
™”
)

306 ià(
had_chd»n
)

308 
	`¥rštbuf
(
pb
, ",");

309 ià(
æags
 & 
JSON_C_TO_STRING_PRETTY
)

310 
	`¥rštbuf
(
pb
, "\n");

312 
had_chd»n
 = 1;

313 ià(
æags
 & 
JSON_C_TO_STRING_SPACED
)

314 
	`¥rštbuf
(
pb
, " ");

315 
	`šd’t
(
pb
, 
Ëv–
+1, 
æags
);

316 
	`¥rštbuf
(
pb
, "\"");

317 
	`jsÚ_esÿ³_¡r
(
pb
, 
™”
.
key
, 
	`¡¾’
(iter.key));

318 ià(
æags
 & 
JSON_C_TO_STRING_SPACED
)

319 
	`¥rštbuf
(
pb
, "\": ");

321 
	`¥rštbuf
(
pb
, "\":");

322 if(
™”
.
v®
 =ğ
NULL
)

323 
	`¥rštbuf
(
pb
, "null");

325 
™”
.
v®
->
	`_to_jsÚ_¡ršg
(™”.v®, 
pb
, 
Ëv–
+1,
æags
);

327 ià(
æags
 & 
JSON_C_TO_STRING_PRETTY
)

329 ià(
had_chd»n
)

330 
	`¥rštbuf
(
pb
, "\n");

331 
	`šd’t
(
pb
,
Ëv–
,
æags
);

333 ià(
æags
 & 
JSON_C_TO_STRING_SPACED
)

334  
	`¥rštbuf
(
pb
, " }");

336  
	`¥rštbuf
(
pb
, "}");

337 
	}
}

340 
	$jsÚ_objeù_lh_’Œy_ä“
(
lh_’Œy
 *
’t
)

342 
	`ä“
(
’t
->
k
);

343 
	`jsÚ_objeù_put
((
jsÚ_objeù
*)
’t
->
v
);

344 
	}
}

346 
	$jsÚ_objeù_objeù_d–‘e
(
jsÚ_objeù
* 
jso
)

348 
	`lh_bË_ä“
(
jso
->
o
.
c_objeù
);

349 
	`jsÚ_objeù_g’”ic_d–‘e
(
jso
);

350 
	}
}

352 
jsÚ_objeù
* 
	$jsÚ_objeù_Ãw_objeù
()

354 
jsÚ_objeù
 *
jso
 = 
	`jsÚ_objeù_Ãw
(
jsÚ_ty³_objeù
);

355 if(!
jso
è 
NULL
;

356 
jso
->
_d–‘e
 = &
jsÚ_objeù_objeù_d–‘e
;

357 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_objeù_to_jsÚ_¡ršg
;

358 
jso
->
o
.
c_objeù
 = 
	`lh_kch¬_bË_Ãw
(
JSON_OBJECT_DEF_HASH_ENTRIES
,

359 
NULL
, &
jsÚ_objeù_lh_’Œy_ä“
);

360  
jso
;

361 
	}
}

363 
lh_bË
* 
	$jsÚ_objeù_g‘_objeù
(
jsÚ_objeù
 *
jso
)

365 if(!
jso
è 
NULL
;

366 
jso
->
o_ty³
) {

367 
jsÚ_ty³_objeù
:

368  
jso
->
o
.
c_objeù
;

370  
NULL
;

372 
	}
}

374 
	$jsÚ_objeù_objeù_add
(
jsÚ_objeù
* 
jso
, cÚ¡ *
key
,

375 
jsÚ_objeù
 *
v®
)

379 
jsÚ_objeù
 *
exi¡šg_v®ue
 = 
NULL
;

380 
lh_’Œy
 *
exi¡šg_’Œy
;

381 
exi¡šg_’Œy
 = 
	`lh_bË_lookup_’Œy
(
jso
->
o
.
c_objeù
, (*)
key
);

382 ià(!
exi¡šg_’Œy
)

384 
	`lh_bË_š£¹
(
jso
->
o
.
c_objeù
, 
	`¡rdup
(
key
), 
v®
);

387 
exi¡šg_v®ue
 = (*)
exi¡šg_’Œy
->
v
;

388 ià(
exi¡šg_v®ue
)

389 
	`jsÚ_objeù_put
(
exi¡šg_v®ue
);

390 
exi¡šg_’Œy
->
v
 = 
v®
;

391 
	}
}

393 
	$jsÚ_objeù_objeù_Ëngth
(
jsÚ_objeù
 *
jso
)

395  
	`lh_bË_Ëngth
(
jso
->
o
.
c_objeù
);

396 
	}
}

398 
jsÚ_objeù
* 
	$jsÚ_objeù_objeù_g‘
(
jsÚ_objeù
* 
jso
, cÚ¡ *
key
)

400 
jsÚ_objeù
 *
»suÉ
 = 
NULL
;

401 
	`jsÚ_objeù_objeù_g‘_ex
(
jso
, 
key
, &
»suÉ
);

402  
»suÉ
;

403 
	}
}

405 
jsÚ_boŞ
 
	$jsÚ_objeù_objeù_g‘_ex
(
jsÚ_objeù
* 
jso
, cÚ¡ *
key
, jsÚ_objeù **
v®ue
)

407 ià(
v®ue
 !ğ
NULL
)

408 *
v®ue
 = 
NULL
;

410 ià(
NULL
 =ğ
jso
)

411  
FALSE
;

413 
jso
->
o_ty³
)

415 
jsÚ_ty³_objeù
:

416  
	`lh_bË_lookup_ex
(
jso
->
o
.
c_objeù
, (*)
key
, (**)
v®ue
);

418 ià(
v®ue
 !ğ
NULL
)

419 *
v®ue
 = 
NULL
;

420  
FALSE
;

422 
	}
}

424 
	$jsÚ_objeù_objeù_d–
(
jsÚ_objeù
* 
jso
, cÚ¡ *
key
)

426 
	`lh_bË_d–‘e
(
jso
->
o
.
c_objeù
, 
key
);

427 
	}
}

432 
	$jsÚ_objeù_boŞ—n_to_jsÚ_¡ršg
(
jsÚ_objeù
* 
jso
,

433 
´štbuf
 *
pb
,

434 
Ëv–
,

435 
æags
)

437 if(
jso
->
o
.
c_boŞ—n
è 
	`¥rštbuf
(
pb
, "true");

438  
	`¥rštbuf
(
pb
, "false");

439 
	}
}

441 
jsÚ_objeù
* 
	$jsÚ_objeù_Ãw_boŞ—n
(
jsÚ_boŞ
 
b
)

443 
jsÚ_objeù
 *
jso
 = 
	`jsÚ_objeù_Ãw
(
jsÚ_ty³_boŞ—n
);

444 if(!
jso
è 
NULL
;

445 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_boŞ—n_to_jsÚ_¡ršg
;

446 
jso
->
o
.
c_boŞ—n
 = 
b
;

447  
jso
;

448 
	}
}

450 
jsÚ_boŞ
 
	$jsÚ_objeù_g‘_boŞ—n
(
jsÚ_objeù
 *
jso
)

452 if(!
jso
è 
FALSE
;

453 
jso
->
o_ty³
) {

454 
jsÚ_ty³_boŞ—n
:

455  
jso
->
o
.
c_boŞ—n
;

456 
jsÚ_ty³_št
:

457  (
jso
->
o
.
c_št64
 != 0);

458 
jsÚ_ty³_doubË
:

459  (
jso
->
o
.
c_doubË
 != 0);

460 
jsÚ_ty³_¡ršg
:

461  (
jso
->
o
.
c_¡ršg
.
Ën
 != 0);

463  
FALSE
;

465 
	}
}

470 
	$jsÚ_objeù_št_to_jsÚ_¡ršg
(
jsÚ_objeù
* 
jso
,

471 
´štbuf
 *
pb
,

472 
Ëv–
,

473 
æags
)

475  
	`¥rštbuf
(
pb
, "%"
PRId64
, 
jso
->
o
.
c_št64
);

476 
	}
}

478 
jsÚ_objeù
* 
	$jsÚ_objeù_Ãw_št
(
št32_t
 
i
)

480 
jsÚ_objeù
 *
jso
 = 
	`jsÚ_objeù_Ãw
(
jsÚ_ty³_št
);

481 if(!
jso
è 
NULL
;

482 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_št_to_jsÚ_¡ršg
;

483 
jso
->
o
.
c_št64
 = 
i
;

484  
jso
;

485 
	}
}

487 
št32_t
 
	$jsÚ_objeù_g‘_št
(
jsÚ_objeù
 *
jso
)

489 
št64_t
 
cšt64
;

490 
jsÚ_ty³
 
o_ty³
;

492 if(!
jso
)  0;

494 
o_ty³
 = 
jso
->o_type;

495 
cšt64
 = 
jso
->
o
.
c_št64
;

497 ià(
o_ty³
 =ğ
jsÚ_ty³_¡ršg
)

503 ià(
	`jsÚ_·r£_št64
(
jso
->
o
.
c_¡ršg
.
¡r
, &
cšt64
) != 0)

505 
o_ty³
 = 
jsÚ_ty³_št
;

508 
o_ty³
) {

509 
jsÚ_ty³_št
:

511 ià(
cšt64
 <ğ
INT32_MIN
)

512  
INT32_MIN
;

513 ià(
cšt64
 >ğ
INT32_MAX
)

514  
INT32_MAX
;

516  (
št32_t
)
cšt64
;

517 
jsÚ_ty³_doubË
:

518  (
št32_t
)
jso
->
o
.
c_doubË
;

519 
jsÚ_ty³_boŞ—n
:

520  
jso
->
o
.
c_boŞ—n
;

524 
	}
}

526 
jsÚ_objeù
* 
	$jsÚ_objeù_Ãw_št64
(
št64_t
 
i
)

528 
jsÚ_objeù
 *
jso
 = 
	`jsÚ_objeù_Ãw
(
jsÚ_ty³_št
);

529 if(!
jso
è 
NULL
;

530 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_št_to_jsÚ_¡ršg
;

531 
jso
->
o
.
c_št64
 = 
i
;

532  
jso
;

533 
	}
}

535 
št64_t
 
	$jsÚ_objeù_g‘_št64
(
jsÚ_objeù
 *
jso
)

537 
št64_t
 
cšt
;

539 if(!
jso
)  0;

540 
jso
->
o_ty³
) {

541 
jsÚ_ty³_št
:

542  
jso
->
o
.
c_št64
;

543 
jsÚ_ty³_doubË
:

544  (
št64_t
)
jso
->
o
.
c_doubË
;

545 
jsÚ_ty³_boŞ—n
:

546  
jso
->
o
.
c_boŞ—n
;

547 
jsÚ_ty³_¡ršg
:

548 ià(
	`jsÚ_·r£_št64
(
jso
->
o
.
c_¡ršg
.
¡r
, &
cšt
) == 0)  cint;

552 
	}
}

557 
	$jsÚ_objeù_doubË_to_jsÚ_¡ršg
(
jsÚ_objeù
* 
jso
,

558 
´štbuf
 *
pb
,

559 
Ëv–
,

560 
æags
)

562 
buf
[128], *
p
, *
q
;

563 
size
;

565 
size
 = 
	`¢´štf
(
buf
, 128, "%f", 
jso
->
o
.
c_doubË
);

566 
p
 = 
	`¡rchr
(
buf
, ',');

567 ià(
p
) {

568 *
p
 = '.';

570 
p
 = 
	`¡rchr
(
buf
, '.');

572 ià(
p
 && (
æags
 & 
JSON_C_TO_STRING_NOZERO
)) {

574 
p
++;

575 
q
=
p
 ; *q ; q++) {

576 ià(*
q
!='0'è
p
=q;

579 *(++
p
) = 0;

580 
size
 = 
p
-
buf
;

582 
	`´štbuf_mem­³nd
(
pb
, 
buf
, 
size
);

583  
size
;

584 
	}
}

586 
jsÚ_objeù
* 
	$jsÚ_objeù_Ãw_doubË
(
d
)

588 
jsÚ_objeù
 *
jso
 = 
	`jsÚ_objeù_Ãw
(
jsÚ_ty³_doubË
);

589 if(!
jso
è 
NULL
;

590 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_doubË_to_jsÚ_¡ršg
;

591 
jso
->
o
.
c_doubË
 = 
d
;

592  
jso
;

593 
	}
}

595 
	$jsÚ_objeù_g‘_doubË
(
jsÚ_objeù
 *
jso
)

597 
cdoubË
;

599 if(!
jso
)  0.0;

600 
jso
->
o_ty³
) {

601 
jsÚ_ty³_doubË
:

602  
jso
->
o
.
c_doubË
;

603 
jsÚ_ty³_št
:

604  
jso
->
o
.
c_št64
;

605 
jsÚ_ty³_boŞ—n
:

606  
jso
->
o
.
c_boŞ—n
;

607 
jsÚ_ty³_¡ršg
:

608 if(
	`ssÿnf
(
jso
->
o
.
c_¡ršg
.
¡r
, "%lf", &
cdoubË
) == 1)  cdouble;

612 
	}
}

617 
	$jsÚ_objeù_¡ršg_to_jsÚ_¡ršg
(
jsÚ_objeù
* 
jso
,

618 
´štbuf
 *
pb
,

619 
Ëv–
,

620 
æags
)

622 
	`¥rštbuf
(
pb
, "\"");

623 
	`jsÚ_esÿ³_¡r
(
pb
, 
jso
->
o
.
c_¡ršg
.
¡r
, jso->o.c_¡ršg.
Ën
);

624 
	`¥rštbuf
(
pb
, "\"");

626 
	}
}

628 
	$jsÚ_objeù_¡ršg_d–‘e
(
jsÚ_objeù
* 
jso
)

630 
	`ä“
(
jso
->
o
.
c_¡ršg
.
¡r
);

631 
	`jsÚ_objeù_g’”ic_d–‘e
(
jso
);

632 
	}
}

634 
jsÚ_objeù
* 
	$jsÚ_objeù_Ãw_¡ršg
(cÚ¡ *
s
)

636 
jsÚ_objeù
 *
jso
 = 
	`jsÚ_objeù_Ãw
(
jsÚ_ty³_¡ršg
);

637 if(!
jso
è 
NULL
;

638 
jso
->
_d–‘e
 = &
jsÚ_objeù_¡ršg_d–‘e
;

639 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_¡ršg_to_jsÚ_¡ršg
;

640 
jso
->
o
.
c_¡ršg
.
¡r
 = 
	`¡rdup
(
s
);

641 
jso
->
o
.
c_¡ršg
.
Ën
 = 
	`¡¾’
(
s
);

642  
jso
;

643 
	}
}

645 
jsÚ_objeù
* 
	$jsÚ_objeù_Ãw_¡ršg_Ën
(cÚ¡ *
s
, 
Ën
)

647 
jsÚ_objeù
 *
jso
 = 
	`jsÚ_objeù_Ãw
(
jsÚ_ty³_¡ršg
);

648 if(!
jso
è 
NULL
;

649 
jso
->
_d–‘e
 = &
jsÚ_objeù_¡ršg_d–‘e
;

650 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_¡ršg_to_jsÚ_¡ršg
;

651 
jso
->
o
.
c_¡ršg
.
¡r
 = (*)
	`m®loc
(
Ën
 + 1);

652 
	`memıy
(
jso
->
o
.
c_¡ršg
.
¡r
, (*)
s
, 
Ën
);

653 
jso
->
o
.
c_¡ršg
.
¡r
[
Ën
] = '\0';

654 
jso
->
o
.
c_¡ršg
.
Ën
 =†en;

655  
jso
;

656 
	}
}

658 cÚ¡ * 
	$jsÚ_objeù_g‘_¡ršg
(
jsÚ_objeù
 *
jso
)

660 if(!
jso
è 
NULL
;

661 
jso
->
o_ty³
) {

662 
jsÚ_ty³_¡ršg
:

663  
jso
->
o
.
c_¡ršg
.
¡r
;

665  
	`jsÚ_objeù_to_jsÚ_¡ršg
(
jso
);

667 
	}
}

669 
	$jsÚ_objeù_g‘_¡ršg_Ën
(
jsÚ_objeù
 *
jso
) {

670 if(!
jso
)  0;

671 
jso
->
o_ty³
) {

672 
jsÚ_ty³_¡ršg
:

673  
jso
->
o
.
c_¡ršg
.
Ën
;

677 
	}
}

682 
	$jsÚ_objeù_¬¿y_to_jsÚ_¡ršg
(
jsÚ_objeù
* 
jso
,

683 
´štbuf
 *
pb
,

684 
Ëv–
,

685 
æags
)

687 
had_chd»n
 = 0;

688 
ii
;

689 
	`¥rštbuf
(
pb
, "[");

690 ià(
æags
 & 
JSON_C_TO_STRING_PRETTY
)

691 
	`¥rštbuf
(
pb
, "\n");

692 
ii
=0; i˜< 
	`jsÚ_objeù_¬¿y_Ëngth
(
jso
); ii++)

694 
jsÚ_objeù
 *
v®
;

695 ià(
had_chd»n
)

697 
	`¥rštbuf
(
pb
, ",");

698 ià(
æags
 & 
JSON_C_TO_STRING_PRETTY
)

699 
	`¥rštbuf
(
pb
, "\n");

701 
had_chd»n
 = 1;

702 ià(
æags
 & 
JSON_C_TO_STRING_SPACED
)

703 
	`¥rštbuf
(
pb
, " ");

704 
	`šd’t
(
pb
, 
Ëv–
 + 1, 
æags
);

705 
v®
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
jso
, 
ii
);

706 if(
v®
 =ğ
NULL
)

707 
	`¥rštbuf
(
pb
, "null");

709 
v®
->
	`_to_jsÚ_¡ršg
(v®, 
pb
, 
Ëv–
+1, 
æags
);

711 ià(
æags
 & 
JSON_C_TO_STRING_PRETTY
)

713 ià(
had_chd»n
)

714 
	`¥rštbuf
(
pb
, "\n");

715 
	`šd’t
(
pb
,
Ëv–
,
æags
);

718 ià(
æags
 & 
JSON_C_TO_STRING_SPACED
)

719  
	`¥rštbuf
(
pb
, " ]");

721  
	`¥rštbuf
(
pb
, "]");

722 
	}
}

724 
	$jsÚ_objeù_¬¿y_’Œy_ä“
(*
d©a
)

726 
	`jsÚ_objeù_put
((
jsÚ_objeù
*)
d©a
);

727 
	}
}

729 
	$jsÚ_objeù_¬¿y_d–‘e
(
jsÚ_objeù
* 
jso
)

731 
	`¬¿y_li¡_ä“
(
jso
->
o
.
c_¬¿y
);

732 
	`jsÚ_objeù_g’”ic_d–‘e
(
jso
);

733 
	}
}

735 
jsÚ_objeù
* 
	$jsÚ_objeù_Ãw_¬¿y
()

737 
jsÚ_objeù
 *
jso
 = 
	`jsÚ_objeù_Ãw
(
jsÚ_ty³_¬¿y
);

738 if(!
jso
è 
NULL
;

739 
jso
->
_d–‘e
 = &
jsÚ_objeù_¬¿y_d–‘e
;

740 
jso
->
_to_jsÚ_¡ršg
 = &
jsÚ_objeù_¬¿y_to_jsÚ_¡ršg
;

741 
jso
->
o
.
c_¬¿y
 = 
	`¬¿y_li¡_Ãw
(&
jsÚ_objeù_¬¿y_’Œy_ä“
);

742  
jso
;

743 
	}
}

745 
¬¿y_li¡
* 
	$jsÚ_objeù_g‘_¬¿y
(
jsÚ_objeù
 *
jso
)

747 if(!
jso
è 
NULL
;

748 
jso
->
o_ty³
) {

749 
jsÚ_ty³_¬¿y
:

750  
jso
->
o
.
c_¬¿y
;

752  
NULL
;

754 
	}
}

756 
jsÚ_objeù_¬¿y_sÜt
(
jsÚ_objeù
 *
jso
, (*
sÜt_â
)(const *, const *))

758 
	`¬¿y_li¡_sÜt
(
jso
->
o
.
c_¬¿y
, 
sÜt_â
);

759 
	}
}

761 
	$jsÚ_objeù_¬¿y_Ëngth
(
jsÚ_objeù
 *
jso
)

763  
	`¬¿y_li¡_Ëngth
(
jso
->
o
.
c_¬¿y
);

764 
	}
}

766 
	$jsÚ_objeù_¬¿y_add
(
jsÚ_objeù
 *
jso
,jsÚ_objeù *
v®
)

768  
	`¬¿y_li¡_add
(
jso
->
o
.
c_¬¿y
, 
v®
);

769 
	}
}

771 
	$jsÚ_objeù_¬¿y_put_idx
(
jsÚ_objeù
 *
jso
, 
idx
,

772 
jsÚ_objeù
 *
v®
)

774  
	`¬¿y_li¡_put_idx
(
jso
->
o
.
c_¬¿y
, 
idx
, 
v®
);

775 
	}
}

777 
jsÚ_objeù
* 
	$jsÚ_objeù_¬¿y_g‘_idx
(
jsÚ_objeù
 *
jso
,

778 
idx
)

780  (
jsÚ_objeù
*)
	`¬¿y_li¡_g‘_idx
(
jso
->
o
.
c_¬¿y
, 
idx
);

781 
	}
}

	@json/json_object.h

13 #iâdeà
_jsÚ_objeù_h_


14 
	#_jsÚ_objeù_h_


	)

16 
	~"jsÚ_š‰y³s.h
"

18 #ifdeà
__ılu¥lus


22 
	#JSON_OBJECT_DEF_HASH_ENTRIES
 16

	)

29 
	#JSON_C_TO_STRING_PLAIN
 0

	)

35 
	#JSON_C_TO_STRING_SPACED
 (1<<0)

	)

44 
	#JSON_C_TO_STRING_PRETTY
 (1<<1)

	)

48 
	#JSON_C_TO_STRING_NOZERO
 (1<<2)

	)

50 #undeà
FALSE


51 
	#FALSE
 ((
jsÚ_boŞ
)0)

	)

53 #undeà
TRUE


54 
	#TRUE
 ((
jsÚ_boŞ
)1)

	)

56 cÚ¡ *
jsÚ_numb”_ch¬s
;

57 cÚ¡ *
jsÚ_hex_ch¬s
;

60 
	sjsÚ_objeù_™”


62 *
	gkey
;

63 
jsÚ_objeù
 *
	gv®
;

64 
lh_’Œy
 *
	g’Œy
;

69 
	tjsÚ_boŞ
;

70 
´štbuf
 
	t´štbuf
;

71 
lh_bË
 
	tlh_bË
;

72 
¬¿y_li¡
 
	t¬¿y_li¡
;

73 
jsÚ_objeù
 
	tjsÚ_objeù
;

74 
jsÚ_objeù_™”
 
	tjsÚ_objeù_™”
;

75 
jsÚ_tok’”
 
	tjsÚ_tok’”
;

80 (
	gjsÚ_objeù_d–‘e_â
)(
	tjsÚ_objeù
 *
	tjso
, *
	tu£rd©a
);

85 (
	gjsÚ_objeù_to_jsÚ_¡ršg_â
)(
	tjsÚ_objeù
 *
	tjso
,

86 
	t´štbuf
 *
	tpb
,

87 
	tËv–
,

88 
	tæags
);

92 
	ejsÚ_ty³
 {

94 
	gjsÚ_ty³_nuÎ
,

95 
	gjsÚ_ty³_boŞ—n
,

96 
	gjsÚ_ty³_doubË
,

97 
	gjsÚ_ty³_št
,

98 
	gjsÚ_ty³_objeù
,

99 
	gjsÚ_ty³_¬¿y
,

100 
	gjsÚ_ty³_¡ršg
,

101 } 
	tjsÚ_ty³
;

111 
jsÚ_objeù
* 
jsÚ_objeù_g‘
(jsÚ_objeù *
obj
);

121 
jsÚ_objeù_put
(
jsÚ_objeù
 *
obj
);

135 
jsÚ_objeù_is_ty³
(
jsÚ_objeù
 *
obj
, 
jsÚ_ty³
 
ty³
);

151 
jsÚ_ty³
 
jsÚ_objeù_g‘_ty³
(
jsÚ_objeù
 *
obj
);

159 cÚ¡ * 
jsÚ_objeù_to_jsÚ_¡ršg
(
jsÚ_objeù
 *
obj
);

166 cÚ¡ * 
jsÚ_objeù_to_jsÚ_¡ršg_ext
(
jsÚ_objeù
 *
obj
, 

167 
æags
);

195 
jsÚ_objeù_£t_£rŸliz”
(
jsÚ_objeù
 *
jso
,

196 
jsÚ_objeù_to_jsÚ_¡ršg_â
 
to_¡ršg_func
,

197 *
u£rd©a
,

198 
jsÚ_objeù_d–‘e_â
 *
u£r_d–‘e
);

214 
jsÚ_objeù
* 
jsÚ_objeù_Ãw_objeù
();

220 
lh_bË
* 
jsÚ_objeù_g‘_objeù
(
jsÚ_objeù
 *
obj
);

225 
jsÚ_objeù_objeù_Ëngth
(
jsÚ_objeù
* 
obj
);

243 
jsÚ_objeù_objeù_add
(
jsÚ_objeù
* 
obj
, cÚ¡ *
key
,

244 
jsÚ_objeù
 *
v®
);

263 
jsÚ_objeù
* 
jsÚ_objeù_objeù_g‘
(jsÚ_objeù* 
obj
,

264 cÚ¡ *
key
);

284 
jsÚ_boŞ
 
jsÚ_objeù_objeù_g‘_ex
(
jsÚ_objeù
* 
obj
,

285 cÚ¡ *
key
,

286 
jsÚ_objeù
 **
v®ue
);

297 
jsÚ_objeù_objeù_d–
(
jsÚ_objeù
* 
obj
, cÚ¡ *
key
);

312 #ià
defšed
(
__GNUC__
è&& !defšed(
__STRICT_ANSI__
è&& 
__STDC_VERSION__
 >= 199901L

314 
	#jsÚ_objeù_objeù_fÜ—ch
(
obj
,
key
,
v®
) \

315 *
key
; \

316 
jsÚ_objeù
 *
v®
 
	`__©Œibu‹__
((
__unu£d__
)); \

317 
lh_’Œy
 *
’Œy
 ## 
key
 = 
	`jsÚ_objeù_g‘_objeù
(
obj
)->
h—d
, *
’Œy_Ãxt
 ## key = 
NULL
; \

318 ({ if(
’Œy
 ## 
key
) { \

319 
key
 = (*)
’Œy
 ## key->
k
; \

320 
v®
 = (
jsÚ_objeù
*)
’Œy
 ## 
key
->
v
; \

321 
’Œy_Ãxt
 ## 
key
 = 
’Œy
 ## key->
Ãxt
; \

322 } ; 
’Œy
 ## 
key
; }); \

323 
’Œy
 ## 
key
 = 
’Œy_Ãxt
 ## key )

	)

327 
	#jsÚ_objeù_objeù_fÜ—ch
(
obj
,
key
,
v®
) \

328 *
key
;\

329 
jsÚ_objeù
 *
v®
; \

330 
lh_’Œy
 *
’Œy
 ## 
key
; \

331 
lh_’Œy
 *
’Œy_Ãxt
 ## 
key
 = 
NULL
; \

332 
’Œy
 ## 
key
 = 
	`jsÚ_objeù_g‘_objeù
(
obj
)->
h—d
; \

333 (
’Œy
 ## 
key
 ? ( \

334 
key
 = (*)
’Œy
 ## key->
k
, \

335 
v®
 = (
jsÚ_objeù
*)
’Œy
 ## 
key
->
v
, \

336 
’Œy_Ãxt
 ## 
key
 = 
’Œy
 ## key->
Ãxt
, \

337 
’Œy
 ## 
key
) : 0); \

338 
’Œy
 ## 
key
 = 
’Œy_Ãxt
 ## key)

	)

346 
	#jsÚ_objeù_objeù_fÜ—chC
(
obj
,
™”
) \

347 
™”
.
’Œy
 = 
	`jsÚ_objeù_g‘_objeù
(
obj
)->
h—d
; (™”.’Œy ? (™”.
key
 = (*)™”.’Œy->
k
, i‹r.
v®
 = (
jsÚ_objeù
*)™”.’Œy->
v
, i‹r.’Œyè: 0); i‹r.’Œy = i‹r.’Œy->
Ãxt
)

	)

354 
jsÚ_objeù
* 
jsÚ_objeù_Ãw_¬¿y
();

360 
¬¿y_li¡
* 
jsÚ_objeù_g‘_¬¿y
(
jsÚ_objeù
 *
obj
);

366 
jsÚ_objeù_¬¿y_Ëngth
(
jsÚ_objeù
 *
obj
);

376 
jsÚ_objeù_¬¿y_sÜt
(
jsÚ_objeù
 *
jso
, (*
sÜt_â
)(const *, const *));

387 
jsÚ_objeù_¬¿y_add
(
jsÚ_objeù
 *
obj
,

388 
jsÚ_objeù
 *
v®
);

405 
jsÚ_objeù_¬¿y_put_idx
(
jsÚ_objeù
 *
obj
, 
idx
,

406 
jsÚ_objeù
 *
v®
);

413 
jsÚ_objeù
* 
jsÚ_objeù_¬¿y_g‘_idx
(jsÚ_objeù *
obj
,

414 
idx
);

422 
jsÚ_objeù
* 
jsÚ_objeù_Ãw_boŞ—n
(
jsÚ_boŞ
 
b
);

435 
jsÚ_boŞ
 
jsÚ_objeù_g‘_boŞ—n
(
jsÚ_objeù
 *
obj
);

446 
jsÚ_objeù
* 
jsÚ_objeù_Ãw_št
(
št32_t
 
i
);

453 
jsÚ_objeù
* 
jsÚ_objeù_Ãw_št64
(
št64_t
 
i
);

470 
št32_t
 
jsÚ_objeù_g‘_št
(
jsÚ_objeù
 *
obj
);

485 
št64_t
 
jsÚ_objeù_g‘_št64
(
jsÚ_objeù
 *
obj
);

494 
jsÚ_objeù
* 
jsÚ_objeù_Ãw_doubË
(
d
);

519 
jsÚ_objeù_g‘_doubË
(
jsÚ_objeù
 *
obj
);

531 
jsÚ_objeù
* 
jsÚ_objeù_Ãw_¡ršg
(cÚ¡ *
s
);

533 
jsÚ_objeù
* 
jsÚ_objeù_Ãw_¡ršg_Ën
(cÚ¡ *
s
, 
Ën
);

546 cÚ¡ * 
jsÚ_objeù_g‘_¡ršg
(
jsÚ_objeù
 *
obj
);

556 
jsÚ_objeù_g‘_¡ršg_Ën
(
jsÚ_objeù
 *
obj
);

558 #ifdeà
__ılu¥lus


	@json/json_object_iterator.c

18 
	~<¡ddef.h
>

20 
	~"jsÚ.h
"

21 
	~"jsÚ_objeù_´iv©e.h
"

23 
	~"jsÚ_objeù_™”©Ü.h
"

61 cÚ¡ * 
	gkObjeùEndI‹rV®ue
 = 
NULL
;

66 
jsÚ_objeù_™”©Ü


67 
	$jsÚ_objeù_™”_begš
(
jsÚ_objeù
* 
obj
)

69 
jsÚ_objeù_™”©Ü
 
™”
;

70 
lh_bË
* 
pTabË
;

74 
pTabË
 = 
	`jsÚ_objeù_g‘_objeù
(
obj
);

75 
	`JASSERT
(
NULL
 !ğ
pTabË
);

79 
™”
.
İaque_
 = 
pTabË
->
h—d
;

80  
™”
;

81 
	}
}

86 
jsÚ_objeù_™”©Ü


87 
	$jsÚ_objeù_™”_’d
(cÚ¡ 
jsÚ_objeù
* 
obj
)

89 
jsÚ_objeù_™”©Ü
 
™”
;

91 
	`JASSERT
(
NULL
 !ğ
obj
);

92 
	`JASSERT
(
	`jsÚ_objeù_is_ty³
(
obj
, 
jsÚ_ty³_objeù
));

94 
™”
.
İaque_
 = 
kObjeùEndI‹rV®ue
;

96  
™”
;

97 
	}
}

103 
	$jsÚ_objeù_™”_Ãxt
(
jsÚ_objeù_™”©Ü
* 
™”
)

105 
	`JASSERT
(
NULL
 !ğ
™”
);

106 
	`JASSERT
(
kObjeùEndI‹rV®ue
 !ğ
™”
->
İaque_
);

108 
™”
->
İaque_
 = ((
lh_’Œy
 *)™”->İaque_)->
Ãxt
;

109 
	}
}

116 
	$jsÚ_objeù_™”_³ek_Çme
(cÚ¡ 
jsÚ_objeù_™”©Ü
* 
™”
)

118 
	`JASSERT
(
NULL
 !ğ
™”
);

119 
	`JASSERT
(
kObjeùEndI‹rV®ue
 !ğ
™”
->
İaque_
);

121  (cÚ¡ *)(((
lh_’Œy
 *)
™”
->
İaque_
)->
k
);

122 
	}
}

128 
jsÚ_objeù
*

129 
	$jsÚ_objeù_™”_³ek_v®ue
(cÚ¡ 
jsÚ_objeù_™”©Ü
* 
™”
)

131 
	`JASSERT
(
NULL
 !ğ
™”
);

132 
	`JASSERT
(
kObjeùEndI‹rV®ue
 !ğ
™”
->
İaque_
);

134  (
jsÚ_objeù
*)(((
lh_’Œy
 *)
™”
->
İaque_
)->
v
);

135 
	}
}

141 
jsÚ_boŞ


142 
	$jsÚ_objeù_™”_equ®
(cÚ¡ 
jsÚ_objeù_™”©Ü
* 
™”1
,

143 cÚ¡ 
jsÚ_objeù_™”©Ü
* 
™”2
)

145 
	`JASSERT
(
NULL
 !ğ
™”1
);

146 
	`JASSERT
(
NULL
 !ğ
™”2
);

148  (
™”1
->
İaque_
 =ğ
™”2
->opaque_);

149 
	}
}

155 
jsÚ_objeù_™”©Ü


156 
	$jsÚ_objeù_™”_š™_deçuÉ
()

158 
jsÚ_objeù_™”©Ü
 
™”
;

165 
™”
.
İaque_
 = 
NULL
;

167  
™”
;

168 
	}
}

	@json/json_object_iterator.h

23 #iâdeà
JSON_OBJECT_ITERATOR_H


24 
	#JSON_OBJECT_ITERATOR_H


	)

26 
	~<¡ddef.h
>

28 #ifdeà
__ılu¥lus


35 
jsÚ_objeù_™”_šfo_
;

41 
	sjsÚ_objeù_™”©Ü
 {

42 cÚ¡ * 
İaque_
;

49 
jsÚ_objeù
;

74 
jsÚ_objeù_™”©Ü


75 
jsÚ_objeù_™”_š™_deçuÉ
();

108 
jsÚ_objeù_™”©Ü


109 
jsÚ_objeù_™”_begš
(
jsÚ_objeù
* 
obj
);

139 
jsÚ_objeù_™”©Ü


140 
jsÚ_objeù_™”_’d
(cÚ¡ 
jsÚ_objeù
* 
obj
);

158 
jsÚ_objeù_™”_Ãxt
(
jsÚ_objeù_™”©Ü
* 
™”
);

177 
jsÚ_objeù_™”_³ek_Çme
(cÚ¡ 
jsÚ_objeù_™”©Ü
* 
™”
);

199 
jsÚ_objeù
*

200 
jsÚ_objeù_™”_³ek_v®ue
(cÚ¡ 
jsÚ_objeù_™”©Ü
* 
™”
);

229 
jsÚ_boŞ


230 
jsÚ_objeù_™”_equ®
(cÚ¡ 
jsÚ_objeù_™”©Ü
* 
™”1
,

231 cÚ¡ 
jsÚ_objeù_™”©Ü
* 
™”2
);

234 #ifdeà
__ılu¥lus


	@json/json_object_private.h

12 #iâdeà
_jsÚ_objeù_´iv©e_h_


13 
	#_jsÚ_objeù_´iv©e_h_


	)

15 #ifdeà
__ılu¥lus


19 (
jsÚ_objeù_´iv©e_d–‘e_â
)(
	tjsÚ_objeù
 *
	to
);

21 
	sjsÚ_objeù


23 
jsÚ_ty³
 
o_ty³
;

24 
jsÚ_objeù_´iv©e_d–‘e_â
 *
_d–‘e
;

25 
jsÚ_objeù_to_jsÚ_¡ršg_â
 *
_to_jsÚ_¡ršg
;

26 
_»f_couÁ
;

27 
´štbuf
 *
_pb
;

28 
	ud©a
 {

29 
jsÚ_boŞ
 
c_boŞ—n
;

30 
c_doubË
;

31 
št64_t
 
c_št64
;

32 
lh_bË
 *
c_objeù
;

33 
¬¿y_li¡
 *
c_¬¿y
;

35 *
¡r
;

36 
Ën
;

37 } 
c_¡ršg
;

38 } 
o
;

39 
jsÚ_objeù_d–‘e_â
 *
_u£r_d–‘e
;

40 *
_u£rd©a
;

43 #ifdeà
__ılu¥lus


	@json/json_tokener.c

16 
	~"jcÚfig.h
"

18 
	~<¡dio.h
>

19 
	~<¡dlib.h
>

20 
	~<¡ddef.h
>

21 
	~<ùy³.h
>

22 
	~<¡ršg.h
>

23 
	~<lim™s.h
>

25 
	~"b™s.h
"

26 
	~"debug.h
"

27 
	~"´štbuf.h
"

28 
	~"¬¿yli¡.h
"

29 
	~"jsÚ_š‰y³s.h
"

30 
	~"jsÚ_objeù.h
"

31 
	~"jsÚ_tok’”.h
"

32 
	~"jsÚ_ut.h
"

34 #ifdeà
HAVE_LOCALE_H


35 
	~<loÿË.h
>

38 #ià!
HAVE_STRDUP
 && 
defšed
(
_MSC_VER
)

40 
	#¡rdup
 
_¡rdup


	)

41 #–ià!
HAVE_STRDUP


42 #”rÜ 
You
 dØ
nÙ
 
have
 
¡rdup
 
Ú
 
your
 
sy¡em
.

45 #ià!
HAVE_STRNCASECMP
 && 
defšed
(
_MSC_VER
)

47 
	#¡ºÿ£cmp
 
_¡ºicmp


	)

48 #–ià!
HAVE_STRNCASECMP


49 #”rÜ 
You
 dØ
nÙ
 
have
 
¡ºÿ£cmp
 
Ú
 
your
 
sy¡em
.

52 cÚ¡ * 
	gjsÚ_nuÎ_¡r
 = "null";

53 cÚ¡ * 
	gjsÚ_Œue_¡r
 = "true";

54 cÚ¡ * 
	gjsÚ_çl£_¡r
 = "false";

57 cÚ¡ * 
	gjsÚ_tok’”_”rÜs
[] = {

74 cÚ¡ *
	$jsÚ_tok’”_”rÜ_desc
(
jsÚ_tok’”_”rÜ
 
j”r
)

76 
j”r_št
 = ()
j”r
;

77 ià(
j”r_št
 < 0 || j”r_šˆ> ()(
jsÚ_tok’”_”rÜs
))

79  
jsÚ_tok’”_”rÜs
[
j”r
];

80 
	}
}

82 
jsÚ_tok’”_”rÜ
 
	$jsÚ_tok’”_g‘_”rÜ
(
jsÚ_tok’”
 *
tok
)

84  
tok
->
”r
;

85 
	}
}

88 
	#IS_HIGH_SURROGATE
(
uc
è(((ucè& 0xFC00è=ğ0xD800)

	)

89 
	#IS_LOW_SURROGATE
(
uc
è(((ucè& 0xFC00è=ğ0xDC00)

	)

90 
	#DECODE_SURROGATE_PAIR
(
hi
,
lo
è((((hiè& 0x3FFè<< 10è+ (Öoè& 0x3FFè+ 0x10000)

	)

91 
	gutf8_»¶aûm’t_ch¬
[3] = { 0xEF, 0xBF, 0xBD };

93 
jsÚ_tok’”
* 
	$jsÚ_tok’”_Ãw_ex
(
d•th
)

95 
jsÚ_tok’”
 *
tok
;

97 
tok
 = (
jsÚ_tok’”
*)
	`ÿÎoc
(1, (json_tokener));

98 ià(!
tok
è 
NULL
;

99 
tok
->
¡ack
 = (
jsÚ_tok’”_¤ec
 *)
	`ÿÎoc
(
d•th
, (json_tokener_srec));

100 ià(!
tok
->
¡ack
) {

101 
	`ä“
(
tok
);

102  
NULL
;

104 
tok
->
pb
 = 
	`´štbuf_Ãw
();

105 
tok
->
max_d•th
 = 
d•th
;

106 
	`jsÚ_tok’”_»£t
(
tok
);

107  
tok
;

108 
	}
}

110 
jsÚ_tok’”
* 
	$jsÚ_tok’”_Ãw
()

112  
	`jsÚ_tok’”_Ãw_ex
(
JSON_TOKENER_DEFAULT_DEPTH
);

113 
	}
}

115 
	$jsÚ_tok’”_ä“
(
jsÚ_tok’”
 *
tok
)

117 
	`jsÚ_tok’”_»£t
(
tok
);

118 ià(
tok
->
pb
è
	`´štbuf_ä“
(tok->pb);

119 ià(
tok
->
¡ack
è
	`ä“
(tok->stack);

120 
	`ä“
(
tok
);

121 
	}
}

123 
	$jsÚ_tok’”_»£t_Ëv–
(
jsÚ_tok’”
 *
tok
, 
d•th
)

125 
tok
->
¡ack
[
d•th
].
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

126 
tok
->
¡ack
[
d•th
].
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_¡¬t
;

127 
	`jsÚ_objeù_put
(
tok
->
¡ack
[
d•th
].
cu¼’t
);

128 
tok
->
¡ack
[
d•th
].
cu¼’t
 = 
NULL
;

129 
	`ä“
(
tok
->
¡ack
[
d•th
].
obj_f›ld_Çme
);

130 
tok
->
¡ack
[
d•th
].
obj_f›ld_Çme
 = 
NULL
;

131 
	}
}

133 
	$jsÚ_tok’”_»£t
(
jsÚ_tok’”
 *
tok
)

135 
i
;

136 ià(!
tok
)

139 
i
 = 
tok
->
d•th
; i >= 0; i--)

140 
	`jsÚ_tok’”_»£t_Ëv–
(
tok
, 
i
);

141 
tok
->
d•th
 = 0;

142 
tok
->
”r
 = 
jsÚ_tok’”_sucûss
;

143 
	}
}

145 
jsÚ_objeù
* 
	$jsÚ_tok’”_·r£
(cÚ¡ *
¡r
)

147 
jsÚ_tok’”_”rÜ
 
j”r_ignÜed
;

148 
jsÚ_objeù
* 
obj
;

149 
obj
 = 
	`jsÚ_tok’”_·r£_v”bo£
(
¡r
, &
j”r_ignÜed
);

150  
obj
;

151 
	}
}

153 
jsÚ_objeù
* 
	$jsÚ_tok’”_·r£_v”bo£
(cÚ¡ *
¡r
, 
jsÚ_tok’”_”rÜ
 *
”rÜ
)

155 
jsÚ_tok’”
* 
tok
;

156 
jsÚ_objeù
* 
obj
;

158 
tok
 = 
	`jsÚ_tok’”_Ãw
();

159 ià(!
tok
)

160  
NULL
;

161 
obj
 = 
	`jsÚ_tok’”_·r£_ex
(
tok
, 
¡r
, -1);

162 *
”rÜ
 = 
tok
->
”r
;

163 if(
tok
->
”r
 !ğ
jsÚ_tok’”_sucûss
) {

164 ià(
obj
 !ğ
NULL
)

165 
	`jsÚ_objeù_put
(
obj
);

166 
obj
 = 
NULL
;

169 
	`jsÚ_tok’”_ä“
(
tok
);

170  
obj
;

171 
	}
}

174 #ià!
HAVE_STRNDUP


176 * 
	$¡ºdup
(cÚ¡ * 
¡r
, 
size_t
 
n
)

178 if(
¡r
) {

179 
size_t
 
Ën
 = 
	`¡¾’
(
¡r
);

180 
size_t
 
Â
 = 
	`jsÚ_mš
(
Ën
,
n
);

181 * 
s
 = (*)
	`m®loc
((è* (
Â
 + 1));

183 if(
s
) {

184 
	`memıy
(
s
, 
¡r
, 
Â
);

185 
s
[
Â
] = '\0';

188  
s
;

191  
NULL
;

192 
	}
}

196 
	#¡©e
 
tok
->
¡ack
[tok->
d•th
].
¡©e


	)

197 
	#§ved_¡©e
 
tok
->
¡ack
[tok->
d•th
].
§ved_¡©e


	)

198 
	#cu¼’t
 
tok
->
¡ack
[tok->
d•th
].
cu¼’t


	)

199 
	#obj_f›ld_Çme
 
tok
->
¡ack
[tok->
d•th
].
obj_f›ld_Çme


	)

219 
	#PEEK_CHAR
(
de¡
, 
tok
) \

220 (((
tok
)->
ch¬_off£t
 =ğ
Ën
) ? \

221 (((
tok
)->
d•th
 =ğ0 && 
¡©e
 =ğ
jsÚ_tok’”_¡©e_—tws
 && 
§ved_¡©e
 =ğ
jsÚ_tok’”_¡©e_fšish
) ? \

222 (((
tok
)->
”r
 = 
jsÚ_tok’”_sucûss
), 0) \

224 (((
tok
)->
”r
 = 
jsÚ_tok’”_cÚtšue
), 0) \

226 (((
de¡
èğ*
¡r
), 1) \

227 )

	)

234 
	#ADVANCE_CHAR
(
¡r
, 
tok
) \

235 Ğ++(
¡r
), ((
tok
)->
ch¬_off£t
)++, 
c
)

	)

241 
jsÚ_objeù
* 
	$jsÚ_tok’”_·r£_ex
(
jsÚ_tok’”
 *
tok
,

242 cÚ¡ *
¡r
, 
Ën
)

244 
jsÚ_objeù
 *
obj
 = 
NULL
;

245 
c
 = '\1';

246 #ifdeà
HAVE_SETLOCALE


247 *
ŞdloÿË
=
NULL
, *
tm¶oÿË
;

249 
tm¶oÿË
 = 
	`£oÿË
(
LC_NUMERIC
, 
NULL
);

250 ià(
tm¶oÿË
è
ŞdloÿË
 = 
	`¡rdup
(tmplocale);

251 
	`£oÿË
(
LC_NUMERIC
, "C");

254 
tok
->
ch¬_off£t
 = 0;

255 
tok
->
”r
 = 
jsÚ_tok’”_sucûss
;

257 
	`PEEK_CHAR
(
c
, 
tok
)) {

259 
»do_ch¬
:

260 
¡©e
) {

262 
jsÚ_tok’”_¡©e_—tws
:

264 
	`is¥aû
(()
c
)) {

265 ià((!
	`ADVANCE_CHAR
(
¡r
, 
tok
)è|| (!
	`PEEK_CHAR
(
c
,ok)))

266 
out
;

268 if(
c
 == '/') {

269 
	`´štbuf_»£t
(
tok
->
pb
);

270 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, &
c
, 1);

271 
¡©e
 = 
jsÚ_tok’”_¡©e_comm’t_¡¬t
;

273 
¡©e
 = 
§ved_¡©e
;

274 
»do_ch¬
;

278 
jsÚ_tok’”_¡©e_¡¬t
:

279 
c
) {

281 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

282 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_objeù_f›ld_¡¬t
;

283 
cu¼’t
 = 
	`jsÚ_objeù_Ãw_objeù
();

286 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

287 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_¬¿y
;

288 
cu¼’t
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

292 
¡©e
 = 
jsÚ_tok’”_¡©e_nuÎ
;

293 
	`´štbuf_»£t
(
tok
->
pb
);

294 
tok
->
¡_pos
 = 0;

295 
»do_ch¬
;

298 
¡©e
 = 
jsÚ_tok’”_¡©e_¡ršg
;

299 
	`´štbuf_»£t
(
tok
->
pb
);

300 
tok
->
quÙe_ch¬
 = 
c
;

306 
¡©e
 = 
jsÚ_tok’”_¡©e_boŞ—n
;

307 
	`´štbuf_»£t
(
tok
->
pb
);

308 
tok
->
¡_pos
 = 0;

309 
»do_ch¬
;

310 #ià
	`defšed
(
__GNUC__
)

325 
¡©e
 = 
jsÚ_tok’”_¡©e_numb”
;

326 
	`´štbuf_»£t
(
tok
->
pb
);

327 
tok
->
is_doubË
 = 0;

328 
»do_ch¬
;

330 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_uÃx³ùed
;

331 
out
;

335 
jsÚ_tok’”_¡©e_fšish
:

336 if(
tok
->
d•th
 =ğ0è
out
;

337 
obj
 = 
	`jsÚ_objeù_g‘
(
cu¼’t
);

338 
	`jsÚ_tok’”_»£t_Ëv–
(
tok
,ok->
d•th
);

339 
tok
->
d•th
--;

340 
»do_ch¬
;

342 
jsÚ_tok’”_¡©e_nuÎ
:

343 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, &
c
, 1);

344 if(
	`¡ºÿ£cmp
(
jsÚ_nuÎ_¡r
, 
tok
->
pb
->
buf
,

345 
	`jsÚ_mš
(
tok
->
¡_pos
+1, ()
	`¡¾’
(
jsÚ_nuÎ_¡r
))) == 0) {

346 if(
tok
->
¡_pos
 =ğ()
	`¡¾’
(
jsÚ_nuÎ_¡r
)) {

347 
cu¼’t
 = 
NULL
;

348 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_fšish
;

349 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

350 
»do_ch¬
;

353 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_nuÎ
;

354 
out
;

356 
tok
->
¡_pos
++;

359 
jsÚ_tok’”_¡©e_comm’t_¡¬t
:

360 if(
c
 == '*') {

361 
¡©e
 = 
jsÚ_tok’”_¡©e_comm’t
;

362 } if(
c
 == '/') {

363 
¡©e
 = 
jsÚ_tok’”_¡©e_comm’t_eŞ
;

365 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_comm’t
;

366 
out
;

368 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, &
c
, 1);

371 
jsÚ_tok’”_¡©e_comm’t
:

374 cÚ¡ *
ÿ£_¡¬t
 = 
¡r
;

375 
c
 != '*') {

376 ià(!
	`ADVANCE_CHAR
(
¡r
, 
tok
è|| !
	`PEEK_CHAR
(
c
,ok)) {

377 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
¡r
-case_start);

378 
out
;

381 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 1+
¡r
-case_start);

382 
¡©e
 = 
jsÚ_tok’”_¡©e_comm’t_’d
;

386 
jsÚ_tok’”_¡©e_comm’t_eŞ
:

389 cÚ¡ *
ÿ£_¡¬t
 = 
¡r
;

390 
c
 != '\n') {

391 ià(!
	`ADVANCE_CHAR
(
¡r
, 
tok
è|| !
	`PEEK_CHAR
(
c
,ok)) {

392 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
¡r
-case_start);

393 
out
;

396 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
¡r
-case_start);

397 
	`MC_DEBUG
("jsÚ_tok’”_comm’t: %s\n", 
tok
->
pb
->
buf
);

398 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

402 
jsÚ_tok’”_¡©e_comm’t_’d
:

403 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, &
c
, 1);

404 if(
c
 == '/') {

405 
	`MC_DEBUG
("jsÚ_tok’”_comm’t: %s\n", 
tok
->
pb
->
buf
);

406 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

408 
¡©e
 = 
jsÚ_tok’”_¡©e_comm’t
;

412 
jsÚ_tok’”_¡©e_¡ršg
:

415 cÚ¡ *
ÿ£_¡¬t
 = 
¡r
;

417 if(
c
 =ğ
tok
->
quÙe_ch¬
) {

418 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
¡r
-case_start);

419 
cu¼’t
 = 
	`jsÚ_objeù_Ãw_¡ršg_Ën
(
tok
->
pb
->
buf
,ok->pb->
bpos
);

420 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_fšish
;

421 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

423 } if(
c
 == '\\') {

424 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
¡r
-case_start);

425 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_¡ršg
;

426 
¡©e
 = 
jsÚ_tok’”_¡©e_¡ršg_esÿ³
;

429 ià(!
	`ADVANCE_CHAR
(
¡r
, 
tok
è|| !
	`PEEK_CHAR
(
c
,ok)) {

430 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
¡r
-case_start);

431 
out
;

437 
jsÚ_tok’”_¡©e_¡ršg_esÿ³
:

438 
c
) {

442 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, &
c
, 1);

443 
¡©e
 = 
§ved_¡©e
;

450 if(
c
 =ğ'b'è
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, "\b", 1);

451 if(
c
 =ğ'n'è
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, "\n", 1);

452 if(
c
 =ğ'r'è
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, "\r", 1);

453 if(
c
 =ğ't'è
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, "\t", 1);

454 if(
c
 =ğ'f'è
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, "\f", 1);

455 
¡©e
 = 
§ved_¡©e
;

458 
tok
->
ucs_ch¬
 = 0;

459 
tok
->
¡_pos
 = 0;

460 
¡©e
 = 
jsÚ_tok’”_¡©e_esÿ³_unicode
;

463 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_¡ršg
;

464 
out
;

468 
jsÚ_tok’”_¡©e_esÿ³_unicode
:

470 
gÙ_hi_su¼og©e
 = 0;

474 if(
	`¡rchr
(
jsÚ_hex_ch¬s
, 
c
)) {

475 
tok
->
ucs_ch¬
 +ğ(()
	`hexdig™
(
c
è<< ((3-tok->
¡_pos
++)*4));

476 if(
tok
->
¡_pos
 == 4) {

477 
uÃsÿ³d_utf
[4];

479 ià(
gÙ_hi_su¼og©e
) {

480 ià(
	`IS_LOW_SURROGATE
(
tok
->
ucs_ch¬
)) {

482 
tok
->
ucs_ch¬
 = 
	`DECODE_SURROGATE_PAIR
(
gÙ_hi_su¼og©e
,ok->ucs_char);

486 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
utf8_»¶aûm’t_ch¬
, 3);

488 
gÙ_hi_su¼og©e
 = 0;

491 ià(
tok
->
ucs_ch¬
 < 0x80) {

492 
uÃsÿ³d_utf
[0] = 
tok
->
ucs_ch¬
;

493 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
uÃsÿ³d_utf
, 1);

494 } ià(
tok
->
ucs_ch¬
 < 0x800) {

495 
uÃsÿ³d_utf
[0] = 0xc0 | (
tok
->
ucs_ch¬
 >> 6);

496 
uÃsÿ³d_utf
[1] = 0x80 | (
tok
->
ucs_ch¬
 & 0x3f);

497 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
uÃsÿ³d_utf
, 2);

498 } ià(
	`IS_HIGH_SURROGATE
(
tok
->
ucs_ch¬
)) {

503 
gÙ_hi_su¼og©e
 = 
tok
->
ucs_ch¬
;

505 ià((
tok
->
ch¬_off£t
+1 !ğ
Ën
) &&

506 (
tok
->
ch¬_off£t
+2 !ğ
Ën
) &&

507 (
¡r
[1] == '\\') &&

508 (
¡r
[2] == 'u'))

514 ifĞ!
	`ADVANCE_CHAR
(
¡r
, 
tok
) || !ADVANCE_CHAR(str,ok) ) {

515 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
utf8_»¶aûm’t_ch¬
, 3);

520 ià(!
	`ADVANCE_CHAR
(
¡r
, 
tok
è|| !
	`PEEK_CHAR
(
c
,ok)) {

521 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
utf8_»¶aûm’t_ch¬
, 3);

522 
out
;

524 
tok
->
ucs_ch¬
 = 0;

525 
tok
->
¡_pos
 = 0;

532 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
utf8_»¶aûm’t_ch¬
, 3);

534 } ià(
	`IS_LOW_SURROGATE
(
tok
->
ucs_ch¬
)) {

536 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
utf8_»¶aûm’t_ch¬
, 3);

537 } ià(
tok
->
ucs_ch¬
 < 0x10000) {

538 
uÃsÿ³d_utf
[0] = 0xe0 | (
tok
->
ucs_ch¬
 >> 12);

539 
uÃsÿ³d_utf
[1] = 0x80 | ((
tok
->
ucs_ch¬
 >> 6) & 0x3f);

540 
uÃsÿ³d_utf
[2] = 0x80 | (
tok
->
ucs_ch¬
 & 0x3f);

541 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
uÃsÿ³d_utf
, 3);

542 } ià(
tok
->
ucs_ch¬
 < 0x110000) {

543 
uÃsÿ³d_utf
[0] = 0xf0 | ((
tok
->
ucs_ch¬
 >> 18) & 0x07);

544 
uÃsÿ³d_utf
[1] = 0x80 | ((
tok
->
ucs_ch¬
 >> 12) & 0x3f);

545 
uÃsÿ³d_utf
[2] = 0x80 | ((
tok
->
ucs_ch¬
 >> 6) & 0x3f);

546 
uÃsÿ³d_utf
[3] = 0x80 | (
tok
->
ucs_ch¬
 & 0x3f);

547 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
uÃsÿ³d_utf
, 4);

550 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
utf8_»¶aûm’t_ch¬
, 3);

552 
¡©e
 = 
§ved_¡©e
;

556 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_¡ršg
;

557 
out
;

559 ià(!
	`ADVANCE_CHAR
(
¡r
, 
tok
è|| !
	`PEEK_CHAR
(
c
,ok)) {

560 ià(
gÙ_hi_su¼og©e
)

561 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, (*)
utf8_»¶aûm’t_ch¬
, 3);

562 
out
;

568 
jsÚ_tok’”_¡©e_boŞ—n
:

569 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, &
c
, 1);

570 if(
	`¡ºÿ£cmp
(
jsÚ_Œue_¡r
, 
tok
->
pb
->
buf
,

571 
	`jsÚ_mš
(
tok
->
¡_pos
+1, ()
	`¡¾’
(
jsÚ_Œue_¡r
))) == 0) {

572 if(
tok
->
¡_pos
 =ğ()
	`¡¾’
(
jsÚ_Œue_¡r
)) {

573 
cu¼’t
 = 
	`jsÚ_objeù_Ãw_boŞ—n
(1);

574 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_fšish
;

575 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

576 
»do_ch¬
;

578 } if(
	`¡ºÿ£cmp
(
jsÚ_çl£_¡r
, 
tok
->
pb
->
buf
,

579 
	`jsÚ_mš
(
tok
->
¡_pos
+1, ()
	`¡¾’
(
jsÚ_çl£_¡r
))) == 0) {

580 if(
tok
->
¡_pos
 =ğ()
	`¡¾’
(
jsÚ_çl£_¡r
)) {

581 
cu¼’t
 = 
	`jsÚ_objeù_Ãw_boŞ—n
(0);

582 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_fšish
;

583 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

584 
»do_ch¬
;

587 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_boŞ—n
;

588 
out
;

590 
tok
->
¡_pos
++;

593 
jsÚ_tok’”_¡©e_numb”
:

596 cÚ¡ *
ÿ£_¡¬t
 = 
¡r
;

597 
ÿ£_Ën
=0;

598 
c
 && 
	`¡rchr
(
jsÚ_numb”_ch¬s
, c)) {

599 ++
ÿ£_Ën
;

600 if(
c
 == '.' || c == 'e' || c == 'E')

601 
tok
->
is_doubË
 = 1;

602 ià(!
	`ADVANCE_CHAR
(
¡r
, 
tok
è|| !
	`PEEK_CHAR
(
c
,ok)) {

603 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
ÿ£_Ën
);

604 
out
;

607 ià(
ÿ£_Ën
>0)

608 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
ÿ£_Ën
);

611 
št64_t
 
num64
;

612 
numd
;

613 ià(!
tok
->
is_doubË
 && 
	`jsÚ_·r£_št64
Ñok->
pb
->
buf
, &
num64
) == 0) {

614 
cu¼’t
 = 
	`jsÚ_objeù_Ãw_št64
(
num64
);

615 } if(
tok
->
is_doubË
 && 
	`jsÚ_·r£_doubË
Ñok->
pb
->
buf
, &
numd
) == 0) {

616 
cu¼’t
 = 
	`jsÚ_objeù_Ãw_doubË
(
numd
);

618 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_numb”
;

619 
out
;

621 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_fšish
;

622 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

623 
»do_ch¬
;

627 
jsÚ_tok’”_¡©e_¬¿y_aá”_£p
:

628 
jsÚ_tok’”_¡©e_¬¿y
:

629 if(
c
 == ']') {

630 ià(
¡©e
 =ğ
jsÚ_tok’”_¡©e_¬¿y_aá”_£p
 &&

631 (
tok
->
æags
 & 
JSON_TOKENER_STRICT
))

633 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_uÃx³ùed
;

634 
out
;

636 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_fšish
;

637 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

639 if(
tok
->
d•th
 >ğtok->
max_d•th
-1) {

640 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_d•th
;

641 
out
;

643 
¡©e
 = 
jsÚ_tok’”_¡©e_¬¿y_add
;

644 
tok
->
d•th
++;

645 
	`jsÚ_tok’”_»£t_Ëv–
(
tok
,ok->
d•th
);

646 
»do_ch¬
;

650 
jsÚ_tok’”_¡©e_¬¿y_add
:

651 
	`jsÚ_objeù_¬¿y_add
(
cu¼’t
, 
obj
);

652 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_¬¿y_£p
;

653 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

654 
»do_ch¬
;

656 
jsÚ_tok’”_¡©e_¬¿y_£p
:

657 if(
c
 == ']') {

658 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_fšish
;

659 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

660 } if(
c
 == ',') {

661 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_¬¿y_aá”_£p
;

662 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

664 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_¬¿y
;

665 
out
;

669 
jsÚ_tok’”_¡©e_objeù_f›ld_¡¬t
:

670 
jsÚ_tok’”_¡©e_objeù_f›ld_¡¬t_aá”_£p
:

671 if(
c
 == '}') {

672 ià(
¡©e
 =ğ
jsÚ_tok’”_¡©e_objeù_f›ld_¡¬t_aá”_£p
 &&

673 (
tok
->
æags
 & 
JSON_TOKENER_STRICT
))

675 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_uÃx³ùed
;

676 
out
;

678 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_fšish
;

679 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

680 } ià(
c
 == '"' || c == '\'') {

681 
tok
->
quÙe_ch¬
 = 
c
;

682 
	`´štbuf_»£t
(
tok
->
pb
);

683 
¡©e
 = 
jsÚ_tok’”_¡©e_objeù_f›ld
;

685 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_objeù_key_Çme
;

686 
out
;

690 
jsÚ_tok’”_¡©e_objeù_f›ld
:

693 cÚ¡ *
ÿ£_¡¬t
 = 
¡r
;

695 if(
c
 =ğ
tok
->
quÙe_ch¬
) {

696 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
¡r
-case_start);

697 
obj_f›ld_Çme
 = 
	`¡rdup
(
tok
->
pb
->
buf
);

698 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_objeù_f›ld_’d
;

699 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

701 } if(
c
 == '\\') {

702 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
¡r
-case_start);

703 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_objeù_f›ld
;

704 
¡©e
 = 
jsÚ_tok’”_¡©e_¡ršg_esÿ³
;

707 ià(!
	`ADVANCE_CHAR
(
¡r
, 
tok
è|| !
	`PEEK_CHAR
(
c
,ok)) {

708 
	`´štbuf_mem­³nd_ç¡
(
tok
->
pb
, 
ÿ£_¡¬t
, 
¡r
-case_start);

709 
out
;

715 
jsÚ_tok’”_¡©e_objeù_f›ld_’d
:

716 if(
c
 == ':') {

717 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_objeù_v®ue
;

718 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

720 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_objeù_key_£p
;

721 
out
;

725 
jsÚ_tok’”_¡©e_objeù_v®ue
:

726 if(
tok
->
d•th
 >ğtok->
max_d•th
-1) {

727 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_d•th
;

728 
out
;

730 
¡©e
 = 
jsÚ_tok’”_¡©e_objeù_v®ue_add
;

731 
tok
->
d•th
++;

732 
	`jsÚ_tok’”_»£t_Ëv–
(
tok
,ok->
d•th
);

733 
»do_ch¬
;

735 
jsÚ_tok’”_¡©e_objeù_v®ue_add
:

736 
	`jsÚ_objeù_objeù_add
(
cu¼’t
, 
obj_f›ld_Çme
, 
obj
);

737 
	`ä“
(
obj_f›ld_Çme
);

738 
obj_f›ld_Çme
 = 
NULL
;

739 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_objeù_£p
;

740 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

741 
»do_ch¬
;

743 
jsÚ_tok’”_¡©e_objeù_£p
:

744 if(
c
 == '}') {

745 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_fšish
;

746 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

747 } if(
c
 == ',') {

748 
§ved_¡©e
 = 
jsÚ_tok’”_¡©e_objeù_f›ld_¡¬t_aá”_£p
;

749 
¡©e
 = 
jsÚ_tok’”_¡©e_—tws
;

751 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_objeù_v®ue_£p
;

752 
out
;

757 ià(!
	`ADVANCE_CHAR
(
¡r
, 
tok
))

758 
out
;

761 
out
:

762 ià(!
c
) {

763 if(
¡©e
 !ğ
jsÚ_tok’”_¡©e_fšish
 &&

764 
§ved_¡©e
 !ğ
jsÚ_tok’”_¡©e_fšish
)

765 
tok
->
”r
 = 
jsÚ_tok’”_”rÜ_·r£_eof
;

768 #ifdeà
HAVE_SETLOCALE


769 
	`£oÿË
(
LC_NUMERIC
, 
ŞdloÿË
);

770 ià(
ŞdloÿË
è
	`ä“
(oldlocale);

773 ià(
tok
->
”r
 =ğ
jsÚ_tok’”_sucûss
)

775 
jsÚ_objeù
 *
»t
 = 
	`jsÚ_objeù_g‘
(
cu¼’t
);

776 
ii
;

779 
ii
 = 
tok
->
d•th
; ii >= 0; ii--)

780 
	`jsÚ_tok’”_»£t_Ëv–
(
tok
, 
ii
);

781  
»t
;

784 
	`MC_DEBUG
("json_tokener_parse_ex:ƒrror %s‡t offset %d\n",

785 
jsÚ_tok’”_”rÜs
[
tok
->
”r
],ok->
ch¬_off£t
);

786  
NULL
;

787 
	}
}

789 
	$jsÚ_tok’”_£t_æags
(
jsÚ_tok’”
 *
tok
, 
æags
)

791 
tok
->
æags
 = flags;

792 
	}
}

	@json/json_tokener.h

12 #iâdeà
_jsÚ_tok’”_h_


13 
	#_jsÚ_tok’”_h_


	)

15 
	~<¡ddef.h
>

16 
	~"jsÚ_objeù.h
"

18 #ifdeà
__ılu¥lus


22 
	ejsÚ_tok’”_”rÜ
 {

23 
jsÚ_tok’”_sucûss
,

24 
jsÚ_tok’”_cÚtšue
,

25 
jsÚ_tok’”_”rÜ_d•th
,

26 
jsÚ_tok’”_”rÜ_·r£_eof
,

27 
jsÚ_tok’”_”rÜ_·r£_uÃx³ùed
,

28 
jsÚ_tok’”_”rÜ_·r£_nuÎ
,

29 
jsÚ_tok’”_”rÜ_·r£_boŞ—n
,

30 
jsÚ_tok’”_”rÜ_·r£_numb”
,

31 
jsÚ_tok’”_”rÜ_·r£_¬¿y
,

32 
jsÚ_tok’”_”rÜ_·r£_objeù_key_Çme
,

33 
jsÚ_tok’”_”rÜ_·r£_objeù_key_£p
,

34 
jsÚ_tok’”_”rÜ_·r£_objeù_v®ue_£p
,

35 
jsÚ_tok’”_”rÜ_·r£_¡ršg
,

36 
jsÚ_tok’”_”rÜ_·r£_comm’t


39 
	ejsÚ_tok’”_¡©e
 {

40 
jsÚ_tok’”_¡©e_—tws
,

41 
jsÚ_tok’”_¡©e_¡¬t
,

42 
jsÚ_tok’”_¡©e_fšish
,

43 
jsÚ_tok’”_¡©e_nuÎ
,

44 
jsÚ_tok’”_¡©e_comm’t_¡¬t
,

45 
jsÚ_tok’”_¡©e_comm’t
,

46 
jsÚ_tok’”_¡©e_comm’t_eŞ
,

47 
jsÚ_tok’”_¡©e_comm’t_’d
,

48 
jsÚ_tok’”_¡©e_¡ršg
,

49 
jsÚ_tok’”_¡©e_¡ršg_esÿ³
,

50 
jsÚ_tok’”_¡©e_esÿ³_unicode
,

51 
jsÚ_tok’”_¡©e_boŞ—n
,

52 
jsÚ_tok’”_¡©e_numb”
,

53 
jsÚ_tok’”_¡©e_¬¿y
,

54 
jsÚ_tok’”_¡©e_¬¿y_add
,

55 
jsÚ_tok’”_¡©e_¬¿y_£p
,

56 
jsÚ_tok’”_¡©e_objeù_f›ld_¡¬t
,

57 
jsÚ_tok’”_¡©e_objeù_f›ld
,

58 
jsÚ_tok’”_¡©e_objeù_f›ld_’d
,

59 
jsÚ_tok’”_¡©e_objeù_v®ue
,

60 
jsÚ_tok’”_¡©e_objeù_v®ue_add
,

61 
jsÚ_tok’”_¡©e_objeù_£p
,

62 
jsÚ_tok’”_¡©e_¬¿y_aá”_£p
,

63 
jsÚ_tok’”_¡©e_objeù_f›ld_¡¬t_aá”_£p


66 
	sjsÚ_tok’”_¤ec


68 
jsÚ_tok’”_¡©e
 
¡©e
, 
§ved_¡©e
;

69 
jsÚ_objeù
 *
obj
;

70 
jsÚ_objeù
 *
cu¼’t
;

71 *
obj_f›ld_Çme
;

74 
	#JSON_TOKENER_DEFAULT_DEPTH
 32

	)

76 
	sjsÚ_tok’”


78 *
¡r
;

79 
´štbuf
 *
pb
;

80 
max_d•th
, 
d•th
, 
is_doubË
, 
¡_pos
, 
ch¬_off£t
;

81 
jsÚ_tok’”_”rÜ
 
”r
;

82 
ucs_ch¬
;

83 
quÙe_ch¬
;

84 
jsÚ_tok’”_¤ec
 *
¡ack
;

85 
æags
;

98 
	#JSON_TOKENER_STRICT
 0x01

	)

106 cÚ¡ *
jsÚ_tok’”_”rÜ_desc
(
jsÚ_tok’”_”rÜ
 
j”r
);

114 cÚ¡ * 
jsÚ_tok’”_”rÜs
[];

125 
jsÚ_tok’”_”rÜ
 
jsÚ_tok’”_g‘_”rÜ
(
jsÚ_tok’”
 *
tok
);

127 
jsÚ_tok’”
* 
jsÚ_tok’”_Ãw
();

128 
jsÚ_tok’”
* 
jsÚ_tok’”_Ãw_ex
(
d•th
);

129 
jsÚ_tok’”_ä“
(
jsÚ_tok’”
 *
tok
);

130 
jsÚ_tok’”_»£t
(
jsÚ_tok’”
 *
tok
);

131 
jsÚ_objeù
* 
jsÚ_tok’”_·r£
(cÚ¡ *
¡r
);

132 
jsÚ_objeù
* 
jsÚ_tok’”_·r£_v”bo£
(cÚ¡ *
¡r
, 
jsÚ_tok’”_”rÜ
 *
”rÜ
);

137 
jsÚ_tok’”_£t_æags
(
jsÚ_tok’”
 *
tok
, 
æags
);

202 
jsÚ_objeù
* 
jsÚ_tok’”_·r£_ex
(
jsÚ_tok’”
 *
tok
,

203 cÚ¡ *
¡r
, 
Ën
);

205 #ifdeà
__ılu¥lus


	@json/json_util.c

12 
	~"jcÚfig.h
"

13 #undeà
»®loc


15 
	~<¡dio.h
>

16 
	~<¡dlib.h
>

17 
	~<¡ddef.h
>

18 
	~<lim™s.h
>

19 
	~<¡ršg.h
>

20 
	~<”ºo.h
>

21 
	~<ùy³.h
>

23 #ifdeà
HAVE_SYS_TYPES_H


24 
	~<sys/ty³s.h
>

27 #ifdeà
HAVE_SYS_STAT_H


28 
	~<sys/¡©.h
>

31 #ifdeà
HAVE_FCNTL_H


32 
	~<fú.h
>

35 #ifdeà
HAVE_UNISTD_H


36 
	~<uni¡d.h
>

39 #ifdeà
WIN32


40 
	#WIN32_LEAN_AND_MEAN


	)

41 
	~<wšdows.h
>

42 
	~<io.h
>

45 #ià!
defšed
(
HAVE_OPEN
è&& defšed(
WIN32
)

46 
	#İ’
 
_İ’


	)

49 #ià!
defšed
(
HAVE_SNPRINTF
è&& defšed(
_MSC_VER
)

51 
	#¢´štf
 
_¢´štf


	)

52 #–ià!
defšed
(
HAVE_SNPRINTF
)

53 #”rÜ 
You
 dØ
nÙ
 
have
 
¢´štf
 
Ú
 
your
 
sy¡em
.

56 
	~"b™s.h
"

57 
	~"debug.h
"

58 
	~"´štbuf.h
"

59 
	~"jsÚ_š‰y³s.h
"

60 
	~"jsÚ_objeù.h
"

61 
	~"jsÚ_tok’”.h
"

62 
	~"jsÚ_ut.h
"

64 
	gssÿnf_is_brok’
 = 0;

65 
	gssÿnf_is_brok’_‹¡dÚe
 = 0;

66 
ssÿnf_is_brok’_‹¡
();

68 
jsÚ_objeù
* 
	$jsÚ_objeù_äom_fe
(cÚ¡ *
f’ame
)

70 
´štbuf
 *
pb
;

71 
jsÚ_objeù
 *
obj
;

72 
buf
[
JSON_FILE_BUF_SIZE
];

73 
fd
, 
»t
;

75 if((
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
)) < 0) {

76 
	`MC_ERROR
("json_object_from_file:ƒrror„eading file %s: %s\n",

77 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

78  
NULL
;

80 if(!(
pb
 = 
	`´štbuf_Ãw
())) {

81 
	`şo£
(
fd
);

82 
	`MC_ERROR
("json_object_from_file:…rintbuf_new failed\n");

83  
NULL
;

85 (
»t
 = 
	`»ad
(
fd
, 
buf
, 
JSON_FILE_BUF_SIZE
)) > 0) {

86 
	`´štbuf_mem­³nd
(
pb
, 
buf
, 
»t
);

88 
	`şo£
(
fd
);

89 if(
»t
 < 0) {

90 
	`MC_ABORT
("json_object_from_file:ƒrror„eading file %s: %s\n",

91 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

92 
	`´štbuf_ä“
(
pb
);

93  
NULL
;

95 
obj
 = 
	`jsÚ_tok’”_·r£
(
pb
->
buf
);

96 
	`´štbuf_ä“
(
pb
);

97  
obj
;

98 
	}
}

102 
	$jsÚ_objeù_to_fe_ext
(*
f’ame
, 
jsÚ_objeù
 *
obj
, 
æags
)

104 cÚ¡ *
jsÚ_¡r
;

105 
fd
, 
»t
;

106 
wpos
, 
wsize
;

108 if(!
obj
) {

109 
	`MC_ERROR
("json_object_to_file: object is‚ull\n");

113 if((
fd
 = 
	`İ’
(
f’ame
, 
O_WRONLY
 | 
O_TRUNC
 | 
O_CREAT
, 0644)) < 0) {

114 
	`MC_ERROR
("json_object_to_file:ƒrror opening file %s: %s\n",

115 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

119 if(!(
jsÚ_¡r
 = 
	`jsÚ_objeù_to_jsÚ_¡ršg_ext
(
obj
,
æags
))) {

120 
	`şo£
(
fd
);

124 
wsize
 = ()(
	`¡¾’
(
jsÚ_¡r
è& 
UINT_MAX
);

125 
wpos
 = 0;

126 
wpos
 < 
wsize
) {

127 if((
»t
 = 
	`wr™e
(
fd
, 
jsÚ_¡r
 + 
wpos
, 
wsize
-wpos)) < 0) {

128 
	`şo£
(
fd
);

129 
	`MC_ERROR
("json_object_to_file:ƒrror writing file %s: %s\n",

130 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

135 
wpos
 +ğ()
»t
;

138 
	`şo£
(
fd
);

140 
	}
}

144 
	$jsÚ_objeù_to_fe
(*
f’ame
, 
jsÚ_objeù
 *
obj
)

146  
	`jsÚ_objeù_to_fe_ext
(
f’ame
, 
obj
, 
JSON_C_TO_STRING_PLAIN
);

147 
	}
}

149 
	$jsÚ_·r£_doubË
(cÚ¡ *
buf
, *
»tv®
)

151  (
	`ssÿnf
(
buf
, "%lf", 
»tv®
)==1 ? 0 : 1);

152 
	}
}

159 
	$ssÿnf_is_brok’_‹¡
()

161 
št64_t
 
num64
;

163 ()
	`ssÿnf
(" -01234567890123456789012345", "%" 
SCNd64
, &
num64
);

164 
»t_”ºo
 = 
”ºo
;

165 
is_št64_mš
 = (
num64
 =ğ
INT64_MIN
);

167 ()
	`ssÿnf
(" 01234567890123456789012345", "%" 
SCNd64
, &
num64
);

168 
»t_”ºo2
 = 
”ºo
;

169 
is_št64_max
 = (
num64
 =ğ
INT64_MAX
);

171 ià(
»t_”ºo
 !ğ
ERANGE
 || !
is_št64_mš
 ||

172 
»t_”ºo2
 !ğ
ERANGE
 || !
is_št64_max
)

174 
	`MC_DEBUG
("sscanf_is_broken_test failed,ƒnabling workaround code\n");

175 
ssÿnf_is_brok’
 = 1;

177 
	}
}

179 
	$jsÚ_·r£_št64
(cÚ¡ *
buf
, 
št64_t
 *
»tv®
)

181 
št64_t
 
num64
;

182 cÚ¡ *
buf_sig_dig™s
;

183 
Üig_has_Ãg
;

184 
§ved_”ºo
;

186 ià(!
ssÿnf_is_brok’_‹¡dÚe
)

188 
	`ssÿnf_is_brok’_‹¡
();

189 
ssÿnf_is_brok’_‹¡dÚe
 = 1;

193 
	`is¥aû
(()*
buf
) && *buf)

194 
buf
++;

196 
”ºo
 = 0;

197 ià(
	`ssÿnf
(
buf
, "%" 
SCNd64
, &
num64
) != 1)

199 
	`MC_DEBUG
("Failedo…arse, sscanf != 1\n");

203 
§ved_”ºo
 = 
”ºo
;

204 
buf_sig_dig™s
 = 
buf
;

205 
Üig_has_Ãg
 = 0;

206 ià(*
buf_sig_dig™s
 == '-')

208 
buf_sig_dig™s
++;

209 
Üig_has_Ãg
 = 1;

213 ià(
ssÿnf_is_brok’
 && 
§ved_”ºo
 !ğ
ERANGE
)

215 
buf_cmp
[100];

216 *
buf_cmp_¡¬t
 = 
buf_cmp
;

217 
»check_has_Ãg
 = 0;

218 
buf_cmp_Ën
;

221 
buf_sig_dig™s
[0] == '0' && buf_sig_digits[1] != '\0')

222 
buf_sig_dig™s
++;

223 ià(
num64
 == 0)

224 
Üig_has_Ãg
 = 0;

226 
	`¢´štf
(
buf_cmp_¡¬t
, (
buf_cmp
), "%" 
PRId64
, 
num64
);

227 ià(*
buf_cmp_¡¬t
 == '-')

229 
»check_has_Ãg
 = 1;

230 
buf_cmp_¡¬t
++;

234 
buf_cmp_Ën
 = 
	`¡¾’
(
buf_cmp_¡¬t
);

241 ià(
Üig_has_Ãg
 !ğ
»check_has_Ãg
 ||

242 
	`¡ºcmp
(
buf_sig_dig™s
, 
buf_cmp_¡¬t
, 
	`¡¾’
(buf_cmp_start)) != 0 ||

243 (()
	`¡¾’
(
buf_sig_dig™s
è!ğ
buf_cmp_Ën
 &&

244 
	`isdig™
(()
buf_sig_dig™s
[
buf_cmp_Ën
])

248 
§ved_”ºo
 = 
ERANGE
;

255 ià(
§ved_”ºo
 =ğ
ERANGE
)

257 ià(
Üig_has_Ãg
)

258 
num64
 = 
INT64_MIN
;

260 
num64
 = 
INT64_MAX
;

262 *
»tv®
 = 
num64
;

264 
	}
}

266 #iâdeà
HAVE_REALLOC


267 * 
	$½l_»®loc
(* 
p
, 
size_t
 
n
)

269 ià(
n
 == 0)

270 
n
 = 1;

271 ià(
p
 == 0)

272  
	`m®loc
(
n
);

273  
	`»®loc
(
p
, 
n
);

274 
	}
}

277 
	#NELEM
(
a
è(×è/ ×[0]))

	)

278 cÚ¡ * 
	gjsÚ_ty³_Çme
[] = {

289 cÚ¡ *
	$jsÚ_ty³_to_Çme
(
jsÚ_ty³
 
o_ty³
)

291 
o_ty³_št
 = ()
o_ty³
;

292 ià(
o_ty³_št
 < 0 || o_ty³_šˆ>ğ()
	`NELEM
(
jsÚ_ty³_Çme
))

294 
	`MC_ERROR
("jsÚ_ty³_to_Çme:y³ %d i ouˆoà¿ng[0,%d]\n", 
o_ty³
, 
	`NELEM
(
jsÚ_ty³_Çme
));

295  
NULL
;

297  
jsÚ_ty³_Çme
[
o_ty³
];

298 
	}
}

	@json/json_util.h

12 #iâdeà
_jsÚ_ut_h_


13 
	#_jsÚ_ut_h_


	)

15 
	~"jsÚ_objeù.h
"

17 #ifdeà
__ılu¥lus


21 
	#JSON_FILE_BUF_SIZE
 4096

	)

24 
jsÚ_objeù
* 
jsÚ_objeù_äom_fe
(cÚ¡ *
f’ame
);

25 
jsÚ_objeù_to_fe
(*
f’ame
, 
jsÚ_objeù
 *
obj
);

26 
jsÚ_objeù_to_fe_ext
(*
f’ame
, 
jsÚ_objeù
 *
obj
, 
æags
);

27 
jsÚ_·r£_št64
(cÚ¡ *
buf
, 
št64_t
 *
»tv®
);

28 
jsÚ_·r£_doubË
(cÚ¡ *
buf
, *
»tv®
);

35 cÚ¡ *
jsÚ_ty³_to_Çme
(
jsÚ_ty³
 
o_ty³
);

37 #ifdeà
__ılu¥lus


	@json/libjson.c

4 #ià
defšed
(
HAVE_CDEFS_H
)

5 
	~<sys/cdefs.h
>

8 #iâdeà
__w¬n_»ã»nûs


10 #ià
defšed
(
__GNUC__
è&& defšed (
HAS_GNU_WARNING_LONG
)

12 
	#__w¬n_»ã»nûs
(
sym
,
msg
) \

13 
	`__asm__
(".£ùiÚ .gnu" #sym ",\n\t.asci˜\"" 
msg
 "\"\n\t.‹xt");

	)

16 
	#__w¬n_»ã»nûs
(
sym
,
msg
è

	)

21 
	~"jsÚ_objeù.h
"

23 
__w¬n_»ã»nûs
(
jsÚ_objeù_g‘
, "Warning:…lease†ink‡gainst†ibjson-c instead of†ibjson");

	@json/linkhash.c

13 
	~<¡dio.h
>

14 
	~<¡ršg.h
>

15 
	~<¡dlib.h
>

16 
	~<¡d¬g.h
>

17 
	~<¡ddef.h
>

18 
	~<lim™s.h
>

20 
	~"lškhash.h
"

22 
	$lh_abÜt
(cÚ¡ *
msg
, ...)

24 
va_li¡
 
­
;

25 
	`va_¡¬t
(
­
, 
msg
);

26 
	`v´štf
(
msg
, 
­
);

27 
	`va_’d
(
­
);

28 
	`ex™
(1);

29 
	}
}

31 
	$lh_±r_hash
(cÚ¡ *
k
)

34  ()((((
±rdiff_t
)
k
 * 
LH_PRIME
è>> 4è& 
ULONG_MAX
);

35 
	}
}

37 
	$lh_±r_equ®
(cÚ¡ *
k1
, cÚ¡ *
k2
)

39  (
k1
 =ğ
k2
);

40 
	}
}

42 
	$lh_ch¬_hash
(cÚ¡ *
k
)

44 
h
 = 0;

45 cÚ¡ * 
d©a
 = (cÚ¡ *)
k
;

47  *
d©a
!=0 ) 
h
 = h*129 + ()(*d©a++è+ 
LH_PRIME
;

49  
h
;

50 
	}
}

52 
	$lh_ch¬_equ®
(cÚ¡ *
k1
, cÚ¡ *
k2
)

54  (
	`¡rcmp
((cÚ¡ *)
k1
, (cÚ¡ *)
k2
) == 0);

55 
	}
}

57 
lh_bË
* 
	$lh_bË_Ãw
(
size
, cÚ¡ *
Çme
,

58 
lh_’Œy_ä“_â
 *
ä“_â
,

59 
lh_hash_â
 *
hash_â
,

60 
lh_equ®_â
 *
equ®_â
)

62 
i
;

63 
lh_bË
 *
t
;

65 
t
 = (
lh_bË
*)
	`ÿÎoc
(1, (lh_table));

66 if(!
t
è
	`lh_abÜt
("lh_table_new: calloc failed\n");

67 
t
->
couÁ
 = 0;

68 
t
->
size
 = size;

69 
t
->
Çme
 =‚ame;

70 
t
->
bË
 = (
lh_’Œy
*)
	`ÿÎoc
(
size
, (lh_entry));

71 if(!
t
->
bË
è
	`lh_abÜt
("lh_table_new: calloc failed\n");

72 
t
->
ä“_â
 = free_fn;

73 
t
->
hash_â
 = hash_fn;

74 
t
->
equ®_â
 =ƒqual_fn;

75 
i
 = 0; i < 
size
; i++è
t
->
bË
[i].
k
 = 
LH_EMPTY
;

76  
t
;

77 
	}
}

79 
lh_bË
* 
	$lh_kch¬_bË_Ãw
(
size
, cÚ¡ *
Çme
,

80 
lh_’Œy_ä“_â
 *
ä“_â
)

82  
	`lh_bË_Ãw
(
size
, 
Çme
, 
ä“_â
, 
lh_ch¬_hash
, 
lh_ch¬_equ®
);

83 
	}
}

85 
lh_bË
* 
	$lh_k±r_bË_Ãw
(
size
, cÚ¡ *
Çme
,

86 
lh_’Œy_ä“_â
 *
ä“_â
)

88  
	`lh_bË_Ãw
(
size
, 
Çme
, 
ä“_â
, 
lh_±r_hash
, 
lh_±r_equ®
);

89 
	}
}

91 
	$lh_bË_»size
(
lh_bË
 *
t
, 
Ãw_size
)

93 
lh_bË
 *
Ãw_t
;

94 
lh_’Œy
 *
’t
;

96 
Ãw_t
 = 
	`lh_bË_Ãw
(
Ãw_size
, 
t
->
Çme
, 
NULL
,->
hash_â
,->
equ®_â
);

97 
’t
 = 
t
->
h—d
;

98 
’t
) {

99 
	`lh_bË_š£¹
(
Ãw_t
, 
’t
->
k
,ƒÁ->
v
);

100 
’t
 =ƒÁ->
Ãxt
;

102 
	`ä“
(
t
->
bË
);

103 
t
->
bË
 = 
Ãw_t
->table;

104 
t
->
size
 = 
Ãw_size
;

105 
t
->
h—d
 = 
Ãw_t
->head;

106 
t
->

 = 
Ãw_t
->tail;

107 
t
->
»sizes
++;

108 
	`ä“
(
Ãw_t
);

109 
	}
}

111 
	$lh_bË_ä“
(
lh_bË
 *
t
)

113 
lh_’Œy
 *
c
;

114 
c
 = 
t
->
h—d
; c !ğ
NULL
; c = c->
Ãxt
) {

115 if(
t
->
ä“_â
) {

116 
t
->
	`ä“_â
(
c
);

119 
	`ä“
(
t
->
bË
);

120 
	`ä“
(
t
);

121 
	}
}

124 
	$lh_bË_š£¹
(
lh_bË
 *
t
, *
k
, cÚ¡ *
v
)

126 
h
, 
n
;

128 
t
->
š£¹s
++;

129 if(
t
->
couÁ
 >ğt->
size
 * 
LH_LOAD_FACTOR
è
	`lh_bË_»size
(t,->size * 2);

131 
h
 = 
t
->
	`hash_â
(
k
);

132 
n
 = 
h
 % 
t
->
size
;

135 if(
t
->
bË
[
n
].
k
 =ğ
LH_EMPTY
 ||->bË[n].k =ğ
LH_FREED
) ;

136 
t
->
cŞlisiÚs
++;

137 ià(()++
n
 =ğ
t
->
size
)‚ = 0;

140 
t
->
bË
[
n
].
k
 = k;

141 
t
->
bË
[
n
].
v
 = v;

142 
t
->
couÁ
++;

144 if(
t
->
h—d
 =ğ
NULL
) {

145 
t
->
h—d
 =->

 = &t->
bË
[
n
];

146 
t
->
bË
[
n
].
Ãxt
 =->bË[n].
´ev
 = 
NULL
;

148 
t
->

->
Ãxt
 = &t->
bË
[
n
];

149 
t
->
bË
[
n
].
´ev
 =->

;

150 
t
->
bË
[
n
].
Ãxt
 = 
NULL
;

151 
t
->

 = &t->
bË
[
n
];

155 
	}
}

158 
lh_’Œy
* 
	$lh_bË_lookup_’Œy
(
lh_bË
 *
t
, cÚ¡ *
k
)

160 
h
 = 
t
->
	`hash_â
(
k
);

161 
n
 = 
h
 % 
t
->
size
;

162 
couÁ
 = 0;

164 
t
->
lookups
++;

165  
couÁ
 < 
t
->
size
 ) {

166 if(
t
->
bË
[
n
].
k
 =ğ
LH_EMPTY
è 
NULL
;

167 if(
t
->
bË
[
n
].
k
 !ğ
LH_FREED
 &&

168 
t
->
	`equ®_â
Ñ->
bË
[
n
].
k
, k))  &t->table[n];

169 ià(()++
n
 =ğ
t
->
size
)‚ = 0;

170 
couÁ
++;

172  
NULL
;

173 
	}
}

176 cÚ¡ * 
	$lh_bË_lookup
(
lh_bË
 *
t
, cÚ¡ *
k
)

178 *
»suÉ
;

179 
	`lh_bË_lookup_ex
(
t
, 
k
, &
»suÉ
);

180  
»suÉ
;

181 
	}
}

183 
jsÚ_boŞ
 
	$lh_bË_lookup_ex
(
lh_bË
* 
t
, cÚ¡ * 
k
, **
v
)

185 
lh_’Œy
 *
e
 = 
	`lh_bË_lookup_’Œy
(
t
, 
k
);

186 ià(
e
 !ğ
NULL
) {

187 ià(
v
 !ğ
NULL
è*v = (*)
e
->v;

188  
TRUE
;

190 ià(
v
 !ğ
NULL
) *v = NULL;

191  
FALSE
;

192 
	}
}

194 
	$lh_bË_d–‘e_’Œy
(
lh_bË
 *
t
, 
lh_’Œy
 *
e
)

196 
±rdiff_t
 
n
 = (±rdiff_t)(
e
 - 
t
->
bË
);

199 if(
n
 < 0) {  -2; }

201 if(
t
->
bË
[
n
].
k
 =ğ
LH_EMPTY
 ||->bË[n].k =ğ
LH_FREED
)  -1;

202 
t
->
couÁ
--;

203 if(
t
->
ä“_â
èt->
	`ä“_â
(
e
);

204 
t
->
bË
[
n
].
v
 = 
NULL
;

205 
t
->
bË
[
n
].
k
 = 
LH_FREED
;

206 if(
t
->

 =ğ&t->
bË
[
n
] &&->
h—d
 == &t->table[n]) {

207 
t
->
h—d
 =->

 = 
NULL
;

208 } ià(
t
->
h—d
 =ğ&t->
bË
[
n
]) {

209 
t
->
h—d
->
Ãxt
->
´ev
 = 
NULL
;

210 
t
->
h—d
 =->h—d->
Ãxt
;

211 } ià(
t
->

 =ğ&t->
bË
[
n
]) {

212 
t
->

->
´ev
->
Ãxt
 = 
NULL
;

213 
t
->

 =->->
´ev
;

215 
t
->
bË
[
n
].
´ev
->
Ãxt
 =->table[n].next;

216 
t
->
bË
[
n
].
Ãxt
->
´ev
 =->table[n].prev;

218 
t
->
bË
[
n
].
Ãxt
 =->bË[n].
´ev
 = 
NULL
;

220 
	}
}

223 
	$lh_bË_d–‘e
(
lh_bË
 *
t
, cÚ¡ *
k
)

225 
lh_’Œy
 *
e
 = 
	`lh_bË_lookup_’Œy
(
t
, 
k
);

226 if(!
e
)  -1;

227  
	`lh_bË_d–‘e_’Œy
(
t
, 
e
);

228 
	}
}

230 
	$lh_bË_Ëngth
(
lh_bË
 *
t
)

232  
t
->
couÁ
;

233 
	}
}

	@json/linkhash.h

13 #iâdeà
_lškhash_h_


14 
	#_lškhash_h_


	)

16 
	~"jsÚ_objeù.h
"

18 #ifdeà
__ılu¥lus


25 
	#LH_PRIME
 0x9e370001UL

	)

32 
	#LH_LOAD_FACTOR
 0.66

	)

37 
	#LH_EMPTY
 (*)-1

	)

42 
	#LH_FREED
 (*)-2

	)

44 
lh_’Œy
;

49 (
lh_’Œy_ä“_â
è(
	tlh_’Œy
 *
	te
);

53 (
	tlh_hash_â
è(cÚ¡ *
	tk
);

57 (
lh_equ®_â
è(cÚ¡ *
	tk1
, cÚ¡ *
	tk2
);

62 
	slh_’Œy
 {

66 *
k
;

70 cÚ¡ *
v
;

74 
lh_’Œy
 *
Ãxt
;

78 
lh_’Œy
 *
´ev
;

85 
	slh_bË
 {

89 
size
;

93 
couÁ
;

98 
cŞlisiÚs
;

103 
»sizes
;

108 
lookups
;

113 
š£¹s
;

118 
d–‘es
;

123 cÚ¡ *
Çme
;

128 
lh_’Œy
 *
h—d
;

133 
lh_’Œy
 *

;

135 
lh_’Œy
 *
bË
;

140 
lh_’Œy_ä“_â
 *
ä“_â
;

141 
lh_hash_â
 *
hash_â
;

142 
lh_equ®_â
 *
equ®_â
;

149 
lh_±r_hash
(cÚ¡ *
k
);

150 
lh_±r_equ®
(cÚ¡ *
k1
, cÚ¡ *
k2
);

152 
lh_ch¬_hash
(cÚ¡ *
k
);

153 
lh_ch¬_equ®
(cÚ¡ *
k1
, cÚ¡ *
k2
);

159 
	#lh_fÜ—ch
(
bË
, 
’Œy
) \

160 
’Œy
 = 
bË
->
h—d
;ƒÁry;ƒÁry =ƒÁry->
Ãxt
)

	)

165 
	#lh_fÜ—ch_§ã
(
bË
, 
’Œy
, 
tmp
) \

166 
’Œy
 = 
bË
->
h—d
;ƒÁry && ((
tmp
 =ƒÁry->
Ãxt
è|| 1);ƒÁry =mp)

	)

187 
lh_bË
* 
lh_bË_Ãw
(
size
, cÚ¡ *
Çme
,

188 
lh_’Œy_ä“_â
 *
ä“_â
,

189 
lh_hash_â
 *
hash_â
,

190 
lh_equ®_â
 *
equ®_â
);

200 
lh_bË
* 
lh_kch¬_bË_Ãw
(
size
, cÚ¡ *
Çme
,

201 
lh_’Œy_ä“_â
 *
ä“_â
);

212 
lh_bË
* 
lh_k±r_bË_Ãw
(
size
, cÚ¡ *
Çme
,

213 
lh_’Œy_ä“_â
 *
ä“_â
);

222 
lh_bË_ä“
(
lh_bË
 *
t
);

231 
lh_bË_š£¹
(
lh_bË
 *
t
, *
k
, cÚ¡ *
v
);

240 
lh_’Œy
* 
lh_bË_lookup_’Œy
(
lh_bË
 *
t
, cÚ¡ *
k
);

249 cÚ¡ * 
lh_bË_lookup
(
lh_bË
 *
t
, cÚ¡ *
k
);

258 
jsÚ_boŞ
 
lh_bË_lookup_ex
(
lh_bË
 *
t
, cÚ¡ *
k
, **
v
);

269 
lh_bË_d–‘e_’Œy
(
lh_bË
 *
t
, 
lh_’Œy
 *
e
);

281 
lh_bË_d–‘e
(
lh_bË
 *
t
, cÚ¡ *
k
);

283 
lh_bË_Ëngth
(
lh_bË
 *
t
);

285 
lh_abÜt
(cÚ¡ *
msg
, ...);

286 
lh_bË_»size
(
lh_bË
 *
t
, 
Ãw_size
);

288 #ifdeà
__ılu¥lus


	@json/printbuf.c

16 
	~"jcÚfig.h
"

18 
	~<¡dio.h
>

19 
	~<¡dlib.h
>

20 
	~<¡ršg.h
>

22 #ifdeà
HAVE_STDARG_H


23 
	~<¡d¬g.h
>

25 #”rÜ 
NÙ
 
’ough
 
v¬
 
¬g
 
suµÜt
!

28 
	~"b™s.h
"

29 
	~"debug.h
"

30 
	~"´štbuf.h
"

32 
´štbuf_ex‹nd
(
´štbuf
 *
p
, 
mš_size
);

34 
´štbuf
* 
	$´štbuf_Ãw
()

36 
´štbuf
 *
p
;

38 
p
 = (
´štbuf
*)
	`ÿÎoc
(1, (printbuf));

39 if(!
p
è 
NULL
;

40 
p
->
size
 = 32;

41 
p
->
bpos
 = 0;

42 if(!(
p
->
buf
 = (*)
	`m®loc
Õ->
size
))) {

43 
	`ä“
(
p
);

44  
NULL
;

46  
p
;

47 
	}
}

58 
	$´štbuf_ex‹nd
(
´štbuf
 *
p
, 
mš_size
)

60 *
t
;

61 
Ãw_size
;

63 ià(
p
->
size
 >ğ
mš_size
)

66 
Ãw_size
 = 
	`jsÚ_max
(
p
->
size
 * 2, 
mš_size
 + 8);

67 #ifdeà
PRINTBUF_DEBUG


68 
	`MC_DEBUG
("printbuf_memappend:„ealloc "

70 
p
->
bpos
, 
mš_size
,…->
size
, 
Ãw_size
);

72 if(!(
t
 = (*)
	`»®loc
(
p
->
buf
, 
Ãw_size
)))

74 
p
->
size
 = 
Ãw_size
;

75 
p
->
buf
 = 
t
;

77 
	}
}

79 
	$´štbuf_mem­³nd
(
´štbuf
 *
p
, cÚ¡ *
buf
, 
size
)

81 ià(
p
->
size
 <ğp->
bpos
 + size + 1) {

82 ià(
	`´štbuf_ex‹nd
(
p
,…->
bpos
 + 
size
 + 1) < 0)

85 
	`memıy
(
p
->
buf
 +…->
bpos
, buf, 
size
);

86 
p
->
bpos
 +ğ
size
;

87 
p
->
buf
[p->
bpos
]= '\0';

88  
size
;

89 
	}
}

91 
	$´štbuf_mem£t
(
´štbuf
 *
pb
, 
off£t
, 
ch¬v®ue
, 
Ën
)

93 
size_Ãeded
;

95 ià(
off£t
 == -1)

96 
off£t
 = 
pb
->
bpos
;

97 
size_Ãeded
 = 
off£t
 + 
Ën
;

98 ià(
pb
->
size
 < 
size_Ãeded
)

100 ià(
	`´štbuf_ex‹nd
(
pb
, 
size_Ãeded
) < 0)

104 
	`mem£t
(
pb
->
buf
 + 
off£t
, 
ch¬v®ue
, 
Ën
);

105 ià(
pb
->
bpos
 < 
size_Ãeded
)

106 
pb
->
bpos
 = 
size_Ãeded
;

109 
	}
}

111 #ià!
defšed
(
HAVE_VSNPRINTF
è&& defšed(
_MSC_VER
)

112 
	#v¢´štf
 
_v¢´štf


	)

113 #–ià!
defšed
(
HAVE_VSNPRINTF
)

114 #”rÜ 
N“d
 
v¢´štf
!

117 #ià!
defšed
(
HAVE_VASPRINTF
)

119 
	$va¥rštf
(**
buf
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

121 #iâdeà
WIN32


122 
_T_em±ybufãr
 = '\0';

124 
ch¬s
;

125 *
b
;

127 if(!
buf
) {  -1; }

129 #ifdeà
WIN32


130 
ch¬s
 = 
	`_vsırštf
(
fmt
, 
­
)+1;

134 
ch¬s
 = 
	`v¢´štf
(&
_T_em±ybufãr
, 0, 
fmt
, 
­
)+1;

135 if(
ch¬s
 < 0) { chars *= -1; }

138 
b
 = (*)
	`m®loc
(()*
ch¬s
);

139 if(!
b
) {  -1; }

141 if((
ch¬s
 = 
	`v¥rštf
(
b
, 
fmt
, 
­
)) < 0)

143 
	`ä“
(
b
);

145 *
buf
 = 
b
;

148  
ch¬s
;

149 
	}
}

152 
	$¥rštbuf
(
´štbuf
 *
p
, cÚ¡ *
msg
, ...)

154 
va_li¡
 
­
;

155 *
t
;

156 
size
;

157 
buf
[128];

160 
	`va_¡¬t
(
­
, 
msg
);

161 
size
 = 
	`v¢´štf
(
buf
, 128, 
msg
, 
­
);

162 
	`va_’d
(
­
);

167 if(
size
 == -1 || size > 127) {

168 
	`va_¡¬t
(
­
, 
msg
);

169 if((
size
 = 
	`va¥rštf
(&
t
, 
msg
, 
­
)è< 0è{ 
	`va_’d
(ap);  -1; }

170 
	`va_’d
(
­
);

171 
	`´štbuf_mem­³nd
(
p
, 
t
, 
size
);

172 
	`ä“
(
t
);

173  
size
;

175 
	`´štbuf_mem­³nd
(
p
, 
buf
, 
size
);

176  
size
;

178 
	}
}

180 
	$´štbuf_»£t
(
´štbuf
 *
p
)

182 
p
->
buf
[0] = '\0';

183 
p
->
bpos
 = 0;

184 
	}
}

186 
	$´štbuf_ä“
(
´štbuf
 *
p
)

188 if(
p
) {

189 
	`ä“
(
p
->
buf
);

190 
	`ä“
(
p
);

192 
	}
}

	@json/printbuf.h

16 #iâdeà
_´štbuf_h_


17 
	#_´štbuf_h_


	)

19 #ifdeà
__ılu¥lus


23 
	s´štbuf
 {

24 *
buf
;

25 
bpos
;

26 
size
;

29 
´štbuf
*

30 
´štbuf_Ãw
();

40 
´štbuf_mem­³nd
(
´štbuf
 *
p
, cÚ¡ *
buf
, 
size
);

42 
	#´štbuf_mem­³nd_ç¡
(
p
, 
buåŒ
, 
bufsize
) \

44 ià((
p
->
size
 -…->
bpos
è> 
bufsize
) { \

45 
	`memıy
(
p
->
buf
 +…->
bpos
, (
buåŒ
), 
bufsize
); \

46 
p
->
bpos
 +ğ
bufsize
; \

47 
p
->
buf
[p->
bpos
]= '\0'; \

48 } { 
	`´štbuf_mem­³nd
(
p
, (
buåŒ
), 
bufsize
); } \

49 } 0)

	)

51 
	#´štbuf_Ëngth
(
p
è(Õ)->
bpos
)

	)

62 
´štbuf_mem£t
(
´štbuf
 *
pb
, 
off£t
, 
ch¬v®ue
, 
Ën
);

65 
¥rštbuf
(
´štbuf
 *
p
, cÚ¡ *
msg
, ...);

68 
´štbuf_»£t
(
´štbuf
 *
p
);

71 
´štbuf_ä“
(
´štbuf
 *
p
);

73 #ifdeà
__ılu¥lus


	@radius/example/local.c

12 
	~<r_cÚfig.h
>

13 
	~<šşudes.h
>

14 
	~<ä“¿dius-ş›Á.h
>

15 
	~<mes§ges.h
>

16 
	~<¿dlogš.h
>

18 
ENV
 *
’v
;

20 
LFUNC
 
	$auth_loÿl
(*
u£ºame
, *
·sswd
)

22 
·sswd
 *
pw
;

23 *
x·sswd
;

24 #ifdeà
SHADOW_PASSWORD


25 
¥wd
 *
¥w
;

28 ià((
pw
 = 
	`g‘pwÇm
(
u£ºame
)è=ğ
NULL
) {

29 
	`’dpw’t
();

30 
	`rc_log
(
LOG_NOTICE
, "auth’tiÿtiÚ FAILED,y³†oÿl, u£ºam%s", 
u£ºame
);

31 
	`´štf
(
SC_LOCAL_FAILED
);

32  
NULL
;

34 
	`’dpw’t
();

36 #ifdeà
SHADOW_PASSWORD


37 if((
¥w
 = 
	`g‘¥Çm
(
pw
->
pw_Çme
)è=ğ
NULL
) {

38 
	`’d¥’t
();

39 
	`rc_log
(
LOG_NOTICE
, "auth’tiÿtiÚ FAILED,y³†oÿl, u£ºam%s", 
u£ºame
);

40 
	`´štf
(
SC_LOCAL_FAILED
);

41  
NULL
;

45 
pw
->
pw_·sswd
 = 
¥w
->
¥_pwdp
;

47 
	`’d¥’t
();

50 
x·sswd
 = 
	`üy±
(
·sswd
, 
pw
->
pw_·sswd
);

52 ià(*
pw
->
pw_·sswd
 =ğ'\0' || 
	`¡rcmp
(
x·sswd
,…w->pw_passwd)) {

53 
	`rc_log
(
LOG_NOTICE
, "auth’tiÿtiÚ FAILED,y³†oÿl, u£ºam%s", 
u£ºame
);

54 
	`´štf
(
SC_LOCAL_FAILED
);

55  
NULL
;

58 
	`rc_log
(
LOG_NOTICE
, "auth’tiÿtiÚ OK,y³†oÿl, u£ºam%s", 
u£ºame
);

59 
	`´štf
(
SC_LOCAL_OK
);

61  
loÿl_logš
;

62 
	}
}

65 
	$loÿl_logš
(
rc_hªdË
 *
rh
, *
u£ºame
)

67 *
logš_loÿl
 = 
	`rc_cÚf_¡r
(
rh
, "login_local");

72 ià(*
u£ºame
 == '-') {

73 
	`rc_log
(
LOG_WARNING
, "username can't start with‡ dash");

74 
	`ex™
(
ERROR_RC
);

80 
	`exeşe
(
logš_loÿl
,†ogš_loÿl, "-h", "loÿlho¡", "-f", 
u£ºame
, 
NULL
, 
’v
->env);

81 
	`rc_log
(
LOG_ERR
, "couldn'ˆexecu‹ %s: %s", 
logš_loÿl
, 
	`¡»¼Ü
(
”ºo
));

82 
	`¦“p
(1);

83 
	`ex™
(
ERROR_RC
);

84 
	}
}

	@radius/example/radacct.c

12 
	grcsid
[] =

15 
	~<r_cÚfig.h
>

16 
	~<šşudes.h
>

17 
	~<ä“¿dius-ş›Á.h
>

18 
	~<mes§ges.h
>

19 
	~<·thÇmes.h
>

21 *
	g²ame
;

23 
	$u§ge
()

25 
	`årštf
(
¡d”r
,"U§ge: % [-Vh] [-à<cÚfig_fe>] [-˜<ş›Á_pÜt>]\n\n", 
²ame
);

26 
	`årštf
(
¡d”r
," -V output version information\n");

27 
	`årštf
(
¡d”r
," -h outputhisext\n");

28 
	`årštf
(
¡d”r
," -f filename of‡lternate config file\n");

29 
	`årštf
(
¡d”r
," -itynameo sendohe server\n");

30 
	`ex™
(
ERROR_RC
);

31 
	}
}

33 
	$v”siÚ
()

35 
	`årštf
(
¡d”r
,"%s: %s\n", 
²ame
 ,
rcsid
);

36 
	`ex™
(
ERROR_RC
);

37 
	}
}

40 
	$maš
 (
¬gc
, **
¬gv
)

42 
»suÉ
 = 
ERROR_RC
;

43 
VALUE_PAIR
 *
£nd
 = 
NULL
;

44 
ušt32_t
 
ş›Á_pÜt
;

45 
c
;

46 
VALUE_PAIR
 *
vp
;

47 
DICT_VALUE
 *
dv®
;

48 *
u£ºame
, *
£rviû
, *
årÙo
, *
ty³
;

49 *
·th_¿diusş›Á_cÚf
 = 
RC_CONFIG_FILE
;

50 *
‰yn
 = 
NULL
;

51 
rc_hªdË
 *
rh
;

53 *
İrg
;

55 
²ame
 = (²amğ
	`¡¼chr
(
¬gv
[0],'/'))?pname+1:argv[0];

57 
	`rc_İ’log
(
²ame
);

59 (
c
 = 
	`g‘İt
(
¬gc
,
¬gv
,"f:i:hV")) > 0)

61 
c
)

64 
·th_¿diusş›Á_cÚf
 = 
İrg
;

67 
‰yn
 = 
İrg
;

70 
	`v”siÚ
();

73 
	`u§ge
();

76 
	`ex™
(
ERROR_RC
);

81 ià((
rh
 = 
	`rc_»ad_cÚfig
(
·th_¿diusş›Á_cÚf
)è=ğ
NULL
)

82 
	`ex™
(
ERROR_RC
);

84 ià(
	`rc_»ad_diùiÚ¬y
(
rh
, 
	`rc_cÚf_¡r
(rh, "dictionary")) != 0)

85 
	`ex™
 (
ERROR_RC
);

87 ià(
	`rc_»ad_m­fe
(
rh
, 
	`rc_cÚf_¡r
(rh, "mapfile")) != 0)

88 
	`ex™
 (
ERROR_RC
);

90 ià(
‰yn
 !ğ
NULL
)

92 
ş›Á_pÜt
 = 
	`rc_m­2id
(
rh
, 
‰yn
);

99 ià((
‰yn
 = 
	`‰yÇme
(1)è!ğ
NULL
)

101 
ş›Á_pÜt
 = 
	`rc_m­2id
(
rh
, 
‰yn
);

105 
ş›Á_pÜt
 = 0;

109 ià((
£nd
 = 
	`rc_av·œ_»adš
(
rh
, 
¡dš
))) {

111 
u£ºame
 = 
£rviû
 = 
ty³
 = "(unknown)";

112 
årÙo
 = 
NULL
;

114 ià((
vp
 = 
	`rc_av·œ_g‘
(
£nd
, 
PW_ACCT_STATUS_TYPE
, 0)è!ğ
NULL
)

115 ià((
dv®
 = 
	`rc_diù_g‘v®
(
rh
, 
vp
->
lv®ue
, vp->
Çme
)è!ğ
NULL
) {

116 
ty³
 = 
dv®
->
Çme
;

119 ià((
vp
 = 
	`rc_av·œ_g‘
(
£nd
, 
PW_USER_NAME
, 0)è!ğ
NULL
)

120 
u£ºame
 = 
vp
->
¡rv®ue
;

122 ià((
vp
 = 
	`rc_av·œ_g‘
(
£nd
, 
PW_SERVICE_TYPE
, 0)è!ğ
NULL
)

123 ià((
dv®
 = 
	`rc_diù_g‘v®
(
rh
, 
vp
->
lv®ue
, vp->
Çme
)è!ğ
NULL
) {

124 
£rviû
 = 
dv®
->
Çme
;

127 ià(
vp
 && (vp->
lv®ue
 =ğ
PW_FRAMED
) &&

128 ((
vp
 = 
	`rc_av·œ_g‘
(
£nd
, 
PW_FRAMED_PROTOCOL
, 0)è!ğ
NULL
))

129 ià((
dv®
 = 
	`rc_diù_g‘v®
(
rh
, 
vp
->
lv®ue
, vp->
Çme
)è!ğ
NULL
) {

130 
årÙo
 = 
dv®
->
Çme
;

133 
»suÉ
 = 
	`rc_acù
(
rh
, 
ş›Á_pÜt
, 
£nd
);

134 ià(
»suÉ
 =ğ
OK_RC
)

136 
	`årštf
(
¡d”r
, 
SC_ACCT_OK
);

137 
	`rc_log
(
LOG_NOTICE
, "accounting OK,ype %s, username %s, service %s%s%s",

138 
ty³
, 
u£ºame
, 
£rviû
,(
årÙo
)?"/":"", (fproto)?fproto:"");

142 
	`årštf
(
¡d”r
, 
SC_ACCT_FAILED
, 
»suÉ
);

143 
	`rc_log
(
LOG_NOTICE
, "accounting FAILED,ype %s, username %s, service %s%s%s",

144 
ty³
, 
u£ºame
, 
£rviû
,(
årÙo
)?"/":"", (fproto)?fproto:"");

146 
	`rc_av·œ_ä“
(
£nd
);

149 
	`ex™
 (
»suÉ
);

150 
	}
}

	@radius/example/radembedded.c

7 
	~<¡dlib.h
>

8 
	~<sys/ty³s.h
>

9 
	~<sy¦og.h
>

10 
	~<ä“¿dius-ş›Á.h
>

14 
	$maš
 (
¬gc
, **
¬gv
)

16 
»tv®
 = 0;

17 
rc_hªdË
 *
rh
 = 
NULL
;

19 
ušt32_t
 
ş›Á_pÜt
 = 0;

20 
ušt32_t
 
¡©us_ty³
 = 
PW_STATUS_STOP
;

21 
VALUE_PAIR
 *
£nd
 = 
NULL
;

26 
u£ºame
[255] = "bob@somedomain.here";

27 
ÿÎäom
[255] = "8475551212";

28 
ÿÎto
[255] = "8479630116";

29 
myuuid
[255] = "981743-asdf-90834klj234";

33 
rh
 = 
	`rc_Ãw
();

34 ià(
rh
 =ğ
NULL
)

36 
	`´štf
("ERROR: Failedo‡llocate initial structure\n");

37 
	`ex™
(1);

42 
rh
 = 
	`rc_cÚfig_š™
(rh);

43 ià(
rh
 =ğ
NULL
)

45 
	`´štf
("ERROR: Failedo initialze configuration\n");

46 
	`ex™
(1);

55 ià(
	`rc_add_cÚfig
(
rh
, "auth_order", "radius", "config", 0) != 0)

57 
	`´štf
("ERROR: Unableo set‡uth_order.\n");

58 
	`rc_de¡roy
(
rh
);

59 
	`ex™
(1);

62 ià(
	`rc_add_cÚfig
(
rh
, "login_tries", "4", "config", 0) != 0)

64 
	`´štf
("ERROR: Unableo set†ogin_tries.\n");

65 
	`rc_de¡roy
(
rh
);

66 
	`ex™
(1);

69 ià(
	`rc_add_cÚfig
(
rh
, "dictionary", "/usr/local/radius/dictionary", "config", 0) != 0)

71 
	`´štf
("ERROR: Unableo set dictionary.\n");

72 
	`rc_de¡roy
(
rh
);

73 
	`ex™
(1);

76 ià(
	`rc_add_cÚfig
(
rh
, "seqfile", "/var/run/radius.seq", "config", 0) != 0)

78 
	`´štf
("ERROR: Unableo set seq file.\n");

79 
	`rc_de¡roy
(
rh
);

80 
	`ex™
(1);

83 ià(
	`rc_add_cÚfig
(
rh
, "radius_retries", "3", "config", 0) != 0)

85 
	`´štf
("ERROR: Unableo set„adius_retries.\n");

86 
	`rc_de¡roy
(
rh
);

87 
	`ex™
(1);

90 ià(
	`rc_add_cÚfig
(
rh
, "radius_timeout", "5", "config", 0) != 0)

92 
	`´štf
("ERROR: Unableo set„adius_timeout.\n");

93 
	`rc_de¡roy
(
rh
);

94 
	`ex™
(1);

103 ià(
	`rc_add_cÚfig
(
rh
, "authserver", "localhost::testing123", "config", 0) != 0)

105 
	`´štf
("ERROR: Unableo set‡uthserver.\n");

106 
	`rc_de¡roy
(
rh
);

107 
	`ex™
(1);

110 ià(
	`rc_add_cÚfig
(
rh
, "acctserver", "localhost:1813:testing123", "config", 0) != 0)

112 
	`´štf
("ERROR: Unableo set‡cctserver.\n");

113 
	`rc_de¡roy
(
rh
);

114 
	`ex™
(1);

121 ià(
	`rc_»ad_diùiÚ¬y
(
rh
, 
	`rc_cÚf_¡r
(rh, "dictionary")) != 0)

123 
	`´štf
("ERROR: Failedo initialize„adius dictionary\n");

124 
	`ex™
(1);

127 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_ACCT_STATUS_TYPE
, &
¡©us_ty³
, -1, 0è=ğ
NULL
)

129 
	`´štf
("ERROR: Faed‡ddšg Acù-Stus-Ty³:Ø%d\n", 
¡©us_ty³
);

130 
	`ex™
(1);

132 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_ACCT_SESSION_ID
, 
myuuid
, -1, 0è=ğ
NULL
)

134 
	`´štf
("ERROR: Faed‡ddšg Acù-SessiÚ-ID:Ø%s\n", 
myuuid
);

135 
	`ex™
(1);

137 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_USER_NAME
, 
u£ºame
, -1, 0è=ğ
NULL
)

139 
	`´štf
("ERROR: Faed‡ddšg U£r-Name:Ø%s\n", 
u£ºame
);

140 
	`ex™
(1);

142 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_CALLED_STATION_ID
, 
ÿÎto
, -1, 0è=ğ
NULL
)

144 
	`´štf
("ERROR: Faed‡ddšg C®Ëd-StiÚ-ID:Ø%s\n", 
ÿÎto
);

145 
	`ex™
(1);

147 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_CALLING_STATION_ID
, 
ÿÎäom
, -1, 0è=ğ
NULL
)

149 
	`´štf
("ERROR: Faed‡ddšg C®lšg-StiÚ-ID:Ø%s\n", 
ÿÎäom
);

150 
	`ex™
(1);

153 if(
	`rc_acù
(
rh
, 
ş›Á_pÜt
, 
£nd
è=ğ
OK_RC
)

155 
	`´štf
("INFO: AccouÁšg OK: %s\n", 
u£ºame
);

156 
»tv®
 = 0;

160 
	`´štf
("INFO: AccouÁšg Faed: %s\n", 
u£ºame
);

161 
»tv®
 = -1;

163 
	`rc_de¡roy
(
rh
);

164 
	`rc_av·œ_ä“
(
£nd
);

166 
	`ex™
(
»tv®
);

167 
	}
}

	@radius/example/radexample.c

13 
	~<r_cÚfig.h
>

14 
	~<šşudes.h
>

15 
	~<ä“¿dius-ş›Á.h
>

16 
	~<·thÇmes.h
>

18 *
	g²ame
 = 
NULL
;

20 
	#Œaûlše
(è
	`´štf
("fe: %s,†še: %u\n", 
__FILE__
, 
__LINE__
)

	)

23 
	$maš
 (
¬gc
, **
¬gv
)

25 
»suÉ
;

26 
u£ºame
[128];

27 
·sswd
[
AUTH_PASS_LEN
 + 1];

28 
VALUE_PAIR
 *
£nd
, *
»ûived
;

29 
ušt32_t
 
£rviû
;

30 
msg
[4096], 
u£ºame_»®m
[256];

31 *
deçuÉ_»®m
;

32 
rc_hªdË
 *
rh
;

34 
²ame
 = (²amğ
	`¡¼chr
(
¬gv
[0],'/'))?pname+1:argv[0];

36 
	`rc_İ’log
(
²ame
);

38 ià((
rh
 = 
	`rc_»ad_cÚfig
(
RC_CONFIG_FILE
)è=ğ
NULL
)

39  
ERROR_RC
;

41 ià(
	`rc_»ad_diùiÚ¬y
(
rh
, 
	`rc_cÚf_¡r
(rh, "dictionary")) != 0)

42  
ERROR_RC
;

44 
deçuÉ_»®m
 = 
	`rc_cÚf_¡r
(
rh
, "default_realm");

46 
	`¡ºıy
(
u£ºame
, 
	`rc_g‘¡r
 (
rh
, "login: ",1), (username));

47 
	`¡ºıy
 (
·sswd
, 
	`rc_g‘¡r
(
rh
, "Password: ",0),  (passwd));

49 
£nd
 = 
NULL
;

55 
	`¡ºıy
(
u£ºame_»®m
, 
u£ºame
, (username_realm));

58 ià((
	`¡rchr
(
u£ºame_»®m
, '@'è=ğ
NULL
è&& 
deçuÉ_»®m
 &&

59 (*
deçuÉ_»®m
 != '\0'))

61 
	`¡ºÿt
(
u£ºame_»®m
, "@", (u£ºame_»®m)-
	`¡¾’
(username_realm)-1);

62 
	`¡ºÿt
(
u£ºame_»®m
, 
deçuÉ_»®m
, (u£ºame_»®m)-
	`¡¾’
(username_realm)-1);

65 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_USER_NAME
, 
u£ºame_»®m
, -1, 0è=ğ
NULL
)

66  
ERROR_RC
;

72 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_USER_PASSWORD
, 
·sswd
, -1, 0è=ğ
NULL
)

73  
ERROR_RC
;

79 
£rviû
 = 
PW_AUTHENTICATE_ONLY
;

80 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_SERVICE_TYPE
, &
£rviû
, -1, 0è=ğ
NULL
)

81  
ERROR_RC
;

83 
»suÉ
 = 
	`rc_auth
(
rh
, 0, 
£nd
, &
»ûived
, 
msg
);

85 ià(
»suÉ
 =ğ
OK_RC
)

87 
	`årštf
(
¡d”r
, "\"%s\" RADIUS Auth’tiÿtiÚ OK\n", 
u£ºame
);

91 
	`årštf
(
¡d”r
, "\"%s\" RADIUS Auth’tiÿtiÚ fau» (RC=%i)\n", 
u£ºame
, 
»suÉ
);

94  
»suÉ
;

95 
	}
}

	@radius/example/radius.c

12 
	~<r_cÚfig.h
>

13 
	~<šşudes.h
>

14 
	~<ä“¿dius-ş›Á.h
>

15 
	~<mes§ges.h
>

16 
	~<¿dlogš.h
>

18 
ENV
 *
’v
;

20 
LFUNC
 
	$auth_¿dius
(
rc_hªdË
 *
rh
, 
ušt32_t
 
ş›Á_pÜt
, *
u£ºame
, *
·sswd
)

23 
VALUE_PAIR
 *
£nd
, *
»ûived
, *
vp
, *
£rviû_vp
;

24 
ušt32_t
 
£rviû
, 
áy³
, 
ùy³
;

25 
msg
[4096], *
p
, 
u£ºame_»®m
[256];

26 
Çme
[2048], 
v®ue
[2048];

27 
»suÉ
;

28 *
deçuÉ_»®m
, *
£rviû_¡r
, *
áy³_¡r
;

29 
DICT_VALUE
 *
dv®
;

31 
£nd
 = 
»ûived
 = 
NULL
;

37 #ifdeà
SCP


43 *
u£ºame
)

46 
£rviû
 = 
PW_FRAMED
;

47 
áy³
 = 
PW_SLIP
;

48 
ùy³
 = 0;

49 
u£ºame
++;

52 
£rviû
 = 
PW_FRAMED
;

53 
áy³
 = 
PW_SLIP
;

54 
ùy³
 = 
PW_VAN_JACOBSON_TCP_IP
;

55 
u£ºame
++;

58 
£rviû
 = 
PW_FRAMED
;

59 
áy³
 = 
PW_PPP
;

60 
ùy³
 = 0;

61 
u£ºame
++;

64 
£rviû
 = 
PW_LOGIN
;

65 
áy³
 = 0;

66 
ùy³
 = 0;

70 
£rviû
 = 
PW_LOGIN
;

71 
áy³
 = 0;

72 
ùy³
 = 0;

75 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_SERVICE_TYPE
, &
£rviû
, -1, 0è=ğ
NULL
)

76  
NULL
;

80 ià(
áy³
 != 0)

82 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_FRAMED_PROTOCOL
, &
áy³
, -1, 0è=ğ
NULL
)

83  
NULL
;

88 ià(
ùy³
 != 0)

90 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_FRAMED_COMPRESSION
, &
ùy³
, -1, 0è=ğ
NULL
)

91  
NULL
;

98 
	`¡ºıy
(
u£ºame_»®m
, 
u£ºame
, (username_realm));

101 
deçuÉ_»®m
 = 
	`rc_cÚf_¡r
(
rh
, "default_realm");

103 ià((
	`¡rchr
(
u£ºame_»®m
, '@'è=ğ
NULL
è&& 
deçuÉ_»®m
 &&

104 ((*
deçuÉ_»®m
) != '\0'))

106 
	`¡ºÿt
(
u£ºame_»®m
, "@", (u£ºame_»®m)-
	`¡¾’
(username_realm)-1);

107 
	`¡ºÿt
(
u£ºame_»®m
, 
deçuÉ_»®m
, (u£ºame_»®m)-
	`¡¾’
(username_realm)-1);

110 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_USER_NAME
, 
u£ºame_»®m
, -1, 0è=ğ
NULL
)

111  
NULL
;

117 ià(
	`rc_av·œ_add
(
rh
, &
£nd
, 
PW_USER_PASSWORD
, 
·sswd
, -1, 0è=ğ
NULL
)

118  
NULL
;

120 
»suÉ
 = 
	`rc_auth
(
rh
, 
ş›Á_pÜt
, 
£nd
, &
»ûived
, 
msg
);

122 ià(
»suÉ
 =ğ
OK_RC
)

125 
acouÁ
[256], 
©Œ
;

127 
	`mem£t
(
acouÁ
, 0, (acount));

129 
	`rc_add_’v
(
’v
, "RADIUS_USER_NAME", 
u£ºame
);

131 
vp
 = 
»ûived
;

137 
vp
)

139 
	`¡rıy
(
Çme
, "RADIUS_");

140 ià(
	`rc_av·œ_to¡r
(
rh
, 
vp
, 
Çme
+7, Òame)-7, 
v®ue
, (value)) < 0) {

141 
	`rc_av·œ_ä“
(
£nd
);

142 
	`rc_av·œ_ä“
(
»ûived
);

143  
NULL
;

147 
p
 = 
Çme
; *p;…++) {

148 *
p
 = 
	`touµ”
(*p);

149 ià(*
p
 == '-') *p = '_';

154 ià((
©Œ
 = 
vp
->
©Œibu‹
) < 256)

156 
couÁ
;

157 ià((
couÁ
 = 
acouÁ
[
©Œ
]++) > 0) {

158 
buf
[10];

159 
	`¥rštf
(
buf
, "_%d", 
couÁ
);

160 
	`¡rÿt
(
Çme
,
buf
);

164 ià(
	`rc_add_’v
(
’v
, 
Çme
, 
v®ue
) < 0)

166 
	`rc_av·œ_ä“
(
£nd
);

167 
	`rc_av·œ_ä“
(
»ûived
);

168  
NULL
;

171 
vp
 = vp->
Ãxt
;

174 
£rviû_¡r
 = "(unknown)";

175 
áy³_¡r
 = 
NULL
;

177 ià((
£rviû_vp
 = 
	`rc_av·œ_g‘
(
»ûived
, 
PW_SERVICE_TYPE
, 0)è!ğ
NULL
)

178 ià((
dv®
 = 
	`rc_diù_g‘v®
(
rh
, 
£rviû_vp
->
lv®ue
, s”viû_vp->
Çme
)è!ğ
NULL
) {

179 
£rviû_¡r
 = 
dv®
->
Çme
;

182 ià(
£rviû_vp
 && (£rviû_vp->
lv®ue
 =ğ
PW_FRAMED
) &&

183 ((
vp
 = 
	`rc_av·œ_g‘
(
»ûived
, 
PW_FRAMED_PROTOCOL
, 0)è!ğ
NULL
))

184 ià((
dv®
 = 
	`rc_diù_g‘v®
(
rh
, 
vp
->
lv®ue
, vp->
Çme
)è!ğ
NULL
) {

185 
áy³_¡r
 = 
dv®
->
Çme
;

188 
	`rc_log
(
LOG_NOTICE
, "authentication OK, username %s, service %s%s%s",

189 
u£ºame
, 
£rviû_¡r
,(
áy³_¡r
)?"/":"", (ftype_str)?ftype_str:"");

191 ià(
msg
 && (*msg != '\0'))

192 
	`´štf
(
SC_SERVER_REPLY
, 
msg
);

194 
	`´štf
(
SC_RADIUS_OK
);

196 
	`rc_av·œ_ä“
(
£nd
);

197 
	`rc_av·œ_ä“
(
»ûived
);

199  
¿dius_logš
;

203 
	`rc_log
(
LOG_NOTICE
, "authentication FAILED,ype RADIUS, username %s",

204 
u£ºame_»®m
);

205 ià(
msg
 && (*msg != '\0'))

206 
	`´štf
(
SC_SERVER_REPLY
, 
msg
);

208 
	`´štf
(
SC_RADIUS_FAILED
);

211 
	`rc_av·œ_ä“
(
£nd
);

212 ià(
»ûived
)

213 
	`rc_av·œ_ä“
(
»ûived
);

215  
NULL
;

216 
	}
}

219 
	$¿dius_logš
(
rc_hªdË
 *
rh
, *
u£ºame
)

221 *
logš_¿dius
 = 
	`rc_cÚf_¡r
(
rh
, "login_radius");

223 
	`exeşe
(
logš_¿dius
,†ogš_¿dius, 
NULL
, 
’v
->env);

225 
	`rc_log
(
LOG_ERR
, "couldn'ˆexecu‹ %s: %s", 
logš_¿dius
, 
	`¡»¼Ü
(
”ºo
));

226 
	`årštf
(
¡d”r
, "couldn'ˆexecu‹ %s: %s", 
logš_¿dius
, 
	`¡»¼Ü
(
”ºo
));

228 
	`¦“p
(1);

229 
	`ex™
(
ERROR_RC
);

230 
	}
}

	@radius/example/radiusclient.c

29 
	~<ùy³.h
>

30 
	~<¡dio.h
>

31 
	~<¡dlib.h
>

32 
	~<¡ršg.h
>

33 
	~<uni¡d.h
>

35 
	~<ä“¿dius-ş›Á.h
>

37 
´oûss
(*, 
VALUE_PAIR
 *, , );

40 
	$u§ge
()

43 
	`årštf
(
¡d”r
, "usage:„adiusclient [-f config_file] [-p‚as_port] [-s | [-a]‡1=v1 [a2=v2[...[aN=vN]...]]]\n");

44 
	`ex™
(1);

45 
	}
}

48 
	$maš
(
¬gc
, **
¬gv
)

50 
i
, 
Çs_pÜt
, 
ch
, 
acù
, 
£rv”
, 
ecouÁ
, 
fœ¡lše
, 
th“nd
;

51 *
rh
;

52 
size_t
 
Ën
;

53 
VALUE_PAIR
 *
£nd
, **
vp
;

54 *
rc_cÚf
, *
ı
;

55 
lbuf
[4096];

57 
rc_cÚf
 = 
RC_CONFIG_FILE
;

58 
Çs_pÜt
 = 5060;

60 
acù
 = 0;

61 
£rv”
 = 0;

62 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "af:p:s")) != -1) {

63 
ch
) {

65 
rc_cÚf
 = 
İrg
;

69 
Çs_pÜt
 = 
	`©oi
(
İrg
);

73 
acù
 = 1;

77 
£rv”
 = 1;

81 
	`u§ge
();

84 
¬gc
 -ğ
İtšd
;

85 
¬gv
 +ğ
İtšd
;

87 ià((
¬gc
 =ğ0 && 
£rv”
 == 0) || (argc != 0 && server != 0))

88 
	`u§ge
();

90 ià((
rh
 = 
	`rc_»ad_cÚfig
(
rc_cÚf
)è=ğ
NULL
) {

91 
	`årštf
(
¡d”r
, "error opening„adius configuration file\n");

92 
	`ex™
(1);

95 ià(
	`rc_»ad_diùiÚ¬y
(
rh
, 
	`rc_cÚf_¡r
(rh, "dictionary")) != 0) {

96 
	`årštf
(
¡d”r
, "error„eading„adius dictionary\n");

97 
	`ex™
(2);

100 ià(
£rv”
 == 0) {

101 
£nd
 = 
NULL
;

102 
vp
 = &
£nd
;

103 
i
 = 0; i < 
¬gc
; i++) {

104 ià(
	`rc_av·œ_·r£
(
rh
, 
¬gv
[
i
], 
vp
) < 0) {

105 
	`årštf
(
¡d”r
, "%s: cª'ˆ·r£ AV…aœ\n", 
¬gv
[
i
]);

106 
	`ex™
(3);

108 
vp
 = &
£nd
->
Ãxt
;

110 
	`ex™
(
	`´oûss
(
rh
, 
£nd
, 
acù
, 
Çs_pÜt
));

113 
£nd
 = 
NULL
;

114 
vp
 = &
£nd
;

115 
ecouÁ
 = 0;

116 
fœ¡lše
 = 1;

117 
acù
 = 0;

119 
Ën
 = 0;

120 
ı
 = 
	`rc_fg‘Ê
(
¡dš
, &
Ën
);

121 
th“nd
 = 1;

122 ià(
ı
 !ğ
NULL
 && 
Ën
 > 0) {

123 ià(
fœ¡lše
 != 0) {

124 ià(
Ën
 >ğ4 && 
	`memcmp
(
ı
, "ACCT", 4) == 0)

125 
acù
 = 1;

126 
fœ¡lše
 = 0;

127 
th“nd
 = 0;

130 
i
 = 0; i < 
Ën
; i++) {

131 ià(!
	`is¥aû
(
ı
[
i
])) {

132 
th“nd
 = 0;

136 ià(
th“nd
 == 0) {

137 
	`memıy
(
lbuf
, 
ı
, 
Ën
);

138 
lbuf
[
Ën
] = '\0';

139 ià(
	`rc_av·œ_·r£
(
rh
, 
lbuf
, 
vp
) < 0) {

140 
	`årštf
(
¡d”r
, "%s: cª'ˆ·r£ AV…aœ\n", 
lbuf
);

141 
ecouÁ
++;

143 
vp
 = &
£nd
->
Ãxt
;

147 } 
th“nd
 == 0);

148 ià(
£nd
 !ğ
NULL
 && 
ecouÁ
 == 0)

149 
	`´štf
("%d\n\n", 
	`´oûss
(
rh
, 
£nd
, 
acù
, 
Çs_pÜt
));

151 
	`´štf
("%d\n\n", -1);

152 
	`fæush
(
¡dout
);

153 ià(
£nd
 !ğ
NULL
)

154 
	`rc_av·œ_ä“
(
£nd
);

155 ià(
ı
 =ğ
NULL
 || 
Ën
 <= 0)

158 
	`ex™
(0);

159 
	}
}

162 
	$´oûss
(*
rh
, 
VALUE_PAIR
 *
£nd
, 
acù
, 
Çs_pÜt
)

164 
VALUE_PAIR
 *
»ûived
;

165 
msg
[4096];

166 
i
;

168 
»ûived
 = 
NULL
;

169 ià(
acù
 == 0) {

170 
i
 = 
	`rc_auth
(
rh
, 
Çs_pÜt
, 
£nd
, &
»ûived
, 
msg
);

171 ià(
»ûived
 !ğ
NULL
) {

172 
	`´štf
("%s", 
	`rc_av·œ_log
(
rh
, 
»ûived
));

173 
	`rc_av·œ_ä“
(
»ûived
);

176 
i
 = 
	`rc_acù
(
rh
, 
Çs_pÜt
, 
£nd
);

179  (
i
 =ğ
OK_RC
) ? 0 : 1;

180 
	}
}

	@radius/example/radlogin.c

13 
	grcsid
[] =

16 
	~<r_cÚfig.h
>

17 
	~<šşudes.h
>

18 
	~<ä“¿dius-ş›Á.h
>

19 
	~<mes§ges.h
>

20 
	~<·thÇmes.h
>

21 
	~<¿dlogš.h
>

23 
ENV
 *
	g’v
 = 
NULL
;

24 *
	g²ame
 = 
NULL
;

25 
rc_hªdË
 *
	grh
 = 
NULL
;

27 
RETSIGTYPE


28 
	$®¬m_hªdËr
(
¢
)

30 
	`årštf
(
¡d”r
, 
SC_TIMEOUT
, 
	`rc_cÚf_št
(
rh
, "login_timeout"));

31 
	`¦“p
(1);

32 
	`ex™
(
ERROR_RC
);

33 
	}
}

36 
	$logš_®lowed
(*
‰y
)

38 
FILE
 *
å
;

39 
âame
[
PATH_MAX
];

40 
c
;

42 
	`¡rıy
(
âame
, 
	`rc_cÚf_¡r
(
rh
, "nologin"));

43 ià(
	`acûss
(
âame
, 
F_OK
) < 0) {

44 ià(
‰y
) {

45 
	`¥rštf
(
âame
, "%s.%s", 
	`rc_cÚf_¡r
(
rh
, "nŞogš"), 
‰y
);

46 ià(
	`acûss
(
âame
, 
F_OK
) < 0)

53 ià((
å
 = 
	`fİ’
(
âame
, "r")è!ğ
NULL
)

55 (
c
 = 
	`fg‘c
(
å
)è!ğ
EOF
)

57 ià(
c
 == '\n')

58 
	`åutc
('\r', 
¡dout
);

59 
	`åutc
(
c
, 
¡dout
);

61 
	`fæush
(
¡dout
);

62 
	`fşo£
(
å
);

64 
	`´štf
(
SC_NOLOGIN
);

67 
	}
}

70 
	$sub¡_¶aûhŞd”s
(*
¡r
, *
‰y
)

72 *
p
,*
q
;

73 
buf
[4096];

74 #ià
	`defšed
(
HAVE_UNAME
)

75 
ut¢ame
 
uts
;

77 #ià!
	`defšed
(
HAVE_STRUCT_UTSNAME_DOMAINNAME
è&& defšed(
HAVE_GETDOMAINNAME
)

78 
domašÇme
[256];

81 #ià
	`defšed
(
HAVE_UNAME
)

82 
	`uÇme
(&
uts
);

85 
p
 = 
¡r
;

86 
q
 = 
buf
;

88 *
p
 != '\0') {

89 *
p
) {

91 ià(*(
p
+1) == '\0')

93 
p
++;

94 *
p
) {

96 
	`¡rıy
(
q
, 
rcsid
);

97 
q
 +ğ
	`¡¾’
(
rcsid
);

101 
	`¡rıy
(
q
, 
‰y
);

102 
q
 +ğ
	`¡¾’
(
‰y
);

104 #ià
	`defšed
(
HAVE_UNAME
)

106 
	`¡rıy
(
q
, 
uts
.
sy¢ame
);

107 
q
 +ğ
	`¡¾’
(
uts
.
sy¢ame
);

110 
	`¡rıy
(
q
, 
uts
.
nod’ame
);

111 
q
 +ğ
	`¡¾’
(
uts
.
nod’ame
);

114 
	`¡rıy
(
q
, 
uts
.
»Ëa£
);

115 
q
 +ğ
	`¡¾’
(
uts
.
»Ëa£
);

118 
	`¡rıy
(
q
, 
uts
.
v”siÚ
);

119 
q
 +ğ
	`¡¾’
(
uts
.
v”siÚ
);

122 
	`¡rıy
(
q
, 
uts
.
machše
);

123 
q
 +ğ
	`¡¾’
(
uts
.
machše
);

127 #ià
	`defšed
(
HAVE_STRUCT_UTSNAME_DOMAINNAME
)

128 
	`¡rıy
(
q
, 
uts
.
domašÇme
);

129 
q
 +ğ
	`¡¾’
(
uts
.
domašÇme
);

130 #–ià
	`defšed
(
HAVE_GETDOMAINNAME
)

131 
	`g‘domašÇme
(
domašÇme
, (domainname));

132 
	`¡rıy
(
q
, 
domašÇme
);

133 
q
 +ğ
	`¡¾’
(
domašÇme
);

137 *
q
 = '\\';

138 
q
++;

142 #ià
	`defšed
(
HAVE_UNAME
)

144 
	`¡rıy
(
q
, 
uts
.
nod’ame
);

145 
q
 +ğ
	`¡¾’
(
uts
.
nod’ame
);

149 
	`¡rıy
(
q
,"\r\n");

150 
q
 += 2;

153 *
q
 = *
p
;

154 
q
++;

158 
p
++;

160 *
q
 = '\0';

162  
buf
;

163 
	}
}

166 
	$u§ge
()

168 
	`årštf
(
¡d”r
,"U§ge: % [-Vhnd] [-à<cÚfig_fe>] [-˜<ş›Á_pÜt>] [-m <logš_Œ›s>]\n\n", 
²ame
);

169 
	`årštf
(
¡d”r
," -V output version information\n");

170 
	`årštf
(
¡d”r
," -h outputhisext\n");

171 
	`årštf
(
¡d”r
," -n don't display issue file\n");

172 
	`årštf
(
¡d”r
," -f filename of‡lternate config file\n");

173 
	`årštf
(
¡d”r
," -itynameo sendohe server\n");

174 
	`årštf
(
¡d”r
," -m maximum†oginries (overrides value in config file)\n");

175 
	`ex™
(
ERROR_RC
);

176 
	}
}

179 
	$v”siÚ
()

181 
	`årštf
(
¡d”r
,"%s: %s\n", 
²ame
 ,
rcsid
);

182 
	`ex™
(
ERROR_RC
);

183 
	}
}

186 
	$maš
 (
¬gc
, **
¬gv
)

188 
u£ºame
[128];

189 
·sswd
[
AUTH_PASS_LEN
 + 1];

190 
Œ›s
, 
»maššg
, 
c
;

191 
ušt32_t
 
ş›Á_pÜt
;

192 (*
logš_func
)(
rc_hªdË
 *, *);

193 
FILE
 *
å
;

194 
buf
[4096];

195 
‰y
[1024], *
p
;

196 
noissue
 = 0;

197 
maxŒ›s
 = 0;

198 *
‰yn
 = 
NULL
;

199 *
·th_¿diusş›Á_cÚf
 = 
RC_CONFIG_FILE
;

201 *
İrg
;

202 
İtšd
;

204 
²ame
 = (²amğ
	`¡¼chr
(
¬gv
[0],'/'))?pname+1:argv[0];

206 
	`rc_İ’log
(
²ame
);

208 (
c
 = 
	`g‘İt
(
¬gc
,
¬gv
,"f:m:i:nhV")) > 0)

210 
c
) {

212 
·th_¿diusş›Á_cÚf
 = 
İrg
;

215 
‰yn
 = 
İrg
;

218 
noissue
 = 1;

221 
maxŒ›s
 = 
	`©oi
(
İrg
);

224 
	`v”siÚ
();

227 
	`u§ge
();

230 
	`ex™
(
ERROR_RC
);

235 ià((
rh
 = 
	`rc_»ad_cÚfig
(
·th_¿diusş›Á_cÚf
)è=ğ
NULL
)

236 
	`ex™
(
ERROR_RC
);

238 ià(
	`rc_»ad_diùiÚ¬y
(
rh
, 
	`rc_cÚf_¡r
(rh, "dictionary")) != 0)

239 
	`ex™
 (
ERROR_RC
);

241 ià(
	`rc_»ad_m­fe
(
rh
, 
	`rc_cÚf_¡r
(rh, "mapfile")) != 0)

242 
	`ex™
 (
ERROR_RC
);

244 ià(
‰yn
 !ğ
NULL
)

246 
ş›Á_pÜt
 = 
	`rc_m­2id
(
rh
, 
‰yn
);

248 ià((
p
 = 
	`¡¼chr
(
‰yn
, '/')è=ğ
NULL
)

249 
	`¡ºıy
(
‰y
, 
‰yn
, (tty));

251 
	`¡ºıy
(
‰y
, 
p
+1, (tty));

255 
‰yn
 = 
	`‰yÇme
(0);

256 ià(
‰yn
)

258 ià((
p
 = 
	`¡¼chr
(
‰yn
, '/')è=ğ
NULL
)

259 
	`¡ºıy
(
‰y
, 
‰yn
, (tty));

261 
	`¡ºıy
(
‰y
, 
p
+1, (tty));

263 
ş›Á_pÜt
 = 
	`rc_m­2id
(
rh
, 
‰yn
);

267 *
‰y
 = '\0';

268 
ş›Á_pÜt
 = 0;

272 #ifdeà
SETVBUF_REVERSED


273 
	`£tvbuf
(
¡dout
, 
_IONBF
, 
NULL
, 0);

275 
	`£tvbuf
(
¡dout
, 
NULL
, 
_IONBF
, 0);

278 ià((
¬gc
 - 
İtšd
) == 1)

280 
	`¡ºıy
(
u£ºame
,
¬gv
[
İtšd
], (username));

284 *
u£ºame
 = '\0';

286 ià(!
noissue
) {

287 ià(
	`rc_cÚf_¡r
(
rh
, "issue"è&& ((
å
 = 
	`fİ’
Ôc_cÚf_¡rÔh, "issue"), "r")è!ğ
NULL
))

289 
	`fg‘s
(
buf
, (buf), 
å
è!ğ
NULL
)

290 
	`åuts
(
	`sub¡_¶aûhŞd”s
(
buf
, 
‰y
), 
¡dout
);

292 
	`fæush
(
¡dout
);

293 
	`fşo£
(
å
);

295 
	`åuts
(
	`sub¡_¶aûhŞd”s
(
SC_DEFAULT_ISSUE
, 
‰y
), 
¡dout
);

296 
	`fæush
(
¡dout
);

301 ià((
’v
 = 
	`rc_Ãw_’v
(
ENV_SIZE
)è=ğ
NULL
)

303 
	`rc_log
(
LOG_CRIT
, "rc_new_env: FATAL: out of memory");

304 
	`abÜt
();

307 #ifdeà
SECURITY_DISABLED


308 ià(
	`rc_impÜt_’v
(
’v
,
’vœÚ
) < 0)

310 
	`rc_log
(
LOG_CRIT
, "rc_import_env: FATAL:‚otƒnough space forƒnvironment (increase ENV_SIZE)");

311 
	`abÜt
();

314 
	`rc_add_’v
(
’v
, "IFS", " ");

315 
	`rc_add_’v
(
’v
, "PATH", 
RC_SECURE_PATH
);

318 
	`sigÇl
(
SIGALRM
, 
®¬m_hªdËr
);

320 
»maššg
 = 
	`rc_cÚf_št
(
rh
, "login_timeout");

322 ià(!
maxŒ›s
)

323 
maxŒ›s
 = 
	`rc_cÚf_št
(
rh
, "login_tries");

325 
Œ›s
 = 1;

326 
Œ›s
 <ğ
maxŒ›s
)

328 
	`®¬m
(
»maššg
);

330 !*
u£ºame
) {

331 
p
 = 
	`rc_g‘¡r
 (
rh
, 
SC_LOGIN
, 1);

332 ià(
p
)

333 
	`¡ºıy
(
u£ºame
, 
p
, (username));

335 
	`ex™
 (
ERROR_RC
);

337 
p
 = 
	`rc_g‘¡r
(
rh
, 
SC_PASSWORD
,0);

338 ià(
p
)

339 
	`¡ºıy
 (
·sswd
, 
p
,  (passwd));

341 
	`ex™
 (
ERROR_RC
);

343 
»maššg
 = 
	`®¬m
(0);

345 
logš_func
 = 
NULL
;

347 ià(
	`rc_cÚf_št
(
rh
, "auth_Üd”"è& 
AUTH_LOCAL_FST
)

349 
logš_func
 = 
	`auth_loÿl
(
u£ºame
, 
·sswd
);

351 ià(!
logš_func
)

352 ià(
	`rc_cÚf_št
(
rh
, "auth_Üd”"è& 
AUTH_RADIUS_SND
)

353 
logš_func
 = 
	`auth_¿dius
(
rh
, 
ş›Á_pÜt
, 
u£ºame
, 
·sswd
);

357 
logš_func
 = 
	`auth_¿dius
(
rh
, 
ş›Á_pÜt
, 
u£ºame
, 
·sswd
);

358 ià(!
logš_func
)

359 ià(
	`rc_cÚf_št
(
rh
, "auth_Üd”"è& 
AUTH_LOCAL_SND
)

360 
logš_func
 = 
	`auth_loÿl
(
u£ºame
, 
·sswd
);

363 
	`mem£t
(
·sswd
, '\0', (passwd));

365 ià(
logš_func
 !ğ
NULL
) {

366 ià(
	`logš_®lowed
(
‰y
)) {

367 (*
logš_func
)(
rh
, 
u£ºame
);

369 
	`¦“p
(1);

370 
	`ex™
 (
ERROR_RC
);

374 *
u£ºame
 = '\0';

376 ià((++
Œ›s
è<ğ
maxŒ›s
) {

377 
	`®¬m
(
»maššg
);

378 
	`¦“p
(
Œ›s
 * 2);

379 
»maššg
 = 
	`®¬m
(0);

384 
	`årštf
(
¡d”r
, 
SC_EXCEEDED
);

385 
	`¦“p
(1);

387 
	`ex™
 (
ERROR_RC
);

388 
	}
}

	@radius/example/radlogin.h

12 #iâdeà
RADLOGIN_H


13 
	#RADLOGIN_H


	)

15 (*
	tLFUNC
)(
	trc_hªdË
 *, *);

18 
LFUNC
 
	`auth_¿dius
(
rc_hªdË
 *, 
ušt32_t
, *, *);

19 
	`¿dius_logš
(
rc_hªdË
 *, *);

22 
LFUNC
 
	`auth_loÿl
(*, *);

23 
	`loÿl_logš
(
rc_hªdË
 *, *);

	@radius/example/radstatus.c

17 
	#FIX_ME_SECRET
 "fixme"

	)

19 
	grcsid
[] =

22 
	~<r_cÚfig.h
>

23 
	~<šşudes.h
>

24 
	~<ä“¿dius-ş›Á.h
>

25 
	~<·thÇmes.h
>

26 
	~<mes§ges.h
>

28 *
	g²ame
;

31 
	$u§ge
()

33 
	`årštf
(
¡d”r
,"U§ge: % [-Vh] [-à<cÚfig_fe>] [£rv”[:pÜt[:£ü‘]] ...\n\n", 
²ame
);

34 
	`årštf
(
¡d”r
," -V output version information\n");

35 
	`årštf
(
¡d”r
," -h outputhisext\n");

36 
	`årštf
(
¡d”r
," -f filename of‡lternate config file\n");

37 
	`ex™
(
ERROR_RC
);

38 
	}
}

40 
	$v”siÚ
()

42 
	`årštf
(
¡d”r
,"%s: %s\n", 
²ame
 ,
rcsid
);

43 
	`ex™
(
ERROR_RC
);

44 
	}
}

46 
	$maš
 (
¬gc
, **
¬gv
)

48 
»suÉ
 = 
ERROR_RC
;

49 
c
,
i
;

50 *
p
, 
msg
[4096];

51 
SERVER
 *
¤v
;

52 *
·th_¿diusş›Á_cÚf
 = 
RC_CONFIG_FILE
;

53 
rc_hªdË
 *
rh
;

55 
İtšd
;

57 
²ame
 = (²amğ
	`¡¼chr
(
¬gv
[0],'/'))?pname+1:argv[0];

59 
	`rc_İ’log
(
²ame
);

61 (
c
 = 
	`g‘İt
(
¬gc
,
¬gv
,"hVf:")) > 0)

63 
c
) {

65 
·th_¿diusş›Á_cÚf
 = 
İrg
;

68 
	`v”siÚ
();

71 
	`u§ge
();

74 
	`ex™
(
ERROR_RC
);

79 
¬gc
 -ğ
İtšd
;

80 
¬gv
 +ğ
İtšd
;

82 ià((
rh
 = 
	`rc_»ad_cÚfig
(
·th_¿diusş›Á_cÚf
)è=ğ
NULL
)

83 
	`ex™
(
ERROR_RC
);

85 ià(
	`rc_»ad_diùiÚ¬y
(
rh
, 
	`rc_cÚf_¡r
(rh, "dictionary")) != 0)

86 
	`ex™
 (
ERROR_RC
);

88 ià(
¬gc
 > 0) {

89 
i
 = 0; i < 
¬gc
; i++) {

90 ià((
p
 = 
	`¡rchr
(
¬gv
[
i
], ':')è=ğ
NULL
) {

91 
»suÉ
 = 
	`rc_check
(
rh
, 
¬gv
[
i
],
FIX_ME_SECRET
,
	`rc_g‘pÜt
(
AUTH
), 
msg
);

92 } ià(!
	`¡rcmp
(
p
+1, "auth")) {

93 *
p
 = '\0';

94 
»suÉ
 = 
	`rc_check
(
rh
, 
¬gv
[
i
],
FIX_ME_SECRET
,
	`rc_g‘pÜt
(
AUTH
), 
msg
);

95 } ià(!
	`¡rcmp
(
p
+1, "acct")) {

96 *
p
 = '\0';

97 
»suÉ
 = 
	`rc_check
(
rh
, 
¬gv
[
i
],
FIX_ME_SECRET
,
	`rc_g‘pÜt
(
ACCT
), 
msg
);

99 *
p
 = '\0';

100 
»suÉ
 = 
	`rc_check
(
rh
, 
¬gv
[
i
],
FIX_ME_SECRET
,
	`©oi
(
p
+1), 
msg
);

102 ià(
»suÉ
 =ğ
OK_RC
)

103 
	`åuts
(
msg
, 
¡dout
);

105 
	`´štf
(
SC_STATUS_FAILED
);

108 
¤v
 = 
	`rc_cÚf_¤v
(
rh
, "authserver");

109 
i
=0; i<
¤v
->
max
 ; i++)

111 
»suÉ
 = 
	`rc_check
(
rh
, 
¤v
->
Çme
[
i
], srv->
£ü‘
[i], srv->
pÜt
[i], 
msg
);

112 
	`åuts
(
msg
, 
¡dout
);

115 
¤v
 = 
	`rc_cÚf_¤v
(
rh
, "acctserver");

116 
i
=0; i<
¤v
->
max
 ; i++)

118 
»suÉ
 = 
	`rc_check
(
rh
, 
¤v
->
Çme
[
i
], srv->
£ü‘
[i], srv->
pÜt
[i], 
msg
);

119 
	`åuts
(
msg
, 
¡dout
);

124 
	}
}

	@radius/src/avpair.c

17 
	~<r_cÚfig.h
>

18 
	~<šşudes.h
>

19 
	~<ä“¿dius-ş›Á.h
>

32 
VALUE_PAIR
 *
	$rc_av·œ_add
 (cÚ¡ 
rc_hªdË
 *
rh
, 
VALUE_PAIR
 **
li¡
, 
©Œid
, *
pv®
, 
Ën
, 
v’dÜ³c
)

34 
VALUE_PAIR
 *
vp
;

36 
vp
 = 
	`rc_av·œ_Ãw
 (
rh
, 
©Œid
, 
pv®
, 
Ën
, 
v’dÜ³c
);

38 ià(
vp
 !ğ
NULL
)

40 
	`rc_av·œ_š£¹
 (
li¡
, 
NULL
, 
vp
);

43  
vp
;

45 
	}
}

57 
	$rc_av·œ_assign
 (
VALUE_PAIR
 *
vp
, *
pv®
, 
Ën
)

59 ià(!
vp
)

62 
vp
->
ty³
)

64 
PW_TYPE_STRING
:

65 ià(
Ën
 == -1)

66 
Ën
 = (
ušt32_t
)
	`¡¾’
((*)
pv®
);

67 ià(
Ën
 > 
AUTH_STRING_LEN
) {

68 
	`rc_log
(
LOG_ERR
, "rc_avpair_assign: bad‡ttribute†ength");

71 
	`memıy
(
vp
->
¡rv®ue
, (*)
pv®
, 
Ën
);

72 
vp
->
¡rv®ue
[
Ën
] = '\0';

73 
vp
->
lv®ue
 = 
Ën
;

76 
PW_TYPE_DATE
:

77 
PW_TYPE_INTEGER
:

78 
PW_TYPE_IPADDR
:

79 
vp
->
lv®ue
 = * (
ušt32_t
 *è
pv®
;

83 
	`rc_log
(
LOG_ERR
, "rc_av·œ_assign: unknowÀ©Œibu‹ %d", 
vp
->
ty³
);

87 
	}
}

98 
VALUE_PAIR
 *
	$rc_av·œ_Ãw
 (cÚ¡ 
rc_hªdË
 *
rh
, 
©Œid
, *
pv®
, 
Ën
, 
v’dÜ³c
)

100 
VALUE_PAIR
 *
vp
 = 
NULL
;

101 
DICT_ATTR
 *
pda
;

103 
©Œid
 =‡‰rid | (
v’dÜ³c
 << 16);

104 ià((
pda
 = 
	`rc_diù_g‘©Œ
 (
rh
, 
©Œid
)è=ğ
NULL
)

106 
	`rc_log
(
LOG_ERR
,"rc_av·œ_Ãw: unknowÀ©Œibu‹ %d", 
©Œid
);

107  
NULL
;

109 ià(
v’dÜ³c
 !ğ0 && 
	`rc_diù_g‘v’d
(
rh
, v’dÜ³cè=ğ
NULL
)

111 
	`rc_log
(
LOG_ERR
,"rc_av·œ_Ãw: unknowÀV’dÜ-Id %d", 
v’dÜ³c
);

112  
NULL
;

114 ià((
vp
 = 
	`m®loc
 ( (
VALUE_PAIR
))è!ğ
NULL
)

116 
	`¡ºıy
 (
vp
->
Çme
, 
pda
->name,  (vp->name));

117 
vp
->
©Œibu‹
 = 
©Œid
;

118 
vp
->
Ãxt
 = 
NULL
;

119 
vp
->
ty³
 = 
pda
->type;

120 ià(
	`rc_av·œ_assign
 (
vp
, 
pv®
, 
Ën
) == 0)

123 
vp
->
©Œibu‹
) {

124 
PW_DIGEST_REALM
:

125 
PW_DIGEST_NONCE
:

126 
PW_DIGEST_METHOD
:

127 
PW_DIGEST_URI
:

128 
PW_DIGEST_QOP
:

129 
PW_DIGEST_ALGORITHM
:

130 
PW_DIGEST_BODY_DIGEST
:

131 
PW_DIGEST_CNONCE
:

132 
PW_DIGEST_NONCE_COUNT
:

133 
PW_DIGEST_USER_NAME
:

135 ià(
vp
->
lv®ue
 > 
AUTH_STRING_LEN
 - 2)

136 
vp
->
lv®ue
 = 
AUTH_STRING_LEN
 - 2;

137 
	`memmove
(&
vp
->
¡rv®ue
[2], &vp->¡rv®ue[0], vp->
lv®ue
);

138 
vp
->
¡rv®ue
[0] = vp->
©Œibu‹
 - 
PW_DIGEST_REALM
 + 1;

139 
vp
->
lv®ue
 += 2;

140 
vp
->
¡rv®ue
[1] = vp->
lv®ue
;

141 
vp
->
¡rv®ue
[vp->
lv®ue
] = '\0';

142 
vp
->
©Œibu‹
 = 
PW_DIGEST_ATTRIBUTES
;

146  
vp
;

148 
	`ä“
 (
vp
);

149 
vp
 = 
NULL
;

153 
	`rc_log
(
LOG_CRIT
,"rc_avpair_new: out of memory");

156  
vp
;

157 
	}
}

169 
VALUE_PAIR
 *

170 
	$rc_av·œ_g’
(cÚ¡ 
rc_hªdË
 *
rh
, 
VALUE_PAIR
 *
·œ
, *
±r
,

171 
Ëngth
, 
v’dÜ³c
)

173 
©Œibu‹
, 
©ŒËn
, 
x_Ën
;

174 *
x_±r
;

175 
ušt32_t
 
lv®ue
;

176 
DICT_ATTR
 *
©Œ
;

177 
VALUE_PAIR
 *
½aœ
;

178 
bufãr
[(
AUTH_STRING_LEN
 * 2) + 1];

180 
hex
[3];

182 ià(
Ëngth
 < 2) {

183 
	`rc_log
(
LOG_ERR
, "rc_avpair_gen:„eceived‡ttribute with "

185 
sh™h­³ns
;

187 
©ŒËn
 = 
±r
[1];

188 ià(
Ëngth
 < 
©ŒËn
 ||‡ttrlen < 2) {

189 
	`rc_log
(
LOG_ERR
, "rc_avpair_gen:„eceived‡ttribute with "

191 
sh™h­³ns
;

195 ià(
Ëngth
 !ğ
©ŒËn
) {

196 
·œ
 = 
	`rc_av·œ_g’
(
rh
,…aœ, 
±r
 + 
©ŒËn
, 
Ëngth
 -‡ttrlen,

197 
v’dÜ³c
);

198 ià(
·œ
 =ğ
NULL
)

199  
NULL
;

203 
©Œibu‹
 = 
±r
[0] | (
v’dÜ³c
 << 16);

204 
±r
 += 2;

205 
©ŒËn
 -= 2;

208 ià(
©Œibu‹
 =ğ
PW_VENDOR_SPECIFIC
) {

209 ià(
©ŒËn
 < 4) {

210 
	`rc_log
(
LOG_ERR
, "rc_avpair_gen:„eceived VSA "

212 
sh™h­³ns
;

214 
	`memıy
(&
lv®ue
, 
±r
, 4);

215 
v’dÜ³c
 = 
	`Áohl
(
lv®ue
);

216 ià(
	`rc_diù_g‘v’d
(
rh
, 
v’dÜ³c
è=ğ
NULL
) {

218 
	`rc_log
(
LOG_WARNING
, "rc_avpair_gen:„eceived VSA "

219 "©Œibu‹ w™h unknowÀV’dÜ-Id %d", 
v’dÜ³c
);

220  
·œ
;

223  
	`rc_av·œ_g’
(
rh
, 
·œ
, 
±r
 + 4, 
©ŒËn
 - 4,

224 
v’dÜ³c
);

228 
©Œ
 = 
	`rc_diù_g‘©Œ
(
rh
, 
©Œibu‹
);

229 ià(
©Œ
 =ğ
NULL
) {

230 
bufãr
[0] = '\0';

231 
x_±r
 = 
±r
;

232 
x_Ën
 = 
©ŒËn
; x_ËÀ> 0; x_Ën--, 
x_±r
++) {

233 
	`¥rštf
(
hex
, "%2.2X", 
x_±r
[0]);

234 
	`¡rÿt
(
bufãr
, 
hex
);

236 ià(
v’dÜ³c
 == 0) {

237 
	`rc_log
(
LOG_WARNING
, "rc_avpair_gen:„eceived "

239 
©Œibu‹
, 
©ŒËn
 + 2, 
bufãr
);

241 
	`rc_log
(
LOG_WARNING
, "rc_avpair_gen:„eceived "

243 "Ëngth %d: 0x%s", 
©Œibu‹
 & 0xffff,

244 
	`VENDOR
(
©Œibu‹
), 
©ŒËn
 + 2, 
bufãr
);

246 
sh™h­³ns
;

249 
½aœ
 = 
	`m®loc
((*rpair));

250 ià(
½aœ
 =ğ
NULL
) {

251 
	`rc_log
(
LOG_CRIT
, "rc_avpair_gen: out of memory");

252 
sh™h­³ns
;

254 
	`mem£t
(
½aœ
, '\0', (*rpair));

257 
½aœ
->
Ãxt
 = 
·œ
;

258 
·œ
 = 
½aœ
;

259 
	`¡rıy
(
·œ
->
Çme
, 
©Œ
->name);

260 
·œ
->
©Œibu‹
 = 
©Œ
->
v®ue
;

261 
·œ
->
ty³
 = 
©Œ
->type;

263 
©Œ
->
ty³
) {

264 
PW_TYPE_STRING
:

265 
	`memıy
(
·œ
->
¡rv®ue
, (*)
±r
, (
size_t
)
©ŒËn
);

266 
·œ
->
¡rv®ue
[
©ŒËn
] = '\0';

267 
·œ
->
lv®ue
 = 
©ŒËn
;

270 
PW_TYPE_INTEGER
:

271 ià(
©ŒËn
 != 4) {

272 
	`rc_log
(
LOG_ERR
, "rc_avpair_gen:„eceived INT "

274 
sh™h­³ns
;

276 
PW_TYPE_IPADDR
:

277 ià(
©ŒËn
 != 4) {

278 
	`rc_log
(
LOG_ERR
, "rc_avpair_gen:„eceived IPADDR"

280 
sh™h­³ns
;

282 
	`memıy
((*)&
lv®ue
, (*)
±r
, 4);

283 
·œ
->
lv®ue
 = 
	`Áohl
(lvalue);

287 
	`rc_log
(
LOG_WARNING
, "rc_avpair_gen: %s has unknownype",

288 
©Œ
->
Çme
);

289 
sh™h­³ns
;

291  
·œ
;

293 
sh™h­³ns
:

294 
·œ
 !ğ
NULL
) {

295 
½aœ
 = 
·œ
->
Ãxt
;

296 
	`ä“
(
·œ
);

297 
·œ
 = 
½aœ
;

299  
NULL
;

300 
	}
}

312 
VALUE_PAIR
 *
	$rc_av·œ_g‘
 (
VALUE_PAIR
 *
vp
, 
©Œid
, 
v’dÜ³c
)

314 ; 
vp
 !ğ
NULL
 && !(
	`ATTRID
(vp->
©Œibu‹
è=ğATTRID(
©Œid
) &&

315 
	`VENDOR
(
vp
->
©Œibu‹
è=ğ
v’dÜ³c
); v°ğvp->
Ãxt
)

319  
vp
;

320 
	}
}

332 
	$rc_av·œ_š£¹
 (
VALUE_PAIR
 **
a
, VALUE_PAIR *
p
, VALUE_PAIR *
b
)

334 
VALUE_PAIR
 *
this_node
 = 
NULL
;

335 
VALUE_PAIR
 *
vp
;

337 ià(
b
->
Ãxt
 !ğ
NULL
)

339 
	`rc_log
(
LOG_CRIT
, "rc_av·œ_š£¹: v®u·œ (0x%pèÃxˆ±r. (0x%pènÙ NULL", 
b
, b->
Ãxt
);

340 
	`abÜt
 ();

343 ià(*
a
 =ğ
NULL
)

345 *
a
 = 
b
;

349 
vp
 = *
a
;

351 iàĞ
p
 =ğ
NULL
)

353 
vp
 !ğ
NULL
)

355 
this_node
 = 
vp
;

356 
vp
 = vp->
Ãxt
;

361 
this_node
 = *
a
;

362 
this_node
 !ğ
NULL
)

364 ià(
this_node
 =ğ
p
)

368 
this_node
 =his_node->
Ãxt
;

372 
b
->
Ãxt
 = 
this_node
->next;

373 
this_node
->
Ãxt
 = 
b
;

376 
	}
}

385 
	$rc_av·œ_ä“
 (
VALUE_PAIR
 *
·œ
)

387 
VALUE_PAIR
 *
Ãxt
;

389 
·œ
 !ğ
NULL
)

391 
Ãxt
 = 
·œ
->next;

392 
	`ä“
 (
·œ
);

393 
·œ
 = 
Ãxt
;

395 
	}
}

408 
	$rc_f›ldıy
(*
¡ršg
, **
u±r
, cÚ¡ *
¡İ©
, 
size_t
 
Ën
)

410 *
±r
, *
e¡ršg
;

412 
±r
 = *
u±r
;

413 
e¡ršg
 = 
¡ršg
 + 
Ën
 - 1;

414 ià(*
±r
 == '"')

416 
±r
++;

417 *
±r
 != '"' && *ptr != '\0' && *ptr != '\n')

419 ià(
¡ršg
 < 
e¡ršg
)

420 *
¡ršg
++ = *
±r
;

421 
±r
++;

423 ià(*
±r
 == '"')

425 
±r
++;

427 *
¡ršg
 = '\0';

428 *
u±r
 = 
±r
;

432 *
±r
 !ğ'\0' && 
	`¡rchr
(
¡İ©
, *±rè=ğ
NULL
)

434 ià(
¡ršg
 < 
e¡ršg
)

435 *
¡ršg
++ = *
±r
;

436 
±r
++;

438 *
¡ršg
 = '\0';

439 *
u±r
 = 
±r
;

441 
	}
}

454 
	#PARSE_MODE_NAME
 0

	)

455 
	#PARSE_MODE_EQUAL
 1

	)

456 
	#PARSE_MODE_VALUE
 2

	)

457 
	#PARSE_MODE_INVALID
 3

	)

459 
	$rc_av·œ_·r£
 (cÚ¡ 
rc_hªdË
 *
rh
, *
bufãr
, 
VALUE_PAIR
 **
fœ¡_·œ
)

461 
mode
;

462 
©Œ¡r
[
AUTH_ID_LEN
];

463 
v®¡r
[
AUTH_STRING_LEN
 + 1];

464 
DICT_ATTR
 *
©Œ
 = 
NULL
;

465 
DICT_VALUE
 *
dv®
;

466 
VALUE_PAIR
 *
·œ
;

467 
VALUE_PAIR
 *
lšk
;

468 
tm
 *tm;

469 
time_t
 
timev®
;

471 
mode
 = 
PARSE_MODE_NAME
;

472 *
bufãr
 != '\n' && *buffer != '\0')

474 ià(*
bufãr
 == ' ' || *buffer == '\t')

476 
bufãr
++;

480 
mode
)

482 
PARSE_MODE_NAME
:

483 
	`rc_f›ldıy
 (
©Œ¡r
, &
bufãr
, " \t\n=,", (attrstr));

484 ià((
©Œ
 =

485 
	`rc_diù_fšd©Œ
 (
rh
, 
©Œ¡r
)è=ğ
NULL
)

487 
	`rc_log
(
LOG_ERR
, "rc_avpair_parse: unknown‡ttribute");

488 ià(*
fœ¡_·œ
) {

489 
	`rc_av·œ_ä“
(*
fœ¡_·œ
);

490 *
fœ¡_·œ
 = 
NULL
;

494 
mode
 = 
PARSE_MODE_EQUAL
;

497 
PARSE_MODE_EQUAL
:

498 ià(*
bufãr
 == '=')

500 
mode
 = 
PARSE_MODE_VALUE
;

501 
bufãr
++;

505 
	`rc_log
(
LOG_ERR
, "rc_avpair_parse: missing or misplacedƒqual sign");

506 ià(*
fœ¡_·œ
) {

507 
	`rc_av·œ_ä“
(*
fœ¡_·œ
);

508 *
fœ¡_·œ
 = 
NULL
;

514 
PARSE_MODE_VALUE
:

515 
	`rc_f›ldıy
 (
v®¡r
, &
bufãr
, " \t\n,", (valstr));

517 ià((
·œ
 = 
	`m®loc
 ( (
VALUE_PAIR
))è=ğ
NULL
)

519 
	`rc_log
(
LOG_CRIT
, "rc_avpair_parse: out of memory");

520 ià(*
fœ¡_·œ
) {

521 
	`rc_av·œ_ä“
(*
fœ¡_·œ
);

522 *
fœ¡_·œ
 = 
NULL
;

526 
	`¡rıy
 (
·œ
->
Çme
, 
©Œ
->name);

527 
·œ
->
©Œibu‹
 = 
©Œ
->
v®ue
;

528 
·œ
->
ty³
 = 
©Œ
->type;

530 
·œ
->
ty³
)

533 
PW_TYPE_STRING
:

534 
	`¡rıy
 (
·œ
->
¡rv®ue
, 
v®¡r
);

535 
·œ
->
lv®ue
 = (
ušt32_t
)
	`¡¾’
(
v®¡r
);

538 
PW_TYPE_INTEGER
:

539 ià(
	`isdig™
 (*
v®¡r
))

541 
·œ
->
lv®ue
 = 
	`©oi
 (
v®¡r
);

545 ià((
dv®
 = 
	`rc_diù_fšdv®
 (
rh
, 
v®¡r
))

546 =ğ
NULL
)

548 
	`rc_log
(
LOG_ERR
, "rc_av·œ_·r£: unknowÀ©Œibu‹ v®ue: %s", 
v®¡r
);

549 ià(*
fœ¡_·œ
) {

550 
	`rc_av·œ_ä“
(*
fœ¡_·œ
);

551 *
fœ¡_·œ
 = 
NULL
;

553 
	`ä“
 (
·œ
);

558 
·œ
->
lv®ue
 = 
dv®
->
v®ue
;

563 
PW_TYPE_IPADDR
:

564 
·œ
->
lv®ue
 = 
	`rc_g‘_addr
(
v®¡r
);

567 
PW_TYPE_DATE
:

568 
timev®
 = 
	`time
 (0);

569 
tm
 = 
	`loÿÉime
 (&
timev®
);

570 
tm
->
tm_hour
 = 0;

571 
tm
->
tm_mš
 = 0;

572 
tm
->
tm_£c
 = 0;

573 
	`rc_¡r2tm
 (
v®¡r
, 
tm
);

574 #ifdeà
TIMELOCAL


575 
·œ
->
lv®ue
 = (
ušt32_t
è
	`tim–oÿl
 (
tm
);

577 
·œ
->
lv®ue
 = (
ušt32_t
è
	`mktime
 (
tm
);

582 
	`rc_log
(
LOG_ERR
, "rc_av·œ_·r£: unknowÀ©Œibu‹y³ %d", 
·œ
->
ty³
);

583 ià(*
fœ¡_·œ
) {

584 
	`rc_av·œ_ä“
(*
fœ¡_·œ
);

585 *
fœ¡_·œ
 = 
NULL
;

587 
	`ä“
 (
·œ
);

592 
·œ
->
©Œibu‹
) {

593 
PW_DIGEST_REALM
:

594 
PW_DIGEST_NONCE
:

595 
PW_DIGEST_METHOD
:

596 
PW_DIGEST_URI
:

597 
PW_DIGEST_QOP
:

598 
PW_DIGEST_ALGORITHM
:

599 
PW_DIGEST_BODY_DIGEST
:

600 
PW_DIGEST_CNONCE
:

601 
PW_DIGEST_NONCE_COUNT
:

602 
PW_DIGEST_USER_NAME
:

604 ià(
·œ
->
lv®ue
 > 
AUTH_STRING_LEN
 - 2)

605 
·œ
->
lv®ue
 = 
AUTH_STRING_LEN
 - 2;

606 
	`memmove
(&
·œ
->
¡rv®ue
[2], &·œ->¡rv®ue[0],…aœ->
lv®ue
);

607 
·œ
->
¡rv®ue
[0] =…aœ->
©Œibu‹
 - 
PW_DIGEST_REALM
 + 1;

608 
·œ
->
lv®ue
 += 2;

609 
·œ
->
¡rv®ue
[1] =…aœ->
lv®ue
;

610 
·œ
->
¡rv®ue
[·œ->
lv®ue
] = '\0';

611 
·œ
->
©Œibu‹
 = 
PW_DIGEST_ATTRIBUTES
;

614 
·œ
->
Ãxt
 = 
NULL
;

616 ià(*
fœ¡_·œ
 =ğ
NULL
)

618 *
fœ¡_·œ
 = 
·œ
;

622 
lšk
 = *
fœ¡_·œ
;

623 
lšk
->
Ãxt
 !ğ
NULL
)

625 
lšk
 =†šk->
Ãxt
;

627 
lšk
->
Ãxt
 = 
·œ
;

630 
mode
 = 
PARSE_MODE_NAME
;

634 
mode
 = 
PARSE_MODE_NAME
;

639 
	}
}

650 
	$rc_av·œ_to¡r
 (cÚ¡ 
rc_hªdË
 *
rh
, 
VALUE_PAIR
 *
·œ
, *
Çme
, 
Ê
, *
v®ue
, 
lv
)

652 
DICT_VALUE
 *
dv®
;

653 
bufãr
[32];

654 
š_addr
 
šad
;

655 *
±r
;

657 *
Çme
 = *
v®ue
 = '\0';

659 ià(!
·œ
 ||…aœ->
Çme
[0] == '\0') {

660 
	`rc_log
(
LOG_ERR
, "rc_avpair_tostr:…air is NULL orƒmpty");

664 
	`¡ºıy
(
Çme
, 
·œ
->Çme, (
size_t
è
Ê
);

666 
·œ
->
ty³
)

668 
PW_TYPE_STRING
:

669 
lv
--;

670 
±r
 = (*è
·œ
->
¡rv®ue
;

671 ià(
·œ
->
©Œibu‹
 =ğ
PW_DIGEST_ATTRIBUTES
) {

672 
·œ
->
¡rv®ue
[*(
±r
 + 1)] = '\0';

673 
±r
 += 2;

675 *
±r
 != '\0')

677 ià(!(
	`i¥ršt
 (*
±r
)))

679 
	`¥rštf
 (
bufãr
, "\\%03o", *
±r
);

680 
	`¡ºÿt
(
v®ue
, 
bufãr
, (
size_t
è
lv
);

681 
lv
 -= 4;

682 ià(
lv
 < 0) ;

686 
	`¡ºÿt
(
v®ue
, (*)
±r
, 1);

687 
lv
--;

688 ià(
lv
 < 0) ;

690 
±r
++;

694 
PW_TYPE_INTEGER
:

695 
dv®
 = 
	`rc_diù_g‘v®
 (
rh
, 
·œ
->
lv®ue
,…aœ->
Çme
);

696 ià(
dv®
 !ğ
NULL
)

698 
	`¡ºıy
(
v®ue
, 
dv®
->
Çme
, (
size_t
è
lv
-1);

702 
	`¥rštf
 (
bufãr
, "%ld", ()
·œ
->
lv®ue
);

703 
	`¡ºıy
(
v®ue
, 
bufãr
, (
size_t
è
lv
);

707 
PW_TYPE_IPADDR
:

708 
šad
.
s_addr
 = 
	`htÚl
(
·œ
->
lv®ue
);

709 
	`¡ºıy
 (
v®ue
, 
	`š‘_Áß
 (
šad
), (
size_t
è
lv
-1);

712 
PW_TYPE_DATE
:

713 
	`¡ráime
 (
bufãr
,  (buffer), "%m/%d/%y %H:%M:%S",

714 
	`gmtime
 ((
time_t
 *è& 
·œ
->
lv®ue
));

715 
	`¡ºıy
(
v®ue
, 
bufãr
, 
lv
-1);

719 
	`rc_log
(
LOG_ERR
, "rc_av·œ_to¡r: unknowÀ©Œibu‹y³ %d", 
·œ
->
ty³
);

725 
	}
}

737 
	$rc_av·œ_log
(
rc_hªdË
 *
rh
, 
VALUE_PAIR
 *
·œ
)

739 
size_t
 
Ën
, 
Æ’
;

740 
VALUE_PAIR
 *
vp
;

741 
Çme
[33], 
v®ue
[256];

742 *
ı
;

744 
Ën
 = 0;

745 
vp
 = 
·œ
; v°!ğ
NULL
; v°ğvp->
Ãxt
) {

746 ià(
	`rc_av·œ_to¡r
(
rh
, 
vp
, 
Çme
, Òame), 
v®ue
,

747 (
v®ue
)) == -1)

748  
NULL
;

749 
Æ’
 = 
Ën
 + 32 + 3 + 
	`¡¾’
(
v®ue
) + 2 + 2;

750 
ı
 = 
	`»®loc
(
rh
->
µbuf
, 
Æ’
);

751 ià(
ı
 =ğ
NULL
) {

752 
	`rc_log
(
LOG_ERR
, "rc_avpair_log: can't‡llocate memory");

753  
NULL
;

755 
	`¥rštf
(
ı
 + 
Ën
, "%-32 ğ'%s'\n", 
Çme
, 
v®ue
);

756 
rh
->
µbuf
 = 
ı
;

757 
Ën
 = 
Æ’
 - 1;

759  (
Ën
 > 0è? 
rh
->
µbuf
 : 
NULL
;

760 
	}
}

770 
VALUE_PAIR
 *
	$rc_av·œ_»adš
(cÚ¡ 
rc_hªdË
 *
rh
, 
FILE
 *
šput
)

772 
VALUE_PAIR
 *
vp
 = 
NULL
;

773 
bufãr
[1024], *
q
;

775 
	`fg‘s
(
bufãr
, (bufãr), 
šput
è!ğ
NULL
)

777 
q
 = 
bufãr
;

779 *
q
 && 
	`is¥aû
(*q)) q++;

781 ià((*
q
 == '\n') || (*q == '#') || (*q == '\0'))

784 ià(
	`rc_av·œ_·r£
(
rh
, 
q
, &
vp
) < 0) {

785 
	`rc_log
(
LOG_ERR
, "rc_av·œ_»adš: m®fÜmed‡‰ribu‹: %s", 
bufãr
);

786 
	`rc_av·œ_ä“
(
vp
);

787  
NULL
;

791  
vp
;

792 
	}
}

	@radius/src/buildreq.c

12 
	~<r_cÚfig.h
>

13 
	~<šşudes.h
>

14 
	~<ä“¿dius-ş›Á.h
>

16 
rc_g‘_£qnbr
(
rc_hªdË
 *);

26 
	$rc_bud»q
(
rc_hªdË
 *
rh
, 
SEND_DATA
 *
d©a
, 
code
, *
£rv”
, 
pÜt
,

27 *
£ü‘
, 
timeout
, 
»Œ›s
)

29 
d©a
->
£rv”
 = server;

30 
d©a
->
£ü‘
 = secret;

31 
d©a
->
svc_pÜt
 = 
pÜt
;

32 
d©a
->
£q_nbr
 = 
	`rc_g‘_£qnbr
(
rh
);

33 
d©a
->
timeout
 =imeout;

34 
d©a
->
»Œ›s
 =„etries;

35 
d©a
->
code
 = code;

36 
	}
}

45 
	$rc_guess_£qnbr
()

47 
	`¤ªdom
(()(
	`time
(
NULL
)+
	`g‘pid
()));

48  ()(
	`¿ndom
(è& 
UCHAR_MAX
);

49 
	}
}

58 
	$rc_g‘_£qnbr
(
rc_hªdË
 *
rh
)

60 
FILE
 *
sf
;

61 
Œ›s
 = 1;

62 
£q_nbr
;

63 *
£qfe
 = 
	`rc_cÚf_¡r
(
rh
, "seqfile");

65 ià((
sf
 = 
	`fİ’
(
£qfe
, "a+")è=ğ
NULL
)

67 
	`rc_log
(
LOG_ERR
,"rc_g‘_£qnbr: couldn'ˆİ’ sequ’û f%s: %s", 
£qfe
, 
	`¡»¼Ü
(
”ºo
));

69  
	`rc_guess_£qnbr
();

72 
	`do_lock_exşusive
(
sf
)!= 0)

74 ià(
”ºo
 !ğ
EWOULDBLOCK
) {

75 
	`rc_log
(
LOG_ERR
, "rc_g‘_£qnbr: flock fau»: %s: %s", 
£qfe
, 
	`¡»¼Ü
(
”ºo
));

76 
	`fşo£
(
sf
);

77  
	`rc_guess_£qnbr
();

79 
Œ›s
++;

80 ià(
Œ›s
 <= 10)

81 
	`rc_md–ay
(500);

86 ià(
Œ›s
 > 10) {

87 
	`rc_log
(
LOG_ERR
,"rc_g‘_£qnbr: couldn'ˆg‘†ock‡á” %dr›s: %s", 
Œ›s
-1, 
£qfe
);

88 
	`fşo£
(
sf
);

89  
	`rc_guess_£qnbr
();

92 
	`»wšd
(
sf
);

93 ià(
	`fsÿnf
(
sf
, "%d", &
£q_nbr
) != 1) {

94 
	`rc_log
(
LOG_ERR
,"rc_g‘_£qnbr: fsÿnàçu»: %s", 
£qfe
);

95 
£q_nbr
 = 
	`rc_guess_£qnbr
();

98 
	`»wšd
(
sf
);

99 
	`árunÿ‹
(
	`f’o
(
sf
),0);

100 
	`årštf
(
sf
,"%d\n", (
£q_nbr
+1è& 
UCHAR_MAX
);

102 
	`fæush
(
sf
);

104 ià(
	`do_uÆock
(
sf
) != 0)

105 
	`rc_log
(
LOG_ERR
, "rc_g‘_£qnbr: couldn'ˆ»Ëa£†ock oÀ%s: %s", 
£qfe
, 
	`¡»¼Ü
(
”ºo
));

107 
	`fşo£
(
sf
);

109  ()
£q_nbr
;

110 
	}
}

123 
	$rc_¯a
(
rc_hªdË
 *
rh
, 
ušt32_t
 
ş›Á_pÜt
, 
VALUE_PAIR
 *
£nd
, VALUE_PAIR **
»ûived
,

124 *
msg
, 
add_Çs_pÜt
, 
»que¡_ty³
)

126 
SEND_DATA
 
d©a
;

127 
VALUE_PAIR
 *
adt_vp
 = 
NULL
;

128 
»suÉ
;

129 
i
, 
sk_couÁ
;

130 
SERVER
 *
¯a£rv”
;

131 
timeout
 = 
	`rc_cÚf_št
(
rh
, "radius_timeout");

132 
»Œ›s
 = 
	`rc_cÚf_št
(
rh
, "radius_retries");

133 
¿dius_d—dtime
 = 
	`rc_cÚf_št
(
rh
, "radius_deadtime");

134 
¡¬t_time
;

135 
time_t
 
dtime
;

137 ià(
»que¡_ty³
 !ğ
PW_ACCOUNTING_REQUEST
) {

138 
¯a£rv”
 = 
	`rc_cÚf_¤v
(
rh
, "authserver");

140 
¯a£rv”
 = 
	`rc_cÚf_¤v
(
rh
, "acctserver");

142 ià(
¯a£rv”
 =ğ
NULL
)

143  
ERROR_RC
;

145 
d©a
.
£nd_·œs
 = 
£nd
;

146 
d©a
.
»ûive_·œs
 = 
NULL
;

148 ià(
add_Çs_pÜt
 != 0) {

152 ià(
	`rc_av·œ_add
(
rh
, &(
d©a
.
£nd_·œs
), 
PW_NAS_PORT
,

153 &
ş›Á_pÜt
, 0, 0è=ğ
NULL
)

154  
ERROR_RC
;

157 ià(
»que¡_ty³
 =ğ
PW_ACCOUNTING_REQUEST
) {

161 
dtime
 = 0;

162 ià((
adt_vp
 = 
	`rc_av·œ_add
(
rh
, &(
d©a
.
£nd_·œs
),

163 
PW_ACCT_DELAY_TIME
, &
dtime
, 0, 0)è=ğ
NULL
)

164  
ERROR_RC
;

167 
¡¬t_time
 = 
	`rc_g‘ùime
();

168 
sk_couÁ
 = 0;

169 
»suÉ
 = 
ERROR_RC
;

170 
i
=0; (˜< 
¯a£rv”
->
max
è&& (
»suÉ
 !ğ
OK_RC
è&& (»suÉ !ğ
BADRESP_RC
)

171 ; 
i
++)

173 ià(
¯a£rv”
->
d—dtime_’ds
[
i
] != -1 &&

174 
¯a£rv”
->
d—dtime_’ds
[
i
] > 
¡¬t_time
) {

175 
sk_couÁ
++;

178 ià(
d©a
.
»ûive_·œs
 !ğ
NULL
) {

179 
	`rc_av·œ_ä“
(
d©a
.
»ûive_·œs
);

180 
d©a
.
»ûive_·œs
 = 
NULL
;

182 
	`rc_bud»q
(
rh
, &
d©a
, 
»que¡_ty³
, 
¯a£rv”
->
Çme
[
i
],

183 
¯a£rv”
->
pÜt
[
i
],‡¯£rv”->
£ü‘
[i], 
timeout
, 
»Œ›s
);

185 ià(
»que¡_ty³
 =ğ
PW_ACCOUNTING_REQUEST
) {

186 
dtime
 = 
	`rc_g‘ùime
(è- 
¡¬t_time
;

187 
	`rc_av·œ_assign
(
adt_vp
, &
dtime
, 0);

190 
»suÉ
 = 
	`rc_£nd_£rv”
 (
rh
, &
d©a
, 
msg
);

191 ià(
»suÉ
 =ğ
TIMEOUT_RC
 && 
¿dius_d—dtime
 > 0)

192 
¯a£rv”
->
d—dtime_’ds
[
i
] = 
¡¬t_time
 + ()
¿dius_d—dtime
;

194 ià(
»suÉ
 =ğ
OK_RC
 ||„esuÉ =ğ
BADRESP_RC
 || 
sk_couÁ
 == 0)

195 
ex™
;

197 
»suÉ
 = 
ERROR_RC
;

198 
i
=0; (˜< 
¯a£rv”
->
max
è&& (
»suÉ
 !ğ
OK_RC
è&& (»suÉ !ğ
BADRESP_RC
)

199 ; 
i
++)

201 ià(
¯a£rv”
->
d—dtime_’ds
[
i
] == -1 ||

202 
¯a£rv”
->
d—dtime_’ds
[
i
] <ğ
¡¬t_time
) {

205 ià(
d©a
.
»ûive_·œs
 !ğ
NULL
) {

206 
	`rc_av·œ_ä“
(
d©a
.
»ûive_·œs
);

207 
d©a
.
»ûive_·œs
 = 
NULL
;

209 
	`rc_bud»q
(
rh
, &
d©a
, 
»que¡_ty³
, 
¯a£rv”
->
Çme
[
i
],

210 
¯a£rv”
->
pÜt
[
i
],‡¯£rv”->
£ü‘
[i], 
timeout
, 
»Œ›s
);

212 ià(
»que¡_ty³
 =ğ
PW_ACCOUNTING_REQUEST
) {

213 
dtime
 = 
	`rc_g‘ùime
(è- 
¡¬t_time
;

214 
	`rc_av·œ_assign
(
adt_vp
, &
dtime
, 0);

217 
»suÉ
 = 
	`rc_£nd_£rv”
 (
rh
, &
d©a
, 
msg
);

218 ià(
»suÉ
 !ğ
TIMEOUT_RC
)

219 
¯a£rv”
->
d—dtime_’ds
[
i
] = -1;

222 
ex™
:

223 ià(
»que¡_ty³
 !ğ
PW_ACCOUNTING_REQUEST
) {

224 *
»ûived
 = 
d©a
.
»ûive_·œs
;

226 
	`rc_av·œ_ä“
(
d©a
.
»ûive_·œs
);

229  
»suÉ
;

230 
	}
}

243 
	$rc_auth
(
rc_hªdË
 *
rh
, 
ušt32_t
 
ş›Á_pÜt
, 
VALUE_PAIR
 *
£nd
, VALUE_PAIR **
»ûived
,

244 *
msg
)

247  
	`rc_¯a
(
rh
, 
ş›Á_pÜt
, 
£nd
, 
»ûived
, 
msg
, 1, 
PW_ACCESS_REQUEST
);

248 
	}
}

263 
	$rc_auth_´oxy
(
rc_hªdË
 *
rh
, 
VALUE_PAIR
 *
£nd
, VALUE_PAIR **
»ûived
, *
msg
)

266  
	`rc_¯a
(
rh
, 0, 
£nd
, 
»ûived
, 
msg
, 0, 
PW_ACCESS_REQUEST
);

267 
	}
}

280 
	$rc_acù
(
rc_hªdË
 *
rh
, 
ušt32_t
 
ş›Á_pÜt
, 
VALUE_PAIR
 *
£nd
)

282 
msg
[4096];

284  
	`rc_¯a
(
rh
, 
ş›Á_pÜt
, 
£nd
, 
NULL
, 
msg
, 1, 
PW_ACCOUNTING_REQUEST
);

285 
	}
}

294 
	$rc_acù_´oxy
(
rc_hªdË
 *
rh
, 
VALUE_PAIR
 *
£nd
)

296 
msg
[4096];

298  
	`rc_¯a
(
rh
, 0, 
£nd
, 
NULL
, 
msg
, 0, 
PW_ACCOUNTING_REQUEST
);

299 
	}
}

309 
	$rc_check
(
rc_hªdË
 *
rh
, *
ho¡
, *
£ü‘
, 
pÜt
, *
msg
)

311 
SEND_DATA
 
d©a
;

312 
»suÉ
;

313 
ušt32_t
 
£rviû_ty³
;

314 
timeout
 = 
	`rc_cÚf_št
(
rh
, "radius_timeout");

315 
»Œ›s
 = 
	`rc_cÚf_št
(
rh
, "radius_retries");

317 
d©a
.
£nd_·œs
 = d©a.
»ûive_·œs
 = 
NULL
;

323 
£rviû_ty³
 = 
PW_ADMINISTRATIVE
;

324 
	`rc_av·œ_add
(
rh
, &(
d©a
.
£nd_·œs
), 
PW_SERVICE_TYPE
, &
£rviû_ty³
, 0, 0);

326 
	`rc_bud»q
(
rh
, &
d©a
, 
PW_STATUS_SERVER
, 
ho¡
, 
pÜt
, 
£ü‘
, 
timeout
, 
»Œ›s
);

327 
»suÉ
 = 
	`rc_£nd_£rv”
 (
rh
, &
d©a
, 
msg
);

329 
	`rc_av·œ_ä“
(
d©a
.
»ûive_·œs
);

331  
»suÉ
;

332 
	}
}

	@radius/src/clientid.c

12 
	~<r_cÚfig.h
>

13 
	~<šşudes.h
>

14 
	~<ä“¿dius-ş›Á.h
>

16 
	sm­2id_s
 {

17 *
	mÇme
;

18 
ušt32_t
 
	mid
;

20 
m­2id_s
 *
	mÃxt
;

33 
	$rc_»ad_m­fe
(
rc_hªdË
 *
rh
, *
f’ame
)

35 
bufãr
[1024];

36 
FILE
 *
m­fd
;

37 *
c
, *
Çme
, *
id
, *
q
;

38 
m­2id_s
 *
p
;

39 
Êr
 = 0;

41 ià((
m­fd
 = 
	`fİ’
(
f’ame
,"r")è=ğ
NULL
)

43 
	`rc_log
(
LOG_ERR
,"rc_»ad_m­fe: cª'ˆ»ad %s: %s", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

47 
	#SKIP
(
p
è*°&& 
	`is¥aû
(*p)èp++;

	)

49 
	`fg‘s
(
bufãr
, (bufãr), 
m­fd
è!ğ
NULL
)

51 
Êr
++;

53 
q
 = 
bufãr
;

55 
	`SKIP
(
q
);

57 ià((*
q
 == '\n') || (*q == '#') || (*q == '\0'))

60 ià(Ğ
c
 = 
	`¡rchr
(
q
, ' ')) || (c = strchr(q,'\t'))) {

62 *
c
 = '\0'; c++;

63 
	`SKIP
(
c
);

65 
Çme
 = 
q
;

66 
id
 = 
c
;

68 ià((
p
 = (
m­2id_s
 *)
	`m®loc
((*p))è=ğ
NULL
) {

69 
	`rc_log
(
LOG_CRIT
,"rc_read_mapfile: out of memory");

70 
	`fşo£
(
m­fd
);

74 
p
->
Çme
 = 
	`¡rdup
(name);

75 
p
->
id
 = 
	`©oi
(id);

76 
p
->
Ãxt
 = 
rh
->
m­2id_li¡
;

77 
rh
->
m­2id_li¡
 = 
p
;

81 
	`rc_log
(
LOG_ERR
, "rc_»ad_m­fe: m®fÜmed†šš %s,†š%d", 
f’ame
, 
Êr
);

82 
	`fşo£
(
m­fd
);

88 #undeà
SKIP


90 
	`fşo£
(
m­fd
);

93 
	}
}

105 
ušt32_t
 
	$rc_m­2id
(
rc_hªdË
 *
rh
, *
Çme
)

107 
m­2id_s
 *
p
;

108 
‰yÇme
[
PATH_MAX
];

110 *
‰yÇme
 = '\0';

111 ià(*
Çme
 != '/')

112 
	`¡rıy
(
‰yÇme
, "/dev/");

114 
	`¡ºÿt
(
‰yÇme
, 
Çme
, ÑtyÇme)-
	`¡¾’
(ttyname)-1);

116 
p
 = 
rh
->
m­2id_li¡
;…;… =…->
Ãxt
)

117 ià(!
	`¡rcmp
(
‰yÇme
, 
p
->
Çme
)è…->
id
;

119 
	`rc_log
(
LOG_WARNING
,"rc_m­2id: cª'ˆfšdty % š m­ d©aba£", 
‰yÇme
);

122 
	}
}

133 
	$rc_m­2id_ä“
(
rc_hªdË
 *
rh
)

135 
m­2id_s
 *
p
, *
Å
;

137 ià(
rh
->
m­2id_li¡
 =ğ
NULL
)

140 
p
 = 
rh
->
m­2id_li¡
;… !ğ
NULL
;… = 
Å
) {

141 
Å
 = 
p
->
Ãxt
;

142 
	`ä“
(
p
->
Çme
);

143 
	`ä“
(
p
);

145 
rh
->
m­2id_li¡
 = 
NULL
;

146 
	}
}

	@radius/src/config.c

17 
	~<r_cÚfig.h
>

18 
	~<šşudes.h
>

19 
	~<ä“¿dius-ş›Á.h
>

20 
	~<İtiÚs.h
>

30 
OPTION
 *
	$fšd_İtiÚ
(
rc_hªdË
 *
rh
, cÚ¡ *
İŠame
, 
ty³
)

32 
i
;

35 
i
 = 0; i < 
NUM_OPTIONS
; i++) {

36 ià(!
	`¡rcmp
(
rh
->
cÚfig_İtiÚs
[
i
].
Çme
, 
İŠame
) &&

37 (
rh
->
cÚfig_İtiÚs
[
i
].
ty³
 &ype))

39  &
rh
->
cÚfig_İtiÚs
[
i
];

43  
NULL
;

44 
	}
}

54 
	$£t_İtiÚ_¡r
(cÚ¡ *
f’ame
, 
lše
, 
OPTION
 *
İtiÚ
, cÚ¡ *
p
)

56 ià(
p
) {

57 
İtiÚ
->
v®
 = (*è
	`¡rdup
(
p
);

58 ià(
İtiÚ
->
v®
 =ğ
NULL
) {

59 
	`rc_log
(
LOG_CRIT
, "read_config: out of memory");

63 
İtiÚ
->
v®
 = 
NULL
;

67 
	}
}

69 
	$£t_İtiÚ_št
(cÚ¡ *
f’ame
, 
lše
, 
OPTION
 *
İtiÚ
, cÚ¡ *
p
)

71 *
Œ
;

73 ià(
p
 =ğ
NULL
) {

74 
	`rc_log
(
LOG_ERR
, "%s:†š%d: bogu İtiÚ v®ue", 
f’ame
, 
lše
);

78 ià((
Œ
 = 
	`m®loc
((*Œ))è=ğ
NULL
) {

79 
	`rc_log
(
LOG_CRIT
, "read_config: out of memory");

83 *
Œ
 = 
	`©oi
(
p
);

84 
İtiÚ
->
v®
 = (*è
Œ
;

87 
	}
}

89 
	$£t_İtiÚ_¤v
(cÚ¡ *
f’ame
, 
lše
, 
OPTION
 *
İtiÚ
, cÚ¡ *
p
)

91 
SERVER
 *
£rv
;

92 *
p_poš‹r
;

93 *
p_du³
;

94 *
p_§ve
;

95 *
q
;

96 *
s
;

97 
£rv’t
 *
svp
;

99 
p_du³
 = 
	`¡rdup
(
p
);

101 ià(
p_du³
 =ğ
NULL
) {

102 
	`rc_log
(
LOG_ERR
, "%s:†š%d: Inv®id o±iÚ o¸memÜy fau»", 
f’ame
, 
lše
);

106 
£rv
 = (
SERVER
 *è
İtiÚ
->
v®
;

107 ià(
£rv
 =ğ
NULL
) {

108 
	`rc_log
(
LOG_ERR
, "option->val / server is NULL,‡llocating memory");

109 
£rv
 = 
	`m®loc
((*serv));

110 ià(
£rv
 =ğ
NULL
) {

111 
	`rc_log
(
LOG_CRIT
, "read_config: out of memory");

112 
	`ä“
(
p_du³
);

115 
£rv
->
max
 = 0;

118 
p_poš‹r
 = 
	`¡¹ok_r
(
p_du³
, ", \t", &
p_§ve
);

121 ià((
q
 = 
	`¡rchr
(
p_poš‹r
,':')è!ğ
NULL
) {

122 *
q
 = '\0';

123 
q
++;

126 if((
s
 = 
	`¡rchr
(
q
,':')è!ğ
NULL
) {

127 *
s
 = '\0';

128 
s
++;

129 
£rv
->
£ü‘
[£rv->
max
] = 
	`¡rdup
(
s
);

130 ià(
£rv
->
£ü‘
[£rv->
max
] =ğ
NULL
) {

131 
	`rc_log
(
LOG_CRIT
, "read_config: out of memory");

132 ià(
İtiÚ
->
v®
 =ğ
NULL
) {

133 
	`ä“
(
p_du³
);

134 
	`ä“
(
£rv
);

140 if(
q
 && 
	`¡¾’
(q) > 0) {

141 
£rv
->
pÜt
[£rv->
max
] = 
	`©oi
(
q
);

143 ià(!
	`¡rcmp
(
İtiÚ
->
Çme
,"authserver"))

144 ià((
svp
 = 
	`g‘£rvbyÇme
 ("¿dius", "udp")è=ğ
NULL
)

145 
£rv
->
pÜt
[£rv->
max
] = 
PW_AUTH_UDP_PORT
;

147 
£rv
->
pÜt
[£rv->
max
] = 
	`Áohs
 ((è
svp
->
s_pÜt
);

148 ià(!
	`¡rcmp
(
İtiÚ
->
Çme
, "acctserver"))

149 ià((
svp
 = 
	`g‘£rvbyÇme
 ("¿dacù", "udp")è=ğ
NULL
)

150 
£rv
->
pÜt
[£rv->
max
] = 
PW_ACCT_UDP_PORT
;

152 
£rv
->
pÜt
[£rv->
max
] = 
	`Áohs
 ((è
svp
->
s_pÜt
);

154 
	`rc_log
(
LOG_ERR
, "%s:†š%d:‚ØdeçuÉ…ÜˆfÜ %s", 
f’ame
, 
lše
, 
İtiÚ
->
Çme
);

155 ià(
İtiÚ
->
v®
 =ğ
NULL
) {

156 
	`ä“
(
p_du³
);

157 
	`ä“
(
£rv
);

163 
£rv
->
Çme
[£rv->
max
] = 
	`¡rdup
(
p_poš‹r
);

164 ià(
£rv
->
Çme
[£rv->
max
] =ğ
NULL
) {

165 
	`rc_log
(
LOG_CRIT
, "read_config: out of memory");

166 ià(
İtiÚ
->
v®
 =ğ
NULL
) {

167 
	`ä“
(
p_du³
);

168 
	`ä“
(
£rv
);

172 
	`ä“
(
p_du³
);

174 
£rv
->
d—dtime_’ds
[£rv->
max
] = -1;

175 
£rv
->
max
++;

177 ià(
İtiÚ
->
v®
 =ğ
NULL
)

178 
İtiÚ
->
v®
 = (*)
£rv
;

181 
	}
}

183 
	$£t_İtiÚ_auo
(cÚ¡ *
f’ame
, 
lše
, 
OPTION
 *
İtiÚ
, cÚ¡ *
p
)

185 *
Œ
;

186 *
p_du³
 = 
NULL
;

187 *
p_poš‹r
 = 
NULL
;

188 *
p_§ve
 = 
NULL
;

190 
p_du³
 = 
	`¡rdup
(
p
);

192 ià(
p_du³
 =ğ
NULL
) {

193 
	`rc_log
(
LOG_WARNING
, "%s:†š%d: bogu İtiÚ v®ue", 
f’ame
, 
lše
);

197 ià((
Œ
 = 
	`m®loc
((Œ))è=ğ
NULL
) {

198 
	`rc_log
(
LOG_CRIT
, "read_config: out of memory");

202 *
Œ
 = 0;

204 
p_poš‹r
 = 
	`¡¹ok_r
(
p_du³
, ", \t", &
p_§ve
);

207 ià(!
	`¡ºcmp
(
p_poš‹r
, "local", 5))

208 *
Œ
 = 
AUTH_LOCAL_FST
;

209 ià(!
	`¡ºcmp
(
p_poš‹r
, "radius", 6))

210 *
Œ
 = 
AUTH_RADIUS_FST
;

212 
	`rc_log
(
LOG_ERR
,"%s:‡uth_Üd”: unknowÀkeywÜd: %s", 
f’ame
, 
p
);

213 
	`ä“
(
p_du³
);

217 
p_poš‹r
 = 
	`¡¹ok_r
(
NULL
, ", \t", &
p_§ve
);

219 ià(
p_poš‹r
 && (*p_pointer != '\0')) {

220 ià((*
Œ
 & 
AUTH_RADIUS_FST
è&& !
	`¡rcmp
(
p_poš‹r
, "local"))

221 *
Œ
 = (*Œè| 
AUTH_LOCAL_SND
;

222 ià((*
Œ
 & 
AUTH_LOCAL_FST
è&& !
	`¡rcmp
(
p_poš‹r
, "radius"))

223 *
Œ
 = (*Œè| 
AUTH_RADIUS_SND
;

225 
	`rc_log
(
LOG_ERR
,"%s:‡uth_Üd”: unknowÀÜ uÃx³ùed keywÜd: %s", 
f’ame
, 
p
);

226 
	`ä“
(
p_du³
);

231 
İtiÚ
->
v®
 = (*è
Œ
;

233 
	`ä“
(
p_du³
);

235 
	}
}

245 
	$rc_add_cÚfig
(
rc_hªdË
 *
rh
, cÚ¡ *
İtiÚ_Çme
, cÚ¡ *
İtiÚ_v®
, cÚ¡ *
sourû
, cÚ¡ 
lše
)

247 
OPTION
 *
İtiÚ
;

249 ià((
İtiÚ
 = 
	`fšd_İtiÚ
(
rh
, 
İtiÚ_Çme
, 
OT_ANY
)è=ğ
NULL
)

251 
	`rc_log
(
LOG_ERR
, "ERROR: uÄecognized o±iÚ: %s", 
İtiÚ_Çme
);

255 ià(
İtiÚ
->
¡©us
 !ğ
ST_UNDEF
)

257 
	`rc_log
(
LOG_ERR
, "ERROR: du¶iÿ‹ o±iÚ: %s", 
İtiÚ_Çme
);

261 
İtiÚ
->
ty³
) {

262 
OT_STR
:

263 ià(
	`£t_İtiÚ_¡r
(
sourû
, 
lše
, 
İtiÚ
, 
İtiÚ_v®
) < 0) {

267 
OT_INT
:

268 ià(
	`£t_İtiÚ_št
(
sourû
, 
lše
, 
İtiÚ
, 
İtiÚ_v®
) < 0) {

272 
OT_SRV
:

273 ià(
	`£t_İtiÚ_¤v
(
sourû
, 
lše
, 
İtiÚ
, 
İtiÚ_v®
) < 0) {

277 
OT_AUO
:

278 ià(
	`£t_İtiÚ_auo
(
sourû
, 
lše
, 
İtiÚ
, 
İtiÚ_v®
) < 0) {

283 
	`rc_log
(
LOG_CRIT
, "rc_read_config: impossible case branch!");

284 
	`abÜt
();

287 
	}
}

298 
rc_hªdË
 *

299 
	$rc_cÚfig_š™
(
rc_hªdË
 *
rh
)

302 
i
;

303 
SERVER
 *
auth£rv”s
;

304 
SERVER
 *
acù£rv”s
;

307 
rh
->
cÚfig_İtiÚs
 = 
	`m®loc
((
cÚfig_İtiÚs_deçuÉ
));

308 ià(
rh
->
cÚfig_İtiÚs
 =ğ
NULL
)

310 
	`rc_log
(
LOG_CRIT
, "rc_config_init: out of memory");

311 
	`rc_de¡roy
(
rh
);

312  
NULL
;

314 
	`memıy
(
rh
->
cÚfig_İtiÚs
, &
cÚfig_İtiÚs_deçuÉ
, (config_options_default));

317 
auth£rv”s
 = 
	`rc_cÚf_¤v
(
rh
, "authserver");

318 
acù£rv”s
 = 
	`rc_cÚf_¤v
(
rh
, "acctserver");

319 
auth£rv”s
 = 
	`m®loc
((
SERVER
));

320 
acù£rv”s
 = 
	`m®loc
((
SERVER
));

322 if(
auth£rv”s
 =ğ
NULL
 || 
acù£rv”s
 == NULL)

324 
	`rc_log
(
LOG_CRIT
, "rc_config_init:ƒrror initializing server structs");

325 
	`rc_de¡roy
(
rh
);

326  
NULL
;

330 
auth£rv”s
->
max
 = 0;

331 
acù£rv”s
->
max
 = 0;

333 
i
=0; i < 
SERVER_MAX
; i++)

335 
auth£rv”s
->
Çme
[
i
] = 
NULL
;

336 
auth£rv”s
->
£ü‘
[
i
] = 
NULL
;

337 
acù£rv”s
->
Çme
[
i
] = 
NULL
;

338 
acù£rv”s
->
£ü‘
[
i
] = 
NULL
;

341  
rh
;

342 
	}
}

353 
rc_hªdË
 *

354 
	$rc_»ad_cÚfig
(*
f’ame
)

356 
FILE
 *
cÚfigfd
;

357 
bufãr
[512], *
p
;

358 
OPTION
 *
İtiÚ
;

359 
lše
;

360 
size_t
 
pos
;

361 
rc_hªdË
 *
rh
;

363 
rh
 = 
	`rc_Ãw
();

364 ià(
rh
 =ğ
NULL
)

365  
NULL
;

367 
rh
->
cÚfig_İtiÚs
 = 
	`m®loc
((
cÚfig_İtiÚs_deçuÉ
));

368 ià(
rh
->
cÚfig_İtiÚs
 =ğ
NULL
) {

369 
	`rc_log
(
LOG_CRIT
, "rc_read_config: out of memory");

370 
	`rc_de¡roy
(
rh
);

371  
NULL
;

373 
	`memıy
(
rh
->
cÚfig_İtiÚs
, &
cÚfig_İtiÚs_deçuÉ
, (config_options_default));

375 ià((
cÚfigfd
 = 
	`fİ’
(
f’ame
,"r")è=ğ
NULL
)

377 
	`rc_log
(
LOG_ERR
,"rc_»ad_cÚfig: cª'ˆİ’ %s: %s", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

378 
	`rc_de¡roy
(
rh
);

379  
NULL
;

382 
lše
 = 0;

383 (
	`fg‘s
(
bufãr
, (bufãr), 
cÚfigfd
è!ğ
NULL
))

385 
lše
++;

386 
p
 = 
bufãr
;

388 ià((*
p
 == '\n') || (*p == '#') || (*p == '\0'))

391 
p
[
	`¡¾’
(p)-1] = '\0';

394 ià((
pos
 = 
	`¡rc¥n
(
p
, "\t ")) == 0) {

395 
	`rc_log
(
LOG_ERR
, "%s:†š%d: bogu fÜm©: %s", 
f’ame
, 
lše
, 
p
);

396 
	`fşo£
(
cÚfigfd
);

397 
	`rc_de¡roy
(
rh
);

398  
NULL
;

401 
p
[
pos
] = '\0';

403 ià((
İtiÚ
 = 
	`fšd_İtiÚ
(
rh
, 
p
, 
OT_ANY
)è=ğ
NULL
) {

404 
	`rc_log
(
LOG_ERR
, "%s:†š%d: uÄecognized keywÜd: %s", 
f’ame
, 
lše
, 
p
);

405 
	`fşo£
(
cÚfigfd
);

406 
	`rc_de¡roy
(
rh
);

407  
NULL
;

410 ià(
İtiÚ
->
¡©us
 !ğ
ST_UNDEF
) {

411 
	`rc_log
(
LOG_ERR
, "%s:†š%d: du¶iÿ‹ o±iÚ†še: %s", 
f’ame
, 
lše
, 
p
);

412 
	`fşo£
(
cÚfigfd
);

413 
	`rc_de¡roy
(
rh
);

414  
NULL
;

417 
p
 +ğ
pos
+1;

418 
	`is¥aû
(*
p
))

419 
p
++;

420 
pos
 = 
	`¡¾’
(
p
) - 1;

421 
pos
 >ğ0 && 
	`is¥aû
(
p
[pos]))

422 
pos
--;

423 
p
[
pos
 + 1] = '\0';

425 
İtiÚ
->
ty³
) {

426 
OT_STR
:

427 ià(
	`£t_İtiÚ_¡r
(
f’ame
, 
lše
, 
İtiÚ
, 
p
) < 0) {

428 
	`fşo£
(
cÚfigfd
);

429 
	`rc_de¡roy
(
rh
);

430  
NULL
;

433 
OT_INT
:

434 ià(
	`£t_İtiÚ_št
(
f’ame
, 
lše
, 
İtiÚ
, 
p
) < 0) {

435 
	`fşo£
(
cÚfigfd
);

436 
	`rc_de¡roy
(
rh
);

437  
NULL
;

440 
OT_SRV
:

441 ià(
	`£t_İtiÚ_¤v
(
f’ame
, 
lše
, 
İtiÚ
, 
p
) < 0) {

442 
	`fşo£
(
cÚfigfd
);

443 
	`rc_de¡roy
(
rh
);

444  
NULL
;

447 
OT_AUO
:

448 ià(
	`£t_İtiÚ_auo
(
f’ame
, 
lše
, 
İtiÚ
, 
p
) < 0) {

449 
	`fşo£
(
cÚfigfd
);

450 
	`rc_de¡roy
(
rh
);

451  
NULL
;

455 
	`rc_log
(
LOG_CRIT
, "rc_read_config: impossible case branch!");

456 
	`abÜt
();

459 
	`fşo£
(
cÚfigfd
);

461 ià(
	`‹¡_cÚfig
(
rh
, 
f’ame
) == -1) {

462 
	`rc_de¡roy
(
rh
);

463  
NULL
;

465  
rh
;

466 
	}
}

476 *
	$rc_cÚf_¡r
(
rc_hªdË
 *
rh
, *
İŠame
)

478 
OPTION
 *
İtiÚ
;

480 
İtiÚ
 = 
	`fšd_İtiÚ
(
rh
, 
İŠame
, 
OT_STR
);

482 ià(
İtiÚ
 !ğ
NULL
) {

483  (*)
İtiÚ
->
v®
;

485 
	`rc_log
(
LOG_CRIT
, "rc_cÚf_¡r: unkowÀcÚfig o±iÚ„eque¡ed: %s", 
İŠame
);

486 
	`abÜt
();

487  
NULL
;

489 
	}
}

491 
	$rc_cÚf_št
(
rc_hªdË
 *
rh
, *
İŠame
)

493 
OPTION
 *
İtiÚ
;

495 
İtiÚ
 = 
	`fšd_İtiÚ
(
rh
, 
İŠame
, 
OT_INT
|
OT_AUO
);

497 ià(
İtiÚ
 !ğ
NULL
) {

498  *((*)
İtiÚ
->
v®
);

500 
	`rc_log
(
LOG_CRIT
, "rc_cÚf_št: unkowÀcÚfig o±iÚ„eque¡ed: %s", 
İŠame
);

501 
	`abÜt
();

504 
	}
}

506 
SERVER
 *
	$rc_cÚf_¤v
(
rc_hªdË
 *
rh
, *
İŠame
)

508 
OPTION
 *
İtiÚ
;

510 
İtiÚ
 = 
	`fšd_İtiÚ
(
rh
, 
İŠame
, 
OT_SRV
);

512 ià(
İtiÚ
 !ğ
NULL
) {

513  (
SERVER
 *)
İtiÚ
->
v®
;

515 
	`rc_log
(
LOG_CRIT
, "rc_cÚf_¤v: unkowÀcÚfig o±iÚ„eque¡ed: %s", 
İŠame
);

516 
	`abÜt
();

517  
NULL
;

519 
	}
}

529 
	$‹¡_cÚfig
(
rc_hªdË
 *
rh
, *
f’ame
)

532 
¡©
 
¡
;

533 *
fe
;

536 ià(!(
	`rc_cÚf_¤v
(
rh
, "auth£rv”")->
max
))

538 
	`rc_log
(
LOG_ERR
,"%s:‚Øauth£rv” s³cif›d", 
f’ame
);

541 ià(!(
	`rc_cÚf_¤v
(
rh
, "acù£rv”")->
max
))

543 
	`rc_log
(
LOG_ERR
,"%s:‚Øacù£rv” s³cif›d", 
f’ame
);

546 ià(!
	`rc_cÚf_¡r
(
rh
, "servers"))

548 
	`rc_log
(
LOG_ERR
,"%s:‚Ø£rv” f¥ecif›d", 
f’ame
);

551 ià(!
	`rc_cÚf_¡r
(
rh
, "dictionary"))

553 
	`rc_log
(
LOG_ERR
,"%s:‚ØdiùiÚ¬y s³cif›d", 
f’ame
);

557 ià(
	`rc_cÚf_št
(
rh
, "radius_timeout") <= 0)

559 
	`rc_log
(
LOG_ERR
,"%s:„adius_timeouˆ<ğ0 i Ëg®", 
f’ame
);

562 ià(
	`rc_cÚf_št
(
rh
, "radius_retries") <= 0)

564 
	`rc_log
(
LOG_ERR
,"%s:„adius_»Œ› <ğ0 i Ëg®", 
f’ame
);

567 ià(
	`rc_cÚf_št
(
rh
, "radius_deadtime") < 0)

569 
	`rc_log
(
LOG_ERR
,"%s:„adius_d—dtimi Ëg®", 
f’ame
);

573 
fe
 = 
	`rc_cÚf_¡r
(
rh
, "login_local");

574 ià(
	`¡©
(
fe
, &
¡
) == 0)

576 ià(!
	`S_ISREG
(
¡
.
¡_mode
)) {

577 
	`rc_log
(
LOG_ERR
,"%s:‚Ù‡„eguÏ¸fe: %s", 
f’ame
, 
fe
);

581 
	`rc_log
(
LOG_ERR
,"%s: fnÙ found: %s", 
f’ame
, 
fe
);

584 
fe
 = 
	`rc_cÚf_¡r
(
rh
, "login_radius");

585 ià(
	`¡©
(
fe
, &
¡
) == 0)

587 ià(!
	`S_ISREG
(
¡
.
¡_mode
)) {

588 
	`rc_log
(
LOG_ERR
,"%s:‚Ù‡„eguÏ¸fe: %s", 
f’ame
, 
fe
);

592 
	`rc_log
(
LOG_ERR
,"%s: fnÙ found: %s", 
f’ame
, 
fe
);

597 ià(
	`rc_cÚf_št
(
rh
, "login_tries") <= 0)

599 
	`rc_log
(
LOG_ERR
,"%s:†ogš_Œ› <ğ0 i Ëg®", 
f’ame
);

602 ià(
	`rc_cÚf_¡r
(
rh
, "£qfe"è=ğ
NULL
)

604 
	`rc_log
(
LOG_ERR
,"%s: seqfnÙ s³cif›d", 
f’ame
);

607 ià(
	`rc_cÚf_št
(
rh
, "login_timeout") <= 0)

609 
	`rc_log
(
LOG_ERR
,"%s:†ogš_timeouˆ<ğ0 i Ëg®", 
f’ame
);

612 ià(
	`rc_cÚf_¡r
(
rh
, "m­fe"è=ğ
NULL
)

614 
	`rc_log
(
LOG_ERR
,"%s: m­fnÙ s³cif›d", 
f’ame
);

617 ià(
	`rc_cÚf_¡r
(
rh
, "nŞogš"è=ğ
NULL
)

619 
	`rc_log
(
LOG_ERR
,"%s:‚Şogš‚Ù s³cif›d", 
f’ame
);

624 
	}
}

635 
	$fšd_m©ch
 (
ušt32_t
 *
_addr
, *
ho¡Çme
)

638 
ušt32_t
 
addr
;

639 **
·ddr
;

640 
ho¡’t
 *
hp
;

642 ià(
	`rc_good_addr
 (
ho¡Çme
) == 0)

644 ià(*
_addr
 =ğ
	`Áohl
(
	`š‘_addr
 (
ho¡Çme
)))

651 ià((
hp
 = 
	`rc_g‘ho¡byÇme
(
ho¡Çme
)è=ğ
NULL
)

656 
·ddr
 = 
hp
->
h_addr_li¡
; *paddr;…addr++)

658 
addr
 = ** (
ušt32_t
 **è
·ddr
;

659 ià(
	`Áohl
(
addr
è=ğ*
_addr
)

665 
	}
}

677 
	$rc_addr_loÿl
(
ušt32_t
 
_addr
)

679 
‹mp_sock
, 
»s
, 
£¼no
;

680 
sockaddr_š
 
sš
;

682 
‹mp_sock
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

683 ià(
‹mp_sock
 == -1)

685 
	`mem£t
(&
sš
, '\0', (sin));

686 
sš
.
sš_çmy
 = 
AF_INET
;

687 
sš
.
sš_addr
.
s_addr
 = 
	`htÚl
(
_addr
);

688 
sš
.
sš_pÜt
 = 
	`htÚs
(0);

689 
»s
 = 
	`bšd
(
‹mp_sock
, (
sockaddr
 *)&
sš
, (sin));

690 
£¼no
 = 
”ºo
;

691 
	`şo£
(
‹mp_sock
);

692 ià(
»s
 == 0)

694 ià(
£¼no
 =ğ
EADDRNOTAVAIL
)

697 
	}
}

709 
	$rc_is_myÇme
(*
ho¡Çme
)

711 
ušt32_t
 
addr
;

712 **
·ddr
;

713 
ho¡’t
 *
hp
;

714 
»s
;

716 ià(
	`rc_good_addr
(
ho¡Çme
) == 0)

717  
	`rc_addr_loÿl
(
	`Áohl
(
	`š‘_addr
(
ho¡Çme
)));

719 ià((
hp
 = 
	`rc_g‘ho¡byÇme
(
ho¡Çme
)è=ğ
NULL
)

721 
·ddr
 = 
hp
->
h_addr_li¡
; *paddr;…addr++) {

722 
addr
 = **(
ušt32_t
 **)
·ddr
;

723 
»s
 = 
	`rc_addr_loÿl
(
	`Áohl
(
addr
));

724 ià(
»s
 == 0 ||„es == -1)

725  
»s
;

728 
	}
}

739 
	$rc_fšd_£rv”
 (
rc_hªdË
 *
rh
, *
£rv”_Çme
, 
ušt32_t
 *
_addr
, *
£ü‘
)

741 
i
;

742 
size_t
 
Ën
;

743 
»suÉ
 = 0;

744 
FILE
 *
ş›Áfd
;

745 *
h
;

746 *
s
;

747 
bufãr
[128];

748 
ho¡nm
[
AUTH_ID_LEN
 + 1];

749 *
bufãr_§ve
;

750 *
ho¡nm_§ve
;

751 
SERVER
 *
auth£rv”s
;

752 
SERVER
 *
acù£rv”s
;

755 ià((*
_addr
 = 
	`rc_g‘_addr
 (
£rv”_Çme
)è=ğ(
ušt32_t
) 0)

759 ifĞ(
auth£rv”s
 = 
	`rc_cÚf_¤v
(
rh
, "auth£rv”")è!ğ
NULL
 )

761  
i
 = 0; i < 
auth£rv”s
->
max
; i++ )

763 ifĞ(
	`¡ºcmp
(
£rv”_Çme
, 
auth£rv”s
->
Çme
[
i
], 
	`¡¾’
(server_name)) == 0) &&

764 (
auth£rv”s
->
£ü‘
[
i
] !ğ
NULL
) )

766 
	`mem£t
 (
£ü‘
, '\0', 
MAX_SECRET_LENGTH
);

767 
Ën
 = 
	`¡¾’
 (
auth£rv”s
->
£ü‘
[
i
]);

768 ià(
Ën
 > 
MAX_SECRET_LENGTH
)

770 
Ën
 = 
MAX_SECRET_LENGTH
;

772 
	`¡ºıy
 (
£ü‘
, 
auth£rv”s
->£ü‘[
i
], (
size_t
è
Ën
);

773 
£ü‘
[
MAX_SECRET_LENGTH
] = '\0';

779 ifĞ(
acù£rv”s
 = 
	`rc_cÚf_¤v
(
rh
, "acù£rv”")è!ğ
NULL
 )

781  
i
 = 0; i < 
acù£rv”s
->
max
; i++ )

783 ifĞ(
	`¡ºcmp
(
£rv”_Çme
, 
acù£rv”s
->
Çme
[
i
], 
	`¡¾’
(server_name)) == 0) &&

784 (
acù£rv”s
->
£ü‘
[
i
] !ğ
NULL
) )

786 
	`mem£t
 (
£ü‘
, '\0', 
MAX_SECRET_LENGTH
);

787 
Ën
 = 
	`¡¾’
 (
acù£rv”s
->
£ü‘
[
i
]);

788 ià(
Ën
 > 
MAX_SECRET_LENGTH
)

790 
Ën
 = 
MAX_SECRET_LENGTH
;

792 
	`¡ºıy
 (
£ü‘
, 
acù£rv”s
->£ü‘[
i
], (
size_t
è
Ën
);

793 
£ü‘
[
MAX_SECRET_LENGTH
] = '\0';

803 ià((
ş›Áfd
 = 
	`fİ’
 (
	`rc_cÚf_¡r
(
rh
, "£rv”s"), "r")è=ğ
NULL
)

805 
	`rc_log
(
LOG_ERR
, "rc_fšd_£rv”: couldn'ˆİ’ fe: %s: %s", 
	`¡»¼Ü
(
”ºo
), 
	`rc_cÚf_¡r
(
rh
, "servers"));

809 
	`fg‘s
 (
bufãr
,  (bufãr), 
ş›Áfd
è!ğ
NULL
)

811 ià(*
bufãr
 == '#')

814 ià((
h
 = 
	`¡¹ok_r
(
bufãr
, " \t\n", &
bufãr_§ve
)è=ğ
NULL
)

817 
	`mem£t
 (
ho¡nm
, '\0', 
AUTH_ID_LEN
);

818 
Ën
 = 
	`¡¾’
 (
h
);

819 ià(
Ën
 > 
AUTH_ID_LEN
)

821 
Ën
 = 
AUTH_ID_LEN
;

823 
	`¡ºıy
 (
ho¡nm
, 
h
, (
size_t
è
Ën
);

824 
ho¡nm
[
AUTH_ID_LEN
] = '\0';

826 ià((
s
 = 
	`¡¹ok_r
 (
NULL
, " \t\n", &
bufãr_§ve
)) == NULL)

829 
	`mem£t
 (
£ü‘
, '\0', 
MAX_SECRET_LENGTH
);

830 
Ën
 = 
	`¡¾’
 (
s
);

831 ià(
Ën
 > 
MAX_SECRET_LENGTH
)

833 
Ën
 = 
MAX_SECRET_LENGTH
;

835 
	`¡ºıy
 (
£ü‘
, 
s
, (
size_t
è
Ën
);

836 
£ü‘
[
MAX_SECRET_LENGTH
] = '\0';

838 ià(!
	`¡rchr
 (
ho¡nm
, '/'))

840 ià(
	`fšd_m©ch
 (
_addr
, 
ho¡nm
) == 0)

842 
»suÉ
++;

848 
	`¡¹ok_r
(
ho¡nm
, "/", &
ho¡nm_§ve
);

849 ià(
	`rc_is_myÇme
(
ho¡nm
) == 0)

851 ià(
	`fšd_m©ch
 (
_addr
, 
ho¡nm_§ve
) == 0)

853 
»suÉ
++;

859 ià(
	`fšd_m©ch
 (
_addr
, 
ho¡nm
) == 0)

861 
»suÉ
++;

867 
	`fşo£
 (
ş›Áfd
);

868 ià(
»suÉ
 == 0)

870 
	`mem£t
 (
bufãr
, '\0',  (buffer));

871 *
£ü‘
 = '\0';

872 
	`rc_log
(
LOG_ERR
, "rc_find_server: couldn't find RADIUS server %s in %s",

873 
£rv”_Çme
, 
	`rc_cÚf_¡r
(
rh
, "servers"));

877 
	}
}

888 
	$rc_cÚfig_ä“
(
rc_hªdË
 *
rh
)

890 
i
, 
j
;

891 
SERVER
 *
£rv
;

893 ià(
rh
->
cÚfig_İtiÚs
 =ğ
NULL
)

896 
i
 = 0; i < 
NUM_OPTIONS
; i++) {

897 ià(
rh
->
cÚfig_İtiÚs
[
i
].
v®
 =ğ
NULL
)

899 ià(
rh
->
cÚfig_İtiÚs
[
i
].
ty³
 =ğ
OT_SRV
) {

900 
£rv
 = (
SERVER
 *)
rh
->
cÚfig_İtiÚs
[
i
].
v®
;

901 
j
 = 0; j < 
£rv
->
max
; j++)

902 
	`ä“
(
£rv
->
Çme
[
j
]);

903 
	`ä“
(
£rv
);

905 
	`ä“
(
rh
->
cÚfig_İtiÚs
[
i
].
v®
);

908 
	`ä“
(
rh
->
cÚfig_İtiÚs
);

909 
rh
->
cÚfig_İtiÚs
 = 
NULL
;

910 
	}
}

	@radius/src/dict.c

17 
	~<r_cÚfig.h
>

18 
	~<šşudes.h
>

19 
	~<ä“¿dius-ş›Á.h
>

30 
	$rc_»ad_diùiÚ¬y
 (
rc_hªdË
 *
rh
, cÚ¡ *
f’ame
)

32 
FILE
 *
diùfd
;

33 
dummy¡r
[
AUTH_ID_LEN
];

34 
Çme¡r
[
AUTH_ID_LEN
];

35 
v®¡r
[
AUTH_ID_LEN
];

36 
©Œ¡r
[
AUTH_ID_LEN
];

37 
ty³¡r
[
AUTH_ID_LEN
];

38 
İt¡r
[
AUTH_ID_LEN
];

39 *
ı
, *
if’ame
;

40 
lše_no
;

41 
DICT_ATTR
 *
©Œ
;

42 
DICT_VALUE
 *
dv®
;

43 
DICT_VENDOR
 *
dv’d
;

44 
bufãr
[256];

45 
v®ue
;

46 
ty³
;

48 ià((
diùfd
 = 
	`fİ’
 (
f’ame
, "r")è=ğ
NULL
)

50 
	`rc_log
(
LOG_ERR
, "rc_read_dictionary: couldn't open dictionary %s: %s",

51 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

55 
lše_no
 = 0;

56 
	`fg‘s
 (
bufãr
,  (bufãr), 
diùfd
è!ğ
NULL
)

58 
lše_no
++;

61 ià(*
bufãr
 == '#' || *buffer == '\0' || *buffer == '\n' || \

62 *
bufãr
 == '\r')

68 
ı
 = 
	`¡rchr
(
bufãr
, '#');

69 ià(
ı
 !ğ
NULL
)

71 *
ı
 = '\0';

74 ià(
	`¡ºcmp
 (
bufãr
, "ATTRIBUTE", 9) == 0)

76 
İt¡r
[0] = '\0';

78 ià(
	`ssÿnf
 (
bufãr
, "%s%s%s%s%s", 
dummy¡r
, 
Çme¡r
,

79 
v®¡r
, 
ty³¡r
, 
İt¡r
) < 4)

81 
	`rc_log
(
LOG_ERR
, "rc_read_dictionary: invalid‡ttribute on†ine %d of dictionary %s",

82 
lše_no
, 
f’ame
);

83 
	`fşo£
(
diùfd
);

90 ià(
	`¡¾’
 (
Çme¡r
è> 
NAME_LENGTH
)

92 
	`rc_log
(
LOG_ERR
, "rc_read_dictionary: invalid‚ame†ength on†ine %d of dictionary %s",

93 
lše_no
, 
f’ame
);

94 
	`fşo£
(
diùfd
);

98 ià(!
	`isdig™
 (*
v®¡r
))

100 
	`rc_log
(
LOG_ERR
,

102 
lše_no
, 
f’ame
);

103 
	`fşo£
(
diùfd
);

106 
v®ue
 = 
	`©oi
 (
v®¡r
);

108 ià(
	`¡rcmp
 (
ty³¡r
, "string") == 0)

110 
ty³
 = 
PW_TYPE_STRING
;

112 ià(
	`¡rcmp
 (
ty³¡r
, "integer") == 0)

114 
ty³
 = 
PW_TYPE_INTEGER
;

116 ià(
	`¡rcmp
 (
ty³¡r
, "ipaddr") == 0)

118 
ty³
 = 
PW_TYPE_IPADDR
;

120 ià(
	`¡rcmp
 (
ty³¡r
, "date") == 0)

122 
ty³
 = 
PW_TYPE_DATE
;

126 
	`rc_log
(
LOG_ERR
,

128 
lše_no
, 
f’ame
);

129 
	`fşo£
(
diùfd
);

133 
dv’d
 = 
NULL
;

134 ià(
İt¡r
[0] != '\0') {

135 *
ı1
;

136 
ı1
 = 
İt¡r
; cp1 !ğ
NULL
; cp1 = 
ı
) {

137 
ı
 = 
	`¡rchr
(
ı1
, ',');

138 ià(
ı
 !ğ
NULL
) {

139 *
ı
 = '\0';

140 
ı
++;

142 ià(
	`¡ºcmp
(
ı1
, "vendor=", 7) == 0)

143 
ı1
 += 7;

144 
dv’d
 = 
	`rc_diù_fšdv’d
(
rh
, 
ı1
);

145 ià(
dv’d
 =ğ
NULL
) {

146 
	`rc_log
(
LOG_ERR
,

148 
ı1
, 
lše_no
, 
f’ame
);

149 
	`fşo£
(
diùfd
);

156 ià((
©Œ
 = 
	`m®loc
 ( (
DICT_ATTR
))è=ğ
NULL
)

158 
	`rc_log
(
LOG_CRIT
, "rc_read_dictionary: out of memory");

159 
	`fşo£
(
diùfd
);

162 
	`¡rıy
 (
©Œ
->
Çme
, 
Çme¡r
);

163 
©Œ
->
v®ue
 = value;

164 
©Œ
->
ty³
 =ype;

166 ià(
dv’d
 !ğ
NULL
)

167 
©Œ
->
v®ue
 |ğ(
dv’d
->
v’dÜ³c
 << 16);

170 
©Œ
->
Ãxt
 = 
rh
->
diùiÚ¬y_©Œibu‹s
;

171 
rh
->
diùiÚ¬y_©Œibu‹s
 = 
©Œ
;

173 ià(
	`¡ºcmp
 (
bufãr
, "VALUE", 5) == 0)

176 ià(
	`ssÿnf
 (
bufãr
, "%s%s%s%s", 
dummy¡r
, 
©Œ¡r
,

177 
Çme¡r
, 
v®¡r
) != 4)

179 
	`rc_log
(
LOG_ERR
,

181 
lše_no
, 
f’ame
);

182 
	`fşo£
(
diùfd
);

189 ià(
	`¡¾’
 (
©Œ¡r
è> 
NAME_LENGTH
)

191 
	`rc_log
(
LOG_ERR
,

193 
lše_no
, 
f’ame
);

194 
	`fşo£
(
diùfd
);

198 ià(
	`¡¾’
 (
Çme¡r
è> 
NAME_LENGTH
)

200 
	`rc_log
(
LOG_ERR
,

202 
lše_no
, 
f’ame
);

203 
	`fşo£
(
diùfd
);

207 ià(!
	`isdig™
 (*
v®¡r
))

209 
	`rc_log
(
LOG_ERR
,

211 
lše_no
, 
f’ame
);

212 
	`fşo£
(
diùfd
);

215 
v®ue
 = 
	`©oi
 (
v®¡r
);

218 ià((
dv®
 = 
	`m®loc
 ( (
DICT_VALUE
))è=ğ
NULL
)

220 
	`rc_log
(
LOG_CRIT
, "rc_read_dictionary: out of memory");

221 
	`fşo£
(
diùfd
);

224 
	`¡rıy
 (
dv®
->
©ŒÇme
, 
©Œ¡r
);

225 
	`¡rıy
 (
dv®
->
Çme
, 
Çme¡r
);

226 
dv®
->
v®ue
 = value;

229 
dv®
->
Ãxt
 = 
rh
->
diùiÚ¬y_v®ues
;

230 
rh
->
diùiÚ¬y_v®ues
 = 
dv®
;

232 ià(
	`¡ºcmp
 (
bufãr
, "$INCLUDE", 8) == 0)

235 ià(
	`ssÿnf
 (
bufãr
, "%s%s", 
dummy¡r
, 
Çme¡r
) != 2)

237 
	`rc_log
(
LOG_ERR
,

239 
lše_no
, 
f’ame
);

240 
	`fşo£
(
diùfd
);

243 
if’ame
 = 
Çme¡r
;

245 ià(
Çme¡r
[0] != '/') {

246 
ı
 = 
	`¡¼chr
(
f’ame
, '/');

247 ià(
ı
 !ğ
NULL
) {

248 
if’ame
 = 
	`®loÿ
(
AUTH_ID_LEN
);

249 *
ı
 = '\0';

250 
	`¥rštf
(
if’ame
, "%s/%s", 
f’ame
, 
Çme¡r
);

251 *
ı
 = '/';

254 ià(
	`rc_»ad_diùiÚ¬y
(
rh
, 
if’ame
) < 0)

256 
	`fşo£
(
diùfd
);

260 ià(
	`¡ºcmp
 (
bufãr
, "VENDOR", 6) == 0)

263 ià(
	`ssÿnf
 (
bufãr
, "%s%s%s", 
dummy¡r
, 
©Œ¡r
, 
v®¡r
) != 3)

265 
	`rc_log
(
LOG_ERR
,

267 
lše_no
, 
f’ame
);

268 
	`fşo£
(
diùfd
);

273 ià(
	`¡¾’
 (
©Œ¡r
è> 
NAME_LENGTH
)

275 
	`rc_log
(
LOG_ERR
,

277 
lše_no
, 
f’ame
);

278 
	`fşo£
(
diùfd
);

282 ià(!
	`isdig™
 (*
v®¡r
))

284 
	`rc_log
(
LOG_ERR
,

286 
lše_no
, 
f’ame
);

287 
	`fşo£
(
diùfd
);

290 
v®ue
 = 
	`©oi
 (
v®¡r
);

293 
dv’d
 = 
	`m®loc
((
DICT_VENDOR
));

294 ià(
dv’d
 =ğ
NULL
)

296 
	`rc_log
(
LOG_CRIT
, "rc_read_dictionary: out of memory");

297 
	`fşo£
(
diùfd
);

300 
	`¡rıy
 (
dv’d
->
v’dÜÇme
, 
©Œ¡r
);

301 
dv’d
->
v’dÜ³c
 = 
v®ue
;

304 
dv’d
->
Ãxt
 = 
rh
->
diùiÚ¬y_v’dÜs
;

305 
rh
->
diùiÚ¬y_v’dÜs
 = 
dv’d
;

308 
	`fşo£
 (
diùfd
);

310 
	}
}

320 
DICT_ATTR
 *
	$rc_diù_g‘©Œ
 (cÚ¡ 
rc_hªdË
 *
rh
, 
©Œibu‹
)

322 
DICT_ATTR
 *
©Œ
;

324 
©Œ
 = 
rh
->
diùiÚ¬y_©Œibu‹s
;

325 
©Œ
 !ğ
NULL
)

327 ià(
©Œ
->
v®ue
 =ğ
©Œibu‹
)

329  
©Œ
;

331 
©Œ
 =‡‰r->
Ãxt
;

333  
NULL
;

334 
	}
}

344 
DICT_ATTR
 *
	$rc_diù_fšd©Œ
 (cÚ¡ 
rc_hªdË
 *
rh
, cÚ¡ *
©ŒÇme
)

346 
DICT_ATTR
 *
©Œ
;

348 
©Œ
 = 
rh
->
diùiÚ¬y_©Œibu‹s
;

349 
©Œ
 !ğ
NULL
)

351 ià(
	`¡rÿ£cmp
 (
©Œ
->
Çme
, 
©ŒÇme
) == 0)

353  
©Œ
;

355 
©Œ
 =‡‰r->
Ãxt
;

357  
NULL
;

358 
	}
}

369 
DICT_VALUE
 *
	$rc_diù_fšdv®
 (cÚ¡ 
rc_hªdË
 *
rh
, cÚ¡ *
v®Çme
)

371 
DICT_VALUE
 *
v®
;

373 
v®
 = 
rh
->
diùiÚ¬y_v®ues
;

374 
v®
 !ğ
NULL
)

376 ià(
	`¡rÿ£cmp
 (
v®
->
Çme
, 
v®Çme
) == 0)

378  
v®
;

380 
v®
 = v®->
Ãxt
;

382  
NULL
;

383 
	}
}

393 
DICT_VENDOR
 *

394 
	$rc_diù_fšdv’d
(cÚ¡ 
rc_hªdË
 *
rh
, cÚ¡ *
v’dÜÇme
)

396 
DICT_VENDOR
 *
v’d
;

398 
v’d
 = 
rh
->
diùiÚ¬y_v’dÜs
; v’d !ğ
NULL
; v’d = v’d->
Ãxt
)

399 ià(
	`¡rÿ£cmp
(
v’d
->
v’dÜÇme
, vendorname) == 0)

400  
v’d
;

401  
NULL
;

402 
	}
}

412 
DICT_VENDOR
 *

413 
	$rc_diù_g‘v’d
 (cÚ¡ 
rc_hªdË
 *
rh
, 
v’dÜ³c
)

415 
DICT_VENDOR
 *
v’d
;

417 
v’d
 = 
rh
->
diùiÚ¬y_v’dÜs
; v’d !ğ
NULL
; v’d = v’d->
Ãxt
)

418 ià(
v’d
->
v’dÜ³c
 == vendorpec)

419  
v’d
;

420  
NULL
;

421 
	}
}

431 
DICT_VALUE
 *

432 
	$rc_diù_g‘v®
 (cÚ¡ 
rc_hªdË
 *
rh
, 
ušt32_t
 
v®ue
, cÚ¡ *
©ŒÇme
)

434 
DICT_VALUE
 *
v®
;

436 
v®
 = 
rh
->
diùiÚ¬y_v®ues
;

437 
v®
 !ğ
NULL
)

439 ià(
	`¡rcmp
 (
v®
->
©ŒÇme
,‡ttrname) == 0 &&

440 
v®
->
v®ue
 == value)

442  
v®
;

444 
v®
 = v®->
Ãxt
;

446  
NULL
;

447 
	}
}

458 
	$rc_diù_ä“
(
rc_hªdË
 *
rh
)

460 
DICT_ATTR
 *
©Œ
, *
Ç‰r
;

461 
DICT_VALUE
 *
v®
, *
nv®
;

462 
DICT_VENDOR
 *
v’d
, *
nv’d
;

464 
©Œ
 = 
rh
->
diùiÚ¬y_©Œibu‹s
;‡‰¸!ğ
NULL
;‡‰¸ğ
Ç‰r
) {

465 
Ç‰r
 = 
©Œ
->
Ãxt
;

466 
	`ä“
(
©Œ
);

468 
v®
 = 
rh
->
diùiÚ¬y_v®ues
; v® !ğ
NULL
; v® = 
nv®
) {

469 
nv®
 = 
v®
->
Ãxt
;

470 
	`ä“
(
v®
);

472 
v’d
 = 
rh
->
diùiÚ¬y_v’dÜs
; v’d !ğ
NULL
; v’d = 
nv’d
) {

473 
nv’d
 = 
v’d
->
Ãxt
;

474 
	`ä“
(
v’d
);

476 
rh
->
diùiÚ¬y_©Œibu‹s
 = 
NULL
;

477 
rh
->
diùiÚ¬y_v®ues
 = 
NULL
;

478 
rh
->
diùiÚ¬y_v’dÜs
 = 
NULL
;

479 
	}
}

	@radius/src/env.c

12 
	~<r_cÚfig.h
>

13 
	~<šşudes.h
>

14 
	~<ä“¿dius-ş›Á.h
>

23 
ENV
 *
	$rc_Ãw_’v
(
size
)

25 
ENV
 *
p
;

27 ià(
size
 < 1)

28  
NULL
;

30 ià((
p
 = 
	`m®loc
((*p))è=ğ
NULL
)

31  
NULL
;

33 ià((
p
->
’v
 = 
	`m®loc
(
size
 * (*))è=ğ
NULL
)

35 
	`rc_log
(
LOG_CRIT
, "rc_new_env: out of memory");

36 
	`ä“
(
p
);

37  
NULL
;

40 
p
->
’v
[0] = 
NULL
;

42 
p
->
size
 = 0;

43 
p
->
maxsize
 = 
size
;

45  
p
;

46 
	}
}

55 
	$rc_ä“_’v
(
ENV
 *
’v
)

57 
	`ä“
(
’v
->env);

58 
	`ä“
(
’v
);

59 
	}
}

68 
	$rc_add_’v
(
ENV
 *
’v
, *
Çme
, *
v®ue
)

70 
i
;

71 *
Ãw_’v
;

73 
i
 = 0; 
’v
->’v[i] !ğ
NULL
; i++)

75 ià(
	`¡ºcmp
(
’v
->’v[
i
], 
Çme
, 
	`MAX
(
	`¡rchr
Ónv->’v[i], '='è-ƒnv->’v[i], ()
	`¡¾’
(name))) == 0)

79 ià(
’v
->’v[
i
])

81 ià((
Ãw_’v
 = 
	`»®loc
(
’v
->’v[
i
], 
	`¡¾’
(
Çme
)+¡¾’(
v®ue
)+2)è=ğ
NULL
)

84 
’v
->’v[
i
] = 
Ãw_’v
;

86 
	`¥rštf
(
’v
->’v[
i
],"%s=%s", 
Çme
, 
v®ue
);

88 ià(
’v
->
size
 =ğÓnv->
maxsize
-1)) {

89 
	`rc_log
(
LOG_CRIT
, "rc_add_env:‚otƒnough space forƒnvironment (increase ENV_SIZE)");

93 ià((
’v
->’v[’v->
size
] = 
	`m®loc
(
	`¡¾’
(
Çme
)+¡¾’(
v®ue
)+2)è=ğ
NULL
) {

94 
	`rc_log
(
LOG_CRIT
, "rc_add_env: out of memory");

98 
	`¥rštf
(
’v
->’v[’v->
size
],"%s=%s", 
Çme
, 
v®ue
);

100 
’v
->
size
++;

102 
’v
->’v[’v->
size
] = 
NULL
;

106 
	}
}

115 
	$rc_impÜt_’v
(
ENV
 *
’v
, **
impÜt
)

117 *
es
;

119 *
impÜt
)

121 
es
 = 
	`¡rchr
(*
impÜt
, '=');

123 ià(!
es
)

125 
impÜt
++;

130 *
es
 = '\0';

132 ià(
	`rc_add_’v
(
’v
, *
impÜt
, 
es
+1) < 0)

134 *
es
 = '=';

138 *
es
 = '=';

140 
impÜt
++;

144 
	}
}

	@radius/src/freeradius-client.h

17 #iâdeà
FREERADIUS_CLIENT_H


18 
	#FREERADIUS_CLIENT_H


	)

21 
	~<sys/ty³s.h
>

27 
	~<¡dšt.h
>

29 
	~<¡dio.h
>

30 
	~<time.h
>

32 #undeà
__BEGIN_DECLS


33 #undeà
__END_DECLS


34 #ifdeà
__ılu¥lus


35 
	#__BEGIN_DECLS
 "C" {

	)

36 
	#__END_DECLS
 }

	)

38 
	#__BEGIN_DECLS


	)

39 
	#__END_DECLS


	)

42 
	#AUTH_VECTOR_LEN
 16

	)

43 
	#AUTH_PASS_LEN
 (3 * 16è

	)

44 
	#AUTH_ID_LEN
 64

	)

45 
	#AUTH_STRING_LEN
 253

	)

47 
	#BUFFER_LEN
 8192

	)

49 
	#NAME_LENGTH
 32

	)

50 
	#GETSTR_LENGTH
 128

	)

52 
	#MAX_SECRET_LENGTH
 (3 * 16è

	)

54 
	#VENDOR
(
x
è(((xè>> 16è& 0xffff)

	)

55 
	#ATTRID
(
x
è((xè& 0xffff)

	)

58 
	#AUTH
 0

	)

59 
	#ACCT
 1

	)

63 
	#SERVER_MAX
 8

	)

65 
	#AUTH_LOCAL_FST
 (1<<0)

	)

66 
	#AUTH_RADIUS_FST
 (1<<1)

	)

67 
	#AUTH_LOCAL_SND
 (1<<2)

	)

68 
	#AUTH_RADIUS_SND
 (1<<3)

	)

70 
	s£rv”
 {

71 
max
;

72 *
Çme
[
SERVER_MAX
];

73 
ušt16_t
 
pÜt
[
SERVER_MAX
];

74 *
£ü‘
[
SERVER_MAX
];

75 
d—dtime_’ds
[
SERVER_MAX
];

76 } 
	tSERVER
;

78 
	spw_auth_hdr


80 
ušt8_t
 
	mcode
;

81 
ušt8_t
 
	mid
;

82 
ušt16_t
 
	mËngth
;

83 
ušt8_t
 
	mveùÜ
[
AUTH_VECTOR_LEN
];

84 
ušt8_t
 
	md©a
[2];

85 } 
	tAUTH_HDR
;

87 
	src_cÚf


89 
_İtiÚ
 *
	mcÚfig_İtiÚs
;

90 
ušt32_t
 
	mthis_ho¡_addr
;

91 
ušt32_t
 *
	mthis_ho¡_bšd_addr
;

92 
m­2id_s
 *
	mm­2id_li¡
;

93 
diù_©Œ
 *
	mdiùiÚ¬y_©Œibu‹s
;

94 
diù_v®ue
 *
	mdiùiÚ¬y_v®ues
;

95 
diù_v’dÜ
 *
	mdiùiÚ¬y_v’dÜs
;

96 
	mbuf
[
GETSTR_LENGTH
];

97 
	mbuf1
[14];

98 
	miâame
[512];

99 *
	mµbuf
;

102 
rc_cÚf
 
	trc_hªdË
;

104 
	#AUTH_HDR_LEN
 20

	)

105 
	#CHAP_VALUE_LENGTH
 16

	)

107 
	#PW_AUTH_UDP_PORT
 1645

	)

108 
	#PW_ACCT_UDP_PORT
 1646

	)

110 
	#PW_TYPE_STRING
 0

	)

111 
	#PW_TYPE_INTEGER
 1

	)

112 
	#PW_TYPE_IPADDR
 2

	)

113 
	#PW_TYPE_DATE
 3

	)

117 
	#PW_ACCESS_REQUEST
 1

	)

118 
	#PW_ACCESS_ACCEPT
 2

	)

119 
	#PW_ACCESS_REJECT
 3

	)

120 
	#PW_ACCOUNTING_REQUEST
 4

	)

121 
	#PW_ACCOUNTING_RESPONSE
 5

	)

122 
	#PW_ACCOUNTING_STATUS
 6

	)

123 
	#PW_PASSWORD_REQUEST
 7

	)

124 
	#PW_PASSWORD_ACK
 8

	)

125 
	#PW_PASSWORD_REJECT
 9

	)

126 
	#PW_ACCOUNTING_MESSAGE
 10

	)

127 
	#PW_ACCESS_CHALLENGE
 11

	)

128 
	#PW_STATUS_SERVER
 12

	)

129 
	#PW_STATUS_CLIENT
 13

	)

134 
	#PW_USER_NAME
 1

	)

135 
	#PW_USER_PASSWORD
 2

	)

136 
	#PW_CHAP_PASSWORD
 3

	)

137 
	#PW_NAS_IP_ADDRESS
 4

	)

138 
	#PW_NAS_PORT
 5

	)

139 
	#PW_SERVICE_TYPE
 6

	)

140 
	#PW_FRAMED_PROTOCOL
 7

	)

141 
	#PW_FRAMED_IP_ADDRESS
 8

	)

142 
	#PW_FRAMED_IP_NETMASK
 9

	)

143 
	#PW_FRAMED_ROUTING
 10

	)

144 
	#PW_FILTER_ID
 11

	)

145 
	#PW_FRAMED_MTU
 12

	)

146 
	#PW_FRAMED_COMPRESSION
 13

	)

147 
	#PW_LOGIN_IP_HOST
 14

	)

148 
	#PW_LOGIN_SERVICE
 15

	)

149 
	#PW_LOGIN_PORT
 16

	)

150 
	#PW_OLD_PASSWORD
 17

	)

151 
	#PW_REPLY_MESSAGE
 18

	)

152 
	#PW_LOGIN_CALLBACK_NUMBER
 19

	)

153 
	#PW_FRAMED_CALLBACK_ID
 20

	)

154 
	#PW_EXPIRATION
 21

	)

155 
	#PW_FRAMED_ROUTE
 22

	)

156 
	#PW_FRAMED_IPX_NETWORK
 23

	)

157 
	#PW_STATE
 24

	)

158 
	#PW_CLASS
 25

	)

159 
	#PW_VENDOR_SPECIFIC
 26

	)

160 
	#PW_SESSION_TIMEOUT
 27

	)

161 
	#PW_IDLE_TIMEOUT
 28

	)

162 
	#PW_TERMINATION_ACTION
 29

	)

163 
	#PW_CALLED_STATION_ID
 30

	)

164 
	#PW_CALLING_STATION_ID
 31

	)

165 
	#PW_NAS_IDENTIFIER
 32

	)

166 
	#PW_PROXY_STATE
 33

	)

167 
	#PW_LOGIN_LAT_SERVICE
 34

	)

168 
	#PW_LOGIN_LAT_NODE
 35

	)

169 
	#PW_LOGIN_LAT_GROUP
 36

	)

170 
	#PW_FRAMED_APPLETALK_LINK
 37

	)

171 
	#PW_FRAMED_APPLETALK_NETWORK
 38

	)

172 
	#PW_FRAMED_APPLETALK_ZONE
 39

	)

173 
	#PW_EVENT_TIMESTAMP
 55

	)

174 
	#PW_CHAP_CHALLENGE
 60

	)

175 
	#PW_NAS_PORT_TYPE
 61

	)

176 
	#PW_PORT_LIMIT
 62

	)

177 
	#PW_LOGIN_LAT_PORT
 63

	)

178 
	#PW_CONNECT_INFO
 77

	)

183 
	#PW_MESSAGE_AUTHENTICATOR
 80

	)

188 
	#PW_NAS_IPV6_ADDRESS
 95

	)

189 
	#PW_FRAMED_INTERFACE_ID
 96

	)

190 
	#PW_FRAMED_IPV6_PREFIX
 97

	)

191 
	#PW_LOGIN_IPV6_HOST
 98

	)

192 
	#PW_FRAMED_IPV6_ROUTE
 99

	)

193 
	#PW_FRAMED_IPV6_POOL
 100

	)

197 
	#PW_ACCT_STATUS_TYPE
 40

	)

198 
	#PW_ACCT_DELAY_TIME
 41

	)

199 
	#PW_ACCT_INPUT_OCTETS
 42

	)

200 
	#PW_ACCT_OUTPUT_OCTETS
 43

	)

201 
	#PW_ACCT_SESSION_ID
 44

	)

202 
	#PW_ACCT_AUTHENTIC
 45

	)

203 
	#PW_ACCT_SESSION_TIME
 46

	)

204 
	#PW_ACCT_INPUT_PACKETS
 47

	)

205 
	#PW_ACCT_OUTPUT_PACKETS
 48

	)

206 
	#PW_ACCT_TERMINATE_CAUSE
 49

	)

207 
	#PW_ACCT_MULTI_SESSION_ID
 50

	)

208 
	#PW_ACCT_LINK_COUNT
 51

	)

213 
	#PW_ACCT_INPUT_GIGAWORDS
 52

	)

214 
	#PW_ACCT_OUTPUT_GIGAWORDS
 53

	)

218 
	#PW_DIGEST_RESPONSE
 206

	)

219 
	#PW_DIGEST_ATTRIBUTES
 207

	)

220 
	#PW_DIGEST_REALM
 1063

	)

221 
	#PW_DIGEST_NONCE
 1064

	)

222 
	#PW_DIGEST_METHOD
 1065

	)

223 
	#PW_DIGEST_URI
 1066

	)

224 
	#PW_DIGEST_QOP
 1067

	)

225 
	#PW_DIGEST_ALGORITHM
 1068

	)

226 
	#PW_DIGEST_BODY_DIGEST
 1069

	)

227 
	#PW_DIGEST_CNONCE
 1070

	)

228 
	#PW_DIGEST_NONCE_COUNT
 1071

	)

229 
	#PW_DIGEST_USER_NAME
 1072

	)

233 
	#PW_USER_ID
 222

	)

234 
	#PW_USER_REALM
 223

	)

240 
	#PW_LOGIN
 1

	)

241 
	#PW_FRAMED
 2

	)

242 
	#PW_CALLBACK_LOGIN
 3

	)

243 
	#PW_CALLBACK_FRAMED
 4

	)

244 
	#PW_OUTBOUND
 5

	)

245 
	#PW_ADMINISTRATIVE
 6

	)

246 
	#PW_NAS_PROMPT
 7

	)

247 
	#PW_AUTHENTICATE_ONLY
 8

	)

248 
	#PW_CALLBACK_NAS_PROMPT
 9

	)

252 
	#PW_PPP
 1

	)

253 
	#PW_SLIP
 2

	)

254 
	#PW_ARA
 3

	)

255 
	#PW_GANDALF
 4

	)

256 
	#PW_XYLOGICS
 5

	)

260 
	#PW_NONE
 0

	)

261 
	#PW_BROADCAST
 1

	)

262 
	#PW_LISTEN
 2

	)

263 
	#PW_BROADCAST_LISTEN
 3

	)

267 
	#PW_VAN_JACOBSON_TCP_IP
 1

	)

268 
	#PW_IPX_HEADER_COMPRESSION
 2

	)

272 
	#PW_TELNET
 0

	)

273 
	#PW_RLOGIN
 1

	)

274 
	#PW_TCP_CLEAR
 2

	)

275 
	#PW_PORTMASTER
 3

	)

276 
	#PW_LAT
 4

	)

277 
	#PW_X25_PAD
 5

	)

278 
	#PW_X25_T3POS
 6

	)

282 
	#PW_DEFAULT
 0

	)

283 
	#PW_RADIUS_REQUEST
 1

	)

287 
	#PW_DUMB
 0

	)

288 
	#PW_AUTH_ONLY
 3

	)

289 
	#PW_ALL
 255

	)

293 
	#PW_STATUS_START
 1

	)

294 
	#PW_STATUS_STOP
 2

	)

295 
	#PW_STATUS_ALIVE
 3

	)

296 
	#PW_STATUS_MODEM_START
 4

	)

297 
	#PW_STATUS_MODEM_STOP
 5

	)

298 
	#PW_STATUS_CANCEL
 6

	)

299 
	#PW_ACCOUNTING_ON
 7

	)

300 
	#PW_ACCOUNTING_OFF
 8

	)

304 
	#PW_USER_REQUEST
 1

	)

305 
	#PW_LOST_CARRIER
 2

	)

306 
	#PW_LOST_SERVICE
 3

	)

307 
	#PW_ACCT_IDLE_TIMEOUT
 4

	)

308 
	#PW_ACCT_SESSION_TIMEOUT
 5

	)

309 
	#PW_ADMIN_RESET
 6

	)

310 
	#PW_ADMIN_REBOOT
 7

	)

311 
	#PW_PORT_ERROR
 8

	)

312 
	#PW_NAS_ERROR
 9

	)

313 
	#PW_NAS_REQUEST
 10

	)

314 
	#PW_NAS_REBOOT
 11

	)

315 
	#PW_PORT_UNNEEDED
 12

	)

316 
	#PW_PORT_PREEMPTED
 13

	)

317 
	#PW_PORT_SUSPENDED
 14

	)

318 
	#PW_SERVICE_UNAVAILABLE
 15

	)

319 
	#PW_CALLBACK
 16

	)

320 
	#PW_USER_ERROR
 17

	)

321 
	#PW_HOST_REQUEST
 18

	)

325 
	#PW_ASYNC
 0

	)

326 
	#PW_SYNC
 1

	)

327 
	#PW_ISDN_SYNC
 2

	)

328 
	#PW_ISDN_SYNC_V120
 3

	)

329 
	#PW_ISDN_SYNC_V110
 4

	)

330 
	#PW_VIRTUAL
 5

	)

333 
	#PW_RADIUS
 1

	)

334 
	#PW_LOCAL
 2

	)

335 
	#PW_REMOTE
 3

	)

339 
	sdiù_©Œ


341 
	mÇme
[
NAME_LENGTH
 + 1];

342 
	mv®ue
;

343 
	mty³
;

344 
diù_©Œ
 *
	mÃxt
;

345 } 
	tDICT_ATTR
;

347 
	sdiù_v®ue


349 
	m©ŒÇme
[
NAME_LENGTH
 +1];

350 
	mÇme
[
NAME_LENGTH
 + 1];

351 
	mv®ue
;

352 
diù_v®ue
 *
	mÃxt
;

353 } 
	tDICT_VALUE
;

355 
	sdiù_v’dÜ


357 
	mv’dÜÇme
[
NAME_LENGTH
 +1];

358 
	mv’dÜ³c
;

359 
diù_v’dÜ
 *
	mÃxt
;

360 } 
	tDICT_VENDOR
;

362 
	sv®ue_·œ


364 
	mÇme
[
NAME_LENGTH
 + 1];

365 
	m©Œibu‹
;

366 
	mty³
;

367 
ušt32_t
 
	mlv®ue
;

368 
	m¡rv®ue
[
AUTH_STRING_LEN
 + 1];

369 
v®ue_·œ
 *
	mÃxt
;

370 } 
	tVALUE_PAIR
;

373 
	#MGMT_POLL_SECRET
 "H¬dlya£ü‘"

	)

377 
	#BADRESP_RC
 -2

	)

378 
	#ERROR_RC
 -1

	)

379 
	#OK_RC
 0

	)

380 
	#TIMEOUT_RC
 1

	)

381 
	#REJECT_RC
 2

	)

383 
	s£nd_d©a


385 
ušt8_t
 
	mcode
;

386 
ušt8_t
 
	m£q_nbr
;

387 *
	m£rv”
;

388 
	msvc_pÜt
;

389 *
	m£ü‘
;

390 
	mtimeout
;

391 
	m»Œ›s
;

392 
VALUE_PAIR
 *
	m£nd_·œs
;

393 
VALUE_PAIR
 *
	m»ûive_·œs
;

394 } 
	tSEND_DATA
;

396 #iâdeà
MIN


397 
	#MIN
(
a
, 
b
è(×è< (bè? (aè: (b))

	)

399 #iâdeà
MAX


400 
	#MAX
(
a
, 
b
è(×è> (bè? (aè: (b))

	)

403 #iâdeà
PATH_MAX


404 
	#PATH_MAX
 1024

	)

407 
	s’v


409 
	mmaxsize
, 
	msize
;

410 **
	m’v
;

411 } 
	tENV
;

413 
	#ENV_SIZE
 128

	)

415 
__BEGIN_DECLS


421 
VALUE_PAIR
 *
rc_av·œ_add
(cÚ¡ 
rc_hªdË
 *, VALUE_PAIR **, , *, , );

422 
rc_av·œ_assign
(
VALUE_PAIR
 *, *, );

423 
VALUE_PAIR
 *
rc_av·œ_Ãw
(cÚ¡ 
rc_hªdË
 *, , *, , );

424 
VALUE_PAIR
 *
rc_av·œ_g’
(cÚ¡ 
rc_hªdË
 *, VALUE_PAIR *, *, , );

425 
VALUE_PAIR
 *
rc_av·œ_g‘
(VALUE_PAIR *, , );

426 
rc_av·œ_š£¹
(
VALUE_PAIR
 **, VALUE_PAIR *, VALUE_PAIR *);

427 
rc_av·œ_ä“
(
VALUE_PAIR
 *);

428 
rc_av·œ_·r£
(cÚ¡ 
rc_hªdË
 *, *, 
VALUE_PAIR
 **);

429 
rc_av·œ_to¡r
(cÚ¡ 
rc_hªdË
 *, 
VALUE_PAIR
 *, *, , *, );

430 *
rc_av·œ_log
(
rc_hªdË
 *, 
VALUE_PAIR
 *);

431 
VALUE_PAIR
 *
rc_av·œ_»adš
(cÚ¡ 
rc_hªdË
 *, 
FILE
 *);

435 
rc_bud»q
(
rc_hªdË
 *, 
SEND_DATA
 *, , *, , *, , );

436 
rc_g‘_£qnbr
(
rc_hªdË
 *);

437 
rc_auth
(
rc_hªdË
 *, 
ušt32_t
, 
VALUE_PAIR
 *, VALUE_PAIR **, *);

438 
rc_auth_´oxy
(
rc_hªdË
 *, 
VALUE_PAIR
 *, VALUE_PAIR **, *);

439 
rc_acù
(
rc_hªdË
 *, 
ušt32_t
, 
VALUE_PAIR
 *);

440 
rc_acù_´oxy
(
rc_hªdË
 *, 
VALUE_PAIR
 *);

441 
rc_check
(
rc_hªdË
 *, *, *, , *);

445 
rc_»ad_m­fe
(
rc_hªdË
 *, *);

446 
ušt32_t
 
rc_m­2id
(
rc_hªdË
 *, *);

447 
rc_m­2id_ä“
(
rc_hªdË
 *);

451 
rc_hªdË
 *
rc_»ad_cÚfig
(*);

452 *
rc_cÚf_¡r
(
rc_hªdË
 *, *);

453 
rc_cÚf_št
(
rc_hªdË
 *, *);

454 
SERVER
 *
rc_cÚf_¤v
(
rc_hªdË
 *, *);

455 
rc_fšd_£rv”
(
rc_hªdË
 *, *, 
ušt32_t
 *, *);

456 
rc_cÚfig_ä“
(
rc_hªdË
 *);

457 
rc_add_cÚfig
(
rc_hªdË
 *, const *, const *, const *, const );

458 
rc_hªdË
 *
rc_cÚfig_š™
(rc_handle *);

459 
‹¡_cÚfig
(
rc_hªdË
 *, *);

463 
rc_»ad_diùiÚ¬y
(
rc_hªdË
 *, const *);

464 
DICT_ATTR
 *
rc_diù_g‘©Œ
(cÚ¡ 
rc_hªdË
 *, );

465 
DICT_ATTR
 *
rc_diù_fšd©Œ
(cÚ¡ 
rc_hªdË
 *, const *);

466 
DICT_VALUE
 *
rc_diù_fšdv®
(cÚ¡ 
rc_hªdË
 *, const *);

467 
DICT_VENDOR
 *
rc_diù_fšdv’d
(cÚ¡ 
rc_hªdË
 *, const *);

468 
DICT_VENDOR
 *
rc_diù_g‘v’d
(cÚ¡ 
rc_hªdË
 *, );

469 
DICT_VALUE
 * 
rc_diù_g‘v®
(cÚ¡ 
rc_hªdË
 *, 
ušt32_t
, const *);

470 
rc_diù_ä“
(
rc_hªdË
 *);

474 
ho¡’t
 *
rc_g‘ho¡byÇme
(const *);

475 
ho¡’t
 *
rc_g‘ho¡byaddr
(cÚ¡ *, 
size_t
, );

476 
ušt32_t
 
rc_g‘_addr
(*);

477 
rc_good_addr
(*);

478 cÚ¡ *
rc__ho¡Çme
(
ušt32_t
);

479 
rc_g‘pÜt
();

480 
rc_own_ho¡Çme
(*, );

481 
ušt32_t
 
rc_own_add»ss
(
rc_hªdË
 *);

482 
ušt32_t
 
rc_own_bšd_add»ss
(
rc_hªdË
 *);

483 
rc_g‘_¤ÿddr
(
sockaddr
 *, sockaddr *);

488 
rc_İ’log
(*);

489 
rc_log
(, const *, ...);

493 
rc_£nd_£rv”
(
rc_hªdË
 *, 
SEND_DATA
 *, *);

497 
rc_¡r2tm
(*, 
tm
 *);

498 *
rc_g‘iâame
(
rc_hªdË
 *, *);

499 *
rc_g‘¡r
(
rc_hªdË
 *, *, );

500 
rc_md–ay
();

501 *
rc_mksid
(
rc_hªdË
 *);

502 
rc_hªdË
 *
rc_Ãw
();

503 
rc_de¡roy
(
rc_hªdË
 *);

504 *
rc_fg‘Ê
(
FILE
 *, 
size_t
 *);

505 
rc_g‘ùime
();

509 
’v
 *
rc_Ãw_’v
();

510 
rc_ä“_’v
(
’v
 *);

511 
rc_add_’v
(
’v
 *, *, *);

512 
rc_impÜt_’v
(
’v
 *, **);

516 
rc_md5_ÿlc
(*, *, );

518 
rc_check_»¶y
 (
AUTH_HDR
 *, , *, *, );

519 
rc_¿ndom_veùÜ
(*);

520 
rc_·ck_li¡
 (
VALUE_PAIR
 *
vp
, cÚ¡ *
£ü‘
, 
AUTH_HDR
 *
auth
);

521 
rc_hmac_md5_ÿlc
(*, 
size_t
, *, size_t, *);

523 
	g__END_DECLS


	@radius/src/includes.h

17 
	~"r_cÚfig.h
"

20 #iâdeà
__GNUC__


21 #ià
HAVE_ALLOCA_H


22 
	~<®loÿ.h
>

24 #ifdeà
_AIX


25 #´agm¨
®loÿ


27 #iâdeà
®loÿ


28 *
®loÿ
 ();

34 
	~<sys/ty³s.h
>

36 
	~<ùy³.h
>

37 
	~<¡dio.h
>

38 
	~<”ºo.h
>

40 #ifdeà
HAVE_NETDB_H


41 
	~<Ãtdb.h
>

44 #ifdeà
HAVE_SYSLOG_H


45 
	~<sy¦og.h
>

48 #ifdeà
STDC_HEADERS


49 
	~<¡dlib.h
>

50 
	~<¡ršg.h
>

51 
	~<¡d¬g.h
>

53 
	~<¡d¬g.h
>

54 #iâdeà
HAVE_STRCHR


55 
	#¡rchr
 
šdex


	)

56 
	#¡¼chr
 
ršdex


	)

61 #iâdeà
HAVE_SNPRINTF


62 
	#¢´štf
(
buf
, 
Ën
, 
fÜm©
, ...è
	`¥rštf
(buf, fÜm©, 
__VA_ARGS__
)

	)

64 #iâdeà
HAVE_VSNPRINTF


65 
	#v¢´štf
(
buf
, 
Ën
, 
fÜm©
, 
­
è
	`v¥rštf
(buf, fÜm©,‡p)

	)

68 #ifdeà
HAVE_UNISTD_H


69 
	~<uni¡d.h
>

72 #ifdeà
HAVE_FCNTL_H


73 
	~<fú.h
>

76 #ifdeà
HAVE_SYS_FCNTL_H


77 
	~<sys/fú.h
>

80 #ifdeà
HAVE_SYS_FILE_H


81 
	~<sys/fe.h
>

84 #ifdeà
HAVE_SYS_STAT_H


85 
	~<sys/¡©.h
>

88 #ifdeà
HAVE_SYS_UTSNAME_H


89 
	~<sys/ut¢ame.h
>

92 #ifdeà
HAVE_SYS_IOCTL_H


93 
	~<sys/ioùl.h
>

96 #ifdeà
HAVE_CRYPT_H


97 
	~<üy±.h
>

100 #ifdeà
HAVE_LIMITS_H


101 
	~<lim™s.h
>

104 #ifdeà
HAVE_TERMIOS_H


105 
	~<‹rmios.h
>

108 #iâdeà
PATH_MAX


109 
	#PATH_MAX
 1024

	)

112 #iâdeà
UCHAR_MAX


113 #ifdeà 
__STDC__


114 
	#UCHAR_MAX
 255U

	)

116 
	#UCHAR_MAX
 255

	)

120 #ifdeà
HAVE_PWD_H


121 
	~<pwd.h
>

124 #ifdeà
HAVE_SYS_SOCKET_H


125 
	~<sys/sock‘.h
>

128 #ifdeà
HAVE_NETINET_IN_H


129 
	~<Ãtš‘/š.h
>

132 #ifdeà
HAVE_ARPA_INET_H


133 
	~<¬·/š‘.h
>

136 #ià
defšed
(
HAVE_SIGNAL_H
)

137 
	~<sigÇl.h
>

139 #ià
defšed
(
HAVE_SYS_SIGNAL_H
)

140 
	~<sys/sigÇl.h
>

143 #ifdeà
NEED_SIG_PROTOTYPES


144 
sigem±y£t
(
sig£t_t
 *);

145 
sigadd£t
(
sig£t_t
 *, );

146 
sig´ocmask
 (, 
sig£t_t
 *, sigset_t *);

149 #ià
HAVE_GETOPT_H


150 
	~<g‘İt.h
>

153 #ià
defšed
(
HAVE_SHADOW_H
è&& defšed(
HAVE_SHADOW_PASSWORDS
)

154 
	~<shadow.h
>

157 #ià
TIME_WITH_SYS_TIME


158 
	~<sys/time.h
>

159 
	~<time.h
>

161 #ià
HAVE_SYS_TIME_H


162 
	~<sys/time.h
>

164 
	~<time.h
>

173 #iâdeà
HAVE_RANDOM


174 #ifdeà
HAVE_RAND


175 
	#¤ªdom
 
¤ªd


	)

176 
	#¿ndom
 
¿nd


	)

180 
	#RC_CONFIG_FILE
 "./cÚf/¿diusş›Á.cÚf"

	)

183 
do_lock_exşusive
(
FILE
 *);

184 
do_uÆock
(
FILE
 *);

	@radius/src/ip_util.c

17 
	~<r_cÚfig.h
>

18 
	~<šşudes.h
>

19 
	~<ä“¿dius-ş›Á.h
>

21 #ià!
defšed
(
SA_LEN
)

22 
	#SA_LEN
(
§
) \

23 (((
§
)->
§_çmy
 =ğ
AF_INET
) ? \

24 (
sockaddr_š
è: (
sockaddr_š6
))

	)

35 
ho¡’t
 *
	$rc_g‘ho¡byÇme
(cÚ¡ *
ho¡Çme
)

37 
ho¡’t
 *
hp
;

38 #ifdeà
GETHOSTBYNAME_R


39 #ià
	`defšed
 (
GETHOSTBYNAMERSTYLE_SYSV
è|| defšed (
GETHOSTBYNAMERSTYLE_GNU
)

40 
ho¡’t
 
ho¡buf
;

41 
size_t
 
ho¡buæ’
;

42 *
tmpho¡buf
;

43 
»s
;

44 
h”r
;

46 
ho¡buæ’
 = 1024;

47 
tmpho¡buf
 = 
	`m®loc
(
ho¡buæ’
);

51 #ifdeà
GETHOSTBYNAME_R


52 #ià
	`defšed
 (
GETHOSTBYNAMERSTYLE_GNU
)

53 (
»s
 = 
	`g‘ho¡byÇme_r
(
ho¡Çme
, &
ho¡buf
, 
tmpho¡buf
, 
ho¡buæ’
, &
hp
, &
h”r
)è=ğ
ERANGE
)

56 
ho¡buæ’
 *= 2;

57 
tmpho¡buf
 = 
	`»®loc
Ñmpho¡buf, 
ho¡buæ’
);

59 
	`ä“
(
tmpho¡buf
);

60 #–ià
	`defšed
 (
GETHOSTBYNAMERSTYLE_SYSV
)

61 
hp
 = 
	`g‘ho¡byÇme_r
(
ho¡Çme
, &
ho¡buf
, 
tmpho¡buf
, 
ho¡buæ’
, &
h”r
);

62 
	`ä“
(
tmpho¡buf
);

64 
hp
 = 
	`g‘ho¡byÇme
(
ho¡Çme
);

67 
hp
 = 
	`g‘ho¡byÇme
(
ho¡Çme
);

70 ià(
hp
 =ğ
NULL
) {

71  
NULL
;

73  
hp
;

74 
	}
}

84 
ho¡’t
 *
	$rc_g‘ho¡byaddr
(cÚ¡ *
addr
, 
size_t
 
Ëngth
, 
fÜm©
)

86 
ho¡’t
 *
hp
;

87 #ifdeà
GETHOSTBYADDR_R


88 #ià
	`defšed
 (
GETHOSTBYADDRRSTYLE_SYSV
è|| defšed (
GETHOSTBYADDRRSTYLE_GNU
)

89 
ho¡’t
 
ho¡buf
;

90 
size_t
 
ho¡buæ’
;

91 *
tmpho¡buf
;

92 
»s
;

93 
h”r
;

95 
ho¡buæ’
 = 1024;

96 
tmpho¡buf
 = 
	`m®loc
(
ho¡buæ’
);

100 #ifdeà
GETHOSTBYADDR_R


101 #ià
	`defšed
 (
GETHOSTBYADDRRSTYLE_GNU
)

102 (
»s
 = 
	`g‘ho¡byaddr_r
(
addr
, 
Ëngth
, 
fÜm©
, &
ho¡buf
, 
tmpho¡buf
, 
ho¡buæ’
,

103 &
hp
, &
h”r
)è=ğ
ERANGE
)

106 
ho¡buæ’
 *= 2;

107 
tmpho¡buf
 = 
	`»®loc
Ñmpho¡buf, 
ho¡buæ’
);

109 
	`ä“
(
tmpho¡buf
);

110 #–ià
GETHOSTBYADDRSTYLE_SYSV


111 
hp
 = 
	`g‘ho¡byaddr_r
(
addr
, 
Ëngth
, 
fÜm©
, &
ho¡buf
, 
tmpho¡buf
, 
ho¡buæ’
, &
h”r
);

112 
	`ä“
(
tmpho¡buf
);

114 
hp
 = 
	`g‘ho¡byaddr
((*)&
addr
, (
š_addr
), 
AF_INET
);

117 
hp
 = 
	`g‘ho¡byaddr
((*)&
addr
, (
š_addr
), 
AF_INET
);

120 ià(
hp
 =ğ
NULL
) {

121  
NULL
;

123  
hp
;

124 
	}
}

135 
ušt32_t
 
	$rc_g‘_addr
 (*
ho¡
)

137 
ho¡’t
 *
hp
;

139 ià(
	`rc_good_addr
 (
ho¡
) == 0)

141  
	`Áohl
(
	`š‘_addr
 (
ho¡
));

143 ià((
hp
 = 
	`rc_g‘ho¡byÇme
(
ho¡
)è=ğ
NULL
)

145 
	`rc_log
(
LOG_ERR
,"rc_g‘_addr: couldn'ˆ»sŞvho¡Çme: %s", 
ho¡
);

146  (
ušt32_t
)0;

148  
	`Áohl
((*(
ušt32_t
 *è
hp
->
h_addr
));

149 
	}
}

160 
	$rc_good_addr
 (*
addr
)

162 
dÙ_couÁ
;

163 
dig™_couÁ
;

165 ià(
addr
 =ğ
NULL
)

168 
dÙ_couÁ
 = 0;

169 
dig™_couÁ
 = 0;

170 *
addr
 != '\0' && *addr != ' ')

172 ià(*
addr
 == '.')

174 
dÙ_couÁ
++;

175 
dig™_couÁ
 = 0;

177 ià(!
	`isdig™
 (*
addr
))

179 
dÙ_couÁ
 = 5;

183 
dig™_couÁ
++;

184 ià(
dig™_couÁ
 > 3)

186 
dÙ_couÁ
 = 5;

189 
addr
++;

191 ià(
dÙ_couÁ
 != 3)

199 
	}
}

209 cÚ¡ *
	$rc__ho¡Çme
 (
ušt32_t
 
h_addr
)

211 
ho¡’t
 *
hp
;

212 
ušt32_t
 
n_addr
 = 
	`htÚl
 (
h_addr
);

214 ià((
hp
 = 
	`rc_g‘ho¡byaddr
 ((*è&
n_addr
,  (
š_addr
),

215 
AF_INET
)è=ğ
NULL
) {

216 
	`rc_log
(
LOG_ERR
,"rc__ho¡Çme: couldn'ˆlook u°ho¡ by‡ddr: %08lX", 
h_addr
);

219  (
hp
 =ğ
NULL
è? "unknown" : hp->
h_Çme
;

220 
	}
}

229 
	$rc_g‘pÜt
(
ty³
)

231 
£rv’t
 *
svp
;

233 ià((
svp
 = 
	`g‘£rvbyÇme
 ((
ty³
==
AUTH
)?"¿dius":"¿dacù", "udp")è=ğ
NULL
)

235  (
ty³
==
AUTH
è? 
PW_AUTH_UDP_PORT
 : 
PW_ACCT_UDP_PORT
;

237  
	`Áohs
 ((è
svp
->
s_pÜt
);

239 
	}
}

251 
	$rc_own_ho¡Çme
(*
ho¡Çme
, 
Ën
)

253 #ifdeà
HAVE_UNAME


254 
ut¢ame
 
uts
;

257 #ià
	`defšed
(
HAVE_UNAME
)

258 ià(
	`uÇme
(&
uts
) < 0)

260 
	`rc_log
(
LOG_ERR
,"rc_own_hostname: couldn't get own hostname");

263 
	`¡ºıy
(
ho¡Çme
, 
uts
.
nod’ame
, 
Ën
);

264 #–ià
	`defšed
(
HAVE_GETHOSTNAME
)

265 ià(
	`g‘ho¡Çme
(
ho¡Çme
, 
Ën
) < 0)

267 
	`rc_log
(
LOG_ERR
,"rc_own_hostname: couldn't get own hostname");

270 #–ià
	`defšed
(
HAVE_SYSINFO
)

271 ià(
	`sysšfo
(
SI_HOSTNAME
, 
ho¡Çme
, 
Ën
) < 0)

273 
	`rc_log
(
LOG_ERR
,"rc_own_hostname: couldn't get own hostname");

281 
	}
}

292 
ušt32_t
 
	$rc_own_add»ss
(
rc_hªdË
 *
rh
)

294 
ho¡Çme
[256];

296 ià(!
rh
->
this_ho¡_addr
) {

297 ià(
	`rc_cÚf_¡r
(
rh
, "bšdaddr"è=ğ
NULL
 ||

298 
	`¡rcmp
(
	`rc_cÚf_¡r
(
rh
, "bindaddr"), "*") == 0) {

299 ià(
	`rc_own_ho¡Çme
(
ho¡Çme
, (hostname)) < 0)

302 
	`¡ºıy
(
ho¡Çme
, 
	`rc_cÚf_¡r
(
rh
, "bindaddr"), (hostname));

303 
ho¡Çme
[(hostname) - 1] = '\0';

305 ià((
rh
->
this_ho¡_addr
 = 
	`rc_g‘_addr
 (
ho¡Çme
)) == 0) {

306 
	`rc_log
(
LOG_ERR
, "rc_own_ipaddress: couldn't get own IP‡ddress");

311  
rh
->
this_ho¡_addr
;

312 
	}
}

324 
ušt32_t
 
	$rc_own_bšd_add»ss
(
rc_hªdË
 *
rh
)

326 
ho¡Çme
[256];

327 
ušt32_t
 
rv®
;

329 ià(
rh
->
this_ho¡_bšd_addr
 !ğ
NULL
)

330  *
rh
->
this_ho¡_bšd_addr
;

332 
rh
->
this_ho¡_bšd_addr
 = 
	`m®loc
((*rh->this_host_bind_ipaddr));

333 ià(
rh
->
this_ho¡_bšd_addr
 =ğ
NULL
)

334 
	`rc_log
(
LOG_CRIT
, "rc_own_bind_ipaddress: out of memory");

335 ià(
	`rc_cÚf_¡r
(
rh
, "bšdaddr"è=ğ
NULL
 ||

336 
	`¡rcmp
(
	`rc_cÚf_¡r
(
rh
, "bindaddr"), "*") == 0) {

337 
rv®
 = 
INADDR_ANY
;

339 
	`¡ºıy
(
ho¡Çme
, 
	`rc_cÚf_¡r
(
rh
, "bindaddr"), (hostname));

340 
ho¡Çme
[(hostname) - 1] = '\0';

341 ià((
rv®
 = 
	`rc_g‘_addr
 (
ho¡Çme
)) == 0) {

342 
	`rc_log
(
LOG_ERR
, "rc_own_ipaddress: couldn't get IP‡ddress from bindaddr");

343 
rv®
 = 
INADDR_ANY
;

346 ià(
rh
->
this_ho¡_bšd_addr
 !ğ
NULL
)

347 *
rh
->
this_ho¡_bšd_addr
 = 
rv®
;

349  
rv®
;

350 
	}
}

364 
	$rc_g‘_¤ÿddr
(
sockaddr
 *
lŸ
, sockadd¸*
rŸ
)

366 
‹mp_sock
;

367 
sockËn_t
 
Çm–’
;

369 
‹mp_sock
 = 
	`sock‘
(
rŸ
->
§_çmy
, 
SOCK_DGRAM
, 0);

370 ià(
‹mp_sock
 == -1) {

371 
	`rc_log
(
LOG_ERR
, "rc_g‘_¤ÿddr: sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

375 ià(
	`cÚÃù
(
‹mp_sock
, 
rŸ
, 
	`SA_LEN
(ria)) != 0) {

376 
	`rc_log
(
LOG_ERR
, "rc_get_srcaddr: connect: %s",

377 
	`¡»¼Ü
(
”ºo
));

378 
	`şo£
(
‹mp_sock
);

382 
Çm–’
 = 
	`SA_LEN
(
rŸ
);

383 ià(
	`g‘sockÇme
(
‹mp_sock
, 
lŸ
, &
Çm–’
) != 0) {

384 
	`rc_log
(
LOG_ERR
, "rc_get_srcaddr: getsockname: %s",

385 
	`¡»¼Ü
(
”ºo
));

386 
	`şo£
(
‹mp_sock
);

390 
	`şo£
(
‹mp_sock
);

392 
	}
}

	@radius/src/lock.c

12 
	~"r_cÚfig.h
"

13 
	~"šşudes.h
"

15 #ià
defšed
(
HAVE_FLOCK
)

17 
	$do_lock_exşusive
(
FILE
 * 
fd
)

19  
	`æock
(
	`f’o
(
fd
), 
LOCK_EX
|
LOCK_NB
);

20 
	}
}

22 
	$do_uÆock
(
FILE
 * 
fd
)

24  
	`æock
(
	`f’o
(
fd
), 
LOCK_UN
);

25 
	}
}

27 #–ià
defšed
(
WIN32
)

29 
	$do_lock_exşusive
(
FILE
 * 
fd
)

31 
	`_lock_fe
(
fd
);

33 
	}
}

35 
	$do_uÆock
(
FILE
 * 
fd
)

37 
	`_uÆock_fe
(
fd
);

39 
	}
}

41 #–ià
defšed
(
HAVE_FCNTL
)

43 
	$do_lock_exşusive
(
FILE
 * 
fd
)

45 
æock_t
 
æ
;

46 
»s
;

48 
	`mem£t
((*)&
æ
, 0, (fl));

50 
æ
.
l_ty³
 = 
F_WRLCK
;

51 
æ
.
l_wh’û
 = fl.
l_¡¬t
 = 0;

52 
æ
.
l_Ën
 = 0;

54 
»s
 = 
	`fú
(
	`f’o
(
fd
), 
F_SETLK
, &
æ
);

56 ià((
»s
 =ğ-1è&& (
”ºo
 =ğ
EAGAIN
))

57 
”ºo
 = 
EWOULDBLOCK
;

59  
»s
;

60 
	}
}

62 
	$do_uÆock
(
FILE
 * 
fd
)

64 
æock_t
 
æ
;

66 
	`mem£t
((*)&
æ
, 0, (fl));

68 
æ
.
l_ty³
 = 
F_UNLCK
;

69 
æ
.
l_wh’û
 = fl.
l_¡¬t
 = 0;

70 
æ
.
l_Ën
 = 0;

72  
	`fú
(
	`f’o
(
fd
), 
F_SETLK
, &
æ
);

73 
	}
}

76 #”rÜ 
YOU_LOSE
 "needƒither flock(2) or fcntl(2)"

	@radius/src/log.c

12 
	~<r_cÚfig.h
>

13 
	~<šşudes.h
>

14 
	~<ä“¿dius-ş›Á.h
>

27 
	$rc_İ’log
(*
id’t
)

29 #iâdeà
_MSC_VER


30 
	`İ’log
(
id’t
, 
LOG_PID
, 
LOG_DAEMON
);

32 
	}
}

45 
	$rc_log
(
´io
, cÚ¡ *
fÜm©
, ...)

47 
buff
[1024];

48 
va_li¡
 
­
;

50 
	`va_¡¬t
(
­
,
fÜm©
);

51 
	`v¢´štf
(
buff
, (buff), 
fÜm©
, 
­
);

52 
	`va_’d
(
­
);

55 #iâdeà
_MSC_VER


56 
	`sy¦og
(
´io
, "%s", 
buff
);

59 
	`årštf
(
¡dout
, "%s\n", 
buff
);

61 
	}
}

	@radius/src/md5.c

13 
	~"md5.h
"

15 
rc_md5_ÿlc
(*
ouut
, *
šput
,

16 
size_t
 
špu’
);

18 
	$rc_md5_ÿlc
(*
ouut
, *
šput
,

19 
size_t
 
šËn
)

21 
MD5_CTX
 
cÚ‹xt
;

23 
	`MD5In™
(&
cÚ‹xt
);

24 
	`MD5Upd©e
(&
cÚ‹xt
, 
šput
, 
šËn
);

25 
	`MD5Fš®
(
ouut
, &
cÚ‹xt
);

26 
	}
}

34 
	$rc_hmac_md5_ÿlc
(*
šput
, 
size_t
 
šput_Ën
,

35 *
key
, 
size_t
 
key_Ën
,

36 *
ouut
)

38 
MD5_CTX
 
ùx
;

39 
k_ad
[65];

40 
k_İad
[65];

41 
tk
[16];

42 
i
;

45 ià(
key_Ën
 > 64) {

46 
	`rc_md5_ÿlc
(
tk
, 
key
, 
key_Ën
);

47 
key
 = 
tk
;

48 
key_Ën
 = 16;

52 
	`mem£t
(
k_ad
, 0, (k_ipad));

53 
	`mem£t
(
k_İad
, 0, (k_opad));

54 
	`memıy
(
k_ad
, 
key
, 
key_Ën
);

55 
	`memıy
(
k_İad
, 
key
, 
key_Ën
);

58 
i
=0; i<64; i++) {

59 
k_ad
[
i
] ^= 0x36;

60 
k_İad
[
i
] ^= 0x5c;

66 
	`MD5In™
(&
ùx
);

67 
	`MD5Upd©e
(&
ùx
, 
k_ad
, 64);

68 
	`MD5Upd©e
(&
ùx
, 
šput
, 
šput_Ën
);

69 
	`MD5Fš®
(
ouut
, &
ùx
);

72 
	`MD5In™
(&
ùx
);

73 
	`MD5Upd©e
(&
ùx
, 
k_İad
, 64);

74 
	`MD5Upd©e
(&
ùx
, 
ouut
, 16);

75 
	`MD5Fš®
(
ouut
, &
ùx
);

76 
	}
}

108 
	#PUT_64BIT_LE
(
ı
, 
v®ue
) do { \

109 (
ı
)[7] = (
v®ue
)[1] >> 24; \

110 (
ı
)[6] = (
v®ue
)[1] >> 16; \

111 (
ı
)[5] = (
v®ue
)[1] >> 8; \

112 (
ı
)[4] = (
v®ue
)[1]; \

113 (
ı
)[3] = (
v®ue
)[0] >> 24; \

114 (
ı
)[2] = (
v®ue
)[0] >> 16; \

115 (
ı
)[1] = (
v®ue
)[0] >> 8; \

116 (
ı
)[0] = (
v®ue
)[0]; } 0)

	)

118 
	#PUT_32BIT_LE
(
ı
, 
v®ue
) do { \

119 (
ı
)[3] = (
v®ue
) >> 24; \

120 (
ı
)[2] = (
v®ue
) >> 16; \

121 (
ı
)[1] = (
v®ue
) >> 8; \

122 (
ı
)[0] = (
v®ue
); } 0)

	)

124 
ušt8_t
 
	gPADDING
[
MD5_BLOCK_LENGTH
] = {

135 
	$MD5In™
(
MD5_CTX
 *
ùx
)

137 
ùx
->
couÁ
[0] = 0;

138 
ùx
->
couÁ
[1] = 0;

139 
ùx
->
¡©e
[0] = 0x67452301;

140 
ùx
->
¡©e
[1] = 0xefcdab89;

141 
ùx
->
¡©e
[2] = 0x98badcfe;

142 
ùx
->
¡©e
[3] = 0x10325476;

143 
	}
}

150 
	$MD5Upd©e
(
MD5_CTX
 *
ùx
, cÚ¡ *
šput
, 
size_t
 
Ën
)

152 
size_t
 
have
, 
Ãed
;

155 
have
 = (
size_t
)((
ùx
->
couÁ
[0] >> 3è& (
MD5_BLOCK_LENGTH
 - 1));

156 
Ãed
 = 
MD5_BLOCK_LENGTH
 - 
have
;

160 ià((
ùx
->
couÁ
[0] +ğ((
ušt32_t
)
Ën
 << 3)) < (uint32_t)len) {

162 
ùx
->
couÁ
[1]++;

164 
ùx
->
couÁ
[1] +ğ((
ušt32_t
)
Ën
 >> 29);

168 ià(
Ën
 >ğ
Ãed
) {

169 ià(
have
 != 0) {

170 
	`memıy
(
ùx
->
bufãr
 + 
have
, 
šput
, 
Ãed
);

171 
	`MD5T¿nsfÜm
(
ùx
->
¡©e
, ctx->
bufãr
);

172 
šput
 +ğ
Ãed
;

173 
Ën
 -ğ
Ãed
;

174 
have
 = 0;

178 
Ën
 >ğ
MD5_BLOCK_LENGTH
) {

179 
	`MD5T¿nsfÜm
(
ùx
->
¡©e
, 
šput
);

180 
šput
 +ğ
MD5_BLOCK_LENGTH
;

181 
Ën
 -ğ
MD5_BLOCK_LENGTH
;

186 ià(
Ën
 != 0)

187 
	`memıy
(
ùx
->
bufãr
 + 
have
, 
šput
, 
Ën
);

188 
	}
}

195 
	$MD5Fš®
(
dige¡
[
MD5_DIGEST_LENGTH
], 
MD5_CTX
 *
ùx
)

197 
ušt8_t
 
couÁ
[8];

198 
size_t
 
·dËn
;

199 
i
;

202 
	`PUT_64BIT_LE
(
couÁ
, 
ùx
->count);

205 
·dËn
 = 
MD5_BLOCK_LENGTH
 -

206 ((
ùx
->
couÁ
[0] >> 3è& (
MD5_BLOCK_LENGTH
 - 1));

207 ià(
·dËn
 < 1 + 8)

208 
·dËn
 +ğ
MD5_BLOCK_LENGTH
;

209 
	`MD5Upd©e
(
ùx
, 
PADDING
, 
·dËn
 - 8);

210 
	`MD5Upd©e
(
ùx
, 
couÁ
, 8);

212 ià(
dige¡
 !ğ
NULL
) {

213 
i
 = 0; i < 4; i++)

214 
	`PUT_32BIT_LE
(
dige¡
 + 
i
 * 4, 
ùx
->
¡©e
[i]);

216 
	`mem£t
(
ùx
, 0, (*ctx));

217 
	}
}

223 
	#F1
(
x
, 
y
, 
z
è(z ^ (x & (y ^ z)))

	)

224 
	#F2
(
x
, 
y
, 
z
è
	`F1
(z, x, y)

	)

225 
	#F3
(
x
, 
y
, 
z
è(x ^ y ^ z)

	)

226 
	#F4
(
x
, 
y
, 
z
è(y ^ (x | ~z))

	)

229 
	#MD5STEP
(
f
, 
w
, 
x
, 
y
, 
z
, 
d©a
, 
s
) \

230 Ğ
w
 +ğ
	`f
(
x
, 
y
, 
z
è+ 
d©a
, w = w<<
s
 | w>>(32-s), w +ğx )

	)

238 
	$MD5T¿nsfÜm
(
ušt32_t
 
¡©e
[4], cÚ¡ 
ušt8_t
 
block
[
MD5_BLOCK_LENGTH
])

240 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
š
[
MD5_BLOCK_LENGTH
 / 4];

242 
a
 = 0;‡ < 
MD5_BLOCK_LENGTH
 / 4;‡++) {

243 
š
[
a
] = (
ušt32_t
)(

244 (
ušt32_t
)(
block
[
a
 * 4 + 0]) |

245 (
ušt32_t
)(
block
[
a
 * 4 + 1]) << 8 |

246 (
ušt32_t
)(
block
[
a
 * 4 + 2]) << 16 |

247 (
ušt32_t
)(
block
[
a
 * 4 + 3]) << 24);

250 
a
 = 
¡©e
[0];

251 
b
 = 
¡©e
[1];

252 
c
 = 
¡©e
[2];

253 
d
 = 
¡©e
[3];

255 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[ 0] + 0xd76aa478, 7);

256 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[ 1] + 0xe8c7b756, 12);

257 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[ 2] + 0x242070db, 17);

258 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[ 3] + 0xc1bdceee, 22);

259 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[ 4] + 0xf57c0faf, 7);

260 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[ 5] + 0x4787c62a, 12);

261 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[ 6] + 0xa8304613, 17);

262 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[ 7] + 0xfd469501, 22);

263 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[ 8] + 0x698098d8, 7);

264 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[ 9] + 0x8b44f7af, 12);

265 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[10] + 0xffff5bb1, 17);

266 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[11] + 0x895cd7be, 22);

267 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[12] + 0x6b901122, 7);

268 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[13] + 0xfd987193, 12);

269 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[14] + 0xa679438e, 17);

270 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[15] + 0x49b40821, 22);

272 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[ 1] + 0xf61e2562, 5);

273 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[ 6] + 0xc040b340, 9);

274 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[11] + 0x265e5a51, 14);

275 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[ 0] + 0xe9b6c7aa, 20);

276 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[ 5] + 0xd62f105d, 5);

277 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[10] + 0x02441453, 9);

278 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[15] + 0xd8a1e681, 14);

279 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[ 4] + 0xe7d3fbc8, 20);

280 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[ 9] + 0x21e1cde6, 5);

281 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[14] + 0xc33707d6, 9);

282 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[ 3] + 0xf4d50d87, 14);

283 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[ 8] + 0x455a14ed, 20);

284 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[13] + 0xa9e3e905, 5);

285 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[ 2] + 0xfcefa3f8, 9);

286 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[ 7] + 0x676f02d9, 14);

287 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[12] + 0x8d2a4c8a, 20);

289 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[ 5] + 0xfffa3942, 4);

290 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[ 8] + 0x8771f681, 11);

291 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[11] + 0x6d9d6122, 16);

292 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[14] + 0xfde5380c, 23);

293 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[ 1] + 0xa4beea44, 4);

294 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[ 4] + 0x4bdecfa9, 11);

295 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[ 7] + 0xf6bb4b60, 16);

296 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[10] + 0xbebfbc70, 23);

297 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[13] + 0x289b7ec6, 4);

298 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[ 0] + 0xeaa127fa, 11);

299 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[ 3] + 0xd4ef3085, 16);

300 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[ 6] + 0x04881d05, 23);

301 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[ 9] + 0xd9d4d039, 4);

302 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[12] + 0xe6db99e5, 11);

303 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[15] + 0x1fa27cf8, 16);

304 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[2 ] + 0xc4ac5665, 23);

306 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[ 0] + 0xf4292244, 6);

307 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[7 ] + 0x432aff97, 10);

308 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[14] + 0xab9423a7, 15);

309 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[5 ] + 0xfc93a039, 21);

310 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[12] + 0x655b59c3, 6);

311 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[3 ] + 0x8f0ccc92, 10);

312 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[10] + 0xffeff47d, 15);

313 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[1 ] + 0x85845dd1, 21);

314 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[8 ] + 0x6fa87e4f, 6);

315 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[15] + 0xfe2ce6e0, 10);

316 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[6 ] + 0xa3014314, 15);

317 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[13] + 0x4e0811a1, 21);

318 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[4 ] + 0xf7537e82, 6);

319 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[11] + 0xbd3af235, 10);

320 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[2 ] + 0x2ad7d2bb, 15);

321 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[9 ] + 0xeb86d391, 21);

323 
¡©e
[0] +ğ
a
;

324 
¡©e
[1] +ğ
b
;

325 
¡©e
[2] +ğ
c
;

326 
¡©e
[3] +ğ
d
;

327 
	}
}

	@radius/src/md5.h

9 #iâdeà
_RCRAD_MD5_H


10 
	#_RCRAD_MD5_H


	)

12 
	~"r_cÚfig.h
"

14 #ifdeà
HAVE_INTTYPES_H


15 
	~<š‰y³s.h
>

18 #ifdeà
HAVE_SYS_TYPES_H


19 
	~<sys/ty³s.h
>

22 #ifdeà
HAVE_STDINT_H


23 
	~<¡dšt.h
>

26 
	~<¡ršg.h
>

31 
	#MD5_CTX
 
lib¿d_MD5_CTX


	)

32 
	#MD5In™
 
lib¿d_MD5In™


	)

33 
	#MD5Upd©e
 
lib¿d_MD5Upd©e


	)

34 
	#MD5Fš®
 
lib¿d_MD5Fš®


	)

35 
	#MD5T¿nsfÜm
 
lib¿d_MD5T¿nsfÜm


	)

56 
	#MD5_BLOCK_LENGTH
 64

	)

57 
	#MD5_DIGEST_LENGTH
 16

	)

59 
	sMD5CÚ‹xt
 {

60 
ušt32_t
 
	m¡©e
[4];

61 
ušt32_t
 
	mcouÁ
[2];

62 
ušt8_t
 
	mbufãr
[
MD5_BLOCK_LENGTH
];

63 } 
	tMD5_CTX
;

68 
MD5In™
(
MD5_CTX
 *);

69 
MD5Upd©e
(
MD5_CTX
 *, cÚ¡ 
ušt8_t
 *, 
size_t
)

71 
MD5Fš®
(
ušt8_t
 [
MD5_DIGEST_LENGTH
], 
MD5_CTX
 *)

73 
MD5T¿nsfÜm
(
ušt32_t
 [4], cÚ¡ 
ušt8_t
 [
MD5_BLOCK_LENGTH
])

	@radius/src/messages.h

22 #iâdeà
MESSAGES_H


23 
	#MESSAGES_H


	)

27 
	#SC_LOGIN
 "logš: "

	)

28 
	#SC_PASSWORD
 "PasswÜd: "

	)

30 
	#SC_TIMEOUT
 "\r\Æogšimed ouˆaá” %d secÚds. Bye.\r\n"

	)

31 
	#SC_EXCEEDED
 "Maximum†ogšr› exûeded. GØaway!\r\n"

	)

33 
	#SC_RADIUS_OK
 "RADIUS: Auth’tiÿtiÚ OK\r\n"

	)

34 
	#SC_RADIUS_FAILED
 "RADIUS: Auth’tiÿtiÚ fau»\r\n"

	)

36 
	#SC_LOCAL_OK
 "loÿl: Auth’tiÿtiÚ OK\r\n"

	)

37 
	#SC_LOCAL_FAILED
 "loÿl: Auth’tiÿtiÚ fau»\r\n"

	)

38 
	#SC_NOLOGIN
 "\r\nSy¡em clo£d fÜ maš‹Çnû. Try‡gaš†©”...\r\n"

	)

40 
	#SC_SERVER_REPLY
 "RADIUS: %s"

	)

42 
	#SC_DEFAULT_ISSUE
 "(\\I)\r\n\r\n\\S \\R (\\NèÕÜˆ\\L)\r\n\r\n"

	)

46 
	#SC_ACCT_OK
 "RADIUS‡ccouÁšg OK\r\n"

	)

47 
	#SC_ACCT_FAILED
 "RADIUS‡ccouÁšg faed (RC=%i)\r\n"

	)

51 
	#SC_STATUS_FAILED
 "RADIUS: Stu çu»\r\n"

	)

	@radius/src/options.h

12 
	#OPTION_LEN
 64

	)

15 
	#OT_STR
 (1<<0è

	)

16 
	#OT_INT
 (1<<1è

	)

17 
	#OT_SRV
 (1<<2è

	)

18 
	#OT_AUO
 (1<<3è

	)

20 
	#OT_ANY
 (()~0è

	)

23 
	#ST_UNDEF
 (1<<0è

	)

25 
	s_İtiÚ
 {

26 
	mÇme
[
OPTION_LEN
];

27 
	mty³
, 
	m¡©us
;

28 *
	mv®
;

29 } 
	tOPTION
;

31 
OPTION
 
	gcÚfig_İtiÚs_deçuÉ
[] = {

33 {"cÚfig_fe", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

35 {"auth_Üd”", 
OT_AUO
, 
ST_UNDEF
, 
NULL
},

36 {"logš_Œ›s", 
OT_INT
, 
ST_UNDEF
, 
NULL
},

37 {"logš_timeout", 
OT_INT
, 
ST_UNDEF
, 
NULL
},

38 {"nŞogš", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

39 {"issue", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

41 {"auth£rv”", 
OT_SRV
, 
ST_UNDEF
, 
NULL
},

42 {"acù£rv”", 
OT_SRV
, 
ST_UNDEF
, 
NULL
},

43 {"£rv”s", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

44 {"diùiÚ¬y", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

45 {"logš_¿dius", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

46 {"£qfe", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

47 {"m­fe", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

48 {"deçuÉ_»®m", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

49 {"¿dius_timeout", 
OT_INT
, 
ST_UNDEF
, 
NULL
},

50 {"¿dius_»Œ›s", 
OT_INT
, 
ST_UNDEF
, 
NULL
},

51 {"¿dius_d—dtime", 
OT_INT
, 
ST_UNDEF
, 
NULL
},

52 {"bšdaddr", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

54 {"logš_loÿl", 
OT_STR
, 
ST_UNDEF
, 
NULL
},

57 
	#NUM_OPTIONS
 (((
cÚfig_İtiÚs_deçuÉ
))/((cÚfig_İtiÚs_deçuÉ[0])))

	)

	@radius/src/pathnames.h

17 #iâdeà
PATHNAMES_H


18 
	#PATHNAMES_H


	)

20 
	#_PATH_DEV_URANDOM
 "/dev/u¿ndom"

	)

21 
	#_PATH_ETC_ISSUE
 "/‘c/issue"

	)

24 #iâdeà
_PATH_ETC_RADIUSCLIENT_CONF


25 
	#_PATH_ETC_RADIUSCLIENT_CONF
 "/‘c/¿diusş›Á.cÚf"

	)

	@radius/src/r_config.h

1 
	#GETHOSTBYADDRRSTYLE_GNU


	)

2 
	#GETHOSTBYADDR_R
 1

	)

3 
	#GETHOSTBYNAMERSTYLE_GNU


	)

4 
	#GETHOSTBYNAME_R


	)

5 
	#HAVE_ALLOCA
 1

	)

6 
	#HAVE_ALLOCA_H
 1

	)

7 
	#HAVE_ARPA_INET_H
 1

	)

8 
	#HAVE_CRYPT_H
 1

	)

9 
	#HAVE_DEV_URANDOM
 1

	)

10 
	#HAVE_DIRENT_H
 1

	)

11 
	#HAVE_DLFCN_H
 1

	)

12 
	#HAVE_FCNTL
 1

	)

13 
	#HAVE_FCNTL_H
 1

	)

14 
	#HAVE_FLOCK
 1

	)

15 
	#HAVE_GETDOMAINNAME
 1

	)

16 
	#HAVE_GETHOSTNAME
 1

	)

17 
	#HAVE_GETOPT_H
 1

	)

18 
	#HAVE_INTTYPES_H
 1

	)

19 
	#HAVE_LIBCRYPT
 1

	)

20 
	#HAVE_LIBNSL
 1

	)

21 
	#HAVE_MEMORY_H
 1

	)

22 
	#HAVE_NETDB_H
 1

	)

23 
	#HAVE_NETINET_IN_H
 1

	)

24 
	#HAVE_PWD_H
 1

	)

25 
	#HAVE_RAND
 1

	)

26 
	#HAVE_RANDOM
 1

	)

27 
	#HAVE_SIGNAL_H
 1

	)

28 
	#HAVE_SNPRINTF
 1

	)

29 
	#HAVE_STDINT_H
 1

	)

30 
	#HAVE_STDLIB_H
 1

	)

31 
	#HAVE_STRCASECMP
 1

	)

32 
	#HAVE_STRDUP
 1

	)

33 
	#HAVE_STRERROR
 1

	)

34 
	#HAVE_STRFTIME
 1

	)

35 
	#HAVE_STRINGS_H
 1

	)

36 
	#HAVE_STRING_H
 1

	)

37 
	#HAVE_SYSINFO
 1

	)

38 
	#HAVE_SYSLOG_H
 1

	)

39 
	#HAVE_SYS_FCNTL_H
 1

	)

40 
	#HAVE_SYS_FILE_H
 1

	)

41 
	#HAVE_SYS_IOCTL_H
 1

	)

42 
	#HAVE_SYS_SIGNAL_H
 1

	)

43 
	#HAVE_SYS_SOCKET_H
 1

	)

44 
	#HAVE_SYS_STAT_H
 1

	)

45 
	#HAVE_SYS_TYPES_H
 1

	)

46 
	#HAVE_SYS_UTSNAME_H
 1

	)

47 
	#HAVE_TERMIOS_H
 1

	)

48 
	#HAVE_UNAME
 1

	)

49 
	#HAVE_UNISTD_H
 1

	)

50 
	#HAVE_VSNPRINTF
 1

	)

52 
	#PACKAGE
 "¿diusş›Á"

	)

53 
	#PACKAGE_BUGREPORT
 ""

	)

54 
	#PACKAGE_NAME
 ""

	)

55 
	#PACKAGE_STRING
 ""

	)

56 
	#PACKAGE_TARNAME
 ""

	)

57 
	#PACKAGE_VERSION
 ""

	)

58 
	#PROTOTYPES
 1

	)

59 
	#RETSIGTYPE
 

	)

60 
	#STDC_HEADERS
 1

	)

61 
	#TIME_WITH_SYS_TIME
 1

	)

62 
	#VERSION
 "1.1.6"

	)

63 
	#__PROTOTYPES
 1

	)

	@radius/src/sendserver.c

17 
	~<r_cÚfig.h
>

18 
	~<šşudes.h
>

19 
	~<ä“¿dius-ş›Á.h
>

20 
	~<·thÇmes.h
>

22 
	#SA
(
p
è((
sockaddr
 *)Õ))

	)

24 
rc_¿ndom_veùÜ
 (*);

25 
rc_check_»¶y
 (
AUTH_HDR
 *, , *, *, );

36 
	$rc_·ck_li¡
 (
VALUE_PAIR
 *
vp
, cÚ¡ *
£ü‘
, 
AUTH_HDR
 *
auth
)

38 
Ëngth
, 
i
, 
pc
, 
·dded_Ëngth
;

39 
tÙ®_Ëngth
 = 0;

40 
size_t
 
£ü‘Ën
;

41 
ušt32_t
 
lv®ue
, 
v’dÜ
;

42 
·ssbuf
[
	`MAX
(
AUTH_PASS_LEN
, 
CHAP_VALUE_LENGTH
)];

43 
md5buf
[256];

44 *
buf
, *
veùÜ
, *
v§_Ëngth_±r
;

46 
buf
 = 
auth
->
d©a
;

48 
vp
 !ğ
NULL
)

50 
v§_Ëngth_±r
 = 
NULL
;

51 ià(
	`VENDOR
(
vp
->
©Œibu‹
) != 0) {

52 *
buf
++ = 
PW_VENDOR_SPECIFIC
;

53 
v§_Ëngth_±r
 = 
buf
;

54 *
buf
++ = 6;

55 
v’dÜ
 = 
	`htÚl
(
	`VENDOR
(
vp
->
©Œibu‹
));

56 
	`memıy
(
buf
, &
v’dÜ
, (
ušt32_t
));

57 
buf
 += 4;

58 
tÙ®_Ëngth
 += 6;

60 *
buf
++ = (
vp
->
©Œibu‹
 & 0xff);

62 
vp
->
©Œibu‹
)

64 
PW_USER_PASSWORD
:

69 
Ëngth
 = 
vp
->
lv®ue
;

70 ià(
Ëngth
 > 
AUTH_PASS_LEN
)

71 
Ëngth
 = 
AUTH_PASS_LEN
;

74 
·dded_Ëngth
 = (
Ëngth
+(
AUTH_VECTOR_LEN
-1)) & ~(AUTH_VECTOR_LEN-1);

77 *
buf
++ = 
·dded_Ëngth
 + 2;

78 ià(
v§_Ëngth_±r
 !ğ
NULL
è*v§_Ëngth_±¸+ğ
·dded_Ëngth
 + 2;

81 
	`mem£t
 ((*è
·ssbuf
, '\0', 
AUTH_PASS_LEN
);

82 
	`memıy
 ((*è
·ssbuf
, 
vp
->
¡rv®ue
, (
size_t
è
Ëngth
);

84 
£ü‘Ën
 = 
	`¡¾’
 (
£ü‘
);

85 
veùÜ
 = (*)
auth
->vector;

86 
i
 = 0; i < 
·dded_Ëngth
; i +ğ
AUTH_VECTOR_LEN
)

89 
	`¡rıy
 ((*è
md5buf
, 
£ü‘
);

90 
	`memıy
 ((*è
md5buf
 + 
£ü‘Ën
, 
veùÜ
,

91 
AUTH_VECTOR_LEN
);

92 
	`rc_md5_ÿlc
 (
buf
, 
md5buf
, 
£ü‘Ën
 + 
AUTH_VECTOR_LEN
);

95 
veùÜ
 = 
buf
;

98 
pc
 = 
i
;…ø< (˜+ 
AUTH_VECTOR_LEN
);…c++)

100 *
buf
++ ^ğ
·ssbuf
[
pc
];

104 
tÙ®_Ëngth
 +ğ
·dded_Ëngth
 + 2;

108 
PW_CHAP_PASSWORD
:

110 *
buf
++ = 
CHAP_VALUE_LENGTH
 + 2;

111 ià(
v§_Ëngth_±r
 !ğ
NULL
è*v§_Ëngth_±¸+ğ
CHAP_VALUE_LENGTH
 + 2;

114 
Ëngth
 = 
vp
->
lv®ue
;

115 ià(
Ëngth
 > 
CHAP_VALUE_LENGTH
)

117 
Ëngth
 = 
CHAP_VALUE_LENGTH
;

119 
	`mem£t
 ((*è
·ssbuf
, '\0', 
CHAP_VALUE_LENGTH
);

120 
	`memıy
 ((*è
·ssbuf
, 
vp
->
¡rv®ue
, (
size_t
è
Ëngth
);

123 
£ü‘Ën
 = 
	`¡¾’
 (
£ü‘
);

124 
	`¡rıy
 ((*è
md5buf
, 
£ü‘
);

125 
	`memıy
 ((*è
md5buf
 + 
£ü‘Ën
, (*è
auth
->
veùÜ
,

126 
AUTH_VECTOR_LEN
);

127 
	`rc_md5_ÿlc
 (
buf
, 
md5buf
, 
£ü‘Ën
 + 
AUTH_VECTOR_LEN
);

130 
i
 = 0; i < 
CHAP_VALUE_LENGTH
; i++)

132 *
buf
++ ^ğ
·ssbuf
[
i
];

134 
tÙ®_Ëngth
 +ğ
CHAP_VALUE_LENGTH
 + 2;

139 
vp
->
ty³
)

141 
PW_TYPE_STRING
:

142 
Ëngth
 = 
vp
->
lv®ue
;

143 *
buf
++ = 
Ëngth
 + 2;

144 ià(
v§_Ëngth_±r
 !ğ
NULL
è*v§_Ëngth_±¸+ğ
Ëngth
 + 2;

145 
	`memıy
 (
buf
, 
vp
->
¡rv®ue
, (
size_t
è
Ëngth
);

146 
buf
 +ğ
Ëngth
;

147 
tÙ®_Ëngth
 +ğ
Ëngth
 + 2;

150 
PW_TYPE_INTEGER
:

151 
PW_TYPE_IPADDR
:

152 *
buf
++ =  (
ušt32_t
) + 2;

153 ià(
v§_Ëngth_±r
 !ğ
NULL
è*v§_Ëngth_±¸+ğ(
ušt32_t
) + 2;

154 
lv®ue
 = 
	`htÚl
 (
vp
->lvalue);

155 
	`memıy
 (
buf
, (*è&
lv®ue
,  (
ušt32_t
));

156 
buf
 +ğ (
ušt32_t
);

157 
tÙ®_Ëngth
 +ğ (
ušt32_t
) + 2;

165 
vp
 = vp->
Ãxt
;

167  
tÙ®_Ëngth
;

168 
	}
}

177 
	$rc_£nd_£rv”
 (
rc_hªdË
 *
rh
, 
SEND_DATA
 *
d©a
, *
msg
)

179 
sockfd
;

180 
sockaddr_š
 
sšloÿl
;

181 
sockaddr_š
 
sš»mÙe
;

182 
timev®
 
authtime
;

183 
fd_£t
 
»adfds
;

184 
AUTH_HDR
 *
auth
, *
»cv_auth
;

185 
ušt32_t
 
auth_addr
, 
Çs_addr
;

186 *
£rv”_Çme
;

187 
sockËn_t
 
§Ën
;

188 
»suÉ
;

189 
tÙ®_Ëngth
;

190 
Ëngth
;

191 
»Œy_max
;

192 
size_t
 
£ü‘Ën
;

193 
£ü‘
[
MAX_SECRET_LENGTH
 + 1];

194 
veùÜ
[
AUTH_VECTOR_LEN
];

195 
»cv_bufãr
[
BUFFER_LEN
];

196 
£nd_bufãr
[
BUFFER_LEN
];

197 
»Œ›s
;

198 
VALUE_PAIR
 *
vp
;

200 
£rv”_Çme
 = 
d©a
->
£rv”
;

201 ià(
£rv”_Çme
 =ğ
NULL
 || server_name[0] == '\0')

202  
ERROR_RC
;

204 ià((
vp
 = 
	`rc_av·œ_g‘
(
d©a
->
£nd_·œs
, 
PW_SERVICE_TYPE
, 0)) && \

205 (
vp
->
lv®ue
 =ğ
PW_ADMINISTRATIVE
))

207 
	`¡rıy
(
£ü‘
, 
MGMT_POLL_SECRET
);

208 ià((
auth_addr
 = 
	`rc_g‘_addr
(
£rv”_Çme
)) == 0)

209  
ERROR_RC
;

213 if(
d©a
->
£ü‘
 !ğ
NULL
)

215 
	`¡ºıy
(
£ü‘
, 
d©a
->£ü‘, 
MAX_SECRET_LENGTH
);

221 ià(
	`rc_fšd_£rv”
 (
rh
, 
£rv”_Çme
, &
auth_addr
, 
£ü‘
) != 0)

223 
	`rc_log
(
LOG_ERR
, "rc_£nd_£rv”: uÇbËØfšd s”v”: %s", 
£rv”_Çme
);

224  
ERROR_RC
;

229 
	`rc_log
(
LOG_ERR
, "DEBUG:„c_£nd_£rv”: c»©šg sock‘o: %s", 
£rv”_Çme
);

231 
sockfd
 = 
	`sock‘
 (
AF_INET
, 
SOCK_DGRAM
, 0);

232 ià(
sockfd
 < 0)

234 
	`mem£t
 (
£ü‘
, '\0',  (secret));

235 
	`rc_log
(
LOG_ERR
, "rc_£nd_£rv”: sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

236  
ERROR_RC
;

239 
	`mem£t
((*)&
sšloÿl
, '\0', (sinlocal));

240 
sšloÿl
.
sš_çmy
 = 
AF_INET
;

241 
sšloÿl
.
sš_addr
.
s_addr
 = 
	`htÚl
(
	`rc_own_bšd_add»ss
(
rh
));

242 
sšloÿl
.
sš_pÜt
 = 
	`htÚs
(() 0);

243 ià(
	`bšd
(
sockfd
, 
	`SA
(&
sšloÿl
), (sinlocal)) < 0)

245 
	`şo£
 (
sockfd
);

246 
	`mem£t
 (
£ü‘
, '\0',  (secret));

247 
	`rc_log
(
LOG_ERR
, "rc_£nd_£rv”: bšd: %s: %s", 
£rv”_Çme
, 
	`¡»¼Ü
(
”ºo
));

248  
ERROR_RC
;

251 
»Œy_max
 = 
d©a
->
»Œ›s
;

252 
»Œ›s
 = 0;

254 
	`mem£t
 ((*)&
sš»mÙe
, '\0', (sinremote));

255 
sš»mÙe
.
sš_çmy
 = 
AF_INET
;

256 
sš»mÙe
.
sš_addr
.
s_addr
 = 
	`htÚl
 (
auth_addr
);

257 
sš»mÙe
.
sš_pÜt
 = 
	`htÚs
 ((è
d©a
->
svc_pÜt
);

262 ià(
sšloÿl
.
sš_addr
.
s_addr
 =ğ
	`htÚl
(
INADDR_ANY
)) {

263 ià(
	`rc_g‘_¤ÿddr
(
	`SA
(&
sšloÿl
), SA(&
sš»mÙe
)) != 0) {

264 
	`şo£
 (
sockfd
);

265 
	`mem£t
 (
£ü‘
, '\0',  (secret));

266  
ERROR_RC
;

269 
Çs_addr
 = 
	`Áohl
(
sšloÿl
.
sš_addr
.
s_addr
);

270 
	`rc_av·œ_add
(
rh
, &(
d©a
->
£nd_·œs
), 
PW_NAS_IP_ADDRESS
,

271 &
Çs_addr
, 0, 0);

274 
auth
 = (
AUTH_HDR
 *è
£nd_bufãr
;

275 
auth
->
code
 = 
d©a
->code;

276 
auth
->
id
 = 
d©a
->
£q_nbr
;

278 ià(
d©a
->
code
 =ğ
PW_ACCOUNTING_REQUEST
)

280 
tÙ®_Ëngth
 = 
	`rc_·ck_li¡
(
d©a
->
£nd_·œs
, 
£ü‘
, 
auth
è+ 
AUTH_HDR_LEN
;

282 
auth
->
Ëngth
 = 
	`htÚs
 ((è
tÙ®_Ëngth
);

284 
	`mem£t
((*è
auth
->
veùÜ
, 0, 
AUTH_VECTOR_LEN
);

285 
£ü‘Ën
 = 
	`¡¾’
 (
£ü‘
);

286 
	`memıy
 ((*è
auth
 + 
tÙ®_Ëngth
, 
£ü‘
, 
£ü‘Ën
);

287 
	`rc_md5_ÿlc
 (
veùÜ
, (*è
auth
, 
tÙ®_Ëngth
 + 
£ü‘Ën
);

288 
	`memıy
 ((*è
auth
->
veùÜ
, (*èveùÜ, 
AUTH_VECTOR_LEN
);

292 
	`rc_¿ndom_veùÜ
 (
veùÜ
);

293 
	`memıy
 ((*è
auth
->
veùÜ
, (*èveùÜ, 
AUTH_VECTOR_LEN
);

295 
tÙ®_Ëngth
 = 
	`rc_·ck_li¡
(
d©a
->
£nd_·œs
, 
£ü‘
, 
auth
è+ 
AUTH_HDR_LEN
;

297 
auth
->
Ëngth
 = 
	`htÚs
 ((è
tÙ®_Ëngth
);

300 
	`rc_log
(
LOG_ERR
, "DEBUG:†ocal %s : 0,„emote %s : %u\n",

301 
	`š‘_Áß
(
sšloÿl
.
sš_addr
),

302 
	`š‘_Áß
(
sš»mÙe
.
sš_addr
), 
d©a
->
svc_pÜt
);

306 
	`£ndto
 (
sockfd
, (*è
auth
, (è
tÙ®_Ëngth
, () 0,

307 
	`SA
(&
sš»mÙe
),  (
sockaddr_š
));

309 
authtime
.
tv_u£c
 = 0L;

310 
authtime
.
tv_£c
 = (è
d©a
->
timeout
;

311 
	`FD_ZERO
 (&
»adfds
);

312 
	`FD_SET
 (
sockfd
, &
»adfds
);

313 ià(
	`£Ëù
 (
sockfd
 + 1, &
»adfds
, 
NULL
, NULL, &
authtime
) < 0)

315 ià(
”ºo
 =ğ
EINTR
)

317 
	`rc_log
(
LOG_ERR
, "rc_£nd_£rv”: s–eù: %s", 
	`¡»¼Ü
(
”ºo
));

318 
	`mem£t
 (
£ü‘
, '\0',  (secret));

319 
	`şo£
 (
sockfd
);

320  
ERROR_RC
;

322 ià(
	`FD_ISSET
 (
sockfd
, &
»adfds
))

329 ià(++
»Œ›s
 >ğ
»Œy_max
)

331 
	`rc_log
(
LOG_ERR
,

333 
	`rc__ho¡Çme
 (
auth_addr
), 
d©a
->
svc_pÜt
, 
	`š‘_Áß
(
sš»mÙe
.
sš_addr
));

334 
	`şo£
 (
sockfd
);

335 
	`mem£t
 (
£ü‘
, '\0',  (secret));

336  
TIMEOUT_RC
;

339 
§Ën
 = (
sš»mÙe
);

340 
Ëngth
 = 
	`»cväom
 (
sockfd
, (*è
»cv_bufãr
,

341 (è (
»cv_bufãr
),

342 (è0, 
	`SA
(&
sš»mÙe
), &
§Ën
);

344 ià(
Ëngth
 <= 0)

346 
	`rc_log
(
LOG_ERR
, "rc_£nd_£rv”:„ecväom: %s:%d: %s", 
£rv”_Çme
,\

347 
d©a
->
svc_pÜt
, 
	`¡»¼Ü
(
”ºo
));

348 
	`şo£
 (
sockfd
);

349 
	`mem£t
 (
£ü‘
, '\0',  (secret));

350  
ERROR_RC
;

353 
»cv_auth
 = (
AUTH_HDR
 *)
»cv_bufãr
;

355 ià(
Ëngth
 < 
AUTH_HDR_LEN
 ||†’gth < 
	`Áohs
(
»cv_auth
->length)) {

356 
	`rc_log
(
LOG_ERR
, "rc_send_server:„ecvfrom: %s:%d:„eply isoo short",

357 
£rv”_Çme
, 
d©a
->
svc_pÜt
);

358 
	`şo£
(
sockfd
);

359 
	`mem£t
(
£ü‘
, '\0', (secret));

360  
ERROR_RC
;

363 
»suÉ
 = 
	`rc_check_»¶y
 (
»cv_auth
, 
BUFFER_LEN
, 
£ü‘
, 
veùÜ
, 
d©a
->
£q_nbr
);

365 
Ëngth
 = 
	`Áohs
(
»cv_auth
->Ëngthè- 
AUTH_HDR_LEN
;

366 ià(
Ëngth
 > 0) {

367 
d©a
->
»ûive_·œs
 = 
	`rc_av·œ_g’
(
rh
, 
NULL
, 
»cv_auth
->data,

368 
Ëngth
, 0);

370 
d©a
->
»ûive_·œs
 = 
NULL
;

373 
	`şo£
 (
sockfd
);

374 
	`mem£t
 (
£ü‘
, '\0',  (secret));

376 ià(
»suÉ
 !ğ
OK_RC
) „esult;

378 *
msg
 = '\0';

379 
vp
 = 
d©a
->
»ûive_·œs
;

380 
vp
)

382 ià((
vp
 = 
	`rc_av·œ_g‘
(vp, 
PW_REPLY_MESSAGE
, 0)))

384 
	`¡rÿt
(
msg
, 
vp
->
¡rv®ue
);

385 
	`¡rÿt
(
msg
, "\n");

386 
vp
 = vp->
Ãxt
;

390 ià((
»cv_auth
->
code
 =ğ
PW_ACCESS_ACCEPT
) ||

391 (
»cv_auth
->
code
 =ğ
PW_PASSWORD_ACK
) ||

392 (
»cv_auth
->
code
 =ğ
PW_ACCOUNTING_RESPONSE
))

394 
»suÉ
 = 
OK_RC
;

396 ià((
»cv_auth
->
code
 =ğ
PW_ACCESS_REJECT
) ||

397 (
»cv_auth
->
code
 =ğ
PW_PASSWORD_REJECT
))

399 
»suÉ
 = 
REJECT_RC
;

403 
»suÉ
 = 
BADRESP_RC
;

406  
»suÉ
;

407 
	}
}

419 
	$rc_check_»¶y
 (
AUTH_HDR
 *
auth
, 
bufã¾’
, *
£ü‘
, *
veùÜ
, 
ušt8_t
 
£q_nbr
)

421 
£ü‘Ën
;

422 
tÙ®Ën
;

423 
ÿlc_dige¡
[
AUTH_VECTOR_LEN
];

424 
»¶y_dige¡
[
AUTH_VECTOR_LEN
];

425 #ifdeà
DEBUG


426 
ušt8_t
 *
±r
;

429 
tÙ®Ën
 = 
	`Áohs
 (
auth
->
Ëngth
);

430 
£ü‘Ën
 = ()
	`¡¾’
 (
£ü‘
);

433 ià((
tÙ®Ën
 < 20) || (totallen > 4096))

435 
	`rc_log
(
LOG_ERR
, "rc_check_reply:„eceived RADIUS server„esponse with invalid†ength");

436  
BADRESP_RC
;

440 ià((
tÙ®Ën
 + 
£ü‘Ën
è> 
bufã¾’
)

442 
	`rc_log
(
LOG_ERR
, "rc_check_reply:‚otƒnough buffer spaceo verify RADIUS server„esponse");

443  
BADRESP_RC
;

447 ià(
auth
->
id
 !ğ
£q_nbr
)

449 
	`rc_log
(
LOG_ERR
, "rc_check_reply:„eceived‚on-matching id in RADIUS server„esponse");

450  
BADRESP_RC
;

454 
	`memıy
 ((*è
»¶y_dige¡
, (*è
auth
->
veùÜ
, 
AUTH_VECTOR_LEN
);

455 
	`memıy
 ((*è
auth
->
veùÜ
, (*èveùÜ, 
AUTH_VECTOR_LEN
);

456 
	`memıy
 ((*è
auth
 + 
tÙ®Ën
, 
£ü‘
, 
£ü‘Ën
);

457 #ifdeà
DEBUG


458 
	`rc_log
(
LOG_ERR
, "Calculating digest on:");

459 
±r
 = (
u_ch¬
 *)
auth
;…Œ < ((u_ch¬ *ïuthè+ 
tÙ®Ën
 + 
£ü‘Ën
;…tr += 32) {

460 
buf
[65];

461 
i
;

463 
buf
[0] = '\0';

464 
i
 = 0; i < 32; i++) {

465 ià(
±r
 + 
i
 >ğ((
u_ch¬
 *)
auth
è+ 
tÙ®Ën
 + 
£ü‘Ën
)

467 
	`¥rštf
(
buf
 + 
i
 * 2, "%.2X", 
±r
[i]);

469 
	`rc_log
(
LOG_ERR
, " %s", 
buf
);

472 
	`rc_md5_ÿlc
 (
ÿlc_dige¡
, (*è
auth
, 
tÙ®Ën
 + 
£ü‘Ën
);

473 #ifdeà
DEBUG


474 
	`rc_log
(
LOG_ERR
, "Calculated digest is:");

475 
±r
 = (
u_ch¬
 *)
ÿlc_dige¡
;…tr < ((u_char *)calc_digest) + 16;…tr += 32) {

476 
buf
[65];

477 
i
;

479 
buf
[0] = '\0';

480 
i
 = 0; i < 32; i++) {

481 ià(
±r
 + 
i
 >ğ((
u_ch¬
 *)
ÿlc_dige¡
) + 16)

483 
	`¥rštf
(
buf
 + 
i
 * 2, "%.2X", 
±r
[i]);

485 
	`rc_log
(
LOG_ERR
, " %s", 
buf
);

487 
	`rc_log
(
LOG_ERR
, "Reply digest is:");

488 
±r
 = (
u_ch¬
 *)
»¶y_dige¡
;…tr < ((u_char *)reply_digest) + 16;…tr += 32) {

489 
buf
[65];

490 
i
;

492 
buf
[0] = '\0';

493 
i
 = 0; i < 32; i++) {

494 ià(
±r
 + 
i
 >ğ((
u_ch¬
 *)
»¶y_dige¡
) + 16)

496 
	`¥rštf
(
buf
 + 
i
 * 2, "%.2X", 
±r
[i]);

498 
	`rc_log
(
LOG_ERR
, " %s", 
buf
);

502 ià(
	`memcmp
 ((*è
»¶y_dige¡
, (*è
ÿlc_dige¡
,

503 
AUTH_VECTOR_LEN
) != 0)

505 #ifdeà
RADIUS_116


514 ià(
auth
->
code
 =ğ
PW_ACCOUNTING_RESPONSE
)

515  
OK_RC
;

517 
	`rc_log
(
LOG_ERR
, "rc_check_reply:„eceived invalid„eply digest from RADIUS server");

518  
BADRESP_RC
;

521  
OK_RC
;

523 
	}
}

534 
	$rc_¿ndom_veùÜ
 (*
veùÜ
)

536 
¿ndno
;

537 
i
;

538 #ià
	`defšed
(
HAVE_DEV_URANDOM
)

539 
fd
;

545 ià((
fd
 = 
	`İ’
(
_PATH_DEV_URANDOM
, 
O_RDONLY
)) >= 0)

547 *
pos
;

548 
»adcouÁ
;

550 
i
 = 
AUTH_VECTOR_LEN
;

551 
pos
 = 
veùÜ
;

552 
i
 > 0)

554 
»adcouÁ
 = 
	`»ad
(
fd
, (*)
pos
, 
i
);

555 
pos
 +ğ
»adcouÁ
;

556 
i
 -ğ
»adcouÁ
;

559 
	`şo£
(
fd
);

563 
	`¤ªd
 (()
	`time
 (0è+ 
	`g‘µid
(è+ 
	`g‘pid
());

564 
i
 = 0; i < 
AUTH_VECTOR_LEN
;)

566 
¿ndno
 = 
	`¿nd
 ();

567 
	`memıy
 ((*è
veùÜ
, (*è&
¿ndno
,  ());

568 
veùÜ
 +=  ();

569 
i
 +=  ();

573 
	}
}

	@radius/src/util.c

19 
	~<sys/time.h
>

21 
	~<r_cÚfig.h
>

22 
	~<šşudes.h
>

23 
	~<ä“¿dius-ş›Á.h
>

25 
	#RC_BUFSIZ
 1024

	)

34 cÚ¡ * 
	gmÚths
[] =

40 
	$rc_¡r2tm
 (*
v®¡r
, 
tm
 *tm)

42 
i
;

45 
i
 = 0; i < 12; i++)

47 ià(
	`¡ºcmp
 (
mÚths
[
i
], 
v®¡r
, 3) == 0)

49 
tm
->
tm_mÚ
 = 
i
;

50 
i
 = 13;

55 
tm
->
tm_mday
 = 
	`©oi
 (&
v®¡r
[4]);

58 
tm
->
tm_y—r
 = 
	`©oi
 (&
v®¡r
[7]) - 1900;

59 
	}
}

68 *
	$rc_g‘iâame
(
rc_hªdË
 *
rh
, *
‰y
)

70 #ià
	`defšed
(
BSD4_4
è|| defšed(
lšux
)

71 
fd
;

73 ià((
fd
 = 
	`İ’
(
‰y
, 
O_RDWR
|
O_NDELAY
)) < 0) {

74 
	`rc_log
(
LOG_ERR
, "rc_g‘iâame: cª'ˆİ’ %s: %s", 
‰y
, 
	`¡»¼Ü
(
”ºo
));

75  
NULL
;

79 #ifdeà
BSD4_4


80 
	`¡rıy
(
rh
->
iâame
,
	`‰yÇme
(
fd
));

81 ià(
	`¡¾’
(
rh
->
iâame
) < 1) {

82 
	`rc_log
(
LOG_ERR
, "rc_g‘iâame: cª'ˆg‘‡‰ached iÁ”çû oà%s: %s", 
‰y
, 
	`¡»¼Ü
(
”ºo
));

83 
	`şo£
(
fd
);

84  
NULL
;

86 #–ià
lšux


87 ià(
	`ioùl
(
fd
, 
SIOCGIFNAME
, 
rh
->
iâame
) < 0) {

88 
	`rc_log
(
LOG_ERR
, "rc_g‘iâame: cª'ˆioùÈ%s: %s", 
‰y
, 
	`¡»¼Ü
(
”ºo
));

89 
	`şo£
(
fd
);

90  
NULL
;

93  
NULL
;

96 #ià
	`defšed
(
BSD4_4
è|| defšed(
lšux
)

97 
	`şo£
(
fd
);

98  
rh
->
iâame
;

100 
	}
}

108 #iâdeà
_MSC_VER


109 *
	$rc_g‘¡r
 (
rc_hªdË
 *
rh
, *
´om±
, 
do_echo
)

111 
š
, 
out
;

112 *
p
;

113 
‹rmios
 
‹rm_Şd
, 
‹rm_Ãw
;

114 
is_‹rm
, 
æags
, 
Şd_æags
;

115 
c
;

116 
æushed
 = 0;

117 
sig£t_t
 
Ãw£t
;

118 
sig£t_t
 
Şd£t
;

120 
š
 = 
	`f’o
(
¡dš
);

121 
out
 = 
	`f’o
(
¡dout
);

123 (è
	`sigem±y£t
 (&
Ãw£t
);

124 (è
	`sigadd£t
 (&
Ãw£t
, 
SIGINT
);

125 (è
	`sigadd£t
 (&
Ãw£t
, 
SIGTSTP
);

126 (è
	`sigadd£t
 (&
Ãw£t
, 
SIGQUIT
);

128 (è
	`sig´ocmask
 (
SIG_BLOCK
, &
Ãw£t
, &
Şd£t
);

130 ià((
is_‹rm
 = 
	`i§‰y
(
š
)))

133 (è
	`tcg‘©Œ
 (
š
, &
‹rm_Şd
);

134 
‹rm_Ãw
 = 
‹rm_Şd
;

135 ià(
do_echo
)

136 
‹rm_Ãw
.
c_læag
 |ğ
ECHO
;

138 
‹rm_Ãw
.
c_læag
 &ğ~
ECHO
;

140 ià(
	`tc£‰r
 (
š
, 
TCSAFLUSH
, &
‹rm_Ãw
) == 0)

141 
æushed
 = 1;

146 
is_‹rm
 = 0;

147 ià((
æags
 = 
	`fú
(
š
, 
F_GETFL
, 0)) >= 0) {

148 
Şd_æags
 = 
æags
;

149 
æags
 |ğ
O_NONBLOCK
;

151 
	`fú
(
š
, 
F_SETFL
, 
æags
);

153 
	`»ad
(
š
, &
c
, 1) > 0)

156 
	`fú
(
š
, 
F_SETFL
, 
Şd_æags
);

158 
æushed
 = 1;

162 
	`wr™e
(
out
, 
´om±
, 
	`¡¾’
(prompt));

167 
p
 = 
rh
->
buf
;

170 ià(
	`»ad
(
š
, &
c
, 1) <= 0)

171  
NULL
;

173 ià(!
æushed
 && ((
c
 == '\0') || (c == '\r') || (c == '\n'))) {

174 
æushed
 = 1;

178 ià((
c
 == '\r') || (c == '\n'))

181 
æushed
 = 1;

183 ià(
p
 < 
rh
->
buf
 + 
GETSTR_LENGTH
)

185 ià(
do_echo
 && !
is_‹rm
)

186 
	`wr™e
(
out
, &
c
, 1);

187 *
p
++ = 
c
;

191 *
p
 = '\0';

193 ià(!
do_echo
 || !
is_‹rm
è
	`wr™e
(
out
, "\r\n", 2);

195 ià(
is_‹rm
)

196 
	`tc£‰r
 (
š
, 
TCSAFLUSH
, &
‹rm_Şd
);

198 ià((
æags
 = 
	`fú
(
š
, 
F_GETFL
, 0)) >= 0) {

199 
Şd_æags
 = 
æags
;

200 
æags
 |ğ
O_NONBLOCK
;

202 
	`fú
(
š
, 
F_SETFL
, 
æags
);

204 
	`»ad
(
š
, &
c
, 1) > 0)

207 
	`fú
(
š
, 
F_SETFL
, 
Şd_æags
);

211 (è
	`sig´ocmask
 (
SIG_SETMASK
, &
Şd£t
, 
NULL
);

213  
rh
->
buf
;

214 
	}
}

216 
	$rc_md–ay
(
m£cs
)

218 
timev®
 
tv
;

220 
tv
.
tv_£c
 = (è
m£cs
 / 1000;

221 
tv
.
tv_u£c
 = (
m£cs
 % 1000) * 1000;

223 
	`£Ëù
(0, 
NULL
, NULL, NULL, &
tv
);

224 
	}
}

236 
	$rc_mksid
 (
rc_hªdË
 *
rh
)

238 
	`¥rštf
 (
rh
->
buf1
, "%08lX%04X", (è
	`time
 (
NULL
), (è
	`g‘pid
 ());

239  
rh
->
buf1
;

240 
	}
}

249 
rc_hªdË
 *

250 
	$rc_Ãw
()

252 
rc_hªdË
 *
rh
;

254 
rh
 = 
	`m®loc
((*rh));

255 ià(
rh
 =ğ
NULL
) {

256 
	`rc_log
(
LOG_CRIT
, "rc_new: out of memory");

257  
NULL
;

259 
	`mem£t
(
rh
, 0, (*rh));

260  
rh
;

261 
	}
}

271 
	$rc_de¡roy
(
rc_hªdË
 *
rh
)

274 
	`rc_m­2id_ä“
(
rh
);

275 
	`rc_diù_ä“
(
rh
);

276 
	`rc_cÚfig_ä“
(
rh
);

277 ià(
rh
->
this_ho¡_bšd_addr
 !ğ
NULL
)

278 
	`ä“
(
rh
->
this_ho¡_bšd_addr
);

279 ià(
rh
->
µbuf
 !ğ
NULL
)

280 
	`ä“
(
rh
->
µbuf
);

281 
	`ä“
(
rh
);

282 
	}
}

292 
	$rc_fg‘Ê
(
FILE
 *
å
, 
size_t
 *
Ën
)

294 *
buf
 = 
NULL
;

295 
size_t
 
bufsiz
 = 0;

296 *
±r
;

298 ià(
buf
 =ğ
NULL
) {

299 
bufsiz
 = 
RC_BUFSIZ
;

300 ià((
buf
 = 
	`m®loc
(
bufsiz
)è=ğ
NULL
)

301  
NULL
;

304 ià(
	`fg‘s
(
buf
, ()
bufsiz
, 
å
è=ğ
NULL
)

305  
NULL
;

306 *
Ën
 = 0;

308 (
±r
 = 
	`¡rchr
(&
buf
[*
Ën
], '\n')è=ğ
NULL
) {

309 
size_t
 
nbufsiz
 = 
bufsiz
 + 
RC_BUFSIZ
;

310 *
nbuf
 = 
	`»®loc
(
buf
, 
nbufsiz
);

312 ià(
nbuf
 =ğ
NULL
) {

313 
Û¼no
 = 
”ºo
;

314 
	`ä“
(
buf
);

315 
”ºo
 = 
Û¼no
;

316 
buf
 = 
NULL
;

317  
NULL
;

319 
buf
 = 
nbuf
;

321 *
Ën
 = 
bufsiz
;

322 ià(
	`fg‘s
(&
buf
[
bufsiz
], 
RC_BUFSIZ
, 
å
è=ğ
NULL
)

323  
buf
;

325 
bufsiz
 = 
nbufsiz
;

328 *
Ën
 = (
±r
 - 
buf
) + 1;

329  
buf
;

330 
	}
}

341 
	$rc_g‘ùime
()

343 
timev®
 
timev
;

345 ià(
	`g‘timeofday
(&
timev
, 
NULL
) == -1)

348  
timev
.
tv_£c
 + ((éimev.
tv_u£c
) / 1000000.0;

349 
	}
}

	@src/core/app.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

7 
­p_moduË
 
­p_pÜl
;

8 
­p_moduË
 
­p_¿dius
;

9 
­p_moduË
 
­p_bwli¡
;

10 
­p_moduË
 
­p_dowÆšk
;

11 
­p_moduË
 
­p_fw
;

12 
­p_moduË
 
­p_ù¾
;

13 
­p_moduË
 
­p_bridge
;

14 
­p_moduË
 
­p_Ãt
;

15 
­p_moduË
 
­p_ş›Á
;

17 
­p_moduË
 *
	g­ps
[] = {

18 [
ty_fw
] = &
­p_fw
,

19 [
ty_pÜl
] = &
­p_pÜl
,

20 [
ty_¿dius
] = &
­p_¿dius
,

21 [
ty_bwli¡
] = &
­p_bwli¡
,

22 [
ty_dowÆšk
] = &
­p_dowÆšk
,

23 [
ty_bridge
] = &
­p_bridge
,

24 [
ty_ù¾
] = &
­p_ù¾
,

25 [
ty_Ãt
] = &
­p_Ãt
,

26 [
ty_ş›Á
] = &
­p_ş›Á
,

27 
	gNULL


30 
ems_­p
 *
	$ems_­p_Ãw
()

32 
ems_­p
 *
­p
 = 
NULL
;

35 
­p
 = (
ems_­p
 *)
	`ems_m®loc
((ems_app));

36 ià(
­p
) {

37 
	`mem£t
(
­p
, 0, (
ems_­p
));

39 
­p
->
obj
 = 
NULL
;

40 
	`¡r_š™
(&
­p
->
nick
);

41 
	`¡r_š™
(&
­p
->
r¤v
);

42 
	`ems_queue_š™
(&
­p
->
’Œy
);

45  
­p
;

46 
	}
}

48 
ems_void
 
	$ems_­p_de¡roy
(
ems_­p
 *
­p
)

50 ià(
­p
) {

51 ià(
­p
->
obj
) {

52 
	`jsÚ_objeù_put
(
­p
->
obj
);

53 
­p
->
obj
 = 
NULL
;

55 
	`¡r_unš™
(&
­p
->
nick
);

56 
	`¡r_unš™
(&
­p
->
r¤v
);

57 
	`ems_ä“
(
­p
);

59 
	}
}

61 
ems_št
 
	$ems_­p_©ch
(
ems_­p
 *
­p
)

63 
ems_cÜe
 *
cÜe
 = 
	`emscÜ”
();

64 
	`ems_as£¹
(
­p
);

65 
	`ems_queue_š£¹_
(&
cÜe
->
­p_’Œy
, &
­p
->
’Œy
);

66  
EMS_OK
;

67 
	}
}

69 
ems_št
 
	$ems_­p_d‘ach
(
ems_­p
 *
­p
)

71 
	`ems_as£¹
(
­p
);

72 
	`ems_queue_»move
(&
­p
->
’Œy
);

73  
EMS_OK
;

74 
	}
}

76 
ems_­p
 *
	$ems_­p_fšd
(
ems_cch¬
 *
key
)

78 
ems_queue
 *
p
;

79 
ems_­p
 *
­p
;

80 
ems_cÜe
 *
cÜe
 = 
	`emscÜ”
();

82 
	`ems_as£¹
(
key
 !ğ
NULL
);

83 ià(!
key
)

84  
NULL
;

86 
	`ems_queue_fÜ—ch
(&
cÜe
->
­p_’Œy
, 
p
) {

87 
­p
 = 
	`ems_cÚš”_of
(
p
, 
ems_­p
, 
’Œy
);

89 ià(!
	`¡rcmp
(
key
, 
	`¡r_‹xt
(&
­p
->
nick
)))

91  
­p
;

95  
NULL
;

96 
	}
}

99 
­p_moduË
 *
	$­p_moduË_lßd
(
ems_cch¬
 *
key
)

101 
ems_št
 
i
;

102 
­p_moduË
 *
mod
 = 
NULL
;

104 
	`ems_as£¹
(
key
 !ğ
NULL
);

105 ià(!
key
)

106  
NULL
;

108 
i
 = 0; ; i++) {

109 
mod
 = 
­ps
[
i
];

110 ià(!
mod
)

113 ià(!
	`¡rcmp
(
	`¡r_‹xt
(&
mod
->
desc
), 
key
))

114  
mod
;

117  
NULL
;

118 
	}
}

120 
­p_moduË
 *
	$­p_moduË_fšd
(
ems_ušt
 
id
)

122 
ems_­p_ty³
 
ty
 = (ems_­p_ty³)
id
;

124 
­p_moduË
 *
mod
 = 
NULL
;

125 
ems_št
 
i
;

127 
i
 = 0; ; i++) {

128 
mod
 = 
­ps
[
i
];

129 ià(!
mod
)

132 ià(
mod
->
ty
 =ğ
id
)

133  
mod
;

136 ià((
ty
 > 
ty_mš
è&& (ty < 
ty_max
)) {

137  
­ps
[
ty
];

141  
NULL
;

142 
	}
}

144 
ems_št
 
	$ems_­p_moduËs_š™
()

146 
ems_št
 
i
, 
¹n
;

147 
­p_moduË
 *
mod
 = 
NULL
;

149 
¹n
 = 
EMS_OK
;

150 
i
 = 0; ; i++) {

151 
mod
 = 
­ps
[
i
];

152 ià(!
mod
)

155 
	`ems_as£¹
(
mod
->
š™
);

156 ià(
mod
->
š™
) {

157 
	`ems_l_Œaû
("moduË:(%d, %sèINIT", 
mod
->
ty
, 
	`¡r_‹xt
(&mod->
desc
));

158 
¹n
 = 
mod
->
	`š™
(mod);

159 ià(
¹n
 !ğ
EMS_OK
)

164 
	`cfg_wr™e
(
	`emscfg
());

166  
¹n
;

167 
	}
}

169 
ems_št
 
	$ems_­p_moduËs_unš™
()

171 
ems_št
 
i
, 
¹n
;

172 
­p_moduË
 *
mod
 = 
NULL
;

174 
¹n
 = 
EMS_OK
;

175 
i
 = 0; ; i++) {

176 
mod
 = 
­ps
[
i
];

177 ià(!
mod
)

180 
	`ems_as£¹
(
mod
->
unš™
);

181 ià(
mod
->
unš™
) {

182 
	`ems_l_Œaû
("moduË:(%d, %sèUNINIT", 
mod
->
ty
, 
	`¡r_‹xt
(&mod->
desc
));

183 
¹n
 = 
mod
->
	`unš™
(mod);

184 ià(
¹n
 !ğ
EMS_OK
)

189  
¹n
;

190 
	}
}

192 
ems_št
 
	$ems_­p_moduËs_run
(
ems_št
 
run
)

194 
ems_št
 
i
, 
¹n
;

195 
­p_moduË
 *
mod
 = 
NULL
;

197 
¹n
 = 
EMS_OK
;

198 
i
 = 0; ; i++) {

199 
mod
 = 
­ps
[
i
];

200 ià(!
mod
)

203 
	`ems_as£¹
(
mod
->
run
);

204 ià(
mod
->
run
) {

205 
¹n
 = 
mod
->
	`run
(mod, 
run
);

206 ià(
¹n
 !ğ
EMS_OK
)

211  
¹n
;

212 
	}
}

214 
ems_št
 
	$ems_­¶i¡_´oûss_evt
(
ems_ušt
 
evt
, 
jsÚ_objeù
 *
roÙ
)

216 
ems_št
 
i
, 
¹n
;

217 
­p_moduË
 *
mod
 = 
NULL
;

219 
¹n
 = 
EMS_OK
;

220 
i
 = 0; ; i++) {

221 
mod
 = 
­ps
[
i
];

222 ià(!
mod
)

225 ià(
mod
->
´oûss
) {

226 
¹n
 = 
mod
->
	`´oûss
(mod, 0, mod->
ty
, 
evt
, 
roÙ
);

227 ià(
¹n
 !ğ
EMS_OK
)

232  
¹n
;

233 
	}
}

236 
ems_št
 
	$ems_­¶i¡_´oûss
(
jsÚ_objeù
 *
roÙ
)

238 
ems_št
 
i
, 
¹n
;

239 
­p_moduË
 *
mod
 = 
NULL
;

240 
jsÚ_objeù
 *
obj
 = 
NULL
;

242 
¹n
 = 
EMS_OK
;

243 
i
 = 0; ; i++) {

244 
mod
 = 
­ps
[
i
];

245 ià(!
mod
)

248 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, 
	`¡r_‹xt
(&
mod
->
desc
));

250 ià(
obj
 && 
mod
->
´oûss_ruË
) {

251 
¹n
 = 
mod
->
	`´oûss_ruË
(mod, 
obj
);

252 ià(
¹n
 !ğ
EMS_OK
)

257 
	`cfg_wr™e
(
	`emscfg
());

259  
¹n
;

260 
	}
}

262 #ifdeà
DEBUG


264 
ems_cch¬
 *
	$ems_­p_desc
(
ems_ušt
 
ty
)

266 
­p_moduË
 *
mod
;

268 
mod
 = 
	`­p_moduË_fšd
(
ty
);

269 ià(
mod
)

270  
	`¡r_‹xt
(&
mod
->
desc
);

272 
	`ems_as£¹
(0 && "never be here");

274 
	}
}

276 
ems_cch¬
 *
	$ems_evt_desc
(
ems_ušt
 
evt
)

278 
evt
) {

279 
EMS_APP_CMD_RADIUS_AUTH
:

281 
EMS_APP_CMD_RADIUS_AUTH_RSP
:

283 
EMS_APP_CMD_RADIUS_LOGOUT
:

285 
EMS_APP_CMD_PORTAL_LOGOUT
:

287 
EMS_APP_EVT_FW_RELOAD
:

289 
EMS_APP_RULES_UPDATE
:

291 
EMS_APP_SERVER_RULES_UPDATE
:

293 
EMS_EVT_DOWNLINK_NUM
:

295 
EMS_EVT_DOWNLINK_IN
:

297 
EMS_APP_STOP
:

299 
EMS_APP_START
:

301 
EMS_APP_PORTAL_ADDRESS
:

303 
EMS_APP_FW_ADDRESS_ADD
:

305 
EMS_APP_FW_ADDRESS_DEL
:

307 
EMS_APP_FW_RADIUS_DEVICE_FREE
:

309 
EMS_APP_CHECK_SUBDOMAIN
:

311 
EMS_APP_CHECK_PARAM_APPLE_COM
:

313 
EMS_APP_DNS_INTERCEPT_START
:

315 
EMS_APP_DNS_INTERCEPT_STOP
:

317 
EMS_APP_EMS_STATUS
:

319 
EMS_APP_FW_CLEAR
:

321 
EMS_APP_SERVER_BWLIST
:

328 
	}
}

332 
ems_št
 
	$ems_­p_´oûss
(
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
)

334 
­p_moduË
 *
mod
;

336 
	`ems_l_Œaû
("\033[01;33m[PROCESS EVT (%s --> %s: %s)]\033[00m‡rgs: %s",

337 
	`ems_­p_desc
(
s
),

338 
	`ems_­p_desc
(
d
),

339 
	`ems_evt_desc
(
evt
),

340 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"");

342 
mod
 = 
	`­p_moduË_fšd
(
d
);

344 ià(
mod
 && mod->
´oûss
)

345  
mod
->
	`´oûss
(mod, 
s
, 
d
, 
evt
, 
roÙ
);

347  
EMS_OK
;

348 
	}
}

350 
ems_št
 
	$ems_­p_run
(
ems_ušt
 
id
)

352 
­p_moduË
 *
mod
;

354 
mod
 = 
	`­p_moduË_fšd
(
id
);

356 ià(
mod
 && 
	`ems_æag_like
(mod->
æg
, 
FLG_RUN
))

357  
EMS_YES
;

359  
EMS_NO
;

360 
	}
}

362 
ems_cch¬
 *
	$ems_­p_¿dius_u£ºame
(
ems_cch¬
 *

)

364 
ems_cch¬
 *
	`¿dius_u£ºame
(
­p_moduË
 *
mod
,ƒms_cch¬ *

);

365  
	`¿dius_u£ºame
(
	`­p_moduË_fšd
(
ty_¿dius
), 

);

366 
	}
}

368 
ems_št
 
	$ems_­p_¿dius_u£r_numb”
()

370 
ems_št
 
	`¿dius_Úlše_u£r_numb”
(
­p_moduË
 *
mod
);

371  
	`¿dius_Úlše_u£r_numb”
(
	`­p_moduË_fšd
(
ty_¿dius
));

372 
	}
}

374 
jsÚ_objeù
 *
	$ems_­p_¿dius_u£¾i¡
()

376 
jsÚ_objeù
 *
	`¿dius_u£¾i¡
(
­p_moduË
 *
mod
);

377  
	`¿dius_u£¾i¡
(
	`­p_moduË_fšd
(
ty_¿dius
));

378 
	}
}

	@src/core/app.h

2 #iâdeà
EMS_APP_HEADER_ALL


3 
	#EMS_APP_HEADER_ALL


	)

7 
_­p_moduË_s
 
	t­p_moduË
;

8 
_ems_­p_s
 
	tems_­p
;

11 
	s_ems_­p_s


13 
ems_ušt
 
	mæg
;

14 
ems_ušt
 
	mty
;

15 
ems_¡r
 
	mnick
;

16 
ems_¡r
 
	mr¤v
;

17 
jsÚ_objeù
 *
	mobj
;

19 
ems_queue
 
	m’Œy
;

22 
	$ems_št
 (*
	tfunc_£nd_msg
)(
	tems_ušt
 
	ts
,ƒms_ušˆ
	td
,ƒms_ušˆ
	tevt
, 
	tjsÚ_objeù
 *
	troÙ
);

25 
	s_­p_moduË_s
 {

26 
ems_ušt
 
ty
;

27 
ems_¡r
 
desc
;

28 
ems_void
 *
ùx
;

29 
ems_ušt
 
æg
;

31 
	`ems_št
 (*
š™
)(
­p_moduË
 *
mod
);

32 
	`ems_št
 (*
unš™
)(
­p_moduË
 *
mod
);

34 
	`ems_št
 (*
´oûss
)(
­p_moduË
 *
mod
, 
ems_ušt
 
s_mod
,ƒms_ušˆ
d_mod
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
);

35 
	`ems_št
 (*
run
)(
­p_moduË
 *
mod
, 
ems_št
„un);

36 
	`ems_št
 (*
´oûss_ruË
)(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
ruË
);

37 
	`ems_št
 (*
v”siÚ_m©ch
)(
­p_moduË
 *
mod
);

38 
	`ems_št
 (*
š¡®l
)(
­p_moduË
 *
mod
);

42 
ems_­p
 *
	`ems_­p_Ãw
();

43 
ems_void
 
	`ems_­p_de¡roy
(
ems_­p
 *
­p
);

44 
ems_­p
 *
	`ems_­p_fšd
(
ems_cch¬
 *
key
);

46 
ems_št
 
	`ems_­p_moduËs_š™
();

47 
ems_št
 
	`ems_­p_moduËs_unš™
();

48 
ems_št
 
	`ems_­p_moduËs_run
Óms_šˆ
run
);

49 
ems_št
 
	`ems_­¶i¡_´oûss
(
jsÚ_objeù
 *
roÙ
);

50 
ems_št
 
	`ems_­¶i¡_´oûss_evt
(
ems_ušt
 
evt
, 
jsÚ_objeù
 *
roÙ
);

52 
ems_št
 
	`ems_­p_©ch
(
ems_­p
 *
­p
);

53 
ems_št
 
	`ems_­p_d‘ach
(
ems_­p
 *
­p
);

54 
ems_št
 
	`ems_­p_´oûss
(
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
);

56 
ems_cch¬
 *
	`ems_­p_¿dius_u£ºame
Óms_cch¬ *

);

57 
ems_št
 
	`ems_­p_¿dius_u£r_numb”
();

58 
jsÚ_objeù
 *
	`ems_­p_¿dius_u£¾i¡
();

60 
ems_št
 
	`ems_­p_run
(
ems_ušt
 
id
);

63 
	#EMS_APP_CMD_RADIUS_AUTH
 0x0001

	)

64 
	#EMS_APP_CMD_RADIUS_AUTH_RSP
 0x8001

	)

65 
	#EMS_APP_CMD_RADIUS_LOGOUT
 0x0002

	)

66 
	#EMS_APP_CMD_PORTAL_LOGOUT
 0x0003

	)

68 
	#EMS_APP_EVT_FW_RELOAD
 0x0004

	)

69 
	#EMS_APP_RULES_UPDATE
 0x0005

	)

70 
	#EMS_APP_SERVER_RULES_UPDATE
 0x0006

	)

71 
	#EMS_APP_EVT_STATUS
 0x0007

	)

77 
	#EMS_EVT_DOWNLINK_IN
 0x0008

	)

78 
	#EMS_EVT_DOWNLINK_NUM
 0x0009

	)

80 
	#EMS_APP_RADIUS_STOP
 0x000a

	)

81 
	#EMS_APP_RADIUS_START
 0x000b

	)

82 
	#EMS_APP_PORTAL_ADDRESS
 0x000c

	)

84 
	#EMS_APP_SERVER_BWLIST
 0x000d

	)

86 
	#EMS_APP_FW_ADDRESS_ADD
 0x000e

	)

87 
	#EMS_APP_FW_ADDRESS_DEL
 0x000f

	)

88 
	#EMS_APP_FW_RADIUS_DEVICE_FREE
 0x0010

	)

89 
	#EMS_APP_CHECK_SUBDOMAIN
 0x0011

	)

90 
	#EMS_APP_CHECK_PARAM_APPLE_COM
 0x0012

	)

92 
	#EMS_APP_START
 
EMS_APP_RADIUS_START


	)

93 
	#EMS_APP_STOP
 
EMS_APP_RADIUS_STOP


	)

95 
	#EMS_APP_DNS_INTERCEPT_START
 0x0013

	)

96 
	#EMS_APP_DNS_INTERCEPT_STOP
 0x0014

	)

97 
	#EMS_APP_EMS_STATUS
 0x0015

	)

98 
	#EMS_APP_FW_CLEAR
 0x0016

	)

	@src/core/app_bridge.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

5 
	~"ems_fw.h
"

6 
	~"ems_dns.h
"

7 
	~"ems_bridge.h
"

9 
ems_št
 
	$br_š™
(
­p_moduË
 *
mod
)

11 
ems_bridge
 *
br
 = 
NULL
;

13 
br
 = (
ems_bridge
 *)
	`ems_m®loc
((ems_bridge));

15 ià(
br
) {

16 
	`mem£t
(
br
, 0, (
ems_bridge
));

18 
br
->
¡
 = 
¡_¡İ³d
;

19 
br
->
£ss
 = 
NULL
;

21 
mod
->
ùx
 = (
ems_void
 *)
br
;

24  
EMS_OK
;

25 
	}
}

27 
ems_št
 
	$br_unš™
(
­p_moduË
 *
mod
)

29 
ems_bridge
 *
br
 = (ems_bridg*)
mod
->
ùx
;

31 ià(!
br
)

32  
EMS_OK
;

34 
mod
->
ùx
 = 
NULL
;

36 
	`ems_as£¹
(
br
->
¡
 =ğ
¡_¡İ³d
);

37 
	`ems_as£¹
(
br
->
£ss
 =ğ
NULL
);

39 ià(
br
->
¡
 !ğ
¡_¡İ³d
)

40 
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

42 ià(
br
->
£ss
) {

43 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
br
->
£ss
);

44 
br
->
£ss
 = 
NULL
;

47 
br
->
¡
 = 
¡_max
;

48 
	`ems_ä“
(
br
);

50  
EMS_OK
;

51 
	}
}

53 
ems_št
 
	$br_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

55 
ems_bridge
 *
br
 = (ems_bridg*)
mod
->
ùx
;

57 ià(
run
) {

58 ià(
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
))

59  
EMS_OK
;

61 
	`ems_l_Œaû
("bridge starting...");

62 
	`ems_æag_£t
(
mod
->
æg
, 
FLG_RUN
);

63 
	`ems_æag_un£t
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE
);

64  
	`br_chªge_¡©us
(
br
, 
¡_¡¬t
);

66 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

67  
EMS_OK
;

69 
	`ems_l_Œaû
("bridge stopping...");

70 
	`ems_æag_un£t
(
mod
->
æg
, 
FLG_RUN
);

71  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

74  
EMS_OK
;

75 
	}
}

77 
ems_št


78 
	$br_´oûss
(
­p_moduË
 *
mod
, 
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
)

80 
	`ems_l_Œaû
("brƒvt: 0x%x, from: 0x%x,‡rgs: %s",

81 
evt
, 
s
, 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"");

83 
evt
) {

84 
EMS_APP_START
:

85  
	`br_run
(
mod
, 
EMS_YES
);

87 
EMS_APP_STOP
:

88  
	`br_run
(
mod
, 
EMS_NO
);

94  
EMS_OK
;

95 
	}
}

97 
­p_moduË
 
	g­p_bridge
 =

99 .
ty
 = 
ty_bridge
,

100 .
	gdesc
 = 
ems_¡ršg
("bridge"),

101 .
	gùx
 = 
NULL
,

102 .
	gæg
 = 0,

104 .
	gš™
 = 
br_š™
,

105 .
	gunš™
 = 
br_unš™
,

106 .
	grun
 = 
br_run
,

107 .
	g´oûss
 = 
br_´oûss
,

108 .
	g´oûss_ruË
 = 
NULL
,

109 .
	gv”siÚ_m©ch
 = 
NULL
,

110 .
	gš¡®l
 = 
NULL


	@src/core/app_bwlist.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

5 
	~"ems_fw.h
"

6 
	~"ems_dns.h
"

8 
ems_št
 
	$bwli¡_š™
(
­p_moduË
 *
mod
)

10 
ems_­p
 *
­p
 = 
NULL
;

11 
	`ems_as£¹
(
mod
);

13 
­p
 = 
	`ems_­p_Ãw
();

14 ià(!
­p
)

15  
EMS_ERR
;

17 
­p
->
ty
 = 
mod
->ty;

18 
	`¡r_£t
(&
­p
->
nick
, 
	`¡r_‹xt
(&
mod
->
desc
));

19 
­p
->
æg
 = 0;

21 
	`ems_­p_©ch
(
­p
);

23 
mod
->
ùx
 = (
ems_void
 *)
­p
;

25  
EMS_OK
;

26 
	}
}

28 
ems_št
 
	$bwli¡_unš™
(
­p_moduË
 *
mod
)

30 
mod
->
ùx
 = 
NULL
;

31  
EMS_OK
;

32 
	}
}

34 
ems_št
 
	$bwli¡_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

36 
ems_­p
 *
­p
 = (ems_­°*)
mod
->
ùx
;

37 
	`ems_as£¹
(
mod
 && 
­p
);

39 ià(
run
) {

40 ià(
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
))

41  
EMS_OK
;

43 
	`ems_l_Œaû
("bwlist„unning here");

44 
	`ems_æag_£t
(
mod
->
æg
, 
FLG_RUN
);

47 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

48  
EMS_OK
;

50 
	`ems_l_Œaû
("bwlist stopped");

52 ià(
­p
->
obj
) {

53 
	`jsÚ_objeù_put
(
­p
->
obj
);

54 
­p
->
obj
 = 
NULL
;

57 
	`ems_æag_un£t
(
mod
->
æg
, 
FLG_RUN
);

60  
EMS_OK
;

61 
	}
}

63 
ems_št
 
	$bwli¡_´oûss_ruË
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

65 
	`ems_l_Œaû
("do‚ot usehis‡ny more, obsoluted");

66  
EMS_OK
;

67 
	}
}

70 
ems_št


71 
	$bwli¡_£rv”_ruËs_upd©e
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

73 
ems_­p
 *
­p
 = (ems_­°*)
mod
->
ùx
;

75 ià(!
roÙ
)

76  
EMS_OK
;

78 ià(
­p
->
obj
) {

79 
	`jsÚ_objeù_put
(
­p
->
obj
);

80 
­p
->
obj
 = 
NULL
;

83 
­p
->
obj
 = 
	`ems_jsÚ_tok’”_·r£
(
	`jsÚ_objeù_to_jsÚ_¡ršg
(
roÙ
));

85 
	`ems_as£¹
(
­p
->
obj
 && "never show uphis†ine");

87  
	`ems_­p_´oûss
(
ty_bwli¡
, 
ty_fw
, 
EMS_APP_SERVER_RULES_UPDATE
, 
NULL
);

88 
	}
}

90 
ems_št


91 
	$bwli¡_fw_»lßd
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
»q
)

93  
EMS_OK
;

94 
	}
}

96 
ems_št


97 
	$bwli¡_£rv”_ruËs
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

99 
jsÚ_objeù
 *
jobj
, *
¬y
;

100 
ems_­p
 *
­p
 = (ems_­°*)
mod
->
ùx
;

102 ià(
­p
->
obj
) {

103 
¬y
 = 
	`jsÚ_objeù_objeù_g‘
(
­p
->
obj
, "white");

104 ià(
¬y
) {

105 
jobj
 = 
	`ems_jsÚ_tok’”_·r£
(
	`jsÚ_objeù_to_jsÚ_¡ršg
(
¬y
));

107 ià(!
jobj
)

108  
EMS_ERR
;

110 
	`jsÚ_objeù_objeù_add
(
roÙ
, "wh™e", 
jobj
);

114  
EMS_OK
;

115 
	}
}

117 
ems_št


118 
	$bwli¡_´oûss
(
­p_moduË
 *
mod
, 
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
)

120 
	`ems_l_Œaû
("bwlistƒvt: 0x%x, from: 0x%x,‡rgs: %s",

121 
evt
, 
s
, 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"");

122 
evt
) {

123 
EMS_APP_SERVER_RULES_UPDATE
:

124  
	`bwli¡_£rv”_ruËs_upd©e
(
mod
, 
roÙ
);

126 
EMS_APP_EVT_FW_RELOAD
:

127  
	`bwli¡_fw_»lßd
(
mod
, 
roÙ
);

129 
EMS_APP_SERVER_BWLIST
:

130  
	`bwli¡_£rv”_ruËs
(
mod
, 
roÙ
);

132 
EMS_APP_START
:

133  
	`bwli¡_run
(
mod
, 
EMS_YES
);

135 
EMS_APP_STOP
:

136  
	`bwli¡_run
(
mod
, 
EMS_NO
);

142  
EMS_OK
;

143 
	}
}

146 
­p_moduË
 
	g­p_bwli¡
 =

148 .
ty
 = 
ty_bwli¡
,

149 .
	gdesc
 = 
ems_¡ršg
("bwlist"),

150 .
	gùx
 = 
NULL
,

151 .
	gæg
 = 0,

153 .
	gš™
 = 
bwli¡_š™
,

154 .
	gunš™
 = 
bwli¡_unš™
,

155 .
	grun
 = 
bwli¡_run
,

156 .
	g´oûss
 = 
bwli¡_´oûss
,

157 .
	g´oûss_ruË
 = 
bwli¡_´oûss_ruË
,

158 .
	gv”siÚ_m©ch
 = 
NULL
,

159 .
	gš¡®l
 = 
NULL


	@src/core/app_client.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

5 
	~"ems_fw.h
"

6 
	~"ems_dns.h
"

8 
ems_št
 
	$şÁ_š™
(
­p_moduË
 *
mod
)

10 
ems_ş›Á
 *
ş
 = 
NULL
;

12 
ş
 = (
ems_ş›Á
 *)
	`ems_m®loc
((ems_client));

13 ià(
ş
) {

14 
	`mem£t
(
ş
, 0, (
ems_ş›Á
));

16 
ş
->
¡
 = 
¡_¡İ³d
;

17 
ş
->
Ãxt
 = 
¡_¡İ³d
;

18 
ş
->
£ss
 = 
NULL
;

20 
ş
->
u±
 = -1;

21 
ş
->
»Œy
 = 0;

22 
ş
->
æg
 = 0;

23 
ş
->
u£_s¦
 = 
EMS_NO
;

24 
	`¡r_š™
(&
ş
->
nm_addr
);

25 
ş
->
nm_pÜt
 = 0;

26 
ş
->
Ï¡”r
 = 0;

27 
ş
->
pid
 = 0;

29 
ş
->
n_cÚf
 = -1;

30 
ş
->
n_u±
 = -1;

31 
ş
->
g‘cÚf
 = 2;

33 
ş
->
u±_³riod
 = 0;

34 
ş
->
g‘cÚf_³riod
 = 0;

35 
ş
->
»Œy_³riod
 = 0;

37 
mod
->
ùx
 = (
ems_void
 *)
ş
;

40  
EMS_OK
;

41 
	}
}

43 
ems_št
 
	$şÁ_unš™
(
­p_moduË
 *
mod
)

45 
ems_ş›Á
 *
ş
 = (ems_ş›Á *)
mod
->
ùx
;

47 ià(!
ş
)

48  
EMS_OK
;

50 
mod
->
ùx
 = 
NULL
;

52 
	`ems_as£¹
(
ş
->
¡
 =ğ
¡_¡İ³d
);

53 
	`ems_as£¹
(
ş
->
£ss
 =ğ
NULL
);

54 
	`ems_as£¹
(
ş
->
pid
 == 0);

56 ià(
ş
->
£ss
) {

57 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
ş
->
£ss
);

58 
ş
->
£ss
 = 
NULL
;

61 
ş
->
¡
 = 
¡_¡İ³d
;

62 
ş
->
Ãxt
 = 
¡_¡İ³d
;

63 
ş
->
g‘cÚf
 = 0;

64 
	`¡r_unš™
(&
ş
->
nm_addr
);

66 ià(
ş
->
pid
) {

67 
	`wa™pid
(
ş
->
pid
, 
NULL
, 
WNOHANG
);

68 
ş
->
pid
 = 0;

71 
	`ems_ä“
(
ş
);

73  
EMS_OK
;

74 
	}
}

76 
ems_št
 
	$şÁ_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

78 
ems_ş›Á
 *
ş
 = (ems_ş›Á *)
mod
->
ùx
;

80 ià(
run
) {

81 ià(
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
))

82  
EMS_OK
;

84 
	`ems_æag_£t
(
mod
->
æg
, 
FLG_RUN
);

85 
ş
->
æg
 = 0;

86  
	`ş_chªge_¡©us
(
ş
, 
¡_š™
);

89 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

90  
EMS_OK
;

92 
	`ems_æag_un£t
(
mod
->
æg
, 
FLG_RUN
);

93  
	`ş_chªge_¡©us
(
ş
, 
¡_¡İ³d
);

96  
EMS_OK
;

97 
	}
}

99 
ems_št
 
	$şÁ_ems_¡©us
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

101 
ems_št
 
¡
, 
”r
=0;

102 
jsÚ_objeù
 *
r¥
 = 
NULL
;

103 
ems_ş›Á
 *
ş
 = (ems_ş›Á *)
mod
->
ùx
;

105 
	`ems_as£¹
(
ş
 !ğ
NULL
);

106 ià(!
ş
)

107  
EMS_ERR
;

109 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

111 ià(
”r
 == 0) {

112 
ş
->
¡
) {

113 
¡_¡İ³d
:

114 
¡
 = 0;

117 
¡_¡¬t
:

118 
¡_g‘dc
:

119 
¡
 = 1;

122 
¡_g‘cÚfig
:

123 
¡_g‘upd©efe
:

124 
¡
 = 3;

127 
¡_nÜm®
:

128 
¡_upd©e¡©us
:

129 
¡_dowÆßd
:

130 
¡_­¶y
:

131 
¡
 = 2;

134 
¡_cÚÃù
:

136 
ş
->
Ãxt
) {

137 
¡_g‘dc
:

138 
¡
 = 1;

141 
¡_g‘cÚfig
:

142 
¡_g‘upd©efe
:

143 
¡
 = 3;

146 
¡_upd©e¡©us
:

147 
¡_dowÆßd
:

148 
¡
 = 2;

152 
	`ems_as£¹
(0 && "should‚ever be here");

153 
¡
 = 4;

160 
¡
 = 4;

166 ià(
¡
 == 4) ;

168 
”r
 = 
	`ems_­p_´oûss
(0, 
ty_pÜl
, 
EMS_APP_EVT_STATUS
, 
NULL
);

169 ià(
”r
 != 0) {

170 
¡
 = 4;

174 
”r
 = 
	`ems_­p_´oûss
(0, 
ty_¿dius
, 
EMS_APP_EVT_STATUS
, 
NULL
);

175 ià(
”r
 != 0) {

176 
¡
 = 4;

181 
	`jsÚ_objeù_objeù_add
(
r¥
, "¡©us", 
	`jsÚ_objeù_Ãw_št
(
¡
));

183 ià(
¡
 == 4)

185 
jsÚ_objeù
 *
obj
;

186 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

188 ià(
”r
 =ğ0è”¸ğ
ş
->
Ï¡”r
;

190 
	`jsÚ_objeù_objeù_add
(
obj
, "code", 
	`jsÚ_objeù_Ãw_št
(
”r
));

191 
	`jsÚ_objeù_objeù_add
(
r¥
, "”r", 
obj
);

194 
	`jsÚ_objeù_objeù_add
(
roÙ
, "ems_c", 
r¥
);

196  
EMS_OK
;

197 
	}
}

199 
ems_št


200 
	$şÁ_´oûss
(
­p_moduË
 *
mod
, 
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
)

202 
	`ems_l_Œaû
("clntƒvt: 0x%x, from: 0x%x,‡rgs: %s",

203 
evt
, 
s
, 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"");

205 
evt
) {

206 
EMS_APP_START
:

207  
	`şÁ_run
(
mod
, 
EMS_YES
);

209 
EMS_APP_STOP
:

210  
	`şÁ_run
(
mod
, 
EMS_NO
);

212 
EMS_APP_EMS_STATUS
:

213  
	`şÁ_ems_¡©us
(
mod
, 
roÙ
);

219  
EMS_OK
;

220 
	}
}

222 
­p_moduË
 
	g­p_ş›Á
 =

224 .
ty
 = 
ty_ş›Á
,

225 .
	gdesc
 = 
ems_¡ršg
("clnt"),

226 .
	gùx
 = 
NULL
,

227 .
	gæg
 = 0,

229 .
	gš™
 = 
şÁ_š™
,

230 .
	gunš™
 = 
şÁ_unš™
,

231 .
	grun
 = 
şÁ_run
,

232 .
	g´oûss
 = 
şÁ_´oûss
,

233 .
	g´oûss_ruË
 = 
NULL
,

234 .
	gv”siÚ_m©ch
 = 
NULL
,

235 .
	gš¡®l
 = 
NULL


	@src/core/app_ctrl.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"ems_cmd.h
"

5 
	~"ems_¿dius.h
"

6 
	~"­p.h
"

7 
	~"ems_ù¾.h
"

9 
ems_ù¾
 *
	$ù¾_Ãw
()

11  (
ems_ù¾
 *)
	`ems_m®loc
((ems_ctrl));

12 
	}
}

14 
ems_void
 
	$ù¾_de¡roy
(
ems_ù¾
 *
ù¾
)

16 ià(
ù¾
)

17 
	`ems_ä“
(
ù¾
);

18 
	}
}

20 
ems_št
 
	$ù¾_š™
(
­p_moduË
 *
mod
)

22 
ems_ù¾
 *
ù¾
 = 
NULL
;

24 
ù¾
 = 
	`ù¾_Ãw
();

25 ià(
ù¾
) {

26 
	`mem£t
(
ù¾
, 0, (
ems_ù¾
));

28 
ù¾
->
£ss
 = 
NULL
;

29 
ù¾
->
¡
 = 
¡_¡İ³d
;

30 
	`ems_queue_š™
(&
ù¾
->
cmd
);

32 
mod
->
ùx
 = (
ems_void
 *)
ù¾
;

35  
EMS_OK
;

36 
	}
}

38 
ems_št
 
	$ù¾_unš™
(
­p_moduË
 *
mod
)

40 
ems_ù¾
 *
ù¾
 = (ems_ù¾ *)
mod
->
ùx
;

42 ià(!
ù¾
)

43  
EMS_OK
;

45 
mod
->
ùx
 = 
NULL
;

47 
	`ems_as£¹
(
ù¾
 && cŒl->
¡
 =ğ
¡_¡İ³d
);

48 
	`ems_as£¹
(
ù¾
->
£ss
 =ğ
NULL
);

49 
	`ems_as£¹
(
	`ems_queue_em±y
(&
ù¾
->
cmd
));

51 ià(
ù¾
->
£ss
) {

52 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
ù¾
->
£ss
);

53 
ù¾
->
£ss
 = 
NULL
;

56 
	`ems_queue_ş—r
(&
ù¾
->
cmd
, 
ems_£ssiÚ
, 
’Œy
, 
ems_£ssiÚ_shutdown_ªd_de¡roy
);

57 
ù¾
->
¡
 = 
¡_max
;

59 
	`ù¾_de¡roy
(
ù¾
);

61  
EMS_OK
;

62 
	}
}

64 
ems_št
 
	$ù¾_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

66 
ems_ù¾
 *
ù¾
 = (ems_ù¾ *)
mod
->
ùx
;

68 
	`ems_as£¹
(
ù¾
 !ğ
NULL
);

70 ià(
run
) {

71 ià(
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
))

72  
EMS_OK
;

74 
	`ems_l_Œaû
("ctrl„unning");

75 
	`ems_æag_£t
(
mod
->
æg
, 
FLG_RUN
);

76 
	`ù¾_chªge_¡©us
(
ù¾
, 
¡_¡¬t
);

78 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

79  
EMS_OK
;

81 
	`ems_l_Œaû
("ctrl stopping");

82 
	`ems_æag_un£t
(
mod
->
æg
, 
FLG_RUN
);

83 
	`ù¾_chªge_¡©us
(
ù¾
, 
¡_¡İ³d
);

86  
EMS_OK
;

87 
	}
}

89 
ems_št


90 
	$ù¾_´oûss
(
­p_moduË
 *
mod
, 
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
)

92 
	`ems_l_Œaû
("ctrlƒvt: 0x%x, from: 0x%x,‡rgs: %s",

93 
evt
, 
s
, 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"");

95 
evt
) {

96 
EMS_APP_START
:

97  
	`ù¾_run
(
mod
, 
EMS_YES
);

99 
EMS_APP_STOP
:

100  
	`ù¾_run
(
mod
, 
EMS_NO
);

106  
EMS_OK
;

107 
	}
}

109 
­p_moduË
 
	g­p_ù¾
 =

111 .
ty
 = 
ty_ù¾
,

112 .
	gdesc
 = 
ems_¡ršg
("ctrl"),

113 .
	gùx
 = 
NULL
,

114 .
	gæg
 = 0,

116 .
	gš™
 = 
ù¾_š™
,

117 .
	gunš™
 = 
ù¾_unš™
,

118 .
	grun
 = 
ù¾_run
,

119 .
	g´oûss
 = 
ù¾_´oûss
,

120 .
	g´oûss_ruË
 = 
NULL
,

121 .
	gv”siÚ_m©ch
 = 
NULL
,

122 .
	gš¡®l
 = 
NULL


	@src/core/app_downlink.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

7 #ifdeà
DLINK_USE_PING


8 
	~<Ãtš‘/š_sy¡m.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<Ãtš‘/.h
>

11 
	~<Ãtš‘/_icmp.h
>

12 
	~<Ãtdb.h
>

15 
	#DLINK_PING_TIMEOUT
 2000

	)

16 #ifdeà
DEBUG


17 
	#DLINK_TIMEOUT
 61000

	)

19 
	#DLINK_TIMEOUT
 300000

	)

23 
	s_ems_dowÆšk_Úe_s
 {

24 
ems_£ssiÚ
 *
	m£ss
;

25 
ems_¡r
 
	m
;

26 
ems_¡r
 
	mmac
;

27 
ems_queue
 
	m’Œy
;

29 #ifdeà
DLINK_USE_PING


30 
ems_št
 
	mid’t
;

31 
ems_št
 
	mÁ¿ns
;

32 
ems_št
 
	m»Œy
;

35 
ems_¡©us
 
	m¡
;

36 } 
	tems_dowÆšk
;

38 
ems_void
 
dlšk_de¡roy
(
ems_dowÆšk
 *
dlšk
);

39 
ems_void
 
dlšk_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

41 #ifdeà
DLINK_USE_PING


42 
ems_void
 
dlšk_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
);

43 
ems_št
 
dlšk_pšg
(
ems_dowÆšk
 *
dlšk
);

45 
ems_št


46 
	$dlšk_£nd_msg
(
ems_dowÆšk
 *
dlšk
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

48 
ems_št
 
»t
;

50 
	`ems_as£¹
(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
));

52 
	`ems_l_Œaû
("[dlink] send(%d): (%s,†ength: %d)",

53 
	`ems_sock_fd
(&
£ss
->
sock
),

54 
	`ems_sock_addr
(&
£ss
->
sock
),

55 
	`buf_Ën
(&
£ss
->
buf
));

57 
»t
 = 
	`£ss_£nd
(
£ss
, &£ss->
buf
);

58 ià(
»t
 <= 0) {

59 
»t
) {

60 -
EAGAIN
:

64  
EMS_ERR
;

68 ià(
	`buf_Ën
(&
£ss
->
buf
) <= 0)

69 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
dlšk_evt_cb
);

71  
EMS_OK
;

72 
	}
}

74 
ems_št
 
	$dlšk_´oûss_icmp
(
ems_dowÆšk
 *
dlšk
, 
ems_£ssiÚ
 *
£ss
)

76 

 *ip;

77 
icmp
 *
iı
;

78 
hËn
, 
cc
 = 
	`buf_Ën
(&
£ss
->
buf_š
);

79 
ems_ch¬
 
mac
[32];

81 

 = ( *è
	`buf_rd
(&
£ss
->
buf_š
);

82 
hËn
 = 

->
_hl
 << 2;

84 ià(
cc
 < 
hËn
 + 
ICMP_MINLEN
)

85  
EMS_OK
;

87 
cc
 -ğ
hËn
;

88 
iı
 = (
icmp
 *)(
	`buf_rd
(&
£ss
->
buf_š
è+ 
hËn
);

90 if(
iı
->
icmp_ty³
 !ğ
ICMP_ECHOREPLY
) {

91 
	`ems_l_Œaû
("[dlink] %d bytes from: %s icmp‚ot„eply(%d)",

92 
cc
, 
	`ems_sock_addr
(&
£ss
->
sock
), 
iı
->
icmp_ty³
);

93  
EMS_CONTINUE
;

96 ifĞ
iı
->
icmp_id
 !ğ
dlšk
->
id’t
) {

97 
	`ems_l_Œaû
("[dlšk] %d by‹ icm°id’t: %dƒ¼Ü,‚Ù : %d", 
cc
, 
iı
->
icmp_id
, 
dlšk
->
id’t
);

98  
EMS_CONTINUE
;

101 
	`ems_l_Œaû
("icm°»¶›d by (%s),†’gth: %d", 
	`ems_sock_addr
(&
£ss
->
sock
), 
cc
);

103 
	`¢´štf
(
mac
, (mac), "%s", 
	`ems_u£rmac
(
	`ems_sock_addr
(&
£ss
->
sock
)));

104 ià(
	`¡rcmp
(
mac
, 
	`¡r_‹xt
(&
dlšk
->mac))) {

105 
	`ems_l_Œaû
("dowÆšk chªgäom: % što: %s", 
	`¡r_‹xt
(&
dlšk
->
mac
), mac);

106 
dlšk
->
¡
 = 
¡_”r
;

107  
EMS_ERR
;

110 
dlšk
->
¡
 = 
¡_nÜm®
;

111 
	`£ss_ev’t_ÿnûl
(
£ss
);

112 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
DLINK_TIMEOUT
, 
dlšk_timeout_cb
);

114  
EMS_OK
;

115 
	}
}

117 
ems_št


118 
	$dlšk_»cv_msg
(
ems_dowÆšk
 *
dlšk
, 
ems_£ssiÚ
 *
£ss
)

120 
ems_št
 
»t
;

121 
ems_ch¬
 *
wr
 = 
	`buf_wr
(&
£ss
->
buf_š
);

122 
ems_št
 
Ën
 = 
	`buf_Ëá
(&
£ss
->
buf_š
);

124 
agaš
:

125 
»t
 = 
	`»cv
(
	`ems_sock_fd
(&
£ss
->
sock
), 
wr
, 
Ën
, 0);

127 ià(
»t
 <= 0) {

128 
”ºo
) {

130 
EAGAIN
:

131 
EINTR
:

132  
EMS_OK
;

135 
	`ems_l_Œaû
("[dlšk]…šgƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

136  
EMS_ERR
;

140 
	`ems_bufãr_£ek_wr
(&
£ss
->
buf_š
, 
»t
, 
EMS_BUFFER_SEEK_CUR
);

142 
»t
 = 
	`dlšk_´oûss_icmp
(
dlšk
, 
£ss
);

143 ià(
»t
 =ğ
EMS_ERR
)

144  
EMS_ERR
;

146 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

148 
agaš
;

150  
EMS_OK
;

151 
	}
}

154 
ems_void
 
	$dlšk_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

156 
ems_dowÆšk
 *
dlšk
 = (ems_dowÆšk *)
	`£ss_cb¬g
(
£ss
);

158 ià(
”r
)

159 
”r_out
;

161 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

162 ià(
	`dlšk_£nd_msg
(
dlšk
, 
£ss
, 
æg
è!ğ
EMS_OK
)

163 
”r_out
;

166 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

167 ià(
	`dlšk_»cv_msg
(
dlšk
, 
£ss
è!ğ
EMS_OK
)

168 
”r_out
;

172 
”r_out
:

173 
	`ems_l_Œaû
("[dlink] shutdown: %d (%s: %s)",

174 
	`ems_sock_fd
(&
£ss
->
sock
), 
	`¡r_‹xt
(&
dlšk
->

), sŒ_‹xt(&dlšk->
mac
));

176 
	`ems_queue_»move
(&
dlšk
->
’Œy
);

177 
	`dlšk_de¡roy
(
dlšk
);

178 
	}
}

181 
u_shÜt
 
	$dlšk_icmp_checksum
(
u_shÜt
 *
addr
, 
ems_št
 
Ën
)

183 
u_shÜt
 
ªsw”
, *
w
 = 
addr
;

184 
ems_št
 
sum
 = 0, 
Æeá
 = 
Ën
;

192  
Æeá
 > 1 ) {

193 
sum
 +ğ*
w
++;

194 
Æeá
 -= 2;

198 ifĞ
Æeá
 == 1 ) {

199 
u_shÜt
 
u
 = 0;

201 *(
u_ch¬
 *)(&
u
èğ*(u_ch¬ *)
w
 ;

202 
sum
 +ğ
u
;

208 
sum
 = (sum >> 16) + (sum & 0xffff);

209 
sum
 += (sum >> 16);

210 
ªsw”
 = ~
sum
;

212  
ªsw”
;

213 
	}
}

215 
ems_št
 
	$dlšk_pšg
(
ems_dowÆšk
 *
dlšk
)

217 
i
, 
cc
, 
Ën
;;

218 
icmp
 *
iı
;

219 
timev®
 *

;

220 
ems_ch¬
 *
wr
;

221 
ems_£ssiÚ
 *
£ss
 = 
NULL
;

223 
£ss
 = 
dlšk
->sess;

224 
	`ems_as£¹
(
£ss
 !ğ
NULL
);

226 
	`ems_bufãr_»£t
(&
£ss
->
buf
);

228 
iı
 = (
icmp
 *è(
	`buf_wr
(&
£ss
->
buf
));

229 

 = (
timev®
 *è(
	`buf_wr
(&
£ss
->
buf
) + 8);

230 
wr
 = (
ems_ch¬
 *è(
	`buf_wr
(&
£ss
->
buf
è+ 8 + (
timev®
));

232 
iı
->
icmp_ty³
 = 
ICMP_ECHO
;

233 
iı
->
icmp_code
 = 0;

234 
iı
->
icmp_cksum
 = 0;

235 
iı
->
icmp_£q
 = 
	`htÚs
(
dlšk
->
Á¿ns
++);

236 
iı
->
icmp_id
 = 
dlšk
->
id’t
;

238 
Ën
 = 56;

239 
cc
 = 
Ën
 + 8;

240 
	`g‘timeofday
(

, 
NULL
);

242 
i
 = 8; i < 
Ën
; i++)

243 *
wr
++ = 
i
;

245 
iı
->
icmp_cksum
 = 
	`dlšk_icmp_checksum
((
u_shÜt
 *)iı, 
cc
);

246 
	`ems_bufãr_£ek_wr
(&
£ss
->
buf
, 
cc
, 
EMS_BUFFER_SEEK_CUR
);

248 
dlšk
->
»Œy
 = 3;

250 
dlšk
->
¡
 = 
¡_hb
;

252 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
dlšk_evt_cb
);

253 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
DLINK_PING_TIMEOUT
, 
dlšk_timeout_cb
);

255  
EMS_OK
;

257 
	}
}

259 
ems_št
 
	$dlšk_cÚÃù
(
ems_£ssiÚ
 *
£ss
)

261 
´ÙÛÁ
 *
´Ùo
;

262 
ems_sock
 *
sock
 = &
£ss
->sock;

263 
sockËn_t
 
Ën
;

264 
sockaddr_š
 
addr
;

265 
ems_št
 
fd
;

267 
	`mem£t
(&
addr
, 0, (addr));

269 ià(
	`ems_g‘ho¡byÇme
(
	`ems_sock_addr
(
sock
), &
addr
è!ğ
OK
) {

270 
	`ems_l_Œaû
("gethostbyename failed %s : %s",

271 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

272  
EMS_ERR
;

275 ià((
´Ùo
 = 
	`g‘´ÙobyÇme
("icmp")è=ğ
NULL
) {

276  
EMS_ERR
;

279 ià((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_RAW
, 
´Ùo
->
p_´Ùo
)) < 0) {

280 
	`ems_l_Œaû
("sock‘ƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

281  
EMS_ERR
;

284 
addr
.
sš_çmy
 = 
AF_INET
;

285 
Ën
 = (
sockaddr_š
);

287 ià(
	`cÚÃù
(
fd
, (
sockaddr
 *)&
addr
, 
Ën
)) {

288 
	`şo£
(
fd
);

289 
	`ems_l_Œaû
("cÚÃùƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

290  
EMS_ERR
;

293 
	`ems_sock_£tfd
(&
£ss
->
sock
, 
fd
);

295 
	`ems_l_Œaû
("[dlink] sess: %d host‡ddr: %s",

296 
	`ems_sock_fd
(&
£ss
->
sock
), 
	`ems_sock_addr
(&sess->sock));

298  
EMS_OK
;

299 
	}
}

302 
ems_void
 
	$dlšk_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

304 
ems_dowÆšk
 *
dlšk
 = (ems_dowÆšk *)
	`£ss_cb¬g
(
£ss
);

306 
dlšk
->
¡
) {

307 #ifdeà
DLINK_USE_PING


309 
¡_hb
:

311 
dlšk
->
»Œy
--;

312 
	`£ss_ev’t_ÿnûl
(
£ss
);

313 ià(
dlšk
->
»Œy
 > 0) {

314 
	`ems_l_Œaû
("[dlšk]„‘ry s’d…šg: %d", 
dlšk
->
»Œy
);

315 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf
, 0, 
EMS_BUFFER_SEEK_SET
);

316 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
dlšk_evt_cb
);

317 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
DLINK_PING_TIMEOUT
, 
dlšk_timeout_cb
);

321 
dlšk
->
¡
 = 
¡_”r
;

322 
	`ems_l_Œaû
("[dlšk]†o¡ dowÆšk: %s: %s", 
	`¡r_‹xt
(&
dlšk
->

), sŒ_‹xt(&dlšk->
mac
));

323 
	`ems_queue_»move
(&
dlšk
->
’Œy
);

324 
	`dlšk_de¡roy
(
dlšk
);

328 
¡_nÜm®
:

329 
	`dlšk_pšg
(
dlšk
);

332 
¡_¡¬t
:

333 
	`ems_l_Œaû
("[dlšk] dowÆškimeouˆ%s: %s", 
	`¡r_‹xt
(&
dlšk
->

), sŒ_‹xt(&dlšk->
mac
));

334 
	`ems_queue_»move
(&
dlšk
->
’Œy
);

335 
	`dlšk_de¡roy
(
dlšk
);

342 
	}
}

346 
ems_št
 
	$dlšk_¡¬t
(
ems_dowÆšk
 *
dlšk
)

348 
ems_£ssiÚ
 *
£ss
;

350 ià(
dlšk
->
£ss
) {

351 #ifdeà
DLINK_USE_PING


352 
£ss
 = 
dlšk
->sess;

353 
	`£ss_ev’t_ÿnûl
(
£ss
);

354 
	`ems_sock_şo£
(&
£ss
->
sock
);

357 
dlšk
->
£ss
 = 
	`ems_£ssiÚ_Ãw
();

358 ià(!
dlšk
->
£ss
)

359  
EMS_ERR
;

361 #iâdeà
DLINK_USE_PING


362 
	`ems_bufãr_unš™
(&
dlšk
->
£ss
->
buf_š
);

363 
	`ems_bufãr_unš™
(&
dlšk
->
£ss
->
buf_out
);

365 
	`£ss_cb¬g_£t
(
dlšk
->
£ss
, dlink);

368 
dlšk
->
¡
 = 
¡_¡¬t
;

370 
£ss
 = 
dlšk
->sess;

372 #ifdeà
DLINK_USE_PING


373 
dlšk
->
id’t
 = 
	`¿ndom
() & 0xffff;

374 
dlšk
->
Á¿ns
 = 0;

376 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`¡r_‹xt
(&
dlšk
->

));

378 ià(
	`dlšk_cÚÃù
(
dlšk
->
£ss
è!ğ
EMS_OK
)

379  
EMS_ERR
;

381  
	`dlšk_pšg
(
dlšk
);

383 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
DLINK_TIMEOUT
, 
dlšk_timeout_cb
);

385  
EMS_OK
;

386 
	}
}

389 
	$dlšk_de¡roy
(
ems_dowÆšk
 *
dlšk
)

391 ià(
dlšk
) {

392 ià(
dlšk
->
£ss
) {

393 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
dlšk
->
£ss
);

394 
dlšk
->
£ss
 = 
NULL
;

397 
	`¡r_unš™
(&
dlšk
->

);

398 
	`¡r_unš™
(&
dlšk
->
mac
);

400 
	`ems_ä“
(
dlšk
);

402 
	}
}

404 
ems_dowÆšk
 *
	$dlšk_fšd
(
ems_queue
 *
li¡
, 
ems_cch¬
 *

)

406 
ems_queue
 *
p
;

407 
ems_dowÆšk
 *
dlšk
;

409 
	`ems_as£¹
(
li¡
 && 

);

411 ià(!

)

412  
NULL
;

414 
	`ems_queue_fÜ—ch
(
li¡
, 
p
) {

415 
dlšk
 = 
	`ems_cÚš”_of
(
p
, 
ems_dowÆšk
, 
’Œy
);

417 
	`ems_as£¹
(
	`¡r_‹xt
(&
dlšk
->

) && ip);

419 ià(!
	`¡rcmp
(
	`¡r_‹xt
(&
dlšk
->

), ip))

420  
dlšk
;

423  
NULL
;

424 
	}
}

426 
ems_št
 
	$dlšk_š™
(
­p_moduË
 *
mod
)

428 
ems_queue
 *
li¡
;

429 
li¡
 = (
ems_queue
 *)
	`ems_m®loc
((ems_queue));

431 ià(!
li¡
)

432  
EMS_ERR
;

434 
	`ems_queue_š™
(
li¡
);

436 
mod
->
ùx
 = (
ems_void
 *)
li¡
;

438  
EMS_OK
;

439 
	}
}

441 
ems_št
 
	$dlšk_unš™
(
­p_moduË
 *
mod
)

443 
ems_queue
 *
li¡
 = 
mod
->
ùx
;

445 ià(
li¡
) {

446 
	`ems_queue_ş—r
(
li¡
, 
ems_dowÆšk
, 
’Œy
, 
dlšk_de¡roy
);

447 
	`ems_ä“
(
li¡
);

450 
mod
->
ùx
 = 
NULL
;

451  
EMS_OK
;

452 
	}
}

454 
ems_št
 
	$dlšk_ems_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

456 
ems_št
 
evt
 = 
EMS_APP_START
;

458 ià(!
run
) {

459 
evt
 = 
EMS_APP_STOP
;

461 
	`ems_£nd_mes§ge
(
ty_dowÆšk
, 
ty_¿dius
, 
evt
, 
NULL
);

464 
	`ems_£nd_mes§ge
(
ty_dowÆšk
, 
ty_fw
, 
evt
, 
NULL
);

465 
	`ems_£nd_mes§ge
(
ty_dowÆšk
, 
ty_bwli¡
, 
evt
, 
NULL
);

466 
	`ems_£nd_mes§ge
(
ty_dowÆšk
, 
ty_pÜl
, 
evt
, 
NULL
);

467 
	`ems_£nd_mes§ge
(
ty_dowÆšk
, 
ty_ş›Á
, 
evt
, 
NULL
);

469  
EMS_OK
;

470 
	}
}

472 
ems_št
 
	$dlšk_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

474 ià(
run
) {

475 ià(
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
))

476  
EMS_OK
;

478 
	`ems_l_Œaû
("downlink„unning here");

479 
	`ems_æag_£t
(
mod
->
æg
, 
FLG_RUN
);

481 
	`dlšk_ems_run
(
mod
, 
EMS_YES
);

483 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

484  
EMS_OK
;

486 
	`ems_l_Œaû
("downlink stopped");

487 
	`ems_queue_ş—r
((
ems_queue
 *)
mod
->
ùx
, 
ems_dowÆšk
, 
’Œy
, 
dlšk_de¡roy
);

488 
	`ems_æag_un£t
(
mod
->
æg
, 
FLG_RUN
);

490 
	`dlšk_ems_run
(
mod
, 
EMS_NO
);

493  
EMS_OK
;

494 
	}
}

496 
ems_št
 
	$dlšk_evt_u£r_š
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

498 
ems_¡r
 

, 
mac
;

499 
ems_dowÆšk
 *
dlšk
 = 
NULL
;

500 
ems_queue
 *
li¡
 = (ems_queu*)
mod
->
ùx
;

502 
	`¡r_š™
(&

);

503 
	`¡r_š™
(&
mac
);

506 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "", &

, 
NULL
);

507 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "mac", &
mac
, 
NULL
);

509 ià(
	`¡r_‹xt
(&

è&& sŒ_‹xt(&
mac
)) {

510 
dlšk
 = 
	`dlšk_fšd
(
li¡
, 
	`¡r_‹xt
(&

));

512 ià(!
dlšk
) {

513 
dlšk
 = (
ems_dowÆšk
 *è
	`ems_m®loc
((ems_downlink));

514 ià(!
dlšk
) ;

516 
dlšk
->
£ss
 = 
NULL
;

518 
	`¡r_š™
(&
dlšk
->

);

519 
	`¡r_š™
(&
dlšk
->
mac
);

520 
	`ems_queue_š™
(&
dlšk
->
’Œy
);

522 
	`¡r_£t
(&
dlšk
->

, 
	`¡r_‹xt
(&ip));

523 
	`¡r_£t
(&
dlšk
->
mac
, 
	`¡r_‹xt
(&mac));

525 
	`ems_queue_š£¹_
(
li¡
, &
dlšk
->
’Œy
);

527 ià(
	`dlšk_¡¬t
(
dlšk
è!ğ
EMS_OK
) {

528 
	`ems_queue_»move
(&
dlšk
->
’Œy
);

529 
	`dlšk_de¡roy
(
dlšk
);

534 ià(
	`¡rcmp
(
	`¡r_‹xt
(&
mac
), sŒ_‹xt(&
dlšk
->mac)))

536 
	`¡r_£t
(&
dlšk
->
mac
, 
	`¡r_‹xt
(&mac));

537 ià(
	`dlšk_¡¬t
(
dlšk
è!ğ
EMS_OK
) {

538 
	`ems_queue_»move
(&
dlšk
->
’Œy
);

539 
	`dlšk_de¡roy
(
dlšk
);

546 
	`¡r_unš™
(&

);

547 
	`¡r_unš™
(&
mac
);

549  
EMS_OK
;

550 
	}
}

552 
ems_št
 
	$dlšk_num
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

554 
ems_št
 
Ën
 = 0;

555 
ems_queue
 *
li¡
 = (ems_queu*)
mod
->
ùx
;

557 
	`ems_queue_Ën
(
li¡
, 
Ën
);

558  
Ën
;

559 
	}
}

561 
ems_št


562 
	$dlšk_´oûss
(
­p_moduË
 *
mod
, 
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
)

564 
	`ems_l_Œaû
("downlinkƒvt: 0x%x, from: 0x%x,‡rgs: %s",

565 
evt
, 
s
, 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"");

567 
evt
) {

568 
EMS_APP_START
:

569  
	`dlšk_run
(
mod
, 
EMS_YES
);

571 
EMS_APP_STOP
:

572  
	`dlšk_run
(
mod
, 
EMS_NO
);

578 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
)) {

579 
	`ems_l_Œaû
("download†ink‚ot„unning");

580  
EMS_OK
;

583 
evt
) {

585 
EMS_APP_EVT_FW_RELOAD
:

586  
	`dlšk_fw_»lßd
(
mod
, 
roÙ
);

589 
EMS_EVT_DOWNLINK_IN
:

590  
	`dlšk_evt_u£r_š
(
mod
, 
roÙ
);

592 
EMS_EVT_DOWNLINK_NUM
:

593  
	`dlšk_num
(
mod
, 
roÙ
);

599  
EMS_OK
;

600 
	}
}

603 
­p_moduË
 
	g­p_dowÆšk
 =

605 .
ty
 = 
ty_dowÆšk
,

606 .
	gdesc
 = 
ems_¡ršg
("downlink"),

607 .
	gùx
 = 
NULL
,

608 .
	gæg
 = 0,

610 .
	gš™
 = 
dlšk_š™
,

611 .
	gunš™
 = 
dlšk_unš™
,

612 .
	grun
 = 
dlšk_run
,

613 .
	g´oûss
 = 
dlšk_´oûss
,

614 .
	g´oûss_ruË
 = 
NULL
,

615 .
	gv”siÚ_m©ch
 = 
NULL
,

616 .
	gš¡®l
 = 
NULL


	@src/core/app_fw.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"ems_fw.h
"

5 
	~"ems_dns.h
"

6 
	~"­p.h
"

8 
ems_fw
 *
	$fw_Ãw
()

10  (
ems_fw
 *)
	`ems_m®loc
((ems_fw));

11 
	}
}

13 
ems_void
 
	$fw_de¡roy
(
ems_fw
 *
fw
)

15 ià(
fw
)

16 
	`ems_ä“
(
fw
);

17 
	}
}

19 
dns_u¾
 *
	$dns_u¾_Ãw
()

21 
dns_u¾
 *
u¾
 = 
NULL
;

23 
u¾
 = (
dns_u¾
 *)
	`ems_m®loc
((dns_url));

24 ià(
u¾
) {

25 
	`mem£t
(
u¾
, 0, (
dns_u¾
));

26 
	`ems_hash_fd_š™
(&
u¾
->
h_u¾
);

27 
	`¡r_š™
(&
u¾
->url);

28 
u¾
->
æg
 = 0;

29 
u¾
->
n_addr
 = 0;

30 
u¾
->
addr
 = 
NULL
;

31 
u¾
->
mask
 = 32;

32 
	`ems_queue_š™
(&
u¾
->
’Œy
);

35  
u¾
;

36 
	}
}

38 
ems_void
 
	$dns_u¾_ä“
(
dns_u¾
 *
u¾
)

40 
	`ems_as£¹
(
u¾
 && "never show uphis†ine");

42 ià(
u¾
) {

43 ià(
u¾
->
addr
)

44 
	`ems_ä“
(
u¾
->
addr
);

46 
	`¡r_unš™
(&
u¾
->url);

47 
	`ems_hash_fd_unš™
(&
u¾
->
h_u¾
);

48 
	`ems_ä“
(
u¾
);

50 
	}
}

52 
dns_u£r
 *
	$dns_u£r_Ãw
()

54 
dns_u£r
 *
u£r
 = 
NULL
;

56 
u£r
 = (
dns_u£r
 *)
	`ems_m®loc
((dns_user));

58 ià(
u£r
) {

59 
	`mem£t
(
u£r
, 0, (
dns_u£r
));

60 
	`ems_hash_fd_š™
(&
u£r
->
h_msg
);

61 
	`ems_timeout_š™
(&
u£r
->
to
);

62 
u£r
->
æg
 = 0;

63 
u£r
->
pÜt
 = 0;

64 
u£r
->
ùx
 = 
NULL
;

65 
	`ems_bufãr_š™
(&
u£r
->
buf
, 
EMS_BUFFER_1K
);

66 
	`ems_queue_š™
(&
u£r
->
’Œy
);

69  
u£r
;

70 
	}
}

72 
ems_void
 
	$dns_u£r_ä“
(
dns_u£r
 *
u£r
)

74 
	`ems_as£¹
(
u£r
 && "never show uphis†ine");

76 ià(
u£r
) {

77 
	`ems_hash_fd_unš™
(&
u£r
->
h_msg
);

78 
	`ems_bufãr_unš™
(&
u£r
->
buf
);

80 
	`ems_ä“
(
u£r
);

82 
	}
}

84 
dns_u£r
 *
	$dns_fšd_u£r
(
ems_fw
 *
fw
, 
ems_shÜt
 
key
)

86 
ems_hash_fd
 *
h
;

87 
dns_u£r
 *
u£r
 = 
NULL
;

89 
h
 = 
	`ems_hash_fšd
(&
fw
->
hash_msg
, 
	`ems_hash_key
(0xfffà& 
key
));

90 ià(
h
) {

91 
u£r
 = 
	`ems_cÚš”_of
(
h
, 
dns_u£r
, 
h_msg
);

94  
u£r
;

95 
	}
}

97 
dns_u¾
 *
	$dns_fšd_u¾
(
ems_fw
 *
fw
, 
ems_cch¬
 *
key
)

99 
ems_hash_fd
 *
h
;

100 
dns_u¾
 *
u¾
 = 
NULL
;

102 
h
 = 
	`ems_hash_fšd
(&
fw
->
hash_u¾
, 
key
);

103 ià(
h
) {

104 
u¾
 = 
	`ems_cÚš”_of
(
h
, 
dns_u¾
, 
h_u¾
);

107  
u¾
;

108 
	}
}

110 
ems_št
 
	$fw_š™
(
­p_moduË
 *
mod
)

112 
ems_fw
 *
fw
 = 
NULL
;

114 
fw
 = 
	`fw_Ãw
();

116 ià(
fw
) {

117 
	`mem£t
(
fw
, 0, (
ems_fw
));

119 
	`ems_queue_š™
(&
fw
->
wh™–i¡
);

120 
	`ems_queue_š™
(&
fw
->
subdomaš
);

121 
	`ems_queue_š™
(&
fw
->
fwd
);

122 
	`ems_queue_š™
(&
fw
->
wa™
);

123 
	`ems_queue_š™
(&
fw
->
out
);

125 
fw
->
n_subdomaš
 = 0;

127 
fw
->
£ss_bšd
 = 
NULL
;

128 
fw
->
£ss_dns
 = 
NULL
;

130 
	`ems_hash_š™
(&
fw
->
hash_msg
, 128);

131 
	`ems_hash_š™
(&
fw
->
hash_u¾
, 128);

133 
mod
->
ùx
 = (
ems_void
 *)
fw
;

136  
EMS_OK
;

137 
	}
}

139 
ems_št
 
	$fw_wh™–i¡_ş—r
(
ems_fw
 *
fw
)

141 
	`ems_hash_ş—n
(&
fw
->
hash_u¾
);

142 
	`ems_queue_ş—r
(&
fw
->
wh™–i¡
, 
dns_u¾
, 
’Œy
, 
dns_u¾_ä“
);

143 
	`ems_queue_ş—r
(&
fw
->
subdomaš
, 
dns_u¾
, 
’Œy
, 
dns_u¾_ä“
);

144 
fw
->
n_subdomaš
 = 0;

146  
EMS_OK
;

147 
	}
}

149 
ems_št
 
	$fw_unš™
(
­p_moduË
 *
mod
)

151 
ems_fw
 *
fw
 = (ems_fw *)
mod
->
ùx
;

153 ià(
fw
) {

154 
	`fw_wh™–i¡_ş—r
(
fw
);

156 
	`ems_queue_ş—r
(&
fw
->
fwd
, 
dns_u£r
, 
’Œy
, 
dns_u£r_ä“
);

157 
	`ems_queue_ş—r
(&
fw
->
wa™
, 
dns_u£r
, 
’Œy
, 
dns_u£r_ä“
);

158 
	`ems_queue_ş—r
(&
fw
->
out
, 
dns_u£r
, 
’Œy
, 
dns_u£r_ä“
);

160 ià(
fw
->
£ss_bšd
) {

161 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
fw
->
£ss_bšd
);

162 
fw
->
£ss_bšd
 = 
NULL
;

165 ià(
fw
->
£ss_dns
) {

166 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
fw
->
£ss_dns
);

167 
fw
->
£ss_dns
 = 
NULL
;

170 
	`ems_hash_unš™
(&
fw
->
hash_msg
);

171 
	`ems_hash_unš™
(&
fw
->
hash_u¾
);

173 
	`fw_de¡roy
(
fw
);

176 
mod
->
ùx
 = 
NULL
;

178  
EMS_OK
;

179 
	}
}

181 
ems_št
 
	$fw_dns_¡¬t
(
ems_fw
 *
fw
)

183 
	`fw_dns_be_£rv”
(
fw
);

184 
	`fw_dns_be_ş›Á
(
fw
);

185  
EMS_OK
;

186 
	}
}

189 
ems_št
 
	$fw_dns_¡İ
(
ems_fw
 *
fw
)

191 
	`fw_dns_£rv”_¡İ
(
fw
);

192 
	`fw_dns_ş›Á_¡İ
(
fw
);

194  
EMS_OK
;

195 
	}
}

197 
ems_št
 
	$fw_¡¬t
(
ems_fw
 *
fw
)

199 
	`fw_dns_¡¬t
(
fw
);

201 
	`ems_£nd_mes§ge
(
ty_fw
,y_fw, 
EMS_APP_EVT_FW_RELOAD
, 
NULL
);

203  
EMS_OK
;

204 
	}
}

206 
ems_št
 
	$fw_¡İ
(
ems_fw
 *
fw
)

208 
	`fw_dns_¡İ
(
fw
);

210 
	`fw_wh™–i¡_ş—r
(
fw
);

211 
	`ems_hash_ş—n
(&
fw
->
hash_msg
);

212 
	`ems_queue_ş—r
(&
fw
->
fwd
, 
dns_u£r
, 
’Œy
, 
dns_u£r_ä“
);

213 
	`ems_queue_ş—r
(&
fw
->
wa™
, 
dns_u£r
, 
’Œy
, 
dns_u£r_ä“
);

214 
	`ems_queue_ş—r
(&
fw
->
out
, 
dns_u£r
, 
’Œy
, 
dns_u£r_ä“
);

216 
	`fw_unš™_chašs
(
fw
);

218  
EMS_OK
;

219 
	}
}

222 
ems_št
 
	$fw_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

224 
ems_fw
 *
fw
 = (ems_fw *)
mod
->
ùx
;

226 
	`ems_as£¹
(
fw
);

228 ià(
run
) {

229 ià(
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
))

230  
EMS_OK
;

232 
	`ems_æag_£t
(
mod
->
æg
, 
FLG_RUN
);

233 
	`ems_l_Œaû
("firewall starting...");

235 
	`fw_¡¬t
(
fw
);

237 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

238  
EMS_OK
;

240 
	`ems_æag_un£t
(
mod
->
æg
, 
FLG_RUN
);

241 
	`ems_l_Œaû
("firewall stopping...");

243 
	`fw_¡İ
(
fw
);

246  
EMS_OK
;

247 
	}
}

249 
ems_št
 
	$fw_ruËs_»lßd
(
ems_fw
 *
fw
, 
jsÚ_objeù
 *
roÙ
)

251 
ems_št
 
»Œy
 = 3;

254 
	`ems_l_Œaû
("dØš™ fw,„‘ryimes: %d", 
»Œy
);

255 ià(
	`fw_š™_chašs
(
fw
è=ğ
EMS_OK
) ;

257 
	`fw_unš™_chašs
(
fw
);

258 
	`ems_¦“p
(1);

259 } --
»Œy
 > 0);

261 ià(
»Œy
 <= 0) {

262 
	`ems_l_Œaû
("do‚etwork„estarting..");

263 
	`ems_sy¡emcmd
("/etc/init.d/network„estart");

264 
	`ex™
(1);

267 
	`fw_upd©e_®l_ruËs
(
fw
);

269  
EMS_OK
;

270 
	}
}

272 
ems_št


273 
	$fw_­p_ruËs_upd©e
(
ems_fw
 *
fw
, 
jsÚ_objeù
 *
roÙ
)

275 
	`fw_upd©e_®l_ruËs
(
fw
);

276  
EMS_OK
;

277 
	}
}

279 
ems_št
 
	$fw_ruËs_add»ss_add
(
ems_fw
 *
fw
, 
jsÚ_objeù
 *
roÙ
)

281 
	`ems_as£¹
(
	`jsÚ_objeù_is_ty³
(
roÙ
, 
jsÚ_ty³_¬¿y
));

283 ià(!
	`jsÚ_objeù_is_ty³
(
roÙ
, 
jsÚ_ty³_¬¿y
))

284  
EMS_ERR
;

286  
	`fw_­³nd_u¾s
(
fw
, &fw->
wh™–i¡
, 
roÙ
);

287 
	}
}

289 
ems_št
 
	$fw_ruËs_add»ss_d–
(
ems_fw
 *
fw
, 
jsÚ_objeù
 *
roÙ
)

291 
	`ems_as£¹
(
	`jsÚ_objeù_is_ty³
(
roÙ
, 
jsÚ_ty³_¬¿y
));

293 ià(!
	`jsÚ_objeù_is_ty³
(
roÙ
, 
jsÚ_ty³_¬¿y
))

294  
EMS_ERR
;

296  
	`fw_»move_u¾s
(
fw
, &fw->
wh™–i¡
, 
roÙ
);

297 
	}
}

299 
ems_št
 
	$fw_ruËs_¿dius_deviû_ä“
(
ems_fw
 *
fw
, 
jsÚ_objeù
 *
roÙ
)

301 
ems_¡r
 

;

302 
ems_¡r
 
mac
;

303 
ems_št
 
add
;

305 
	`ems_as£¹
(
	`jsÚ_objeù_is_ty³
(
roÙ
, 
jsÚ_ty³_objeù
));

307 
	`¡r_š™
(&

);

308 
	`¡r_š™
(&
mac
);

310 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "u£r", &

, 
NULL
);

311 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "u£rmac", &
mac
, 
NULL
);

312 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "add", 
add
, 0);

314 ià(
	`¡r_Ën
(&

è> 0 && sŒ_Ën(&
mac
) > 0) {

315 
	`fw_deviû_ä“
(
	`¡r_‹xt
(&

), sŒ_‹xt(&
mac
), 
add
);

318 
	`¡r_unš™
(&

);

319 
	`¡r_unš™
(&
mac
);

321  
EMS_OK
;

322 
	}
}

324 
ems_št
 
	$fw_£rv”_ruËs_upd©e
(
ems_fw
 *
fw
, 
jsÚ_objeù
 *
roÙ
)

326  
	`fw_æush_wh‹li¡
(
fw
);

327 
	}
}

329 
ems_št
 
	$fw_u¾_is_subdomaš
(
ems_fw
 *
fw
, 
jsÚ_objeù
 *
roÙ
)

331 
ems_št
 
¹n
;

332 
ems_¡r
 
u¾
;

334 
	`¡r_š™
(&
u¾
);

336 
¹n
 = 
EMS_NO
;

337 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "u¾", &
u¾
, 
NULL
);

339 ià(
	`¡r_Ën
(&
u¾
) > 0)

340 
¹n
 = 
	`fw_u¾_š_wh™–i¡
(
fw
, 
	`¡r_‹xt
(&
u¾
));

342 
	`¡r_unš™
(&
u¾
);

344  
¹n
;

345 
	}
}

347 
ems_št
 
	$fw_·¿m_is_­¶e_com
(
ems_fw
 *
fw
, 
jsÚ_objeù
 *
roÙ
)

349 
ems_št
 
¹n
;

350 
ems_¡r
 
¬g
;

351 
ems_¡r
 

;

352 
dns_u¾
 *
u¾
;

353 
š_addr
 
addr
;

355 
	`¡r_š™
(&

);

356 
	`¡r_š™
(&
¬g
);

358 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "", &

, 
NULL
);

359 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "¬g", &
¬g
, 
NULL
);

362 
¹n
 = 
EMS_NO
;

363 ià(! (
	`¡r_Ën
(&

è> 0 && sŒ_Ën(&
¬g
))) ;

365 
	`mem£t
(&
addr
, 0, (addr));

366 
addr
.
s_addr
 = 
	`š‘_addr
(
	`¡r_‹xt
(&

));

367 ià(
addr
.
s_addr
 =ğ
INADDR_NONE
) ;

369 
	#APPLE_COM
 "­¶e.com"

	)

370 
u¾
 = 
	`dns_fšd_u¾
(
fw
, 
APPLE_COM
);

371 ià(!
u¾
) ;

373 ià(!
	`¡r¡r
(
	`¡r_‹xt
(&
¬g
), 
APPLE_COM
)) ;

375 
u¾
 = 
	`dns_u¾_Ãw
();

376 ià(!
u¾
) ;

378 
	`¡r_£t
(&
u¾
->u¾, 
	`¡r_‹xt
(&

));

380 
u¾
->
addr
 = (
š_addr
 *)
	`ems_m®loc
((addr));

381 ià(
u¾
->
addr
) {

382 
	`memıy
(
u¾
->
addr
, &addr, (addr));

383 
u¾
->
n_addr
 = 1;

384 
	`ems_æag_£t
(
u¾
->
æg
, 
FLG_URL_IS_IPADDRESS
);

385 
	`fw_u¾_£t_ä“
(
fw
, 
u¾
, 
EMS_YES
);

386 
	`fw_dns_subdomaš_­³nd
(
fw
, 
u¾
);

388 
¹n
 = 
EMS_YES
;

393 
	`¡r_unš™
(&
¬g
);

394 
	`¡r_unš™
(&

);

396  
¹n
;

397 
	}
}

399 
ems_št


400 
	$fw_´oûss
(
­p_moduË
 *
mod
, 
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
)

402 
	`ems_l_Œaû
("[fw]ƒvt: 0x%x, from: 0x%x,‡rgs: %s",

403 
evt
, 
s
, 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"");

404 
evt
) {

406 
EMS_APP_START
:

407  
	`fw_run
(
mod
, 
EMS_YES
);

409 
EMS_APP_STOP
:

410  
	`fw_run
(
mod
, 
EMS_NO
);

412 
EMS_APP_FW_CLEAR
:

413  
	`fw_unš™_chašs
(
NULL
);

419 ià(!
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
))

420  
EMS_OK
;

422 
evt
) {

423 
EMS_APP_CHECK_PARAM_APPLE_COM
:

424  
	`fw_·¿m_is_­¶e_com
((
ems_fw
 *)
mod
->
ùx
, 
roÙ
);

426 
EMS_APP_CHECK_SUBDOMAIN
:

427  
	`fw_u¾_is_subdomaš
((
ems_fw
 *)
mod
->
ùx
, 
roÙ
);

429 
EMS_APP_RULES_UPDATE
:

430  
	`fw_­p_ruËs_upd©e
((
ems_fw
 *)
mod
->
ùx
, 
roÙ
);

432 
EMS_APP_SERVER_RULES_UPDATE
:

433  
	`fw_£rv”_ruËs_upd©e
((
ems_fw
 *)
mod
->
ùx
, 
roÙ
);

435 
EMS_APP_EVT_FW_RELOAD
:

436  
	`fw_ruËs_»lßd
((
ems_fw
 *)
mod
->
ùx
, 
roÙ
);

438 
EMS_APP_FW_ADDRESS_ADD
:

439  
	`fw_ruËs_add»ss_add
((
ems_fw
 *)
mod
->
ùx
, 
roÙ
);

441 
EMS_APP_FW_ADDRESS_DEL
:

442  
	`fw_ruËs_add»ss_d–
((
ems_fw
 *)
mod
->
ùx
, 
roÙ
);

444 
EMS_APP_FW_RADIUS_DEVICE_FREE
:

445  
	`fw_ruËs_¿dius_deviû_ä“
((
ems_fw
 *)
mod
->
ùx
, 
roÙ
);

451  
EMS_OK
;

452 
	}
}

455 
­p_moduË
 
	g­p_fw
 = {

456 .
ty
 = 
ty_fw
,

457 .
	gdesc
 = 
ems_¡ršg
("firewall"),

458 .
	gùx
 = 
NULL
,

459 .
	gæg
 = 0,

461 .
	gš™
 = 
fw_š™
,

462 .
	gunš™
 = 
fw_unš™
,

463 .
	grun
 = 
fw_run
,

464 .
	g´oûss
 = 
fw_´oûss
,

465 .
	g´oûss_ruË
 = 
NULL
,

466 .
	gv”siÚ_m©ch
 = 
NULL
,

467 .
	gš¡®l
 = 
NULL


	@src/core/app_net.c

3 
	~"ems_cÜe.h
"

4 
	~"ems_ş›Á.h
"

5 
	~"­p.h
"

6 
	~"ems_Ãtcheck.h
"

8 
ems_št


9 
	$dns_·r£_ªd_r¥
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
sockaddr_š
 *
äom
)

11 
ems_št
 
»t
;

12 
ems_ch¬
 *
qa
;

13 
ems_ch¬
 *
¿
;

14 
ems_ch¬
 *
n
;

15 
š_addr_t
 
addr
;

17 
ems_ch¬
 
buf
[] = {

24 
gw
 = 
	`cfg_g‘
(
	`emscfg
(), 
CFG_Ïn_addr
);

25 ià(!
gw
) {

26 
	`ems_as£¹
(0 && "should‚ever be here");

27  
EMS_ERR
;

31 
addr
 = 
	`š‘_addr
("192.168.19.87");

32 
	`ems_bufãr_wr™e
(&
£ss
->
buf
, 
	`buf_rd
(&£ss->
buf_š
), 
	`buf_Ën
(&sess->buf_in));

33 
	`ems_bufãr_wr™e
(&
£ss
->
buf
, buf, (buf));

34 
	`ems_bufãr_wr™e
(&
£ss
->
buf
, (
ems_ch¬
 *)&
addr
, (addr));

36 
qa
 = 
	`buf_rd
(&
£ss
->
buf
) + 2;

37 
¿
 = 
	`buf_rd
(&
£ss
->
buf
) + 3;

38 
n
 = 
	`buf_rd
(&
£ss
->
buf
) + 7;

40 *
qa
 |= 0x84;

41 *
¿
 |= 0x80;

42 *
n
 |= 0x01;

44 
»t
 = 
	`£ndto
(
	`ems_sock_fd
(&
£ss
->
sock
),

45 
	`buf_rd
(&
£ss
->
buf
),

46 
	`buf_Ën
(&
£ss
->
buf
),

48 (
sockaddr
 *)
äom
,

49 (
sockaddr_š
));

51 
	`ems_bufãr_ş—r
(&
£ss
->
buf
);

52 iàĞ
»t
 <= 0)

53  
EMS_ERR
;

55  
EMS_OK
;

56 
	}
}

58 
ems_št
 
	$dns_»dœeù
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
)

60 
sockËn_t
 
Ën
;

61 
sockaddr_š
 
äom
;

62 
»t
;

63 
ems_bufãr
 *
buf
 = &
£ss
->
buf_š
;

65 
	`ems_as£¹
(
pšg
->
£ss_dns
 =ğ
£ss
);

67 
Ën
 = (
äom
);

68 
agaš
:

69 
»t
 = 
	`»cväom
(
	`ems_sock_fd
(&
£ss
->
sock
), 
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf), 0,

70 (
sockaddr
 *)&
äom
, &
Ën
);

72 ià(
»t
 <= 0) {

73  
EMS_ERR
;

76 
	`ems_bufãr_£ek_wr
(
buf
, 
»t
, 
EMS_BUFFER_SEEK_CUR
);

78 
	`dns_·r£_ªd_r¥
(
pšg
, 
£ss
, &
äom
);

80 
	`ems_bufãr_ş—r
(
buf
);

82 
agaš
;

84  
EMS_OK
;

85 
	}
}

87 
ems_void
 
	$dns_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

89 
Ãtcheck
 *
pšg
 = (Ãtcheck *)
	`£ss_cb¬g
(
£ss
);

91 ià(
”r
) {

92 
	`ems_l_Œaû
("[pšg] dn ”¸£ss: %d", 
	`ems_sock_fd
(&
£ss
->
sock
));

93 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
pšg
->
£ss_dns
);

94 
pšg
->
£ss_dns
 = 
NULL
;

98 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

99 
	`dns_»dœeù
(
pšg
, 
£ss
);

102 
	}
}

104 
ems_št
 
	$dns_bšd
(
ems_£ssiÚ
 *
£ss
)

106 
fd
, 
rc
, 
İt
 = 1;

107 
sockaddr_š
 
addr
;

108 
ems_sock
 *
sock
 = &
£ss
->sock;

110 ià((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0)) == -1)

112 
	`ems_l_Œaû
("[pšg]sock‘ƒ¼: %s", 
	`ems_Ï¡”rmsg
());

113  
EMS_ERR
;

116 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
İt
, (opt)) == -1)

118 
	`ems_l_Œaû
("[pšg]£tsockİˆ”r: %s", 
	`ems_Ï¡”rmsg
());

119 
	`şo£
(
fd
);

120  
EMS_ERR
;

123 
	`mem£t
(&
addr
, 0, (addr));

124 
addr
.
sš_çmy
 = 
AF_INET
;

125 
addr
.
sš_pÜt
 = 
	`htÚs
(
DNS_INTERCEPT_PORT
);

126 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(0);

128 ià((
rc
 = 
	`bšd
(
fd
, (
sockaddr
 *)&
addr
, (
sockaddr_š
))) == -1)

130 
	`ems_l_Œaû
("”¸bšd: %s", 
	`ems_Ï¡”rmsg
());

131 
	`şo£
(
fd
);

132  
EMS_ERR
;

135 
	`ems_sock_£ddr
(
sock
, "0.0.0.0");

136 
	`ems_sock_£tfd
(
sock
, 
fd
);

137  
EMS_OK
;

138 
	}
}

140 
ems_št
 
	$dns_š‹rû±_¡¬t
(
Ãtcheck
 *
pšg
)

142 
ems_£ssiÚ
 *
£ss
;

143 
	`ems_as£¹
(
pšg
 !ğ
NULL
);

145 
pšg
->
£ss_dns
 = 
	`ems_£ssiÚ_Ãw
();

146 ià(!
pšg
->
£ss_dns
)

147  
EMS_ERR
;

149 ià(
	`dns_bšd
(
pšg
->
£ss_dns
è!ğ
EMS_OK
) {

150 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
pšg
->
£ss_dns
);

151 
pšg
->
£ss_dns
 = 
NULL
;

152  
EMS_ERR
;

155 
£ss
 = 
pšg
->
£ss_dns
;

156 
	`£ss_cb¬g_£t
(
£ss
, 
pšg
);

157 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
dns_evt_cb
);

159 
	`ems_l_Œaû
("[ping] dns server (%d) %s",

160 
	`ems_sock_fd
(&
£ss
->
sock
), 
	`ems_sock_addr
(&sess->sock));

162  
EMS_OK
;

163 
	}
}

165 
ems_št
 
	$dns_š‹rû±_¡İ
(
Ãtcheck
 *
pšg
)

167 
	`ems_as£¹
(
pšg
 !ğ
NULL
);

169 ià(
pšg
->
£ss_dns
) {

170 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
pšg
->
£ss_dns
);

171 
pšg
->
£ss_dns
 = 
NULL
;

174  
EMS_OK
;

175 
	}
}

177 
Ãtcheck
 *
	$Ãt_check_Ãw
()

179  (
Ãtcheck
 *)
	`ems_m®loc
((netcheck));

180 
	}
}

182 
ems_void
 
	$Ãt_check_de¡roy
(
Ãtcheck
 *
pšg
)

184 ià(
pšg
)

185 
	`ems_ä“
(
pšg
);

186 
	}
}

188 
ems_št
 
	$Ãt_š™
(
­p_moduË
 *
mod
)

190 
Ãtcheck
 *
pšg
 = 
NULL
;

192 
pšg
 = 
	`Ãt_check_Ãw
();

194 ià(
pšg
) {

195 
	`mem£t
(
pšg
, 0, (
Ãtcheck
));

197 
pšg
->
¡
 = 
¡_¡İ³d
;

198 
pšg
->
£ss
 = 
NULL
;

199 
pšg
->
£ss_dns
 = 
NULL
;

201 
mod
->
ùx
 = (
ems_void
 *)
pšg
;

204  
EMS_OK
;

205 
	}
}

207 
ems_št
 
	$Ãt_unš™
(
­p_moduË
 *
mod
)

209 
Ãtcheck
 *
pšg
 = (Ãtcheck *)
mod
->
ùx
;

211 ià(!
pšg
)

212  
EMS_OK
;

214 
mod
->
ùx
 = 
NULL
;

216 
	`ems_as£¹
(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
));

217 
	`ems_as£¹
(
pšg
->
¡
 =ğ
¡_¡İ³d
);

218 
	`ems_as£¹
(
pšg
->
£ss_dns
 =ğ
NULL
);

220 ià(
pšg
->
¡
 !ğ
¡_¡İ³d
) {

221 
	`pšg_chªge_¡©us
(
pšg
, 
¡_¡İ³d
);

222 
pšg
->
¡
 = 
¡_¡İ³d
;

225 
	`dns_š‹rû±_¡İ
(
pšg
);

226 
pšg
->
£ss
 = 
NULL
;

227 
pšg
->
£ss_dns
 = 
NULL
;

229 
	`ems_ä“
(
pšg
);

231  
EMS_OK
;

232 
	}
}

234 
ems_št
 
	$Ãt_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

236 
Ãtcheck
 *
pšg
 = (Ãtcheck *)
mod
->
ùx
;

238 
	`ems_as£¹
(
pšg
);

240 ià(
run
) {

241 ià(
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
))

242  
EMS_OK
;

244 
	`ems_l_Œaû
("net detector start");

245 
	`ems_æag_£t
(
mod
->
æg
, 
FLG_RUN
);

246 
	`pšg_chªge_¡©us
(
pšg
, 
¡_¡¬t
);

248 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

249  
EMS_OK
;

251 
	`ems_l_Œaû
("net detector stopping");

252 
	`ems_æag_un£t
(
mod
->
æg
, 
FLG_RUN
);

253 
	`pšg_chªge_¡©us
(
pšg
, 
¡_¡İ³d
);

256  
EMS_OK
;

257 
	}
}

260 
ems_št


261 
	$Ãt_dns_š‹rû±_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

263 
Ãtcheck
 *
pšg
 = (Ãtcheck *)
mod
->
ùx
;

265 ià(
run
) {

266 ià(
	`ems_æag_like
(
mod
->
æg
, 
FLG_NET_DNS_RUN
))

267  
EMS_OK
;

269 
	`ems_l_Œaû
("net dns intercept start");

270 ià(
	`dns_š‹rû±_¡¬t
(
pšg
è=ğ
EMS_OK
) {

271 
	`ems_æag_£t
(
mod
->
æg
, 
FLG_NET_DNS_RUN
);

272  
EMS_OK
;

275 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_NET_DNS_RUN
))

276  
EMS_OK
;

278 
	`ems_l_Œaû
("net dns intercept stopped");

279 
	`ems_æag_un£t
(
mod
->
æg
, 
FLG_NET_DNS_RUN
);

280  
	`dns_š‹rû±_¡İ
(
pšg
);

283  
EMS_ERR
;

284 
	}
}

286 
ems_št


287 
	$Ãt_´oûss
(
­p_moduË
 *
mod
, 
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
)

289 
	`ems_l_Œaû
("netƒvt: 0x%x, from: 0x%x,‡rgs: %s",

290 
evt
, 
s
, 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"");

292 
evt
) {

293 
EMS_APP_START
:

294  
	`Ãt_run
(
mod
, 
EMS_YES
);

296 
EMS_APP_STOP
:

297  
	`Ãt_run
(
mod
, 
EMS_NO
);

299 
EMS_APP_DNS_INTERCEPT_STOP
:

300 
	`Ãt_dns_š‹rû±_run
(
mod
, 
EMS_NO
);

307 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
)) {

308 
	`ems_l_Œaû
("net, current‚ot„unning");

309  
EMS_ERR
;

312 
evt
) {

313 
EMS_APP_DNS_INTERCEPT_START
:

314 
	`Ãt_dns_š‹rû±_run
(
mod
, 
EMS_YES
);

321  
EMS_OK
;

322 
	}
}

325 
­p_moduË
 
	g­p_Ãt
 =

327 .
ty
 = 
ty_Ãt
,

328 .
	gdesc
 = 
ems_¡ršg
("netdetect"),

329 .
	gùx
 = 
NULL
,

330 .
	gæg
 = 0,

332 .
	gš™
 = 
Ãt_š™
,

333 .
	gunš™
 = 
Ãt_unš™
,

334 .
	grun
 = 
Ãt_run
,

335 .
	g´oûss
 = 
Ãt_´oûss
,

336 .
	g´oûss_ruË
 = 
NULL
,

337 .
	gv”siÚ_m©ch
 = 
NULL
,

338 .
	gš¡®l
 = 
NULL


	@src/core/app_portal.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

5 
	~"ems_fw.h
"

6 
	~"ems_pÜl.h
"

8 
ems_št
 
±l_¡¬t
(
ems_pÜl
 *
±l
);

9 
ems_št
 
±l_¡İ
(
ems_pÜl
 *
±l
);

11 
ems_št
 
	$pÜl_cfg_š™
()

13 
ems_cfg
 *
cfg
 = 
	`emscfg
();

14 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_addr
))

15 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_addr
, "zuhu-pa.lekewifi.com");

17 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_pÜt
))

18 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_pÜt
, 
	`ems_™ß
(2000));

20 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_»dœeù
))

21 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_»dœeù
, 
	`ems_™ß
(80));

23 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_»g
))

24 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_»g
, 
	`ems_™ß
(600));

26 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_hb
))

27 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_hb
, 
	`ems_™ß
(30));

29 ià(!
	`cfg_g‘
(
	`emscfg
(), 
CFG_­p_pÜl_auto
))

30 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_auto
, 
	`ems_™ß
(1));

32  
EMS_OK
;

33 
	}
}

35 
ems_št
 
	$pÜl_š™
(
­p_moduË
 *
mod
)

37 
ems_pÜl
 *
±l
 = 
NULL
;

38 
	`ems_as£¹
(
mod
);

40 
	`pÜl_cfg_š™
();

42 
±l
 = (
ems_pÜl
 *)
	`ems_m®loc
((ems_portal));

43 ià(!
±l
)

44  
EMS_ERR
;

46 
	`mem£t
(
±l
, 0, (
ems_pÜl
));

48 
	`ems_queue_š™
(&
±l
->
u£rs
);

49 
±l
->
£ss
 = 
NULL
;

50 
	`¡r_š™
(&
±l
->
addr
);

51 
±l
->
¡
 = 
¡_¡İ³d
;

53 
mod
->
ùx
 = (
ems_void
 *)
±l
;

55  
EMS_OK
;

56 
	}
}

59 
ems_št
 
	$pÜl_unš™
(
­p_moduË
 *
mod
)

61 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
mod
->
ùx
;

63 
mod
->
ùx
 = 
NULL
;

65 ià(
±l
) {

66 
	`ems_queue_ş—r
(&
±l
->
u£rs
, 
pÜl_u£r
, 
’Œy
, 
±l_u£r_de¡roy
);

67 
	`¡r_unš™
(&
±l
->
addr
);

68 
	`ems_ä“
(
±l
);

70  
EMS_OK
;

71 
	}
}

73 
ems_št
 
	$pÜl_ruËs_upd©e
(
ems_pÜl
 *
±l
, 
jsÚ_objeù
 *
»q
, 
ems_št
 
run
)

75 
ems_ušt
 
tmp
, 
»¡¬t
;

76 
ems_¡r
 
buf
;

77 
ems_cfg
 *
cfg
 = 
	`emscfg
();

79 
»¡¬t
 = 0;

80 
	`¡r_š™
(&
buf
);

82 
	`ems_jsÚ_g‘_¡ršg_def
(
»q
, "addr", &
buf
, 
NULL
);

83 ià(
	`¡r_Ën
(&
buf
) > 0) {

84 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_addr
, 
	`¡r_‹xt
(&
buf
));

86 ià(!
»¡¬t
 &&

87 ((
	`¡r_Ën
(&
±l
->
addr
è!ğ¡r_Ën(&
buf
)) ||

88 
	`¡rcmp
(
	`¡r_‹xt
(&
±l
->
addr
), sŒ_‹xt(&
buf
))))

90 
»¡¬t
 = 1;

94 ià(
	`¡rcmp
("127.0.0.1", 
	`cfg_g‘
(
	`emscfg
(), 
CFG_­p_pÜl_addr
))){

95 
	`ems_æag_£t
(
	`emscÜ”
()->
æg
, 
FLG_CONFIG_READY
);

98 
	`ems_jsÚ_g‘_št_def
(
»q
, "pÜt", 
tmp
, 2000);

99 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_pÜt
, 
	`ems_™ß
(
tmp
));

100 ià(!
»¡¬t
 && 
tmp
 !ğ
±l
->
pÜt
)„estart = 1;

102 
	`ems_jsÚ_g‘_št_def
(
»q
, "»g_³riod", 
tmp
, 600);

103 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_»g
, 
	`ems_™ß
(
tmp
));

104 ià(
tmp
 > 0è
±l
->
»g_³riod
 =mp;

106 
	`ems_jsÚ_g‘_št_def
(
»q
, "hb_³riod", 
tmp
, 30);

107 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_hb
, 
	`ems_™ß
(
tmp
));

108 ià(
tmp
 > 0è
±l
->
hb_³riod
 =mp;

110 
	`ems_jsÚ_g‘_št_def
(
»q
, "»dœeù_pÜt", 
tmp
, 80);

111 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_»dœeù
, 
	`ems_™ß
(
tmp
));

113 
	`¡r_unš™
(&
buf
);

115 ià(
run
 && 
»¡¬t
) {

116 
	`ems_l_Œaû
("portal„estart...");

117 
	`±l_¡İ
(
±l
);

118 
	`±l_¡¬t
(
±l
);

121  
EMS_OK
;

122 
	}
}

124 
ems_št
 
	$pÜl_­p_ruËs_upd©e
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
»q
, 
ems_št
 
run
)

126 
ems_cfg
 *
cfg
 = 
	`emscfg
();

127 
ems_ušt
 
tmp
;

128 
ems_cÜe
 *
cÜe
 = 
	`emscÜ”
();

129 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
mod
->
ùx
;

131 
	`ems_jsÚ_g‘_št_def
(
»q
, "auto", 
tmp
, 1);

132 
	`cfg_£t
(
cfg
, 
CFG_­p_pÜl_auto
, 
	`ems_™ß
(
tmp
));

134 ià(
tmp
)

135 
	`ems_æag_£t
(
cÜe
->
æg
, 
FLG_PORTAL_AUTO
);

137 
	`ems_æag_un£t
(
cÜe
->
æg
, 
FLG_PORTAL_AUTO
);

139 ià(
tmp
)

140  
EMS_OK
;

142  
	`pÜl_ruËs_upd©e
(
±l
, 
»q
, 
run
);

143 
	}
}

145 
ems_št


146 
	$pÜl_­p_auth_r¥
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

148 
jsÚ_objeù
 *
obj
;

149 
ems_št
 
”r
;

150 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
mod
->
ùx
;

152 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "”rÜ_code", 
”r
, 0);

154 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "userip");

155 
	`ems_as£¹
(
obj
 !ğ
NULL
);

157 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

158  
EMS_ERR
;

160  
	`±l_u£r_auth_r¥
(
±l
, 
	`±l_u£r_fšd
Õ, 
	`jsÚ_objeù_g‘_¡ršg
(
obj
)), 
”r
);

161 
	}
}

163 
ems_št


164 
	$pÜl_­p_logout
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

166 
jsÚ_objeù
 *
obj
;

167 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
mod
->
ùx
;

169 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "userip");

170 
	`ems_as£¹
(
obj
 !ğ
NULL
);

172 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

173  
EMS_ERR
;

175  
	`±l_u£r_Áf_logout
(
±l
, 
	`±l_u£r_fšd
Õ, 
	`jsÚ_objeù_g‘_¡ršg
(
obj
)));

176 
	}
}

178 
ems_št


179 
	$pÜl_­p_£rv”_ruËs_upd©e
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

181 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
mod
->
ùx
;

183 ià(!
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_­p_pÜl_auto
))) {

184 
	`ems_l_Œaû
("use user defined configs...");

185  
EMS_OK
;

188  
	`pÜl_ruËs_upd©e
(
±l
, 
roÙ
, 
EMS_YES
);

189 
	}
}

191 
ems_št


192 
	$pÜl_­p_evt_¡©us
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

194 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
mod
->
ùx
;

195  
±l
->
Ï¡”r
;

196 
	}
}

198 
ems_št


199 
	$pÜl_evt_add»ss
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

201 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
mod
->
ùx
;

202  
	`±l_cu¼’t_add»ss
(
±l
);

203 
	}
}

205 
ems_št
 
pÜl_run
(
­p_moduË
 *
mod
,ƒms_šˆ
run
);

207 
ems_št


208 
	$pÜl_´oûss
(
­p_moduË
 *
mod
, 
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
)

210 
	`ems_l_Œaû
("pÜÈgÙƒvt: 0x%x,‡rgs: %s", 
evt
, 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
roÙ
));

212 
evt
) {

213 
EMS_APP_START
:

214  
	`pÜl_run
(
mod
, 
EMS_YES
);

216 
EMS_APP_STOP
:

217  
	`pÜl_run
(
mod
, 
EMS_NO
);

219 
EMS_APP_RULES_UPDATE
:

220  
	`pÜl_­p_ruËs_upd©e
(
mod
, 
roÙ
, 
	`ems_æag_like
(mod->
æg
, 
FLG_RUN
));

226 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

227  
EMS_ERR
;

229 
evt
) {

230 
EMS_APP_EVT_FW_RELOAD
:

232 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
mod
->
ùx
;

233 
jsÚ_objeù
 *
¬y
;

234 
¬y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

236 
	`jsÚ_objeù_¬¿y_add
(
¬y
, 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
±l
->
addr
)));

237 
	`ems_­p_´oûss
(
ty_pÜl
, 
ty_fw
, 
EMS_APP_FW_ADDRESS_ADD
, 
¬y
);

239 
	`jsÚ_objeù_put
(
¬y
);

240  
EMS_OK
;

244 
EMS_APP_RULES_UPDATE
:

245  
	`pÜl_­p_ruËs_upd©e
(
mod
, 
roÙ
, 
EMS_YES
);

247 
EMS_APP_CMD_RADIUS_AUTH_RSP
:

248  
	`pÜl_­p_auth_r¥
(
mod
, 
roÙ
);

250 
EMS_APP_CMD_PORTAL_LOGOUT
:

251  
	`pÜl_­p_logout
(
mod
, 
roÙ
);

253 
EMS_APP_SERVER_RULES_UPDATE
:

254  
	`pÜl_­p_£rv”_ruËs_upd©e
(
mod
, 
roÙ
);

256 
EMS_APP_EVT_STATUS
:

257  
	`pÜl_­p_evt_¡©us
(
mod
, 
roÙ
);

259 
EMS_APP_PORTAL_ADDRESS
:

260  
	`pÜl_evt_add»ss
(
mod
, 
roÙ
);

266  
EMS_OK
;

267 
	}
}

269 
ems_št
 
	$pÜl_´oûss_ruË
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

271  
EMS_OK
;

272 
	}
}

274 
ems_št
 
	$±l_¡¬t
(
ems_pÜl
 *
±l
)

276 
ems_cfg
 *
cfg
 = 
	`emscfg
();

278 
	`¡r_£t
(&
±l
->
addr
, 
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_addr
));

279 
±l
->
pÜt
 = 
	`ems_©oi
(
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_pÜt
));

280 
±l
->
»g_³riod
 = 
	`ems_©oi
(
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_»g
));

281 
±l
->
hb_³riod
 = 
	`ems_©oi
(
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_hb
));

283 
	`ems_l_Œaû
("portal start: (%s:%d,„eg: %d, hb: %d)",

284 
	`¡r_‹xt
(&
±l
->
addr
),…->
pÜt
,…->
»g_³riod
,…->
hb_³riod
);

286 
jsÚ_objeù
 *
¬y
;

287 
¬y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

289 
	`jsÚ_objeù_¬¿y_add
(
¬y
, 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
±l
->
addr
)));

290 
	`ems_­p_´oûss
(
ty_pÜl
, 
ty_fw
, 
EMS_APP_FW_ADDRESS_ADD
, 
¬y
);

292 
	`jsÚ_objeù_put
(
¬y
);

294  
	`pÜl_chªge_¡©us
(
±l
, 
¡_¡¬t
);

295 
	}
}

297 
ems_št
 
	$±l_¡İ
(
ems_pÜl
 *
±l
)

299 
	`ems_as£¹
(
	`¡r_Ën
(&
±l
->
addr
è> 0 && 
	`¡r_‹xt
(&ptl->addr));

301 
jsÚ_objeù
 *
¬y
;

302 
¬y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

304 
	`jsÚ_objeù_¬¿y_add
(
¬y
, 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
±l
->
addr
)));

305 
	`ems_­p_´oûss
(
ty_pÜl
, 
ty_fw
, 
EMS_APP_FW_ADDRESS_DEL
, 
¬y
);

307 
	`jsÚ_objeù_put
(
¬y
);

309  
	`pÜl_chªge_¡©us
(
±l
, 
¡_¡İ³d
);

310 
	}
}

312 
ems_št
 
	$pÜl_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

314 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
mod
->
ùx
;

315 
	`ems_as£¹
(
mod
 && 
±l
);

317 ià(
run
) {

318 ià(
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
))

319  
EMS_OK
;

321 
	`ems_l_Œaû
("portal„unning here");

322 ià(
	`±l_¡¬t
(
±l
è=ğ
EMS_OK
)

323 
	`ems_æag_£t
(
mod
->
æg
, 
FLG_RUN
);

325 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

326  
EMS_OK
;

328 
	`±l_¡İ
(
±l
);

329 
	`ems_æag_un£t
(
mod
->
æg
, 
FLG_RUN
);

330 
	`ems_l_Œaû
("portal stopped");

333  
EMS_OK
;

334 
	}
}

336 
­p_moduË
 
	g­p_pÜl
 = {

338 .
ty
 = 
ty_pÜl
,

339 .
	gdesc
 = 
ems_¡ršg
("portal"),

340 .
	gùx
 = 
NULL
,

341 .
	gæg
 = 0,

343 .
	gš™
 = 
pÜl_š™
,

344 .
	gunš™
 = 
pÜl_unš™
,

345 .
	grun
 = 
pÜl_run
,

346 .
	g´oûss
 = 
pÜl_´oûss
,

347 .
	g´oûss_ruË
 = 
pÜl_´oûss_ruË
,

348 .
	gv”siÚ_m©ch
 = 
NULL
,

349 .
	gš¡®l
 = 
NULL


	@src/core/app_radius.c

3 
	~"ems_cÜe.h
"

4 
	~"ems_ş›Á.h
"

5 
	~"­p.h
"

6 
	~"ems_¿dius.h
"

7 
	~"ems_fw.h
"

9 
ems_deviû
 *
	$¿dius_fšd_dev
(
ems_¿dius
 *
¿
, 
ems_cch¬
 *

)

11 
ems_queue
 *
p
;

12 
ems_deviû
 *
dev
;

14 
	`ems_queue_fÜ—ch
(&
¿
->
dev_’Œy
, 
p
) {

15 
dev
 = 
	`ems_cÚš”_of
(
p
, 
ems_deviû
, 
’Œy
);

17 ià(!
	`¡rcmp
(
	`¡r_‹xt
(&
dev
->
u£r
.

), ip))

18  
dev
;

21  
NULL
;

22 
	}
}

24 
rc_hªdË
 *
	$¿dius_ü—‹_hªdË
()

26 
ems_cch¬
 *
æ
;

27 
rc_hªdË
 *
rh
 = 
NULL
;

29 
rh
 = 
	`rc_Ãw
();

30 ià(!
rh
)

31  
NULL
;

33 
	`rc_cÚfig_š™
(
rh
);

35 
æ
 = 
	`cfg_g‘
(
	`emscfg
(), 
CFG_¿dius_diù
);

36 ià(!
æ
) {

37 
	`cfg_£t
(
	`emscfg
(), 
CFG_¿dius_diù
, "/usr/ems/conf/dictionary");

38 
æ
 = 
	`cfg_g‘
(
	`emscfg
(), 
CFG_¿dius_diù
);

41 ià(
	`rc_»ad_diùiÚ¬y
(
rh
, 
æ
) != 0) {

42 
	`rc_de¡roy
(
rh
);

43  
NULL
;

46  
rh
;

47 
	}
}

49 
ems_št
 
	$¿dius_¡¬t
(
ems_¿dius
 *
¿
)

51 
ems_cfg
 *
cfg
 = 
	`emscfg
();

52 
ems_cch¬
 *
v®
 = 
NULL
;

54 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_addr
);

56 ià(
v®
) {

57 
	`¡r_£t
(&
¿
->
auth_addr
, 
v®
);

58 
	`¡r_£t
(&
¿
->
acù_addr
, 
v®
);

60 
	`ems_as£¹
(0 && "never be here");

61 
	`ems_l_Œaû
("¿diu ¡¬ˆçed, % missšg", 
CFG_­p_¿dius_addr
);

62  
EMS_ERR
;

65 
¿
->
auth_pÜt
 = 
	`ems_©oi
(
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_pÜt_auth
));

66 
¿
->
acù_pÜt
 = 
	`ems_©oi
(
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_pÜt_acù
));

68 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_sh¬ed_key
);

69 ià(
v®
)

70 
	`¡r_£t
(&
¿
->
£ü‘
, 
v®
);

72 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_»Œy_times
);

73 ià(
v®
)

74 
¿
->
»Œy_times
 = 
	`ems_©oi
(
v®
);

76 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_»Œy_timeout
);

77 ià(
v®
)

78 
¿
->
»Œy_timeout
 = 
	`ems_©oi
(
v®
);

80 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_»pÜt_³riod
);

81 ià(
v®
)

82 
¿
->
»pÜt_³riod
 = 
	`ems_©oi
(
v®
);

84 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_discÚÃù
);

85 ià(
v®
)

86 
¿
->
discÚÃù
 = 
	`ems_©oi
(
v®
);

88 
¿
->
Ï¡”r
 = 0;

90  
EMS_OK
;

91 
	}
}

93 
ems_št
 
	$¿dius_¡İ
(
ems_¿dius
 *
¿
)

95 
ems_queue
 *
p
;

96 
ems_deviû
 *
dev
;

98 
¿
->
Ï¡”r
 = 0;

99 
	`ems_queue_fÜ—ch
(&
¿
->
dev_’Œy
, 
p
) {

100 
dev
 = 
	`ems_cÚš”_of
(
p
, 
ems_deviû
, 
’Œy
);

101 
dev
->
”r
 = 7;

102 
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

105  
EMS_OK
;

106 
	}
}

108 
ems_¿dius
 *
	$¿dius_Ãw
()

110  (
ems_¿dius
 *)
	`ems_m®loc
((ems_radius));

111 
	}
}

113 
ems_void
 
	$¿dius_de¡roy
(
ems_¿dius
 *
¿
)

115 ià(
¿
)

116 
	`ems_ä“
(
¿
);

117 
	}
}

119 
ems_št
 
	$¿dius_š™
(
ems_¿dius
 *
¿
)

121 
	`ems_as£¹
(
¿
 !ğ
NULL
);

122 
	`mem£t
(
¿
, 0, (
ems_¿dius
));

124 
	`ems_queue_š™
(&
¿
->
dev_’Œy
);

125 
¿
->
£q_nbr
 = 
	`time
(
NULL
);

126 
	`¡r_š™
(&
¿
->
£ü‘
);

127 
	`¡r_š™
(&
¿
->
auth_addr
);

128 
	`¡r_š™
(&
¿
->
acù_addr
);

130 
¿
->
»Œy_times
 = 3;

131 
¿
->
»Œy_timeout
 = 10;

132 
¿
->
»pÜt_³riod
 = 300;

133 
¿
->
discÚÃù
 = 300;

135 
¿
->
rh
 = 
	`¿dius_ü—‹_hªdË
();

136 ià(!
¿
->
rh
)

137  
EMS_ERR
;

139  
EMS_OK
;

140 
	}
}

142 
ems_št
 
	$¿dius_unš™
(
ems_¿dius
 *
¿
)

144 
ems_queue
 *
p
, *
q
;

145 
ems_deviû
 *
dev
;

147 ià(!
¿
)

148  
EMS_OK
;

150 ià(
¿
->
rh
) {

151 
	`rc_de¡roy
(
¿
->
rh
);

152 
¿
->
rh
 = 
NULL
;

155 
	`ems_queue_fÜ—ch_§ã
(&
¿
->
dev_’Œy
, 
p
, 
q
) {

156 
dev
 = 
	`ems_cÚš”_of
(
p
, 
ems_deviû
, 
’Œy
);

157 
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

160 
	`¡r_unš™
(&
¿
->
£ü‘
);

161 
	`¡r_unš™
(&
¿
->
auth_addr
);

162 
	`¡r_unš™
(&
¿
->
acù_addr
);

164  
EMS_OK
;

165 
	}
}

167 
ems_št
 
	$¿dius_cfg_š™
()

169 
ems_cfg
 *
cfg
 = 
	`emscfg
();

170 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_addr
))

171 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_addr
, "zuhu-pa.lekewifi.com");

173 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_pÜt_auth
))

174 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_pÜt_auth
, 
	`ems_™ß
(1812));

176 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_pÜt_acù
))

177 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_pÜt_acù
, 
	`ems_™ß
(1813));

179 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_sh¬ed_key
))

180 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_sh¬ed_key
, "admin");

182 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_»pÜt_³riod
))

183 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_»pÜt_³riod
, 
	`ems_™ß
(300));

185 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_discÚÃù
))

186 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_discÚÃù
, 
	`ems_™ß
(300));

188 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_auto
))

189 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_auto
, 
	`ems_™ß
(1));

191 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_»Œy_times
))

192 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_»Œy_times
, 
	`ems_™ß
(3));

194 ià(!
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_»Œy_timeout
))

195 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_»Œy_timeout
, 
	`ems_™ß
(5));

197  
EMS_OK
;

198 
	}
}

201 
ems_št
 
	$¿_š™
(
­p_moduË
 *
mod
)

203 
	`¿dius_cfg_š™
();

205 
mod
->
ùx
 = (
ems_void
 *)
	`¿dius_Ãw
();

206 ià(!
mod
->
ùx
)

207  
EMS_ERR
;

209 
	`¿dius_š™
((
ems_¿dius
 *)
mod
->
ùx
);

211  
EMS_OK
;

212 
	}
}

214 
ems_št
 
	$¿_unš™
(
­p_moduË
 *
mod
)

216 
ems_¿dius
 *
¿
 = (ems_¿diu *)
mod
->
ùx
;

218 ià(
¿
) {

219 
mod
->
ùx
 = 
NULL
;

221 
	`¿dius_unš™
(
¿
);

222 
	`¿dius_de¡roy
(
¿
);

223 
¿
 = 
NULL
;

226  
EMS_OK
;

227 
	}
}

229 
ems_št
 
	$¿dius_g‘_ruËs
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

231 
ems_¡r
 
buf
;

232 
ems_ušt
 
tmp
;

233 
ems_cfg
 *
cfg
 = 
	`emscfg
();

235 
	`ems_l_Œaû
("¿diu ´oûs ruË: %s", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
roÙ
));

237 ià(!
	`jsÚ_objeù_is_ty³
(
roÙ
, 
jsÚ_ty³_objeù
))

238  
EMS_OK
;

240 
	`¡r_š™
(&
buf
);

242 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "addr", &
buf
, 
NULL
);

243 ià(
	`¡r_Ën
(&
buf
) > 0)

244 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_addr
, 
	`¡r_‹xt
(&
buf
));

246 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "auth_pÜt", 
tmp
, 0);

247 ià(
tmp
 > 0)

248 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_pÜt_auth
, 
	`ems_™ß
(
tmp
));

250 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "acù_pÜt", 
tmp
, 0);

251 ià(
tmp
 > 0)

252 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_pÜt_acù
, 
	`ems_™ß
(
tmp
));

254 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "£ü‘", &
buf
, 
NULL
);

255 ià(
	`¡r_Ën
(&
buf
) > 0)

256 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_sh¬ed_key
, 
	`¡r_‹xt
(&
buf
));

258 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "»pÜt_³riod", 
tmp
, 0);

259 ià(
tmp
 > 0)

260 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_»pÜt_³riod
, 
	`ems_™ß
(
tmp
));

262 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "discÚÃù", 
tmp
, 0);

263 ià(
tmp
 > 0)

264 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_discÚÃù
, 
	`ems_™ß
(
tmp
));

266 
	`¡r_unš™
(&
buf
);

268 
	`ems_l_Œaû
("radius„ule:‡ddr: %s:…ort‡uth: %s,…ort count: %s shared key: %s,„eport…eriod: %s, disconnect: %s",

269 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_addr
),

270 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_pÜt_auth
),

271 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_pÜt_acù
),

272 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_sh¬ed_key
),

273 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_»pÜt_³riod
),

274 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_discÚÃù
)

276  
EMS_OK
;

277 
	}
}

279 
ems_deviû
 *
	$ems_deviû_Ãw
()

281 
ems_deviû
 *
dev
 = 
NULL
;

283 
dev
 = (
ems_deviû
 *)
	`ems_m®loc
((ems_device));

284 ià(
dev
) {

285 
	`mem£t
(
dev
, 0, (
ems_deviû
));

286 
	`ems_queue_š™
(&
dev
->
’Œy
);

288 
dev
->
£ss_dev
 = 
NULL
;

289 
dev
->
£ss
 = 
NULL
;

290 
dev
->
ùx
 = 
NULL
;

291 
	`¡r_š™
(&
dev
->
u£r
.
Çme
);

292 
	`¡r_š™
(&
dev
->
u£r
.
·ss
);

293 
	`¡r_š™
(&
dev
->
u£r
.
mac
);

294 
	`¡r_š™
(&
dev
->
u£r
.

);

295 
	`¡r_š™
(&
dev
->
u£r
.
£ssid
);

297 
dev
->
u£r
.
š_by‹s
 = 0;

298 
dev
->
u£r
.
out_by‹s
 = 0;

299 
dev
->
u£r
.
š_pkgs
 = 0;

300 
dev
->
u£r
.
out_pkgs
 = 0;

302 
dev
->
»Œy_times
 = 0;

303 
dev
->
»Œy_timeout
 = 0;

304 
dev
->
»asÚ
 = 0;

305 
dev
->
”r
 = 0;

306 
dev
->
vp_out
 = 
NULL
;

307 
dev
->
vp_š
 = 
NULL
;

308 
dev
->
auth_out
 = 
NULL
;

309 
dev
->
auth_š
 = 
NULL
;

311 
dev
->
¡
 = 
¡_¡İ³d
;

314  
dev
;

315 
	}
}

317 
ems_void
 
	$ems_deviû_de¡roy
(
ems_deviû
 *
dev
)

319 ià(
dev
) {

320 ià(
dev
->
vp_out
) {

321 
	`rc_av·œ_ä“
(
dev
->
vp_out
);

322 
dev
->
vp_out
 = 
NULL
;

325 ià(
dev
->
vp_š
) {

326 
	`rc_av·œ_ä“
(
dev
->
vp_š
);

327 
dev
->
vp_š
 = 
NULL
;

330 
	`¡r_unš™
(&
dev
->
u£r
.
Çme
);

331 
	`¡r_unš™
(&
dev
->
u£r
.
·ss
);

332 
	`¡r_unš™
(&
dev
->
u£r
.
mac
);

333 
	`¡r_unš™
(&
dev
->
u£r
.

);

334 
	`¡r_unš™
(&
dev
->
u£r
.
£ssid
);

336 ià(
dev
->
£ss_dev
) {

337 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
dev
->
£ss_dev
);

338 
dev
->
£ss_dev
 = 
NULL
;

341 ià(
dev
->
£ss
) {

342 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
dev
->
£ss
);

343 
dev
->
£ss
 = 
NULL
;

346 
	`ems_ä“
(
dev
);

348 
	}
}

350 
ems_št


351 
	$¿dius_u£r_š
(
ems_¿dius
 *
¿
, 
ems_¡r
 *
Çme
,ƒms_¡¸*
·ss
,ƒms_¡¸*

,ƒms_¡¸*
mac
)

353 
ems_deviû
 *
dev
 = 
	`ems_deviû_Ãw
();

354 
	`ems_l_Œaû
("user user in : %s, %s, %s, %s",

355 
	`¡r_‹xt
(
Çme
), sŒ_‹xt(
·ss
),¡r_‹xt(

), sŒ_‹xt(
mac
));

357 ià(!
dev
)

358  
EMS_ERR
;

360 
	`¡r_ıy
(&
dev
->
u£r
.
Çme
,‚ame);

361 
	`¡r_ıy
(&
dev
->
u£r
.
·ss
,…ass);

362 
	`¡r_ıy
(&
dev
->
u£r
.

, ip);

363 
	`¡r_ıy
(&
dev
->
u£r
.
mac
, mac);

365 
dev
->
ùx
 = 
¿
;

366 
dev
->
discÚÃù
 = 
¿
->discÚÃù / (¿->
»pÜt_³riod
 + 6) + 1;

368 
	`ems_queue_š£¹_
(&
¿
->
dev_’Œy
, &
dev
->
’Œy
);

370  
	`dev_chªge_¡©us
(
dev
, 
¡_¡¬t
);

371 
	}
}

373 
ems_št
 
	$¿dius_cmd_auth
(
ems_¿dius
 *
¿
, 
jsÚ_objeù
 *
roÙ
)

375 
ems_št
 
¹n
;

376 
ems_¡r
 
Çme
, 
·ss
, 

, 
mac
;

377 
ems_deviû
 *
dev
;

379 
	`¡r_š™
(&
Çme
);

380 
	`¡r_š™
(&
·ss
);

381 
	`¡r_š™
(&

);

382 
	`¡r_š™
(&
mac
);

385 
¹n
 = 
EMS_ERR
;

387 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "u£ºame", &
Çme
, 
NULL
);

388 ià(
	`¡r_Ën
(&
Çme
) <= 0) ;

390 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "u£½ass", &
·ss
, 
NULL
);

391 ià(
	`¡r_Ën
(&
·ss
) <= 0) ;

393 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "u£r", &

, 
NULL
);

394 ià(
	`¡r_Ën
(&

) <= 0) ;

396 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "u£rmac", &
mac
, 
NULL
);

397 ià(
	`¡r_Ën
(&
mac
) <= 0) ;

399 
dev
 = 
	`¿dius_fšd_dev
(
¿
, 
	`¡r_‹xt
(&

));

400 ià(
dev
) {

402 ià(!
	`¡rcmp
(
	`¡r_‹xt
(&
dev
->
u£r
.
mac
), str_text(&mac))) {

404 
	`¡r_£t
(&
dev
->
u£r
.
Çme
, 
	`¡r_‹xt
(&name));

405 
	`¡r_£t
(&
dev
->
u£r
.
·ss
, 
	`¡r_‹xt
(&pass));

406 
¹n
 = 
	`dev_chªge_¡©us
(
dev
, 
¡_¡¬t
);

410 
	`ems_l_Œaû
("ip(%s) user mac changed: %s --> %s",

411 
	`¡r_‹xt
(&

), sŒ_‹xt(&
dev
->
u£r
.
mac
), str_text(&mac));

412 
dev
->
”r
 = 2;

413 
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

416 
¹n
 = 
	`¿dius_u£r_š
(
¿
, &
Çme
, &
·ss
, &

, &
mac
);

419 
	`¡r_unš™
(&
Çme
);

420 
	`¡r_unš™
(&
·ss
);

421 
	`¡r_unš™
(&

);

422 
	`¡r_unš™
(&
mac
);

424  
¹n
;

425 
	}
}

427 
ems_št
 
	$¿dius_cmd_logout
(
ems_¿dius
 *
¿
, 
jsÚ_objeù
 *
roÙ
)

429 
ems_št
 
¹n
;

430 
ems_¡r
 
Çme
, 

, 
mac
;

431 
ems_deviû
 *
dev
 = 
NULL
;

433 
	`¡r_š™
(&
Çme
);

434 
	`¡r_š™
(&

);

435 
	`¡r_š™
(&
mac
);

438 
¹n
 = 
EMS_ERR
;

440 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "u£ºame", &
Çme
, 
NULL
);

441 ià(
	`¡r_Ën
(&
Çme
) <= 0) ;

443 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "u£r", &

, 
NULL
);

444 ià(
	`¡r_Ën
(&

) <= 0) ;

446 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "u£rmac", &
mac
, 
NULL
);

447 ià(
	`¡r_Ën
(&
mac
) <= 0) ;

449 
dev
 = 
	`¿dius_fšd_dev
(
¿
, 
	`¡r_‹xt
(&

));

450 ià(
dev
) {

451 ià(!
	`¡rcmp
(
	`¡r_‹xt
(&
dev
->
u£r
.
mac
), str_text(&mac))) {

452 
	`ems_l_Œaû
("(%sèu£¸logout", 
	`¡r_‹xt
(&

));

453 
dev
->
”r
 = 1;

454 
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

458 
¹n
 = 
EMS_OK
;

461 
	`¡r_unš™
(&
Çme
);

462 
	`¡r_unš™
(&

);

463 
	`¡r_unš™
(&
mac
);

465  
¹n
;

466 
	}
}

468 
ems_št
 
	$¿dius_evt_fw_»lßd
(
ems_¿dius
 *
¿
, 
jsÚ_objeù
 *
roÙ
)

470 
ems_queue
 *
p
;

471 
ems_deviû
 *
dev
;

472 
jsÚ_objeù
 *
obj
;

473 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

475 
	`ems_queue_fÜ—ch
(&
¿
->
dev_’Œy
, 
p
) {

476 
dev
 = 
	`ems_cÚš”_of
(
p
, 
ems_deviû
, 
’Œy
);

478 
	`jsÚ_objeù_objeù_add
(
obj
, "userip",

479 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.

)));

480 
	`jsÚ_objeù_objeù_add
(
obj
, "usermac",

481 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
mac
)));

482 
	`jsÚ_objeù_objeù_add
(
obj
, "add",

483 
	`jsÚ_objeù_Ãw_št
(1));

485 
	`ems_­p_´oûss
(
ty_¿dius
, 
ty_fw
, 
EMS_APP_FW_RADIUS_DEVICE_FREE
, 
obj
);

488 
	`jsÚ_objeù_put
(
obj
);

490  
EMS_OK
;

491 
	}
}

494 
ems_št
 
	$¿dius_ruËs_upd©e
(
ems_¿dius
 *
¿
, 
jsÚ_objeù
 *
»q
, 
ems_št
 
run
)

496 
ems_ušt
 
tmp
, 
»¡¬t
;

497 
ems_¡r
 
buf
;

498 
ems_cfg
 *
cfg
 = 
	`emscfg
();

500 
	`¡r_š™
(&
buf
);

502 
»¡¬t
 = 0;

503 
	`ems_jsÚ_g‘_¡ršg_def
(
»q
, "addr", &
buf
, 
NULL
);

504 ià(
	`¡r_Ën
(&
buf
) > 0) {

505 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_addr
, 
	`¡r_‹xt
(&
buf
));

507 ià(!
»¡¬t
 &&

508 (
	`¡r_Ën
(&
buf
è!ğ¡r_Ën(&
¿
->
auth_addr
) ||

509 
	`¡rcmp
(
	`¡r_‹xt
(&
buf
), sŒ_‹xt(&
¿
->
auth_addr
))

512 
»¡¬t
 = 1;

516 
	`ems_jsÚ_g‘_¡ršg_def
(
»q
, "£ü‘", &
buf
, 
NULL
);

517 ià(
	`¡r_Ën
(&
buf
) > 0) {

518 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_sh¬ed_key
, 
	`¡r_‹xt
(&
buf
));

519 ià(!
»¡¬t
 &&

520 (
	`¡r_Ën
(&
buf
)!ğ¡r_Ën(&
¿
->
£ü‘
) ||

521 
	`¡rcmp
(
	`¡r_‹xt
(&
buf
), sŒ_‹xt(&
¿
->
£ü‘
))

524 
»¡¬t
 = 1;

528 
	`ems_jsÚ_g‘_št_def
(
»q
, "authpÜt", 
tmp
, 1812);

529 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_pÜt_auth
, 
	`ems_™ß
(
tmp
));

530 ià(!
»¡¬t
 && 
tmp
 !ğ
¿
->
auth_pÜt
)„estart = 1;

532 
	`ems_jsÚ_g‘_št_def
(
»q
, "acùpÜt", 
tmp
, 1813);

533 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_pÜt_acù
, 
	`ems_™ß
(
tmp
));

534 ià(!
»¡¬t
 && 
tmp
 !ğ
¿
->
acù_pÜt
)„estart = 1;

536 
	`ems_jsÚ_g‘_št_def
(
»q
, "½_³riod", 
tmp
, 300);

537 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_»pÜt_³riod
, 
	`ems_™ß
(
tmp
));

538 
¿
->
»pÜt_³riod
 = 
tmp
;

540 
	`ems_jsÚ_g‘_št_def
(
»q
, "discÚÃù", 
tmp
, 0);

541 ià(
tmp
 > 0) {

542 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_discÚÃù
, 
	`ems_™ß
(
tmp
));

543 
¿
->
discÚÃù
 = 
tmp
;

546 
	`ems_jsÚ_g‘_št_def
(
»q
, "»Œy_times", 
tmp
, 3);

547 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_»Œy_times
, 
	`ems_™ß
(
tmp
));

548 
¿
->
»Œy_times
 = 
tmp
;

550 
	`ems_jsÚ_g‘_št_def
(
»q
, "»Œy_timeout", 
tmp
, 5);

551 
	`cfg_£t
(
cfg
, 
CFG_­p_¿dius_»Œy_timeout
, 
	`ems_™ß
(
tmp
));

552 
¿
->
»Œy_timeout
 = 
tmp
;

554 
	`¡r_unš™
(&
buf
);

556 ià(
run
 && 
»¡¬t
) {

557 
	`ems_l_Œaû
("radius„estart...");

558 
	`¿dius_¡İ
(
¿
);

559 
	`¿dius_¡¬t
(
¿
);

562  
EMS_OK
;

563 
	}
}

565 
ems_št
 
	$¿dius_evt_ruËs_upd©e
(
ems_¿dius
 *
¿
, 
jsÚ_objeù
 *
»q
, 
ems_št
 
run
)

567 
ems_ušt
 
tmp
;

568 
ems_cÜe
 *
cÜe
 = 
	`emscÜ”
();

570 
	`ems_jsÚ_g‘_št_def
(
»q
, "auto", 
tmp
, 1);

571 ià(
tmp
)

572 
	`ems_æag_£t
(
cÜe
->
æg
, 
FLG_RADIUS_AUTO
);

574 
	`ems_æag_un£t
(
cÜe
->
æg
, 
FLG_RADIUS_AUTO
);

576 
	`cfg_£t
(
	`emscfg
(), 
CFG_­p_¿dius_auto
, 
	`ems_™ß
(
tmp
));

578 ià(
tmp
)

579  
EMS_OK
;

581  
	`¿dius_ruËs_upd©e
(
¿
, 
»q
, 
run
);

582 
	}
}

584 
ems_št
 
	$¿dius_evt_£rv”_ruËs_upd©e
(
ems_¿dius
 *
¿
, 
jsÚ_objeù
 *
»q
)

586 ià(!
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_­p_¿dius_auto
))) {

587 
	`ems_l_Œaû
("use user defined configs...");

588  
EMS_OK
;

591  
	`¿dius_ruËs_upd©e
(
¿
, 
»q
, 
EMS_YES
);

592 
	}
}

595 
ems_št
 
	$¿dius_evt_¡©us
(
ems_¿dius
 *
¿
, 
jsÚ_objeù
 *
roÙ
)

597 
¿
->
Ï¡”r
) {

598 
RADIUS_ERR_CANNOT_CONNECT
:

599 
RADIUS_ERR_REJECT
:

600 
RADIUS_ERR_NETWORK
:

601  
¿
->
Ï¡”r
;

609 
	}
}

611 
ems_št
 
¿_run
(
­p_moduË
 *
mod
,ƒms_šˆ
run
);

613 
ems_št


614 
	$¿_´oûss
(
­p_moduË
 *
mod
, 
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
roÙ
)

616 
ems_¿dius
 *
¿
 = (ems_¿diu *è
mod
->
ùx
;

618 
	`ems_l_Œaû
("¿diu gÙƒvt: 0x%x,‡rgs: %s", 
evt
, 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
roÙ
));

620 
evt
) {

621 
EMS_APP_STOP
:

622  
	`¿_run
(
mod
, 
EMS_NO
);

624 
EMS_APP_START
:

625  
	`¿_run
(
mod
, 
EMS_YES
);

627 
EMS_APP_RULES_UPDATE
:

628  
	`¿dius_evt_ruËs_upd©e
(
¿
, 
roÙ
, 
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
));

634 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

635  
EMS_ERR
;

637 
	`ems_as£¹
(
mod
->
ùx
 && 
¿
);

639 ià(!
¿
->
rh
) {

640 
	`ems_l_w¬n
("radius config file missing...");

641  
EMS_ERR
;

644 
evt
) {

645 
EMS_APP_CMD_RADIUS_AUTH
:

646  
	`¿dius_cmd_auth
(
¿
, 
roÙ
);

648 
EMS_APP_CMD_RADIUS_LOGOUT
:

649  
	`¿dius_cmd_logout
(
¿
, 
roÙ
);

651 
EMS_APP_EVT_FW_RELOAD
:

652  
	`¿dius_evt_fw_»lßd
(
¿
, 
roÙ
);

654 
EMS_APP_SERVER_RULES_UPDATE
:

655  
	`¿dius_evt_£rv”_ruËs_upd©e
(
¿
, 
roÙ
);

657 
EMS_APP_EVT_STATUS
:

658  
	`¿dius_evt_¡©us
(
¿
, 
roÙ
);

664  
EMS_OK
;

665 
	}
}

667 
ems_št
 
	$¿_´oûss_ruËs
(
­p_moduË
 *
mod
, 
jsÚ_objeù
 *
roÙ
)

669 #ifdeà
DEBUG


670 
ems_¿dius
 *
¿
 = (ems_¿diu *)
mod
->
ùx
;

672 
jsÚ_objeù
 *
obj
;

674 
	`ems_as£¹
(
mod
 && 
roÙ
 && 
¿
);

676 
	`ems_l_Œaû
("¿diu ­°šfo: %s", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
roÙ
));

678 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "rsrv");

680 ià(
obj
 && 
	`¿dius_g‘_ruËs
(
mod
, objè=ğ
EMS_OK
)

683 
	`ems_l_Œaû
("update„adiusƒnv here");

686  
EMS_OK
;

687 
	}
}

689 
ems_št
 
	$¿_run
(
­p_moduË
 *
mod
, 
ems_št
 
run
)

691 
ems_¿dius
 *
¿
 = (ems_¿diu *)
mod
->
ùx
;

692 
	`ems_as£¹
(
mod
 && 
¿
);

694 ià(
run
) {

695 ià(
	`ems_æag_like
(
mod
->
æg
, 
FLG_RUN
))

696  
EMS_OK
;

698 
	`ems_l_Œaû
("radius„unning here");

699 ià(
	`¿dius_¡¬t
(
¿
è=ğ
EMS_OK
)

700 
	`ems_æag_£t
(
mod
->
æg
, 
FLG_RUN
);

703 ià(
	`ems_æag_uÆike
(
mod
->
æg
, 
FLG_RUN
))

704  
EMS_OK
;

706 
	`ems_l_Œaû
("radius stopped");

707 
	`¿dius_¡İ
(
¿
);

708 
	`ems_æag_un£t
(
mod
->
æg
, 
FLG_RUN
);

711  
EMS_OK
;

712 
	}
}

715 
ems_cch¬
 *
	$¿dius_u£ºame
(
­p_moduË
 *
mod
, 
ems_cch¬
 *

)

717 
ems_deviû
 *
dev
;

719 ià(!(
mod
 && mod->
ùx
 && 

))

720  
NULL
;

722 
dev
 = 
	`¿dius_fšd_dev
((
ems_¿dius
 *)
mod
->
ùx
, 

);

724 ià(
dev
)

725  
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
);

727  
NULL
;

728 
	}
}

730 
ems_št
 
	$¿dius_Úlše_u£r_numb”
(
­p_moduË
 *
mod
)

732 
ems_št
 
n
;

733 
ems_¿dius
 *
¿
 = (ems_¿diu *)
mod
->
ùx
;

734 
ems_queue
 *
p
;

736 ià(!(
¿
 && 
mod
 && mod->
ùx
))

739 
n
 = 0;

740 
	`ems_queue_fÜ—ch
(&
¿
->
dev_’Œy
, 
p
) {

741 
n
++;

744  
n
;

745 
	}
}

747 
jsÚ_objeù
 *
	$¿dius_u£¾i¡
(
­p_moduË
 *
mod
)

749 
jsÚ_objeù
 *
roÙ
, *
¬y
, *
obj
;

750 
ems_¿dius
 *
¿
 = (ems_¿diu *)
mod
->
ùx
;

751 
ems_queue
 *
p
;

752 
ems_deviû
 *
dev
;

754 ià(!(
¿
 && 
mod
 && mod->
ùx
))

757 
roÙ
 = 
	`jsÚ_objeù_Ãw_objeù
();

758 
¬y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

760 
	`jsÚ_objeù_objeù_add
(
roÙ
, "u£r", 
¬y
);

762 
	`ems_queue_fÜ—ch
(&
¿
->
dev_’Œy
, 
p
) {

763 
dev
 = 
	`ems_cÚš”_of
(
p
, 
ems_deviû
, 
’Œy
);

765 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

766 
	`jsÚ_objeù_objeù_add
(
obj
, "nick", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
)));

767 
	`jsÚ_objeù_objeù_add
(
obj
, "pwd", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
·ss
)));

768 
	`jsÚ_objeù_objeù_add
(
obj
, "", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.

)));

769 
	`jsÚ_objeù_objeù_add
(
obj
, "mac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
mac
)));

770 
	`jsÚ_objeù_objeù_add
(
obj
, "¡©us", 
	`jsÚ_objeù_Ãw_št
(
dev
->
¡
));

772 
	`jsÚ_objeù_¬¿y_add
(
¬y
, 
obj
);

775  
roÙ
;

776 
	}
}

779 
­p_moduË
 
	g­p_¿dius
 = {

781 .
ty
 = 
ty_¿dius
,

782 .
	gdesc
 = 
ems_¡ršg
("radius"),

783 .
	gùx
 = 
NULL
,

784 .
	gæg
 = 0,

786 .
	gš™
 = 
¿_š™
,

787 .
	gunš™
 = 
¿_unš™
,

788 .
	grun
 = 
¿_run
,

789 .
	g´oûss
 = 
¿_´oûss
,

790 .
	g´oûss_ruË
 = 
¿_´oûss_ruËs
,

791 .
	gv”siÚ_m©ch
 = 
NULL
,

792 .
	gš¡®l
 = 
NULL


	@src/core/cmd_main.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

6 
ems_št
 
	$cmd_cÚÃù
(
ems_sock
 *
sock
)

8 
ems_št
 
fd
;

9 
sockËn_t
 
Ën
;

10 
sockaddr_š
 
addr
;

12 
	`mem£t
(&
addr
, 0, (addr));

14 ià(
	`ems_g‘ho¡byÇme
(
	`ems_sock_addr
(
sock
), &
addr
è!ğ
OK
) {

15 
	`ems_l_Œaû
("gethostbynameƒrr for %s : %s",

16 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

17  
EMS_ERR
;

20 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
);

21 ià(
fd
 <= 0)

22  
EMS_ERR
;

24 
	`ems_£tsock_rw_timeout
(
fd
, 5000);

26 
addr
.
sš_çmy
 = 
AF_INET
;

27 
addr
.
sš_pÜt
 = 
	`htÚs
(
	`ems_sock_pÜt
(
sock
));

29 
Ën
 = (
sockaddr_š
);

31 ià(
	`cÚÃù
(
fd
, (
sockaddr
 *)&
addr
, 
Ën
)) {

32 
	`şo£
(
fd
);

33 
	`ems_l_Œaû
("connecto: %s:%d failed: %s",

34 
	`ems_sock_addr
(
sock
), 
	`ems_sock_pÜt
(sock),

35 
	`ems_Ï¡”rmsg
());

36  
EMS_ERR
;

39 
	`ems_sock_£tfd
(
sock
, 
fd
);

41  
EMS_OK
;

42 
	}
}

44 
ems_št
 
	$cmd_£nd
(
ems_sock
 *
sock
, 
ems_bufãr
 *
buf
)

46 
ems_št
 
¹n
;

47 
ems_št
 
tÙ®
 = 
	`buf_Ën
(
buf
);

49 
¹n
 = 
	`ems_sock_£nd
(
sock
, 
buf
);

51 ià(
¹n
 !ğ
tÙ®
)

52  
EMS_ERR
;

54 
	`ems_bufãr_»äesh
(
buf
);

55  
EMS_OK
;

56 
	}
}

58 
ems_št
 
	$cmd_»cv_n
(
ems_sock
 *
sock
, 
ems_bufãr
 *
buf
, 
ems_ušt
 
Ën
)

60 
ems_ch¬
 *
p
;

61 
ems_št
 
»t
, 
fd
;

62 
ems_ušt
 
Ëá
 = 
Ën
;

64 ià(
	`ems_sock_fd
(
sock
) <= 0)

65  
EMS_ERR
;

67 
fd
 = 
	`ems_sock_fd
(
sock
);

68 
p
 = 
	`buf_wr
(
buf
);

69 
Ëá
 = 
Ën
;

71 
Ëá
 > 0) {

72 
»t
 = 
	`»cv
(
fd
, 
p
, 
Ëá
, 0);

74 ià(
»t
 <= 0) {

75 
	`ems_l_Œaû
("£ss: %d„ecv faed: %s", 
fd
, 
	`ems_Ï¡”rmsg
());

76 
	`ems_sock_şo£
(
sock
);

80 
Ëá
 -ğ
»t
;

81 
p
 +ğ
»t
;

84 
»t
 = 
	`abs
(
p
 - 
	`buf_wr
(
buf
));

85 
	`ems_bufãr_£ek_wr
(
buf
, 
»t
, 
EMS_BUFFER_SEEK_CUR
);

87  
»t
;

88 
	}
}

90 
ems_št
 
	$cmd_»cv
(
ems_sock
 *
sock
, 
ems_bufãr
 *
buf
)

92 
ems_št
 
Ëá
;

93 
ems_»¥Ú£
 
r¥
;

95 ià(
	`cmd_»cv_n
(
sock
, 
buf
, 
SIZE_RESPONSE
) != SIZE_RESPONSE)

97  
EMS_ERR
;

100 
	`ems_bufãr_´eãtch
(
buf
, (
ems_ch¬
 *)
r¥
.
v®
, 
SIZE_RESPONSE
);

102 
r¥
.
g
.
v®
 = 
	`Áohl
(rsp.tag.val);

103 
r¥
.
Ën
 = 
	`Áohl
(rsp.len);

105 
Ëá
 = 
r¥
.
Ën
 - 
SIZE_RESPONSE
;

107 
	`ems_l_Œaû
("g: %x,†’: %d,†eá: %d", 
r¥
.
g
.
v®
,„¥.
Ën
, 
Ëá
);

109 ià(
Ëá
 > 0) {

111 ià(
	`buf_Ëá
(
buf
è<ğ
Ëá
)

112 
	`ems_bufãr_šü—£
(
buf
, 
Ëá
);

114 ià(
	`cmd_»cv_n
(
sock
, 
buf
, 
Ëá
) !=†eft)

115  
EMS_ERR
;

118  
EMS_OK
;

119 
	}
}

121 
ems_št
 
	$cmd_·r£_r¥
(
ems_bufãr
 *
buf
)

123 
jsÚ_objeù
 *
roÙ
;

124 
ems_»¥Ú£
 *
r¥
;

125 
ems_št
 
¹n
;

127 
r¥
 = (
ems_»¥Ú£
 *)
	`buf_rd
(
buf
);

129 
r¥
->
g
.
v®
 = 
	`Áohl
(rsp->tag.val);

130 
r¥
->
Ën
 = 
	`Áohl
(rsp->len);

131 
r¥
->
¡
 = 
	`Áohl
(rsp->st);

133 
roÙ
 = 
NULL
;

134 ià(
r¥
->
Ën
 > 
SIZE_RESPONSE
) {

135 
	`ems_as£¹
(
	`buf_Ën
(
buf
è>ğ
r¥
->
Ën
);

136 
ems_št
 
Ën
;

137 
ems_ch¬
 *
p
, 
ch
;

139 
p
 = (
ems_ch¬
 *)(
	`buf_rd
(
buf
è+ 
SIZE_RESPONSE
);

140 
	`g‘wÜd
(
p
, 
Ën
);

142 
ch
 = 
p
[
Ën
];

143 
p
[
Ën
] = '\0';

144 
roÙ
 = 
	`ems_jsÚ_tok’”_·r£
(
p
);

145 
p
[
Ën
] = 
ch
;

148 
	`ems_l_Œaû
("\033[01;34m[sync]<rspag: 0x%x, st: %d ctx: %s> \033[00m",

149 
r¥
->
g
.
v®
,„¥->
¡
, 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"no ctx");

150 
¹n
 = 
r¥
->
¡
;

152 ià(
roÙ
) {

153 
ems_cch¬
 *
ùx
 = 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
roÙ
);

154 
FILE
 *
å
 = 
	`fİ’
("/tmp/ems_result.res", "w");

156 ià(
å
) {

157 ià(
ùx
)

158 
	`fwr™e
(
ùx
, 
	`¡¾’
(ùx), 1, 
å
);

160 
	`fşo£
(
å
);

163 
	`jsÚ_objeù_put
(
roÙ
);

166 
	`ems_bufãr_£ek_rd
(
buf
, 
r¥
->
Ën
, 
EMS_BUFFER_SEEK_CUR
);

167 
	`ems_bufãr_»äesh
(
buf
);

168  
¹n
;

170 
	}
}

172 
ems_št
 
	$exec_cmd
(
ems_št
 
cmd
, 
jsÚ_objeù
 *
roÙ
)

174 
ems_sock
 
sock
;

175 
ems_bufãr
 
buf
;

176 
ems_št
 
¹n
;

177 
ems_cch¬
 *
ùx
;

179 
	`ems_l_Œaû
("\033[00;31m[sync]<req:ag: 0x%x ctx: %s> \033[00m",

180 
cmd
, 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"no ctx");

182 
	`ems_sock_š™
(&
sock
);

183 
	`ems_bufãr_š™
(&
buf
, 
EMS_BUFFER_1K
);

186 
¹n
 = 
EMS_OK
;

187 
ùx
 = 
NULL
;

189 
	`ems_sock_£ddr
(&
sock
, 
EMS_ADDR
);

190 
	`ems_sock_£Üt
(&
sock
, 
EMS_PORT
);

192 ià(
	`cmd_cÚÃù
(&
sock
è!ğ
EMS_OK
) {

193 
¹n
 = 
MSG_ST_CONNECT_EMS_FAILED
;

197 ià(
roÙ
)

198 
ùx
 = 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
roÙ
);

200 
	`ems_·ck_»q
(
cmd
, 
ùx
, 
	`ems_¡¾’
(ùx), &
buf
);

202 
¹n
 = 
	`cmd_£nd
(&
sock
, &
buf
);

203 ià(
¹n
 !ğ
EMS_OK
) ;

205 
¹n
 = 
	`cmd_»cv
(&
sock
, &
buf
);

206 ià(
¹n
 !ğ
EMS_OK
) ;

208 
¹n
 = 
	`cmd_·r£_r¥
(&
buf
);

212 
	`ems_bufãr_unš™
(&
buf
);

213 
	`ems_sock_şo£
(&
sock
);

214 
	`ems_sock_ş—r
(&
sock
);

216  
¹n
;

217 
	}
}

219 
ems_št
 
	$cmd_·r£_cmd
(
ems_št
 
¬gc
, 
ems_ch¬
 **
¬gv
, 
jsÚ_objeù
 *
»q
)

221 
ems_št
 
i
;

222 
ems_ch¬
 
buf
[1024], *
key
, *
v®
;

224 
i
 = 1; i < 
¬gc
; i++) {

225 
	`¢´štf
(
buf
, (buf), "%s", 
¬gv
[
i
]);

227 
key
 = 
buf
;

228 
v®
 = 
	`¡rchr
(
buf
, '=');

230 ià(!
v®
)

232 *
v®
++ = '\0';

234 ià(
	`¡¾’
(
key
è<ğ0 || sŒËn(
v®
) <= 0)

237 
	`jsÚ_objeù_objeù_add
(
»q
, 
key
, 
	`jsÚ_objeù_Ãw_¡ršg
(
v®
));

240 
	`ems_l_Œaû
("·r£_cmd„esuÉ: %s", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
»q
));

242  
EMS_OK
;

243 
	}
}

	@src/core/ems_bridge.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

5 
	~"ems_bridge.h
"

6 
	~"ems_cmd.h
"

8 
	#BR_CONNECT_GW_TIMEOUT
 3000

	)

9 
	#BR_HEARTBEAT_TIME
 60000

	)

11 
ems_št
 
br_¡¬t
 (
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

12 
ems_št
 
br_¡İ³d
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

13 
ems_št
 
br_cÚÃù
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

14 
ems_št
 
br_nÜm®
 (
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

15 
ems_št
 
br_br
 (
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

16 
ems_št
 
br_”r
 (
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

18 
	$ems_št
 (*
	tbr_evt_func
)(
	tems_bridge
 *
	tbr
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_ušt
 
	tæg
);

19 
br_evt_func
 
br_evt_hªdËr
[] =

21 [
¡_¡¬t
] = 
br_¡¬t
,

22 [
¡_¡İ³d
] = 
br_¡İ³d
,

23 [
¡_cÚÃù
] = 
br_cÚÃù
,

24 [
¡_nÜm®
] = 
br_nÜm®
,

25 [
¡_hb
] = 
br_br
,

26 [
¡_”r
] = 
br_”r
,

27 [
¡_max
] = 
NULL


28 
	}
};

31 
ems_št
 
br_to_cÚÃù
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

32 
ems_št
 
br_to_nÜm®
 (
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

33 
ems_št
 
br_to_br
 (
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

34 
ems_št
 
br_to_”r
 (
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

36 
	$ems_št
 (*
	tbr_timeout_func
)(
	tems_bridge
 *
	tbr
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_timeout
 *
	tto
);

37 
br_timeout_func
 
br_timeout_hªdËr
[] =

39 [
¡_¡¬t
] = 
NULL
,

40 [
¡_¡İ³d
] = 
NULL
,

41 [
¡_cÚÃù
] = 
br_to_cÚÃù
,

42 [
¡_nÜm®
] = 
br_to_nÜm®
,

43 [
¡_hb
] = 
br_to_br
,

44 [
¡_”r
] = 
br_to_”r
,

45 [
¡_max
] = 
NULL


46 
	}
};

48 
ems_št
 
	$br_evt_run
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

50 
	`ems_as£¹
(
br_evt_hªdËr
[
br
->
¡
]);

51  
br_evt_hªdËr
[
br
->
¡
](br, 
£ss
, 
æg
);

52 
	}
}

54 
ems_void
 
	$br_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

56 
ems_bridge
 *
br
 = (ems_bridg*)
	`£ss_cb¬g
(
£ss
);

58 
	`ems_as£¹
(
br
->
¡
 > 
¡_mš
 && br->¡ < 
¡_max
);

60 
	`ems_l_Œaû
("[br]ƒvt:ƒ¼Ü? %s, flg: 0x%x", 
”r
?"yes":"no", 
æg
);

62 ià(
”r
) {

63 
	`ems_l_Œaû
("[br]ƒvtƒrr, sess: %d %s",

64 
	`ems_sock_fd
(&
£ss
->
sock
),

65 
	`ems_sock_addr
(&
£ss
->
sock
));

67 ià(
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE
))

68 
	`br_chªge_¡©us
(
br
, 
¡_hb
);

70 
	`ems_£nd_mes§ge
(
ty_bridge
, 
ty_dowÆšk
, 
EMS_APP_START
, 
NULL
);

71 
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

77 
	`br_evt_run
(
br
, 
£ss
, 
æg
);

78 
	}
}

80 
ems_void
 
	$br_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

82 
ems_bridge
 *
br
 = (ems_bridg*)
	`£ss_cb¬g
(
£ss
);

84 
	`ems_as£¹
(
br
->
¡
 > 
¡_mš
 && br->¡ < 
¡_max
);

86 
	`ems_as£¹
(
br_timeout_hªdËr
[
br
->
¡
]);

88 ià(
br_timeout_hªdËr
[
br
->
¡
])

89 
br_timeout_hªdËr
[
br
->
¡
](br, 
£ss
, 
to
);

90 
	}
}

92 
ems_št
 
	$br_cÚÃù_gw
(
ems_£ssiÚ
 *
£ss
)

94 
ems_št
 
fd
, 
»t
;

95 
sockËn_t
 
Ën
;

96 
sockaddr_š
 
addr
;

97 
ems_sock
 *
sock
 = &
£ss
->sock;

99 
	`ems_as£¹
(
£ss
);

101 
	`mem£t
(&
addr
, 0, (addr));

102 ià(
	`ems_g‘ho¡byÇme
(
	`ems_sock_addr
(
sock
), &
addr
è!ğ
OK
) {

103 
	`ems_l_Œaû
("gethostbyename failed %s : %s",

104 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

105  
EMS_ERR
;

108 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
);

109 ià(
fd
 <= 0)

110  
EMS_ERR
;

112 
	`ems_l_Œaû
("[br] sess(%d)ryo connecto: %s(%s): %d...",

113 
fd
,

114 
	`ems_sock_addr
(
sock
),

115 
	`š‘_Áß
(
addr
.
sš_addr
),

116 
	`ems_sock_pÜt
(
sock
));

118 
addr
.
sš_çmy
 = 
AF_INET
;

119 
addr
.
sš_pÜt
 = 
	`htÚs
(
	`ems_sock_pÜt
(
sock
));

121 
	`ems_£ŠÚblockšg
(
fd
, 
YES
);

122 
Ën
 = (
sockaddr_š
);

123 
»t
 = 
	`cÚÃù
(
fd
, (
sockaddr
 *)&
addr
, 
Ën
);

125 
»t
) {

127 
	`ems_æag_£t
(
£ss
->
æg
, 
EMS_FLG_ONLINE
);

131 
»t
 = 
	`ems_Ï¡”r
();

132 
	`ems_æag_un£t
(
£ss
->
æg
, 
EMS_FLG_ONLINE
);

134 ià(
»t
 !ğ
EINPROGRESS
) {

135 
	`şo£
(
fd
);

136 
	`ems_l_Œaû
("[br] connecto: %s:%d: failed: %s",

137 
	`ems_sock_addr
(
sock
),

138 
	`ems_sock_pÜt
(
sock
),

139 
	`ems_g‘”rmsg
(
»t
));

140  
EMS_ERR
;

147 
	`ems_sock_£tfd
(
sock
, 
fd
);

148  
EMS_OK
;

149 
	}
}

151 
ems_št
 
	$br_d‘eù_u¶šk
(
ems_bridge
 *
br
)

153 
ems_£ssiÚ
 *
£ss
 = 
NULL
;

154 
ems_cfg
 *
cfg
 = 
	`emscfg
();

156 ià(!
br
->
£ss
) {

157 
br
->
£ss
 = 
	`ems_£ssiÚ_Ãw
();

158 ià(!
br
->
£ss
)

159  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

162 
£ss
 = 
br
->sess;

163 
	`£ss_cb¬g_£t
(
£ss
, 
br
);

165 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`cfg_g‘
(
cfg
, 
CFG_wª_gw
));

166 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
EMS_PORT
);

168 ià(
	`br_cÚÃù_gw
(
£ss
è!ğ
EMS_OK
)

169  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

171 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
br_evt_cb
);

172 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
BR_CONNECT_GW_TIMEOUT
, 
br_timeout_cb
);

174 ià(
	`ems_æag_like
(
£ss
->
æg
, 
EMS_FLG_ONLINE
)) {

175 
	`cÜe_·ck_»q
(
£ss
, 
CMD_BRIDGE_REQ
);

176  
	`br_chªge_¡©us
(
br
, 
¡_nÜm®
);

179  
	`br_chªge_¡©us
(
br
, 
¡_cÚÃù
);

180 
	}
}

182 
ems_št
 
	$br_¡¬t
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

184 
ems_cfg
 *
cfg
 = 
	`emscfg
();

186 
	`ems_l_Œaû
("\033[00;32m\n"

191 
	`cÜe_gw_iâame
(),

192 
	`cfg_g‘
(
cfg
, 
CFG_Ïn_´Ùo
),

193 
	`cÜe_gw_addr
(),

194 
	`cfg_g‘
(
cfg
, 
CFG_Ïn_mask
),

195 
	`cfg_g‘
(
cfg
, 
CFG_Ïn_gw
),

197 
	`cfg_g‘
(
cfg
, 
CFG_wª_iâame
),

198 
	`cfg_g‘
(
cfg
, 
CFG_wª_´Ùo
),

199 
	`cfg_g‘
(
cfg
, 
CFG_wª_addr
),

200 
	`cfg_g‘
(
cfg
, 
CFG_wª_mask
),

201 
	`cfg_g‘
(
cfg
, 
CFG_wª_gw
),

203 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_iâame
),

204 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_ssid
),

205 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_’üy±
),

206 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_key
)

210 ià(!
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_READY
))

212 
	`ems_as£¹
(0 && "should‚ot be here");

213 
	`ems_l_Œaû
("network‚ot„eady");

214  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

217 
	`ems_as£¹
((
	`cfg_g‘
(
cfg
, 
CFG_wª_gw
è|| cfg_g‘(cfg, 
CFG_Ïn_gw
)) && "never show uphis");

223 ià(!
	`cfg_g‘
(
cfg
, 
CFG_wª_addr
è&& cfg_g‘(cfg, 
CFG_Ïn_gw
))

225 
	`ems_l_Œaû
("we‡re in brigde mode„ight‚ow");

227 
	`ems_æag_£t
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE
);

228 
	`ems_£nd_mes§ge
(
ty_bridge
, 
ty_Ãt
, 
EMS_APP_STOP
, 
NULL
);

234 ià(!
br
->
£ss
)

235 
br
->
£ss
 = 
	`ems_£ssiÚ_Ãw
();

237 ià(
br
->
£ss
) {

238 
	`£ss_cb¬g_£t
(
br
->
£ss
, br);

239  
	`br_chªge_¡©us
(
br
, 
¡_hb
);

242  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

245 ià(
	`cfg_g‘
(
cfg
, 
CFG_wª_addr
è&& cfg_g‘(cfg, 
CFG_wª_gw
)) {

247 
ems_cch¬
 *
´o
 = 
	`cfg_g‘
(
cfg
, 
CFG_wª_´Ùo
);

248 
ems_cch¬
 *
iâame
 = 
	`cfg_g‘
(
cfg
, 
CFG_wª_iâame
);

251 
	`ems_l_Œaû
("tryo connecto gw: %s from : %s",

252 
	`cfg_g‘
(
cfg
, 
CFG_wª_gw
), cfg_g‘(cfg, 
CFG_wª_addr
));

254 ià(
´o
 && !
	`¡rcmp
(pro, "pppoe")) {

255 
	`ems_l_Œaû
("the uplink is…ppoe server, we‡re fat‡p");

257 
	`ems_£nd_mes§ge
(
ty_bridge
, 
ty_dowÆšk
, 
EMS_APP_START
, 
NULL
);

258  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

261 ià(
iâame
 && !
	`¡ºcmp
(ifname, "apcli", 5)) {

262 
	`ems_l_Œaû
("we‡re in wireless„epeat mode,‚ot support wireless brigde");

263 
	`ems_£nd_mes§ge
(
ty_bridge
, 
ty_dowÆšk
, 
EMS_APP_START
, 
NULL
);

264  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

272 
ems_cch¬
 *
Ïn_addr
, *
wª_gw
;

273 
Ïn_addr
 = 
	`cfg_g‘
(
cfg
, 
CFG_Ïn_addr
);

274 
wª_gw
 = 
	`cfg_g‘
(
cfg
, 
CFG_wª_gw
);

276 ià(
Ïn_addr
 && 
wª_gw
 && !
	`¡rcmp
(lan_addr, wan_gw)) {

277 
ems_ch¬
 
buf
[512];

279 
	`¢´štf
(
buf
, (buf), "ip‡ddr del dev %s %s/%s",

280 
	`cfg_g‘
(
cfg
, 
CFG_Ïn_iâame
),

281 
Ïn_addr
,

282 
	`cfg_g‘
(
cfg
, 
CFG_Ïn_mask
));

283 
	`ems_sy¡emcmd
(
buf
);

285 
	`ems_æag_£t
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_LAN_BACK
);

289  
	`br_d‘eù_u¶šk
(
br
);

292 
	`ems_as£¹
(0 && "we did‚ot handle for‚ow");

293 
	`ems_£nd_mes§ge
(
ty_bridge
, 
ty_dowÆšk
, 
EMS_APP_START
, 
NULL
);

294  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

295 
	}
}

297 
ems_št
 
	$br_¡İ³d
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

299 
	`ems_l_Œaû
("[br] in status stoppped");

301 ià(
br
->
£ss
) {

302 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
br
->
£ss
);

303 
br
->
£ss
 = 
NULL
;

306 ià(
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_LAN_BACK
)) {

307 
ems_ch¬
 
buf
[512];

308 
ems_cfg
 *
cfg
 = 
	`emscfg
();

310 
	`ems_æag_un£t
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_LAN_BACK
);

311 
	`¢´štf
(
buf
, (buf), "ip‡ddr‡dd dev %s %s/%s",

312 
	`cfg_g‘
(
cfg
, 
CFG_Ïn_iâame
),

313 
	`cfg_g‘
(
cfg
, 
CFG_Ïn_addr
),

314 
	`cfg_g‘
(
cfg
, 
CFG_Ïn_mask
));

315 
	`ems_sy¡emcmd
(
buf
);

318  
EMS_OK
;

319 
	}
}

321 
ems_št
 
	$br_cÚÃù
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

323 
ems_št
 
”r
;

324 
sockËn_t
 
Ën
;

326 
Ën
 = (
”r
);

327 
”r
 = 0;

328 
	`g‘sockİt
(
	`ems_sock_fd
(&
£ss
->
sock
), 
SOL_SOCKET
, 
SO_ERROR
, (
ems_ch¬
 *)&
”r
, &
Ën
);

330 ià(
”r
 ) {

331 
”ºo
 = 
”r
;

332 
	`ems_l_Œaû
("[br]sess(%d) connecto %s:%d failed, %s",

333 
	`ems_sock_fd
(&
£ss
->
sock
),

334 
	`ems_sock_addr
(&
£ss
->
sock
),

335 
	`ems_sock_pÜt
(&
£ss
->
sock
),

336 
	`ems_g‘”rmsg
(
”r
));

337  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

340 
	`ems_l_Œaû
("[br]sess(%d)ƒstablished with %s:%d",

341 
	`ems_sock_fd
(&
£ss
->
sock
),

342 
	`ems_sock_addr
(&
£ss
->
sock
),

343 
	`ems_sock_pÜt
(&
£ss
->
sock
));

345 
	`ems_æag_£t
(
£ss
->
æg
, 
EMS_FLG_ONLINE
);

347 ià(
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE
))

348 
	`cÜe_·ck_»q
(
£ss
, 
CMD_BRIDGE_HB
);

350 
	`cÜe_·ck_»q
(
£ss
, 
CMD_BRIDGE_REQ
);

352 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
 | 
EMS_EVT_WRITE
, 
br_evt_cb
);

353 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
BR_CONNECT_GW_TIMEOUT
, 
br_timeout_cb
);

355  
	`br_chªge_¡©us
(
br
, 
¡_nÜm®
);

356 
	}
}

358 
ems_št
 
	$br_£nd_msg
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

360 
ems_št
 
»t
;

362 
	`ems_as£¹
(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
));

364 
»t
 = 
	`£ss_£nd
(
£ss
, &£ss->
buf
);

365 ià(
»t
 <= 0) {

366 
»t
) {

368 -
EAGAIN
:

372  
»t
;

376 ià(
	`buf_Ën
(&
£ss
->
buf
) <= 0) {

377 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
br_evt_cb
);

378 
	`ems_bufãr_»äesh
(&
£ss
->
buf
);

381  
EMS_OK
;

382 
	}
}

384 
	$ems_št
 (*
	tbr_r¥_cb
)(
	tems_bridge
 *, 
	tems_£ssiÚ
 *, 
	tems_»¥Ú£
 *, 
	tjsÚ_objeù
 *);

385 
ems_št


386 
	$br_´oûss_r¥
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_»¥Ú£
 *
r¥
, 
br_r¥_cb
 
h
)

388 
jsÚ_objeù
 *
roÙ
;

389 
ems_št
 
¹n
 = 
EMS_OK
;

391 
	`ems_as£¹
(
br
 && 
£ss
 && 
r¥
);

393 
roÙ
 = 
NULL
;

394 ià(
r¥
->
Ën
 > 
SIZE_RESPONSE
) {

395 
ems_št
 
Ën
;

396 
ems_ch¬
 *
p
, 
ch
;

398 
	`ems_as£¹
(
	`buf_Ën
(&
£ss
->
buf_š
è>ğ
r¥
->
Ën
);

400 
p
 = (
ems_ch¬
 *)(
	`buf_rd
(&
£ss
->
buf_š
è+ 
SIZE_RESPONSE
);

401 
	`g‘wÜd
(
p
, 
Ën
);

403 
ch
 = 
p
[
Ën
];

404 
p
[
Ën
] = '\0';

405 
roÙ
 = 
	`ems_jsÚ_tok’”_·r£
(
p
);

406 
p
[
Ën
] = 
ch
;

408 #ifdeà
DEUBG


410 
ems_cch¬
 *
ùx
 = 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"no ctx";

412 
	`ems_l_Œaû
("\033[01;34m[br]<rspag: 0x%x, st: %d ctx: %s> \033[00m",

413 
r¥
->
g
.
v®
,„¥->
¡
, 
	`¡¾’
(
ùx
)> 0x200?"**too†ong**":ctx);

417 ià(
h
)

418 
¹n
 = 
	`h
(
br
, 
£ss
, 
r¥
, 
roÙ
);

420 
¹n
 = 
EMS_ERR
;

422 ià(
roÙ
)

423 
	`jsÚ_objeù_put
(
roÙ
);

425 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf_š
, 
r¥
->
Ën
, 
EMS_BUFFER_SEEK_CUR
);

426 
	`ems_bufãr_»äesh
(&
£ss
->
buf_š
);

427  
¹n
;

428 
	}
}

431 
ems_št
 
	$br_´•roûss
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
br_r¥_cb
 
h
)

433 
ems_»¥Ú£
 
r¥
;

435 
	`ems_as£¹
(
br
 && 
£ss
 && 
h
);

437 ià(
	`buf_Ën
(&
£ss
->
buf_š
è< 
SIZE_RESPONSE
)

438  
EMS_CONTINUE
;

440 
	`ems_bufãr_´eãtch
(&
£ss
->
buf_š
, (
ems_ch¬
 *)
r¥
.
v®
, 
SIZE_RESPONSE
);

442 
r¥
.
g
.
v®
 = 
	`Áohl
(rsp.tag.val);

443 
r¥
.
Ën
 = 
	`Áohl
(rsp.len);

444 
r¥
.
¡
 = 
	`Áohl
(rsp.st);

446 ià(
r¥
.
Ën
 >ğ
	`buf_size
(&
£ss
->
buf_š
)) {

447 ià(
	`ems_bufãr_šü—£
(&
£ss
->
buf_š
, 
r¥
.
Ën
è!ğ
EMS_OK
)

448  
EMS_BUFFER_INSUFFICIENT
;

451 ià(
	`buf_Ën
(&
£ss
->
buf_š
è< 
r¥
.
Ën
)

452  
EMS_CONTINUE
;

454  
	`br_´oûss_r¥
(
br
, 
£ss
, &
r¥
, 
h
);

455 
	}
}

458 
ems_št


459 
	$br_»cv_hªdË
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
br_r¥_cb
 
h
)

461 
ems_št
 
»t
, 
agaš
;

463 
agaš
 = 
EMS_YES
;

464 
»cv_agaš
:

465 
»t
 = 
	`£ss_»cv
(
£ss
, &£ss->
buf_š
);

466 ià(
»t
 <= 0) {

467 
»t
) {

468 -
EAGAIN
:

469 
agaš
 = 
EMS_NO
;

472 ià(
	`buf_Ën
(&
£ss
->
buf_š
) > 0)

473 
	`br_´•roûss
(
br
, 
£ss
, 
h
);

474  
EMS_ERR
;

479 
»t
 = 
	`br_´•roûss
(
br
, 
£ss
, 
h
);

481 
»t
) {

482 
EMS_BUFFER_INSUFFICIENT
:

483 
EMS_ERR
:

484  
EMS_ERR
;

486 
EMS_OK
:

487 
EMS_CONTINUE
:

491 } 
»t
 !ğ
EMS_CONTINUE
);

493 ià(
agaš
)

494 
»cv_agaš
;

496  
EMS_OK
;

497 
	}
}

528 
	s_wifi_cmd_s
 {

529 
ems_ch¬
 *
	mnick
;

530 
ems_ch¬
 *
	mAuthMode
;

531 
ems_ch¬
 *
	mEnüypTy³
;

532 
ems_ch¬
 *
	mIEEE8021X
;

533 
ems_ch¬
 *
	m´e_SSID
;

534 
ems_ch¬
 *
	mkey
;

535 
ems_ch¬
 *
	mkeyid
;

536 } 
	tbr_wifi_cmd
;

538 
br_wifi_cmd
 
	g_gcmds
[] =

542 {"nÚe", "OPEN", "NONE", 
NULL
, NULL, NULL, NULL},

543 {"İ’", "OPEN", "NONE", 
NULL
, NULL, NULL, NULL},

546 {"w•-İ’", "WEPAUTO", "WEP", "IEEE8021X=0", 
NULL
, "Key1", "DefaultKeyID=1"},

547 {"w•-sh¬ed", "WEPAUTO", "WEP", "IEEE8021X=0", 
NULL
, "Key1", "DefaultKeyID=1"},

548 {"w•", "WEPAUTO", "WEP", "IEEE8021X=0", 
NULL
, "Key1", "DefaultKeyID=1"},

549 {"WEP", "WEPAUTO", "WEP", "IEEE8021X=0", 
NULL
, "Key1", "DefaultKeyID=1"},

566 
br_wifi_cmd
 *
	$wifi_mod_fšd
(
ems_cch¬
 *
’c
)

568 
br_wifi_cmd
 *
cmd
;

569 
ems_št
 
tÙ®
, 
i
;

572 
tÙ®
 = (
_gcmds
è/ (
br_wifi_cmd
);

574 
i
 = 0; i < 
tÙ®
; i++) {

575 
cmd
 = &
_gcmds
[
i
];

576 ià(!
	`¡rcmp
(
’c
, 
cmd
->
nick
))

577  
cmd
;

580  
NULL
;

581 
	}
}

584 
ems_št
 
	$br_£t_wifi_šfo
(
ems_cch¬
 *
šf
, 
br_wifi_cmd
 *
wifi
,ƒms_cch¬ *
ssid
, 
ems_¡r
 *
key
)

586 
ems_bufãr
 *
cmd
 = 
	`cÜe_bufãr
();

588 
	`ems_as£¹
(
šf
 && 
wifi
 && 
ssid
);

589 ià(
šf
 && 
wifi
 && 
ssid
) {

590 
ems_ch¬
 *
buf
 = 
	`buf_wr
(
cmd
);

591 
ems_št
 
Ën
 = 
	`buf_Ëá
(
cmd
);

593 
	`¢´štf
(
buf
, 
Ën
, "iw´iv % £ˆAuthMode=%s", 
šf
, 
wifi
->
AuthMode
);

594 
	`ems_sy¡emcmd
(
buf
);

596 
	`¢´štf
(
buf
, 
Ën
, "iw´iv % £ˆEnüypTy³=%s", 
šf
, 
wifi
->
EnüypTy³
);

597 
	`ems_sy¡emcmd
(
buf
);

599 ià(
wifi
->
IEEE8021X
) {

600 
	`¢´štf
(
buf
, 
Ën
, "iw´iv % £ˆ%s", 
šf
, 
wifi
->
IEEE8021X
);

601 
	`ems_sy¡emcmd
(
buf
);

604 
	`ems_as£¹
(
ssid
 !ğ
NULL
);

605 ià(
wifi
->
´e_SSID
) {

606 
	`¢´štf
(
buf
, 
Ën
, "iw´iv % £ˆ%s=%s", 
šf
, 
wifi
->
´e_SSID
, 
ssid
);

607 
	`ems_sy¡emcmd
(
buf
);

610 ià(
wifi
->
key
) {

611 
	`¢´štf
(
buf
, 
Ën
, "iw´iv % £ˆ%s=%s", 
šf
, 
wifi
->
key
, 
	`¡r_‹xt
(key));

612 
	`ems_sy¡emcmd
(
buf
);

615 ià(
wifi
->
keyid
) {

616 
	`¢´štf
(
buf
, 
Ën
, "iw´iv % £ˆ%s", 
šf
, 
wifi
->
keyid
);

617 
	`ems_sy¡emcmd
(
buf
);

620 
	`¢´štf
(
buf
, 
Ën
, "iw´iv % £ˆWscCÚfMode=0", 
šf
);

621 
	`ems_sy¡emcmd
(
buf
);

623 
	`¢´štf
(
buf
, 
Ën
, "iw´iv % £ˆSSID=%s", 
šf
, 
ssid
);

624 
	`ems_sy¡emcmd
(
buf
);

628  
EMS_OK
;

629 
	}
}

631 
ems_št


632 
	$br_chrŞe_to_­
(
ems_bridge
 *
br
, 
ems_¡r
 *
ssid
,ƒms_¡¸*
’üy±
,ƒms_¡¸*
key
)

634 
ems_št
 
¹n
;

635 
ems_cfg
 *
cfg
 = 
	`emscfg
();

636 
ems_bufãr
 *
cmd
 = 
	`cÜe_bufãr
();

637 
br_wifi_cmd
 *
wifi
 = 
NULL
;

640 
¹n
 = 
EMS_ERR
;

642 
wifi
 = 
	`wifi_mod_fšd
(
	`¡r_‹xt
(
’üy±
));

644 ià(!
wifi
) {

645 
	`ems_l_Œaû
("did‚Ù fšd‡ny wif˜mod suµly fÜ : %s", 
	`¡r_‹xt
(
’üy±
));

649 ià(
wifi
->
key
 && 
	`¡r_Ën
(key) <= 0) {

650 
	`ems_l_Œaû
("key missing");

654 
	`br_£t_wifi_šfo
(
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_iâame
), 
wifi
, 
	`¡r_‹xt
(
ssid
), 
key
);

657 
ems_cch¬
 *
Ïn_šf
, *
wª_šf
;

658 
ems_ch¬
 *
buf
 = 
	`buf_wr
(
cmd
);

659 
ems_št
 
Ën
 = 
	`buf_Ëá
(
cmd
);

661 
	`ems_sy¡emcmd
("/etc/init.d/dnsmasq stop");

662 
	`ems_sy¡emcmd
("/etc/init.d/uhttpd stop");

664 
Ïn_šf
 = 
	`cÜe_gw_iâame
();

665 
wª_šf
 = 
	`cfg_g‘
(
cfg
, 
CFG_wª_iâame
);

667 
	`ems_as£¹
(
Ïn_šf
 && 
wª_šf
);

669 
	`¢´štf
(
buf
, 
Ën
, "brùÈaddià% %s", 
Ïn_šf
, 
wª_šf
);

670 
	`ems_sy¡emcmd
(
buf
);

672 
	`¢´štf
(
buf
, 
Ën
,

674 
wª_šf
, wan_inf);

675 
	`ems_sy¡emcmd
(
buf
);

677 
	`¢´štf
(
buf
, 
Ën
, "„ou‹ d– deçuÉ vŸ % dev %s", 
	`cfg_g‘
(
cfg
, 
CFG_wª_gw
), 
wª_šf
);

678 
	`ems_sy¡emcmd
(
buf
);

680 
	`¢´štf
(
buf
, 
Ën
,

682 
Ïn_šf
,†an_inf);

683 
	`ems_sy¡emcmd
(
buf
);

685 
	`¢´štf
(
buf
, 
Ën
, "/sbš/udhıø-˜% -xho¡Çme:%s", 
Ïn_šf
, 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_ssid
));

686 
	`ems_sy¡emcmd
(
buf
);

689 
¹n
 = 
EMS_OK
;

692  
¹n
;

693 
	}
}

695 
ems_št


696 
	$br_r¥_»q
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
roÙ
)

698 
ems_št
 
¹n
;

699 
ems_¡r
 
ssid
;

700 
ems_¡r
 
’üy±
;

701 
ems_¡r
 
key
;

703 
	`ems_l_Œaû
("u¶šk' »tuº: %s", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
roÙ
));

705 
	`¡r_š™
(&
ssid
);

706 
	`¡r_š™
(&
’üy±
);

707 
	`¡r_š™
(&
key
);

710 
¹n
 = 
EMS_ERR
;

711 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "ssid", &
ssid
, 
NULL
);

712 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "’üy±iÚ", &
’üy±
, 
NULL
);

713 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "key", &
key
, 
NULL
);

715 ià(
	`¡r_Ën
(&
ssid
è<ğ0 || sŒ_Ën(&
’üy±
) <= 0)

717 
	`ems_l_Œaû
("invalid‡rg");

721 ià(
	`br_chrŞe_to_­
(
br
, &
ssid
, &
’üy±
, &
key
è=ğ
EMS_OK
) {

722 
	`ems_l_Œaû
("we‡re in brigde mode‚ow");

723 
	`ems_æag_£t
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE
);

724 
	`ems_£nd_mes§ge
(
ty_bridge
, 
ty_Ãt
, 
EMS_APP_STOP
, 
NULL
);

728 
¹n
 = 
EMS_OK
;

733 
	`¡r_unš™
(&
ssid
);

734 
	`¡r_unš™
(&
’üy±
);

735 
	`¡r_unš™
(&
key
);

737 ià(
¹n
 =ğ
EMS_OK
)

738  
	`br_chªge_¡©us
(
br
, 
¡_hb
);

740 
	`ems_£nd_mes§ge
(
ty_bridge
, 
ty_dowÆšk
, 
EMS_APP_START
, 
NULL
);

742  
¹n
;

743 
	}
}

745 
ems_št
 
	$br_r¥_hb
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
roÙ
)

747  
	`br_chªge_¡©us
(
br
, 
¡_hb
);

748 
	}
}

750 
ems_št


751 
	$br_msg_nÜm®_r¥
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_»¥Ú£
 *
r¥
, 
jsÚ_objeù
 *
roÙ
)

753 
	`£ss_timeout_ÿnûl
(
£ss
);

755 ià(
r¥
->
¡
 !ğ
EMS_OK
)

756  
EMS_ERR
;

758 
r¥
->
g
.
msg
 & 0x0000ffff) {

760 
CMD_BRIDGE_REQ
:

761  
	`br_r¥_»q
(
br
, 
£ss
, 
roÙ
);

763 
CMD_BRIDGE_HB
:

764  
	`br_r¥_hb
(
br
, 
£ss
, 
roÙ
);

770  
EMS_ERR
;

771 
	}
}

773 
ems_št
 
	$br_nÜm®
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

775 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

776 ià(
	`br_»cv_hªdË
(
br
, 
£ss
, 
br_msg_nÜm®_r¥
è!ğ
EMS_OK
)

777  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

780 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

781 ià(
	`br_£nd_msg
(
br
, 
£ss
, 
æg
è!ğ
EMS_OK
)

782  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

785  
EMS_OK
;

786 
	}
}

788 
ems_št
 
	$br_br
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

790 
£ss
 = 
br
->sess;

791 ià(!
£ss
)

792  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

794 
	`ems_l_Œaû
("[br]session(%d) [%s: %d] down",

795 
	`ems_sock_fd
(&
£ss
->
sock
),

796 
	`ems_sock_addr
(&
£ss
->
sock
),

797 
	`ems_sock_pÜt
(&
£ss
->
sock
));

799 
	`£ss_ev’t_ÿnûl
(
£ss
);

800 
	`ems_sock_şo£
(&
£ss
->
sock
);

801 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
BR_HEARTBEAT_TIME
, 
br_timeout_cb
);

803  
EMS_OK
;

804 
	}
}

806 
ems_št
 
	$br_”r
 (
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

808  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

809 
	}
}

811 
ems_št
 
	$br_to_cÚÃù
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

813 
	`ems_l_Œaû
("timeouto connect uplink");

814 
	`ems_£nd_mes§ge
(
ty_bridge
, 
ty_dowÆšk
, 
EMS_APP_START
, 
NULL
);

815  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

816 
	}
}

818 
ems_št
 
	$br_to_nÜm®
 (
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

820 ià(
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE
))

821  
	`br_chªge_¡©us
(
br
, 
¡_hb
);

823  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

824 
	}
}

826 
ems_št
 
	$br_to_br
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

828 
ems_cch¬
 *
gw
 = 
NULL
;

829 
	`ems_l_Œaû
("[br]imeo say hello");

831 
gw
 = 
	`ems_sock_addr
(&
£ss
->
sock
);

832 ià(!
gw
) {

833 
gw
 = 
	`cfg_g‘
(
	`emscfg
(), 
CFG_Ïn_gw
);

834 ià(
gw
) {

835 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
gw
);

836 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
EMS_PORT
);

838  
	`br_chªge_¡©us
(
br
, 
¡_hb
);

841 ià(
	`br_cÚÃù_gw
(
£ss
è!ğ
EMS_OK
)

842  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

844 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
br_evt_cb
);

845 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
BR_CONNECT_GW_TIMEOUT
, 
br_timeout_cb
);

847 ià(
	`ems_æag_like
(
£ss
->
æg
, 
EMS_FLG_ONLINE
)) {

848 
	`cÜe_·ck_»q
(
£ss
, 
CMD_BRIDGE_HB
);

849  
	`br_chªge_¡©us
(
br
, 
¡_nÜm®
);

852  
	`br_chªge_¡©us
(
br
, 
¡_cÚÃù
);

853 
	}
}

855 
ems_št
 
	$br_to_”r
(
ems_bridge
 *
br
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

857  
	`br_chªge_¡©us
(
br
, 
¡_¡İ³d
);

858 
	}
}

860 
ems_void
 
	$ems_£twifi_nİasswÜd
()

862 
ems_cfg
 *
cfg
 = 
	`emscfg
();

863 
ems_cch¬
 *
v®
 = 
	`cfg_g‘
(
	`emscfg
(), 
CFG_wœ–ess_’üy±
);

865 ià(
v®
 && !
	`¡rcmp
(val, "none"))

868 
	`br_£t_wifi_šfo
(
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_iâame
),

869 
	`wifi_mod_fšd
("none"),

870 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_ssid
),

871 
NULL
);

872 
	}
}

874 
ems_št
 
	$br_chªge_¡©us
(
ems_bridge
 *
br
, 
ems_¡©us
 
¡
)

876 ià(
br
->
¡
 == st)

877  
EMS_OK
;

879 
	`ems_l_Œaû
("[br] chnage status: %s +++> %s",

880 
	`ems_¡©us_¡r
(
br
->
¡
),ƒms_status_str(st));

882 
br
->
¡
 = st;

884 
¡
) {

886 
¡_¡¬t
:

887 
¡_¡İ³d
:

888 
¡_hb
:

889  
	`br_evt_run
(
br
, 
NULL
, 0);

896  
EMS_OK
;

897 
	}
}

	@src/core/ems_bridge.h

2 #iâdeà 
EMS_HEADERE_CLIENT_FOR_BRIGDE___


3 
	#EMS_HEADERE_CLIENT_FOR_BRIGDE___


	)

5 
_ems_bridge_s
 
	tems_bridge
;

7 
	s_ems_bridge_s


9 
ems_¡©us
 
	m¡
;

11 
ems_£ssiÚ
 *
	m£ss
;

14 
ems_št
 
br_chªge_¡©us
(
ems_bridge
 *
br
, 
ems_¡©us
 
¡
);

	@src/core/ems_client.c

2 #ifdeà
USE_EMS_SERVER


4 
	~"ems_cÜe.h
"

5 
	~"ems_ş›Á.h
"

6 
	~"­p.h
"

7 
	~"ems_fw.h
"

9 
	s_ems_ş›Á_s


11 
ems_cÜe
 *
	mcÜe
;

12 
ems_£ssiÚ
 *
	m£ss
;

13 
ems_¡©us
 
	m¡
;

14 
ems_void
 *
	mùx
;

16 
ems_ušt
 
	mu±
;

17 
ems_št
 
	m»Œy
;

18 
ems_ušt
 
	mæg
;

19 
ems_¡r
 
	mtick‘
;

22 
	#EMS_TIMEOUT_CONNECT
 10000

	)

23 
	#EMS_TIMEOUT_ERROR_WAIT
 10000

	)

24 
	#EMS_TIMEOUT_REGISTER
 10000

	)

25 
	#EMS_TIMEOUT_DEFAULT
 10000

	)

26 
	#EMS_TIMEOUT_FOR_HB
 10000

	)

27 
	#EMS_TIMEOUT_HB
 5000

	)

30 
ems_void
 
ş_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

31 
ems_void
 
ş_evt_cb
 (
ems_£ssiÚ
 *
£ss
, 
ems_št
 
¡
,ƒms_šˆ
æg
);

33 
ems_št
 
ş_š™
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

34 
ems_št
 
ş_cÚÃù
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

35 
ems_št
 
ş_¡İ³d
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

36 
ems_št
 
ş_nÜm®
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

37 
ems_št
 
ş_hb
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

38 
ems_št
 
ş_»g
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

39 
ems_št
 
ş_­¶i¡
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

40 
ems_št
 
ş_dowÆßd
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

41 
ems_št
 
ş_š¡®l
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

42 
ems_št
 
ş_”r
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

44 
	$ems_št
 (*
	tş_evt_func
)(
	tems_ş›Á
 *
	tş
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_ušt
 
	tæg
);

45 
ş_evt_func
 
ù¾_hªdËr
[] =

47 [
¡_š™
] = 
ş_š™
,

48 [
¡_¡İ³d
] = 
ş_¡İ³d
,

49 [
¡_nÜm®
] = 
ş_nÜm®
,

50 [
¡_hb
] = 
ş_hb
,

51 [
¡_»g
] = 
ş_»g
,

52 [
¡_­¶i¡
] = 
ş_­¶i¡
,

53 [
¡_dowÆßd
]ğ
ş_dowÆßd
,

54 [
¡_š¡®l
] = 
ş_š¡®l
,

55 [
¡_”r
] = 
ş_”r
,

56 [
¡_cÚÃù
] = 
ş_cÚÃù
,

57 [
¡_max
] = 
NULL


58 
	}
};

60 
	$ems_št
 (*
	tş_timeout_func
)(
	tems_ş›Á
 *
	tæ
, 
	tems_£ssiÚ
 *
	t£ss
);

62 
ems_št
 
	`ş_to_nÜm®
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

63 
ems_št
 
	`ş_to_hb
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

64 
ems_št
 
	`ş_to_»g
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

65 
ems_št
 
	`ş_to_­¶i¡
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

66 
ems_št
 
	`ş_to_dowÆßd
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

67 
ems_št
 
	`ş_to_š¡®l
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

68 
ems_št
 
	`ş_to_”r
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

69 
ems_št
 
	`ş_to_cÚÃù
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

71 
ş_timeout_func
 
timeout_hªdËr
[] =

73 [
¡_š™
] = 
NULL
,

74 [
¡_¡İ³d
] = 
NULL
,

75 [
¡_nÜm®
] = 
ş_to_nÜm®
,

76 [
¡_hb
] = 
ş_to_hb
,

77 [
¡_»g
] = 
ş_to_»g
,

78 [
¡_­¶i¡
] = 
ş_to_­¶i¡
,

79 [
¡_dowÆßd
]ğ
ş_to_dowÆßd
,

80 [
¡_š¡®l
] = 
ş_to_š¡®l
,

81 [
¡_”r
] = 
ş_to_”r
,

82 [
¡_cÚÃù
] = 
ş_to_cÚÃù
,

83 [
¡_max
] = 
NULL


84 
	}
};

86 
	$ems_št
 (*
	tş_evt_r¥_cb
)(
	tems_ş›Á
 *, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_»¥Ú£
 *
	tr¥
, 
	tjsÚ_objeù
 *
	troÙ
);

88 
ems_void
 
	$ş_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

90 
ems_ş›Á
 *
ş
 = (ems_ş›Á *)
	`£ss_cb¬g
(
£ss
);

92 
	`ems_as£¹
(
ş
->
¡
 > 
¡_mš
 && cl->¡ < 
¡_max
);

94 
	`ems_as£¹
(
timeout_hªdËr
[
ş
->
¡
]);

96 ià(
timeout_hªdËr
[
ş
->
¡
])

97 
timeout_hªdËr
[
ş
->
¡
](ş, 
£ss
);

98 
	}
}

100 
ems_št
 
	$ş_evt_run
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_št
 
æg
)

102 
	`ems_as£¹
(
ş
 && cl->
¡
 > 
¡_mš
 && cl->¡ < 
¡_max
);

104 
	`ems_as£¹
(
ù¾_hªdËr
[
ş
->
¡
]);

106  
ù¾_hªdËr
[
ş
->
¡
](ş, 
£ss
, 
æg
);

107 
	}
}

109 
ems_void
 
	$ş_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

111 
ems_ş›Á
 *
ş
 = (ems_ş›Á *)
	`£ss_cb¬g
(
£ss
);

113 
	`ems_as£¹
(
ş
->
¡
 > 
¡_mš
 && cl->¡ < 
¡_max
);

115 ià(
”r
) {

116 
	`ems_l_Œaû
("[clnt]ƒvtƒrr, sess: %d %s:%d",

117 
	`ems_sock_fd
(&
£ss
->
sock
),

118 
	`ems_sock_addr
(&
£ss
->
sock
),

119 
	`ems_sock_pÜt
(&
£ss
->
sock
)

121 
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

125 
	`ş_evt_run
(
ş
, 
£ss
, 
æg
);

126 
	}
}

128 
ems_št
 
	$ş_do_cÚÃù
(
ems_£ssiÚ
 *
£ss
)

130 
ems_št
 
fd
, 
»t
;

131 
sockËn_t
 
Ën
;

132 
sockaddr_š
 
addr
;

133 
ems_sock
 *
sock
 = &
£ss
->sock;

135 
	`ems_as£¹
(
£ss
);

137 
	`mem£t
(&
addr
, 0, (addr));

138 ià(
	`ems_g‘ho¡byÇme
(
	`ems_sock_addr
(
sock
), &
addr
è!ğ
OK
) {

139 
	`ems_l_Œaû
("gethostbyename failed %s : %s",

140 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

141  
EMS_ERR
;

144 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
);

145 ià(
fd
 <= 0)

146  
EMS_ERR
;

148 
	`ems_l_Œaû
("[clnt] sess(%d)ryo connecto: %s(%s): %d...",

149 
fd
,

150 
	`ems_sock_addr
(
sock
),

151 
	`š‘_Áß
(
addr
.
sš_addr
),

152 
	`ems_sock_pÜt
(
sock
));

154 
addr
.
sš_çmy
 = 
AF_INET
;

155 
addr
.
sš_pÜt
 = 
	`htÚs
(
	`ems_sock_pÜt
(
sock
));

157 
	`ems_£ŠÚblockšg
(
fd
, 
YES
);

158 
Ën
 = (
sockaddr_š
);

159 
»t
 = 
	`cÚÃù
(
fd
, (
sockaddr
 *)&
addr
, 
Ën
);

161 
»t
) {

163 
	`ems_æag_£t
(
£ss
->
æg
, 
EMS_FLG_ONLINE
);

167 
»t
 = 
	`ems_Ï¡”r
();

168 
	`ems_æag_un£t
(
£ss
->
æg
, 
EMS_FLG_ONLINE
);

170 ià(
»t
 !ğ
EINPROGRESS
) {

171 
	`şo£
(
fd
);

172 
	`ems_l_Œaû
("[clnt] connecto: %s:%d: failed: %s",

173 
	`ems_sock_addr
(
sock
),

174 
	`ems_sock_pÜt
(
sock
),

175 
	`ems_g‘”rmsg
(
»t
));

176  
EMS_ERR
;

183 
	`ems_sock_£tfd
(
sock
, 
fd
);

184  
EMS_OK
;

185 
	}
}

187 
ems_št
 
	$ş_š™
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

189 ià(!
ş
->
£ss
) {

190 
ş
->
£ss
 = 
	`ems_£ssiÚ_Ãw
();

191 ià(!
ş
->
£ss
)

192  
EMS_ERR
;

194 
	`£ss_cb¬g_£t
(
ş
->
£ss
, cl);

197 
£ss
 = 
ş
->sess;

198 
	`ems_bufãr_ş—r
(&
£ss
->
buf
);

199 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

201 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_s_addr
));

202 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_s_pÜt
)));

204 ià(
	`ş_do_cÚÃù
(
£ss
è!ğ
EMS_OK
)

205  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

207 ià(
	`ems_æag_like
(
£ss
->
æg
, 
EMS_FLG_ONLINE
))

208  
	`ş_chªge_¡©us
(
ş
, 
¡_»g
);

210 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
|
EMS_EVT_WRITE
, 
ş_evt_cb
);

211 
	`£ss_timeout_£t
(
£ss
, 
EMS_TIMEOUT_CONNECT
, 
ş_timeout_cb
);

213  
	`ş_chªge_¡©us
(
ş
, 
¡_cÚÃù
);

214 
	}
}

216 
ems_št
 
	$ş_cÚÃù
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

218 
ems_št
 
”r
;

219 
sockËn_t
 
Ën
;

221 
Ën
 = (
”r
);

222 
”r
 = 0;

223 
	`g‘sockİt
(
	`ems_sock_fd
(&
£ss
->
sock
), 
SOL_SOCKET
, 
SO_ERROR
, (
ems_ch¬
 *)&
”r
, &
Ën
);

225 ià(
”r
 ) {

226 
”ºo
 = 
”r
;

227 
	`ems_l_Œaû
("[clnt]sess(%d) connecto %s:%d failed, %s",

228 
	`ems_sock_fd
(&
£ss
->
sock
),

229 
	`ems_sock_addr
(&
£ss
->
sock
),

230 
	`ems_sock_pÜt
(&
£ss
->
sock
),

231 
	`ems_g‘”rmsg
(
”r
));

232  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

235 
	`ems_l_Œaû
("[clnt]sess(%d)ƒstablished with %s:%d",

236 
	`ems_sock_fd
(&
£ss
->
sock
),

237 
	`ems_sock_addr
(&
£ss
->
sock
),

238 
	`ems_sock_pÜt
(&
£ss
->
sock
));

240 
	`ems_æag_£t
(
£ss
->
æg
, 
EMS_FLG_ONLINE
);

242 ià(
	`ems_æag_like
(
ş
->
æg
, 
FLG_CLIENT_ONLINE
))

243  
	`ş_chªge_¡©us
(
ş
, 
¡_hb
);

245  
	`ş_chªge_¡©us
(
ş
, 
¡_»g
);

246 
	}
}

248 
ems_št
 
	$ş_¡İ³d
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

250 ià(
ş
->
£ss
) {

251 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
ş
->
£ss
);

252 
ş
->
£ss
 = 
NULL
;

255  
EMS_OK
;

256 
	}
}

258 
ems_št


259 
	$ş_´oûss_r¥
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_»¥Ú£
 *
r¥
, 
ş_evt_r¥_cb
 
h
)

261 
jsÚ_objeù
 *
roÙ
;

262 
ems_št
 
¹n
 = 
EMS_OK
;

264 
	`ems_as£¹
(
ş
 && 
£ss
 && 
r¥
);

266 
roÙ
 = 
NULL
;

267 ià(
r¥
->
Ën
 > 
SIZE_RESPONSE
) {

268 
ems_št
 
Ën
;

269 
ems_ch¬
 *
p
, 
ch
;

271 
	`ems_as£¹
(
	`buf_Ën
(&
£ss
->
buf_š
è>ğ
r¥
->
Ën
);

273 
p
 = (
ems_ch¬
 *)(
	`buf_rd
(&
£ss
->
buf_š
è+ 
SIZE_RESPONSE
);

274 
	`g‘wÜd
(
p
, 
Ën
);

276 
ch
 = 
p
[
Ën
];

277 
p
[
Ën
] = '\0';

278 
roÙ
 = 
	`ems_jsÚ_tok’”_·r£
(
p
);

279 
p
[
Ën
] = 
ch
;

281 #ifdeà
DEBUG


283 
ems_cch¬
 *
ùx
 = 
roÙ
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(root):"no ctx";

285 
	`ems_l_Œaû
("\033[01;34m[clnt]<rspag: 0x%x, st: %d ctx: %s> \033[00m",

286 
r¥
->
g
.
v®
,„¥->
¡
, 
	`¡¾’
(
ùx
)> 0x200?"**too†ong**":ctx);

291 ià(
h
)

292 
¹n
 = 
	`h
(
ş
, 
£ss
, 
r¥
, 
roÙ
);

294 
¹n
 = 
EMS_ERR
;

296 ià(
roÙ
)

297 
	`jsÚ_objeù_put
(
roÙ
);

299 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf_š
, 
r¥
->
Ën
, 
EMS_BUFFER_SEEK_CUR
);

300 
	`ems_bufãr_»äesh
(&
£ss
->
buf_š
);

301  
¹n
;

302 
	}
}

305 
ems_št
 
	$ş_´•roûss
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ş_evt_r¥_cb
 
h
)

307 
ems_»¥Ú£
 
r¥
;

309 
	`ems_as£¹
(
ş
 && 
£ss
 && 
h
);

311 ià(
	`buf_Ën
(&
£ss
->
buf_š
è< 
SIZE_RESPONSE
)

312  
EMS_CONTINUE
;

314 
	`ems_bufãr_´eãtch
(&
£ss
->
buf_š
, (
ems_ch¬
 *)
r¥
.
v®
, 
SIZE_RESPONSE
);

316 
r¥
.
g
.
v®
 = 
	`Áohl
(rsp.tag.val);

317 
r¥
.
Ën
 = 
	`Áohl
(rsp.len);

318 
r¥
.
¡
 = 
	`Áohl
(rsp.st);

320 ià(
r¥
.
Ën
 >ğ
	`buf_size
(&
£ss
->
buf_š
)) {

321 ià(
	`ems_bufãr_šü—£
(&
£ss
->
buf_š
, 
r¥
.
Ën
è!ğ
EMS_OK
)

322  
EMS_BUFFER_INSUFFICIENT
;

325 ià(
	`buf_Ën
(&
£ss
->
buf_š
è< 
r¥
.
Ën
)

326  
EMS_CONTINUE
;

328  
	`ş_´oûss_r¥
(
ş
, 
£ss
, &
r¥
, 
h
);

329 
	}
}

332 
ems_št


333 
	$ş_»cv_hªdË
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ş_evt_r¥_cb
 
h
)

335 
ems_št
 
»t
, 
agaš
;

337 
agaš
 = 
EMS_YES
;

338 
»cv_agaš
:

339 
»t
 = 
	`£ss_»cv
(
£ss
, &£ss->
buf_š
);

340 ià(
»t
 <= 0) {

341 
»t
) {

342 -
EAGAIN
:

343 
agaš
 = 
EMS_NO
;

346 ià(
	`buf_Ën
(&
£ss
->
buf_š
) > 0)

347 
	`ş_´•roûss
(
ş
, 
£ss
, 
h
);

348  
EMS_ERR
;

353 
»t
 = 
	`ş_´•roûss
(
ş
, 
£ss
, 
h
);

355 
»t
) {

356 
EMS_BUFFER_INSUFFICIENT
:

357 
EMS_ERR
:

358  
EMS_ERR
;

360 
EMS_OK
:

361 
EMS_CONTINUE
:

365 } 
»t
 !ğ
EMS_CONTINUE
);

367 ià(
agaš
)

368 
»cv_agaš
;

370  
EMS_OK
;

371 
	}
}

373 
ems_št
 
	$ş_£nd_msg
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

375 
ems_št
 
»t
;

377 
	`ems_as£¹
(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
));

379 
»t
 = 
	`£ss_£nd
(
£ss
, &£ss->
buf
);

380 ià(
»t
 <= 0) {

381 
»t
) {

383 -
EAGAIN
:

387  
»t
;

391 ià(
	`buf_Ën
(&
£ss
->
buf
) <= 0) {

392 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
ş_evt_cb
);

393 
	`£ss_timeout_ÿnûl
(
£ss
);

394 
	`ems_bufãr_»äesh
(&
£ss
->
buf
);

397  
EMS_OK
;

398 
	}
}

401 
ems_št
 
	$ş_nÜm®
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

403 
	`ems_as£¹
(
ş
->
£ss
 !ğ
NULL
);

405 
£ss
 = 
ş
->sess;

407 ià(
£ss
) {

408 
	`£ss_ev’t_ÿnûl
(
£ss
);

409 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

410 
	`ems_sock_fd
(&
£ss
->
sock
),

411 
	`ems_sock_addr
(&
£ss
->
sock
),

412 
	`ems_sock_pÜt
(&
£ss
->
sock
));

413 
	`ems_sock_şo£
(&
£ss
->
sock
);

414 
	`£ss_timeout_£t
(
£ss
, 
EMS_TIMEOUT_FOR_HB
, 
ş_timeout_cb
);

417  
EMS_OK
;

418 
	}
}

420 
ems_št


421 
	$ş_msg_r¥_hb
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_»¥Ú£
 *
r¥
, 
jsÚ_objeù
 *
roÙ
)

423 
ems_št
 
u±
;

425 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "modify_id", 
u±
, 0);

426 ià(
u±
 !ğ
ş
->upt) {

427 
	`ems_l_Œaû
("£rv”' u± upd©e: from %u iÁØ%u", 
ş
->
u±
, upt);

428 
ş
->
u±
 = upt;

429  
	`ş_chªge_¡©us
(
ş
, 
¡_­¶i¡
);

432  
	`ş_chªge_¡©us
(
ş
, 
¡_nÜm®
);

433 
	}
}

435 
ems_št
 
	$ş_hb
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

437 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

438 ià(
	`ş_»cv_hªdË
(
ş
, 
£ss
, 
ş_msg_r¥_hb
è!ğ
EMS_OK
)

440  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

444 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

445 ià(
	`ş_£nd_msg
(
ş
, 
£ss
, 
æg
è!ğ
EMS_OK
)

446  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

449  
EMS_OK
;

450 
	}
}

452 
ems_št


453 
	$ş_msg_r¥_»g
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_»¥Ú£
 *
r¥
, 
jsÚ_objeù
 *
roÙ
)

455 ià((
r¥
->
¡
 =ğ
EMS_OK
è&& 
roÙ
) {

456 
	`ems_jsÚ_g‘_¡ršg_def
(
roÙ
, "tick‘", &
ş
->
tick‘
, 
NULL
);

457 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "modify_id", 
ş
->
u±
, 0);

459 
	`ems_as£¹
(
	`¡r_Ën
(&
ş
->
tick‘
) > 0);

460 ià(
	`¡r_Ën
(&
ş
->
tick‘
) > 0) {

461 
	`ems_æag_£t
(
ş
->
æg
, 
FLG_CLIENT_ONLINE
);

462  
	`ş_chªge_¡©us
(
ş
, 
¡_­¶i¡
);

466  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

467 
	}
}

469 
ems_št
 
	$ş_»g
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

471 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

472 ià(
	`ş_»cv_hªdË
(
ş
, 
£ss
, 
ş_msg_r¥_»g
è!ğ
EMS_OK
)

474  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

478 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

479 ià(
	`ş_£nd_msg
(
ş
, 
£ss
, 
æg
è!ğ
EMS_OK
)

480  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

483  
EMS_OK
;

484 
	}
}

486 
ems_št


487 
	$ş_msg_r¥_­¶i¡
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_»¥Ú£
 *
r¥
, 
jsÚ_objeù
 *
roÙ
)

489 
	`ems_­¶i¡_´oûss
(
roÙ
);

494  
	`ş_chªge_¡©us
(
ş
, 
¡_nÜm®
);

495 
	}
}

497 
ems_št
 
	$ş_­¶i¡
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

499 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

500 ià(
	`ş_»cv_hªdË
(
ş
, 
£ss
, 
ş_msg_r¥_­¶i¡
è!ğ
EMS_OK
)

502  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

506 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

507 ià(
	`ş_£nd_msg
(
ş
, 
£ss
, 
æg
è!ğ
EMS_OK
)

508  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

511  
EMS_OK
;

512 
	}
}

514 
ems_št
 
	$ş_dowÆßd
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

516  
EMS_OK
;

517 
	}
}

519 
ems_št
 
	$ş_š¡®l
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

521  
EMS_OK
;

522 
	}
}

524 
ems_št
 
	$ş_”r
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

526 
	`ems_as£¹
(
ş
->
£ss
 !ğ
NULL
);

528 
£ss
 = 
ş
->sess;

530 ià(
£ss
) {

531 
	`£ss_ev’t_ÿnûl
(
£ss
);

532 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

533 
	`ems_sock_fd
(&
£ss
->
sock
),

534 
	`ems_sock_addr
(&
£ss
->
sock
),

535 
	`ems_sock_pÜt
(&
£ss
->
sock
));

536 
	`ems_sock_şo£
(&
£ss
->
sock
);

537 
	`£ss_timeout_£t
(
£ss
, 
EMS_TIMEOUT_ERROR_WAIT
, 
ş_timeout_cb
);

540 
	`ems_æag_un£t
(
ş
->
æg
, 
FLG_CLIENT_ONLINE
);

541 
ş
->
u±
 = -1;

543  
EMS_OK
;

544 
	}
}

546 
ems_št
 
	$ş_to_cÚÃù
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

548 
	`ems_l_Œaû
("[clnt]sess(%d) connecto %s:%dimeout",

549 
	`ems_sock_fd
(&
£ss
->
sock
),

550 
	`ems_sock_addr
(&
£ss
->
sock
),

551 
	`ems_sock_pÜt
(&
£ss
->
sock
));

553  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

554 
	}
}

556 
ems_št
 
	$ş_to_nÜm®
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

558 
	`ems_l_Œaû
("[şÁ]£ss(%dètimfÜ hb ", 
	`ems_sock_fd
(&
£ss
->
sock
));

559 #ifdeà
DEBUG


560 ià(!
ş
->
»Œy
)

561  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

563 
	`ems_bufãr_ş—r
(&
£ss
->
buf
);

564 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

566 ià(
	`ş_do_cÚÃù
(
£ss
è!ğ
EMS_OK
)

567  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

569 ià(
	`ems_æag_like
(
£ss
->
æg
, 
EMS_FLG_ONLINE
))

570  
	`ş_chªge_¡©us
(
ş
, 
¡_hb
);

572 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
|
EMS_EVT_WRITE
, 
ş_evt_cb
);

573 
	`£ss_timeout_£t
(
£ss
, 
EMS_TIMEOUT_CONNECT
, 
ş_timeout_cb
);

575  
	`ş_chªge_¡©us
(
ş
, 
¡_cÚÃù
);

576 
	}
}

578 
ems_št
 
	$ş_to_hb
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

580 
	`ems_l_Œaû
("[clnt]sess(%d) send hbimeouto %s:%d ",

581 
	`ems_sock_fd
(&
£ss
->
sock
),

582 
	`ems_sock_addr
(&
£ss
->
sock
),

583 
	`ems_sock_pÜt
(&
£ss
->
sock
));

585  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

586 
	}
}

588 
ems_št
 
	$ş_to_»g
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

590 
	`ems_l_Œaû
("[clnt]sess(%d)„ego %s:%dimeout",

591 
	`ems_sock_fd
(&
£ss
->
sock
),

592 
	`ems_sock_addr
(&
£ss
->
sock
),

593 
	`ems_sock_pÜt
(&
£ss
->
sock
));

595  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

596 
	}
}

598 
ems_št
 
	$ş_to_­¶i¡
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

600  
EMS_OK
;

601 
	}
}

603 
ems_št
 
	$ş_to_dowÆßd
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

605  
EMS_OK
;

606 
	}
}

608 
ems_št
 
	$ş_to_š¡®l
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

610  
EMS_OK
;

611 
	}
}

613 
ems_št
 
	$ş_to_”r
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

615 
	`ems_l_Œaû
("[clnt]imeo„etryo connect server");

616  
	`ş_chªge_¡©us
(
ş
, 
¡_š™
);

617 
	}
}

619 #ifdeà
DEBUG


620 
ems_cch¬
 *
	$ems_¡©us_¡r
(
ems_¡©us
 
¡
)

622 
¡
) {

623 
¡_š™
:

625 
¡_nÜm®
:

627 
¡_hb
:

629 
¡_»g
:

631 
¡_­¶i¡
:

633 
¡_dowÆßd
:

635 
¡_š¡®l
:

637 
¡_”r
:

639 
¡_¡İ³d
:

641 
¡_cÚÃù
:

644 
¡_auth
:

647 
¡_acù
:

650 
¡_acù_¡İ
:

657 
	}
}

661 
ems_št
 
	$ş_¡_što_»g
(
ems_ş›Á
 *
ş
)

663 
ems_£ssiÚ
 *
£ss
 = 
ş
->sess;

664 
jsÚ_objeù
 *
»q
;

666 
	`ems_as£¹
(
ş
->
£ss
 !ğ
NULL
);

668 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

669 
	`jsÚ_objeù_objeù_add
(
»q
, "code", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_¢
)));

670 
	`jsÚ_objeù_objeù_add
(
»q
, "mac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_mac
)));

672 
	`£ss_»que¡_£t
(
£ss
, 
»q
);

673 
	`cÜe_·ck_»q
(
£ss
, 
AC_MSG_REGISTER
);

674 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

675 
	`£ss_timeout_£t
(
£ss
, 
EMS_TIMEOUT_REGISTER
, 
ş_timeout_cb
);

677  
EMS_OK
;

678 
	}
}

680 
ems_št
 
	$ş_¡_što_hb
(
ems_ş›Á
 *
ş
)

682 
ems_£ssiÚ
 *
£ss
 = 
ş
->sess;

683 
jsÚ_objeù
 *
»q
;

685 
	`ems_as£¹
(
ş
->
£ss
 !ğ
NULL
);

687 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

688 
	`jsÚ_objeù_objeù_add
(
»q
, "tick‘", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
ş
->
tick‘
)));

690 
	`£ss_»que¡_£t
(
£ss
, 
»q
);

691 
	`cÜe_·ck_»q
(
£ss
, 
AC_MSG_HB
);

692 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

693 
	`£ss_timeout_£t
(
£ss
, 
EMS_TIMEOUT_REGISTER
, 
ş_timeout_cb
);

695  
EMS_OK
;

696 
	}
}

698 
ems_št
 
	$ş_¡_što_­¶i¡
(
ems_ş›Á
 *
ş
)

700 
ems_£ssiÚ
 *
£ss
 = 
ş
->sess;

701 
jsÚ_objeù
 *
»q
;

703 
	`ems_as£¹
(
ş
->
£ss
 !ğ
NULL
);

705 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

706 
	`jsÚ_objeù_objeù_add
(
»q
, "tick‘", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
ş
->
tick‘
)));

708 
	`£ss_»que¡_£t
(
£ss
, 
»q
);

709 
	`cÜe_·ck_»q
(
£ss
, 
AC_MSG_APPLIST
);

710 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

711 
	`£ss_timeout_£t
(
£ss
, 
EMS_TIMEOUT_REGISTER
, 
ş_timeout_cb
);

713  
EMS_OK
;

714 
	}
}

717 
ems_št
 
	$ş_chªge_¡©us
(
ems_ş›Á
 *
ş
, 
ems_¡©us
 
¡
)

719 
	`ems_l_Œaû
("[clnt] change status: %s ---> %s",

720 
	`ems_¡©us_¡r
(
ş
->
¡
),ƒms_status_str(st));

722 
ş
->
¡
 = st;

724 
ş
->
¡
) {

725 
¡_š™
:

726 
¡_¡İ³d
:

727 
¡_”r
:

728  
	`ş_evt_run
(
ş
, 
NULL
, 0);

731 
¡_»g
:

732  
	`ş_¡_što_»g
(
ş
);

735 
¡_­¶i¡
:

736  
	`ş_¡_što_­¶i¡
(
ş
);

738 
¡_nÜm®
:

739 
ş
->
»Œy
 = 5;

740  
	`ş_evt_run
(
ş
, 
NULL
, 0);

742 
¡_hb
:

743  
	`ş_¡_što_hb
(
ş
);

749  
EMS_OK
;

750 
	}
}

754 
ems_št
 
	$şÁ_š™
(
ems_cÜe
 *
cÜe
)

756 
ems_ş›Á
 *
ş
 = 
cÜe
->
şÁ
;

758 
	`mem£t
(
ş
, 0, (
ems_ş›Á
));

760 
ş
->
cÜe
 = core;

761 
ş
->
¡
 = 
¡_¡İ³d
;

762 
ş
->
£ss
 = 
NULL
;

764 
ş
->
u±
 = -1;

765 
ş
->
»Œy
 = 0;

766 
ş
->
æg
 = 0;

767 
	`¡r_š™
(&
ş
->
tick‘
);

769  
EMS_OK
;

770 
	}
}

772 
ems_št
 
	$şÁ_unš™
(
ems_cÜe
 *
cÜe
)

774 
ems_ş›Á
 *
ş
 = 
cÜe
->
şÁ
;

775 
	`ems_as£¹
(
cÜe
 !ğ
NULL
);

777 
	`ems_as£¹
(
ş
->
¡
 =ğ
¡_¡İ³d
);

779 ià(
ş
->
£ss
) {

780 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
ş
->
£ss
);

781 
ş
->
£ss
 = 
NULL
;

784 
ş
->
cÜe
 = 
NULL
;

785 
ş
->
¡
 = 
¡_¡İ³d
;

787 
	`¡r_unš™
(&
ş
->
tick‘
);

789  
EMS_OK
;

790 
	}
}

792 
ems_št
 
	$şÁ_run
(
ems_cÜe
 *
cÜe
, 
ems_št
 
run
)

794 
ems_ş›Á
 *
ş
 = 
cÜe
->
şÁ
;

795 
	`ems_as£¹
(
cÜe
 !ğ
NULL
 && 
ş
);

797 ià(
run
) {

798 ià(
ş
->
¡
 !ğ
¡_¡İ³d
)

799  
EMS_OK
;

801 
	`ems_­p_moduËs_run
(
EMS_YES
);

802 
	`ems_æag_£t
(
cÜe
->
æg
, 
FLG_RUN
);

803  
	`ş_chªge_¡©us
(
ş
, 
¡_š™
);

806 ià(
ş
->
¡
 =ğ
¡_¡İ³d
)

807  
EMS_OK
;

809 
	`ems_­p_moduËs_run
(
EMS_NO
);

810 
	`ems_æag_un£t
(
cÜe
->
æg
, 
FLG_RUN
);

811  
	`ş_chªge_¡©us
(
ş
, 
¡_¡İ³d
);

814  
EMS_OK
;

815 
	}
}

817 
ems_ş›Á
 *
	$şÁ_Ãw
()

819  (
ems_ş›Á
 *)
	`ems_m®loc
((ems_client));

820 
	}
}

822 
ems_void
 
	$şÁ_de¡roy
(
ems_ş›Á
 *
şÁ
)

824 ià(
şÁ
)

825 
	`ems_ä“
(
şÁ
);

826 
	}
}

828 
ems_št
 
	$ems_cmd_¡©us_fl_ems
(
ems_cÜe
 *
cÜe
, 
jsÚ_objeù
 *
roÙ
)

830 
ems_ş›Á
 *
ş
 = 
cÜe
->
şÁ
;

831 
jsÚ_objeù
 *
r¥
 = 
NULL
;

833 ià(!
ş
)

834  
EMS_ERR
;

836 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

837 
	`jsÚ_objeù_objeù_add
(
r¥
, "¡©us", 
	`jsÚ_objeù_Ãw_št
(
ş
->
¡
));

838 
	`jsÚ_objeù_objeù_add
(
roÙ
, "ems_c", 
r¥
);

840  
EMS_OK
;

841 
	}
}

	@src/core/ems_client.h

2 #iâdeà
EMS_CLIENT_HEADER_____123


3 
	#EMS_CLIENT_HEADER_____123


	)

5 
	~"ems_cÚf.h
"

7 
	#FLG_AUTO_REG
 0x00000001

	)

8 
	#FLG_RUN
 0x00000002

	)

9 
	#FLG_INITED
 0x00000004

	)

10 
	#FLG_CLIENT_ONLINE
 0x80000000

	)

11 
	#FLG_NETWORK_BRIDGE_RUN
 0x40000000

	)

12 
	#FLG_NETWORK_READY
 0x20000000

	)

13 
	#FLG_NETWORK_BRIDGE
 0x10000000

	)

14 
	#FLG_NETWORK_WIRELESS
 0x08000000

	)

15 
	#FLG_RADIUS_AUTO
 0x04000000

	)

16 
	#FLG_PORTAL_AUTO
 0x02000000

	)

17 
	#FLG_SESSION_IS_WEB
 0x01000000

	)

18 
	#FLG_NETWORK_LAN_BACK
 0x00800000

	)

19 
	#FLG_SUBDOMAIN_ENABLE
 0x00400000

	)

20 
	#FLG_NET_DNS_RUN
 0x00200000

	)

21 
	#FLG_FIRST_CONFIG
 0x00100000

	)

22 
	#FLG_CONFIG_READY
 0x00080000

	)

25 
_ems_cÜe_s
 
	tems_cÜe
;

26 
_ems_ş›Á_s
 
	tems_ş›Á
;

27 
_ems_¡©us_s
 
	tems_¡©us
;

28 
_msg_queue_s
 
	tmsgqueue
;

31 
_dns_s
 
	tems_dns
;

32 
_dns_h—d”_s
 
	tdns_h—d”
;

33 
_dns_que¡iÚ_s
 
	tdns_que¡iÚ
;

34 
_dns_¼_s
 
	tdns_¼
;

35 
_dns_™em_s
 
	tdns_™em
;

36 
_dns_u£r_s
 
	tdns_u£r
;

37 
_dns_u¾_s
 
	tdns_u¾
;

39 
_ems_fw_s
 
	tems_fw
;

41 
	s_ems_cÜe_s


43 
ems_cfg
 
	mcfg
;

44 
ems_ev’t
 
	mevt
;

45 
ems_ušt
 
	mæg
;

47 
ems_queue
 
	m­p_’Œy
;

49 
ems_bufãr
 
	mbuf
;

50 
ems_¡r
 
	mgw
;

51 
ems_¡r
 
	miâame
;

52 
ems_¡r
 
	mac_mac
;

53 
ems_¡r
 
	mpÜl
;

54 
ems_št
 
	mpÜl_»dœeù_pÜt
;

55 
ems_¡r
 
	mssid
;

56 
ems_¡r
 
	mdevty
;

57 
ems_¡r
 
	m¢
;

60 
ems_queue
 
	mmsg_’Œy
;

61 
ems_mtx
 
	mmsg_mtx
;

64 
	s_msg_queue_s
 {

65 
ems_ušt
 
	ms
;

66 
ems_ušt
 
	md
;

67 
ems_ušt
 
	mevt
;

68 
jsÚ_objeù
 *
	mobj
;

69 
ems_queue
 
	m’Œy
;

73 
	e_ems_¡©us_s


75 
	m¡_mš
 = -1,

76 
	m¡_š™
 = 0,

77 
	m¡_¡İ³d
,

78 
	m¡_nÜm®
,

79 
	m¡_hb
,

80 
	m¡_»g
,

81 
	m¡_­¶i¡
,

82 
	m¡_dowÆßd
,

83 
	m¡_š¡®l
,

84 
	m¡_”r
,

85 
	m¡_cÚÃù
,

87 
	m¡_g‘cÚfig
,

88 
	m¡_g‘upd©efe
,

90 
	#¡_¡¬t
 
¡_š™


	)

91 
	#¡_g‘dc
 
¡_»g


	)

92 
	#¡_­¶y
 
¡_š¡®l


	)

93 
	#¡_upd©e¡©us
 
¡_hb


	)

95 
	m¡_auth
,

96 
	m¡_acù
,

97 
	m¡_acù_¡İ
,

98 
	m¡_max


101 
	s_ems_ş›Á_s


103 
ems_£ssiÚ
 *
	m£ss
;

104 
ems_¡©us
 
	m¡
;

105 
ems_void
 *
	mùx
;

106 
ems_¡©us
 
	mÃxt
;

108 
ems_ušt
 
	mu±
;

109 
ems_št
 
	m»Œy
;

110 
ems_ušt
 
	mæg
;

111 
ems_št
 
	mu£_s¦
;

112 
ems_ušt
 
	mÏ¡”r
;

114 
ems_¡r
 
	mnm_addr
;

115 
ems_št
 
	mnm_pÜt
;

116 
ems_št
 
	mg‘cÚf
;

118 
ems_lÚg
 
	mn_u±
;

119 
ems_lÚg
 
	mn_cÚf
;

121 
ems_št
 
	mu±_³riod
;

122 
ems_št
 
	mg‘cÚf_³riod
;

123 
ems_št
 
	m»Œy_³riod
;

125 
ems_´oûssid
 
	mpid
;

130 
ems_št
 
ems_£nd_mes§ge
(
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
obj
);

133 
ems_št
 
ems_cÜe_š™
(
ems_cÜe
 *
cÜe
);

134 
ems_št
 
ems_cÜe_unš™
(
ems_cÜe
 *
cÜe
);

135 
ems_št
 
ems_cÜe_maš
(
ems_cÜe
 *
cÜe
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

137 
ems_št
 
cÜe_·ck_r¥
(
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
g
,ƒms_šˆ
¡
);

138 
ems_št
 
cÜe_·ck_»q
(
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
g
);

139 
ems_cÜe
 *
emscÜ”
();

140 
ems_cfg
 *
emscfg
();

142 #ifdeà
DEBUG


143 
ems_cch¬
 *
ems_¡©us_¡r
(
ems_¡©us
 
¡
);

145 
ems_cch¬
 *
ems_pİ’_g‘
Óms_cch¬ *
cmd
);

146 
ems_cch¬
 *
ems_¡rÿt
Óms_cch¬ *
s1
,ƒms_cch¬ *
s2
);

147 
ems_ch¬
 *
ems_u£rmac
(
ems_cch¬
 *

);

148 
ems_št
 
ems_sy¡emcmd
(
ems_cch¬
 *
cmd
);

149 
ems_št
 
cÜe_wœ–ess_šfo
();

150 
ems_št
 
ems_æush_sy¡em_šfo
();

157 
ems_void
 
cÜe_gw_addr_ş—r
();

158 
ems_cch¬
 *
cÜe_gw_addr
();

159 
ems_void
 
cÜe_gw_iâame_ş—r
();

160 
ems_cch¬
 *
cÜe_gw_iâame
();

161 
ems_bufãr
 *
cÜe_bufãr
();

163 
ems_cch¬
 *
cÜe_ac_mac
();

164 
ems_cch¬
 *
cÜe_pÜl_addr
();

165 
ems_št
 
cÜe_pÜl_»dœeù_pÜt
();

166 
ems_cch¬
 *
cÜe_ssid
();

167 
ems_cch¬
 *
cÜe_deviûty³
();

168 
ems_cch¬
 *
cÜe_¢
();

170 
	#NAS_ADDR
 "115.28.38.73"

	)

171 
	#NAS_INFO_URL
 "h‰p://"
NAS_ADDR


	)

173 
ems_void
 
ems_£twifi_nİasswÜd
();

174 
ems_št
 
ş_chªge_¡©us
(
ems_ş›Á
 *
ş
, 
ems_¡©us
 
¡
);

	@src/core/ems_client_v1.c

2 #iâdeà
USE_EMS_SERVER


4 
	~"ems_cÜe.h
"

5 
	~"ems_ş›Á.h
"

6 
	~"­p.h
"

7 
	~"ems_fw.h
"

9 
	#EMS_TIMEOUT_SEND
 10000

	)

10 
	#EMS_TIMEOUT_CONNECT
 10000

	)

13 
	#ERR_DEVICE_INACTIVE
 0x999

	)

14 
	#ERR_CONNECT_DC_FAILED
 0x1000

	)

15 
	#ERR_DOWNLOAD_APPCONFIG
 0x1001

	)

16 
	#ERR_RESPONSE_ERROR
 0x1002

	)

18 
	#ERR_CONNECT_NM_FAILED
 0x2000

	)

19 
	#ERR_DOWNLOAD_CONFIG_FAILED
 0x2001

	)

20 
	#ERR_SETUPFILE_MISSING
 0x2002

	)

21 
	#ERR_INSTALL_FAILED
 0x2003

	)

25 #ifdeà
FOR_TEST_INM


30 
	#GETDC_RSP_ERR
 "{'jsÚ½c': '2.0', '”rÜ': {'code': -1, 'mes§ge': 'M‘hod‚Ù found'}, 'id': 1}"

	)

31 
	#GETDC_RSP_OK
 \

34 "'id': 1}"

	)

38 
ems_cch¬
 *
	gnm_r¥
[] = {

39 [
¡_g‘dc
] = 
GETDC_RSP_OK
,

41 [
¡_g‘cÚfig
] =

75 [
¡_g‘upd©efe
] =

90 [
¡_max
] = 
NULL


95 
ems_void
 
ş_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

96 
ems_void
 
ş_evt_cb
 (
ems_£ssiÚ
 *
£ss
, 
ems_št
 
¡
,ƒms_šˆ
æg
);

98 
ems_št
 
ş_¡¬t
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

99 
ems_št
 
ş_¡İ³d
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

100 
ems_št
 
ş_”r
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

101 
ems_št
 
ş_nÜm®
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

102 
ems_št
 
ş_g‘dc
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

103 
ems_št
 
ş_g‘cÚfig
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

104 
ems_št
 
ş_g‘upd©efe
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

105 
ems_št
 
ş_dowÆßd
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

106 
ems_št
 
ş_­¶y
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

107 
ems_št
 
ş_upd©e¡©us
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

108 
ems_št
 
ş_cÚÃù
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

110 
	$ems_št
 (*
	tş_evt_func
)(
	tems_ş›Á
 *
	tş
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_ušt
 
	tæg
);

111 
ş_evt_func
 
ù¾_hªdËr
[] =

113 [
¡_¡¬t
] = 
ş_¡¬t
,

114 [
¡_¡İ³d
] = 
ş_¡İ³d
,

115 [
¡_”r
] = 
ş_”r
,

116 [
¡_nÜm®
] = 
ş_nÜm®
,

117 [
¡_g‘dc
] = 
ş_g‘dc
,

118 [
¡_g‘cÚfig
] = 
ş_g‘cÚfig
,

119 [
¡_g‘upd©efe
] = 
ş_g‘upd©efe
,

120 [
¡_dowÆßd
] = 
ş_dowÆßd
,

121 [
¡_­¶y
] = 
ş_­¶y
,

122 [
¡_upd©e¡©us
] = 
ş_upd©e¡©us
,

123 [
¡_cÚÃù
] = 
ş_cÚÃù
,

124 [
¡_max
] = 
NULL


125 
	}
};

127 
	$ems_št
 (*
	tş_timeout_func
)(
	tems_ş›Á
 *
	tæ
, 
	tems_£ssiÚ
 *
	t£ss
);

129 
ems_št
 
	`ş_to_”r
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

130 
ems_št
 
	`ş_to_nÜm®
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

131 
ems_št
 
	`ş_to_g‘dc
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

132 
ems_št
 
	`ş_to_g‘cÚfig
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

133 
ems_št
 
	`ş_to_g‘upd©efe
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

134 
ems_št
 
	`ş_to_dowÆßd
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

135 
ems_št
 
	`ş_to_upd©e¡©us
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

136 
ems_št
 
	`ş_to_cÚÃù
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
);

138 
ş_timeout_func
 
timeout_hªdËr
[] =

140 [
¡_¡¬t
] = 
NULL
,

141 [
¡_¡İ³d
] = 
NULL
,

142 [
¡_”r
] = 
ş_to_”r
,

143 [
¡_nÜm®
] = 
ş_to_nÜm®
,

144 [
¡_g‘dc
] = 
ş_to_g‘dc
,

145 [
¡_g‘cÚfig
] = 
ş_to_g‘cÚfig
,

146 [
¡_g‘upd©efe
] = 
ş_to_g‘upd©efe
,

147 [
¡_dowÆßd
] = 
ş_to_dowÆßd
,

148 [
¡_­¶y
] = 
NULL
,

149 [
¡_upd©e¡©us
] = 
ş_to_upd©e¡©us
,

150 [
¡_cÚÃù
] = 
ş_to_cÚÃù
,

151 [
¡_max
] = 
NULL


152 
	}
};

154 
	$ems_št
 (*
	tş_evt_r¥_cb
)(
	tems_ş›Á
 *, 
	tems_£ssiÚ
 *
	t£ss
, 
	tjsÚ_objeù
 *
	troÙ
);

156 
jsÚ_objeù
 *
	$ş_kv_što_jsÚ
(
ems_cch¬
 *
ùx
)

158 
jsÚ_objeù
 *
obj
 = 
NULL
;

159 
ems_bufãr
 
buff
;

160 
ems_cch¬
 *
p
, *
q
;

161 
ems_ch¬
 *
buf
, *
k
, *
v
;

162 
ems_št
 
Ën
;

164 
	`ems_bufãr_š™
(&
buff
, 
EMS_BUFFER_1K
);

165 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

167 
buf
 = 
	`buf_wr
(&
buff
);

168 
k
 = 
v
 = 
NULL
;

171 
	`mem£t
(
buf
, 0, 
	`buf_size
(&
buff
));

172 
q
 = 
ùx
;

173 
p
 = 
	`¡rchr
(
q
, '\n');

175 ià(!
p
) {

176 
ùx
 +ğ
	`¡¾’
(ctx);

177 
p
 = 
ùx
;

180 
ùx
 = 
p
 + 1;

182 
Ën
 = 
	`abs
(
p
 - 
q
);

183 ià(
Ën
 > 
	`buf_size
(&
buff
))

184 
Ën
 = 
	`buf_size
(&
buff
) -1;

186 
	`memıy
(
buf
, 
q
, 
Ën
);

188 
	`ems_Œim
(
buf
);

189 
	`ems_l_Œaû
("lššfo: %s", 
buf
);

191 
k
 = 
buf
;

192 
v
 = 
	`¡rchr
(
k
, '=');

194 ià(
v
 && 
	`¡¾’
(vè> 0 && sŒËn(
k
) > 0) {

195 *
v
 = '\0';

196 
v
++;

198 
	`jsÚ_objeù_objeù_add
(
obj
, 
k
, 
	`jsÚ_objeù_Ãw_¡ršg
(
v
));

200 } *
ùx
);

202 
	`ems_bufãr_unš™
(&
buff
);

204 #ifdeà
DEBUG


205 
	`ems_l_Œaû
("after convert: ");

206 
	`jsÚ_objeù_objeù_fÜ—ch
(
obj
, 
key
, 
v®
)

207 
	`ems_l_Œaû
("\t% >> %s", 
key
, 
	`jsÚ_objeù_g‘_¡ršg
(
v®
));

210  
obj
;

211 
	}
}

213 
ems_št


214 
	$g½_jsÚ_cfg
(
jsÚ_objeù
 *
d¡
, jsÚ_objeù *
¤c
, 
ems_cch¬
 *
roÙ
,ƒms_cch¬ *
sub
, 
ems_št
 
¬y
)

216 
jsÚ_objeù
 *
obj
 = 
NULL
, *
chd
 = NULL;

217 
ems_cch¬
 *
p
;

218 
ems_št
 
Ën
;

220 
	`ems_as£¹
(
d¡
 && 
¤c
 && 
roÙ
);

222 ià(
¬y
) {

223 ià(
sub
) {

224 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

225 
chd
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

226 
	`jsÚ_objeù_objeù_add
(
obj
, 
sub
, 
chd
);

228 
obj
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

231 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

233 
	`jsÚ_objeù_objeù_add
(
d¡
, 
roÙ
, 
obj
);

234 
Ën
 = 
	`¡¾’
(
roÙ
);

236 
	`jsÚ_objeù_objeù_fÜ—ch
(
¤c
, 
key
, 
v®
)

238 ià(
	`¡¾’
(
key
è< 
Ën
)

241 ià(!
	`¡ºcmp
(
key
, 
roÙ
, 
Ën
)) {

242 
p
 = 
key
 + 
Ën
 + 1;

243 ià(
sub
 && !
	`¡r¡r
(
key
, sub))

246 ià(
¬y
) {

247 ià(
chd
)

248 
	`jsÚ_objeù_¬¿y_add
(
chd
, 
	`jsÚ_objeù_Ãw_¡ršg
(
	`jsÚ_objeù_g‘_¡ršg
(
v®
)));

250 
	`jsÚ_objeù_¬¿y_add
(
obj
, 
	`jsÚ_objeù_Ãw_¡ršg
(
	`jsÚ_objeù_g‘_¡ršg
(
v®
)));

253 
	`jsÚ_objeù_objeù_add
(
obj
, 
p
, 
	`jsÚ_objeù_Ãw_¡ršg
(
	`jsÚ_objeù_g‘_¡ršg
(
v®
)));

257 
	`ems_l_Œaû
("g½ : %s, %s", 
roÙ
, 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
obj
));

259  
EMS_OK
;

260 
	}
}

262 
	#ems_jsÚ_key_©oi
(
obj
, 
»q
, 
key
) \

263 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, 
key
); \

264 ià(
obj
) \

265 
	`jsÚ_objeù_objeù_add
(
»q
, 
key
, \

266 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
)))); \

268 
	`ems_l_Œaû
("w¬nšg, did‚Ù fšd key: %s", 
key
)

	)

272 
ems_št
 
	$g½_jsÚ_pÜl_upd©e
(
jsÚ_objeù
 *
roÙ
)

274 
jsÚ_objeù
 *
»q
, *
obj
;

276 
»q
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "portal");

278 ià(!
»q
)

279  
EMS_OK
;

281 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "port");

282 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "redirect_port");

283 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "reg_period");

284 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "hb_period");

286  
EMS_OK
;

287 
	}
}

289 
ems_št
 
	$g½_jsÚ_¿dius_upd©e
(
jsÚ_objeù
 *
roÙ
)

291 
jsÚ_objeù
 *
»q
, *
obj
;

293 
»q
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "radius");

295 ià(!
»q
)

296  
EMS_OK
;

298 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "authport");

299 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "acctport");

300 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "rp_period");

301 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "retry_times");

302 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "retry_timeout");

304  
EMS_OK
;

305 
	}
}

307 
ems_št
 
	$g½_jsÚ_ş›Á_upd©e
(
jsÚ_objeù
 *
roÙ
)

309 
jsÚ_objeù
 *
»q
, *
obj
;

311 
»q
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "client");

313 ià(!
»q
)

314  
EMS_OK
;

316 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "upt_period");

317 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "getconf_period");

318 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "retry_period");

319 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "enable_subdomain");

321  
EMS_OK
;

322 
	}
}

324 
ems_št
 
	$g½_jsÚ_wœ–ess_upd©e
(
jsÚ_objeù
 *
roÙ
)

326 
jsÚ_objeù
 *
»q
, *
obj
;

328 
»q
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "wireless");

330 ià(!
»q
)

331  
EMS_OK
;

333 
	`ems_jsÚ_key_©oi
(
obj
, 
»q
, "enable_encrypt");

335  
EMS_OK
;

336 
	}
}

338 
jsÚ_objeù
 *
	$g½_®l_cfgs
(
jsÚ_objeù
 *
obj
)

340 
jsÚ_objeù
 *
roÙ
 = 
NULL
;

341 
roÙ
 = 
	`jsÚ_objeù_Ãw_objeù
();

343 
	`g½_jsÚ_cfg
(
roÙ
, 
obj
, "ş›Á", 
NULL
, 
EMS_NO
);

344 
	`g½_jsÚ_cfg
(
roÙ
, 
obj
, "pÜl", 
NULL
, 
EMS_NO
);

345 
	`g½_jsÚ_cfg
(
roÙ
, 
obj
, "¿dius", 
NULL
, 
EMS_NO
);

346 
	`g½_jsÚ_cfg
(
roÙ
, 
obj
, "bwli¡", "wh™e", 
EMS_YES
);

347 
	`g½_jsÚ_cfg
(
roÙ
, 
obj
, "wœ–ess", 
NULL
, 
EMS_NO
);

349 
	`g½_jsÚ_pÜl_upd©e
(
roÙ
);

350 
	`g½_jsÚ_¿dius_upd©e
(
roÙ
);

351 
	`g½_jsÚ_ş›Á_upd©e
(
roÙ
);

352 
	`g½_jsÚ_wœ–ess_upd©e
(
roÙ
);

354 #ifdeà
DEBUG


355 
	`ems_l_Œaû
("after grouped: ");

356 
	`jsÚ_objeù_objeù_fÜ—ch
(
roÙ
, 
key
, 
v®
) {

357 
	`jsÚ_objeù_g‘_ty³
(
v®
)) {

358 
jsÚ_ty³_¬¿y
:

362 
	`ems_l_Œaû
("% ==> %s", 
key
, 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
v®
));

368  
roÙ
;

369 
	}
}

372 
ems_void
 
	$ş_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

374 
ems_ş›Á
 *
ş
 = (ems_ş›Á *)
	`£ss_cb¬g
(
£ss
);

376 
	`ems_as£¹
(
ş
->
¡
 > 
¡_mš
 && cl->¡ < 
¡_max
);

378 
	`ems_as£¹
(
timeout_hªdËr
[
ş
->
¡
]);

380 ià(
timeout_hªdËr
[
ş
->
¡
])

381 
timeout_hªdËr
[
ş
->
¡
](ş, 
£ss
);

382 
	}
}

384 
ems_št
 
	$ş_evt_run
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_št
 
æg
)

386 
	`ems_as£¹
(
ş
 && cl->
¡
 > 
¡_mš
 && cl->¡ < 
¡_max
);

388 
	`ems_as£¹
(
ù¾_hªdËr
[
ş
->
¡
]);

390  
ù¾_hªdËr
[
ş
->
¡
](ş, 
£ss
, 
æg
);

391 
	}
}

393 
ems_void
 
	$ş_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

395 
ems_ş›Á
 *
ş
 = (ems_ş›Á *)
	`£ss_cb¬g
(
£ss
);

397 
	`ems_as£¹
(
ş
->
¡
 > 
¡_mš
 && cl->¡ < 
¡_max
);

399 ià(
”r
) {

400 
	`ems_l_Œaû
("[clnt]ƒvtƒrr, sess: %d %s:%d",

401 
	`ems_sock_fd
(&
£ss
->
sock
),

402 
	`ems_sock_addr
(&
£ss
->
sock
),

403 
	`ems_sock_pÜt
(&
£ss
->
sock
)

406 
ş
->
Ï¡”r
 = 
ERR_CONNECT_DC_FAILED
;

407 ià(
ş
->
Ãxt
 !ğ
¡_g‘dc
)

408 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

409 
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

413 
	`ş_evt_run
(
ş
, 
£ss
, 
æg
);

414 
	}
}

416 
ems_št
 
	$ş_do_cÚÃù
(
ems_£ssiÚ
 *
£ss
)

418 
ems_št
 
fd
, 
»t
;

419 
sockËn_t
 
Ën
;

420 
sockaddr_š
 
addr
;

421 
ems_sock
 *
sock
 = &
£ss
->sock;

423 
	`ems_as£¹
(
£ss
);

425 
	`mem£t
(&
addr
, 0, (addr));

426 ià(
	`ems_g‘ho¡byÇme
(
	`ems_sock_addr
(
sock
), &
addr
è!ğ
OK
) {

427 
	`ems_l_Œaû
("gethostbyename failed %s : %s",

428 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

429  
EMS_ERR
;

432 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
);

433 ià(
fd
 <= 0)

434  
EMS_ERR
;

436 
	`ems_l_Œaû
("[clnt] sess(%d)ryo connecto: %s(%s): %d...",

437 
fd
,

438 
	`ems_sock_addr
(
sock
),

439 
	`š‘_Áß
(
addr
.
sš_addr
),

440 
	`ems_sock_pÜt
(
sock
));

442 
addr
.
sš_çmy
 = 
AF_INET
;

443 
addr
.
sš_pÜt
 = 
	`htÚs
(
	`ems_sock_pÜt
(
sock
));

445 
	`ems_£ŠÚblockšg
(
fd
, 
YES
);

446 
Ën
 = (
sockaddr_š
);

447 
»t
 = 
	`cÚÃù
(
fd
, (
sockaddr
 *)&
addr
, 
Ën
);

449 
»t
) {

451 
	`ems_æag_£t
(
£ss
->
æg
, 
EMS_FLG_ONLINE
);

455 
»t
 = 
	`ems_Ï¡”r
();

456 
	`ems_æag_un£t
(
£ss
->
æg
, 
EMS_FLG_ONLINE
);

458 ià(
»t
 !ğ
EINPROGRESS
) {

459 
	`şo£
(
fd
);

460 
	`ems_l_Œaû
("[clnt] connecto: %s:%d: failed: %s",

461 
	`ems_sock_addr
(
sock
),

462 
	`ems_sock_pÜt
(
sock
),

463 
	`ems_g‘”rmsg
(
»t
));

464  
EMS_ERR
;

471 
	`ems_sock_£tfd
(
sock
, 
fd
);

472  
EMS_OK
;

473 
	}
}

477 
ems_št
 
	$ş_¡¬t
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

479 ià(!
ş
->
£ss
) {

480 
ş
->
£ss
 = 
	`ems_£ssiÚ_Ãw
();

481 
	`ems_as£¹
(
ş
->
£ss
 !ğ
NULL
);

482 ià(!
ş
->
£ss
)

483  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

485 
	`ems_bufãr_šü—£
(&
ş
->
£ss
->
buf
, 
EMS_BUFFER_4k
 - 
EMS_BUFFER_1K
);

486 
	`ems_bufãr_šü—£
(&
ş
->
£ss
->
buf_š
, 
EMS_BUFFER_4k
 - 
EMS_BUFFER_1K
);

487 
	`£ss_cb¬g_£t
(
ş
->
£ss
, cl);

490 
ş
->
»Œy_³riod
 = 
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ş›Á_»Œy_³riod
));

491 ià(
ş
->
»Œy_³riod
 <= 0) {

492 
ş
->
»Œy_³riod
 = 600;

493 
	`cfg_£t
(
	`emscfg
(), 
CFG_ş›Á_»Œy_³riod
, 
	`ems_™ß
(
ş
->
»Œy_³riod
));

496 
ş
->
u±_³riod
 = 
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ş›Á_u±_³riod
));

497 ià(
ş
->
u±_³riod
 <= 0) {

498 
ş
->
u±_³riod
 = 300;

499 
	`cfg_£t
(
	`emscfg
(), 
CFG_ş›Á_u±_³riod
, 
	`ems_™ß
(
ş
->
u±_³riod
));

502 
ş
->
g‘cÚf_³riod
 = 
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ş›Á_g‘cÚf_³riod
));

503 ià(
ş
->
g‘cÚf_³riod
 <= 0) {

504 
ş
->
g‘cÚf_³riod
 = 600;

505 
	`cfg_£t
(
	`emscfg
(), 
CFG_ş›Á_g‘cÚf_³riod
, 
	`ems_™ß
(
ş
->
g‘cÚf_³riod
));

508 
£ss
 = 
ş
->sess;

509 
	`ems_bufãr_ş—r
(&
£ss
->
buf
);

510 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

512 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_s_addr
));

513 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_s_pÜt
)));

515 ià(
	`ş_do_cÚÃù
(
£ss
è!ğ
EMS_OK
) {

516 
ş
->
Ï¡”r
 = 
ERR_CONNECT_DC_FAILED
;

517  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

520 ià(
	`ems_æag_like
(
£ss
->
æg
, 
EMS_FLG_ONLINE
))

521  
	`ş_chªge_¡©us
(
ş
, 
¡_g‘dc
);

523 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
|
EMS_EVT_WRITE
, 
ş_evt_cb
);

524 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_CONNECT
, 
ş_timeout_cb
);

526 
ş
->
Ãxt
 = 
¡_g‘dc
;

527  
	`ş_chªge_¡©us
(
ş
, 
¡_cÚÃù
);

528 
	}
}

530 
ems_št
 
	$ş_¡İ³d
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

532 ià(
ş
->
£ss
) {

533 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
ş
->
£ss
);

534 
ş
->
£ss
 = 
NULL
;

537 
ş
->
n_cÚf
 = -1;

538 
ş
->
n_u±
 = -1;

540 ià(
ş
->
pid
) {

541 
	`wa™pid
(
ş
->
pid
, 
NULL
, 
WNOHANG
);

542 
ş
->
pid
 = 0;

545  
EMS_OK
;

546 
	}
}

548 
ems_št
 
	$ş_”r
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

550 
	`ems_as£¹
(
ş
->
£ss
 !ğ
NULL
);

552 
£ss
 = 
ş
->sess;

554 
	`ems_as£¹
(
£ss
 !ğ
NULL
);

555 ià(
£ss
) {

556 
	`£ss_ev’t_ÿnûl
(
£ss
);

557 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

558 
	`ems_sock_fd
(&
£ss
->
sock
),

559 
	`ems_sock_addr
(&
£ss
->
sock
),

560 
	`ems_sock_pÜt
(&
£ss
->
sock
));

561 
	`ems_sock_şo£
(&
£ss
->
sock
);

563 
	`ems_æag_un£t
(
£ss
->
æg
, 
EMS_FLG_ONLINE
);

564 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
ş
->
»Œy_³riod
 * 1000, 
ş_timeout_cb
);

566 
	`ems_bufãr_ş—r
(&
£ss
->
buf
);

567 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

570 ià(
ş
->
pid
) {

571 
	`wa™pid
(
ş
->
pid
, 
NULL
, 
WNOHANG
);

572 
ş
->
pid
 = 0;

578  
EMS_OK
;

579 
	}
}

581 
ems_št
 
	$ş_nÜm®
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

583  
EMS_OK
;

584 
	}
}

586 
ems_št
 
	$ş_£nd_msg
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

588 
ems_št
 
»t
;

590 
	`ems_as£¹
(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
));

592 
»t
 = 
	`£ss_£nd
(
£ss
, &£ss->
buf
);

593 ià(
»t
 <= 0) {

594 
»t
) {

596 -
EAGAIN
:

600  
»t
;

604 ià(
	`buf_Ën
(&
£ss
->
buf
) <= 0) {

605 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
ş_evt_cb
);

606 
	`ems_bufãr_ş—r
(&
£ss
->
buf
);

609  
EMS_OK
;

610 
	}
}

617 
ems_št
 
	$ş_f‹r_h‰p_r¥
(
ems_bufãr
 *
buff
)

619 
ems_ch¬
 *
£p
, *
ù_Ën
;

620 
ems_ch¬
 *
rd
 = 
	`buf_rd
(
buff
);

621 
ems_št
 
tÙ®
 = 0;

623 
	#HTTP_SEP
 "\r\n\r\n"

	)

624 
	#CONTENT_LENGTH
 "CÚ‹Á-L’gth: "

	)

626 
	`ems_l_Œaû
("r¥ cÚ‹Á: %s", 
rd
);

629 ià(
	`buf_Ën
(
buff
) <= 4)

630  
EMS_CONTINUE
;

632 ià(
	`¡ºcmp
("HTTP", 
rd
, 4))

633  
EMS_ERR
;

635 #iâdeà
FOR_TEST_INM


636 ià(!
	`¡r¡r
(
rd
, "200"))

637  
EMS_ERR
;

640 
£p
 = 
ù_Ën
 = 
NULL
;

642 
ù_Ën
 = 
	`¡r¡r
(
rd
, 
CONTENT_LENGTH
);

643 ià(
ù_Ën
) {

644 
ù_Ën
 +ğ
	`¡¾’
(
CONTENT_LENGTH
);

645 
tÙ®
 = 
	`ems_©oi
(
ù_Ën
);

647 
	`ems_l_Œaû
("g‘†’gth: %d", 
tÙ®
);

649 ià(
tÙ®
 <ğ0 ||Ù® > 
EMS_BUFFER_16k
 ) {

650 
	`ems_l_Œaû
("Content-Lengthƒrror 0x%x (0 < x < 0x%x)",

651 
tÙ®
, 
EMS_BUFFER_16k
);

652  
EMS_ERR
;

655 ià(
	`buf_size
(
buff
è- 
tÙ®
 <= 0) {

656 
	`ems_l_Œaû
("total: 0x%x,†eft: %d, size:%d, do increase",

657 
tÙ®
, 
	`buf_Ëá
(
buff
), 
	`buf_size
(buff));

658 
	`ems_bufãr_šü—£
(
buff
, 
tÙ®
);

659  
EMS_CONTINUE
;

663 
£p
 = 
	`¡r¡r
(
rd
, 
HTTP_SEP
);

664 ià(
£p
) {

666 ià(
tÙ®
 > 0) {

667 ià(
	`abs
(
	`buf_Ën
(
buff
è-‡bs((
£p
 + 
	`¡¾’
(
HTTP_SEP
è- 
rd
))è< 
tÙ®
)

668  
EMS_CONTINUE
;

670 *
£p
 = '\0';

671 
£p
 +ğ
	`¡¾’
(
HTTP_SEP
);

673 
	`ems_bufãr_£ek_rd
(
buff
, 
	`abs
(
£p
 - 
rd
), 
EMS_BUFFER_SEEK_CUR
);

674 
	`ems_l_Œaû
("h—dËn(%d), CÚ‹Á: %s", 
	`abs
(
£p
 -
rd
), 
	`buf_rd
(
buff
));

677 ià(
£p
) {

678 ià(
ù_Ën
 ) {

679 ià(
	`buf_Ën
(
buff
è< 
tÙ®
)

680  
EMS_CONTINUE
;

683 
	`ems_bufãr_»äesh
(
buff
);

684  
EMS_OK
;

687  
EMS_CONTINUE
;

688 
	}
}

690 
ems_št
 
	$ş_´•roûss
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ş_evt_r¥_cb
 
h
)

692 
ems_cch¬
 *
buf
;

693 
ems_št
 
Ën
, 
¹n
;

694 
jsÚ_tok’”
 *
tok
;

695 
jsÚ_objeù
 *
jobj
;

696 
jsÚ_tok’”_”rÜ
 
j”r
;

698 
¹n
 = 
	`ş_f‹r_h‰p_r¥
(&
£ss
->
buf_š
);

699 ià(
¹n
 !ğ
EMS_OK
)

700  
¹n
;

702 
tok
 = 
	`jsÚ_tok’”_Ãw
();

703 ià(!
tok
)

704  
EMS_ERR
;

706 #ifdeà
FOR_TEST_INM


707 ià(
nm_r¥
[
ş
->
¡
] !ğ
NULL
) {

708 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

709 
	`ems_l_Œaû
("»¶aû cu¼’ˆcÚ‹Á iÁo; %s", 
nm_r¥
[
ş
->
¡
]);

710 
	`ems_bufãr_wr™e
(&
£ss
->
buf_š
, 
nm_r¥
[
ş
->
¡
], 
	`¡¾’
(nm_rsp[cl->st]));

713 
buf
 = 
	`buf_rd
(&
£ss
->
buf_š
);

714 
Ën
 = 
	`buf_Ën
(&
£ss
->
buf_š
);

716 
jobj
 = 
	`jsÚ_tok’”_·r£_ex
(
tok
, 
buf
, 
Ën
);

718 ià((
j”r
 = 
	`jsÚ_tok’”_g‘_”rÜ
(
tok
)è=ğ
jsÚ_tok’”_cÚtšue
)

720 
	`jsÚ_tok’”_ä“
(
tok
);

721  
EMS_CONTINUE
;

724 
	`jsÚ_tok’”_ä“
(
tok
);

726 ià(!(
jobj
 && (
j”r
 =ğ
jsÚ_tok’”_sucûss
))) {

727 
	`ems_l_Œaû
("·r£ƒ¼: %s", 
	`jsÚ_tok’”_”rÜ_desc
(
j”r
));

728 ià(
jobj
)

729 
	`jsÚ_objeù_put
(
jobj
);

731 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

732 
ş
->
Ï¡”r
 = 
ERR_RESPONSE_ERROR
;

733  
EMS_ERR
;

736 #ifdeà
DEBUG


738 
ems_cch¬
 *
ùx
 = 
jobj
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(jobj):"no ctx";

740 
	`ems_l_Œaû
("\033[01;34m[clnt]<rsp ctx: %s> \033[00m",

741 
	`¡¾’
(
ùx
)> 0x400?"**too†ong**":ctx);

744 ià(
h
) {

745 
	`£ss_ev’t_ÿnûl
(
£ss
);

746 
	`ems_sock_şo£
(&
£ss
->
sock
);

747 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

748 
	`ems_sock_fd
(&
£ss
->
sock
),

749 
	`ems_sock_addr
(&
£ss
->
sock
),

750 
	`ems_sock_pÜt
(&
£ss
->
sock
));

752 
	`h
(
ş
, 
£ss
, 
jobj
);

753 
¹n
 = 
EMS_OK
;

756 
¹n
 = 
EMS_ERR
;

758 ià(
jobj
)

759 
	`jsÚ_objeù_put
(
jobj
);

761 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

762  
¹n
;

763 
	}
}

767 
ems_št


768 
	$ş_»cv_hªdË
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ş_evt_r¥_cb
 
h
)

770 
ems_št
 
»t
, 
agaš
;

772 
agaš
 = 
EMS_YES
;

773 
»cv_agaš
:

774 
»t
 = 
	`£ss_»cv
(
£ss
, &£ss->
buf_š
);

775 ià(
»t
 <= 0) {

776 
»t
) {

777 -
EAGAIN
:

778 
agaš
 = 
EMS_NO
;

781 ià(
	`buf_Ën
(&
£ss
->
buf_š
) > 0)

782 
»t
 = 
	`ş_´•roûss
(
ş
, 
£ss
, 
h
);

784 
şo£_out
;

789 
»t
 = 
	`ş_´•roûss
(
ş
, 
£ss
, 
h
);

791 
»t
) {

792 
EMS_BUFFER_INSUFFICIENT
:

793 
EMS_ERR
:

794 
EMS_OK
:

795 
şo£_out
;

797 
EMS_CONTINUE
:

801 } 
»t
 !ğ
EMS_CONTINUE
);

803 ià(
agaš
)

804 
»cv_agaš
;

806  
EMS_OK
;

808 
şo£_out
:

809 ià(
»t
 !ğ
EMS_OK
) {

810 
	`£ss_ev’t_ÿnûl
(
£ss
);

811 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

812 
	`ems_sock_fd
(&
£ss
->
sock
),

813 
	`ems_sock_addr
(&
£ss
->
sock
),

814 
	`ems_sock_pÜt
(&
£ss
->
sock
));

815 
	`ems_sock_şo£
(&
£ss
->
sock
);

818  
»t
;

819 
	}
}

822 
ems_št
 
	$ş_msg_g‘dc_r¥
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
roÙ
)

824 
jsÚ_objeù
 *
»suÉ
, *
r¥
, *
cfg
;

826 
»suÉ
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "result");

828 ià(!(
»suÉ
 && 
	`jsÚ_objeù_is_ty³
ÔesuÉ, 
jsÚ_ty³_objeù
))) {

829 
ş
->
Ï¡”r
 = 
ERR_CONNECT_DC_FAILED
;

830  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

833 
cfg
 = 
	`jsÚ_objeù_objeù_g‘
(
»suÉ
, "dcConfig");

834 ià(!(
cfg
 && 
	`jsÚ_objeù_is_ty³
(cfg, 
jsÚ_ty³_¡ršg
))) {

835 
ş
->
Ï¡”r
 = 
ERR_RESPONSE_ERROR
;

836  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

839 
r¥
 = 
	`ş_kv_što_jsÚ
(
	`jsÚ_objeù_g‘_¡ršg
(
cfg
));

840 ià(
r¥
) {

841 
ems_¡r
 
tmp
;

842 
	`¡r_š™
(&
tmp
);

844 
	`ems_jsÚ_g‘_¡ršg_def
(
r¥
, "nm_addr", &
tmp
, 
NULL
);

845 ià(
	`¡r_Ën
(&
tmp
) > 0)

846 
	`¡r_ıy
(&
ş
->
nm_addr
, &
tmp
);

848 
	`ems_jsÚ_g‘_¡ršg_def
(
r¥
, "nm_pÜt", &
tmp
, 
NULL
);

849 ià(
	`¡r_Ën
(&
tmp
) > 0)

850 
ş
->
nm_pÜt
 = 
	`ems_©oi
(
	`¡r_‹xt
(&
tmp
));

852 
	`¡r_unš™
(&
tmp
);

853 
	`jsÚ_objeù_put
(
r¥
);

855 
	`ems_as£¹
(
	`¡r_Ën
(&
ş
->
nm_addr
è> 0 && cl->
nm_pÜt
 > 0);

857 ià(
	`¡r_Ën
(&
ş
->
nm_addr
è<ğ0 || cl->
nm_pÜt
 <= 0) {

858 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

859  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

862 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`¡r_‹xt
(&
ş
->
nm_addr
));

863 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
ş
->
nm_pÜt
);

864 ià(
	`ş_do_cÚÃù
(
£ss
è!ğ
EMS_OK
) {

865 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

866  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

869 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

870 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_CONNECT
, 
ş_timeout_cb
);

872 
	`ems_æag_£t
(
ş
->
æg
, 
EMS_FLG_ONLINE
);

874 
ş
->
Ãxt
 = 
¡_g‘cÚfig
;

875  
	`ş_chªge_¡©us
(
ş
, 
¡_cÚÃù
);

878 
ş
->
Ï¡”r
 = 
ERR_RESPONSE_ERROR
;

879  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

880 
	}
}

883 
ems_št
 
	$ş_g‘dc
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

885 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

886 ià(
	`ş_»cv_hªdË
(
ş
, 
£ss
, 
ş_msg_g‘dc_r¥
è!ğ
EMS_OK
)

888 
ş
->
Ï¡”r
 = 
ERR_CONNECT_DC_FAILED
;

889  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

893 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

894 ià(
	`ş_£nd_msg
(
ş
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

895 
ş
->
Ï¡”r
 = 
ERR_CONNECT_DC_FAILED
;

896  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

900  
EMS_OK
;

901 
	}
}

903 
ems_št
 
	$ş_cÚf_´oûss
(
ems_ş›Á
 *
ş
, 
jsÚ_objeù
 *
roÙ
)

905 
ems_št
 
u±
, 
cÚf
, 
»Œy
, 
’abË
;

907 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "u±_³riod", 
u±
, 0);

908 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "g‘cÚf_³riod", 
cÚf
, 0);

909 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "»Œy_³riod", 
»Œy
, 0);

911 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "’abË_subdomaš", 
’abË
, 0);

912 ià(
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ş›Á_subdomaš_’abË
)è!ğ
’abË
) {

913 ià(
’abË
)

914 
	`ems_æag_£t
(
	`emscÜ”
()->
æg
, 
FLG_SUBDOMAIN_ENABLE
);

916 
	`ems_æag_un£t
(
	`emscÜ”
()->
æg
, 
FLG_SUBDOMAIN_ENABLE
);

918 
	`cfg_£t
(
	`emscfg
(), 
CFG_ş›Á_subdomaš_’abË
, 
	`ems_™ß
(
’abË
));

921 ià(
u±
 > 0) {

922 
ş
->
u±_³riod
 = 
u±
;

923 
	`cfg_£t
(
	`emscfg
(), 
CFG_ş›Á_u±_³riod
, 
	`ems_™ß
(
ş
->
u±_³riod
));

926 ià(
cÚf
 > 0) {

927 
ş
->
g‘cÚf_³riod
 = 
cÚf
;

928 
	`cfg_£t
(
	`emscfg
(), 
CFG_ş›Á_g‘cÚf_³riod
, 
	`ems_™ß
(
ş
->
g‘cÚf_³riod
));

931 ià(
»Œy
 > 0) {

932 
ş
->
»Œy_³riod
 = 
»Œy
;

933 
	`cfg_£t
(
	`emscfg
(), 
CFG_ş›Á_»Œy_³riod
, 
	`ems_™ß
(
ş
->
»Œy_³riod
));

936 
	`ems_as£¹
(
ş
->
g‘cÚf_³riod
 > 0 && cl->
u±_³riod
 > 0);

937 
ş
->
g‘cÚf
 = cl->
g‘cÚf_³riod
 / cl->
u±_³riod
;

939  
EMS_OK
;

940 
	}
}

942 
ems_void
 *
	$ş_»lßd_wifi
(
ems_th»ad¬g
 
¬g
)

944 
	`±h»ad_d‘ach
(
	`±h»ad_£lf
());

945 
	`ems_l_Œaû
("[client]„eload wirelessƒncrypt method");

946 
	`ems_sy¡emcmd
("/sbin/wifi„eload_legacy");

947  
NULL
;

948 
	}
}

950 
ems_št
 
	$ş_cÚf_´oûss_wœ–ess
(
ems_ş›Á
 *
ş
, 
jsÚ_objeù
 *
roÙ
)

952 
ems_št
 
’abË
;

953 
ems_th»adid
 
tid
;

955 
	`ems_jsÚ_g‘_št_def
(
roÙ
, "’abË_’üy±", 
’abË
, 0);

957 ià(
’abË
 !ğ
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_wœ–ess_’abË_’üy±
))) {

958 
	`cfg_£t
(
	`emscfg
(), 
CFG_wœ–ess_’abË_’üy±
, 
	`ems_™ß
(
’abË
));

960 ià(
’abË
) {

961 ià(
	`ems_th»adü—‹
(&
tid
, 
ş_»lßd_wifi
, 
NULL
))

963 
	`ems_l_Œaû
("[client]„eload wirelessƒncrypt method");

964 
	`ems_sy¡emcmd
("/sbin/wifi„eload_legacy");

967 
	`ems_l_Œaû
("reset wirelessƒncrypt method");

968 
	`ems_£twifi_nİasswÜd
();

972  
EMS_OK
;

973 
	}
}

975 
ems_št
 
	$ş_´oûss_ruËs
(
ems_ş›Á
 *
ş
, 
jsÚ_objeù
 *
roÙ
)

977 
jsÚ_objeù
 *
obj
;

979 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "portal");

980 ià(
obj
)

981 
	`ems_­p_´oûss
(
ty_ş›Á
, 
ty_pÜl
, 
EMS_APP_SERVER_RULES_UPDATE
, 
obj
);

983 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "radius");

984 ià(
obj
)

985 
	`ems_­p_´oûss
(
ty_ş›Á
, 
ty_¿dius
, 
EMS_APP_SERVER_RULES_UPDATE
, 
obj
);

987 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "bwlist");

988 ià(
obj
)

989 
	`ems_­p_´oûss
(
ty_ş›Á
, 
ty_bwli¡
, 
EMS_APP_SERVER_RULES_UPDATE
, 
obj
);

991 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "client");

992 ià(
obj
)

993 
	`ş_cÚf_´oûss
(
ş
, 
obj
);

995 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "wireless");

996 ià(
obj
)

997 
	`ş_cÚf_´oûss_wœ–ess
(
ş
, 
obj
);

999 
	`cfg_wr™e
(
	`emscfg
());

1001  
EMS_OK
;

1002 
	}
}

1005 
ems_št
 
	$ş_g‘cÚfig_r¥
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
roÙ
)

1007 
št64_t
 
cÚf_n
;

1008 
jsÚ_objeù
 *
»suÉ
, *
cfg
, *
r¥
, *
¬y
;

1010 
»suÉ
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "result");

1011 ià(!(
»suÉ
 && 
	`jsÚ_objeù_is_ty³
ÔesuÉ, 
jsÚ_ty³_objeù
))) {

1012 
ş
->
Ï¡”r
 = 
ERR_DOWNLOAD_CONFIG_FAILED
;

1013 
Ãxt_¡
;

1016 
¬y
 = 
	`jsÚ_objeù_objeù_g‘
(
»suÉ
, "config");

1017 ià(!(
¬y
 && 
	`jsÚ_objeù_is_ty³
×ry, 
jsÚ_ty³_¬¿y
))) {

1018 
ş
->
Ï¡”r
 = 
ERR_DOWNLOAD_CONFIG_FAILED
;

1019 
Ãxt_¡
;

1022 ià(
	`jsÚ_objeù_¬¿y_Ëngth
(
¬y
) <= 0) {

1023 
	`ems_l_Œaû
("cÚfig‚uÎ: , cu¼’ˆcÚfig‚umb”: %ld", 
ş
->
n_cÚf
);

1024 
Ãxt_¡
;

1027 
»suÉ
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
¬y
, 0);

1028 ià(!(
»suÉ
 && 
	`jsÚ_objeù_is_ty³
ÔesuÉ, 
jsÚ_ty³_objeù
))) {

1029 
ş
->
Ï¡”r
 = 
ERR_DOWNLOAD_CONFIG_FAILED
;

1030 
Ãxt_¡
;

1033 
	`ems_jsÚ_g‘_št64_def
(
»suÉ
, "cÚfigNumb”", 
cÚf_n
, -1);

1034 ià(
cÚf_n
 =ğ
ş
->
n_cÚf
) {

1035 
	`ems_l_Œaû
("cÚfig‚Ù chªge: %ld", 
cÚf_n
);

1036 
Ãxt_¡
;

1039 
ş
->
n_cÚf
 = 
cÚf_n
;

1041 
cfg
 = 
	`jsÚ_objeù_objeù_g‘
(
»suÉ
, "config");

1042 ià(!(
cfg
 && 
	`jsÚ_objeù_is_ty³
(cfg, 
jsÚ_ty³_¡ršg
))) {

1043 
ş
->
Ï¡”r
 = 
ERR_DOWNLOAD_CONFIG_FAILED
;

1044 
Ãxt_¡
;

1047 
r¥
 = 
	`ş_kv_što_jsÚ
(
	`jsÚ_objeù_g‘_¡ršg
(
cfg
));

1048 ià(
r¥
) {

1049 
cfg
 = 
	`g½_®l_cfgs
(
r¥
);

1050 
	`jsÚ_objeù_put
(
r¥
);

1052 
	`ş_´oûss_ruËs
(
ş
, 
cfg
);

1053 
	`jsÚ_objeù_put
(
cfg
);

1055 
	`ems_as£¹
(0 && "never show uphis†ine, if server's„eady");

1056 
ş
->
Ï¡”r
 = 
ERR_RESPONSE_ERROR
;

1057 
Ãxt_¡
;

1060 
Ãxt_¡
:

1061 ià(
	`ş_do_cÚÃù
(
£ss
è!ğ
EMS_OK
) {

1062 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1063  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1066 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

1067 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_CONNECT
, 
ş_timeout_cb
);

1069 
ş
->
Ãxt
 = 
¡_g‘upd©efe
;

1070  
	`ş_chªge_¡©us
(
ş
, 
¡_cÚÃù
);

1071 
	}
}

1073 
ems_št
 
	$ş_g‘cÚfig
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1075 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

1076 ià(
	`ş_»cv_hªdË
(
ş
, 
£ss
, 
ş_g‘cÚfig_r¥
è!ğ
EMS_OK
)

1078 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1080 
	`ems_l_Œaû
("recv failed, maybe‡ bug,ryo update self");

1082 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

1084 ià(
	`ş_do_cÚÃù
(
£ss
è!ğ
EMS_OK
)

1085  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1087 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

1088 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_CONNECT
, 
ş_timeout_cb
);

1090 
ş
->
Ãxt
 = 
¡_g‘upd©efe
;

1091  
	`ş_chªge_¡©us
(
ş
, 
¡_cÚÃù
);

1095 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

1096 ià(
	`ş_£nd_msg
(
ş
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

1097 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1098  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1102  
EMS_OK
;

1103 
	}
}

1106 
ems_št


1107 
	$ş_fe_Ãed_upd©e
(
ems_cch¬
 *
Çme
,ƒms_cch¬ *
ty
,ƒms_cch¬ *
v”
,ƒms_cch¬ *
u¾
)

1109 
ems_cch¬
 *
v®
 = 
NULL
;

1110 ià(!
	`¡rcmp
(
ty
, "client")) {

1111 ià(
	`¡rcmp
(
v”
, 
	`ems_pİ’_g‘
("cat /tmp/ems/conf/ver")))

1112  
EMS_YES
;

1114 } ià(!
	`¡rcmp
(
ty
, "rom")) {

1115 
v®
 = 
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_sy¡em_v”siÚ
);

1116 
	`ems_l_Œaû
("upd©rom: (% %s)", 
ty
, 
v®
);

1117 ià(
	`¡rcmp
(
v”
, 
v®
))

1118  
EMS_YES
;

1119 } ià(!
	`¡rcmp
(
ty
, "app")) {

1121 
	`ems_l_Œaû
("app update,‚ot support for‚ow");

1122  
EMS_NO
;

1125 
	`ems_l_Œaû
("unknownype");

1126  
EMS_NO
;

1127 
	}
}

1129 
	~<sys/ty³s.h
>

1130 
	~<sys/¡©.h
>

1132 
ems_void


1133 
	$ş_š¡®Ër
(
ems_cch¬
 *
cmd
,ƒms_cch¬ *
Çme
,ƒms_cch¬ *
ty
,ƒms_cch¬ *
v”
,ƒms_cch¬ *
u¾
)

1135 #iâdeà
DEBUG


1136 
ems_št
 
fd
;

1138 
ems_ch¬
 *
¬gv
[10];

1140 
	`£tsid
();

1141 
	`umask
(0);

1143 #iâdeà
DEBUG


1144 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
);

1145 ià(
fd
 > 0) {

1146 
	`dup2
(
fd
, 
STDIN_FILENO
);

1147 
	`dup2
(
fd
, 
STDOUT_FILENO
);

1148 
	`şo£
(
fd
);

1152 
¬gv
[0] = (
ems_ch¬
 *)
cmd
;

1153 
¬gv
[1] = (
ems_ch¬
 *)
Çme
;

1154 
¬gv
[2] = (
ems_ch¬
 *)
ty
;

1155 
¬gv
[3] = (
ems_ch¬
 *)
v”
;

1156 
¬gv
[4] = (
ems_ch¬
 *)
u¾
;

1157 
¬gv
[5] = 
NULL
;

1159 ià(
	`execv
(
cmd
, 
¬gv
) == -1)

1160 
	`ems_l_Œaû
("exeøcmd: % çed: %s", 
cmd
, 
	`ems_Ï¡”rmsg
());

1162 
	`ex™
(0);

1163 
	}
}

1165 
ems_št


1166 
	$ş_fe_do_upd©e_Úe
(
ems_ş›Á
 *
ş
, 
ems_cch¬
 *
Çme
,ƒms_cch¬ *
ty
,ƒms_cch¬ *
v”
,ƒms_cch¬ *
u¾
)

1168 
ems_´oûssid
 
pid
;

1169 
¡©
 
¡
;

1170 
ems_cch¬
 *
£tup
 = "/tmp/ems/bin/app_setup.sh";

1172 ià(
	`¡©
(
£tup
, &
¡
)) {

1173 
ş
->
Ï¡”r
 = 
ERR_SETUPFILE_MISSING
;

1174 
	`ems_l_Œaû
("w¬nšg s‘u°fmissšg: %s", 
£tup
);

1175  
EMS_ERR
;

1178 ià(!(
¡
.
¡_mode
 & 
S_IXUSR
))

1179 
	`chmod
(
£tup
, 
¡
.
¡_mode
 | 
S_IXUSR
);

1181 
pid
 = 
	`fÜk
();

1183 
pid
) {

1186 
	`ems_l_Œaû
("fÜk(èçed: %s", 
	`ems_Ï¡”rmsg
());

1187  
EMS_ERR
;

1190 
	`ş_š¡®Ër
(
£tup
, 
Çme
, 
ty
, 
v”
, 
u¾
);

1194 
ş
->
pid
 =…id;

1196  
EMS_OK
;

1197 
	}
}

1199 
ems_št
 
	$ş_check_ªd_upd©e
(
ems_ş›Á
 *
ş
, 
jsÚ_objeù
 *
¬y
)

1201 
jsÚ_objeù
 *
obj
;

1202 
jsÚ_objeù
 *
ty
, *
Çme
, *
v”
, *
u¾
;

1203 
ems_št
 
i
;

1204 
ems_cch¬
 *
f_ty
, *
f_Çme
, *
f_v”
,*
f_u¾
;

1206 
	`ems_as£¹
(
¬y
 && 
	`jsÚ_objeù_is_ty³
×ry, 
jsÚ_ty³_¬¿y
));

1208 
i
 = 0; i < 
	`jsÚ_objeù_¬¿y_Ëngth
(
¬y
); i++) {

1209 
obj
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
¬y
, 
i
);

1211 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_objeù
))

1213 
	`ems_l_Œaû
("fe: %s", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
obj
));

1215 
ty
 = 
	`jsÚ_objeù_objeù_g‘
(
obj
, "fileType");

1216 
Çme
 = 
	`jsÚ_objeù_objeù_g‘
(
obj
, "fileName");

1217 
v”
 = 
	`jsÚ_objeù_objeù_g‘
(
obj
, "fileVer");

1218 
u¾
 = 
	`jsÚ_objeù_objeù_g‘
(
obj
, "fileUrl");

1220 ià(!(
ty
 && 
Çme
 && 
v”
 && 
u¾
))

1223 ià(! (
	`jsÚ_objeù_is_ty³
(
ty
, 
jsÚ_ty³_¡ršg
) &&

1224 
	`jsÚ_objeù_is_ty³
(
Çme
, 
jsÚ_ty³_¡ršg
) &&

1225 
	`jsÚ_objeù_is_ty³
(
v”
, 
jsÚ_ty³_¡ršg
) &&

1226 
	`jsÚ_objeù_is_ty³
(
u¾
, 
jsÚ_ty³_¡ršg
))) {

1230 
f_ty
 = 
	`jsÚ_objeù_g‘_¡ršg
(
ty
);

1231 
f_Çme
 = 
	`jsÚ_objeù_g‘_¡ršg
(
Çme
);

1232 
f_v”
 = 
	`jsÚ_objeù_g‘_¡ršg
(
v”
);

1233 
f_u¾
 = 
	`jsÚ_objeù_g‘_¡ršg
(
u¾
);

1235 ià(
	`ş_fe_Ãed_upd©e
(
f_Çme
, 
f_ty
, 
f_v”
, 
f_u¾
)) {

1239 
	`ş_fe_do_upd©e_Úe
(
ş
, 
f_Çme
, 
f_ty
, 
f_v”
, 
f_u¾
);

1241 ià(
	`¡rcmp
(
f_ty
, "app"))

1242  
EMS_OK
;

1247  
EMS_OK
;

1248 
	}
}

1250 
ems_št
 
	$ş_g‘upd©efe_r¥
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
roÙ
)

1252 
jsÚ_objeù
 *
»suÉ
, *
obj
, *
¬y
;

1253 
ems_lÚg
 
u±_n
;

1255 
»suÉ
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "result");

1256 ià(!(
»suÉ
 && 
	`jsÚ_objeù_is_ty³
ÔesuÉ, 
jsÚ_ty³_objeù
)))

1257 
Ãxt_¡
;

1259 
¬y
 = 
	`jsÚ_objeù_objeù_g‘
(
»suÉ
, "updateFile");

1260 ià(!(
¬y
 && 
	`jsÚ_objeù_is_ty³
×ry, 
jsÚ_ty³_¬¿y
))) {

1261 
	`ems_l_Œaû
("updateFile missing.");

1262 
Ãxt_¡
;

1265 ià(
	`jsÚ_objeù_¬¿y_Ëngth
(
¬y
) <= 0) {

1266 
	`ems_l_Œaû
("update‡rray†ength‚ull.");

1267 
Ãxt_¡
;

1270 
»suÉ
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
¬y
, 0);

1271 ià(!(
»suÉ
 && 
	`jsÚ_objeù_is_ty³
ÔesuÉ, 
jsÚ_ty³_objeù
))) {

1272 
	`ems_l_Œaû
("index‡rray missing.");

1273 
Ãxt_¡
;

1276 
	`ems_jsÚ_g‘_št64_def
(
»suÉ
, "upd©eFeNumb”", 
u±_n
, -1);

1277 ià(
u±_n
 =ğ
ş
->
n_u±
) {

1278 
	`ems_l_Œaû
("upd©fnumb”‚Ù chªge: %ld", 
u±_n
);

1279 
ems_št
 
¡
;

1280 ià(
ş
->
pid
 > 0) {

1281 
	`wa™pid
(
ş
->
pid
, &
¡
, 
WNOHANG
)) {

1283 
	`ems_l_Œaû
("­°š¡®Èfšished,‡nd sucûss,…id:%ld", 
ş
->
pid
);

1284 
ş
->
pid
 = 0;

1288 ià(
	`WIFEXITED
(
¡
)) {

1289 
	`ems_l_Œaû
("install failed…rocess: %ldƒxited, status=%d,„eset updateFileNumber",

1290 
ş
->
pid
, 
	`WEXITSTATUS
(
¡
));

1291 } ià(
	`WIFSIGNALED
(
¡
)) {

1292 
	`ems_l_Œaû
("install failed…rocess: %ld killed by signal=%d„eset updateFileNumber",

1293 
ş
->
pid
, 
	`WTERMSIG
(
¡
));

1296 
ş
->
Ï¡”r
 = 
ERR_INSTALL_FAILED
;

1297 
ş
->
n_u±
 = -1;

1299 ià(
	`WIFEXITED
(
¡
è|| 
	`WIFSIGNALED
(st))

1300 
ş
->
pid
 = 0;

1306 
Ãxt_¡
;

1309 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»suÉ
, "files");

1310 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¬¿y
))) {

1311 
	`ems_l_Œaû
("files missing");

1312 
Ãxt_¡
;

1315 #ifdeà
DENY_UPDATE


1316 
ş
->
n_u±
 = 
u±_n
;

1318 ià(
	`ş_check_ªd_upd©e
(
ş
, 
obj
è=ğ
EMS_OK
)

1319 
ş
->
n_u±
 = 
u±_n
;

1322 
Ãxt_¡
:

1323  
	`ş_chªge_¡©us
(
ş
, 
¡_nÜm®
);

1325 
”r_¡
:

1326 
ş
->
Ï¡”r
 = 
ERR_RESPONSE_ERROR
;

1327  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1329 
	}
}

1331 
ems_št
 
	$ş_g‘upd©efe
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1333 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

1334 ià(
	`ş_»cv_hªdË
(
ş
, 
£ss
, 
ş_g‘upd©efe_r¥
è!ğ
EMS_OK
)

1336 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1337  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1341 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

1342 ià(
	`ş_£nd_msg
(
ş
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

1343 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1344  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1348  
EMS_OK
;

1349 
	}
}

1351 
ems_št
 
	$ş_dowÆßd
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1353  
EMS_OK
;

1354 
	}
}

1356 
ems_št
 
	$ş_­¶y
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1358  
EMS_OK
;

1359 
	}
}

1361 
ems_št
 
	$ş_upd©e¡©us
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1363 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

1364 ià(
	`ş_£nd_msg
(
ş
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

1365 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1366  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1369 ià(
	`buf_Ën
(&
£ss
->
buf
) <= 0) {

1370 
	`£ss_ev’t_ÿnûl
(
£ss
);

1371 
	`ems_sock_şo£
(&
£ss
->
sock
);

1372 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

1373 
	`ems_sock_fd
(&
£ss
->
sock
),

1374 
	`ems_sock_addr
(&
£ss
->
sock
),

1375 
	`ems_sock_pÜt
(&
£ss
->
sock
));

1376 
ş
->
g‘cÚf
--;

1377 ià(
ş
->
g‘cÚf
 <= 0) {

1378 
	`ems_as£¹
(
ş
->
g‘cÚf_³riod
 > 0 && cl->
u±_³riod
 > 0);

1379 
ş
->
g‘cÚf
 = cl->
g‘cÚf_³riod
 / cl->
u±_³riod
;

1381 ià(
	`ş_do_cÚÃù
(
£ss
è!ğ
EMS_OK
) {

1382 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1383  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1386 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

1387 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_CONNECT
, 
ş_timeout_cb
);

1389 
ş
->
Ãxt
 = 
¡_g‘cÚfig
;

1390  
	`ş_chªge_¡©us
(
ş
, 
¡_cÚÃù
);

1393  
	`ş_chªge_¡©us
(
ş
, 
¡_nÜm®
);

1397  
EMS_OK
;

1398 
	}
}

1400 
ems_št
 
	$ş_cÚÃù
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1402 
ems_št
 
”r
;

1403 
sockËn_t
 
Ën
;

1405 
Ën
 = (
”r
);

1406 
”r
 = 0;

1407 
	`g‘sockİt
(
	`ems_sock_fd
(&
£ss
->
sock
), 
SOL_SOCKET
, 
SO_ERROR
, (
ems_ch¬
 *)&
”r
, &
Ën
);

1409 ià(
”r
 ) {

1410 
”ºo
 = 
”r
;

1411 
	`ems_l_Œaû
("[clnt]sess(%d) connecto %s:%d failed, %s",

1412 
	`ems_sock_fd
(&
£ss
->
sock
),

1413 
	`ems_sock_addr
(&
£ss
->
sock
),

1414 
	`ems_sock_pÜt
(&
£ss
->
sock
),

1415 
	`ems_g‘”rmsg
(
”r
));

1417 
ş
->
Ï¡”r
 = 
ERR_CONNECT_DC_FAILED
;

1418 ià(
ş
->
Ãxt
 !ğ
¡_g‘dc
)

1419 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1421  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1424 
	`ems_l_Œaû
("[clnt]sess(%d)ƒstablished with %s:%d",

1425 
	`ems_sock_fd
(&
£ss
->
sock
),

1426 
	`ems_sock_addr
(&
£ss
->
sock
),

1427 
	`ems_sock_pÜt
(&
£ss
->
sock
));

1429 
	`ems_æag_£t
(
£ss
->
æg
, 
EMS_FLG_ONLINE
);

1431 
	`£ss_ev’t_ÿnûl
(
£ss
);

1432  
	`ş_chªge_¡©us
(
ş
, cl->
Ãxt
);

1433 
	}
}

1437 
ems_št
 
	$ş_to_”r
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

1439 
	`ems_l_Œaû
("[clnt]ƒrrorimeout, do„estart");

1441 
ş
->
Ãxt
 = 
¡_¡İ³d
;

1443 ià(
	`ems_æag_uÆike
(
ş
->
æg
, 
EMS_FLG_ONLINE
))

1444  
	`ş_chªge_¡©us
(
ş
, 
¡_¡¬t
);

1446 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`¡r_‹xt
(&
ş
->
nm_addr
));

1447 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
ş
->
nm_pÜt
);

1448 ià(
	`ş_do_cÚÃù
(
£ss
è!ğ
EMS_OK
) {

1449 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1450  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1453 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

1454 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_CONNECT
, 
ş_timeout_cb
);

1456 
ş
->
Ãxt
 = 
¡_g‘cÚfig
;

1457  
	`ş_chªge_¡©us
(
ş
, 
¡_cÚÃù
);

1458 
	}
}

1460 
ems_št
 
	$ş_to_nÜm®
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

1462 
	`ems_l_Œaû
("[clnt] client„estart");

1464 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`¡r_‹xt
(&
ş
->
nm_addr
));

1465 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
ş
->
nm_pÜt
);

1466 ià(
	`ş_do_cÚÃù
(
£ss
è!ğ
EMS_OK
) {

1467 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1468  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1471 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

1472 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_CONNECT
, 
ş_timeout_cb
);

1474 
ş
->
Ãxt
 = 
¡_upd©e¡©us
;

1475  
	`ş_chªge_¡©us
(
ş
, 
¡_cÚÃù
);

1476 
	}
}

1478 
ems_št
 
	$ş_to_g‘dc
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

1480 
	`£ss_ev’t_ÿnûl
(
£ss
);

1481 
	`ems_sock_şo£
(&
£ss
->
sock
);

1482 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

1483 
	`ems_sock_fd
(&
£ss
->
sock
),

1484 
	`ems_sock_addr
(&
£ss
->
sock
),

1485 
	`ems_sock_pÜt
(&
£ss
->
sock
));

1487 
ş
->
Ï¡”r
 = 
ERR_CONNECT_DC_FAILED
;

1488  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1489 
	}
}

1491 
ems_št
 
	$ş_to_g‘cÚfig
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

1493 
	`£ss_ev’t_ÿnûl
(
£ss
);

1494 
	`ems_sock_şo£
(&
£ss
->
sock
);

1495 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

1496 
	`ems_sock_fd
(&
£ss
->
sock
),

1497 
	`ems_sock_addr
(&
£ss
->
sock
),

1498 
	`ems_sock_pÜt
(&
£ss
->
sock
));

1500 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1501  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1502 
	}
}

1504 
ems_št
 
	$ş_to_g‘upd©efe
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

1506 
	`£ss_ev’t_ÿnûl
(
£ss
);

1507 
	`ems_sock_şo£
(&
£ss
->
sock
);

1508 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

1509 
	`ems_sock_fd
(&
£ss
->
sock
),

1510 
	`ems_sock_addr
(&
£ss
->
sock
),

1511 
	`ems_sock_pÜt
(&
£ss
->
sock
));

1513 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1514  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1515 
	}
}

1517 
ems_št
 
	$ş_to_dowÆßd
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

1519 
	`ems_as£¹
(0 && "never be here");

1520  
EMS_OK
;

1521 
	}
}

1523 
ems_št
 
	$ş_to_upd©e¡©us
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

1525 
	`£ss_ev’t_ÿnûl
(
£ss
);

1526 
	`ems_sock_şo£
(&
£ss
->
sock
);

1527 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

1528 
	`ems_sock_fd
(&
£ss
->
sock
),

1529 
	`ems_sock_addr
(&
£ss
->
sock
),

1530 
	`ems_sock_pÜt
(&
£ss
->
sock
));

1532 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1533  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1534 
	}
}

1536 
ems_št
 
	$ş_to_cÚÃù
(
ems_ş›Á
 *
ş
, 
ems_£ssiÚ
 *
£ss
)

1538 
	`£ss_ev’t_ÿnûl
(
£ss
);

1539 
	`ems_sock_şo£
(&
£ss
->
sock
);

1540 
	`ems_l_Œaû
("[clnt]shutdown session(%d) with [%s: %d]",

1541 
	`ems_sock_fd
(&
£ss
->
sock
),

1542 
	`ems_sock_addr
(&
£ss
->
sock
),

1543 
	`ems_sock_pÜt
(&
£ss
->
sock
));

1545 
ş
->
Ï¡”r
 = 
ERR_CONNECT_DC_FAILED
;

1546 ià(
ş
->
Ãxt
 !ğ
¡_g‘dc
)

1547 
ş
->
Ï¡”r
 = 
ERR_CONNECT_NM_FAILED
;

1549  
	`ş_chªge_¡©us
(
ş
, 
¡_”r
);

1550 
	}
}

1552 
ems_št


1553 
	$ş_fl_»que¡
(
ems_£ssiÚ
 *
£ss
, 
ems_cch¬
 *
·th
,ƒms_cch¬ *
m‘hod
, 
jsÚ_objeù
 *
·¿m
, 
ems_ušt
 
id
)

1555 
ems_št
 
Ën
;

1556 
jsÚ_objeù
 *
»q
;

1557 
ems_cch¬
 *
ùx
;

1559 
	`ems_as£¹
(
£ss
 && 
·th
 && 
m‘hod
 && "never show uphis†ine");

1561 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

1563 
	`jsÚ_objeù_objeù_add
(
»q
, "jsÚ½c", 
	`jsÚ_objeù_Ãw_¡ršg
("2.0"));

1564 
	`jsÚ_objeù_objeù_add
(
»q
, "m‘hod", 
	`jsÚ_objeù_Ãw_¡ršg
(
m‘hod
));

1566 ià(!
·¿m
) {

1567 
·¿m
 = 
	`jsÚ_objeù_Ãw_objeù
();

1569 
	`jsÚ_objeù_objeù_add
(
·¿m
, "¢", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_¢
()));

1570 
	`jsÚ_objeù_objeù_add
(
·¿m
, "devTy³", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_deviûty³
()));

1571 
	`jsÚ_objeù_objeù_add
(
·¿m
, "soáV”", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_sy¡em_v”siÚ
)));

1574 
	`ems_as£¹
(
	`jsÚ_objeù_is_ty³
(
·¿m
, 
jsÚ_ty³_objeù
));

1576 
	`jsÚ_objeù_objeù_add
(
»q
, "·¿ms", 
·¿m
);

1577 
	`jsÚ_objeù_objeù_add
(
»q
, "id", 
	`jsÚ_objeù_Ãw_št
(
id
));

1579 
ùx
 = 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
»q
);

1580 ià(!
ùx
)

1581 
ùx
 = "";

1583 
	`ems_l_Œaû
("»que¡: %s", 
ùx
);

1585 
Ën
 = 
	`¢´štf
(
	`buf_wr
(&
£ss
->
buf
), 
	`buf_Ëá
(&sess->buf),

1594 
·th
, 
	`cÜe_¢
(), 
	`ems_sock_addr
(&
£ss
->
sock
), (
ems_št
)
	`¡¾’
(
ùx
), ctx);

1596 
	`jsÚ_objeù_put
(
»q
);

1597 
	`ems_bufãr_£ek_wr
(&
£ss
->
buf
, 
Ën
, 
EMS_BUFFER_SEEK_CUR
);

1599  
EMS_OK
;

1600 
	}
}

1603 
ems_št
 
	$ş_¡©us_g‘dc
(
ems_ş›Á
 *
ş
)

1605 
ems_£ssiÚ
 *
£ss
 = 
ş
->sess;

1607 
	`ems_as£¹
(
ş
 && 
£ss
 && "never show uphis†ine");

1609 
	`ş_fl_»que¡
(
£ss
, "šm_Çs_dc_v1", "g‘DC", 
NULL
, 1);

1611 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

1612 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_SEND
, 
ş_timeout_cb
);

1614  
EMS_OK
;

1615 
	}
}

1617 
ems_št
 
	$ş_¡©us_g‘cÚfig
(
ems_ş›Á
 *
ş
)

1619 
jsÚ_objeù
 *
·¿m
;

1620 
jsÚ_objeù
 *
¬y
, *
obj
;

1621 
ems_£ssiÚ
 *
£ss
 = 
ş
->sess;

1623 
	`ems_as£¹
(
ş
 && 
£ss
 && "never show uphis†ine");

1625 
·¿m
 = 
	`jsÚ_objeù_Ãw_objeù
();

1627 
·¿m
 = 
	`jsÚ_objeù_Ãw_objeù
();

1628 
¬y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

1629 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

1631 
	`jsÚ_objeù_objeù_add
(
obj
, "cÚfigNumb”", 
	`jsÚ_objeù_Ãw_št64
(
ş
->
n_cÚf
));

1632 
	`jsÚ_objeù_objeù_add
(
obj
, "¢", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_¢
()));

1633 
	`jsÚ_objeù_objeù_add
(
obj
, "devTy³", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_deviûty³
()));

1634 
	`jsÚ_objeù_objeù_add
(
obj
, "soáV”", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_sy¡em_v”siÚ
)));

1636 
	`jsÚ_objeù_¬¿y_add
(
¬y
, 
obj
);

1637 
	`jsÚ_objeù_objeù_add
(
·¿m
, "ÇsInfos", 
¬y
);

1639 
	`ş_fl_»que¡
(
£ss
, "šm_Çs_v1", "g‘CÚf", 
·¿m
, 3);

1641 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

1642 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_SEND
, 
ş_timeout_cb
);

1644  
EMS_OK
;

1645 
	}
}

1647 
ems_št
 
	$ş_¡©us_nÜm®
(
ems_ş›Á
 *
ş
)

1649 
ems_£ssiÚ
 *
£ss
 = 
ş
->sess;

1651 
	`ems_as£¹
(
ş
 && 
£ss
 && "never show uphis†ine");

1653 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
ş
->
u±_³riod
 * 1000, 
ş_timeout_cb
);

1655  
EMS_OK
;

1656 
	}
}

1658 
ems_št
 
	$ş_¡©us_g‘upd©efe
(
ems_ş›Á
 *
ş
)

1660 
jsÚ_objeù
 *
·¿m
;

1661 
jsÚ_objeù
 *
¬y
, *
obj
;

1662 
ems_£ssiÚ
 *
£ss
 = 
ş
->sess;

1664 
	`ems_as£¹
(
ş
 && 
£ss
 && "never show uphis†ine");

1666 
·¿m
 = 
	`jsÚ_objeù_Ãw_objeù
();

1667 
¬y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

1668 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

1670 
	`jsÚ_objeù_objeù_add
(
obj
, "upd©eFeNumb”", 
	`jsÚ_objeù_Ãw_št64
(
ş
->
n_u±
));

1671 
	`jsÚ_objeù_objeù_add
(
obj
, "¢", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_¢
()));

1672 
	`jsÚ_objeù_objeù_add
(
obj
, "devTy³", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_deviûty³
()));

1673 
	`jsÚ_objeù_objeù_add
(
obj
, "soáV”", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_sy¡em_v”siÚ
)));

1675 
	`jsÚ_objeù_¬¿y_add
(
¬y
, 
obj
);

1676 
	`jsÚ_objeù_objeù_add
(
·¿m
, "ÇsInfos", 
¬y
);

1678 
	`ş_fl_»que¡
(
£ss
, "šm_Çs_v1", "g‘Upd©eFe", 
·¿m
, 4);

1680 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

1681 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_SEND
, 
ş_timeout_cb
);

1683  
EMS_OK
;

1684 
	}
}

1686 
ems_št
 
	$ems_g‘_iâame_throughput
(
ems_cch¬
 *
iâame
, 
off_t
 *
š
, off_ˆ*
out
)

1688 
ems_ch¬
 
buf
[256] = {0};

1689 
ems_ch¬
 
cmd
[256] = {0};

1692 
	`¢´štf
(
cmd
, (cmd),

1693 "ÿˆ/´oc/Ãt/dev | g»°% |‡wk '{´štf(\"%% %%s\", $2, $10)}'", 
iâame
);

1695 
	`mem£t
(
buf
, 0, (buf));

1696 
	`¢´štf
(
buf
, (buf), "%s", 
	`ems_pİ’_g‘
(
cmd
));

1698 ià(
	`¡¾’
(
buf
) > 0) {

1699 #iâdeà
GENERIC_LINUX


1700 
	`ssÿnf
(
buf
, "%Îd %Îd", 
š
, 
out
);

1702 
	`ssÿnf
(
buf
, "%ld %ld", 
š
, 
out
);

1705  
EMS_OK
;

1708  
EMS_ERR
;

1709 
	}
}

1711 
ems_št
 
	$ems_disku§ge
()

1713  
	`ems_©oi
(
	`ems_pİ’_g‘
("df | grep„ootfs |‡wk '{print $5}' | cut -d% -f1"));

1714 
	}
}

1716 
ems_št
 
	$ş_¡©us_upd©e¡©us
(
ems_ş›Á
 *
ş
)

1718 
jsÚ_objeù
 *
·¿m
, *
obj
, *
¬y
;

1719 
ems_£ssiÚ
 *
£ss
 = 
ş
->sess;

1720 
off_t
 
š
, 
out
;

1721 
ems_št
 
¡
, 
¡_pÜl
, 
¡_¿dius
, 
Çp
;

1723 
	`ems_as£¹
(
ş
 && 
£ss
 && "never show uphis†ine");

1725 
š
 = 
out
 = 0;

1726 
	`ems_g‘_iâame_throughput
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_wª_iâame
), &
š
, &
out
);

1728 
·¿m
 = 
	`jsÚ_objeù_Ãw_objeù
();

1729 
¬y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

1730 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

1732 
	`jsÚ_objeù_objeù_add
(
obj
, "¢", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_¢
()));

1733 
	`jsÚ_objeù_objeù_add
(
obj
, "devTy³", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_deviûty³
()));

1734 
	`jsÚ_objeù_objeù_add
(
obj
, "soáV”", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_sy¡em_v”siÚ
)));

1736 
	`jsÚ_objeù_objeù_add
(
obj
, "upd©eFeNumb”", 
	`jsÚ_objeù_Ãw_št64
(
ş
->
n_u±
));

1737 
	`jsÚ_objeù_objeù_add
(
obj
, "cÚfigNumb”", 
	`jsÚ_objeù_Ãw_št64
(
ş
->
n_cÚf
));

1739 
	`jsÚ_objeù_objeù_add
(
obj
, "ıu", 
	`jsÚ_objeù_Ãw_št
(
	`ems_ıuu§ge
()));

1740 
	`jsÚ_objeù_objeù_add
(
obj
, "mem", 
	`jsÚ_objeù_Ãw_št
(
	`ems_memu§ge
()));

1741 
	`jsÚ_objeù_objeù_add
(
obj
, "disk", 
	`jsÚ_objeù_Ãw_št
(
	`ems_disku§ge
()));

1743 
	`jsÚ_objeù_objeù_add
(
obj
, "šOù‘s", 
	`jsÚ_objeù_Ãw_št64
(
š
));

1744 
	`jsÚ_objeù_objeù_add
(
obj
, "outOù‘s", 
	`jsÚ_objeù_Ãw_št64
(
out
));

1745 
	`jsÚ_objeù_objeù_add
(
obj
, "u£rCouÁ", 
	`jsÚ_objeù_Ãw_št
(
	`ems_­p_¿dius_u£r_numb”
()));

1747 
¡_pÜl
 = 
	`ems_­p_´oûss
(
ty_ş›Á
, 
ty_pÜl
, 
EMS_APP_EVT_STATUS
, 
NULL
);

1748 
¡_¿dius
 = 
	`ems_­p_´oûss
(
ty_ş›Á
, 
ty_¿dius
, 
EMS_APP_EVT_STATUS
, 
NULL
);

1749 
¡
 = 
¡_pÜl
 | 
¡_¿dius
;

1751 
	`jsÚ_objeù_objeù_add
(
obj
, "¡©us", 
	`jsÚ_objeù_Ãw_št
(
¡
?1:0));

1752 
	`jsÚ_objeù_objeù_add
(
obj
, "pÜlStus", 
	`jsÚ_objeù_Ãw_št
(
¡_pÜl
 ? 1:0));

1753 
	`jsÚ_objeù_objeù_add
(
obj
, "¿diusStus", 
	`jsÚ_objeù_Ãw_št
(
¡_¿dius
 ? 1:0));

1754 
	`jsÚ_objeù_objeù_add
(
obj
, "¡©usDes", 
	`jsÚ_objeù_Ãw_¡ršg
(""));

1756 
Çp
 = 
	`ems_­p_´oûss
(
ty_ş›Á
, 
ty_dowÆšk
, 
EMS_EVT_DOWNLINK_NUM
, 
NULL
);

1757 
	`jsÚ_objeù_objeù_add
(
obj
, "­Num", 
	`jsÚ_objeù_Ãw_št
(
Çp
));

1759 
	`jsÚ_objeù_¬¿y_add
(
¬y
, 
obj
);

1760 
	`jsÚ_objeù_objeù_add
(
·¿m
, "¡©us", 
¬y
);

1762 
	`ş_fl_»que¡
(
£ss
, "šm_Çs_v1", "upd©eStus", 
·¿m
, 5);

1764 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
ş_evt_cb
);

1765 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_TIMEOUT_SEND
, 
ş_timeout_cb
);

1767  
EMS_OK
;

1768 
	}
}

1770 
ems_št
 
	$ş_chªge_¡©us
(
ems_ş›Á
 *
ş
, 
ems_¡©us
 
¡
)

1772 
	`ems_l_Œaû
("[clnt] change status: %s ---> %s",

1773 
	`ems_¡©us_¡r
(
ş
->
¡
),ƒms_status_str(st));

1775 
ş
->
¡
 = st;

1777 
ş
->
¡
) {

1778 
¡_š™
:

1779 
¡_¡İ³d
:

1780 
¡_”r
:

1781  
	`ş_evt_run
(
ş
, 
NULL
, 0);

1784 
¡_g‘dc
:

1785  
	`ş_¡©us_g‘dc
(
ş
);

1787 
¡_g‘cÚfig
:

1788  
	`ş_¡©us_g‘cÚfig
(
ş
);

1790 
¡_nÜm®
:

1791  
	`ş_¡©us_nÜm®
(
ş
);

1793 
¡_g‘upd©efe
:

1794  
	`ş_¡©us_g‘upd©efe
(
ş
);

1796 
¡_upd©e¡©us
:

1797  
	`ş_¡©us_upd©e¡©us
(
ş
);

1803  
EMS_OK
;

1804 
	}
}

1807 #ifdeà
DEBUG


1808 
ems_cch¬
 *
	$ems_¡©us_¡r
(
ems_¡©us
 
¡
)

1810 
¡
) {

1811 
¡_š™
:

1813 
¡_nÜm®
:

1815 
¡_hb
:

1817 
¡_»g
:

1819 
¡_­¶i¡
:

1821 
¡_dowÆßd
:

1823 
¡_š¡®l
:

1825 
¡_”r
:

1827 
¡_¡İ³d
:

1829 
¡_cÚÃù
:

1832 
¡_auth
:

1835 
¡_acù
:

1838 
¡_acù_¡İ
:

1841 
¡_g‘cÚfig
:

1844 
¡_g‘upd©efe
:

1852 
	}
}

	@src/core/ems_cmd.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"ems_fw.h
"

5 
	~"­p.h
"

6 
	~"ems_Ãtcheck.h
"

8 
ems_št


9 
	$ems_cmd_c_£t
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

11 
ems_št
 
pÜt
;

12 
ems_¡r
 
buf
;

13 
ems_št
 
»¡¬t
 = 
EMS_NO
;

15 
	`¡r_š™
(&
buf
);

17 
	`ems_jsÚ_g‘_št
(
»q
, "pÜt", 
pÜt
);

18 
	`ems_jsÚ_g‘_¡ršg
(
»q
, "addr", &
buf
);

20 ià(
	`¡r_Ën
(&
buf
) <= 0)

21  
MSG_ST_INVALID_ARG
;

23 ià(
	`¡rcmp
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_s_addr
), 
	`¡r_‹xt
(&
buf
))) {

24 
	`cfg_£t
(
	`emscfg
(), 
CFG_ems_s_addr
, 
	`¡r_‹xt
(&
buf
));

25 
»¡¬t
 = 
EMS_YES
;

28 ià(
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_s_pÜt
)è!ğ
pÜt
 ) {

29 
	`cfg_£t
(
	`emscfg
(), 
CFG_ems_s_pÜt
, 
	`ems_™ß
(
pÜt
));

30 
»¡¬t
 = 
EMS_YES
;

33 #ifdeà
DEBUG


34 
	`ems_jsÚ_g‘_¡ršg_def
(
»q
, "¢", &
buf
, 
NULL
);

35 ià(
	`¡r_Ën
(&
buf
) > 0)

36 
	`cfg_£t
(
	`emscfg
(), 
CFG_ems_¢
, 
	`¡r_‹xt
(&
buf
));

38 ià(
»¡¬t
) {

39 
	`cfg_wr™e
(
	`emscfg
());

40 
	`ems_£nd_mes§ge
(
ty_ù¾
, 
ty_ş›Á
, 
EMS_APP_STOP
, 
NULL
);

41 
	`ems_£nd_mes§ge
(
ty_ù¾
, 
ty_ş›Á
, 
EMS_APP_START
, 
NULL
);

44 
	`¡r_ş—r
(&
buf
);

46  
EMS_OK
;

47 
	}
}

49 
ems_št


50 
	$ems_cmd_c_g‘
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

52 
jsÚ_objeù
 *
r¥
;

53 
ems_cfg
 *
cfg
 = 
	`emscfg
();

56 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

58 
	`ems_as£¹
(
	`cfg_g‘
(
cfg
, 
CFG_ems_s_addr
è&& cfg_g‘(cfg, 
CFG_ems_s_pÜt
));

60 
	`jsÚ_objeù_objeù_add
(
r¥
, "addr",

61 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cfg_g‘
(
cfg
, 
CFG_ems_s_addr
)));

62 
	`jsÚ_objeù_objeù_add
(
r¥
, "port",

63 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
	`cfg_g‘
(
cfg
, 
CFG_ems_s_pÜt
))));

65 
	`£ss_»¥Ú£_£t
(
£ss
, 
r¥
);

67  
EMS_OK
;

68 
	}
}

71 
ems_št
 
	$ems_cmd_c
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

73 
jsÚ_objeù
 *
obj
;

75 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

77 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

78  
MSG_ST_INVALID_ARG
;

80 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

81  
	`ems_cmd_c_£t
(
cÜe
, 
£ss
, 
»q
);

83  
	`ems_cmd_c_g‘
(
cÜe
, 
£ss
, 
»q
);

84 
	}
}

87 
ems_št


88 
	$ems_cmd_ù¾_£t
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

90 
ems_št
 
auto_»g
;

91 
ems_št
 
run
;

92 
ems_ušt
 
æg
;

94 
	`ems_jsÚ_g‘_št_def
(
»q
, "auto", 
auto_»g
, 1);

95 
	`ems_jsÚ_g‘_št
(
»q
, "run", 
run
);

97 ià(
auto_»g
)

98 
	`ems_æag_£t
(
cÜe
->
æg
, 
FLG_AUTO_REG
);

100 
	`ems_æag_un£t
(
cÜe
->
æg
, 
FLG_AUTO_REG
);

102 ià(
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_c_auto
)è!ğ
auto_»g
) {

103 
	`cfg_£t
(
	`emscfg
(), 
CFG_ems_c_auto
, 
	`ems_™ß
(
auto_»g
));

106 
æg
 = 
cÜe
->flg;

108 ià(
run
)

109 
	`ems_æag_£t
(
æg
, 
FLG_RUN
);

111 
	`ems_æag_un£t
(
æg
, 
FLG_RUN
);

113  (
æg
 =ğ
cÜe
->æg)? 
EMS_OK
: 
	`şÁ_run
(cÜe, 
run
);

114 
	}
}

116 
ems_št


117 
	$ems_cmd_ù¾_g‘
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

119 
ems_št
 
tmp
;

120 
jsÚ_objeù
 *
r¥
;

122 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

124 
tmp
 = 
EMS_YES
;

125 ià(
	`ems_æag_uÆike
(
cÜe
->
æg
, 
FLG_AUTO_REG
))

126 
tmp
 = 
EMS_NO
;

128 
	`jsÚ_objeù_objeù_add
(
r¥
, "auto", 
	`jsÚ_objeù_Ãw_št
(
tmp
));

130 
tmp
 = 
EMS_YES
;

131 ià(
	`ems_æag_uÆike
(
cÜe
->
æg
, 
FLG_RUN
))

132 
tmp
 = 
EMS_NO
;

134 
	`jsÚ_objeù_objeù_add
(
r¥
, "run", 
	`jsÚ_objeù_Ãw_št
(
tmp
));

136 
	`£ss_»¥Ú£_£t
(
£ss
, 
r¥
);

138  
EMS_OK
;

139 
	}
}

143 
ems_št
 
	$ems_cmd_ù¾
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

145 
jsÚ_objeù
 *
obj
;

147 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

149 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

150  
MSG_ST_INVALID_ARG
;

153 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

154  
	`ems_cmd_ù¾_£t
(
cÜe
, 
£ss
, 
»q
);

156  
	`ems_cmd_ù¾_g‘
(
cÜe
, 
£ss
, 
»q
);

158  
EMS_OK
;

160 
	}
}

163 
ems_št


164 
	$ems_cmd_¡©us_fl_sy¡em
(
ems_cÜe
 *
cÜe
, 
jsÚ_objeù
 *
roÙ
)

166 
jsÚ_objeù
 *
r¥
, *
Ãt
;

168 
ems_cfg
 *
cfg
 = 
	`emscfg
();

170 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

172 
	`jsÚ_objeù_objeù_add
(
r¥
, "¢", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cfg_g‘
(
cfg
, 
CFG_ems_¢
)));

173 
	`jsÚ_objeù_objeù_add
(
r¥
, "mac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cfg_g‘
(
cfg
, 
CFG_ems_mac
)));

175 
Ãt
 = 
	`jsÚ_objeù_Ãw_objeù
();

177 
	`jsÚ_objeù_objeù_add
(
Ãt
, "st",

178 
	`jsÚ_objeù_Ãw_¡ršg
(
	`ems_æag_like
(
cÜe
->
æg
, 
FLG_NETWORK_READY
)?"up":"down"));

180 
	`jsÚ_objeù_objeù_add
(
Ãt
, "bridge",

181 
	`jsÚ_objeù_Ãw_¡ršg
(
	`ems_æag_like
(
cÜe
->
æg
, 
FLG_NETWORK_BRIDGE
)?"yes":"no"));

184 
	`jsÚ_objeù_objeù_add
(
r¥
, "ÃtwÜk_¡©us", 
Ãt
);

185 
	`jsÚ_objeù_objeù_add
(
roÙ
, "sy¡em", 
r¥
);

187  
EMS_OK
;

188 
	}
}

191 
ems_št
 
	$ems_cmd_¡©us
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

193 
ems_ušt
 
æg
;

194 
jsÚ_objeù
 *
r¥
;

196 
	`ems_jsÚ_g‘_št_def
(
»q
, "æag", 
æg
, 0x01);

198 
	#æg_sy¡em
 0x01<<0

	)

199 
	#æg_ems
 0x01<<1

	)

201 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

202 ià(
	`ems_æag_like
(
æg
, 
æg_sy¡em
))

203 
	`ems_cmd_¡©us_fl_sy¡em
(
cÜe
, 
r¥
);

205 ià(
	`ems_æag_like
(
æg
, 
æg_ems
))

206 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_ş›Á
, 
EMS_APP_EMS_STATUS
, 
r¥
);

208 
	`£ss_»¥Ú£_£t
(
£ss
, 
r¥
);

210  
EMS_OK
;

211 
	}
}

214 
ems_št
 
	$ems_cmd_bwli¡_£t
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

216 
ems_ušt
 
æg
;

217 
jsÚ_objeù
 *
obj
;

219 
	`ems_jsÚ_g‘_št
(
»q
, "æag", 
æg
);

221 ià(
	`ems_æag_like
(
æg
, 0x01 << 0)) {

222 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "url");

223 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¬¿y
)) {

224 
	`cfg_£t_jsÚ
(
	`emscfg
(), 
CFG_u£r_u¾_wh™e
, 
obj
);

228 ià(
	`ems_æag_like
(
æg
, 0x01 << 1)) {

229 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "whitemac");

230 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¬¿y
)) {

231 
	`cfg_£t_jsÚ
(
	`emscfg
(), 
CFG_u£r_mac_wh™e
, 
obj
);

235 ià(
	`ems_æag_like
(
æg
, 0x01 << 2)) {

236 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "blackmac");

237 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¬¿y
)) {

238 
	`cfg_£t_jsÚ
(
	`emscfg
(), 
CFG_u£r_mac_bÏck
, 
obj
);

242 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_fw
, 
EMS_APP_RULES_UPDATE
, 
NULL
);

243 
	`cfg_wr™e
(
	`emscfg
());

245  
EMS_OK
;

246 
	}
}

249 
ems_št
 
	$ems_cmd_bwli¡_g‘
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

251 
ems_ušt
 
æg
;

252 
jsÚ_objeù
 *
r¥
;

254 
	`ems_jsÚ_g‘_št_def
(
»q
, "æag", 
æg
, 0x07);

256 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

258 ià(
	`ems_æag_like
(
æg
, 0x01 << 0)) {

259 
	`jsÚ_objeù_objeù_add
(
r¥
, "u¾", 
	`cfg_g‘_jsÚ
(
	`emscfg
(), 
CFG_u£r_u¾_wh™e
));

262 ià(
	`ems_æag_like
(
æg
, 0x01 << 1)) {

263 
	`jsÚ_objeù_objeù_add
(
r¥
, "wh™emac", 
	`cfg_g‘_jsÚ
(
	`emscfg
(), 
CFG_u£r_mac_wh™e
));

267 ià(
	`ems_æag_like
(
æg
, 0x01 << 2)) {

268 
	`jsÚ_objeù_objeù_add
(
r¥
, "bÏckmac", 
	`cfg_g‘_jsÚ
(
	`emscfg
(), 
CFG_u£r_mac_bÏck
));

271 
	`£ss_»¥Ú£_£t
(
£ss
, 
r¥
);

273  
EMS_OK
;

275 
	}
}

277 
ems_št
 
	$ems_cmd_bwli¡
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

279 
jsÚ_objeù
 *
obj
;

281 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

283 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

284  
MSG_ST_INVALID_ARG
;

286 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

287  
	`ems_cmd_bwli¡_£t
(
cÜe
, 
£ss
, 
»q
);

289  
	`ems_cmd_bwli¡_g‘
(
cÜe
, 
£ss
, 
»q
);

290 
	}
}

294 
ems_št


295 
	$ems_cmd_qos_£t
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

297 
ems_ušt
 
’abË
;

299 
	`ems_jsÚ_g‘_št
(
»q
, "’abË", 
’abË
);

301 
	`ems_l_Œaû
("qo £ˆštØ’abË? %s", 
’abË
?"yes":"no");

303 
	`cfg_£t
(
	`emscfg
(), 
CFG_­p_qos_’abË
, 
	`ems_™ß
(
’abË
));

305 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_qos
, 
EMS_APP_RULES_UPDATE
, 
»q
);

307 
	`cfg_wr™e
(
	`emscfg
());

309  
EMS_OK
;

310 
	}
}

312 
ems_št


313 
	$ems_cmd_qos_g‘
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

315 
jsÚ_objeù
 *
r¥
;

316 
ems_cch¬
 *
v®
;

318 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

320 
v®
 = 
	`cfg_g‘
(
	`emscfg
(), 
CFG_­p_qos_’abË
);

321 ià(!
v®
) {

322 
	`cfg_£t
(
	`emscfg
(), 
CFG_­p_qos_’abË
, "1");

323 
v®
 = 
	`cfg_g‘
(
	`emscfg
(), 
CFG_­p_qos_’abË
);

326 
	`jsÚ_objeù_objeù_add
(
r¥
, "’abË", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

328 
	`£ss_»¥Ú£_£t
(
£ss
, 
r¥
);

330  
EMS_OK
;

331 
	}
}

334 
ems_št
 
	$ems_cmd_qos
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

337 
jsÚ_objeù
 *
obj
;

339 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

341 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

342  
MSG_ST_INVALID_ARG
;

344 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

345  
	`ems_cmd_qos_£t
(
cÜe
, 
£ss
, 
»q
);

347  
	`ems_cmd_qos_g‘
(
cÜe
, 
£ss
, 
»q
);

349  
EMS_ERR
;

351 
	}
}

354 
ems_št


355 
	$ems_cmd_pÜl_£t
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

357 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_pÜl
, 
EMS_APP_RULES_UPDATE
, 
»q
);

358 
	`cfg_wr™e
(
	`emscfg
());

360 
	`¡r_ş—r
(&
cÜe
->
pÜl
);

361 
cÜe
->
pÜl_»dœeù_pÜt
 = 0;

363  
EMS_OK
;

364 
	}
}

366 
ems_št


367 
	$ems_cmd_pÜl_g‘
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

369 
jsÚ_objeù
 *
r¥
;

370 
ems_cch¬
 *
v®
;

371 
ems_cfg
 *
cfg
 = 
	`emscfg
();

373 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

375 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_auto
);

376 ià(
v®
)

377 
	`jsÚ_objeù_objeù_add
(
r¥
, "auto", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

379 
	`jsÚ_objeù_objeù_add
(
r¥
, "auto", 
	`jsÚ_objeù_Ãw_št
(1));

381 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_addr
);

382 ià(
v®
)

383 
	`jsÚ_objeù_objeù_add
(
r¥
, "addr", 
	`jsÚ_objeù_Ãw_¡ršg
(
v®
));

385 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_pÜt
);

386 ià(
v®
)

387 
	`jsÚ_objeù_objeù_add
(
r¥
, "pÜt", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

389 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_»g
);

390 ià(
v®
)

391 
	`jsÚ_objeù_objeù_add
(
r¥
, "»g_³riod", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

393 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_hb
);

394 ià(
v®
)

395 
	`jsÚ_objeù_objeù_add
(
r¥
, "hb_³riod", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

397 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_pÜl_»dœeù
);

398 ià(
v®
)

399 
	`jsÚ_objeù_objeù_add
(
r¥
, "»dœeù_pÜt", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

401 
	`£ss_»¥Ú£_£t
(
£ss
, 
r¥
);

403  
EMS_OK
;

404 
	}
}

406 
ems_št
 
	$ems_cmd_pÜl
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

408 
jsÚ_objeù
 *
obj
;

410 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

412 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

413  
MSG_ST_INVALID_ARG
;

415 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

416  
	`ems_cmd_pÜl_£t
(
cÜe
, 
£ss
, 
»q
);

418  
	`ems_cmd_pÜl_g‘
(
cÜe
, 
£ss
, 
»q
);

419 
	}
}

421 
ems_št


422 
	$ems_cmd_¿dius_£t
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

424 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_¿dius
, 
EMS_APP_RULES_UPDATE
, 
»q
);

425 
	`cfg_wr™e
(
	`emscfg
());

426  
EMS_OK
;

427 
	}
}

429 
ems_št


430 
	$ems_cmd_¿dius_g‘
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

432 
jsÚ_objeù
 *
r¥
;

433 
ems_cch¬
 *
v®
;

434 
ems_cfg
 *
cfg
 = 
	`emscfg
();

436 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

438 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_auto
);

439 ià(
v®
)

440 
	`jsÚ_objeù_objeù_add
(
r¥
, "auto", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

442 
	`jsÚ_objeù_objeù_add
(
r¥
, "auto", 
	`jsÚ_objeù_Ãw_št
(1));

444 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_addr
);

445 ià(
v®
)

446 
	`jsÚ_objeù_objeù_add
(
r¥
, "addr", 
	`jsÚ_objeù_Ãw_¡ršg
(
v®
));

448 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_sh¬ed_key
);

449 ià(
v®
)

450 
	`jsÚ_objeù_objeù_add
(
r¥
, "£ü‘", 
	`jsÚ_objeù_Ãw_¡ršg
(
v®
));

452 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_pÜt_auth
);

453 ià(
v®
)

454 
	`jsÚ_objeù_objeù_add
(
r¥
, "authpÜt", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

456 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_pÜt_acù
);

457 ià(
v®
)

458 
	`jsÚ_objeù_objeù_add
(
r¥
, "acùpÜt", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

460 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_»pÜt_³riod
);

461 ià(
v®
)

462 
	`jsÚ_objeù_objeù_add
(
r¥
, "½_³riod", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

464 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_»Œy_times
);

465 ià(
v®
)

466 
	`jsÚ_objeù_objeù_add
(
r¥
, "»Œy_times", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

468 
	`jsÚ_objeù_objeù_add
(
r¥
, "»Œy_times", 
	`jsÚ_objeù_Ãw_št
(3));

470 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_­p_¿dius_»Œy_timeout
);

471 ià(
v®
)

472 
	`jsÚ_objeù_objeù_add
(
r¥
, "»Œy_timeout", 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
v®
)));

474 
	`jsÚ_objeù_objeù_add
(
r¥
, "»Œy_timeout", 
	`jsÚ_objeù_Ãw_št
(5));

476 
	`£ss_»¥Ú£_£t
(
£ss
, 
r¥
);

478  
EMS_OK
;

479 
	}
}

481 
ems_št
 
	$ems_cmd_¿dius
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

483 
jsÚ_objeù
 *
obj
;

485 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

487 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

488  
MSG_ST_INVALID_ARG
;

490 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

491  
	`ems_cmd_¿dius_£t
(
cÜe
, 
£ss
, 
»q
);

493  
	`ems_cmd_¿dius_g‘
(
cÜe
, 
£ss
, 
»q
);

494 
	}
}

496 
ems_št
 
	$ems_cmd_bridge_»q
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

498 
ems_št
 
¹n
;

499 
jsÚ_objeù
 *
r¥
 = 
NULL
;

500 
ems_cch¬
 *
v®
;

501 
ems_cfg
 *
cfg
 = 
	`emscfg
();

503 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

506 
¹n
 = 
EMS_ERR
;

508 
	`cÜe_wœ–ess_šfo
();

510 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_ssid
);

511 ià(!
v®
) ;

512 
	`jsÚ_objeù_objeù_add
(
r¥
, "ssid", 
	`jsÚ_objeù_Ãw_¡ršg
(
v®
));

514 ià(
	`ems_©oi
(
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_’abË_’üy±
))) {

515 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_’üy±
);

516 ià(!
v®
) ;

518 
	`jsÚ_objeù_objeù_add
(
r¥
, "’üy±iÚ", 
	`jsÚ_objeù_Ãw_¡ršg
(
v®
));

520 
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_key
);

521 ià(
v®
)

522 
	`jsÚ_objeù_objeù_add
(
r¥
, "key", 
	`jsÚ_objeù_Ãw_¡ršg
(
v®
));

524 
	`jsÚ_objeù_objeù_add
(
r¥
, "’üy±iÚ", 
	`jsÚ_objeù_Ãw_¡ršg
("none"));

526 
¹n
 = 
EMS_OK
;

529 ià(
¹n
 !ğ
EMS_OK
) {

530 
	`jsÚ_objeù_put
(
r¥
);

531 
r¥
 = 
NULL
;

533 
	`£ss_»¥Ú£_£t
(
£ss
, 
r¥
);

536  
¹n
;

537 
	}
}

539 
ems_št
 
	$ems_cmd_bridge_hb
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

541 
jsÚ_objeù
 *
obj
;

542 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

544 
	`jsÚ_objeù_objeù_add
(
obj
, "ip",

545 
	`jsÚ_objeù_Ãw_¡ršg
(
	`ems_sock_addr
(&
£ss
->
sock
)));

546 
	`jsÚ_objeù_objeù_add
(
obj
, "mac",

547 
	`jsÚ_objeù_Ãw_¡ršg
(
	`ems_u£rmac
(
	`ems_sock_addr
(&
£ss
->
sock
))));

549 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_dowÆšk
, 
EMS_EVT_DOWNLINK_IN
, 
obj
);

551 
	`jsÚ_objeù_put
(
obj
);

553  
EMS_OK
;

554 
	}
}

556 
ems_št
 
	$ems_cmd_‹¡_¿dius
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

558 
jsÚ_objeù
 *
obj
;

559 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

561 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

562  
MSG_ST_INVALID_ARG
;

564 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

565  
	`ems_£nd_mes§ge
(
ty_pÜl
, 
ty_¿dius
, 0x0001, 
»q
);

567  
	`ems_£nd_mes§ge
(
ty_pÜl
, 
ty_¿dius
, 0x0002, 
»q
);

568 
	}
}

570 
ems_št


571 
	$ems_cmd_ÃtwÜk_up
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

573 ià(
	`ems_æag_like
(
cÜe
->
æg
, 
FLG_NETWORK_BRIDGE
))

574  
EMS_OK
;

576 ià(
	`ems_æag_like
(
cÜe
->
æg
, 
FLG_NETWORK_READY
))

577  
EMS_OK
;

579 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_Ãt
, 
EMS_APP_STOP
, 
NULL
);

580 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_pÜl
, 
EMS_APP_STOP
, 
NULL
);

582 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_Ãt
, 
EMS_APP_START
, 
NULL
);

583 
	`ems_£nd_mes§ge
(
ty_ù¾
, 
ty_pÜl
, 
EMS_APP_START
, 
NULL
);

585  
EMS_OK
;

586 
	}
}

588 
ems_št
 
	$ems_cmd_ÃtwÜk
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

590 
jsÚ_objeù
 *
obj
;

591 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

593 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

594  
MSG_ST_INVALID_ARG
;

596 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "up"))

597  
	`ems_cmd_ÃtwÜk_up
(
cÜe
, 
£ss
, 
»q
);

599  
EMS_OK
;

600 
	}
}

602 
ems_št


603 
	$ems_cmd_cÚfig_£t
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

605 
ems_št
 
cfg
;

607 
	`ems_jsÚ_g‘_št
(
»q
, "fœ¡cÚfig", 
cfg
);

609 ià(
cfg
)

610 
	`ems_æag_£t
(
cÜe
->
æg
, 
FLG_FIRST_CONFIG
);

612 
	`ems_æag_un£t
(
cÜe
->
æg
, 
FLG_FIRST_CONFIG
);

614  
EMS_OK
;

615 
	}
}

617 
ems_št


618 
	$ems_cmd_cÚfig
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

620 
jsÚ_objeù
 *
obj
;

621 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

623 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

624  
MSG_ST_INVALID_ARG
;

626 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

627  
	`ems_cmd_cÚfig_£t
(
cÜe
, 
£ss
, 
»q
);

629  
EMS_OK
;

630 
	}
}

632 
ems_št
 
	$ems_cmd_fw
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

634 
	`ems_l_Œaû
("reloading.....");

636 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_Ãt
, 
EMS_APP_STOP
, 
NULL
);

637 
	`ems_æush_sy¡em_šfo
();

638 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_Ãt
, 
EMS_APP_START
, 
NULL
);

640 
	`¡r_ş—r
(&
cÜe
->
gw
);

641 
	`¡r_ş—r
(&
cÜe
->
iâame
);

642 
	`¡r_ş—r
(&
cÜe
->
ac_mac
);

643 
	`¡r_ş—r
(&
cÜe
->
ssid
);

645 ià(!
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_wœ–ess_’abË_’üy±
))) {

646 
	`ems_l_Œaû
("reset wirelessƒncrypt method");

647 
	`ems_£twifi_nİasswÜd
();

650 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_fw
, 
EMS_APP_EVT_FW_RELOAD
, 
NULL
);

651 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_¿dius
, 
EMS_APP_EVT_FW_RELOAD
, 
NULL
);

652 
	`ems_l_Œaû
("done !!!");

654  
EMS_OK
;

655 
	}
}

657 
ems_št
 
	$ems_cmd_u£r
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

659 
jsÚ_objeù
 *
obj
;

660 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

662 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

663  
MSG_ST_INVALID_ARG
;

665 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "kickout")) {

666 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "userip");

668 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

669  
MSG_ST_INVALID_ARG
;

671 
	`jsÚ_objeù_objeù_add
(
»q
, "usermac",

672 
	`jsÚ_objeù_Ãw_¡ršg
(
	`ems_u£rmac
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
)))

675 
	`jsÚ_objeù_objeù_add
(
»q
, "username",

676 
	`jsÚ_objeù_Ãw_¡ršg
(

677 
	`ems_­p_¿dius_u£ºame
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
))

681  
	`ems_£nd_mes§ge
(
ty_pÜl
, 
ty_¿dius
, 
EMS_APP_CMD_RADIUS_LOGOUT
, 
»q
);

684 
	`£ss_»¥Ú£_£t
(
£ss
, 
	`ems_­p_¿dius_u£¾i¡
());

686  
EMS_OK
;

687 
	}
}

689 
ems_št
 
	$ems_cmd_wœ–ess
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
)

691 
jsÚ_objeù
 *
r¥
 = 
NULL
;

692 
jsÚ_objeù
 *
obj
;

693 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

695 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)))

696  
MSG_ST_INVALID_ARG
;

698 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "get")) {

699 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

700 
	`jsÚ_objeù_objeù_add
(
r¥
, "enable_encrypt",

701 
	`jsÚ_objeù_Ãw_št
(

702 
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_wœ–ess_’abË_’üy±
))

706 
	`£ss_»¥Ú£_£t
(
£ss
, 
r¥
);

707  
EMS_OK
;

710  
EMS_ERR
;

711 
	}
}

	@src/core/ems_cmd.h

2 #iâdeà
EMS_COMMAND_HEADER___


3 
	#EMS_COMMAND_HEADER___


	)

6 
	#CMD_EMS
 0

	)

7 
	#CMD_EMS_C
 0x0001

	)

8 
	#CMD_EMS_CTRL
 0x0002

	)

9 
	#CMD_EMS_STATUS
 0x0003

	)

10 
	#CMD_EMS_QOS
 0x0004

	)

11 
	#CMD_EMS_PORTAL
 0x0005

	)

12 
	#CMD_EMS_RADIUS
 0x0006

	)

13 
	#CMD_EMS_BWLIST
 0x0007

	)

14 
	#CMD_EMS_FW
 0x0008

	)

15 
	#CMD_EMS_APP
 0x0009

	)

16 
	#CMD_EMS_USER
 0x000a

	)

17 
	#CMD_EMS_WIRELESS
 0x000b

	)

18 
	#CMD_EMS_NETWORK
 0x000c

	)

19 
	#CMD_EMS_CONFIG
 0x000d

	)

21 
	#CMD_BRIDGE_BASE
 0x1000

	)

22 
	#CMD_BRIDGE_REQ
 0x1001

	)

23 
	#CMD_BRIDGE_HB
 0x1002

	)

24 
	#CMD_EMS_TEST_RADIUS
 0x2000

	)

29 
	#MSG_ST_REQUEST_ERR
 199

	)

30 
	#MSG_ST_CONNECT_EMS_FAILED
 200

	)

31 
	#MSG_ST_RESULT_ERROR
 201

	)

33 
ems_št
 
exec_cmd
Óms_šˆ
cmd
, 
jsÚ_objeù
 *
roÙ
);

34 
ems_št
 
cmd_·r£_cmd
Óms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
, 
jsÚ_objeù
 *
»q
);

36 
	#ems_jsÚ_»£t_key
(
obj
, 
»q
, 
key
) \

37 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, 
key
); \

38 ià(!
obj
) ; \

39 
	`jsÚ_objeù_objeù_add
(
»q
, 
key
, \

40 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
))))

	)

	@src/core/ems_conf.c

2 
	~"ems.h
"

3 
	~"jsÚ.h
"

4 
	~"ems_maš.h
"

5 
	~"ems_cÚf.h
"

8 
_ems_kv_s
 
	tcfg_kv
;

10 
	s_ems_kv_s
 {

11 
ems_¡r
 
	mkey
;

12 
ems_¡r
 
	mv®
;

13 
ems_queue
 
	m’Œy
;

16 
cfg_kv
 *
	$cfg_kv_Ãw
()

18 
cfg_kv
 *
kv
 = 
NULL
;

20 
kv
 = (
cfg_kv
 *)
	`ems_m®loc
((cfg_kv));

21 ià(
kv
) {

22 
	`¡r_š™
(&
kv
->
key
);

23 
	`¡r_š™
(&
kv
->
v®
);

24 
	`ems_queue_š™
(&
kv
->
’Œy
);

27  
kv
;

28 
	}
}

30 
ems_void
 
	$cfg_kv_de¡roy
(
cfg_kv
 *
kv
)

32 ià(
kv
) {

33 
	`¡r_ş—r
(&
kv
->
key
);

34 
	`¡r_ş—r
(&
kv
->
v®
);

35 
	`ems_ä“
(
kv
);

37 
	}
}

39 
cfg_kv
 *
	$cfg_fšd
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
key
)

41 
ems_queue
 *
p
;

42 
cfg_kv
 *
kv
;

44 
	`ems_as£¹
(
cfg
 && 
key
);

46 
	`ems_queue_fÜ—ch
(&
cfg
->
kv_’Œy
, 
p
) {

47 
kv
 = 
	`ems_cÚš”_of
(
p
, 
cfg_kv
, 
’Œy
);

49 ià(!
	`¡rcmp
(
	`¡r_‹xt
(&
kv
->
key
), key))

50  
kv
;

53  
NULL
;

54 
	}
}

57 
ems_št
 
	$cfg_š™
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
æ
)

59 
	`ems_as£¹
(
cfg
 && 
æ
);

61 
	`mem£t
(
cfg
, 0, (
ems_cfg
));

63 
	`¡r_£t
(&
cfg
->
æ
, fl);

64 
	`ems_queue_š™
(&
cfg
->
kv_’Œy
);

66  
EMS_OK
;

67 
	}
}

69 
ems_void
 
	$cfg_unš™
(
ems_cfg
 *
cfg
)

71 
	`ems_as£¹
(
cfg
);

73 
	`¡r_ş—r
(&
cfg
->
æ
);

74 
	`ems_queue_ş—r
(&
cfg
->
kv_’Œy
, 
cfg_kv
, 
’Œy
, 
cfg_kv_de¡roy
);

75 
	}
}

77 
ems_št
 
	$cfg_·r£_lše
(
ems_cfg
 *
cfg
, 
ems_ch¬
 *
buf
)

79 
ems_ch¬
 *
k
, *
v
;

81 
k
 = 
buf
;

82 
v
 = 
	`¡rchr
(
k
, '=');

83 ià(!
v
)

84  
EMS_ERR
;

86 *
v
++ = '\0';

87 
	`ems_Œim
(
k
);

88 
	`ems_Œim
(
v
);

90 ià(
	`¡¾’
(
k
è<ğ0 || sŒËn(
v
) <= 0)

91  
EMS_ERR
;

93  
	`cfg_£t
(
cfg
, 
k
, 
v
);

94 
	}
}

96 
ems_št
 
	$cfg_»ad
(
ems_cfg
 *
cfg
)

98 
FILE
 *
å
 = 
NULL
;

99 
ems_ch¬
 
buf
[1024] = {0};

101 
	`ems_as£¹
(
cfg
 && 
	`¡r_Ën
(&cfg->
æ
) > 0);

103 
å
 = 
	`fİ’
(
	`¡r_‹xt
(&
cfg
->
æ
), "r");

105 ià(!
å
) {

106 
	`ems_l_w¬n
("İ’ cfg f: % ”r: %s", 
	`¡r_‹xt
(&
cfg
->
æ
), 
	`ems_Ï¡”rmsg
());

107  
EMS_ERR
;

110 
NULL
 !ğ
	`fg‘s
(
buf
, (bufè- 1, 
å
)) {

111 
	`ems_Œim
(
buf
);

112 ià(
	`¡¾’
(
buf
) > 0) {

113 
	`cfg_·r£_lše
(
cfg
, 
buf
);

117 
	`fşo£
(
å
);

119  
EMS_OK
;

120 
	}
}

122 
ems_št
 
	$cfg_wr™e
(
ems_cfg
 *
cfg
)

124 
FILE
 *
å
 = 
NULL
;

125 
ems_queue
 *
p
;

126 
cfg_kv
 *
kv
;

127 
ems_ch¬
 
buf
[1024] = {0};

129 
	`ems_as£¹
(
cfg
 && 
	`¡r_Ën
(&cfg->
æ
) > 0);

131 
å
 = 
	`fİ’
(
	`¡r_‹xt
(&
cfg
->
æ
), "w");

133 ià(!
å
) {

134 
	`ems_l_w¬n
("İ’ cfg f % ”r: %s", 
	`¡r_‹xt
(&
cfg
->
æ
), 
	`ems_Ï¡”rmsg
());

135  
EMS_ERR
;

138 
	`ems_queue_fÜ—ch
(&
cfg
->
kv_’Œy
, 
p
) {

139 
kv
 = 
	`ems_cÚš”_of
(
p
, 
cfg_kv
, 
’Œy
);

140 
	`ems_as£¹
(
	`¡r_Ën
(&
kv
->
key
) > 0);

141 
	`ems_as£¹
(
	`¡r_Ën
(&
kv
->
v®
) > 0);

143 ià(
	`¡r_Ën
(&
kv
->
key
è<ğ0 || sŒ_Ën(&kv->
v®
) <= 0)

146 
	`¢´štf
(
buf
, (buf), "%s=%s\n", 
	`¡r_‹xt
(&
kv
->
key
), sŒ_‹xt(&kv->
v®
));

147 
	`fwr™e
(
buf
, 
	`¡¾’
(buf), 1, 
å
);

150 
	`fşo£
(
å
);

152  
EMS_OK
;

153 
	}
}

155 
ems_št
 
	$cfg_æush
(
ems_cfg
 *
cfg
)

157 
	`ems_as£¹
(
cfg
 && "never show uphis†ine");

158 
	`ems_queue_ş—r
(&
cfg
->
kv_’Œy
, 
cfg_kv
, 
’Œy
, 
cfg_kv_de¡roy
);

159  
	`cfg_»ad
(
cfg
);

160 
	}
}

162 
ems_št
 
	$cfg_£t
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
k
,ƒms_cch¬ *
v
)

164 
cfg_kv
 *
kv
;

166 
kv
 = 
	`cfg_fšd
(
cfg
, 
k
);

167 ià(!
kv
) {

168 ià(!(
v
 && 
	`¡¾’
(v) > 0))

169  
EMS_OK
;

171 
kv
 = 
	`cfg_kv_Ãw
();

172 ià(!
kv
)

173  
MSG_ST_MEM_ERR
;

175 
	`¡r_£t
(&
kv
->
key
, 
k
);

176 
	`¡r_£t
(&
kv
->
v®
, 
v
);

177 
	`ems_queue_š£¹_
(&
cfg
->
kv_’Œy
, &
kv
->
’Œy
);

180 ià(!(
v
 && 
	`¡¾’
(v) > 0)) {

181 
	`ems_queue_»move
(&
kv
->
’Œy
);

182 
	`cfg_kv_de¡roy
(
kv
);

184 
	`¡r_£t
(&
kv
->
v®
, 
v
);

187  
EMS_OK
;

188 
	}
}

190 
ems_cch¬
 *
	$cfg_g‘
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
key
)

192 
cfg_kv
 *
kv
;

194 
kv
 = 
	`cfg_fšd
(
cfg
, 
key
);

195 ià(
kv
)

196  
	`¡r_‹xt
(&
kv
->
v®
);

198  
NULL
;

199 
	}
}

201 
ems_št
 
	$cfg_£Ëù
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
like
, 
ems_void
 *
¬g
, 
cfg_£¬ch_cb
 
cb
)

203 
ems_št
 
¹n
, 
Ën
, 
n
;

204 
ems_queue
 *
p
, *
q
;

205 
cfg_kv
 *
kv
;

207 ià(!
cb
)

208  
EMS_ERR
;

210 
Ën
 = 
	`¡¾’
(
like
);

212 
	`ems_queue_fÜ—ch_§ã
(&
cfg
->
kv_’Œy
, 
p
, 
q
) {

213 
kv
 = 
	`ems_cÚš”_of
(
p
, 
cfg_kv
, 
’Œy
);

215 
	`ems_as£¹
(
	`¡r_Ën
(&
kv
->
key
) > 0);

216 
	`ems_as£¹
(
	`¡r_Ën
(&
kv
->
v®
) > 0);

218 
n
 = (
Ën
 <ğ
	`¡r_Ën
(&
kv
->
key
))?len: str_len(&kv->key);

220 ià(!
	`¡ºcmp
(
	`¡r_‹xt
(&
kv
->
key
), 
like
, 
n
)) {

221 
¹n
 = 
	`cb
(
¬g
, 
	`¡r_‹xt
(&
kv
->
key
), sŒ_‹xt(&kv->
v®
));

222 ià(
¹n
 !ğ
EMS_OK
)

223  
¹n
;

227  
EMS_OK
;

228 
	}
}

230 
ems_št
 
	$cfg_d–_jsÚ
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
like
)

232 
ems_št
 
Ën
, 
n
;

233 
ems_queue
 *
p
, *
q
;

234 
cfg_kv
 *
kv
;

236 
Ën
 = 
	`¡¾’
(
like
);

238 
	`ems_queue_fÜ—ch_§ã
(&
cfg
->
kv_’Œy
, 
p
, 
q
) {

239 
kv
 = 
	`ems_cÚš”_of
(
p
, 
cfg_kv
, 
’Œy
);

241 
	`ems_as£¹
(
	`¡r_Ën
(&
kv
->
key
) > 0);

242 
	`ems_as£¹
(
	`¡r_Ën
(&
kv
->
v®
) > 0);

244 
n
 = (
Ën
 <ğ
	`¡r_Ën
(&
kv
->
key
))?len: str_len(&kv->key);

246 ià(!
	`¡ºcmp
(
	`¡r_‹xt
(&
kv
->
key
), 
like
, 
n
)) {

247 
	`ems_queue_»move
(&
kv
->
’Œy
);

248 
	`cfg_kv_de¡roy
(
kv
);

252  
EMS_OK
;

253 
	}
}

255 
ems_št
 
	$cfg_£t_jsÚ
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
key
, 
jsÚ_objeù
 *
ruËs
)

257 
ems_št
 
i
;

258 
jsÚ_objeù
 *
obj
;

259 
ems_ch¬
 
buf
[128] = {0};

261 
	`cfg_d–_jsÚ
(
cfg
, 
key
);

263 ià(!
ruËs
)

264  
EMS_OK
;

266 
	`ems_as£¹
(
ruËs
 && 
	`jsÚ_objeù_is_ty³
ÔuËs, 
jsÚ_ty³_¬¿y
));

268 
i
 = 0; i < 
	`jsÚ_objeù_¬¿y_Ëngth
(
ruËs
); i++) {

269 
obj
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
ruËs
, 
i
);

271 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)) {

272 
	`¢´štf
(
buf
, 128, "%s.%d", 
key
, 
i
);

273 
	`cfg_£t
(
cfg
, 
buf
, 
	`jsÚ_objeù_g‘_¡ršg
(
obj
));

277  
EMS_OK
;

278 
	}
}

281 
ems_št
 
	$cfg_g‘_jsÚ_cb
(
ems_void
 *
¬g
, 
ems_cch¬
 *
key
,ƒms_cch¬ *
v®
)

283 
jsÚ_objeù
 *
¬y
 = (jsÚ_objeù *)
¬g
;

285 
	`ems_as£¹
(
key
 && 
v®
);

287 ià(
key
 && 
v®
)

288 
	`jsÚ_objeù_¬¿y_add
(
¬y
, 
	`jsÚ_objeù_Ãw_¡ršg
(
v®
));

290  
EMS_OK
;

291 
	}
}

293 
jsÚ_objeù
 *
	$cfg_g‘_jsÚ
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
key
)

295 
jsÚ_objeù
 *
¬y
 = 
NULL
;

297 
¬y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

299 
	`cfg_£Ëù
(
cfg
, 
key
, (
ems_void
 *)
¬y
, 
cfg_g‘_jsÚ_cb
);

301  
¬y
;

302 
	}
}

	@src/core/ems_conf.h

2 #iâdeà
EMS_CONFIG___HEADER___


3 
	#EMS_CONFIG___HEADER___


	)

5 
_ems_cÚfig_s
 
	tems_cfg
;

7 
	s_ems_cÚfig_s
 {

8 
ems_¡r
 
	mæ
;

9 
ems_queue
 
	mkv_’Œy
;

12 
ems_št
 
cfg_š™
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
æ
);

13 
ems_void
 
cfg_unš™
(
ems_cfg
 *
cfg
);

15 
ems_št
 
cfg_»ad
(
ems_cfg
 *
cfg
);

16 
ems_št
 
cfg_wr™e
(
ems_cfg
 *
cfg
);

17 
ems_št
 
cfg_æush
(
ems_cfg
 *
cfg
);

18 
ems_št
 
cfg_£t
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
key
,ƒms_cch¬ *
v®
);

19 
ems_cch¬
 *
cfg_g‘
(
ems_cfg
 *
cfg
,ƒms_cch¬ *
key
);

39 
	$ems_št
 (*
	tcfg_£¬ch_cb
)(
	tems_void
 *
	t¬g
, 
	tems_cch¬
 *
	tkey
,ƒms_cch¬ *
	tv®
);

40 
ems_št
 
	`cfg_£Ëù
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
like
, 
ems_void
 *
¬g
, 
cfg_£¬ch_cb
 
cb
);

42 
jsÚ_objeù
 *
	`cfg_g‘_jsÚ
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
key
);

43 
ems_št
 
	`cfg_£t_jsÚ
(
ems_cfg
 *
cfg
, 
ems_cch¬
 *
key
, 
jsÚ_objeù
 *
ruËs
);

49 
	#CFG_dowÆßd_u¾_ios
 "ems_down.ios.u¾"

	)

50 
	#CFG_dowÆßd_u¾_ªdroid
 "ems_down.ªdroid.u¾"

	)

51 
	#CFG_dowÆßd_u¾_wšphÚe
 "ems_down.wšphÚe.u¾"

	)

57 
	#CFG_ems_v”siÚ
 "ems.v”siÚ"

	)

58 
	#CFG_ems_sy¡em_v”siÚ
 "ems.sy¡em.v”siÚ"

	)

59 
	#CFG_ems_¢
 "ems.¢"

	)

60 
	#CFG_ems_mac
 "ems.mac"

	)

61 
	#CFG_ems_deviûty³
 "ems.deviûty³"

	)

63 
	#CFG_ems_c_addr
 "ems_c.addr"

	)

64 
	#CFG_ems_c_pÜt
 "ems_c.pÜt"

	)

65 
	#CFG_ems_c_auto
 "ems_c.auto"

	)

67 
	#CFG_ems_s_addr
 "ems_s.addr"

	)

68 
	#CFG_ems_s_pÜt
 "ems_s.pÜt"

	)

70 
	#CFG_ems_s_¢
 
CFG_ems_¢


	)

71 
	#CFG_ems_s_code
 
CFG_ems_¢


	)

72 
	#CFG_ems_s_aúame
 
CFG_ems_¢


	)

73 
	#CFG_ems_s_mac
 
CFG_ems_mac


	)

75 
	#CFG_¿dius_diù
 "ems.¿dius.diùiÚay"

	)

81 
	#CFG_u£r_u¾_wh™e
 "u£r.u¾_wh™e"

	)

82 
	#CFG_u£r_mac_wh™e
 "u£r.mac_wh™e"

	)

83 
	#CFG_u£r_mac_bÏck
 "u£r.mac_bÏck"

	)

89 
	#CFG_­p_pÜl_addr
 "app.portal.addr"

90 
	#CFG_­p_pÜl_pÜt
 "app.portal.port"

91 
	#CFG_­p_pÜl_»dœeù
 "app.portal.redirect"

92 
	#CFG_­p_pÜl_»g
 "app.portal.reg"

93 
	#CFG_­p_pÜl_hb
 "app.portal.hb"

94 
	#CFG_­p_pÜl_auto
 "app.portal.auto"

95 

	)

99 
	#CFG_­p_¿dius_auto
 "app.radius.auto"

100 
	#CFG_­p_¿dius_addr
 "­p.¿dius.addr"

	)

101 
	#CFG_­p_¿dius_pÜt_auth
 "app.radius.port.auth"

102 
	#CFG_­p_¿dius_pÜt_acù
 "app.radius.port.acct"

103 
	#CFG_­p_¿dius_sh¬ed_key
 "app.radius.shared_key"

104 
	#CFG_­p_¿dius_»pÜt_³riod
 "app.radius.rp_period"

105 
	#CFG_­p_¿dius_»Œy_times
 "app.radius.retry_times"

106 
	#CFG_­p_¿dius_»Œy_timeout
 "app.radius.retry_timeout"

107 
	#CFG_­p_¿dius_discÚÃù
 "app.radius.disconnect"

108 

	)

112 
	#CFG_­p_qos_’abË
 "app.qos.enable"

113 
	#CFG_­p_qos_p2p
 "­p.qos.p2p"

	)

114 
	#CFH_­p_qos_down
 "­p.qos.down"

	)

115 
	#CFG_­p_qos_up
 "­p.qos.up"

	)

121 
	#CFG_­p_bwli¡_u¾_def
 "­p.bwli¡.def.u¾"

	)

122 
	#CFG_­p_bwli¡_u¾
 "­p.bwli¡.u¾"

	)

123 
	#CFG_­p_bwli¡_mac_wh™e
 "­p.bwli¡.mac.wh™e"

	)

124 
	#CFG_­p_bwli¡_mac_bÏck
 "­p.bwli¡.mac.bÏck"

	)

126 
	#CFG_Ïn_iâame
 "ÃtwÜk.Ïn.iâame"

	)

127 
	#CFG_Ïn_addr
 "ÃtwÜk.Ïn.addr"

	)

128 
	#CFG_Ïn_mask
 "ÃtwÜk.Ïn.Ãtmask"

	)

129 
	#CFG_Ïn_gw
 "ÃtwÜk.Ïn.g©eway"

	)

130 
	#CFG_Ïn_´Ùo
 "ÃtwÜk.Ïn.´Ùo"

	)

132 
	#CFG_wª_iâame
 "ÃtwÜk.wª.iâame"

	)

133 
	#CFG_wª_addr
 "ÃtwÜk.wª.addr"

	)

134 
	#CFG_wª_mask
 "ÃtwÜk.wª.Ãtmask"

	)

135 
	#CFG_wª_gw
 "ÃtwÜk.wª.g©eway"

	)

136 
	#CFG_wª_´Ùo
 "ÃtwÜk.wª.´Ùo"

	)

137 
	#CFG_wª_dns
 "ÃtwÜk.wª.dns"

	)

139 
	#CFG_wœ–ess_iâame
 "wœ–ess.@wifi-içû[0].iâame"

	)

140 
	#CFG_wœ–ess_ssid
 "wœ–ess.@wifi-içû[0].ssid"

	)

141 
	#CFG_wœ–ess_’üy±
 "wœ–ess.@wifi-içû[0].’üy±iÚ"

	)

142 
	#CFG_wœ–ess_key
 "wœ–ess.@wifi-içû[0].key"

	)

147 
	#CFG_wœ–ess_’abË_’üy±
 "wœ–ess.’abË_’üy±"

	)

153 
	#CFG_ş›Á_»Œy_³riod
 "ş›Á.»Œy_³riod"

	)

154 
	#CFG_ş›Á_g‘cÚf_³riod
 "ş›Á.g‘cÚf_³riod"

	)

155 
	#CFG_ş›Á_u±_³riod
 "ş›Á.u±_³riod"

	)

156 
	#CFG_ş›Á_subdomaš_’abË
 "ş›Á.’abË_subdomaš"

	)

	@src/core/ems_core.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

5 
	~"ems_Ãtcheck.h
"

6 
	~"ems_bridge.h
"

7 
	~"ems_fw.h
"

9 
	~<sigÇl.h
>

10 
	~<£tjmp.h
>

11 
	~<sys/ty³s.h
>

12 
	~<sys/¡©.h
>

14 
jmp_buf
 
	gjm·ddr
;

15 
ems_void
 
ems_mq_de¡roy
(
msgqueue
 *
mq
);

17 
ems_cch¬
 *
	$ems_pİ’_g‘
(
ems_cch¬
 *
cmd
)

19 
ems_ch¬
 
buf
[512];

20 
FILE
 *
å
;

22 
	`mem£t
(
buf
, 0, (buf));

23 
å
 = 
	`pİ’
(
cmd
, "r");

24 ià(!
å
)

25  
NULL
;

27 
	`fg‘s
(
buf
, (buf), 
å
);

29 
	`ems_Œim
(
buf
);

31 
	`pşo£
(
å
);

33 
	`ems_l_Œaû
("\033[00;32m cmd: %s,„esuÉ: %s\033[00m", 
cmd
, 
buf
);

34  
buf
;

35 
	}
}

37 
ems_št
 
	$ems_sy¡emcmd
(
ems_cch¬
 *
cmd
)

39 
	`ems_as£¹
(
cmd
);

40 ià(!
cmd
)

41  
EMS_ERR
;

43 
	`ems_l_Œaû
("\033[00;31m >>>>>>>: % \033[00m", 
cmd
);

45  
	`sy¡em
(
cmd
);

46 
	}
}

48 
ems_void
 
	$ems_sighªdËr
(
ems_št
 
sig
)

50 
	`årštf
(
¡dout
, "sigÇÈgÙ %d\n", 
sig
);

51 
	`lÚgjmp
(
jm·ddr
,1);

52 
	}
}

55 
jsÚ_objeù
 *
	$ems_jsÚ_tok’”_·r£
(
ems_cch¬
 *
¡r
)

57 
jsÚ_tok’”_”rÜ
 
”r
;

58 
jsÚ_objeù
 *
roÙ
;

60 
	`ems_as£¹
(
¡r
 !ğ
NULL
);

61 ià(!
¡r
)

62  
NULL
;

64 
roÙ
 = 
	`jsÚ_tok’”_·r£_v”bo£
(
¡r
, &
”r
);

66 ià(
”r
 !ğ
jsÚ_tok’”_sucûss
) {

67 
	`ems_l_w¬n
("<< \033[01;32m JSON ERROR: %s:%s \033[00m>>>>",

68 
¡r
, 
	`jsÚ_tok’”_”rÜ_desc
(
”r
));

69  
NULL
;

72  
roÙ
;

73 
	}
}

75 
ems_št
 
	$ems_cÜe_š™
(
ems_cÜe
 *
cÜe
)

77 
	`ems_as£¹
(
cÜe
);

79 
	`mem£t
(
cÜe
, 0, (
ems_cÜe
));

81 
	`ems_bufãr_š™
(&
cÜe
->
buf
, 
EMS_BUFFER_8k
);

82 
	`¡r_š™
(&
cÜe
->
gw
);

83 
	`¡r_š™
(&
cÜe
->
iâame
);

84 
	`¡r_š™
(&
cÜe
->
ac_mac
);

85 
	`¡r_š™
(&
cÜe
->
pÜl
);

86 
	`¡r_š™
(&
cÜe
->
ssid
);

87 
	`¡r_š™
(&
cÜe
->
devty
);

88 
	`¡r_š™
(&
cÜe
->
¢
);

89 
cÜe
->
pÜl_»dœeù_pÜt
 = 0;

91 
	`ems_queue_š™
(&
cÜe
->
msg_’Œy
);

92 
	`ems_mtx_š™
(
cÜe
->
msg_mtx
);

94 
	`ems_ev’t_š™
(&
cÜe
->
evt
, 
EVT_DRIVER_EPOLL
);

95 
cÜe
->
æg
 = 0;

96 
	`ems_queue_š™
(&
cÜe
->
­p_’Œy
);

98 #iâdeà
DEBUG


99 
	`cfg_š™
(&
cÜe
->
cfg
, "/usr/ems/conf/ems.cfg");

101 
	`cfg_š™
(&
cÜe
->
cfg
, "/tmp/ems/conf/ems.cfg");

104 
	`ems_­p_moduËs_š™
();

106  
EMS_OK
;

107 
	}
}

109 
ems_št
 
	$ems_cÜe_unš™
(
ems_cÜe
 *
cÜe
)

111 
	`ems_­p_moduËs_unš™
();

113 
	`ems_ev’t_dÚe
(&
cÜe
->
evt
);

114 
	`cfg_unš™
(&
cÜe
->
cfg
);

115 
	`ems_queue_ş—r
(&
cÜe
->
­p_’Œy
, 
ems_­p
, 
’Œy
, 
ems_­p_de¡roy
);

116 
	`ems_bufãr_unš™
(&
cÜe
->
buf
);

118 
	`¡r_unš™
(&
cÜe
->
gw
);

119 
	`¡r_unš™
(&
cÜe
->
iâame
);

120 
	`¡r_unš™
(&
cÜe
->
ac_mac
);

121 
	`¡r_unš™
(&
cÜe
->
pÜl
);

122 
	`¡r_unš™
(&
cÜe
->
ssid
);

123 
	`¡r_unš™
(&
cÜe
->
devty
);

124 
	`¡r_unš™
(&
cÜe
->
¢
);

126 
	`ems_queue_ş—r
(&
cÜe
->
msg_’Œy
, 
msgqueue
, 
’Œy
, 
ems_mq_de¡roy
);

127 
	`ems_queue_š™
(&
cÜe
->
msg_’Œy
);

128 
	`ems_mtx_de¡roy
(
cÜe
->
msg_mtx
);

130  
EMS_OK
;

131 
	}
}

133 
ems_št
 
	$cÜe_·ck_»q
(
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
g
)

135 
ems_cch¬
 *
ùx
 = 
NULL
;

136 
ems_št
 
Ën
, 
¹n
;

138 
jsÚ_objeù
 *
roÙ
 = (jsÚ_objeù *)
	`£ss_»que¡
(
£ss
);

140 
ùx
 = 
NULL
;

141 
Ën
 = 0;

142 ià(
roÙ
) {

143 
ùx
 = 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
roÙ
);

144 
Ën
 = 
	`ems_¡¾’
(
ùx
);

147 
g
 = (
EMS_MODULE_AC
 << 16) |ag;

149 
	`ems_l_Œaû
("\033[01;33m <reqag: 0x%x, ctx: %s> \033[00m",

150 
g
 , 
ùx
?ctx:"null");

152 
¹n
 = 
	`ems_·ck_»q
(
g
, 
ùx
, 
Ën
, &
£ss
->
buf
);

154 ià(
roÙ
) {

155 
	`jsÚ_objeù_put
(
roÙ
);

156 
	`£ss_»que¡_£t
(
£ss
, 
NULL
);

159  
¹n
;

161 
	}
}

163 
ems_št
 
	$cÜe_·ck_r¥
(
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
g
, 
ems_št
 
¡
)

165 
ems_cch¬
 *
ùx
 = 
NULL
;

166 
ems_št
 
Ën
, 
¹n
;

168 
jsÚ_objeù
 *
roÙ
 = (jsÚ_objeù *)
	`£ss_»¥Ú£
(
£ss
);

170 
ùx
 = 
NULL
;

171 
Ën
 = 0;

172 ià(
roÙ
) {

173 
ùx
 = 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
roÙ
);

174 
Ën
 = 
	`ems_¡¾’
(
ùx
);

177 
	`ems_l_Œaû
("\033[01;34m<rspag: 0x%x, st: %d ctx(0x%x): %s> \033[00m",

178 
g
 | 0x80000000, 
¡
, 
Ën
,

179 (
Ën
 < 1024)?(
ùx
?ctx:"no ctx"):"******TOO LONG *****");

181 
¹n
 = 
	`ems_·ck_r¥
(
g
, 
¡
, 
ùx
, 
Ën
, &
£ss
->
buf
);

183 ià(
roÙ
) {

184 
	`jsÚ_objeù_put
(
roÙ
);

185 
	`£ss_»¥Ú£_£t
(
£ss
, 
NULL
);

188  
¹n
;

189 
	}
}

191 
ems_cch¬
 *
	$ems_¡rÿt
(
ems_cch¬
 *
s1
,ƒms_cch¬ *
s2
)

193 
ems_ch¬
 
buf
[512] = {0};

195 
	`¢´štf
(
buf
, 512, "%s% 2&>/dev/nuÎ", 
s1
, 
s2
);

196  
buf
;

197 
	}
}

199 
ems_št
 
	$ems_æush_sy¡em_šfo
()

201 
ems_cfg
 *
cfg
 = 
	`emscfg
();

202 
ems_ch¬
 
buf
[256] = {0};

203 
ems_cch¬
 *
iâame
 = 
NULL
;

204 
ems_cch¬
 *
cmd
 = "uci get -P /tmp/state ";

206 
	`cÜe_gw_iâame_ş—r
();

207 
	`cÜe_gw_addr_ş—r
();

209 
	`cfg_£t
(
cfg
, 
CFG_Ïn_iâame
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_lan_ifname)));

210 
	`cfg_£t
(
cfg
, 
CFG_Ïn_´Ùo
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_lan_proto)));

211 
	`cfg_£t
(
cfg
, 
CFG_Ïn_addr
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_lan_addr)));

212 
	`cfg_£t
(
cfg
, 
CFG_Ïn_mask
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_lan_mask)));

213 
	`cfg_£t
(
cfg
, 
CFG_Ïn_gw
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_lan_gw)));

215 
iâame
 = 
	`cfg_g‘
(
cfg
, 
CFG_Ïn_iâame
);

216 ià(!
	`cfg_g‘
(
cfg
, 
CFG_Ïn_addr
)) {

217 
	`¢´štf
(
buf
, (buf),

218 "ifcÚfig % | g»°š‘ |‡wk '{´šˆ$2}' | cuˆ-d: -f2-", 
iâame
);

219 
	`cfg_£t
(
cfg
, 
CFG_Ïn_addr
, 
	`ems_pİ’_g‘
(
buf
));

222 ià(!
	`cfg_g‘
(
cfg
, 
CFG_Ïn_mask
)) {

223 
	`¢´štf
(
buf
, (buf),

224 "ifcÚfig % | g»°š‘ |‡wk '{´šˆ$4}' | cuˆ-d: -f2-", 
iâame
);

225 
	`cfg_£t
(
cfg
, 
CFG_Ïn_mask
, 
	`ems_pİ’_g‘
(
buf
));

228 ià(!
	`cfg_g‘
(
cfg
, 
CFG_Ïn_gw
)) {

229 
	`¢´štf
(
buf
, (buf),

230 "„ou‹ | g»°'deçuÉ*.*%s' |‡wk '{´šˆ$3}'", 
iâame
);

231 
	`cfg_£t
(
cfg
, 
CFG_Ïn_gw
, 
	`ems_pİ’_g‘
(
buf
));

234 
	`cfg_£t
(
cfg
, 
CFG_wª_iâame
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_wan_ifname)));

236 
	`cfg_£t
(
cfg
, 
CFG_wª_addr
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_wan_addr)));

237 
	`cfg_£t
(
cfg
, 
CFG_wª_mask
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_wan_mask)));

238 
	`cfg_£t
(
cfg
, 
CFG_wª_gw
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_wan_gw)));

240 
	`cfg_£t
(
cfg
, 
CFG_wª_´Ùo
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_wan_proto)));

242 
iâame
 = 
	`cfg_g‘
(
cfg
, 
CFG_wª_iâame
);

244 ià(!
	`cfg_g‘
(
cfg
, 
CFG_wª_addr
))

247 
	`¢´štf
(
buf
, (buf),

248 "ifcÚfig % | g»°š‘ |‡wk '{´šˆ$2}' | cuˆ-d: -f2-", 
iâame
);

249 
	`cfg_£t
(
cfg
, 
CFG_wª_addr
, 
	`ems_pİ’_g‘
(
buf
));

253 ià(!
	`cfg_g‘
(
cfg
, 
CFG_wª_mask
))

256 
	`¢´štf
(
buf
, (buf),

257 "ifcÚfig % | g»°š‘ |‡wk '{´šˆ$4}' | cuˆ-d: -f2-", 
iâame
);

258 
	`cfg_£t
(
cfg
, 
CFG_wª_mask
, 
	`ems_pİ’_g‘
(
buf
));

262 ià(!
	`cfg_g‘
(
cfg
, 
CFG_wª_gw
))

265 
	`¢´štf
(
buf
, (buf),

266 "„ou‹ | g»°'deçuÉ*.*%s' |‡wk '{´šˆ$3}'", 
iâame
);

267 
	`cfg_£t
(
cfg
, 
CFG_wª_gw
, 
	`ems_pİ’_g‘
(
buf
));

270 
	`cÜe_wœ–ess_šfo
();

272  
EMS_OK
;

273 
	}
}

275 
ems_št
 
	$cÜe_wœ–ess_šfo
()

277 
ems_cfg
 *
cfg
 = 
	`emscfg
();

278 
ems_cch¬
 *
cmd
 = "uci get -P /tmp/state ";

280 
	`cfg_£t
(
cfg
, 
CFG_wœ–ess_iâame
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_wireless_ifname)));

281 
	`cfg_£t
(
cfg
, 
CFG_wœ–ess_ssid
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_wireless_ssid)));

282 
	`cfg_£t
(
cfg
, 
CFG_wœ–ess_’üy±
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_wireless_encrypt)));

283 
	`cfg_£t
(
cfg
, 
CFG_wœ–ess_key
, 
	`ems_pİ’_g‘
(
	`ems_¡rÿt
(
cmd
, CFG_wireless_key)));

285 
ems_cch¬
 *
v®
 = 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_’üy±
);

287 ià(
v®
 && 
	`¡r¡r
(val, "wep")) {

288 
ems_ch¬
 
buf
[256] = {0};

289 
	`¢´štf
(
buf
, (buf), "% %s1", 
cmd
, 
CFG_wœ–ess_key
);

290 
	`cfg_£t
(
cfg
, 
CFG_wœ–ess_key
, 
	`ems_pİ’_g‘
(
buf
));

292 
	`¢´štf
(
buf
, (buf), "%s", 
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_key
));

293 
	`ems_l_Œaû
("Ü˜key: %s", 
buf
);

295 ià(!
	`¡ºcmp
("s:", 
buf
, 2))

296 
	`cfg_£t
(
cfg
, 
CFG_wœ–ess_key
, 
buf
 + 2);

300  
EMS_OK
;

301 
	}
}

303 
ems_ch¬
 *
	$ems_­mac
()

305 
ems_cch¬
 *
cmd
 = "hexdump -s 0x28 -n 6 -C /dev/mtd2 | head -1 |‡wk '{printf(\"%02s:%02s:%02s:%02s:%02s:%02s\", $2, $3, $4, $5, $6, $7)}'";

306 
ems_ch¬
 
buf
[32];

308 
	`¢´štf
(
buf
, (buf), "%s", 
	`ems_pİ’_g‘
(
cmd
));

310  
buf
;

311 
	}
}

313 
ems_št
 
	$ems_v®id_¢
(
ems_ch¬
 *
¢
)

315 
ems_ch¬
 
c
;

317 *
¢
) {

318 
c
 = *
¢
++;

320 ià(!
	`i§Êum
(
c
))

321  
EMS_NO
;

324  
EMS_YES
;

325 
	}
}

327 
ems_ch¬
 *
	$ems_­¢
()

329 
ems_ch¬
 
¢
[32] = {0};

330 
ems_ch¬
 
buf
[64] = {0};

331 
ems_cch¬
 *
cmd
 = 
NULL
;

333 
cmd
 = "hexdump -s 0x100 -n 16 -C /dev/mtd2 | head -1 |‡wk '{print $2$3$4$5$6$7$8$9$10$11$12$13$14$15$16$17}'";

335 
	`¢´štf
(
buf
, (buf), "%s", 
	`ems_pİ’_g‘
(
cmd
));

336 
	`mem£t
(
¢
, 0, (sn));

337 
	`ems_¡r2bš
(
buf
, 
¢
, 32);

339 ià(!
	`ems_v®id_¢
(
¢
)) {

340 
cmd
 = "hexdump -s 0x28 -n 6 -C /dev/mtd2 | head -1 |‡wk '{print $2$3$4$5$6$7}'";

341 
	`¢´štf
(
¢
, (¢), "%s", 
	`ems_pİ’_g‘
(
cmd
));

344  
¢
;

345 
	}
}

347 
ems_ch¬
 *
	$ems_deviûty³
()

349 
ems_ch¬
 
buf
[32];

350 
	`¢´štf
(
buf
, 32, "%s", 
	`ems_pİ’_g‘
("cat /proc/cpuinfo |grep machine | cut -d: -f2-"));

351  
buf
;

352 
	}
}

354 
ems_cch¬
 *
	$ems_sys_v”siÚ
()

356  
	`ems_pİ’_g‘
("cat /etc/lkwifi2000_ver");

358 
	}
}

361 
ems_št
 
	$cÜe_cfg_š™
(
ems_cÜe
 *
cÜe
)

363 
ems_cfg
 *
cfg
 = &
cÜe
->cfg;

365 
	`cfg_»ad
(
cfg
);

367 ià(!
	`cfg_g‘
(
cfg
, 
CFG_ems_c_addr
))

368 
	`cfg_£t
(
cfg
, 
CFG_ems_c_addr
, 
EMS_ADDR
);

370 ià(!
	`cfg_g‘
(
cfg
, 
CFG_ems_c_pÜt
))

371 
	`cfg_£t
(
cfg
, 
CFG_ems_c_pÜt
, 
	`ems_™ß
(
EMS_PORT
));

374 ià(!
	`cfg_g‘
(
cfg
, 
CFG_ems_s_addr
))

375 
	`cfg_£t
(
cfg
, 
CFG_ems_s_addr
, "udc.cengbar.com");

377 ià(!
	`cfg_g‘
(
cfg
, 
CFG_ems_s_pÜt
))

378 
	`cfg_£t
(
cfg
, 
CFG_ems_s_pÜt
, "80");

380 ià(!
	`cfg_g‘
(
cfg
, 
CFG_ems_¢
))

381 
	`cfg_£t
(
cfg
, 
CFG_ems_¢
, 
	`ems_­¢
());

383 ià(!
	`cfg_g‘
(
cfg
, 
CFG_ems_mac
))

384 
	`cfg_£t
(
cfg
, 
CFG_ems_mac
, 
	`ems_­mac
());

386 
	`cfg_£t
(
cfg
, 
CFG_ems_deviûty³
, 
	`ems_deviûty³
());

388 ià(!
	`cfg_g‘
(
cfg
, 
CFG_ems_c_auto
))

389 
	`cfg_£t
(
cfg
, 
CFG_ems_c_auto
, "1");

391 
	`cfg_£t
(
cfg
, 
CFG_ems_sy¡em_v”siÚ
, 
	`ems_sys_v”siÚ
());

393 ià(!
	`cfg_g‘
(
cfg
, 
CFG_wœ–ess_’abË_’üy±
))

394 
	`cfg_£t
(
cfg
, 
CFG_wœ–ess_’abË_’üy±
, "0");

396 
	`cfg_wr™e
(
cfg
);

398  
EMS_OK
;

399 
	}
}

401 
ems_št
 
	$cÜe_g‘¬gs
(
ems_cÜe
 *
cÜe
, 
ems_št
 
¬gc
, 
ems_ch¬
 **
¬gv
)

403 
ems_št
 
c
;

405 (
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "c:")) != -1) {

407 
c
) {

410 
	`¡r_£t
(&
cÜe
->
cfg
.
æ
, 
İrg
);

413 
	`ems_l_”rÜ
("u§ge: % -øcÚfig fe\n", 
¬gv
[0]);

414  
EMS_ERR
;

418  
	`cÜe_cfg_š™
(
cÜe
);

419 
	}
}

421 
msgqueue
 *
	$ems_mq_Ãw
()

423 
msgqueue
 *
mq
 = (msgqueu*)
	`ems_m®loc
((msgqueue));

425 ià(
mq
) {

426 
	`mem£t
(
mq
, 0, (
msgqueue
));

427 
	`ems_queue_š™
(&
mq
->
’Œy
);

430  
mq
;

431 
	}
}

433 
ems_void
 
	$ems_mq_de¡roy
(
msgqueue
 *
mq
)

435 ià(
mq
) {

436 ià(
mq
->
obj
) {

437 
	`jsÚ_objeù_put
(
mq
->
obj
);

438 
mq
->
obj
 = 
NULL
;

441 
	`ems_ä“
(
mq
);

443 
	}
}

445 #ifdeà
DEBUG


446 
ems_cch¬
 *
ems_­p_desc
(
ems_ušt
 
ty
);

447 
ems_cch¬
 *
ems_evt_desc
(
ems_ušt
 
evt
);

450 
ems_št
 
	$ems_£nd_mes§ge
(
ems_ušt
 
s
,ƒms_ušˆ
d
,ƒms_ušˆ
evt
, 
jsÚ_objeù
 *
obj
)

452 
ems_cÜe
 *
cÜe
 = 
	`emscÜ”
();

453 
msgqueue
 *
mq
 = 
	`ems_mq_Ãw
();

455 ià(!
mq
)

456  
EMS_ERR
;

458 
mq
->
s
 = s;

459 
mq
->
d
 = d;

460 
mq
->
evt
 =ƒvt;

461 
mq
->
obj
 = 
NULL
;

462 ià(
obj
) {

463 
mq
->
obj
 = 
	`ems_jsÚ_tok’”_·r£
(
	`jsÚ_objeù_to_jsÚ_¡ršg
(obj));

464 ià(!
mq
->
obj
) {

465 
	`ems_mq_de¡roy
(
mq
);

466  
EMS_ERR
;

470 
	`ems_l_Œaû
("send msg (%s --> %s, (%s, %s))",

471 
	`ems_­p_desc
(
s
),

472 
	`ems_­p_desc
(
d
),

473 
	`ems_evt_desc
(
evt
),

474 
mq
->
obj
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(mq->obj):"");

476 
	`ems_queue_š£¹_
(&
cÜe
->
msg_’Œy
, &
mq
->
’Œy
);

478  
EMS_OK
;

479 
	}
}

481 
ems_void
 
	$cÜe_evt_cb
(
ems_ev’t
 *
evt
)

483 
ems_queue
 *
p
;

484 
msgqueue
 *
mq
;

485 
ems_cÜe
 *
cÜe
 = 
	`emscÜ”
();

486 #ifdeà
DEBUG


487 
ems_ušt
 
út
 = 0;

489 
	`ems_l_Œaû
("evˆcb, cÁ: %u", ++
út
);

492 !
	`ems_queue_em±y
(&
cÜe
->
msg_’Œy
)) {

494 
p
 = 
	`ems_queue_h—d
(&
cÜe
->
msg_’Œy
);

495 
	`ems_queue_»move
(
p
);

497 
mq
 = 
	`ems_cÚš”_of
(
p
, 
msgqueue
, 
’Œy
);

499 
	`ems_­p_´oûss
(
mq
->
s
, mq->
d
, mq->
evt
, mq->
obj
);

500 
	`ems_mq_de¡roy
(
mq
);

502 
	}
}

504 
ems_št
 
	$ems_cÜe_maš
(
ems_cÜe
 *
cÜe
, 
ems_št
 
¬gc
, 
ems_ch¬
 **
¬gv
)

506 
	`¤ªdom
(
	`time
(
NULL
));

508 
	`sigÇl
(
SIGINT
, 
ems_sighªdËr
);

509 
	`sigÇl
(
SIGABRT
, 
ems_sighªdËr
);

510 
	`sigÇl
(
SIGKILL
, 
ems_sighªdËr
);

511 
	`sigÇl
(
SIGSTOP
, 
ems_sighªdËr
);

512 
	`sigÇl
(
SIGTERM
, 
ems_sighªdËr
);

515 ià(
	`cÜe_g‘¬gs
(
cÜe
, 
¬gc
, 
¬gv
è!ğ
EMS_OK
)

518 
	`ems_æush_sy¡em_šfo
();

520 ià(
	`ems_©oi
(
	`ems_pİ’_g‘
("uci get -P /tmp/state ykwifi.base.first_config"))) {

521 
	`ems_æag_£t
(
cÜe
->
æg
, 
FLG_FIRST_CONFIG
);

524 ià(!
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_wœ–ess_’abË_’üy±
))) {

525 
	`ems_l_Œaû
("reset wirelessƒncrypt method");

526 
	`ems_£twifi_nİasswÜd
();

529 ià(
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_ş›Á_subdomaš_’abË
)))

530 
	`ems_æag_£t
(
cÜe
->
æg
, 
FLG_SUBDOMAIN_ENABLE
);

532 ià(
	`¡rcmp
("127.0.0.1", 
	`cfg_g‘
(
	`emscfg
(), 
CFG_­p_pÜl_addr
))){

533 
	`ems_æag_£t
(
cÜe
->
æg
, 
FLG_CONFIG_READY
);

536 
	`ems_­p_´oûss
(0, 
ty_ù¾
, 
EMS_APP_START
, 
NULL
);

537 
	`ems_­p_´oûss
(0, 
ty_Ãt
, 
EMS_APP_START
, 
NULL
);

539 ià(!
	`£tjmp
(
jm·ddr
)) {

540 
	`ems_ev’t_run
(&
cÜe
->
evt
, 
cÜe_evt_cb
);

542 
	`ems_l_Œaû
("aaa got signal, doƒxit");

544 
	`ems_­p_moduËs_run
(
EMS_NO
);

547  
EMS_OK
;

548 
	}
}

	@src/core/ems_core.h

2 #iâdeà
EMS_CLIENT_CORE_HEADER_____


3 
	#EMS_CLIENT_CORE_HEADER_____


	)

5 
	~"ems_maš.h
"

6 
	~"jsÚ.h
"

8 
jsÚ_objeù
 *
ems_jsÚ_tok’”_·r£
(
ems_cch¬
 *
¡r
);

11 
	#ems_jsÚ_g‘_št64_def
(
roÙ
, 
key
, 
v®
, 
def
) do { \

12 
jsÚ_objeù
 *
obj
; \

13 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, 
key
); \

14 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_št
)) \

15 (
v®
èğ
	`jsÚ_objeù_g‘_št64
(
obj
); \

17 (
v®
èğ(
def
); \

18 } 0)

	)

20 
	#ems_jsÚ_g‘_št64
(
roÙ
, 
key
, 
v®
) do { \

21 
jsÚ_objeù
 *
obj
; \

22 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, 
key
); \

23 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_št
)) \

24 (
v®
èğ
	`jsÚ_objeù_g‘_št64
(
obj
); \

26  
MSG_ST_INVALID_ARG
; \

27 } 0)

	)

29 
	#ems_jsÚ_g‘_št_def
(
roÙ
, 
key
, 
v®
, 
def
) do { \

30 
jsÚ_objeù
 *
obj
; \

31 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, 
key
); \

32 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_št
)) \

33 (
v®
èğ
	`jsÚ_objeù_g‘_št
(
obj
); \

35 (
v®
èğ(
def
); \

36 } 0)

	)

38 
	#ems_jsÚ_g‘_št
(
roÙ
, 
key
, 
v®
) do { \

39 
jsÚ_objeù
 *
obj
; \

40 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, 
key
); \

41 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_št
)) \

42 (
v®
èğ
	`jsÚ_objeù_g‘_št
(
obj
); \

44  
MSG_ST_INVALID_ARG
; \

45 } 0)

	)

47 
	#ems_jsÚ_g‘_¡ršg_def
(
roÙ
, 
key
, 
¡r
, 
def
) do { \

48 
jsÚ_objeù
 *
obj
; \

49 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, 
key
); \

50 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)) \

51 
	`¡r_£t
((
¡r
), 
	`jsÚ_objeù_g‘_¡ršg
(
obj
)); \

53 
	`¡r_£t
((
¡r
), (
def
)); \

54 } 0)

	)

56 
	#ems_jsÚ_g‘_¡ršg
(
roÙ
, 
key
, 
¡r
) do { \

57 
jsÚ_objeù
 *
obj
; \

58 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, 
key
); \

59 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
)) \

60 
	`¡r_£t
((
¡r
), 
	`jsÚ_objeù_g‘_¡ršg
(
obj
)); \

62  
MSG_ST_INVALID_ARG
; \

63 } 0)

	)

65 
	#EMS_ADDR
 "0.0.0.0"

	)

66 
	#EMS_PORT
 9111

	)

67 
	#EMS_DNS_BIND
 9113

	)

68 
	#EMS_HTTP_PORT
 80

	)

	@src/core/ems_ctrl.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"ems_cmd.h
"

5 
	~"ems_¿dius.h
"

6 
	~"­p.h
"

7 
	~"ems_ù¾.h
"

10 
	#EMS_CMD_TIMEOUT
 3000

	)

12 
ems_št
 
ù¾_¡¬t
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

13 
ems_št
 
ù¾_¡İ³d
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

14 
ems_št
 
ù¾_nÜm®
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

15 
ems_št
 
ù¾_evt_run
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

17 
	$ems_št
 (*
	tù¾_evt_func
)(
	tems_ù¾
 *
	tù¾
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_ušt
 
	tæg
);

18 
ù¾_evt_func
 
ù¾_hªdËr
[] =

20 [
¡_¡¬t
] = 
ù¾_¡¬t
,

21 [
¡_¡İ³d
] = 
ù¾_¡İ³d
,

22 [
¡_nÜm®
] = 
ù¾_nÜm®
,

23 [
¡_max
] = 
NULL


24 
	}
};

26 
ems_void
 
evt_cmd_cb
 (
ems_£ssiÚ
 *
£ss
, 
ems_št
 
¡
,ƒms_šˆ
æg
);

27 
ems_void
 
timeout_cmd_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

29 
ems_št
 
ems_cmd_c
 (
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

30 
ems_št
 
ems_cmd_ù¾
 (
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

31 
ems_št
 
ems_cmd_¡©us
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

32 
ems_št
 
ems_cmd_bridge_»q
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

33 
ems_št
 
ems_cmd_bridge_hb
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

34 
ems_št
 
ems_cmd_bwli¡
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

36 
ems_št
 
ems_cmd_qos
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

37 
ems_št
 
ems_cmd_pÜl
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

38 
ems_št
 
ems_cmd_¿dius
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

40 
ems_št
 
ems_cmd_fw
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

41 
ems_št
 
ems_cmd_u£r
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

42 
ems_št
 
ems_cmd_wœ–ess
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

44 
ems_št
 
ems_cmd_‹¡_¿dius
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

45 
ems_št
 
ems_cmd_ÃtwÜk
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

46 
ems_št
 
ems_cmd_cÚfig
(
ems_cÜe
 *
cÜe
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
);

48 
ems_št


49 
	$ù¾_cmd_hªdË
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
jsÚ_objeù
 *
»q
, 
ems_ušt
 
msgid
)

51 
	`ems_l_Œaû
("<< \033[01;33m„eq: %s \033[00m>>",

52 
»q
?
	`jsÚ_objeù_to_jsÚ_¡ršg
(req): "no‡rg");

54 
msgid
 & 0x0000ffff) {

56 
CMD_EMS_C
:

57  
	`ems_cmd_c
(
	`emscÜ”
(), 
£ss
, 
»q
);

59 
CMD_EMS_CTRL
:

60  
	`ems_cmd_ù¾
(
	`emscÜ”
(), 
£ss
, 
»q
);

62 
CMD_EMS_STATUS
:

63  
	`ems_cmd_¡©us
(
	`emscÜ”
(), 
£ss
, 
»q
);

65 
CMD_EMS_BWLIST
:

66  
	`ems_cmd_bwli¡
(
	`emscÜ”
(), 
£ss
, 
»q
);

68 
CMD_EMS_QOS
:

69  
	`ems_cmd_qos
(
	`emscÜ”
(), 
£ss
, 
»q
);

71 
CMD_EMS_PORTAL
:

72  
	`ems_cmd_pÜl
(
	`emscÜ”
(), 
£ss
, 
»q
);

74 
CMD_EMS_RADIUS
:

75  
	`ems_cmd_¿dius
(
	`emscÜ”
(), 
£ss
, 
»q
);

77 
CMD_BRIDGE_REQ
:

78  
	`ems_cmd_bridge_»q
(
	`emscÜ”
(), 
£ss
, 
»q
);

80 
CMD_BRIDGE_HB
:

81  
	`ems_cmd_bridge_hb
(
	`emscÜ”
(), 
£ss
, 
»q
);

83 
CMD_EMS_FW
:

84  
	`ems_cmd_fw
(
	`emscÜ”
(), 
£ss
, 
»q
);

86 
CMD_EMS_USER
:

87  
	`ems_cmd_u£r
(
	`emscÜ”
(), 
£ss
, 
»q
);

89 
CMD_EMS_WIRELESS
:

90  
	`ems_cmd_wœ–ess
(
	`emscÜ”
(), 
£ss
, 
»q
);

93 
CMD_EMS_TEST_RADIUS
:

94  
	`ems_cmd_‹¡_¿dius
(
	`emscÜ”
(), 
£ss
, 
»q
);

96 
CMD_EMS_NETWORK
:

97  
	`ems_cmd_ÃtwÜk
(
	`emscÜ”
(), 
£ss
, 
»q
);

99 
CMD_EMS_CONFIG
:

100  
	`ems_cmd_cÚfig
(
	`emscÜ”
(), 
£ss
, 
»q
);

107  
EMS_ERR
;

108 
	}
}

111 
ems_št


112 
	$ù¾_cmd_´oûss_Úe
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_»que¡
 *
»q
)

114 
ems_št
 
¹n
;

115 
jsÚ_objeù
 *
roÙ
 = 
NULL
;

117 
	`ems_as£¹
(
»q
 && 
ù¾
 && 
£ss
);

118 
	`ems_as£¹
(
»q
->
Ën
 >ğ
SIZE_REQUEST
);

119 
	`ems_as£¹
(
	`buf_Ën
(&
£ss
->
buf_š
è>ğ
»q
->
Ën
);

121 ià(
»q
->
Ën
 >ğ(
SIZE_REQUEST
 + 
INTSIZE
))

123 
ems_št
 
Ën
;

124 
ems_ch¬
 *
p
, 
ch
;

126 
p
 = (
ems_ch¬
 *)(
	`buf_rd
(&
£ss
->
buf_š
è+ 
SIZE_REQUEST
);

127 
	`g‘wÜd
(
p
, 
Ën
);

129 ià(
Ën
 > 
»q
->len)

130  
EMS_ERR
;

132 
ch
 = 
p
[
Ën
];

133 
p
[
Ën
] = '\0';

134 
roÙ
 = 
	`ems_jsÚ_tok’”_·r£
(
p
);

135 
p
[
Ën
] = 
ch
;

138 
¹n
 = 
	`ù¾_cmd_hªdË
(
ù¾
, 
£ss
, 
roÙ
, 
»q
->
g
.
msg
);

140 ià(
roÙ
)

141 
	`jsÚ_objeù_put
(
roÙ
);

143 
	`cÜe_·ck_r¥
(
£ss
, 
»q
->
g
.
v®
, 
¹n
);

144 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
evt_cmd_cb
);

145 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_CMD_TIMEOUT
, 
timeout_cmd_cb
);

147 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf_š
, 
»q
->
Ën
, 
EMS_BUFFER_SEEK_CUR
);

148 
	`ems_bufãr_»äesh
(&
£ss
->
buf_š
);

150  
EMS_OK
;

151 
	}
}

154 
	#HTTP_NEWLINE
 "\r\n"

	)

155 
	#HTTP_GET
 "GET"

	)

156 
	#HTTP_POST
 "POST"

	)

157 
	#HTTP_HOST
 "Ho¡: "

	)

159 
ems_št
 
	$ù¾_msg_is_web
(
ems_£ssiÚ
 *
£ss
)

161 ià(!
	`¡ºcmp
(
	`buf_rd
(&
£ss
->
buf_š
), 
HTTP_GET
, 3))

162  
EMS_YES
;

164 ià(!
	`¡ºcmp
(
	`buf_rd
(&
£ss
->
buf_š
), 
HTTP_POST
, 4))

165  
EMS_YES
;

167  
EMS_NO
;

168 
	}
}

170 
ems_cch¬
 *
	$ems_cu¼’t_tm
()

172 
ems_ch¬
 
tm_buf
[128] = {0};

173 
time_t
 
tm
;

175 
	`time
(&
tm
);

176 
	`¢´štf
(
tm_buf
, Ñm_buf), "%s", 
	`ùime
(&
tm
));

177 
tm_buf
[
	`¡¾’
(tm_buf) -1] = '\0';

179  
tm_buf
;

180 
	}
}

182 
ems_št
 
	$ù¾_web_»dœeù_to_hom•age
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
)

184 
ems_št
 
Ën
;

185 
ems_bufãr
 *
buf
 = 
	`cÜe_bufãr
();

187 
Ën
 = 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf),

195 , 
	`ems_cu¼’t_tm
(), 
	`cÜe_gw_addr
());

197 
	`ems_bufãr_wr™e
(&
£ss
->
buf
, 
	`buf_rd
(buf), 
Ën
);

199 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
 | 
EMS_EVT_WRITE
, 
evt_cmd_cb
);

200 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_CMD_TIMEOUT
, 
timeout_cmd_cb
);

202 
	`ems_æag_£t
(
£ss
->
æg
, 
SESSION_FLAG_DIE_AFTER_SEND
);

204  
EMS_OK
;

205 
	}
}

207 
ems_št
 
	$ù¾_web_»dœeù_to_mgmt
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
)

209 
ems_št
 
Ën
;

210 
ems_bufãr
 *
buf
 = 
	`cÜe_bufãr
();

212 
Ën
 = 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf),

220 , 
	`ems_cu¼’t_tm
(), 
	`cÜe_gw_addr
());

222 
	`ems_bufãr_wr™e
(&
£ss
->
buf
, 
	`buf_rd
(buf), 
Ën
);

224 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
 | 
EMS_EVT_WRITE
, 
evt_cmd_cb
);

225 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_CMD_TIMEOUT
, 
timeout_cmd_cb
);

227 
	`ems_æag_£t
(
£ss
->
æg
, 
SESSION_FLAG_DIE_AFTER_SEND
);

229  
EMS_OK
;

230 
	}
}

232 #iâdeà
SKIP_ERROR


233 
ems_št
 
	$ù¾_web_»dœeù_to_”rÜ
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_bufãr
 *
buf
)

235 
ems_št
 
Ën
;

237 
Ën
 = 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf),

245 , 
	`ems_cu¼’t_tm
(), 
	`cÜe_gw_addr
());

247 
	`ems_bufãr_£ek_wr
(
buf
, 
Ën
, 
EMS_BUFFER_SEEK_CUR
);

249  
EMS_OK
;

250 
	}
}

253 
ems_št


254 
	$ù¾_web_»dœeù_to_§me_·ge
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_bufãr
 *
buf
, 
ems_cch¬
 *
¤cu¾
)

256 
ems_št
 
Ën
;

258 
Ën
 = 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf),

266 , 
	`ems_cu¼’t_tm
(), 
¤cu¾
?srcurl:"no");

268 
	`ems_bufãr_£ek_wr
(
buf
, 
Ën
, 
EMS_BUFFER_SEEK_CUR
);

270  
EMS_OK
;

271 
	}
}

273 
ems_ch¬
 *
	$ems_mac_upd©e
(
ems_ch¬
 *
d¡
, 
ems_cch¬
 *
¤c
)

275 *
¤c
) {

276 *
d¡
 = *
¤c
++;

278 ià(*
d¡
 == ':')

279 *
d¡
 = '-';

280 
d¡
++;

283  
d¡
;

284 
	}
}

286 
ems_ch¬
 *
	$ems_u£rmac
(
ems_cch¬
 *

)

288 
ems_ch¬
 
cmd
[128];

289 
ems_ch¬
 
buf
[32];

291 
	`¢´štf
(
cmd
, 128, "/sbš/¬°-À| g»°-v incom¶‘| g»°'(%s)' |‡wk '{´šˆ$4}'", 

);

292 
	`¢´štf
(
buf
, 32, "%s", 
	`ems_pİ’_g‘
(
cmd
));

294  
buf
;

295 
	}
}

297 
ems_št
 
	$ems_u¾’code
(
ems_bufãr
 *
d¡
,ƒms_bufã¸*
¤c
)

299 
ems_ch¬
 *
buf
 = 
NULL
;

300 
ems_št
 
Ën
 = 0, 
»t
;

303 
»t
 = 
EMS_ERR
;

305 
buf
 = 
	`u¾_’code
(
	`buf_rd
(
¤c
), 
	`buf_Ën
(src));

307 ià(!
buf
) ;

309 
Ën
 = 
	`ems_¡¾’
(
buf
);

311 
	`ems_l_Œaû
("u¾ƒncode: %s, buf_Ëá(%d),†’: %d", 
buf
, 
	`buf_Ëá
(
d¡
), 
Ën
);

313 ià(
Ën
 >ğ
	`buf_Ëá
(
d¡
)) ;

315 
	`ems_bufãr_wr™e
(
d¡
, 
buf
, 
Ën
);

317 
ems_ch¬
 *
ch
 = 
	`buf_wr
(
d¡
);

318 *
ch
 = '\0';

321 
»t
 = 
EMS_OK
;

324 ià(
buf
)

325 
	`ems_ä“
(
buf
);

327  
»t
;

328 
	}
}

330 
ems_št


331 
	$ems_g‘·¿ms
(
ems_£ssiÚ
 *
£ss
, 
ems_bufãr
 *
·¿m
)

333 
ems_št
 
Ën
;

334 
ems_bufãr
 *
buf
 = &
£ss
->
buf_š
;

335 
ems_ch¬
 *
p
, *
q
, *
’d”
;

337 
p
 = 
	`buf_rd
(
buf
);

339 ià(!
	`¡ºcmp
(
p
, 
HTTP_GET
, 3)) {

340 
p
 += 4;

341 } ià(!
	`¡ºcmp
(
p
, 
HTTP_POST
, 4)) {

342 
p
 += 5;

344 
	`ems_as£¹
(0 && "never show uphis†ine");

345  
EMS_ERR
;

348 
’d”
 = 
	`¡r¡r
(
p
, 
HTTP_NEWLINE
);

349 ià(!
’d”
) {

350 
	`ems_l_Œaû
("h—d”: %s", 
p
);

351  
EMS_ERR
;

354 *
’d”
 = '\0';

355 
’d”
 += 2;

356 
	`ems_bufãr_£ek_rd
(
buf
, 
	`abs
(
’d”
 - 
	`buf_rd
(buf)), 
EMS_BUFFER_SEEK_CUR
);

358 
q
 = 
	`¡rchr
(
p
, ' ');

359 ià(!
q
)

360  
EMS_ERR
;

361 *
q
 = '\0';

363 
Ën
 = 
	`abs
(
p
 - 
q
);

364 ià(
Ën
 > 
	`buf_Ëá
(
·¿m
)) {

365 
	`ems_l_Œaû
("·¿moØlÚgÒ“d %d > %d†eá)", 
Ën
, 
	`buf_Ëá
(
·¿m
));

366  
EMS_ERR
;

369 
Ën
 = 
	`¢´štf
(
	`buf_wr
(
·¿m
), 
	`buf_Ëá
Õ¬am), "%s", 
p
);

370 
	`ems_bufãr_£ek_wr
(
·¿m
, 
Ën
, 
EMS_BUFFER_SEEK_CUR
);

372 
	`ems_l_Œaû
("·¿m: %s", 
p
);

374  
EMS_OK
;

375 
	}
}

377 
ems_št
 
	$ems_g‘ho¡
(
ems_£ssiÚ
 *
£ss
, 
ems_bufãr
 *
ho¡
, 
ems_št
 *
³rm™
)

379 
ems_št
 
Ën
 = 0;

380 
ems_bufãr
 *
buf
 = &
£ss
->
buf_š
;

381 
ems_ch¬
 *
p
, *
’d”
;

383 
p
 = 
	`¡r¡r
(
	`buf_rd
(
buf
), 
HTTP_HOST
);

384 ià(!
p
)

385  
EMS_ERR
;

387 
p
 +ğ
	`¡¾’
(
HTTP_HOST
);

389 
’d”
 = 
	`¡r¡r
(
p
, 
HTTP_NEWLINE
);

390 ià(!
’d”
)

391  
EMS_ERR
;

393 *
’d”
 = '\0';

394 
’d”
 += 2;

395 
	`ems_bufãr_£ek_rd
(
buf
, 
	`abs
(
’d”
 - 
	`buf_rd
(buf)), 
EMS_BUFFER_SEEK_CUR
);

397 
Ën
 = 
	`¢´štf
(
	`buf_wr
(
ho¡
), 
	`buf_Ëá
(ho¡), "%s", 
p
);

398 
	`ems_bufãr_£ek_wr
(
ho¡
, 
Ën
, 
EMS_BUFFER_SEEK_CUR
);

400 ià(
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_SUBDOMAIN_ENABLE
)){

401 
jsÚ_objeù
 *
obj
;

402 
ems_ch¬
 *
comma
;

404 
comma
 = 
	`¡rchr
(
p
, ':');

405 ià(
comma
)

406 *
comma
 = '\0';

408 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

409 
	`jsÚ_objeù_objeù_add
(
obj
, "u¾", 
	`jsÚ_objeù_Ãw_¡ršg
(
p
));

411 ià(
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_fw
, 
EMS_APP_CHECK_SUBDOMAIN
, 
obj
è=ğ
EMS_YES
)

412 *
³rm™
 = 
EMS_YES
;

414 
	`jsÚ_objeù_put
(
obj
);

416 
	`ems_l_Œaû
("ho¡: %s", 
	`buf_rd
(
ho¡
));

418  
EMS_OK
;

419 
	}
}

421 
ems_cch¬
 *

422 
	$ems_¤cu¾
(
ems_£ssiÚ
 *
£ss
, 
ems_bufãr
 *
·¿m
,ƒms_bufã¸*
ho¡
, 
ems_št
 *
³rm™
)

424 
ems_št
 
¹n
;

427 
¹n
 = 
	`ems_g‘·¿ms
(
£ss
, 
·¿m
);

428 ià(
¹n
 !ğ
OK
) {

429 
	`ems_l_Œaû
("(%sí¬am toØlÚg", 
	`ems_sock_addr
(&
£ss
->
sock
));

433 
	#u¾_h—d”
 "h‰p://"

	)

434 
	`ems_bufãr_wr™e
(
ho¡
, 
u¾_h—d”
, 
	`¡¾’
(url_header));

435 
¹n
 = 
	`ems_g‘ho¡
(
£ss
, 
ho¡
, 
³rm™
);

436 ià(
¹n
 !ğ
OK
) {

437 
	`ems_l_Œaû
("(%s)did‚Ù g‘ ho¡s", 
	`ems_sock_addr
(&
£ss
->
sock
));

443 iàĞ!*
³rm™
 &&

444 
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_SUBDOMAIN_ENABLE
) &&

445 
	`š‘_addr
(
	`buf_rd
(
ho¡
è+ 7è!ğ
INADDR_NONE


448 
jsÚ_objeù
 *
obj
;

451 
ems_ch¬
 
¬g
[80] = {0};

452 
	`¢´štf
(
¬g
, ×rg), "%s", 
	`buf_rd
(
·¿m
));

454 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

455 
	`jsÚ_objeù_objeù_add
(
obj
, "¬g", 
	`jsÚ_objeù_Ãw_¡ršg
(
¬g
));

456 
	`jsÚ_objeù_objeù_add
(
obj
, "", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`buf_rd
(
ho¡
) + 7));

458 ià(
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_fw
, 
EMS_APP_CHECK_PARAM_APPLE_COM
, 
obj
è=ğ
EMS_YES
)

459 *
³rm™
 = 
EMS_YES
;

461 
	`jsÚ_objeù_put
(
obj
);

464 ià(
	`buf_Ëá
(
ho¡
è-1 < 
	`buf_Ën
(
·¿m
)) {

465 
	`ems_l_Œaû
("(%sè·¿m toØlÚg", 
	`ems_sock_addr
(&
£ss
->
sock
));

466 
¹n
 = 
EMS_ERR
;

470 
	`ems_bufãr_wr™e
(
ho¡
, 
	`buf_rd
(
·¿m
), 
	`buf_Ën
(param));

472 
ems_ch¬
 *
ch
 = 
	`buf_wr
(
ho¡
);

473 *
ch
 = '\0';

476 
	`ems_l_Œaû
("u¾(%d): %s", 
	`buf_Ën
(
ho¡
), 
	`buf_rd
(host));

477 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

479 ià(*
³rm™
) {

480 
	`ems_bufãr_wr™e
(&
£ss
->
buf_š
, 
	`buf_rd
(
ho¡
), 
	`buf_Ën
(host));

482 
ems_ch¬
 *
ch
 = 
	`buf_wr
(&
£ss
->
buf_š
);

483 *
ch
 = '\0';

486 ià(
	`ems_u¾’code
(&
£ss
->
buf_š
, 
ho¡
è!ğ
EMS_OK
) {

487 
	`ems_l_Œaû
("urloo†ong");

488 
¹n
 = 
EMS_ERR
;

493 
	`ems_l_Œaû
("¤cu¾: %s", 
	`buf_rd
(&
£ss
->
buf_š
));

495 
¹n
 = 
EMS_OK
;

499 ià(
¹n
 !ğ
OK
)

500  
NULL
;

502  
	`buf_rd
(&
£ss
->
buf_š
);

503 
	}
}

505 
ems_št


506 
	$ù¾_web_pÜl_fl_w™h
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_bufãr
 *
buf
, 
ems_cch¬
 *
d©e
,ƒms_cch¬ *
¤cu¾
)

508 
ems_št
 
¹n
;

509 
ems_ch¬
 
wÏnu£rmac
[32], 
wÏÇpmac
[32];

510 
ems_bufãr
 
¬g
;

512 
ems_cch¬
 *
wÏnu£r
 = 
	`ems_sock_addr
(&
£ss
->
sock
);

514 
	`ems_mac_upd©e
(
wÏnu£rmac
, 
	`ems_u£rmac
(
wÏnu£r
));

515 
	`ems_mac_upd©e
(
wÏÇpmac
, 
	`cÜe_ac_mac
());

517 
	`ems_bufãr_š™
(&
¬g
, 
EMS_BUFFER_2K
);

518 
	`mem£t
(
	`buf_wr
(&
¬g
), 0, 
	`buf_Ëá
(&arg));

520 
¹n
 = 
	`¢´štf
(
	`buf_wr
(&
¬g
), 
	`buf_Ëá
(&arg),

528 
wÏnu£r
, 
	`cÜe_¢
(), 
	`cÜe_ssid
(), 
wÏnu£rmac
, 
wÏÇpmac
, 
	`cÜe_deviûty³
(), core_sn());

530 
	`ems_bufãr_£ek_wr
(&
¬g
, 
¹n
, 
EMS_BUFFER_SEEK_CUR
);

531 ià(
¤cu¾
) {

532 
	`ems_bufãr_wr™e
(&
¬g
, "&¤cu¾=", 
	`¡¾’
("&srcurl="));

533 
	`ems_bufãr_wr™e
(&
¬g
, 
¤cu¾
, 
	`¡¾’
(srcurl));

536 #ifdeà
WEIXIN


537 
ems_ch¬
 *
tmpbuf
 = 
	`u¾_’code
(
	`buf_rd
(&
¬g
), 
	`buf_Ën
(&arg));

538 ià(
tmpbuf
) {

539 
	`ems_bufãr_wr™e
(&
¬g
, "&auth=", 
	`¡¾’
("&auth="));

540 
	`ems_bufãr_wr™e
(&
¬g
, 
tmpbuf
, 
	`¡¾’
(tmpbuf));

541 
	`ems_ä“
(
tmpbuf
);

545 
	`ems_l_Œaû
("¬gs: %s", 
	`buf_rd
(&
¬g
));

547 
¹n
 = 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf),

556 , 
d©e
,

557 
	`cÜe_pÜl_addr
(),

558 
	`cÜe_pÜl_»dœeù_pÜt
(),

559 
	`buf_rd
(&
¬g
));

561 
¹n
 =„Š < 
	`buf_Ëá
(
buf
) ?„tn: buf_left(buf);

562 
	`ems_bufãr_unš™
(&
¬g
);

564 
	`ems_bufãr_£ek_wr
(
buf
, 
¹n
, 
EMS_BUFFER_SEEK_CUR
);

566  
EMS_OK
;

567 
	}
}

569 
ems_cch¬
 *
	$ù¾_web_ÿÎback
(
ems_bufãr
 *
buf
)

571 
ems_ch¬
 *
p
, *
q
;

573 
	#NAS_CALLBACK
 "ÿÎback="

	)

575 
q
 = 
NULL
;

577 
p
 = 
	`¡r¡r
(
	`buf_rd
(
buf
), 
NAS_CALLBACK
);

578 ià(
p
) {

579 
q
 = 
p
 + 
	`¡¾’
(
NAS_CALLBACK
);

581 
p
 = 
	`¡rchr
(
q
, '&');

582 ià(
p
)

583 *
p
 = '\0';

586  
q
;

587 
	}
}

589 
ems_št


590 
	$ù¾_web_Çsšfo_fl_w™h
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_bufãr
 *
buf
, 
ems_cch¬
 *
d©e
,ƒms_cch¬ *
func
)

592 
ems_št
 
»s
;

593 
jsÚ_objeù
 *
r¥
, *
obj
;

594 
ems_cch¬
 *
ùx
 = 
NULL
;

595 
ems_cch¬
 *
wÏnu£r
 = 
	`ems_sock_addr
(&
£ss
->
sock
);

596 
ems_cch¬
 *
u£ºame
 = 
	`ems_­p_¿dius_u£ºame
(
wÏnu£r
);

598 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

599 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

601 
»s
 = 0;

602 ià(!
u£ºame
) {

603 
»s
 = 1;

604 
u£ºame
 = "";

607 
	`jsÚ_objeù_objeù_add
(
r¥
, "»suÉ", 
	`jsÚ_objeù_Ãw_št
(
»s
));

609 
ems_ch¬
 
wÏnu£rmac
[32], 
wÏÇpmac
[32];

611 
	`ems_mac_upd©e
(
wÏnu£rmac
, 
	`ems_u£rmac
(
wÏnu£r
));

612 
	`ems_mac_upd©e
(
wÏÇpmac
, 
	`cÜe_ac_mac
());

614 
	`jsÚ_objeù_objeù_add
(
obj
, "pÜl", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_pÜl_addr
()));

615 
	`jsÚ_objeù_objeù_add
(
obj
, "u£ºame", 
	`jsÚ_objeù_Ãw_¡ršg
(
u£ºame
));

616 
	`jsÚ_objeù_objeù_add
(
obj
, "wÏnu£rmac",
	`jsÚ_objeù_Ãw_¡ršg
(
wÏnu£rmac
));

617 
	`jsÚ_objeù_objeù_add
(
obj
, "wÏnu£r", 
	`jsÚ_objeù_Ãw_¡ršg
(
wÏnu£r
));

618 
	`jsÚ_objeù_objeù_add
(
obj
, "ssid", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_ssid
()));

619 
	`jsÚ_objeù_objeù_add
(
obj
, "wÏÇpmac", 
	`jsÚ_objeù_Ãw_¡ršg
(
wÏÇpmac
));

620 
	`jsÚ_objeù_objeù_add
(
obj
, "wÏÇcmac", 
	`jsÚ_objeù_Ãw_¡ršg
(
wÏÇpmac
));

621 
	`jsÚ_objeù_objeù_add
(
obj
, "wÏÇúame", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_¢
()));

622 
	`jsÚ_objeù_objeù_add
(
obj
, "deviûty³", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_deviûty³
()));

623 
	`jsÚ_objeù_objeù_add
(
obj
, "¢", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_¢
()));

624 
	`jsÚ_objeù_objeù_add
(
obj
, "ac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`cÜe_gw_addr
()));

626 
	`jsÚ_objeù_objeù_add
(
r¥
, "d©a", 
obj
);

628 
ùx
 = 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
r¥
);

630 ià(!
ùx
)

631 
ùx
 = "";

633 ià(!
func
)

634 
func
 = "afunc";

636 
	`ems_l_Œaû
("Çsg‘šfo: %s", 
ùx
);

638 
»s
 = 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf),

648 
d©e
, (
ems_št
)(
	`¡¾’
(
ùx
è+ sŒËn(
func
) + 3), func, ctx);

650 
	`ems_bufãr_£ek_wr
(
buf
, 
»s
, 
EMS_BUFFER_SEEK_CUR
);

652 
	`jsÚ_objeù_put
(
r¥
);

654  
EMS_OK
;

655 
	}
}

657 
ems_št
 
	$ù¾_web_»dœeù_to_pÜl
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
)

659 
ems_bufãr
 
·¿m
, 
ho¡
;

660 
ems_cch¬
 *
¤cu¾
 = 
NULL
;

661 
ems_bufãr
 *
buf
 = 
	`cÜe_bufãr
();

662 
ems_št
 
Ën
 = 0;

663 
ems_št
 
³rm™
 = 
EMS_NO
;

665 
	`ems_bufãr_š™
(&
·¿m
, 
EMS_BUFFER_1K
);

666 
	`ems_bufãr_š™
(&
ho¡
, 
EMS_BUFFER_1K
);

668 
	`mem£t
(
	`buf_wr
(&
·¿m
), 0, 
	`buf_size
(&param));

669 
	`mem£t
(
	`buf_wr
(&
ho¡
), 0, 
	`buf_size
(&host));

671 
¤cu¾
 = 
	`ems_¤cu¾
(
£ss
, &
·¿m
, &
ho¡
, &
³rm™
);

676 
	#PORTAL_PARAMS
 "/pÜl/?"

	)

677 
Ën
 = 9;

678 ià(
	`buf_Ën
(&
·¿m
è<ğ
Ën
) ;

679 ià(
	`¡ºcmp
(
	`buf_rd
(&
·¿m
), 
PORTAL_PARAMS
, 
Ën
)) ;

682 
Ën
 = 
	`¡¾’
(
NAS_INFO_URL
);

683 ià(
	`buf_Ën
(&
ho¡
è< 
Ën
) ;

685 ià(
	`¡ºcmp
(
NAS_INFO_URL
, 
	`buf_rd
(&
ho¡
), 
Ën
) &&

686 
	`¡ºcmp
("h‰p://Çsg‘šfo.com", 
	`buf_rd
(&
ho¡
), 
Ën
+2))

689 
	`ù¾_web_Çsšfo_fl_w™h
(
ù¾
, 
£ss
, 
buf
, 
	`ems_cu¼’t_tm
(), 
	`ù¾_web_ÿÎback
(&
·¿m
));

691 
hªdË_ov”
;

694 ià(
³rm™
) {

695 
	`ù¾_web_»dœeù_to_§me_·ge
(
ù¾
, 
£ss
, 
buf
, 
¤cu¾
);

697 #iâdeà
SKIP_ERROR


698 ià(
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_CONFIG_READY
)) {

699 
	`ù¾_web_pÜl_fl_w™h
(
ù¾
, 
£ss
, 
buf
, 
	`ems_cu¼’t_tm
(), 
¤cu¾
);

701 
	`ù¾_web_»dœeù_to_”rÜ
(
ù¾
, 
£ss
, 
buf
);

703 
ems_št
 
¡
 = 0;

704 
jsÚ_objeù
 *
roÙ
, *
emsc
;

706 
roÙ
 = 
	`jsÚ_objeù_Ãw_objeù
();

708 
	`ems_­p_´oûss
(
ty_ù¾
, 
ty_ş›Á
, 
EMS_APP_EMS_STATUS
, 
roÙ
);

709 
emsc
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, "ems_c");

710 ià(!
emsc
) ;

712 
	`ems_jsÚ_g‘_št_def
(
emsc
, "¡©us", 
¡
, 0);

715 
jsÚ_objeù
 *
obj_”r
;

716 
ems_št
 
”r
;

718 
obj_”r
 = 
	`jsÚ_objeù_objeù_g‘
(
emsc
, "err");

719 ià(!
obj_”r
) ;

721 
	`ems_jsÚ_g‘_št_def
(
obj_”r
, "code", 
”r
, 0);

722 iàĞ(
”r
 =ğ
RADIUS_ERR_CANNOT_CONNECT
) ||

723 (
”r
 =ğ
RADIUS_ERR_REJECT
) ||

724 (
”r
 =ğ
RADIUS_ERR_NETWORK
))

727 
¡
 = 0;

731 
	`jsÚ_objeù_put
(
roÙ
);

733 ià(
¡
 == 4)

734 
	`ù¾_web_»dœeù_to_”rÜ
(
ù¾
, 
£ss
, 
buf
);

736 
	`ems_as£¹
(
¡
 != 0 && "never be here");

737 
	`ù¾_web_pÜl_fl_w™h
(
ù¾
, 
£ss
, 
buf
, 
	`ems_cu¼’t_tm
(), 
¤cu¾
);

743 
	`ù¾_web_pÜl_fl_w™h
(
ù¾
, 
£ss
, 
buf
, 
	`ems_cu¼’t_tm
(), 
¤cu¾
);

747 
hªdË_ov”
:

749 
	`ems_bufãr_unš™
(&
·¿m
);

750 
	`ems_bufãr_unš™
(&
ho¡
);

752 
	`ems_l_Œaû
("sess(%s:%d): buffer†ength: %d",

753 
	`ems_sock_addr
(&
£ss
->
sock
),

754 
	`ems_sock_pÜt
(&
£ss
->
sock
),

755 
	`buf_Ën
(
buf
));

757 
	`ems_bufãr_wr™e
(&
£ss
->
buf
, 
	`buf_rd
(buf), 
	`buf_Ën
(buf));

758 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
 | 
EMS_EVT_WRITE
, 
evt_cmd_cb
);

759 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_CMD_TIMEOUT
, 
timeout_cmd_cb
);

761 
	`ems_æag_£t
(
£ss
->
æg
, 
SESSION_FLAG_DIE_AFTER_SEND
);

763  
EMS_OK
;

764 
	}
}

766 
ems_št
 
	$ù¾_web_msg_»dœeù
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
)

768 
	`ems_æag_£t
(
£ss
->
æg
, 
FLG_SESSION_IS_WEB
);

769 
	`ems_bufãr_ş—r
(
	`cÜe_bufãr
());

771 ià(
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_FIRST_CONFIG
)) {

772  
	`ù¾_web_»dœeù_to_hom•age
(
ù¾
, 
£ss
);

775 ià(
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_READY
)) {

776  
	`ù¾_web_»dœeù_to_pÜl
(
ù¾
, 
£ss
);

779  
	`ù¾_web_»dœeù_to_mgmt
(
ù¾
, 
£ss
);

780 
	}
}

782 
ems_št


783 
	$ù¾_cmd_´oûss
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
)

785 
ems_»que¡
 
»q
;

787 ià(
	`ems_æag_like
(
£ss
->
æg
, 
FLG_SESSION_IS_WEB
))

789 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

790  
EMS_CONTINUE
;

793 ià(
	`ù¾_msg_is_web
(
£ss
)) {

794 
ems_št
 
¹n
;

795 
¹n
 = 
	`ù¾_web_msg_»dœeù
(
ù¾
, 
£ss
);

796 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

797  
¹n
;

800 ià(
	`buf_Ën
(&
£ss
->
buf_š
è< 
SIZE_REQUEST
)

801  
EMS_CONTINUE
;

803 
	`ems_bufãr_´eãtch
(&
£ss
->
buf_š
, (
ems_ch¬
 *)
»q
.
v®
, 
SIZE_REQUEST
);

805 
»q
.
g
.
v®
 = 
	`Áohl
(req.tag.val);

806 
»q
.
Ën
 = 
	`Áohl
(req.len);

808 
	`ems_l_Œaû
("[ctrl]tag: 0x%.8X, msgid: 0x%.2X,†en: 0x%.4X",

809 
»q
.
g
.
v®
,„eq.g.
msg
,„eq.
Ën
);

811 ià(
»q
.
Ën
 >ğ
	`buf_size
(&
£ss
->
buf_š
))

812  
EMS_BUFFER_INSUFFICIENT
;

814 ià(
	`buf_Ën
(&
£ss
->
buf_š
è< 
»q
.
Ën
)

815  
EMS_CONTINUE
;

817  
	`ù¾_cmd_´oûss_Úe
(
ù¾
, 
£ss
, &
»q
);

818 
	}
}

821 
ems_št


822 
	$ù¾_cmd_»ad
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_št
 
æg
)

824 
ems_št
 
»t
, 
agaš
;

826 
	`ems_as£¹
(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
));

828 
agaš
 = 
EMS_YES
;

829 
»cv_agaš
:

830 
	`ems_bufãr_»äesh
(&
£ss
->
buf_š
);

831 
»t
 = 
	`£ss_»cv
(
£ss
, &£ss->
buf_š
);

833 ià(
»t
 <= 0) {

834 
»t
) {

836 -
EAGAIN
:

837 
agaš
 = 
EMS_NO
;

841  
EMS_ERR
;

845 
	`ù¾_cmd_´oûss
(
ù¾
, 
£ss
)) {

847 
EMS_CONTINUE
:

848 
EMS_OK
:

851 
EMS_ERR
:

853  
EMS_ERR
;

857 ià(
agaš
)

858 
»cv_agaš
;

860  
EMS_OK
;

861 
	}
}

863 
ems_št


864 
	$ù¾_cmd_wr™e
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_št
 
æg
)

866 
ems_št
 
»t
;

868 
	`ems_as£¹
(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
));

870 
»t
 = 
	`£ss_£nd
(
£ss
, &£ss->
buf
);

872 ià(
»t
 <= 0) {

873 
»t
) {

874 -
EAGAIN
:

878  
EMS_ERR
;

882 ià(
	`buf_Ën
(&
£ss
->
buf
) <= 0) {

884 ià(
	`ems_æag_like
(
£ss
->
æg
, 
SESSION_FLAG_DIE_AFTER_SEND
))

886  
EMS_ERR
;

889 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
evt_cmd_cb
);

890 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_CMD_TIMEOUT
, 
timeout_cmd_cb
);

891 
	`ems_bufãr_»äesh
(&
£ss
->
buf
);

894  
EMS_OK
;

895 
	}
}

898 
ems_void
 
	$evt_cmd_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

900 
ems_ù¾
 *
ù¾
 = (ems_ù¾ *)
	`£ss_cb¬g
(
£ss
);

902 
	`ems_l_Œaû
("sess(%d),ƒrr? %s, flg: %x",

903 
	`ems_sock_fd
(&
£ss
->
sock
),

904 
”r
?"yes":"no",

905 
æg
);

906 ià(
”r
)

907 
”r_out
;

910 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
) &&

911 
	`ù¾_cmd_»ad
(
ù¾
, 
£ss
, 
æg
))

913 
”r_out
;

916 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
) &&

917 
	`ù¾_cmd_wr™e
(
ù¾
, 
£ss
, 
æg
))

919 
”r_out
;

924 
”r_out
:

925 
	`ems_queue_»move
(&
£ss
->
’Œy
);

926 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
£ss
);

927 
	}
}

929 
ems_void
 
	$timeout_cmd_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

931 
	`ems_l_Œaû
("[ctrl]timeout for cmd sess(%d): %s:%d",

932 
	`ems_sock_fd
(&
£ss
->
sock
),

933 
	`ems_sock_addr
(&
£ss
->
sock
),

934 
	`ems_sock_pÜt
(&
£ss
->
sock
));

936 
	`ems_queue_»move
(&
£ss
->
’Œy
);

937 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
£ss
);

938 
	}
}

940 
ems_št


941 
	$ù¾_£ss_š
(
ems_ù¾
 *
ù¾
, 
ems_št
 
sockfd
, 
ems_cch¬
 *
addr
,ƒms_šˆ
pÜt
)

943 
ems_£ssiÚ
 *
£ss
 = 
NULL
;

945 
£ss
 = 
	`ems_£ssiÚ_Ãw
();

946 ià(!
£ss
)

947  
EMS_ERR
;

949 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
addr
);

950 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
pÜt
);

951 
	`ems_sock_£tfd
(&
£ss
->
sock
, 
sockfd
);

953 
	`ems_queue_š£¹_
(&
ù¾
->
cmd
, &
£ss
->
’Œy
);

955 
	`£ss_cb¬g_£t
(
£ss
, 
ù¾
);

956 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
evt_cmd_cb
);

957 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
EMS_CMD_TIMEOUT
, 
timeout_cmd_cb
);

959  
EMS_OK
;

960 
	}
}

962 
ems_št


963 
	$ù¾_acû±_Ãxt
(
ems_ù¾
 *
ù¾
, 
ems_št
 
sock
)

965 
ems_št
 
»t
;

966 
sockËn_t
 
Ën
;

967 
sockaddr_š
 
addr
;

969 
Ën
 = (
addr
);

970 
	`mem£t
(&
addr
, 0, (addr));

972 
»t
 = 
	`acû±
(
sock
, (
sockaddr
 *)&
addr
, &
Ën
);

974 ià(
»t
 < 0) {

975 
	`ems_Ï¡”r
()) {

977 
EINTR
:

978 
ECONNABORTED
:

979  
EMS_YES
;

981 
EAGAIN
:

982  
EMS_NO
;

985 
	`ems_l_Œaû
("[ù¾]acû±ƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

986  
NO
;

990 
	`ems_l_Œaû
("[ctrl] NEW connection (%d) from: %s:%d in",

991 
»t
, 
	`š‘_Áß
(
addr
.
sš_addr
), 
	`Áohs
×ddr.
sš_pÜt
));

993 
lšg”
 
lg
;

995 
lg
.
l_Úoff
 = 1;

996 
lg
.
l_lšg”
 = 2;

997 
	`£tsockİt
(
»t
, 
SOL_SOCKET
, 
SO_LINGER
, (
ems_cch¬
 *)&
lg
, (lg));

1000 ià(
	`ù¾_£ss_š
(
ù¾
, 
»t
, 
	`š‘_Áß
(
addr
.
sš_addr
), 
	`Áohs
×ddr.
sš_pÜt
)))

1002 
	`şo£
(
»t
);

1005  
EMS_YES
;

1006 
	}
}

1009 
ems_void
 
	$evt_ù¾_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

1011 
ems_ù¾
 *
ù¾
 = (ems_ù¾ *)
	`£ss_cb¬g
(
£ss
);

1013 
	`ems_as£¹
(
ù¾
);

1014 ià(
”r
) {

1015 
	`ems_as£¹
(0 && "should‚ever be here");

1016 
	`ù¾_chªge_¡©us
(
ù¾
, 
¡_¡İ³d
);

1018 
	`ù¾_chªge_¡©us
(
ù¾
, 
¡_¡¬t
);

1022 
	`ù¾_evt_run
(
ù¾
, 
£ss
, 
æg
);

1023 
	}
}

1025 
ems_št
 
	$ù¾_¡¬t
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1027 ià(!
ù¾
->
£ss
) {

1028 
ù¾
->
£ss
 = 
	`ems_£ssiÚ_Ãw
();

1029 ià(!
ù¾
->
£ss
)

1030  
	`ù¾_chªge_¡©us
(
ù¾
, 
¡_¡İ³d
);

1032 
	`ems_sock_£ddr
(&
ù¾
->
£ss
->
sock
, 
EMS_ADDR
);

1033 
	`ems_sock_£Üt
(&
ù¾
->
£ss
->
sock
, 
EMS_PORT
);

1036 
£ss
 = 
ù¾
->sess;

1038 ià(
	`ems_sock_be_£rv”
(&
£ss
->
sock
è!ğ
EMS_OK
)

1039  
	`ù¾_chªge_¡©us
(
ù¾
, 
¡_¡İ³d
);

1041 
	`£ss_cb¬g_£t
(
£ss
, 
ù¾
);

1042 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
evt_ù¾_cb
);

1044  
	`ù¾_chªge_¡©us
(
ù¾
, 
¡_nÜm®
);

1045 
	}
}

1047 
ems_št
 
	$ù¾_¡İ³d
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1049 
	`ems_as£¹
(
ù¾
);

1051 ià(
ù¾
->
£ss
) {

1052 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
ù¾
->
£ss
);

1053 
ù¾
->
£ss
 = 
NULL
;

1056 
	`ems_queue_ş—r
(&
ù¾
->
cmd
, 
ems_£ssiÚ
, 
’Œy
, 
ems_£ssiÚ_shutdown_ªd_de¡roy
);

1058  
EMS_OK
;

1059 
	}
}

1061 
ems_št
 
	$ù¾_nÜm®
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1063 
ems_št
 
Ãxt
;

1065 
	`ems_as£¹
(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
));

1067 ià(
	`ems_æag_uÆike
(
æg
, 
EMS_EVT_READ
))

1068  
EMS_OK
;

1071 
Ãxt
 = 
EMS_NO
;

1072 
Ãxt
 = 
	`ù¾_acû±_Ãxt
(
ù¾
, 
	`ems_sock_fd
(&
£ss
->
sock
));

1073 } 
Ãxt
);

1075  
EMS_OK
;

1076 
	}
}

1078 
ems_št


1079 
	$ù¾_evt_run
(
ems_ù¾
 *
ù¾
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1081 
	`ems_as£¹
(
ù¾
->
¡
 >ğ
¡_¡¬t
 && cŒl->¡ <ğ
¡_nÜm®
);

1083 ià(
ù¾_hªdËr
[
ù¾
->
¡
])

1084  
ù¾_hªdËr
[
ù¾
->
¡
](ù¾, 
£ss
, 
æg
);

1086  
EMS_OK
;

1087 
	}
}

1089 
ems_št
 
	$ù¾_chªge_¡©us
(
ems_ù¾
 *
ù¾
, 
ems_¡©us
 
¡
)

1091 
	`ems_l_Œaû
("[ctrl] change status: %s ===> %s",

1092 
	`ems_¡©us_¡r
(
ù¾
->
¡
),

1093 
	`ems_¡©us_¡r
(
¡
));

1095 
ù¾
->
¡
 = st;

1097 
¡
) {

1098 
¡_¡¬t
:

1099 
¡_¡İ³d
:

1100  
	`ù¾_evt_run
(
ù¾
, 
NULL
, 0);

1107  
EMS_OK
;

1108 
	}
}

	@src/core/ems_ctrl.h

1 #iâdeà
EMS_CONTROL_HEADER___


2 
	#EMS_CONTROL_HEADER___


	)

4 
_ems_ù¾_s
 
	tems_ù¾
;

6 
	s_ems_ù¾_s


8 
ems_£ssiÚ
 *
	m£ss
;

9 
ems_¡©us
 
	m¡
;

10 
ems_queue
 
	mcmd
;

13 
ems_št
 
ù¾_chªge_¡©us
(
ems_ù¾
 *
ù¾
, 
ems_¡©us
 
¡
);

	@src/core/ems_dns.c

1 
	~"ems_cÜe.h
"

2 
	~"ems_ş›Á.h
"

3 
	~"ems_fw.h
"

4 
	~"ems_dns.h
"

6 
ems_void
 
	$dns_fwd_timeout
(
ems_timeout
 *
timeout
)

8 
dns_u£r
 *
u£r
 = 
	`ems_cÚš”_of
(
timeout
, dns_u£r, 
to
);

10 
	`ems_l_Œaû
("---->>>>>>>> [DNS]TIMEOUT for user(%s:%d) <<<<<<<<----",

11 
	`š‘_Áß
(
u£r
->
addr
), u£r->
pÜt
);

13 
	`ems_queue_»move
(&
u£r
->
’Œy
);

14 
	`ems_hash_»move
(&
u£r
->
h_msg
);

15 
	`dns_u£r_ä“
(
u£r
);

16 
	}
}

19 
ems_void
 
	$dns_scheduË_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

21 
ems_fw
 *
fw
 = (ems_fw *)
	`£ss_cb¬g
(
£ss
);

23 
	`fw_dns_qu”y_Œig”
(
fw
);

24 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 10000, 
dns_scheduË_timeout_cb
);

25 
	}
}

27 
ems_št
 
	$dns_bšd
(
ems_£ssiÚ
 *
£ss
)

29 
fd
, 
rc
, 
İt
 = 1;

30 
sockaddr_š
 
addr
;

31 
ems_sock
 *
sock
 = &
£ss
->sock;

33 ià((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0)) == -1)

35 
	`ems_l_Œaû
("[dns]sock‘ƒ¼: %s", 
	`ems_Ï¡”rmsg
());

36  
EMS_ERR
;

39 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
İt
, (opt)) == -1)

41 
	`ems_l_Œaû
("[dns]£tsockİˆ”r: %s", 
	`ems_Ï¡”rmsg
());

42 
	`şo£
(
fd
);

43  
EMS_ERR
;

46 
	`mem£t
(&
addr
, 0, (addr));

47 
addr
.
sš_çmy
 = 
AF_INET
;

48 
addr
.
sš_pÜt
 = 
	`htÚs
(
EMS_DNS_BIND
);

49 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(0);

51 ià((
rc
 = 
	`bšd
(
fd
, (
sockaddr
 *)&
addr
, (
sockaddr_š
))) == -1)

53 
	`ems_l_Œaû
("”¸bšd: %s", 
	`ems_Ï¡”rmsg
());

54 
	`şo£
(
fd
);

55  
EMS_ERR
;

58 
	`ems_sock_£ddr
(
sock
, "0.0.0.0");

59 
	`ems_sock_£tfd
(
sock
, 
fd
);

60  
EMS_OK
;

61 
	}
}

63 
ems_št
 
	$fw_dns_push_fwd
(
ems_fw
 *
fw
, 
dns_u£r
 *
u£r
)

65 
	`ems_as£¹
(
fw
 && 
u£r
);

67 
	`ems_queue_š£¹_
(&
fw
->
fwd
, &
u£r
->
’Œy
);

68 
	`ems_hash_š£¹
(&
fw
->
hash_msg
, &
u£r
->
h_msg
);

70 
u£r
->
ùx
 = (
ems_void
 *)
fw
;

71 
	`ems_timeout_£t
(
	`timeou‹r
(), &
u£r
->
to
, 6000, 
dns_fwd_timeout
, 
EMS_TIMEOUT_SORT
);

73  
EMS_OK
;

74 
	}
}

81 
ems_št


82 
	$fw_dns_fwd
(
ems_fw
 *
fw
, 
ems_£ssiÚ
 *
£ss
, 
sockaddr_š
 *
äom
)

84 
dns_h—d”
 *
dns
 = 
NULL
;

85 
dns_u£r
 *
u£r
 = 
NULL
;

87 
	`ems_l_Œaû
("DNS„equest from(%s:%d),†ength: %d",

88 
	`š‘_Áß
(
äom
->
sš_addr
), 
	`Áohs
(äom->
sš_pÜt
), 
	`buf_Ën
(&
£ss
->
buf_š
));

90 
dns
 = (
dns_h—d”
 *)
	`buf_rd
(&
£ss
->
buf_š
);

92 
u£r
 = 
	`dns_fšd_u£r
(
fw
, 
	`Áohs
(
dns
->
id
));

93 ià(
u£r
) {

94 
	`ems_l_Œaû
("resend dns„equesto user: (%s: %d): 0x%x",

95 
	`š‘_Áß
(
u£r
->
addr
), u£r->
pÜt
, 
	`Áohs
(
dns
->
id
));

96 
	`ems_queue_»move
(&
u£r
->
’Œy
);

97 
	`ems_bufãr_ş—r
(&
u£r
->
buf
);

98 
	`ems_timeout_ÿnûl
(&
u£r
->
to
);

100 
u£r
 = 
	`dns_u£r_Ãw
();

101 ià(!
u£r
)

102  
EMS_OK
;

104 
	`memıy
(&
u£r
->
addr
, &
äom
->
sš_addr
, (
š_addr
));

105 
u£r
->
pÜt
 = 
	`Áohs
(
äom
->
sš_pÜt
);

107 
	`ems_l_Œaû
("new„equest: (%s:%d) id: 0x%x",

108 
	`š‘_Áß
(
u£r
->
addr
), u£r->
pÜt
, 
	`Áohs
(
dns
->
id
));

109 
	`ems_hash_fd_£t_key
(&
u£r
->
h_msg
, 
	`ems_hash_key
(0xfffà& 
	`Áohs
(
dns
->
id
)));

112 
	`ems_bufãr_wr™e
(&
u£r
->
buf
, 
	`buf_rd
(&
£ss
->
buf_š
), 
	`buf_Ën
(&sess->buf_in));

114 
	`fw_dns_push_fwd
(
fw
, 
u£r
);

115 
	`fw_dns_ş›Á_£t_wr™e
(
fw
, 
EMS_YES
);

117  
EMS_OK
;

118 
	}
}

121 
ems_št
 
	$fw_dns_»que¡
(
ems_fw
 *
fw
, 
ems_£ssiÚ
 *
£ss
)

123 
sockËn_t
 
Ën
;

124 
sockaddr_š
 
äom
;

125 
»t
;

126 
ems_bufãr
 *
buf
 = &
£ss
->
buf_š
;

128 
	`ems_as£¹
(
fw
->
£ss_bšd
 =ğ
£ss
);

130 
Ën
 = (
äom
);

131 
agaš
:

132 
»t
 = 
	`»cväom
(
	`ems_sock_fd
(&
£ss
->
sock
), 
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf), 0,

133 (
sockaddr
 *)&
äom
, &
Ën
);

135 ià(
»t
 <= 0) {

136  
EMS_OK
;

139 
	`ems_bufãr_£ek_wr
(
buf
, 
»t
, 
EMS_BUFFER_SEEK_CUR
);

141 
	`fw_dns_fwd
(
fw
, 
£ss
, &
äom
);

143 
	`ems_bufãr_ş—r
(
buf
);

145 
agaš
;

147  
EMS_OK
;

148 
	}
}

150 
ems_št
 
	$fw_dns_»¥Ú£
(
ems_fw
 *
fw
, 
ems_£ssiÚ
 *
£ss
)

152 
dns_u£r
 *
u£r
 = 
NULL
;

153 
ems_queue
 *
p
, *
q
;

154 
»t
;

155 
sockaddr_š
 
äom
;

157 
	`mem£t
(&
äom
, 0, (from));

159 
	`ems_queue_fÜ—ch_§ã
(&
fw
->
out
, 
p
, 
q
) {

160 
u£r
 = 
	`ems_cÚš”_of
(
p
, 
dns_u£r
, 
’Œy
);

162 
	`ems_as£¹
(
	`buf_Ën
(&
u£r
->
buf
) > 0);

164 
	`memıy
(&
äom
.
sš_addr
, &
u£r
->
addr
, (user->addr));

165 
äom
.
sš_pÜt
 = 
	`htÚs
(
u£r
->
pÜt
);

167 
»t
 = 
	`£ndto
(
	`ems_sock_fd
(&
£ss
->
sock
),

168 
	`buf_rd
(&
u£r
->
buf
),

169 
	`buf_Ën
(&
u£r
->
buf
),

171 (
sockaddr
 *)&
äom
,

172 (
sockaddr_š
));

174 ià(
»t
 <= 0)

177 
	`ems_bufãr_ş—r
(&
u£r
->
buf
);

178 
	`ems_queue_»move
(&
u£r
->
’Œy
);

179 
	`dns_u£r_ä“
(
u£r
);

182 ià(
	`ems_queue_em±y
(&
fw
->
out
))

183 
	`fw_dns_£rv”_£t_wr™e
(
fw
, 
EMS_NO
);

185  
EMS_OK
;

186 
	}
}

188 
ems_void
 
	$fw_dns_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

190 
ems_fw
 *
fw
 = (ems_fw *)
	`£ss_cb¬g
(
£ss
);

192 ià(
”r
) {

193 
	`ems_l_Œaû
("[fw] s”v” dn ”¸£ss: %d", 
	`ems_sock_fd
(&
£ss
->
sock
));

195 
	`fw_dns_£rv”_¡İ
(
fw
);

196 
	`fw_dns_be_£rv”
(
fw
);

200 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

201 
	`fw_dns_»que¡
(
fw
, 
£ss
);

204 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

205 
	`fw_dns_»¥Ú£
(
fw
, 
£ss
);

207 
	}
}

209 
ems_št
 
	$fw_dns_be_£rv”
(
ems_fw
 *
fw
)

211 
ems_£ssiÚ
 *
£ss
;

213 ià(!
fw
->
£ss_bšd
)

214 
fw
->
£ss_bšd
 = 
	`ems_£ssiÚ_Ãw
();

216 
£ss
 = 
fw
->
£ss_bšd
;

218 ià(
	`dns_bšd
(
£ss
è!ğ
EMS_OK
) {

219 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
£ss
);

220 
fw
->
£ss_bšd
 = 
NULL
;

221  
EMS_ERR
;

224 
	`£ss_cb¬g_£t
(
£ss
, 
fw
);

225 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
fw_dns_evt_cb
);

228 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 10000, 
dns_scheduË_timeout_cb
);

230 
	`ems_l_Œaû
("[fw] dns server (%d) %s",

231 
	`ems_sock_fd
(&
£ss
->
sock
), 
	`ems_sock_addr
(&sess->sock));

233  
EMS_OK
;

234 
	}
}

236 
ems_št
 
	$fw_dns_£rv”_¡İ
(
ems_fw
 *
fw
)

238 ià(
fw
->
£ss_bšd
) {

239 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
fw
->
£ss_bšd
);

240 
fw
->
£ss_bšd
 = 
NULL
;

243  
EMS_OK
;

244 
	}
}

246 
ems_št
 
	$fw_dns_£rv”_£t_wr™e
(
ems_fw
 *
fw
, 
ems_št
 
wr
)

248 
ems_£ssiÚ
 *
£ss
 = 
fw
->
£ss_bšd
;

249 
ems_št
 
evt
 = 0;

251 
evt
 |ğ
EMS_EVT_READ
;

252 ià(
wr
)

253 
evt
 |ğ
EMS_EVT_WRITE
;

255 
	`£ss_ev’t_£t
(
£ss
, 
evt
, 
fw_dns_evt_cb
);

257  
EMS_OK
;

258 
	}
}

260 
ems_št
 
	$dns_£t_que¡iÚ
(
ems_bufãr
 *
buf
, 
ems_cch¬
 *
u¾
)

262 
ems_cch¬
 *
p
, *
q
;

263 
ems_št
 
Ën
 = 0;

265 *
u¾
) {

266 
q
 = 
u¾
;

267 
p
 = 
	`¡rchr
(
q
, '.');

269 ià(!
p
) {

270 
Ën
 = 
	`¡¾’
(
q
);

271 
	`ems_bufãr_wr™e
(
buf
, (
ems_cch¬
 *)&
Ën
, 1);

272 
	`ems_bufãr_wr™e
(
buf
, 
q
, 
Ën
);

276 ià(
p
) {

277 
u¾
 = 
p
 + 1;

279 
Ën
 = 
	`abs
(
p
 - 
q
);

280 
	`ems_bufãr_wr™e
(
buf
, (
ems_cch¬
 *)&
Ën
, 1);

281 
	`ems_bufãr_wr™e
(
buf
, 
q
, 
Ën
);

285 
Ën
 = 0;

286 
	`ems_bufãr_wr™e
(
buf
, (
ems_cch¬
 *)&
Ën
, 1);

288  
EMS_OK
;

289 
	}
}

291 
ems_št
 
	$fw_dns_ü—‹_u£r
(
ems_fw
 *
fw
, 
dns_u¾
 *
u¾
, 
ems_shÜt
 
id
)

293 
dns_h—d”
 *
dns
 = 
NULL
;

294 
dns_u£r
 *
u£r
 = 
NULL
;

295 
ems_shÜt
 
tmp
 = 0;

297 
u£r
 = 
	`dns_u£r_Ãw
();

298 ià(!
u£r
)

299  
EMS_ERR
;

301 
dns
 = (
dns_h—d”
 *)
	`buf_rd
(&
u£r
->
buf
);

303 
	`ems_æag_£t
(
u£r
->
æg
, 
FLG_DNS_QUERY_SELF
);

305 
u£r
->
addr
.
s_addr
 = 
	`š‘_addr
("127.0.0.1");

306 
u£r
->
pÜt
 = 0;

308 
dns
->
id
 = 
	`htÚs
(id);

309 
dns
->
æg
 = 
	`htÚs
(0x0100);

310 
dns
->
qdcouÁ
 = 
	`htÚs
(0x0001);

311 
dns
->
ªcouÁ
 = 
	`htÚs
(0);

312 
dns
->
nscouÁ
 = 
	`htÚs
(0);

313 
dns
->
¬couÁ
 = 
	`htÚs
(0);

315 
	`ems_bufãr_£ek_wr
(&
u£r
->
buf
, (
dns_h—d”
), 
EMS_BUFFER_SEEK_CUR
);

317 
	`dns_£t_que¡iÚ
(&
u£r
->
buf
, 
	`¡r_‹xt
(&
u¾
->url));

318 
tmp
 = 
	`htÚs
(0x0001);

319 
	`ems_bufãr_wr™e
(&
u£r
->
buf
, (
ems_cch¬
 *)&
tmp
, (tmp));

320 
	`ems_bufãr_wr™e
(&
u£r
->
buf
, (
ems_cch¬
 *)&
tmp
, (tmp));

322 
	`ems_l_Œaû
("dn Œig” qu”y: %s", 
	`¡r_‹xt
(&
u¾
->url));

324 
	`ems_hash_fd_£t_key
(&
u£r
->
h_msg
, 
	`ems_hash_key
(0xfffà& 
	`Áohs
(
dns
->
id
)));

326 
	`fw_dns_push_fwd
(
fw
, 
u£r
);

328  
EMS_OK
;

329 
	}
}

331 
ems_št
 
	$fw_dns_u¾_šfo_u±
(
dns_u¾
 *
u¾
)

333 
ems_ch¬
 
buf
[512];

334 
ems_cch¬
 *
addr
, *
mask
;

336 
addr
 = 
	`¡r_‹xt
(&
u¾
->url);

338 
mask
 = 
	`¡rchr
(
addr
, '/');

339 ià(
mask
) {

340 
mask
++;

342 ià(*
mask
) {

343 
ems_št
 
Ën
 = 
	`abs
(
mask
 - 
addr
) - 1;

344 ià(
Ën
 >ğ(
buf
))

345 
Ën
 = (
buf
) - 1;

347 
	`mem£t
(
buf
, 0, (buf));

348 
	`memıy
(
buf
, 
addr
, 
Ën
);

350 
	`ems_l_Œaû
("upd©add»ss: % --> %s, mask(%s)", 
addr
, 
buf
, 
mask
);

352 
u¾
->
mask
 = 
	`ems_©oi
(mask);

353 ià(
u¾
->
mask
 < 0 || url->mask > 32) {

354 
	`ems_l_Œaû
("šv®id‚‘mask: %d", 
u¾
->
mask
);

355  
EMS_ERR
;

358 
	`ems_æag_£t
(
u¾
->
æg
, 
FLG_URL_IS_IPADDRESS
);

359 
	`¡r_£t
(&
u¾
->u¾, 
buf
);

363  
EMS_OK
;

364 
	}
}

366 
ems_št
 
	$fw_dns_qu”y_Œig”
(
ems_fw
 *
fw
)

368 
dns_u¾
 *
u¾
 = 
NULL
;

369 
ems_queue
 *
p
;

370 
š_addr
 
addr
;

371 
ems_shÜt
 
id
;

372 
id
 = 
	`¿nd
() % 35000;

374 
	`ems_queue_fÜ—ch
(&
fw
->
wh™–i¡
, 
p
) {

375 
u¾
 = 
	`ems_cÚš”_of
(
p
, 
dns_u¾
, 
’Œy
);

377 ià(
	`ems_æag_like
(
u¾
->
æg
, 
FLG_URL_IS_IPADDRESS
))

380 ià(
u¾
->
addr
) {

381 ià(
	`ems_æag_uÆike
(
u¾
->
æg
, 
FLG_URL_IS_IPADDRESS
)) {

382 
	`ems_æag_£t
(
u¾
->
æg
, 
FLG_DNS_QUERY_EXPIRED
);

386 ià(
	`fw_dns_u¾_šfo_u±
(
u¾
è!ğ
EMS_OK
)

389 
addr
.
s_addr
 = 
	`š‘_addr
(
	`¡r_‹xt
(&
u¾
->url));

390 ià(
addr
.
s_addr
 =ğ
INADDR_NONE
) {

391 ià(
	`ems_æag_uÆike
(
u¾
->
æg
, 
FLG_URL_IS_IPADDRESS
)) {

392 
	`fw_dns_ü—‹_u£r
(
fw
, 
u¾
, 
id
++);

395 
u¾
->
addr
 = (
š_addr
 *)
	`ems_m®loc
((addr));

396 ià(
u¾
->
addr
) {

397 
	`memıy
(
u¾
->
addr
, &addr, (addr));

398 
u¾
->
n_addr
 = 1;

399 
	`ems_æag_£t
(
u¾
->
æg
, 
FLG_URL_IS_IPADDRESS
);

400 
	`fw_u¾_£t_ä“
(
fw
, 
u¾
, 
EMS_YES
);

406 
	`ems_queue_fÜ—ch
(&
fw
->
subdomaš
, 
p
) {

407 
u¾
 = 
	`ems_cÚš”_of
(
p
, 
dns_u¾
, 
’Œy
);

408 
	`ems_æag_£t
(
u¾
->
æg
, 
FLG_DNS_QUERY_EXPIRED
);

411 ià(!
	`ems_queue_em±y
(&
fw
->
fwd
))

412 
	`fw_dns_ş›Á_£t_wr™e
(
fw
, 
EMS_YES
);

414  
EMS_OK
;

415 
	}
}

418 
ems_št
 
	$fw_dns_subdomaš_­³nd
(
ems_fw
 *
fw
, 
dns_u¾
 *
u¾
)

420 
	`ems_l_Œaû
("dn ­³nd u¾: %s", 
	`¡r_‹xt
(&
u¾
->url));

422 
	`ems_æag_£t
(
u¾
->
æg
, 
FLG_DNS_IS_SUBDOMAIN
);

423 
	`ems_hash_fd_£t_key
(&
u¾
->
h_u¾
, 
	`¡r_‹xt
(&url->url));

424 
	`ems_hash_š£¹
(&
fw
->
hash_u¾
, &
u¾
->
h_u¾
);

426 
fw
->
n_subdomaš
++;

427 
	`ems_queue_š£¹_
(&
fw
->
subdomaš
, &
u¾
->
’Œy
);

429 ià(
fw
->
n_subdomaš
 > 
MAX_SUB_DOMAIN
) {

430 
fw
->
n_subdomaš
--;

432 
u¾
 = 
	`ems_cÚš”_of
(
	`ems_queue_h—d
(&
fw
->
subdomaš
), 
dns_u¾
, 
’Œy
);

433 
	`ems_queue_»move
(&
u¾
->
’Œy
);

434 
	`ems_hash_»move
(&
u¾
->
h_u¾
);

435 
	`fw_u¾_£t_ä“
(
fw
, 
u¾
, 
EMS_NO
);

436 
	`ems_l_Œaû
("dn LRUrig”„emovu¾: %s", 
	`¡r_‹xt
(&
u¾
->url));

437 
	`dns_u¾_ä“
(
u¾
);

440  
EMS_OK
;

441 
	}
}

443 
ems_št
 
	$fw_dns_is_subdomaš
(
ems_fw
 *
fw
, 
ems_cch¬
 *
key
)

445 
dns_u¾
 *
u¾
;

446 
ems_queue
 *
p
;

448 
	`ems_queue_fÜ—ch
(&
fw
->
wh™–i¡
, 
p
) {

449 
u¾
 = 
	`ems_cÚš”_of
(
p
, 
dns_u¾
, 
’Œy
);

451 ià(
	`ems_æag_like
(
u¾
->
æg
, 
FLG_URL_IS_IPADDRESS
è|| u¾->
n_addr
 <= 0)

456 ià(
	`¡r¡r
(
key
, 
	`¡r_‹xt
(&
u¾
->url)))

457  
EMS_YES
;

460  
EMS_NO
;

461 
	}
}

464 
ems_št
 
	$fw_u¾_š_wh™–i¡
(
ems_fw
 *
fw
, 
ems_cch¬
 *
key
)

466 
dns_u¾
 *
u¾
 = 
NULL
;

468 
addršfo
 *
»s
, 
hšt
, *
cur
;

469 
ems_št
 
n_addr
, 
i
;

472 
u¾
 = 
	`dns_fšd_u¾
(
fw
, 
key
);

473 ià(
u¾
) {

474 ià(
	`ems_æag_like
(
u¾
->
æg
, 
FLG_DNS_IS_SUBDOMAIN
)) {

476 
	`ems_queue_»move
(&
u¾
->
’Œy
);

477 
	`ems_queue_š£¹_
(&
fw
->
subdomaš
, &
u¾
->
’Œy
);

479  
EMS_YES
;

482  
EMS_NO
;

485 ià(
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_SUBDOMAIN_ENABLE
) &&

486 
	`fw_dns_is_subdomaš
(
fw
, 
key
))

488 
u¾
 = 
	`dns_u¾_Ãw
();

489 ià(!
u¾
)

490  
EMS_NO
;

492 
	`¡r_£t
(&
u¾
->u¾, 
key
);

493 
	`fw_dns_subdomaš_­³nd
(
fw
, 
u¾
);

496 
	`fw_dns_ü—‹_u£r
(
fw
, 
u¾
, 
	`¿nd
()%65535);

497 
	`fw_dns_ş›Á_£t_wr™e
(
fw
, 
EMS_YES
);

500 
	`mem£t
(&
hšt
, 0, (hint));

502 
hšt
.
ai_çmy
 = 
AF_INET
;

503 
hšt
.
ai_sockty³
 = 
SOCK_DGRAM
 | 
SOCK_STREAM
;

504 
hšt
.
ai_æags
 = 
AI_PASSIVE
;

506 ià(
	`g‘addršfo
(
	`¡r_‹xt
(&
u¾
->u¾), 
NULL
, &
hšt
, &
»s
))

507  
EMS_NO
;

509 
n_addr
 = 0;

510 
cur
 = 
»s
; cu¸!ğ
NULL
; cu¸ğcur->
ai_Ãxt
)

511 
n_addr
++;

513 
u¾
->
addr
 =(
š_addr
 *)
	`ems_m®loc
((š_addrè* 
n_addr
);

514 ià(!
u¾
->
addr
) {

515 
	`ä“addršfo
(
»s
);

516  
EMS_NO
;

519 
u¾
->
n_addr
 =‚_addr;

521 
i
 = 0;

522 
cur
 = 
»s
; cu¸!ğ
NULL
; cu¸ğcur->
ai_Ãxt
)

524 
	`memıy
Ğ&
u¾
->
addr
[
i
],

525 &((
sockaddr_š
 *)(
cur
->
ai_addr
))->
sš_addr
,

526 (
š_addr
));

527 
i
++;

530 
	`ä“addršfo
(
»s
);

531 
	`fw_u¾_£t_ä“
(
fw
, 
u¾
, 
EMS_YES
);

533  
EMS_YES
;

536  
EMS_NO
;

537 
	}
}

	@src/core/ems_dns.h

2 #iâdeà
EMS_CLIENT_DNS_INTERCEPT_HEADER__


3 
	#EMS_CLIENT_DNS_INTERCEPT_HEADER__


	)

5 #´agm¨
·ck
(
push
, 1)

6 
	s_dns_h—d”_s
 {

7 
ems_shÜt
 
	mid
;

9 
ems_shÜt
 
	mæg
;

11 
	#DNS_QR
(
hdr
è((
	`Áohs
((hdr)->
æg
è& 0x8000è>> 15)

	)

12 
	#DNS_OPCODE
(
hdr
è((
	`Áohs
((hdr)->
æg
è& 0x7800è>> 11)

	)

13 
	#DNS_AA
(
hdr
è((
	`Áohs
((hdr)->
æg
è& 0x0400è>> 10)

	)

14 
	#DNS_TC
(
hdr
è((
	`Áohs
((hdr)->
æg
è& 0x0200è>> 9)

	)

15 
	#DNS_RD
(
hdr
è((
	`Áohs
((hdr)->
æg
è& 0x0100è>> 8)

	)

16 
	#DNS_RA
(
hdr
è((
	`Áohs
((hdr)->
æg
è& 0x0080è>> 7)

	)

17 
	#DNS_Z
(
hdr
è((
	`Áohs
((hdr)->
æg
è& 0x0070è>> 4)

	)

18 
	#DNS_RCODE
(
hdr
è((
	`Áohs
((hdr)->
æg
è& 0x000fè>> 0)

	)

20 
ems_shÜt
 
	mqdcouÁ
;

21 
ems_shÜt
 
	mªcouÁ
;

22 
ems_shÜt
 
	mnscouÁ
;

23 
ems_shÜt
 
	m¬couÁ
;

26 
	s_dns_™em_s
 {

27 
ems_shÜt
 
	mty
;

28 
ems_shÜt
 
	mşs
;

29 
ems_ušt
 
	m‰l
;

30 
ems_shÜt
 
	mËn
;

31 
ems_uch¬
 
	mbuf
[0];

34 #´agm¨
·ck
(
pİ
)

36 
	s_dns_que¡iÚ_s
 {

37 
ems_shÜt
 
	mqty³
;

38 
ems_shÜt
 
	mqşass
;

39 
ems_¡r
 
	mqÇme
;

42 
	s_dns_¼_s
 {

43 
ems_shÜt
 
	m±r
;

44 
ems_¡r
 
	mnick
;

45 
_dns_™em_s
 
	m™em
;

48 
	s_dns_u£r_s
 {

49 
ems_hash_fd
 
	mh_msg
;

50 
ems_timeout
 
	mto
;

51 
ems_ušt
 
	mæg
;

52 
ems_št
 
	mpÜt
;

53 
š_addr
 
	maddr
;

54 
ems_bufãr
 
	mbuf
;

56 
ems_void
 *
	mùx
;

57 
ems_queue
 
	m’Œy
;

60 
	s_dns_u¾_s
 {

61 
ems_hash_fd
 
	mh_u¾
;

62 
ems_ušt
 
	mæg
;

63 
ems_¡r
 
	mu¾
;

64 
ems_št
 
	mn_addr
;

65 
š_addr
 *
	maddr
;

66 
ems_št
 
	mmask
;

68 
ems_queue
 
	m’Œy
;

71 
	#FLG_URL_IS_IPADDRESS
 0x0001

	)

72 
	#FLG_DNS_QUERY_SELF
 0x0002

	)

73 
	#FLG_DNS_QUERY_EXPIRED
 0x0004

	)

74 
	#FLG_DNS_IS_SUBDOMAIN
 0x0008

	)

76 
ems_št
 
fw_dns_be_£rv”
(
ems_fw
 *
fw
);

77 
ems_št
 
fw_dns_£rv”_¡İ
(
ems_fw
 *
fw
);

78 
ems_št
 
fw_dns_ş›Á_¡İ
(
ems_fw
 *
fw
);

79 
ems_št
 
fw_dns_be_ş›Á
(
ems_fw
 *
fw
);

81 
ems_št
 
fw_dns_ş›Á_£t_»ad
(
ems_fw
 *
fw
,ƒms_šˆ
rd
);

82 
ems_št
 
fw_dns_ş›Á_£t_wr™e
(
ems_fw
 *
fw
,ƒms_šˆ
wr
);

83 
ems_št
 
fw_dns_£rv”_£t_»ad
(
ems_fw
 *
fw
,ƒms_šˆ
rd
);

84 
ems_št
 
fw_dns_£rv”_£t_wr™e
(
ems_fw
 *
fw
,ƒms_šˆ
wr
);

86 
dns_u£r
 *
dns_fšd_u£r
(
ems_fw
 *
fw
, 
ems_shÜt
 
key
);

87 
dns_u£r
 *
dns_u£r_Ãw
();

88 
ems_void
 
dns_u£r_ä“
(
dns_u£r
 *
u£r
);

90 
dns_u¾
 *
dns_u¾_Ãw
();

91 
ems_void
 
dns_u¾_ä“
(
dns_u¾
 *
u¾
);

92 
dns_u¾
 *
dns_fšd_u¾
(
ems_fw
 *
fw
, 
ems_cch¬
 *
key
);

94 
ems_št
 
fw_dns_qu”y_Œig”
(
ems_fw
 *
fw
);

95 
ems_št
 
fw_u¾_š_wh™–i¡
(
ems_fw
 *
fw
, 
ems_cch¬
 *
key
);

96 
ems_št
 
fw_dns_is_subdomaš
(
ems_fw
 *
fw
, 
ems_cch¬
 *
key
);

97 
ems_št
 
fw_dns_subdomaš_­³nd
(
ems_fw
 *
fw
, 
dns_u¾
 *
u¾
);

	@src/core/ems_dns_fwd.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"ems_fw.h
"

5 
	~"ems_dns.h
"

7 
ems_št
 
	$dns_cÚÃù
(
ems_£ssiÚ
 *
£ss
)

9 
fd
;

10 
sockaddr_š
 
addr
;

11 
ems_sock
 *
sock
 = &
£ss
->sock;

13 ià((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0)) == -1)

15 
	`ems_l_Œaû
("[dns]sock‘ƒ¼: %s", 
	`ems_Ï¡”rmsg
());

16  
EMS_ERR
;

19 
	`mem£t
(&
addr
, 0, (addr));

20 
addr
.
sš_çmy
 = 
AF_INET
;

21 
addr
.
sš_pÜt
 = 
	`htÚs
(53);

22 
addr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
("127.0.0.1");

24 ià(
	`cÚÃù
(
fd
, (
sockaddr
 *)&
addr
, (
sockaddr_š
))) {

25 
	`ems_l_Œaû
("[dns] connect failed");

26 
	`şo£
(
fd
);

27  
EMS_ERR
;

30 
	`ems_sock_£ddr
(
sock
, "127.0.0.1");

31 
	`ems_sock_£tfd
(
sock
, 
fd
);

32  
EMS_OK
;

33 
	}
}

35 
ems_cch¬
 *
	$dns_g‘_Çme
(
ems_cch¬
 *
·ylßd
,ƒms_cch¬ *
r¥
, 
ems_ch¬
 *
Çme
)

37 
ems_uch¬
 
Ën
;

38 
ems_shÜt
 
off£t
;

40 
Ën
 = *
·ylßd
++;

42 
Ën
 > 0) {

43 ià(
Ën
 & 0xc0) {

45 
ems_uch¬
 
low
 = *
·ylßd
++;

46 
off£t
 = ((
Ën
 & 0x03è<< 8 | (
low
 & 0xff));

47 
	`dns_g‘_Çme
(
r¥
 + 
off£t
,„¥, 
Çme
);

48 
Ën
 = 0;

50 
	`memıy
(
Çme
, 
·ylßd
, 
Ën
);

52 
Çme
 +ğ
Ën
;

53 
·ylßd
 +ğ
Ën
;

55 
Ën
 = *
·ylßd
++;

56 ià(
Ën
 > 0)

57 *
Çme
++ = '.';

61  
·ylßd
;

62 
	}
}

64 
ems_cch¬
 *
	$dns_g‘_shÜt
(
ems_cch¬
 *
·ylßd
, 
ems_shÜt
 *
n
)

66 *
n
 = 
	`Áohs
(*(
ems_shÜt
 *)
·ylßd
);

67 
·ylßd
 +ğ(
ems_shÜt
);

68  
·ylßd
;

69 
	}
}

72 
ems_cch¬
 *
	$dns_g‘_št
(
ems_cch¬
 *
·ylßd
, 
ems_št
 *
n
)

74 *
n
 = 
	`Áohl
(*(
ems_št
 *)
·ylßd
);

75 
·ylßd
 +ğ(
ems_št
);

76  
·ylßd
;

77 
	}
}

80 
ems_cch¬
 *

81 
	$fw_dns_g‘_que¡iÚ
(
ems_cch¬
 *
·ylßd
,ƒms_cch¬ *
r¥
, 
dns_que¡iÚ
 *
qu¡
)

83 
ems_ch¬
 
u¾
[512];

85 
	`mem£t
(
u¾
, 0, (url));

87 
·ylßd
 = 
	`dns_g‘_Çme
Õaylßd, 
r¥
, 
u¾
);

90 
	`¡r_£t
(&
qu¡
->
qÇme
, 
u¾
);

92 
·ylßd
 = 
	`dns_g‘_shÜt
Õaylßd, &
qu¡
->
qty³
);

93 
·ylßd
 = 
	`dns_g‘_shÜt
Õaylßd, &
qu¡
->
qşass
);

95  
·ylßd
;

96 
	}
}

98 
ems_št


99 
	$dns_g‘_®l_add»ss
(
ems_cch¬
 *
·ylßd
,ƒms_cch¬ *
r¥
, 
š_addr
 *
addr
, 
ems_št
 *
n_addr
)

101 
ems_ch¬
 
u¾
[512];

102 
dns_™em
 *
™m
;

103 
ems_št
 
tÙ®
 = *
n_addr
;

105 *
n_addr
 = 0;

107 
tÙ®
 > 0) {

108 
tÙ®
--;

110 
	`mem£t
(
u¾
, 0, (url));

112 
·ylßd
 = 
	`dns_g‘_Çme
Õaylßd, 
r¥
, 
u¾
);

113 
	`ems_l_Œaû
("dn Çme: % tÙ®: %d", 
u¾
, 
tÙ®
);

115 
™m
 = (
dns_™em
 *)
·ylßd
;

117 ià(
	`Áohs
(
™m
->
ty
è=ğ1 &&‚tohs(™m->
şs
) == 1) {

118 
	`ems_as£¹
(
	`Áohs
(
™m
->
Ën
) == 4);

119 
	`memıy
(&
addr
[*
n_addr
], 
™m
->
buf
, 4);

121 
	`ems_l_Œaû
("A : %s", 
	`š‘_Áß
(
addr
[*
n_addr
]));

123 *
n_addr
 = *n_addr +1;

126 
·ylßd
 +ğ(
dns_™em
è+ 
	`Áohs
(
™m
->
Ën
);

129  
EMS_OK
;

130 
	}
}

132 
ems_št
 
	$dns_addr_exi¡
(
dns_u¾
 *
u¾
, 
š_addr
 

)

134 
ems_št
 
i
;

136 ià(!
u¾
 || !u¾->
addr
)

137  
EMS_NO
;

139 
i
 = 0; i < 
u¾
->
n_addr
; i++) {

140 ià(
u¾
->
addr
[
i
].
s_addr
 =ğ

.s_addr)

141  
EMS_YES
;

144  
EMS_NO
;

145 
	}
}

147 
ems_št


148 
	$dns_­¶y_Ãw_add»sss
(
ems_fw
 *
fw
, 
dns_u¾
 *
u¾
, 
š_addr
 *
addr
, 
ems_št
 
n_addr
)

150 
ems_št
 
i
;

152 
	`ems_as£¹
(
n_addr
 > 0 && 
addr
 !ğ
NULL
);

155 ià(
n_addr
 !ğ
u¾
->n_addr) ;

157 
i
 = 0; i < 
n_addr
; i++) {

158 ià(!
	`dns_addr_exi¡
(
u¾
, 
addr
[
i
]))

159 
do_­¶y
;

162  
EMS_OK
;

165 
do_­¶y
:

166 
	`ems_l_Œaû
("dn add»ss: % upd©ed", 
	`¡r_‹xt
(&
u¾
->url));

168 
	`fw_u¾_£t_ä“
(
fw
, 
u¾
, 
EMS_NO
);

170 ià(
u¾
->
addr
) {

171 
	`ems_ä“
(
u¾
->
addr
);

172 
u¾
->
addr
 = 
NULL
;

173 
u¾
->
n_addr
 = 0;

176 ià(
n_addr
 > 0 && 
addr
){

177 
ems_št
 
tÙ®
;

179 
tÙ®
 = 
n_addr
 * (
š_addr
);

181 
u¾
->
addr
 = (
š_addr
 *)
	`ems_m®loc
(
tÙ®
);

182 ià(
u¾
->
addr
) {

183 
	`memıy
(
u¾
->
addr
,‡ddr, 
tÙ®
);

184 
u¾
->
n_addr
 =‚_addr;

185 
	`fw_u¾_£t_ä“
(
fw
, 
u¾
, 
EMS_YES
);

189  
EMS_OK
;

190 
	}
}

192 
ems_št


193 
	$dns_upd©e_u¾_addr
(
ems_fw
 *
fw
, 
dns_u¾
 *
u¾
,

194 
ems_cch¬
 *
·ylßd
, 
dns_h—d”
 *
dns
,ƒms_cch¬ *
r¥
)

196 
š_addr
 *
addr
 = 
NULL
;

197 
ems_št
 
n_addr
 = 0;

199 
n_addr
 = 
	`Áohs
(
dns
->
ªcouÁ
è+‚tohs(dns->
nscouÁ
è+‚tohs(dns->
¬couÁ
);

200 
	`ems_as£¹
(
n_addr
 > 0 && "never should be here");

202 
addr
 = (
š_addr
 *)
	`ems_m®loc
(
n_addr
 * (in_addr));

203 ià(!
addr
)

204  
EMS_ERR
;

206 
	`ems_l_Œaû
("cu¼’ˆaddr: %s,Ù®‚: %d", 
	`¡r_‹xt
(&
u¾
->u¾), 
n_addr
);

208 
	`dns_g‘_®l_add»ss
(
·ylßd
, 
r¥
, 
addr
, &
n_addr
);

210 ià(
n_addr
 > 0)

211 
	`dns_­¶y_Ãw_add»sss
(
fw
, 
u¾
, 
addr
, 
n_addr
);

213 
	`ems_æag_un£t
(
u¾
->
æg
, 
FLG_DNS_QUERY_EXPIRED
);

215 
	`ems_ä“
(
addr
);

217  
EMS_OK
;

218 
	}
}

220 
ems_št


221 
	$fw_dns_·r£_ªd_f‹r
(
ems_fw
 *
fw
, 
ems_£ssiÚ
 *
£ss
, 
dns_u£r
 *
u£r
, 
dns_h—d”
 *
dns
)

223 
ems_bufãr
 *
buf
 = &
£ss
->
buf_š
;

224 
ems_cch¬
 *
·ylßd
;

225 
dns_que¡iÚ
 
qu¡
;

226 
dns_u¾
 *
u¾
 = 
NULL
;

228 
	`mem£t
(&
qu¡
, 0, (qust));

230 
	`¡r_š™
(&
qu¡
.
qÇme
);

232 
·ylßd
 = 
	`buf_rd
(
buf
è+ (
dns_h—d”
);

233 
·ylßd
 = 
	`fw_dns_g‘_que¡iÚ
Õaylßd, 
	`buf_rd
(
buf
), &
qu¡
);

235 
	`ems_l_Œaû
("question: %s, class: 0x%x,ype: 0x%x",

236 
	`¡r_‹xt
(&
qu¡
.
qÇme
), qu¡.
qty³
, qu¡.
qşass
);

238 
u¾
 = 
	`dns_fšd_u¾
(
fw
, 
	`¡r_‹xt
(&
qu¡
.
qÇme
));

240 ià(
u¾
) {

241 ià(
u¾
->
n_addr
 <= 0 ||

242 
	`ems_æag_like
(
u¾
->
æg
, 
FLG_DNS_QUERY_EXPIRED
) ||

243 
	`ems_æag_like
(
u£r
->
æg
, 
FLG_DNS_QUERY_SELF
))

245 
	`dns_upd©e_u¾_addr
(
fw
, 
u¾
, 
·ylßd
, 
dns
, 
	`buf_rd
(
buf
));

248 ià(
	`ems_æag_like
(
u¾
->
æg
, 
FLG_DNS_IS_SUBDOMAIN
)) {

250 
	`ems_queue_»move
(&
u¾
->
’Œy
);

251 
	`ems_queue_š£¹_
(&
fw
->
subdomaš
, &
u¾
->
’Œy
);

254 ià(
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_SUBDOMAIN_ENABLE
) &&

255 
	`fw_dns_is_subdomaš
(
fw
, 
	`¡r_‹xt
(&
qu¡
.
qÇme
))) {

256 
u¾
 = 
	`dns_u¾_Ãw
();

257 ià(
u¾
) {

258 
	`¡r_£t
(&
u¾
->u¾, 
	`¡r_‹xt
(&
qu¡
.
qÇme
));

259 
	`fw_dns_subdomaš_­³nd
(
fw
, 
u¾
);

260 
	`dns_upd©e_u¾_addr
(
fw
, 
u¾
, 
·ylßd
, 
dns
, 
	`buf_rd
(
buf
));

265 
	`¡r_unš™
(&
qu¡
.
qÇme
);

267  
EMS_OK
;

268 
	}
}

270 
ems_št
 
	$fw_dns_fwd_f‹r
(
ems_fw
 *
fw
, 
ems_£ssiÚ
 *
£ss
)

272 
dns_h—d”
 *
dns
 = 
NULL
;

273 
dns_u£r
 *
u£r
 = 
NULL
;

275 
	`ems_l_Œaû
("DNS„e¥Ú£,†’gth: %d", 
	`buf_Ën
(&
£ss
->
buf_š
));

277 
dns
 = (
dns_h—d”
 *)
	`buf_rd
(&
£ss
->
buf_š
);

278 
	`ems_as£¹
(
	`DNS_QR
(
dns
) && "must be‡„esponse");

280 
u£r
 = 
	`dns_fšd_u£r
(
fw
, 
	`Áohs
(
dns
->
id
));

281 ià(
u£r
) {

282 
	`ems_l_Œaû
("u£¸(%s:%dèdn »¶›d", 
	`š‘_Áß
(
u£r
->
addr
), u£r->
pÜt
);

284 
	`ems_queue_»move
(&
u£r
->
’Œy
);

285 
	`ems_timeout_ÿnûl
(&
u£r
->
to
);

286 
	`ems_hash_»move
(&
u£r
->
h_msg
);

288 
	`ems_bufãr_ş—r
(&
u£r
->
buf
);

289 
	`ems_bufãr_wr™e
(&
u£r
->
buf
, 
	`buf_rd
(&
£ss
->
buf_š
), 
	`buf_Ën
(&sess->buf_in));

291 ià((
	`DNS_RCODE
(
dns
è=ğ0è&& (
	`Áohs
(dns->
qdcouÁ
) > 0)) {

292 iàĞ
	`Áohs
(
dns
->
ªcouÁ
) > 0

298 
	`fw_dns_·r£_ªd_f‹r
(
fw
, 
£ss
, 
u£r
, 
dns
);

302 ià(
	`ems_æag_like
(
u£r
->
æg
, 
FLG_DNS_QUERY_SELF
)) {

303 
	`dns_u£r_ä“
(
u£r
);

304  
EMS_OK
;

307 
	`ems_queue_š£¹_
(&
fw
->
out
, &
u£r
->
’Œy
);

308 
	`fw_dns_£rv”_£t_wr™e
(
fw
, 
EMS_YES
);

311  
EMS_OK
;

312 
	}
}

314 
ems_št
 
	$fw_dns_fwd_r¥
(
ems_fw
 *
fw
, 
ems_£ssiÚ
 *
£ss
)

316 
ems_št
 
»t
;

317 
ems_ch¬
 *
wr
 = 
	`buf_wr
(&
£ss
->
buf_š
);

318 
ems_št
 
Ën
 = 
	`buf_Ëá
(&
£ss
->
buf_š
);

320 
agaš
:

321 
»t
 = 
	`»cv
(
	`ems_sock_fd
(&
£ss
->
sock
), 
wr
, 
Ën
, 0);

323 ià(
»t
 <= 0) {

324 
”ºo
) {

326 
EAGAIN
:

327 
EINTR
:

328  
EMS_OK
;

331 
	`ems_l_Œaû
("[fw] fwƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

332  
EMS_ERR
;

336 
	`ems_bufãr_£ek_wr
(&
£ss
->
buf_š
, 
»t
, 
EMS_BUFFER_SEEK_CUR
);

338 
»t
 = 
	`fw_dns_fwd_f‹r
(
fw
, 
£ss
);

340 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

342 
agaš
;

344  
EMS_OK
;

345 
	}
}

347 
ems_št
 
	$fw_dns_fwd_»q
(
ems_fw
 *
fw
, 
ems_£ssiÚ
 *
£ss
)

349 
dns_u£r
 *
u£r
 = 
NULL
;

350 
ems_queue
 *
p
, *
q
;

351 
ems_št
 
»t
;

353 
	`ems_queue_fÜ—ch_§ã
(&
fw
->
fwd
, 
p
, 
q
) {

354 
u£r
 = 
	`ems_cÚš”_of
(
p
, 
dns_u£r
, 
’Œy
);

356 
	`ems_as£¹
(
	`buf_Ën
(&
u£r
->
buf
) > 0);

357 
»t
 = 
	`£nd
(
	`ems_sock_fd
(&
£ss
->
sock
), 
	`buf_rd
(&
u£r
->
buf
), 
	`buf_Ën
(&user->buf), 0);

358 ià(
»t
 <= 0) {

362 
	`ems_bufãr_ş—r
(&
u£r
->
buf
);

363 
	`ems_queue_»move
(&
u£r
->
’Œy
);

364 
	`ems_queue_š£¹_
(&
fw
->
wa™
, &
u£r
->
’Œy
);

367 ià(!
	`ems_queue_em±y
(&
fw
->
wa™
))

368 
	`fw_dns_ş›Á_£t_»ad
(
fw
, 
EMS_YES
);

370 ià(
	`ems_queue_em±y
(&
fw
->
fwd
))

371 
	`fw_dns_ş›Á_£t_wr™e
(
fw
, 
EMS_NO
);

373  
EMS_OK
;

374 
	}
}

376 
ems_void
 
	$fw_dns_fwd_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

378 
ems_fw
 *
fw
 = (ems_fw *)
	`£ss_cb¬g
(
£ss
);

380 ià(
”r
) {

381 
	`ems_l_Œaû
("[fw] cl›Á dn ”¸£ss: %d", 
	`ems_sock_fd
(&
£ss
->
sock
));

383 
	`fw_dns_ş›Á_¡İ
(
fw
);

384 
	`fw_dns_be_ş›Á
(
fw
);

388 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

389 
	`fw_dns_fwd_r¥
(
fw
, 
£ss
);

392 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

393 
	`fw_dns_fwd_»q
(
fw
, 
£ss
);

395 
	}
}

397 
ems_št
 
	$fw_dns_be_ş›Á
(
ems_fw
 *
fw
)

399 
ems_£ssiÚ
 *
£ss
;

401 ià(!
fw
->
£ss_dns
)

402 
fw
->
£ss_dns
 = 
	`ems_£ssiÚ_Ãw
();

404 
	`ems_as£¹
(
fw
->
£ss_dns
 !ğ
NULL
);

405 
£ss
 = 
fw
->
£ss_dns
;

407 ià(
	`dns_cÚÃù
(
£ss
è!ğ
EMS_OK
) {

408 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
£ss
);

409 
fw
->
£ss_dns
 = 
NULL
;

410  
EMS_ERR
;

413 
	`£ss_cb¬g_£t
(
£ss
, 
fw
);

414 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
fw_dns_fwd_evt_cb
);

416 
	`ems_l_Œaû
("[fw] dns client (%d) %s",

417 
	`ems_sock_fd
(&
£ss
->
sock
), 
	`ems_sock_addr
(&sess->sock));

419  
EMS_OK
;

420 
	}
}

422 
ems_št
 
	$fw_dns_ş›Á_¡İ
(
ems_fw
 *
fw
)

424 ià(
fw
->
£ss_dns
) {

425 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
fw
->
£ss_dns
);

426 
fw
->
£ss_dns
 = 
NULL
;

429  
EMS_OK
;

430 
	}
}

432 
ems_št
 
	$fw_dns_ş›Á_£t_»ad
(
ems_fw
 *
fw
, 
ems_št
 
rd
)

434 
ems_£ssiÚ
 *
£ss
 = 
fw
->
£ss_dns
;

435 
ems_št
 
evt
;

437 
evt
 = 0;

438 
	`£ss_ev’t_ÿnûl
(
£ss
);

439 ià(
rd
)

440 
evt
 |ğ
EMS_EVT_READ
;

442 ià(!
	`ems_queue_em±y
(&
fw
->
fwd
))

443 
evt
 |ğ
EMS_EVT_WRITE
;

445 ià(
evt
)

446 
	`£ss_ev’t_£t
(
£ss
, 
evt
, 
fw_dns_fwd_evt_cb
);

448  
EMS_OK
;

449 
	}
}

451 
ems_št
 
	$fw_dns_ş›Á_£t_wr™e
(
ems_fw
 *
fw
, 
ems_št
 
wr
)

453 
ems_£ssiÚ
 *
£ss
 = 
fw
->
£ss_dns
;

454 
ems_št
 
evt
;

456 
evt
 = 0;

457 
	`£ss_ev’t_ÿnûl
(
£ss
);

458 ià(
wr
)

459 
evt
 |ğ
EMS_EVT_WRITE
;

461 ià(!
	`ems_queue_em±y
(&
fw
->
wa™
))

462 
evt
 |ğ
EMS_EVT_READ
;

464 ià(
evt
)

465 
	`£ss_ev’t_£t
(
£ss
, 
evt
, 
fw_dns_fwd_evt_cb
);

467  
EMS_OK
;

468 
	}
}

	@src/core/ems_fw.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"ems_fw.h
"

5 
	~"ems_dns.h
"

6 
	~"­p.h
"

10 
	#C_TABLE_NAT
 "Çt"

	)

11 
	#LOCUS
 "locus_"

	)

12 
	#LOCUS_PRE
 
LOCUS
 "´e_"

	)

13 
	#c_Çt_fw_´e
 
LOCUS_PRE
 "Çt"

	)

14 
	#c_mac_bÏck
 
LOCUS_PRE
 "mac_bÏck"

	)

15 
	#c_mac_wh™e
 
LOCUS_PRE
 "mac_wh™e"

	)

16 
	#c_sy¡em_deçuÉ
 
LOCUS_PRE
 "sy¡em_def"

	)

17 
	#c_u£r_wh™e
 
LOCUS_PRE
 "u£r_wh™e"

	)

18 
	#c_u¾_wh™e
 
LOCUS_PRE
 "wh™–i¡"

	)

20 
	#C_TABLE_FILTER
 "f‹r"

	)

21 
	#c_f‹r_fwd
 
LOCUS
 "f‹r_fwd"

	)

23 
	#RET_ERR_FAILED
(
A
èià((Aè!ğ0è 
EMS_ERR


	)

25 
ems_št
 
	$fw_ü—‹_ªd_š£¹
(
ems_ch¬
 *
chaš
,ƒms_ch¬ *
u¶šk
, 
ems_cch¬
 *
tb
, 
ems_št
 
h—d
)

27 
ems_bufãr
 *
buf
 = 
	`cÜe_bufãr
();

29 
	`ems_bufãr_ş—r
(
buf
);

31 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf), "bË -ˆ% -N %s", 
tb
, 
chaš
);

32 
	`RET_ERR_FAILED
(
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
)));

34 ià(
h—d
)

35 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf), "bË -ˆ% -I % -j %s", 
tb
, 
u¶šk
, 
chaš
);

37 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf), "bË -ˆ% -A % -j %s", 
tb
, 
u¶šk
, 
chaš
);

39 
	`RET_ERR_FAILED
(
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
)));

41  
EMS_OK
;

42 
	}
}

44 
ems_št
 
	$fw_­¶y_deçuÉs
()

46 
ems_bufãr
 *
buf
 = 
	`cÜe_bufãr
();

48 
ems_cch¬
 *
gw
 = 
	`cÜe_gw_addr
();

49 
ems_cch¬
 *
iâame
 = 
	`cÜe_gw_iâame
();

51 ià(!
gw
) {

52 
	`ems_as£¹
(0 && "should‚ever be here");

53  
EMS_ERR
;

57 
ems_ch¬
 *
cmd
;

58 
ems_št
 
Ën
;

60 
cmd
 = 
	`buf_wr
(
buf
);

61 
Ën
 = 
	`buf_Ëá
(
buf
);

64 
	`¢´štf
(
cmd
, 
Ën
, "iptables -i %s -t‚at -I %s -pcp -d %s --dport 80 -j DNAT --to-destination %s:%d",

65 
iâame
, 
c_Çt_fw_´e
, 
NAS_ADDR
, 
gw
, 
EMS_PORT
);

66 
	`RET_ERR_FAILED
(
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
)));

69 
	`¢´štf
(
cmd
, 
Ën
 , "iptables -i %s -t‚at -A %s -p udp --dport 53 -j DNAT --to-destination %s:%d",

70 
iâame
, 
c_sy¡em_deçuÉ
, 
gw
, 
EMS_DNS_BIND
);

71 
	`RET_ERR_FAILED
(
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
)));

74 
	`¢´štf
(
cmd
, 
Ën
 , "bË -˜% -ˆÇˆ-A % -°ud°--dpÜˆ67 -j ACCEPT", 
iâame
, 
c_sy¡em_deçuÉ
);

75 
	`RET_ERR_FAILED
(
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
)));

78 
	`¢´štf
(
cmd
, 
Ën
 , "bË -˜% -ˆÇˆ-A % -d % -j ACCEPT", 
iâame
, 
c_sy¡em_deçuÉ
, 
gw
);

79 
	`RET_ERR_FAILED
(
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
)));

82 
	`¢´štf
(
cmd
, 
Ën
, "bË -˜% -ˆÇˆ-A % -°tı -m muÉÜˆ--dpÜt 80,8080 -j DNAT --to-de¡š©iÚ %s:%d", 
iâame
, 
c_Çt_fw_´e
, 
gw
, 
EMS_PORT
);

83 
	`RET_ERR_FAILED
(
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
)));

86 
	`¢´štf
(
cmd
, 
Ën
, "bË -˜% -ˆÇˆ-A %  -j DNAT --to-de¡š©iÚ 127.0.0.100", 
iâame
, 
c_Çt_fw_´e
);

87 
	`RET_ERR_FAILED
(
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
)));

90  
EMS_OK
;

91 
	}
}

94 
ems_št
 
	$fw_š™_chašs
(
ems_fw
 *
fw
)

96 
	`RET_ERR_FAILED
(
	`fw_ü—‹_ªd_š£¹
(
c_f‹r_fwd
, "FORWARD", 
C_TABLE_FILTER
, 
EMS_YES
));

97 
	`RET_ERR_FAILED
(
	`fw_ü—‹_ªd_š£¹
(
c_Çt_fw_´e
, "PREROUTING", 
C_TABLE_NAT
, 
EMS_NO
));

98 
	`RET_ERR_FAILED
(
	`fw_ü—‹_ªd_š£¹
(
c_mac_bÏck
, 
c_Çt_fw_´e
, 
C_TABLE_NAT
, 
EMS_NO
));

99 
	`RET_ERR_FAILED
(
	`fw_ü—‹_ªd_š£¹
(
c_mac_wh™e
, 
c_Çt_fw_´e
, 
C_TABLE_NAT
, 
EMS_NO
));

100 
	`RET_ERR_FAILED
(
	`fw_ü—‹_ªd_š£¹
(
c_u£r_wh™e
, 
c_Çt_fw_´e
, 
C_TABLE_NAT
, 
EMS_NO
));

101 
	`RET_ERR_FAILED
(
	`fw_ü—‹_ªd_š£¹
(
c_sy¡em_deçuÉ
, 
c_Çt_fw_´e
, 
C_TABLE_NAT
, 
EMS_NO
));

102 
	`RET_ERR_FAILED
(
	`fw_ü—‹_ªd_š£¹
(
c_u¾_wh™e
, 
c_Çt_fw_´e
, 
C_TABLE_NAT
, 
EMS_NO
));

104  
	`fw_­¶y_deçuÉs
();

105 
	}
}

107 
ems_void
 
	$fw_ş—n_ªd_d–
(
ems_cch¬
 *
chaš
,ƒms_cch¬ *
u¶šk
,ƒms_cch¬ *
tb
)

109 
ems_bufãr
 *
buf
 = 
	`cÜe_bufãr
();

111 
	`ems_bufãr_ş—r
(
buf
);

113 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf), "bË -ˆ% -F %s", 
tb
, 
chaš
);

114 
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
));

116 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf), "bË -ˆ% -D % -j %s", 
tb
, 
u¶šk
, 
chaš
);

117 
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
));

119 
	`¢´štf
(
	`buf_wr
(
buf
), 
	`buf_Ëá
(buf), "bË -ˆ% -X %s", 
tb
, 
chaš
);

120 
	`ems_sy¡emcmd
(
	`buf_rd
(
buf
));

121 
	}
}

123 
ems_št
 
	$fw_unš™_chašs
(
ems_fw
 *
fw
)

125 
	`fw_ş—n_ªd_d–
(
c_mac_bÏck
, 
c_Çt_fw_´e
, 
C_TABLE_NAT
);

126 
	`fw_ş—n_ªd_d–
(
c_mac_wh™e
, 
c_Çt_fw_´e
, 
C_TABLE_NAT
);

127 
	`fw_ş—n_ªd_d–
(
c_sy¡em_deçuÉ
, 
c_Çt_fw_´e
, 
C_TABLE_NAT
);

128 
	`fw_ş—n_ªd_d–
(
c_u£r_wh™e
, 
c_Çt_fw_´e
, 
C_TABLE_NAT
);

129 
	`fw_ş—n_ªd_d–
(
c_u¾_wh™e
, 
c_Çt_fw_´e
, 
C_TABLE_NAT
);

130 
	`fw_ş—n_ªd_d–
(
c_Çt_fw_´e
, "PREROUTING", 
C_TABLE_NAT
);

131 
	`fw_ş—n_ªd_d–
(
c_f‹r_fwd
, "FORWARD", 
C_TABLE_FILTER
);

133  
EMS_OK
;

134 
	}
}

136 
ems_void
 
	$fw_ş—r_®l
()

138 
	`fw_unš™_chašs
(
NULL
);

139 
	}
}

141 
ems_št
 
	$fw_æush_u£r_mac_wh™e
(
ems_fw
 *
fw
)

143 
jsÚ_objeù
 *
¬y
, *
obj
;

144 
ems_št
 
i
, 
Ën
;

145 
ems_ch¬
 *
cmd
;

146 
ems_bufãr
 *
buf
 = 
	`cÜe_bufãr
();

147 
ems_cch¬
 *
iâame
 = 
	`cÜe_gw_iâame
();

149 
¬y
 = 
	`cfg_g‘_jsÚ
(
	`emscfg
(), 
CFG_u£r_mac_wh™e
);

150 ià(!
¬y
)

151  
EMS_OK
;

153 
	`ems_l_Œaû
("u£¸defšed maøwh™–i¡: %s", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
¬y
));

155 
cmd
 = 
	`buf_wr
(
buf
);

156 
Ën
 = 
	`buf_Ëá
(
buf
);

158 
	`¢´štf
(
cmd
, 
Ën
, "bË -ˆÇˆ-F %s", 
c_mac_wh™e
);

159 
	`ems_sy¡emcmd
(
cmd
);

161 
i
 = 0; i < 
	`jsÚ_objeù_¬¿y_Ëngth
(
¬y
); i++) {

162 
obj
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
¬y
, 
i
);

164 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
))

166 
	`¢´štf
(
cmd
, 
Ën
,

168 
iâame
, 
c_mac_wh™e
, 
	`jsÚ_objeù_g‘_¡ršg
(
obj
));

170 
	`ems_sy¡emcmd
(
cmd
);

174 
	`jsÚ_objeù_put
(
¬y
);

176  
EMS_OK
;

177 
	}
}

179 
ems_št
 
	$fw_æush_u£r_mac_bÏck
(
ems_fw
 *
fw
)

181 
jsÚ_objeù
 *
¬y
, *
obj
;

182 
ems_bufãr
 
buf
;

183 
ems_št
 
i
, 
Ën
;

184 
ems_ch¬
 *
cmd
;

185 
ems_cch¬
 *
iâame
 = 
	`cÜe_gw_iâame
();

187 
¬y
 = 
	`cfg_g‘_jsÚ
(
	`emscfg
(), 
CFG_u£r_mac_bÏck
);

188 ià(!
¬y
)

189  
EMS_OK
;

191 
	`ems_l_Œaû
("u£¸defšed maøbÏckli¡: %s", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
¬y
));

193 
	`ems_bufãr_š™
(&
buf
, 
EMS_BUFFER_1K
);

195 
cmd
 = 
	`buf_wr
(&
buf
);

196 
Ën
 = 
	`buf_Ëá
(&
buf
);

198 
	`¢´štf
(
cmd
, 
Ën
, "bË -ˆÇˆ-F %s", 
c_mac_bÏck
);

199 
	`ems_sy¡emcmd
(
cmd
);

201 
i
 = 0; i < 
	`jsÚ_objeù_¬¿y_Ëngth
(
¬y
); i++) {

202 
obj
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
¬y
, 
i
);

204 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
))

207 
	`¢´štf
(
cmd
, 
Ën
,

209 
iâame
, 
c_mac_bÏck
, 
	`jsÚ_objeù_g‘_¡ršg
(
obj
));

211 
	`ems_sy¡emcmd
(
cmd
);

215 
	`ems_bufãr_unš™
(&
buf
);

216 
	`jsÚ_objeù_put
(
¬y
);

218  
EMS_OK
;

219 
	}
}

221 
dns_u¾
 *
	$fw_fšd_u¾
(
ems_queue
 *
h—d
, 
ems_cch¬
 *
key
)

223 
ems_queue
 *
p
;

224 
dns_u¾
 *
u¾
;

226 
	`ems_queue_fÜ—ch
(
h—d
, 
p
) {

227 
u¾
 = 
	`ems_cÚš”_of
(
p
, 
dns_u¾
, 
’Œy
);

229 ià(!
	`¡rcmp
(
	`¡r_‹xt
(&
u¾
->u¾), 
key
)) {

230  
u¾
;

234  
NULL
;

235 
	}
}

237 
ems_št
 
	$fw_»move_u¾s
(
ems_fw
 *
fw
, 
ems_queue
 *
h—d
, 
jsÚ_objeù
 *
¬y
)

239 
jsÚ_objeù
 *
obj
;

240 
ems_št
 
i
;

241 
dns_u¾
 *
u¾
;

243 
i
 = 0; i < 
	`jsÚ_objeù_¬¿y_Ëngth
(
¬y
); i++) {

245 
obj
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
¬y
, 
i
);

247 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
))

249 
ems_cch¬
 *
buf
 = 
	`jsÚ_objeù_g‘_¡ršg
(
obj
);

251 
u¾
 = 
	`fw_fšd_u¾
(
h—d
, 
buf
);

252 ià(
u¾
) {

253 
	`ems_queue_»move
(&
u¾
->
’Œy
);

254 
	`ems_hash_»move
(&
u¾
->
h_u¾
);

255 
	`fw_u¾_£t_ä“
(
fw
, 
u¾
, 
EMS_NO
);

256 
	`ems_l_Œaû
("»movu¾: %s", 
	`¡r_‹xt
(&
u¾
->url));

257 
	`dns_u¾_ä“
(
u¾
);

262  
EMS_OK
;

263 
	}
}

265 
ems_št
 
	$fw_­³nd_u¾s
(
ems_fw
 *
fw
, 
ems_queue
 *
h—d
, 
jsÚ_objeù
 *
¬y
)

267 
jsÚ_objeù
 *
obj
;

268 
ems_št
 
i
;

269 
dns_u¾
 *
u¾
;

271 
i
 = 0; i < 
	`jsÚ_objeù_¬¿y_Ëngth
(
¬y
); i++) {

273 
obj
 = 
	`jsÚ_objeù_¬¿y_g‘_idx
(
¬y
, 
i
);

275 ià(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
))

277 
ems_cch¬
 *
buf
 = 
	`jsÚ_objeù_g‘_¡ršg
(
obj
);

278 ià(
	`fw_fšd_u¾
(
h—d
, 
buf
))

281 
u¾
 = 
	`dns_u¾_Ãw
();

282 ià(
u¾
) {

283 
	`¡r_£t
(&
u¾
->u¾, 
buf
);

286 
	`ems_hash_fd_£t_key
(&
u¾
->
h_u¾
, 
buf
);

287 
	`ems_hash_š£¹
(&
fw
->
hash_u¾
, &
u¾
->
h_u¾
);

289 
	`ems_l_Œaû
("­³nd u¾: %s", 
	`¡r_‹xt
(&
u¾
->url));

290 
	`ems_queue_š£¹_
(
h—d
, &
u¾
->
’Œy
);

295  
EMS_OK
;

296 
	}
}

298 
ems_št
 
	$fw_æush_wh‹li¡
(
ems_fw
 *
fw
)

300 
jsÚ_objeù
 *
¬y
, *
obj
;

302 
	`fw_wh™–i¡_ş—r
(
fw
);

304 
	`ems_sy¡emcmd
("bË -ˆÇˆ-F " 
c_u¾_wh™e
);

307 
¬y
 = 
	`cfg_g‘_jsÚ
(
	`emscfg
(), 
CFG_u£r_u¾_wh™e
);

308 ià(
¬y
) {

309 
	`ems_l_Œaû
("u£¸bwli¡: %s", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
¬y
));

310 
	`fw_­³nd_u¾s
(
fw
, &fw->
wh™–i¡
, 
¬y
);

311 
	`jsÚ_objeù_put
(
¬y
);

314 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

316 
	`ems_­p_´oûss
(
ty_fw
, 
ty_bwli¡
, 
EMS_APP_SERVER_BWLIST
, 
obj
);

317 
¬y
 = 
	`jsÚ_objeù_objeù_g‘
(
obj
, "white");

318 ià(
¬y
) {

319 
	`ems_l_Œaû
("£rv” bwli¡: %s", 
	`jsÚ_objeù_to_jsÚ_¡ršg
(
¬y
));

320 
	`fw_­³nd_u¾s
(
fw
, &fw->
wh™–i¡
, 
¬y
);

323 
	`jsÚ_objeù_put
(
obj
);

325 
	`ems_­p_´oûss
(
ty_fw
, 
ty_pÜl
, 
EMS_APP_EVT_FW_RELOAD
, 
NULL
);

330 
	`fw_dns_qu”y_Œig”
(
fw
);

332  
EMS_OK
;

333 
	}
}

343 
ems_št
 
	$fw_upd©e_®l_ruËs
(
ems_fw
 *
fw
)

345 ià(
fw
) {

346 
	`fw_æush_u£r_mac_wh™e
(
fw
);

347 
	`fw_æush_u£r_mac_bÏck
(
fw
);

348 
	`fw_æush_wh‹li¡
(
fw
);

351  
EMS_OK
;

352 
	}
}

354 
ems_ch¬
 *
	$fw_mac_upd©e
(
ems_ch¬
 *
d¡
, 
ems_cch¬
 *
¤c
)

356 *
¤c
) {

357 *
d¡
 = *
¤c
++;

359 ià(*
d¡
 == '-')

360 *
d¡
 = ':';

361 
d¡
++;

364  
d¡
;

365 
	}
}

368 
ems_št
 
	$fw_deviû_ä“
(
ems_cch¬
 *
u£r
,ƒms_cch¬ *
u£rmac
, 
ems_št
 
yes
)

370 
ems_ch¬
 
cmd
[256] = {0};

371 
ems_ch¬
 
mac
[32] = {0};

373 
	`fw_mac_upd©e
(
mac
, 
u£rmac
);

375 ià(
yes
) {

376 
	`¢´štf
(
cmd
, (cmd),

378 
	`cÜe_gw_iâame
(), 
c_u£r_wh™e
, 
mac
, 
u£r
);

380 
	`¢´štf
(
cmd
, (cmd),

382 
	`cÜe_gw_iâame
(), 
c_u£r_wh™e
, 
mac
, 
u£r
);

385 
	`ems_sy¡emcmd
(
cmd
);

388 ià(
yes
) {

389 
	`¢´štf
(
cmd
, (cmd),

391 
c_f‹r_fwd
, 
u£r
, 
u£rmac
);

393 
	`¢´štf
(
cmd
, (cmd),

395 
c_f‹r_fwd
, 
u£r
, 
u£rmac
);

398 
	`ems_sy¡emcmd
(
cmd
);

400  
EMS_OK
;

401 
	}
}

403 
ems_št
 
	$fw_u¾_£t_ä“
(
ems_fw
 *
fw
, 
dns_u¾
 *
u¾
, 
ems_št
 
­³nd
)

405 
ems_št
 
i
;

406 
ems_ch¬
 
cmd
[256] = {0};

407 
ems_cch¬
 *
š£¹
 = "-I";

409 ià(!
­³nd
)

410 
š£¹
 = "-D";

412 ià(
u¾
 && u¾->
addr
) {

413 
i
 = 0; i < 
u¾
->
n_addr
; i++)

415 ià(
u¾
->
addr
[
i
].
s_addr
 == 0) ;

417 
	`¢´štf
(
cmd
, (cmd),

418 "bË -˜% -ˆÇˆ% " 
c_u¾_wh™e
 " -d %s/%d -j ACCEPT -m comment --comment '%s'",

419 
	`cÜe_gw_iâame
(),

420 
š£¹
,

421 
	`š‘_Áß
(
u¾
->
addr
[
i
]),

422 
u¾
->
mask
,

423 
	`¡r_‹xt
(&
u¾
->url));

424 ià(
	`ems_sy¡emcmd
(
cmd
) != 0) {

426 
	`mem£t
(&
u¾
->
addr
[
i
], 0, (
š_addr
));

431  
EMS_OK
;

432 
	}
}

	@src/core/ems_fw.h

2 #iâdeà
EMS_FW_BALIST___HEADER____


3 
	#EMS_FW_BALIST___HEADER____


	)

5 
ems_št
 
fw_š™_chašs
(
ems_fw
 *
fw
);

6 
ems_št
 
fw_unš™_chašs
(
ems_fw
 *
fw
);

7 
ems_št
 
fw_upd©e_®l_ruËs
(
ems_fw
 *
fw
);

8 
ems_št
 
fw_wh™–i¡_ş—r
(
ems_fw
 *
fw
);

9 
ems_št
 
fw_u¾_£t_ä“
(
ems_fw
 *
fw
, 
dns_u¾
 *
u¾
,ƒms_šˆ
­³nd
);

10 
ems_št
 
fw_­³nd_u¾s
(
ems_fw
 *
fw
, 
ems_queue
 *
h—d
, 
jsÚ_objeù
 *
¬y
);

11 
ems_št
 
fw_»move_u¾s
(
ems_fw
 *
fw
, 
ems_queue
 *
h—d
, 
jsÚ_objeù
 *
¬y
);

12 
ems_št
 
fw_deviû_ä“
(
ems_cch¬
 *

,ƒms_cch¬ *
mac
,ƒms_šˆ
yes
);

13 
ems_št
 
fw_æush_wh‹li¡
(
ems_fw
 *
fw
);

14 
ems_void
 
fw_ş—r_®l
();

16 
	s_ems_fw_s
 {

18 
ems_queue
 
	mwh™–i¡
;

19 
ems_št
 
	mn_subdomaš
;

20 
ems_queue
 
	msubdomaš
;

23 
ems_£ssiÚ
 *
	m£ss_bšd
;

24 
ems_£ssiÚ
 *
	m£ss_dns
;

26 
ems_hash
 
	mhash_msg
;

27 
ems_hash
 
	mhash_u¾
;

29 
ems_queue
 
	mfwd
;

30 
ems_queue
 
	mwa™
;

31 
ems_queue
 
	mout
;

35 
	#MAX_SUB_DOMAIN
 300

	)

	@src/core/ems_main.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

4 
	~"ems_ş›Á.h
"

6 
	~<sigÇl.h
>

7 
	~<£tjmp.h
>

8 
	~<sys/ty³s.h
>

9 
	~<sys/¡©.h
>

11 
ems_cÜe
 *
	g_gcÜe
 = 
NULL
;

13 
ems_cÜe
 *
	$emscÜ”
()

15 
	`ems_as£¹
(
_gcÜe
 !ğ
NULL
);

16  
_gcÜe
;

17 
	}
}

19 
ems_cfg
 *
	$emscfg
()

21 
	`ems_as£¹
(
_gcÜe
 !ğ
NULL
);

22  &
_gcÜe
->
cfg
;

23 
	}
}

25 
ems_ev’t
 *
	$ev’‹r
()

27 
	`ems_as£¹
(
_gcÜe
 !ğ
NULL
);

28  &
_gcÜe
->
evt
;

29 
	}
}

31 
ems_queue
 *
	$timeou‹r
()

33 
	`ems_as£¹
(
_gcÜe
 !ğ
NULL
);

35  &
_gcÜe
->
evt
.
timeout
;

36 
	}
}

38 
ems_void
 
	$cÜe_gw_addr_ş—r
()

40 
	`¡r_£t
(&
_gcÜe
->
gw
, 
NULL
);

41 
	}
}

43 
ems_cch¬
 *
	$cÜe_gw_addr
()

45 ià(
	`¡r_Ën
(&
_gcÜe
->
gw
) <= 0) {

46 
	`¡r_£t
(&
_gcÜe
->
gw
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_Ïn_addr
));

49  
	`¡r_‹xt
(&
_gcÜe
->
gw
)?str_text(&_gcore->gw):"";

50 
	}
}

52 
ems_void
 
	$cÜe_gw_iâame_ş—r
()

54 
	`¡r_£t
(&
_gcÜe
->
iâame
, 
NULL
);

55 
	}
}

57 
ems_cch¬
 *
	$cÜe_gw_iâame
()

59 ià(
	`¡r_Ën
(&
_gcÜe
->
gw
) <= 0) {

60 
	`¡r_£t
(&
_gcÜe
->
iâame
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_Ïn_iâame
));

63  
	`¡r_‹xt
(&
_gcÜe
->
iâame
)?str_text(&_gcore->ifname):"br-lan";

64 
	}
}

66 
ems_bufãr
 *
	$cÜe_bufãr
()

68  &
_gcÜe
->
buf
;

69 
	}
}

71 
ems_cch¬
 *
	$cÜe_ac_mac
()

73 ià(
	`¡r_Ën
(&
_gcÜe
->
ac_mac
) <= 0) {

74 
	`¡r_£t
(&
_gcÜe
->
ac_mac
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_mac
));

77  
	`¡r_‹xt
(&
_gcÜe
->
ac_mac
)?str_text(&_gcore->ac_mac):"";

78 
	}
}

80 
ems_cch¬
 *
	$cÜe_pÜl_addr
()

82 ià(
	`¡r_Ën
(&
_gcÜe
->
pÜl
) <= 0) {

83 
	`¡r_£t
(&
_gcÜe
->
pÜl
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_­p_pÜl_addr
));

86  
	`¡r_‹xt
(&
_gcÜe
->
pÜl
)?str_text(&_gcore->portal):"";

87 
	}
}

89 
ems_št
 
	$cÜe_pÜl_»dœeù_pÜt
()

91 ià(
_gcÜe
->
pÜl_»dœeù_pÜt
 <= 0) {

92 
_gcÜe
->
pÜl_»dœeù_pÜt
 = 
	`ems_©oi
(
	`cfg_g‘
(
	`emscfg
(), 
CFG_­p_pÜl_»dœeù
));

95  
_gcÜe
->
pÜl_»dœeù_pÜt
;

96 
	}
}

98 
ems_cch¬
 *
	$cÜe_ssid
()

100 ià(
	`¡r_Ën
(&
_gcÜe
->
ssid
) <= 0) {

101 
	`¡r_£t
(&
_gcÜe
->
ssid
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_wœ–ess_ssid
));

104  
	`¡r_‹xt
(&
_gcÜe
->
ssid
)?str_text(&_gcore->ssid):"";

105 
	}
}

107 
ems_cch¬
 *
	$cÜe_deviûty³
()

109 ià(
	`¡r_Ën
(&
_gcÜe
->
devty
) <= 0) {

110 
	`¡r_£t
(&
_gcÜe
->
devty
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_deviûty³
));

113  
	`¡r_‹xt
(&
_gcÜe
->
devty
)?str_text(&_gcore->devty):"";

114 
	}
}

116 
ems_cch¬
 *
	$cÜe_¢
()

118 ià(
	`¡r_Ën
(&
_gcÜe
->
¢
) <= 0) {

119 
	`¡r_£t
(&
_gcÜe
->
¢
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_¢
));

122  
	`¡r_‹xt
(&
_gcÜe
->
¢
)?str_text(&_gcore->sn):"";

123 
	}
}

125 
ems_št
 
	$ems_maš
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

127 
ems_št
 
¹n
 = 
EMS_OK
;

128 
ems_cÜe
 *
cÜe
 = 
NULL
;

130 #ifdeà
EMS_LOGGER_FILE


131 
FILE
 *
å
 = 
NULL
;

132 
	`ems_logg”_»£t
(
	`logg”
());

133 
å
 = 
	`fİ’
("/tmp/ems_run_time.log", "a+");

134 ià(
å
)

135 
	`ems_logg”_£t_å
(
	`logg”
(), 
å
);

137 
	`ems_logg”_£t_Ëv–
(
	`logg”
(), 
EMS_LOG_TRACE
);

139 
cÜe
 = (
ems_cÜe
 *)
	`ems_m®loc
((ems_core));

140 ià(
cÜe
) {

141 
_gcÜe
 = 
cÜe
;

142 ià(
	`ems_cÜe_š™
(
cÜe
è=ğ
EMS_OK
)

143 
¹n
 = 
	`ems_cÜe_maš
(
cÜe
, 
¬gc
, 
¬gv
);

145 
	`ems_cÜe_unš™
(
cÜe
);

146 
_gcÜe
 = 
NULL
;

147 
	`ems_ä“
(
cÜe
);

150 #ifdeà
EMS_LOGGER_FILE


151 ià(
å
è
	`fşo£
(fp);

154  
¹n
;

155 
	}
}

	@src/core/ems_netcheck.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

5 
	~"ems_Ãtcheck.h
"

6 
	~"ems_bridge.h
"

9 
	~<Ãtš‘/š_sy¡m.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<Ãtš‘/.h
>

12 
	~<Ãtš‘/_icmp.h
>

13 
	~<Ãtdb.h
>

16 
	#PING_SEND_TIMEOUT
 2000

	)

17 
	#PING_IDLE_TIMEOUT
 5000

	)

19 
ems_ch¬
 *
	gÃt_addrs
[] =

22 
NULL


25 
ems_št
 
pšg_¡¬t
 (
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

26 
ems_št
 
pšg_¡İ³d
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

27 
ems_št
 
pšg_nÜm®
 (
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

28 
ems_št
 
pšg_pšg
 (
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

29 
ems_št
 
pšg_”r
 (
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

31 
	$ems_št
 (*
	tpšg_evt_func
)(
	tÃtcheck
 *
	tpšg
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_ušt
 
	tæg
);

32 
pšg_evt_func
 
pšg_evt_hªdËr
[] =

34 [
¡_¡¬t
] = 
pšg_¡¬t
,

35 [
¡_¡İ³d
] = 
pšg_¡İ³d
,

36 [
¡_nÜm®
] = 
pšg_nÜm®
,

37 [
¡_hb
] = 
pšg_pšg
,

38 [
¡_”r
] = 
pšg_”r
,

39 [
¡_max
] = 
NULL


40 
	}
};

43 
ems_št
 
pšg_to_nÜm®
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

44 
ems_št
 
pšg_to_pšg
 (
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

45 
ems_št
 
pšg_to_”r
 (
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

47 
	$ems_št
 (*
	tpšg_timeout_func
)(
	tÃtcheck
 *
	tpšg
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_timeout
 *
	tto
);

48 
pšg_timeout_func
 
pšg_timeout_hªdËr
[] =

50 [
¡_¡¬t
] = 
NULL
,

51 [
¡_¡İ³d
] = 
NULL
,

52 [
¡_nÜm®
] = 
pšg_to_nÜm®
,

53 [
¡_hb
] = 
pšg_to_pšg
,

54 [
¡_”r
] = 
pšg_to_”r
,

55 [
¡_max
] = 
NULL


56 
	}
};

58 
ems_št
 
pšg_evt_run
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

59 
ems_void
 
pšg_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
);

60 
ems_void
 
pšg_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

62 
ems_št
 
	$fw_»dœeù
(
ems_št
 
»
, 
ems_cch¬
 *
gw
,ƒms_cch¬ *
´o
,ƒms_šˆ
s_pÜt
,ƒms_šˆ
d_pÜt
)

64 
ems_ch¬
 *
ac
 = 
NULL
;

65 
ems_št
 
¹n
 = 
EMS_OK
;

67 
ems_ch¬
 *
buf
 = 
	`buf_wr
(
	`cÜe_bufãr
());

68 
ems_št
 
Ën
 = 
	`buf_Ëá
(
	`cÜe_bufãr
());

70 
ac
 = "-I";

71 ià(!
»
)

72 
ac
 = "-D";

74 
	`¢´štf
(
buf
, 
Ën
,

76 
	`cÜe_gw_iâame
(), 
ac
, 
´o
, 
gw
, 
s_pÜt
, gw, 
d_pÜt
);

78 
¹n
 = 
	`ems_sy¡emcmd
(
buf
);

81 ià(
»
)

82 
	`ems_sy¡emcmd
("uci -p /tmp/state set ykwifi.base.status=1");

84 
	`ems_sy¡emcmd
("uci -p /tmp/state del ykwifi.base.status");

87  
¹n
;

88 
	}
}

90 
ems_št
 
	$fw_»dœeù_v2
(
ems_št
 
»
, 
ems_cch¬
 *
gw
,ƒms_cch¬ *
´o
,ƒms_šˆ
s_pÜt
,ƒms_šˆ
d_pÜt
)

92 
ems_ch¬
 *
ac
 = 
NULL
;

93 
ems_št
 
¹n
 = 
EMS_OK
;

94 
ems_ch¬
 *
buf
 = 
	`buf_wr
(
	`cÜe_bufãr
());

95 
ems_št
 
Ën
 = 
	`buf_Ëá
(
	`cÜe_bufãr
());

97 
ac
 = "-I";

98 ià(!
»
)

99 
ac
 = "-D";

101 
	`¢´štf
(
buf
, 
Ën
,

103 
	`cÜe_gw_iâame
(), 
ac
, 
´o
, 
s_pÜt
, 
gw
, 
d_pÜt
);

105 
¹n
 = 
	`ems_sy¡emcmd
(
buf
);

107  
¹n
;

108 
	}
}

110 
ems_št
 
	$fw_»dœeù_web
(
ems_št
 
»
, 
ems_cch¬
 *
gw
)

112  
	`fw_»dœeù
(
»
, 
gw
, "tı", 80, 
EMS_PORT
);

113 
	}
}

115 
ems_št
 
	$fw_»dœeù_dns
(
ems_št
 
»
, 
ems_cch¬
 *
gw
)

117 
ems_ušt
 
evt
 = 
EMS_APP_DNS_INTERCEPT_START
;

119 ià(!
»
)

120 
evt
 = 
EMS_APP_DNS_INTERCEPT_STOP
;

122 
	`ems_­p_´oûss
(
ty_Ãt
,y_Ãt, 
evt
, 
NULL
);

124  
	`fw_»dœeù_v2
(
»
, 
gw
, "udp", 53, 
DNS_INTERCEPT_PORT
);

125 
	}
}

127 
ems_št
 
	$pšg_fw_»dœeù
(
Ãtcheck
 *
pšg
, 
ems_št
 
»dœeù
)

129 
ems_št
 
»
 = -1;

130 
ems_ch¬
 
buf
[256] = {0};

131 
ems_cch¬
 *
gw
 = 
NULL
;

133 ià((
»
 =ğ
»dœeù
è|| 
	`ems_æag_like
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE
))

134  
EMS_OK
;

137 
ems_ch¬
 
cmd
[256] = {0};

138 
	`¢´štf
(
cmd
, (cmd),

139 "„ou‹ | g»°% |‡wk '{´šˆ$5}'", 
	`cÜe_gw_iâame
());

141 
	`¢´štf
(
buf
, (buf), "%s", 
	`ems_pİ’_g‘
(
cmd
));

142 ià(
	`¡¾’
(
buf
) <= 0)

143  
EMS_OK
;

146 
gw
 = 
	`cÜe_gw_addr
();

148 ià(
	`¡rcmp
(
gw
, 
buf
)) {

149 
	`ems_l_Œaû
("gw chªged from : % što: %s", 
gw
, 
buf
);

151 ià(
»
) {

152 
	`fw_»dœeù_web
(
EMS_NO
, 
gw
);

153 
	`fw_»dœeù_dns
(
EMS_NO
, 
gw
);

156 
	`cfg_£t
(
	`emscfg
(), 
CFG_Ïn_addr
, 
buf
);

157 
	`cÜe_gw_addr_ş—r
();

158 
gw
 = 
	`cÜe_gw_addr
();

159 
	`ems_as£¹
(
gw
 !ğ
NULL
);

162 
»
 = 
»dœeù
;

164 
	`fw_»dœeù_web
(
»
, 
gw
);

165 
	`fw_»dœeù_dns
(
»
, 
gw
);

167  
EMS_OK
;

168 
	}
}

171 
u_shÜt
 
	$pšg_chksum
(
u_shÜt
 *
addr
, 
ems_št
 
Ën
)

173 
u_shÜt
 
ªsw”
, *
w
 = 
addr
;

174 
ems_št
 
sum
 = 0, 
Æeá
 = 
Ën
;

182  
Æeá
 > 1 ) {

183 
sum
 +ğ*
w
++;

184 
Æeá
 -= 2;

188 ifĞ
Æeá
 == 1 ) {

189 
u_shÜt
 
u
 = 0;

191 *(
u_ch¬
 *)(&
u
èğ*(u_ch¬ *)
w
 ;

192 
sum
 +ğ
u
;

198 
sum
 = (sum >> 16) + (sum & 0xffff);

199 
sum
 += (sum >> 16);

200 
ªsw”
 = ~
sum
;

202  
ªsw”
;

203 
	}
}

206 
ems_št
 
	$pšg_¡_što_pšg
(
Ãtcheck
 *
pšg
)

208 
i
, 
cc
, 
Ën
;;

209 
icmp
 *
iı
;

210 
timev®
 *

;

211 
ems_ch¬
 *
wr
;

212 
ems_£ssiÚ
 *
£ss
;

214 
	`ems_as£¹
(
pšg
 &&…šg->
£ss
);

216 
£ss
 = 
pšg
->sess;

217 
	`ems_bufãr_ş—r
(&
£ss
->
buf
);

219 
iı
 = (
icmp
 *è(
	`buf_wr
(&
£ss
->
buf
));

220 

 = (
timev®
 *è(
	`buf_wr
(&
£ss
->
buf
) + 8);

221 
wr
 = (
ems_ch¬
 *è(
	`buf_wr
(&
£ss
->
buf
è+ 8 + (
timev®
));

223 
iı
->
icmp_ty³
 = 
ICMP_ECHO
;

224 
iı
->
icmp_code
 = 0;

225 
iı
->
icmp_cksum
 = 0;

226 
iı
->
icmp_£q
 = 
	`htÚs
(
pšg
->
Á¿ns
++);

227 
iı
->
icmp_id
 = 
pšg
->
id’t
;

229 
Ën
 = 56;

230 
cc
 = 
Ën
 + 8;

231 
	`g‘timeofday
(

, 
NULL
);

233 
i
 = 8; i < 
Ën
; i++)

234 *
wr
++ = 
i
;

236 
iı
->
icmp_cksum
 = 
	`pšg_chksum
((
u_shÜt
 *)iı, 
cc
);

238 
pšg
->
»Œy
 = 3;

239 
	`ems_bufãr_£ek_wr
(&
£ss
->
buf
, 
cc
, 
EMS_BUFFER_SEEK_CUR
);

240 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
pšg_evt_cb
);

241 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
PING_SEND_TIMEOUT
, 
pšg_timeout_cb
);

243  
EMS_OK
;

244 
	}
}

246 
ems_št
 
	$pšg_chªge_¡©us
(
Ãtcheck
 *
pšg
, 
ems_¡©us
 
¡
)

248 
pšg
->
¡
 = st;

250 
pšg
->
¡
) {

251 
¡_¡¬t
:

252 
¡_¡İ³d
:

253 
¡_”r
:

254  
	`pšg_evt_run
(
pšg
, 
NULL
, 0);

257 
¡_hb
:

258  
	`pšg_¡_što_pšg
(
pšg
);

266  
EMS_OK
;

267 
	}
}

269 
ems_št
 
	$pšg_evt_run
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

271 
	`ems_as£¹
(
pšg_evt_hªdËr
[
pšg
->
¡
]);

272  
pšg_evt_hªdËr
[
pšg
->
¡
]Õšg, 
£ss
, 
æg
);

273 
	}
}

275 
ems_void
 
	$pšg_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

277 
Ãtcheck
 *
pšg
 = (Ãtcheck *)
	`£ss_cb¬g
(
£ss
);

279 
	`ems_as£¹
(
pšg
->
¡
 > 
¡_mš
 &&…šg->¡ < 
¡_max
);

281 ià(
”r
) {

282 
	`ems_l_Œaû
("[ping]ƒvtƒrr, sess: %d %s",

283 
	`ems_sock_fd
(&
£ss
->
sock
),

284 
	`ems_sock_addr
(&
£ss
->
sock
));

285 
	`pšg_chªge_¡©us
(
pšg
, 
¡_”r
);

289 
	`pšg_evt_run
(
pšg
, 
£ss
, 
æg
);

290 
	}
}

292 
ems_void
 
	$pšg_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

294 
Ãtcheck
 *
pšg
 = (Ãtcheck *)
	`£ss_cb¬g
(
£ss
);

296 
	`ems_as£¹
(
pšg
->
¡
 > 
¡_mš
 &&…šg->¡ < 
¡_max
);

298 
	`ems_as£¹
(
pšg_timeout_hªdËr
[
pšg
->
¡
]);

300 ià(
pšg_timeout_hªdËr
[
pšg
->
¡
])

301 
pšg_timeout_hªdËr
[
pšg
->
¡
]Õšg, 
£ss
, 
to
);

302 
	}
}

305 
ems_št
 
	$pšg_gw_addr
(
ems_£ssiÚ
 *
£ss
)

307 
ems_ch¬
 
buf
[64] = {0};

309 
	`¢´štf
(
buf
, (buf), "%s",

310 
	`ems_pİ’_g‘
("ip„oute | grep default | head -1 |‡wk '{print $3}'"));

312 ià(
	`¡¾’
(
buf
) <= 0)

313  
EMS_ERR
;

315 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
buf
);

317  
EMS_OK
;

318 
	}
}

320 
ems_št
 
	$pšg_gw_cÚÃù
(
ems_£ssiÚ
 *
£ss
)

322 
´ÙÛÁ
 *
´Ùo
;

323 
ems_sock
 *
sock
 = &
£ss
->sock;

324 
sockËn_t
 
Ën
;

325 
sockaddr_š
 
addr
;

326 
ems_št
 
fd
;

328 
	`mem£t
(&
addr
, 0, (addr));

330 ià(
	`ems_g‘ho¡byÇme
(
	`ems_sock_addr
(
sock
), &
addr
è!ğ
OK
) {

331 
	`ems_l_Œaû
("gethostbyename failed %s : %s",

332 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

333  
EMS_ERR
;

336 ià((
´Ùo
 = 
	`g‘´ÙobyÇme
("icmp")è=ğ
NULL
) {

337 
	`ems_l_Œaû
("getprotobyname failed %s : %s",

338 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

339  
EMS_ERR
;

342 ià((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_RAW
, 
´Ùo
->
p_´Ùo
)) < 0) {

343 
	`ems_l_Œaû
("sock‘ƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

344  
EMS_ERR
;

347 
addr
.
sš_çmy
 = 
AF_INET
;

348 
Ën
 = (
sockaddr_š
);

350 ià(
	`cÚÃù
(
fd
, (
sockaddr
 *)&
addr
, 
Ën
)) {

351 
	`şo£
(
fd
);

352 
	`ems_l_Œaû
("cÚÃùƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

353  
EMS_ERR
;

356 
	`ems_sock_£tfd
(&
£ss
->
sock
, 
fd
);

358  
EMS_OK
;

359 
	}
}

361 
ems_št
 
	$pšg_¡¬t
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

363 ià(!
pšg
->
£ss
) {

364 
pšg
->
£ss
 = 
	`ems_£ssiÚ_Ãw
();

365 ià(!
pšg
->
£ss
)

366  
EMS_ERR
;

368 
	`£ss_cb¬g_£t
(
pšg
->
£ss
,…ing);

371 
£ss
 = 
pšg
->sess;

372 
	`ems_bufãr_ş—r
(&
£ss
->
buf
);

373 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

375 
pšg
->
id’t
 = 
	`¿ndom
() & 0xFFFF;

376 
pšg
->
Á¿ns
 = 0;

377 
pšg
->
id
 = 0;

378 
pšg
->
»Œy
 = 3;

380 ià(
	`pšg_gw_addr
(
£ss
è!ğ
EMS_OK
)

381  
	`pšg_chªge_¡©us
(
pšg
, 
¡_”r
);

383 
ems_cch¬
 *
wª
 = 
	`cfg_g‘
(
	`emscfg
(), 
CFG_wª_addr
);

385 ià(!
wª
 || 
	`¡rcmp
(
	`ems_sock_addr
(&
£ss
->
sock
), wan))

387 
	`¡r_ş—r
(&
	`emscÜ”
()->
gw
);

388 
	`¡r_ş—r
(&
	`emscÜ”
()->
iâame
);

389 
	`¡r_ş—r
(&
	`emscÜ”
()->
ac_mac
);

390 
	`¡r_ş—r
(&
	`emscÜ”
()->
ssid
);

391 
	`ems_æush_sy¡em_šfo
();

395 ià(
	`pšg_gw_cÚÃù
(
£ss
è!ğ
EMS_OK
)

396  
	`pšg_chªge_¡©us
(
pšg
, 
¡_”r
);

398 
	`ems_l_Œaû
("[ping] sess: %d gw‡ddr: %s",

399 
	`ems_sock_fd
(&
£ss
->
sock
), 
	`ems_sock_addr
(&sess->sock));

401  
	`pšg_chªge_¡©us
(
pšg
, 
¡_hb
);

402 
	}
}

404 
ems_št
 
	$pšg_¡İ³d
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

406 
£ss
 = 
pšg
->sess;

408 ià(
£ss
) {

409 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
£ss
);

410 
pšg
->
£ss
 = 
NULL
;

413 
	`pšg_fw_»dœeù
(
pšg
, 
EMS_NO
);

415  
EMS_OK
;

416 
	}
}

418 
ems_št
 
	$pšg_nÜm®
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

420 
	`ems_as£¹
(0 && "should‚ever be here");

421  
EMS_OK
;

422 
	}
}

424 
ems_št


425 
	$pšg_£nd
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

427 
ems_št
 
»t
;

429 
	`ems_as£¹
(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
));

431 
»t
 = 
	`£ss_£nd
(
£ss
, &£ss->
buf
);

433 ià(
»t
 <= 0) {

434 
»t
) {

436 -
EAGAIN
:

440  
EMS_ERR
;

444 ià(
	`buf_Ën
(&
£ss
->
buf
) <= 0)

445 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
pšg_evt_cb
);

447  
EMS_OK
;

448 
	}
}

450 
ems_št
 
	$pšg_»cv_hªdË
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
)

452 

 *ip;

453 
icmp
 *
iı
;

454 
hËn
, 
cc
 = 
	`buf_Ën
(&
£ss
->
buf_š
);

456 

 = ( *è
	`buf_rd
(&
£ss
->
buf_š
);

457 
hËn
 = 

->
_hl
 << 2;

459 ià(
cc
 < 
hËn
 + 
ICMP_MINLEN
)

460  
EMS_OK
;

462 
cc
 -ğ
hËn
;

463 
iı
 = (
icmp
 *)(
	`buf_rd
(&
£ss
->
buf_š
è+ 
hËn
);

465 if(
iı
->
icmp_ty³
 !ğ
ICMP_ECHOREPLY
) {

466 
	`ems_l_Œaû
("[pšg] %d by‹ icm°nÙƒchØ»¶y, %d", 
cc
, 
iı
->
icmp_ty³
);

467 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

468  
EMS_OK
;

471 ifĞ
iı
->
icmp_id
 !ğ
pšg
->
id’t
) {

472 
	`ems_l_Œaû
("[pšg] %d by‹ icm°id’t: %d !ğ%d", 
cc
, 
iı
->
icmp_id
, 
pšg
->
id’t
);

473 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

474  
EMS_OK
;

477 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

479 
	`£ss_ev’t_ÿnûl
(
£ss
);

480 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
PING_IDLE_TIMEOUT
, 
pšg_timeout_cb
);

482 
	`ems_æag_£t
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_READY
);

484 
	`pšg_fw_»dœeù
(
pšg
, 
EMS_NO
);

486 ià(
	`ems_æag_uÆike
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE_RUN
)) {

487 
	`ems_æag_£t
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE_RUN
);

489 ià(
	`ems_æag_uÆike
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE
))

490 
	`ems_­p_´oûss
(
ty_Ãt
, 
ty_bridge
, 
EMS_APP_START
, 
NULL
);

494  
	`pšg_chªge_¡©us
(
pšg
, 
¡_nÜm®
);

495 
	}
}

497 
ems_št


498 
	$pšg_»cv
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
)

500 
ems_št
 
»t
;

501 
ems_ch¬
 *
wr
 = 
	`buf_wr
(&
£ss
->
buf_š
);

502 
ems_št
 
Ën
 = 
	`buf_Ëá
(&
£ss
->
buf_š
);

504 
agaš
:

505 
»t
 = 
	`»cv
(
	`ems_sock_fd
(&
£ss
->
sock
), 
wr
, 
Ën
, 0);

507 ià(
»t
 <= 0) {

508 
”ºo
) {

510 
EAGAIN
:

511 
EINTR
:

512  
EMS_OK
;

515 
	`ems_l_Œaû
("[pšg]…šgƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

516  
EMS_ERR
;

520 
	`ems_bufãr_£ek_wr
(&
£ss
->
buf_š
, 
»t
, 
EMS_BUFFER_SEEK_CUR
);

522 
»t
 = 
	`pšg_»cv_hªdË
(
pšg
, 
£ss
);

524 
agaš
;

526  
EMS_OK
;

527 
	}
}

530 
ems_št
 
	$pšg_pšg
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

532 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

533 ià(
	`pšg_»cv
(
pšg
, 
£ss
è!ğ
EMS_OK
)

534  
	`pšg_chªge_¡©us
(
pšg
, 
¡_”r
);

536  
EMS_OK
;

539 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

540 ià(
	`pšg_£nd
(
pšg
, 
£ss
, 
æg
è!ğ
EMS_OK
)

541  
	`pšg_chªge_¡©us
(
pšg
, 
¡_”r
);

544  
EMS_OK
;

545 
	}
}

547 
ems_št
 
	$pšg_”r
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

549 
	`ems_as£¹
(
pšg
->
£ss
 !ğ
NULL
);

551 
£ss
 = 
pšg
->sess;

553 ià(
£ss
) {

554 
	`£ss_ev’t_ÿnûl
(
£ss
);

555 
	`ems_l_Œaû
("[ping]shutdown session(%d) with [%s]",

556 
	`ems_sock_fd
(&
£ss
->
sock
),

557 
	`ems_sock_addr
(&
£ss
->
sock
));

558 
	`ems_sock_şo£
(&
£ss
->
sock
);

559 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
PING_IDLE_TIMEOUT
, 
pšg_timeout_cb
);

562 
	`ems_æag_un£t
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_READY
);

563 
	`pšg_fw_»dœeù
(
pšg
, 
EMS_YES
);

565 ià(
	`ems_æag_uÆike
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE
)) {

566 ià(!
	`ems_­p_run
(
ty_dowÆšk
))

567 
	`ems_æag_un£t
(
	`emscÜ”
()->
æg
, 
FLG_NETWORK_BRIDGE_RUN
);

568 
	`ems_­p_´oûss
(
ty_Ãt
, 
ty_bridge
, 
EMS_APP_STOP
, 
NULL
);

571  
EMS_OK
;

572 
	}
}

575 
ems_št
 
	$pšg_to_nÜm®
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

577  
	`pšg_chªge_¡©us
(
pšg
, 
¡_hb
);

578 
	}
}

580 
ems_št
 
	$pšg_to_pšg
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

582 
ems_cch¬
 *
addr
 = 
NULL
;

584 
	`ems_l_Œaû
("[pšg]imeout...,„‘ryimes: %d", 
pšg
->
»Œy
);

586 
pšg
->
»Œy
--;

588 
	`£ss_ev’t_ÿnûl
(
£ss
);

590 ià(
pšg
->
»Œy
) {

591 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf
, 0, 
EMS_BUFFER_SEEK_SET
);

592 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
pšg_evt_cb
);

593 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
PING_SEND_TIMEOUT
, 
pšg_timeout_cb
);

594  
EMS_OK
;

597 
addr
 = 
Ãt_addrs
[
pšg
->
id
++];

599 ià(
addr
) {

600 
	`£ss_ev’t_ÿnûl
(
£ss
);

601 
	`ems_l_Œaû
("[ping]shutdown session(%d) with [%s]",

602 
	`ems_sock_fd
(&
£ss
->
sock
),

603 
	`ems_sock_addr
(&
£ss
->
sock
));

604 
	`ems_sock_şo£
(&
£ss
->
sock
);

606 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
addr
);

608 ià(
	`pšg_gw_cÚÃù
(
£ss
è!ğ
EMS_OK
)

609  
	`pšg_chªge_¡©us
(
pšg
, 
¡_”r
);

611 
	`ems_l_Œaû
("[ping] sess: %d‡ddr: %s",

612 
	`ems_sock_fd
(&
£ss
->
sock
), 
	`ems_sock_addr
(&sess->sock));

614  
	`pšg_chªge_¡©us
(
pšg
, 
¡_hb
);

617  
	`pšg_chªge_¡©us
(
pšg
, 
¡_”r
);

618 
	}
}

620 
ems_št
 
	$pšg_to_”r
(
Ãtcheck
 *
pšg
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

622  
	`pšg_chªge_¡©us
(
pšg
, 
¡_¡¬t
);

623 
	}
}

	@src/core/ems_netcheck.h

2 #iâdeà
EMS_CLIENT_NET_CHECK_____


3 
	#EMS_CLIENT_NET_CHECK_____


	)

5 
	#DNS_INTERCEPT_PORT
 9112

	)

7 
_Ãtcheck_s
 
	tÃtcheck
;

9 
	s_Ãtcheck_s


11 
ems_¡©us
 
	m¡
;

14 
ems_ušt
 
	mÁ¿ns
;

15 
ems_št
 
	mid’t
;

16 
ems_št
 
	mid
;

17 
ems_št
 
	m»Œy
;

18 
ems_£ssiÚ
 *
	m£ss
;

19 
ems_£ssiÚ
 *
	m£ss_dns
;

22 
ems_št
 
pšg_chªge_¡©us
(
Ãtcheck
 *
pšg
, 
ems_¡©us
 
¡
);

	@src/core/ems_portal.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

5 
	~"ems_fw.h
"

6 
	~"ems_pÜl.h
"

7 
	~"ems_¿dius.h
"

9 
	#PORTAL_RETRY_TIMES
 3

	)

10 
	#PORTAL_RETRY_TIMEOUT
 9

	)

11 
	#PORTAL_ERROR_TIMEOUT
 30000

	)

13 
	#ERR_PORTAL_NETWORK
 0x3000

	)

14 
	#ERR_PORTAL_RESPONSE
 0x3001

	)

17 
ems_št
 
pÜl_¡¬t
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

18 
ems_št
 
pÜl_»g
 (
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

19 
ems_št
 
pÜl_nÜm®
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

20 
ems_št
 
pÜl_hb
 (
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

21 
ems_št
 
pÜl_¡İ³d
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

22 
ems_št
 
pÜl_”r
 (
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

24 
	$ems_št
 (*
	tpÜl_evt_func
)(
	tems_pÜl
 *
	t±l
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_ušt
 
	tæg
);

25 
pÜl_evt_func
 
pÜl_evt_hªdËr
[] =

27 [
¡_¡¬t
] = 
pÜl_¡¬t
,

28 [
¡_»g
] = 
pÜl_»g
,

29 [
¡_nÜm®
] = 
pÜl_nÜm®
,

30 [
¡_hb
] = 
pÜl_hb
,

31 [
¡_”r
] = 
pÜl_”r
,

32 [
¡_¡İ³d
] = 
pÜl_¡İ³d


33 
	}
};

35 
ems_št
 
pÜl_to_»g
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

36 
ems_št
 
pÜl_to_nÜm®
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

37 
ems_št
 
pÜl_to_hb
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

38 
ems_št
 
pÜl_to_”r
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

40 
	$ems_št
 (*
	tpÜl_timeout_func
)(
	tems_pÜl
 *
	t±l
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_timeout
 *
	tto
);

41 
pÜl_timeout_func
 
pÜl_timeout_hªdËr
[] =

43 [
¡_¡¬t
] = 
NULL
,

44 [
¡_»g
] = 
pÜl_to_»g
,

45 [
¡_nÜm®
] = 
pÜl_to_nÜm®
,

46 [
¡_hb
] = 
pÜl_to_hb
,

47 [
¡_”r
] = 
pÜl_to_”r
,

48 [
¡_¡İ³d
] = 
NULL


49 
	}
};

51 
	$ems_št
 (*
	t±l_»cv_cb
)(
	tems_pÜl
 *
	t±l
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_queue
 *
	tli¡
);

55 
ems_št
 
©Œ
;

56 
ems_št
 
id
;

57 
ems_št
 
ty
;

58 } 
	tpÜl_diù
;

61 
ems_uch¬
 
ty
;

62 
ems_uch¬
 
Ën
;

63 
ems_ch¬
 
v®
[2];

64 } 
	tpÜl_©Œ
;

67 
pÜl_ty_»q_ch®Ënge
 = 0x01,

68 
pÜl_ty_ack_ch®Ënge
 = 0x02,

69 
pÜl_ty_»q_auth
 = 0x03,

70 
pÜl_ty_ack_auth
 = 0x04,

71 
pÜl_ty_»q_logout
 = 0x05,

72 
pÜl_ty_ack_logout
 = 0x06,

73 
pÜl_ty_aff_ack_auth
 = 0x07,

74 
pÜl_ty_Áf_logout
 = 0x08,

75 
pÜl_ty_»q_šfo
 = 0x09,

76 
pÜl_ty_ack_šfo
 = 0x0a

80 
pÜl_u£r_¡_nÜm®
 = 0x00,

81 
pÜl_u£r_¡_»q_ch®Ënge
 = 0x01,

82 
pÜl_u£r_¡_ack_ch®Ënge
 = 0x02,

83 
pÜl_u£r_¡_»q_auth
 = 0x03,

84 
pÜl_u£r_¡_ack_auth
 = 0x04,

85 
pÜl_u£r_¡_»q_logout
 = 0x05,

86 
pÜl_u£r_¡_ack_logout
 = 0x06,

87 
pÜl_u£r_¡_aff_ack_auth
 = 0x07,

88 
pÜl_u£r_¡_Áf_logout
 = 0x08

91 
	#PORTAL_AUTH_TYPE
 "PAP,CHAP"

	)

93 
	#TYPE_INT
 0

	)

94 
	#TYPE_STRING
 1

	)

96 
	#ATTR_PKGTYPE
 0x01

	)

97 
	#ATTR_AUTHTYPE
 0x02

	)

98 
	#ATTR_NASNAME
 0x03

	)

99 
	#ATTR_RESPONSE
 0x04

	)

100 
	#ATTR_USERNAME
 0x05

	)

101 
	#ATTR_PASSWORD
 0x06

	)

102 
	#ATTR_CHALLENGE
 0x07

	)

103 
	#ATTR_CHAPPASS
 0x08

	)

104 
	#ATTR_USERMAC
 0x09

	)

105 
	#ATTR_ONLINE
 0x0a

	)

108 
pÜl_diù
 
g_diù
[] = {

109 {
ATTR_PKGTYPE
, 0x0b, 
TYPE_INT
},

110 {
ATTR_AUTHTYPE
, 0x02, 
TYPE_STRING
},

111 {
ATTR_NASNAME
, 0x03, 
TYPE_STRING
},

112 {
ATTR_RESPONSE
, 0x12, 
TYPE_STRING
},

113 {
ATTR_USERNAME
, 0x01, 
TYPE_STRING
},

114 {
ATTR_PASSWORD
, 0x02, 
TYPE_STRING
},

115 {
ATTR_CHALLENGE
, 0x03, 
TYPE_STRING
},

116 {
ATTR_CHAPPASS
, 0x04, 
TYPE_STRING
},

117 {
ATTR_USERMAC
, 0xc9, 
TYPE_STRING
},

118 {
ATTR_ONLINE
, 0x09, 
TYPE_STRING
}

119 
	}
};

121 
pÜl_diù
 *
	$±l_diù_lßd
(
ems_št
 
©Œ
)

123 
ems_št
 
i
, 
Ën
;

124 
pÜl_diù
 *
diù
 = 
NULL
;

126 
Ën
 = (
g_diù
è/ (
pÜl_diù
);

128 
i
 = 0; i < 
Ën
; i++) {

129 
diù
 = &
g_diù
[
i
];

131 ià(
diù
->
©Œ
 ==‡ttr)

132  
diù
;

135  
NULL
;

136 
	}
}

139 
ems_void
 
	$±l_vp_de¡roy
(
pÜl_v®ue_·œ
 *
vp
)

141 ià(
vp
) {

142 ià(
vp
->
v®
) {

143 
	`ems_ä“
(
vp
->
v®
);

144 
vp
->
v®
 = 
NULL
;

147 
	`ems_ä“
(
vp
);

149 
	}
}

151 
pÜl_v®ue_·œ
 *
	$±l_vp_Ãw
()

153 
pÜl_v®ue_·œ
 *
vp
 = 
NULL
;

155 
vp
 = (
pÜl_v®ue_·œ
 *)
	`ems_m®loc
((portal_value_pair));

156 ià(
vp
) {

157 
	`mem£t
(
vp
, 0, (
pÜl_v®ue_·œ
));

158 
vp
->
v®
 = 
NULL
;

159 
	`ems_queue_š™
(&
vp
->
’Œy
);

162  
vp
;

163 
	}
}

166 
pÜl_v®ue_·œ
 *

167 
	$±l_vp_­³nd
(
ems_queue
 *
h—d
, 
ems_št
 
©Œ
, 
ems_cch¬
 *
v®
,ƒms_šˆ
lv®
)

169 
pÜl_diù
 *
diù
 = 
NULL
;

170 
pÜl_v®ue_·œ
 *
vp
 = 
NULL
;

172 
diù
 = 
	`±l_diù_lßd
(
©Œ
);

173 ià(!
diù
) {

174 
	`ems_as£¹
(0 && "should‚ever be here");

175 
	`ems_l_Œaû
("[pÜl] did‚Ù fšd‡ny‡‰ribu‹ : %d", 
©Œ
);

176  
NULL
;

179 
vp
 = 
	`±l_vp_Ãw
();

180 ià(!
vp
)

181  
NULL
;

183 
vp
->
©Œ
 = 
diù
->attr;

184 
vp
->
id
 = 
diù
->id;

185 
vp
->
ty
 = 
diù
->ty;

187 
diù
->
ty
) {

188 
TYPE_STRING
:

190 ià(
v®
) {

191 ià(
lv®
 < 0)

192 
lv®
 = 
	`¡¾’
((
ems_ch¬
 *)
v®
);

194 
vp
->
lv®
 =†val;

195 ià(
vp
->
lv®
 > 253) {

196 
	`ems_l_Œaû
("[pÜl] v®uËngthoØlÚg: %d", 
vp
->
lv®
);

197 
	`±l_vp_de¡roy
(
vp
);

198  
NULL
;

201 
vp
->
v®
 = 
	`ems_m®loc
(
lv®
 + 1);

202 ià(!
vp
->
v®
) {

203 
	`±l_vp_de¡roy
(
vp
);

204  
NULL
;

207 
	`memıy
(
vp
->
v®
, v®, 
lv®
);

208 
vp
->
v®
[vp->
lv®
] = '\0';

210 
vp
->
v®
 = 
NULL
;

211 
vp
->
lv®
 = 0;

216 
TYPE_INT
:

218 
vp
->
lv®
 = *(
ems_št
 *)
v®
;

223 
	`ems_as£¹
(0 && "never be here");

224 
	`±l_vp_de¡roy
(
vp
);

225  
NULL
;

228 
	`ems_queue_š£¹_
(
h—d
, &
vp
->
’Œy
);

230  
vp
;

231 
	}
}

233 
ems_št
 
	$±l_·ck_li¡
(
ems_queue
 *
li¡
, 
ems_bufãr
 *
buff
)

235 
pÜl_v®ue_·œ
 *
vp
 = 
NULL
;

236 
pÜl_©Œ
 *
©Œ
;

237 
ems_queue
 *
q
;

238 
ems_ch¬
 *
buf
 = 
	`buf_wr
(
buff
);

239 
ems_št
 
lbuf
 = 
	`buf_Ëá
(
buff
);

241 
	`ems_queue_fÜ—ch
(
li¡
, 
q
) {

242 
vp
 = 
	`ems_cÚš”_of
(
q
, 
pÜl_v®ue_·œ
, 
’Œy
);

243 
©Œ
 = (
pÜl_©Œ
 *è
buf
;

245 ià(
lbuf
 <= 0)

246  
EMS_BUFFER_INSUFFICIENT
;

248 
vp
->
ty
) {

249 
TYPE_STRING
:

251 
©Œ
->
ty
 = 
vp
->
id
;

252 
©Œ
->
Ën
 = 
vp
->
lv®
 + 2;

254 ià(
lbuf
 <ğ
©Œ
->
Ën
)

255  
EMS_BUFFER_INSUFFICIENT
;

257 ià(
vp
->
v®
) {

258 
	`ems_as£¹
(
vp
->
lv®
 > 0);

259 
	`memıy
(
©Œ
->
v®
, 
vp
->v®, vp->
lv®
);

264 
TYPE_INT
:

266 
©Œ
->
ty
 = 
vp
->
id
;

267 
©Œ
->
Ën
 = 6;

269 ià(
lbuf
 <ğ
©Œ
->
Ën
)

270  
EMS_BUFFER_INSUFFICIENT
;

272 
vp
->
lv®
 = 
	`htÚl
(vp->lval);

274 
	`memıy
(
©Œ
->
v®
, &
vp
->
lv®
, 4);

279 
	`ems_as£¹
(0 && "never be here");

280  
EMS_ERR
;

283 
buf
 +ğ
©Œ
->
Ën
;

284 
lbuf
 -ğ
©Œ
->
Ën
;

287 
	`ems_bufãr_£ek_wr
(
buff
, 
	`abs
(
	`buf_wr
(buffè- 
buf
), 
EMS_BUFFER_SEEK_CUR
);

289  
EMS_OK
;

290 
	}
}

292 
ems_št


293 
	$±l_·r£_ùx
(
ems_queue
 *
li¡
, 
ems_cch¬
 *
buf
, 
ems_št
 
lbuf
,ƒms_šˆ
n
,ƒms_šˆ
evt
)

295 
pÜl_v®ue_·œ
 *
vp
 = 
NULL
;

296 
pÜl_©Œ
 *
©Œ
 = 
NULL
;

297 
ems_cch¬
 *
p
;

298 
ems_št
 
©Œibu‹
;

300 
p
 = 
buf
;

301 
n
 !ğ0 && 
lbuf
 > 0) {

302 
©Œ
 = (
pÜl_©Œ
 *)
buf
;

303 ià(
lbuf
 < 
©Œ
->
Ën
)

304  
EMS_CONTINUE
;

306 
buf
 +ğ
©Œ
->
Ën
;

307 
lbuf
 -ğ
©Œ
->
Ën
;

308 
n
--;

310 
©Œ
->
ty
) {

312 
©Œibu‹
 = 
ATTR_USERNAME
;

315 
©Œibu‹
 = 
ATTR_PKGTYPE
;

318 
©Œibu‹
 = 
ATTR_AUTHTYPE
;

319 ià(
evt
)

320 
©Œibu‹
 = 
ATTR_PASSWORD
;

323 
©Œibu‹
 = 
ATTR_NASNAME
;

324 ià(
evt
)

325 
©Œibu‹
 = 
ATTR_CHALLENGE
;

328 
©Œibu‹
 = 
ATTR_CHAPPASS
;

331 
©Œibu‹
 = 
ATTR_USERMAC
;

334 
©Œibu‹
 = 
ATTR_RESPONSE
;

337 
©Œibu‹
 = 
ATTR_ONLINE
;

341 
©Œibu‹
 = 0;

342 
	`ems_l_Œaû
("[pÜl] unkowÀty: %d,†’gth: %d", 
©Œ
->
ty
,‡‰r->
Ën
);

343 ià(
©Œ
->
Ën
 <= 0) {

344 
	`ems_l_Œaû
("[pÜl]·r£ stİ³d", 
©Œ
->
ty
,‡‰r->
Ën
);

345  
	`abs
(
buf
 -
p
);

350 ià(
©Œibu‹
 == 0)

353 
vp
 = 
	`±l_vp_­³nd
(
li¡
, 
©Œibu‹
, 
©Œ
->
v®
,‡‰r->
Ën
 - 2);

355 ià(
vp
 && (vp->
ty
 =ğ
TYPE_INT
)) {

356 
vp
->
lv®
 = 
	`Áohl
(vp->lval);

359 #ifdeà
DEBUG


360 ià(
vp
) {

361 ià(
vp
->
ty
 =ğ
TYPE_INT
)

362 
	`ems_l_Œaû
("[portal] got‡ttr: %d, id: %d, value: %x",

363 
vp
->
©Œ
, vp->
id
, vp->
lv®
);

366 ià(
©Œibu‹
 =ğ
ATTR_USERMAC
) {

367 
ems_ch¬
 
u£rmac
[12];

368 
	`ems_bš2¡r
(
vp
->
v®
, vp->
lv®
, 
u£rmac
, 12);

369 
	`ems_l_Œaû
("[portal] got‡ttr: %d, id: %d value: %s",

370 
vp
->
©Œ
, vp->
id
, 
u£rmac
);

373 
	`ems_l_Œaû
("[portal] got‡ttr: %d, id: %d, value: %s",

374 
vp
->
©Œ
, vp->
id
, vp->
v®
?vp->val:"no ctx");

380  
	`abs
(
buf
 - 
p
);

381 
	}
}

383 
pÜl_v®ue_·œ
 *
	$±l_vp_fšd
(
ems_queue
 *
li¡
, 
ems_št
 
©Œ
)

385 
ems_queue
 *
p
;

386 
pÜl_v®ue_·œ
 *
vp
 = 
NULL
;

388 
	`ems_queue_fÜ—ch
(
li¡
, 
p
) {

389 
vp
 = 
	`ems_cÚš”_of
(
p
, 
pÜl_v®ue_·œ
, 
’Œy
);

391 ià(
vp
->
©Œ
 ==‡ttr)

392  
vp
;

395  
NULL
;

396 
	}
}

400 
pÜl_u£r
 *
	$±l_u£r_Ãw
()

402 
pÜl_u£r
 *
u£r
 = 
NULL
;

404 
u£r
 = (
pÜl_u£r
 *)
	`ems_m®loc
((portal_user));

405 ià(
u£r
) {

406 
	`mem£t
(
u£r
, 0, (
pÜl_u£r
));

407 
	`¡r_š™
(&
u£r
->
Çme
);

408 
	`¡r_š™
(&
u£r
->
·ss
);

409 
	`¡r_š™
(&
u£r
->
mac
);

410 
	`¡r_š™
(&
u£r
->

);

412 
u£r
->
£rŸl
 = 0;

413 
u£r
->
»qid
 = 0;

414 
u£r
->
æg
 = 0;

416 
	`ems_timeout_š™
(&
u£r
->
to
);

417 
	`ems_bufãr_š™
(&
u£r
->
buf_out
, 
EMS_BUFFER_1K
);

418 
u£r
->
¡
 = 
pÜl_u£r_¡_nÜm®
;

419 
u£r
->
»Œy_times
 = 0;

420 
u£r
->
»Œy_timeout
 = 0;

422 
	`ems_queue_š™
(&
u£r
->
’Œy
);

425  
u£r
;

426 
	}
}

428 
ems_void
 
	$±l_u£r_de¡roy
(
pÜl_u£r
 *
u£r
)

430 ià(
u£r
) {

431 
	`ems_l_Œaû
("destroy user(%s, %s, %s, %s),ƒxit st: 0x%x",

432 
	`¡r_‹xt
(&
u£r
->
Çme
),

433 
	`¡r_‹xt
(&
u£r
->
·ss
),

434 
	`¡r_‹xt
(&
u£r
->
mac
),

435 
	`¡r_‹xt
(&
u£r
->

),

436 
u£r
->
¡


438 
	`¡r_ş—r
(&
u£r
->
Çme
);

439 
	`¡r_ş—r
(&
u£r
->
·ss
);

440 
	`¡r_ş—r
(&
u£r
->
mac
);

441 
	`¡r_ş—r
(&
u£r
->

);

444 
	`ems_bufãr_unš™
(&
u£r
->
buf_out
);

445 
	`ems_ä“
(
u£r
);

447 
	}
}

450 
pÜl_u£r
 *
	$±l_u£r_fšd
(
ems_pÜl
 *
±l
, 
ems_cch¬
 *

)

452 
ems_queue
 *
p
;

453 
pÜl_u£r
 *
u£r
;

455 
	`ems_as£¹
(
±l
 && 

);

457 
	`ems_queue_fÜ—ch
(&
±l
->
u£rs
, 
p
) {

459 
u£r
 = 
	`ems_cÚš”_of
(
p
, 
pÜl_u£r
, 
’Œy
);

461 
	`ems_as£¹
(
	`¡r_Ën
(&
u£r
->

) > 0);

463 ià(!
	`¡rcmp
(
	`¡r_‹xt
(&
u£r
->

), ip))

464  
u£r
;

467  
NULL
;

468 
	}
}

472 
ems_št
 
	$±l_evt_run
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

474 
	`ems_as£¹
(
pÜl_evt_hªdËr
[
±l
->
¡
] !ğ
NULL
);

476  
pÜl_evt_hªdËr
[
±l
->
¡
]Õ, 
£ss
, 
æg
);

477 
	}
}

479 
ems_št


480 
	$±l_timeout_run
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

482 
	`ems_as£¹
(
pÜl_timeout_hªdËr
[
±l
->
¡
] !ğ
NULL
);

484 ià(
pÜl_timeout_hªdËr
[
±l
->
¡
])

485  
pÜl_timeout_hªdËr
[
±l
->
¡
]Õ, 
£ss
, 
to
);

487  
EMS_OK
;

488 
	}
}

490 
ems_void
 
	$±l_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

492 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
	`£ss_cb¬g
(
£ss
);

494 
	`ems_as£¹
(
±l
->
¡
 > 
¡_mš
 &&…->¡ < 
¡_max
);

496 ià(
”r
) {

497 
	`ems_l_Œaû
("[portal]ƒvtƒrr, sess: %d %s",

498 
	`ems_sock_fd
(&
£ss
->
sock
),

499 
	`ems_sock_addr
(&
£ss
->
sock
));

500 
±l
->
Ï¡”r
 = 
ERR_PORTAL_NETWORK
;

501 
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

505 
	`±l_evt_run
(
±l
, 
£ss
, 
æg
);

506 
	}
}

508 
ems_void
 
	$±l_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

510 
ems_pÜl
 *
±l
 = (ems_pÜÈ*)
	`£ss_cb¬g
(
£ss
);

512 
	`ems_as£¹
(
±l
->
¡
 > 
¡_mš
 &&…->¡ < 
¡_max
);

514 
	`±l_timeout_run
(
±l
, 
£ss
, 
to
);

515 
	}
}

517 
ems_št
 
	$pÜl_cÚÃù
(
ems_£ssiÚ
 *
£ss
)

519 
ems_št
 
fd
;

520 
sockËn_t
 
Ën
;

521 
sockaddr_š
 
addr
;

522 
ems_sock
 *
sock
 = &
£ss
->sock;

523 
	`ems_as£¹
(
£ss
);

525 
	`mem£t
(&
addr
, 0, (addr));

526 ià(
	`ems_g‘ho¡byÇme
(
	`ems_sock_addr
(
sock
), &
addr
è!ğ
OK
) {

527 
	`ems_l_Œaû
("[portal]gethostbyename failed %s : %s",

528 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

529  
EMS_ERR
;

532 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

533 ià(
fd
 <= 0)

534  
EMS_ERR
;

536 
	`ems_l_Œaû
("[portal] sess(%d) connecto: %s(%s): %d...",

537 
fd
,

538 
	`ems_sock_addr
(
sock
),

539 
	`š‘_Áß
(
addr
.
sš_addr
),

540 
	`ems_sock_pÜt
(
sock
));

542 
addr
.
sš_çmy
 = 
AF_INET
;

543 
addr
.
sš_pÜt
 = 
	`htÚs
(
	`ems_sock_pÜt
(
sock
));

545 
	`ems_£ŠÚblockšg
(
fd
, 
YES
);

546 
Ën
 = (
sockaddr_š
);

547 ià(
	`cÚÃù
(
fd
, (
sockaddr
 *)&
addr
, 
Ën
)) {

548 
	`ems_l_Œaû
("[portal] connecto: %s:%d: failed: %s",

549 
	`ems_sock_addr
(
sock
),

550 
	`ems_sock_pÜt
(
sock
),

551 
	`ems_Ï¡”rmsg
());

552 
	`şo£
(
fd
);

553  
EMS_ERR
;

556 
	`ems_sock_£tfd
(
sock
, 
fd
);

557  
EMS_OK
;

558 
	}
}

560 
ems_št
 
	$pÜl_¡¬t
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

562 iàĞ!
±l
->
£ss
) {

563 
±l
->
£ss
 = 
	`ems_£ssiÚ_Ãw
();

564 ià(!
±l
->
£ss
) {

565 
	`ems_as£¹
(0 && "never be here");

566 
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

567  
EMS_ERR
;

570 
	`ems_bufãr_šü—£
(&
±l
->
£ss
->
buf_š
, 
EMS_BUFFER_1K
);

571 
	`ems_bufãr_šü—£
(&
±l
->
£ss
->
buf_out
, 
EMS_BUFFER_1K
);

574 
£ss
 = 
±l
->sess;

575 
±l
->
Ï¡”r
 = 0;

576 
	`£ss_cb¬g_£t
(
£ss
, 
±l
);

578 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`¡r_‹xt
(&
±l
->
addr
));

579 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
±l
->
pÜt
);

580 ià(
	`pÜl_cÚÃù
(
£ss
è!ğ
EMS_OK
) {

581 
±l
->
Ï¡”r
 = 
ERR_PORTAL_NETWORK
;

582 
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

583  
EMS_ERR
;

586 
	`ems_£nd_mes§ge
(
ty_pÜl
, 
ty_¿dius
, 
EMS_APP_RADIUS_START
, 
NULL
);

588  
	`pÜl_chªge_¡©us
(
±l
, 
¡_»g
);

589 
	}
}

591 
ems_cch¬
 *
	$±l_mac_to_¿dius
(
ems_¡r
 *
mac
)

593 
ems_ch¬
 
buff
[32], *
p
;

594 
ems_cch¬
 *
buf
;

595 
ems_št
 
i
;

597 
i
 = 0;

598 
buf
 = 
	`¡r_‹xt
(
mac
);

599 
p
 = 
buff
;

601 *
buf
) {

602 *
p
++ = *
buf
++;

604 ià(
i
++ % 2)

605 *
p
++ = ':';

608 
p
--;

609 *
p
 = '\0';

611  
buff
;

612 
	}
}

614 
ems_cch¬
 *
	$¿dius_mac_to_±l
(
ems_cch¬
 *
mac
)

616 
ems_ch¬
 
buf
[32] = {0};

617 
ems_ch¬
 
ch
, *
p
;

619 
p
 = 
buf
;

621 
	`mem£t
(
buf
, 0, (buf));

622 *
mac
) {

623 
ch
 = *
mac
++;

624 ià(
ch
 == ':')

626 *
p
++ = 
ch
;

629  
buf
;

630 
	}
}

633 
ems_void
 
	$u£r_timeout_cb
(
ems_timeout
 *
timeout
)

635 
pÜl_u£r
 *
u£r
 = 
	`ems_cÚš”_of
(
timeout
,…Ül_u£r, 
to
);

636 
ems_pÜl
 *
±l
 = 
u£r
->ptl;

638 
	`ems_l_Œaû
("tim” u£r(¡: 0x%x, %s, %s),„‘ryimes: %d", 
u£r
->
¡
,

639 
	`¡r_‹xt
(&
u£r
->

), sŒ_‹xt(&u£r->
Çme
), u£r->
»Œy_times
);

641 
u£r
->
»Œy_times
--;

642 ià(
u£r
->
»Œy_times
 > 0) {

643 
ems_£ssiÚ
 *
£ss
 = 
±l
->sess;

645 
	`ems_bufãr_»äesh
(&
£ss
->
buf
);

646 
	`ems_bufãr_wr™e
(&
£ss
->
buf
, 
	`buf_rd
(&
u£r
->
buf_out
), 
	`buf_Ën
(&user->buf_out));

647 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
±l_evt_cb
);

648 
	`ems_timeout_š£¹_sÜ‹d
(
	`timeou‹r
(), &
u£r
->
to
, u£r->
»Œy_timeout
 * 1000, 
u£r_timeout_cb
);

652 
u£r
->
¡
) {

653 
pÜl_u£r_¡_ack_auth
:

655 ià(
	`ems_æag_like
(
u£r
->
æg
, 
EMS_FLG_ONLINE
))

658 
jsÚ_objeù
 *
jobj
;

659 
jobj
 = 
	`jsÚ_objeù_Ãw_objeù
();

660 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£ºame", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
u£r
->
Çme
)));

661 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£r", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
u£r
->

)));

662 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£rmac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`±l_mac_to_¿dius
(&
u£r
->
mac
)));

663 
	`ems_£nd_mes§ge
(
ty_pÜl
, 
ty_¿dius
, 
EMS_APP_CMD_RADIUS_LOGOUT
, 
jobj
);

665 
	`jsÚ_objeù_put
(
jobj
);

667 
	`±l_u£r_Áf_logout
(
±l
, 
u£r
);

669 
	`ems_queue_»move
(&
u£r
->
’Œy
);

670 
	`±l_u£r_de¡roy
(
u£r
);

675 
pÜl_u£r_¡_Áf_logout
:

676 
pÜl_u£r_¡_ack_logout
:

677 
pÜl_u£r_¡_ack_ch®Ënge
:

679 
	`ems_queue_»move
(&
u£r
->
’Œy
);

680 
	`±l_u£r_de¡roy
(
u£r
);

687 
	}
}

690 
ems_št
 
	$±l_evt_ack
(

691 
ems_pÜl
 *
±l
,

692 
pÜl_u£r
 *
u£r
,

693 
pÜl_auth_hdr
 *
auth
,

694 
ems_queue
 *
©Œ
)

696 
ems_ch¬
 *
wr
;

697 
ems_£ssiÚ
 *
£ss
 = 
±l
->sess;

699 
	`ems_as£¹
(
±l
 && 
auth
 && "never show uphis†ine");

701 ià(
©Œ
) {

702 
	`ems_queue_Ën
(
©Œ
, 
auth
->
n_©Œ
);

704 
auth
->
n_©Œ
 = 0;

706 
wr
 = 
	`buf_wr
(&
£ss
->
buf
);

707 
	`ems_bufãr_wr™e
(&
£ss
->
buf
, (
ems_ch¬
 *)
auth
->
v®
, (
pÜl_auth_hdr
));

708 ià(
©Œ
)

709 
	`±l_·ck_li¡
(
©Œ
, &
£ss
->
buf
);

711 
	`ems_l_Œaû
("[pÜl]±l,‡ck 0x%x,ƒ¼: %d", 
auth
->
ty
,‡uth->
”r
);

712 ià(
u£r
) {

713 
	`ems_l_Œaû
("[portal]ptl (%s: %s),‡ck 0x%x,ƒrr: %d",

714 
	`¡r_‹xt
(&
u£r
->

), sŒ_‹xt(&u£r->
Çme
), 
auth
->
ty
,‡uth->
”r
);

716 
	`ems_bufãr_ş—r
(&
u£r
->
buf_out
);

717 
	`ems_bufãr_wr™e
(&
u£r
->
buf_out
, 
wr
, 
	`abs
(
	`buf_wr
(&
£ss
->
buf
) - wr));

719 
u£r
->
»Œy_times
 = 
PORTAL_RETRY_TIMES
;

720 
u£r
->
»Œy_timeout
 = 
PORTAL_RETRY_TIMEOUT
;

722 
	`ems_timeout_š£¹_sÜ‹d
(
	`timeou‹r
(), &
u£r
->
to
, u£r->
»Œy_timeout
 * 1000, 
u£r_timeout_cb
);

725 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
±l_evt_cb
);

727  
EMS_OK
;

728 
	}
}

730 
ems_št


731 
	$±l_evt_»q_auth
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
pÜl_auth_hdr
 *
auth
, 
ems_queue
 *
©Œ
)

733 
pÜl_u£r
 *
u£r
;

734 
pÜl_v®ue_·œ
 *
vp
;

735 
ems_ch¬
 

[32];

736 
ems_ch¬
 
mac
[32];

737 
š_addr
 
addr
;

739 
	`mem£t
(&
addr
, 0, (addr));

740 
	`memıy
(&
addr
.
s_addr
, &
auth
->

, 4);

742 
	`¢´štf
(

, (), "%s", 
	`š‘_Áß
(
addr
));

744 
u£r
 = 
	`±l_u£r_fšd
(
±l
, 

);

746 ià(!
u£r
) {

747 
vp
 = 
	`±l_vp_fšd
(
©Œ
, 
ATTR_USERNAME
);

748 ià(!(
vp
 && vp->
v®
)è
”r_out
;

750 
u£r
 = 
	`±l_u£r_Ãw
();

751 ià(!
u£r
è
”r_out
;

753 
u£r
->
±l
 =…tl;

754 
	`¡r_£t
(&
u£r
->
Çme
, 
vp
->
v®
);

755 
	`¡r_£t
(&
u£r
->

, ip);

756 
	`ems_queue_š£¹_
(&
±l
->
u£rs
, &
u£r
->
’Œy
);

759 
	`ems_l_Œaû
("(curent(0x%04x, 0x%04x), user(0x%04x, 0x%04x)",

760 
auth
->
£rŸl
,‡uth->
»qid
, 
u£r
->serial, user->reqid);

762 ià(
	`ems_æag_like
(
u£r
->
æg
, 
EMS_FLG_ONLINE
)) {

763 
u£r
->
£rŸl
 = 
auth
->serial;

764 
auth
->
”r
 = 2;

765 
”r_out_1
;

768 ià(
u£r
->
¡
 =ğ
pÜl_u£r_¡_»q_auth
) {

769 
auth
->
”r
 = 3;

770 
”r_out_1
;

773 ià(
u£r
->
¡
 =ğ
pÜl_u£r_¡_ack_ch®Ënge
) {

774 ià(
u£r
->
»qid
 !ğ
auth
->reqid) {

775 
auth
->
”r
 = 4;

776 
”r_out_1
;

781 
	`ems_æag_un£t
(
u£r
->
æg
, 
EMS_FLG_ONLINE
);

782 
u£r
->
¡
 = 
pÜl_u£r_¡_»q_auth
;

783 
u£r
->
£rŸl
 = 
auth
->serial;

784 
u£r
->
»qid
 = 
auth
->reqid;

785 
u£r
->
auth_ty
 = 
auth
->auth_ty;

787 ià(
auth
->
auth_ty
 == 0) {

789 
vp
 = 
	`±l_vp_fšd
(
©Œ
, 
ATTR_CHAPPASS
);

790 ià(!(
vp
 && vp->
v®
)è
”r_out
;

791 
	`¡r_£t
(&
u£r
->
·ss
, 
vp
->
v®
);

793 } ià(
auth
->
auth_ty
 == 1) {

795 
vp
 = 
	`±l_vp_fšd
(
©Œ
, 
ATTR_PASSWORD
);

796 ià(!(
vp
 && vp->
v®
)è
”r_out
;

797 
	`¡r_£t
(&
u£r
->
·ss
, 
vp
->
v®
);

800 
	`ems_as£¹
(0 && "server'sƒrror");

801 
”r_out
;

804 
vp
 = 
	`±l_vp_fšd
(
©Œ
, 
ATTR_USERMAC
);

805 ià(
vp
 && vp->
v®
)

806 
	`ems_bš2¡r
(
vp
->
v®
, vp->
lv®
, 
mac
, 32);

808 
	`¢´štf
(
mac
, (mac), "%s", 
	`¿dius_mac_to_±l
(
	`ems_u£rmac
(

)));

809 ià(
	`¡¾’
(
mac
) <= 0)

810 
”r_out
;

813 
	`¡r_£t
(&
u£r
->
mac
, mac);

815 
jsÚ_objeù
 *
jobj
;

816 
jobj
 = 
	`jsÚ_objeù_Ãw_objeù
();

817 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£ºame", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
u£r
->
Çme
)));

818 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£½ass", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
u£r
->
·ss
)));

819 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£r", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
u£r
->

)));

820 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£rmac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`±l_mac_to_¿dius
(&
u£r
->
mac
)));

821 
	`ems_£nd_mes§ge
(
ty_pÜl
, 
ty_¿dius
, 
EMS_APP_CMD_RADIUS_AUTH
, 
jobj
);

823 
	`jsÚ_objeù_put
(
jobj
);

826  
EMS_OK
;

828 
”r_out_1
:

829 
auth
->
£rŸl
 = 
	`htÚs
(auth->serial);

830 
auth
->
»qid
 = 
	`htÚs
(auth->reqid);

831 
auth
->
ty
 = 
pÜl_ty_ack_auth
;

832  
	`±l_evt_ack
(
±l
, 
NULL
, 
auth
, NULL);

834 
”r_out
:

835 
auth
->
£rŸl
 = 
	`htÚs
(auth->serial);

836 
auth
->
»qid
 = 
	`htÚs
(auth->reqid);

837 ià(
u£r
)

838 
u£r
->
¡
 = 
pÜl_u£r_¡_ack_auth
;

839 
auth
->
ty
 = 
pÜl_ty_ack_auth
;

840 
auth
->
”r
 = 1;

841  
	`±l_evt_ack
(
±l
, 
u£r
, 
auth
, 
NULL
);

842 
	}
}

844 
ems_št


845 
	$±l_evt_»q_šfo
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
pÜl_auth_hdr
 *
auth
, 
ems_queue
 *
©Œ
)

847 
auth
->
ty
 = 
pÜl_ty_ack_šfo
;

848 
auth
->
”r
 = 0;

849  
	`±l_evt_ack
(
±l
, 
NULL
, 
auth
, NULL);

850 
	}
}

852 
ems_št


853 
	$±l_evt_»q_logout
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
pÜl_auth_hdr
 *
auth
, 
ems_queue
 *
©Œ
)

855 
pÜl_u£r
 *
u£r
;

856 
ems_ch¬
 

[32];

857 
š_addr
 
addr
;

859 
	`mem£t
(&
addr
, 0, (addr));

860 
	`memıy
(&
addr
.
s_addr
, &
auth
->

, 4);

862 
	`¢´štf
(

, (), "%s", 
	`š‘_Áß
(
addr
));

864 
auth
->
ty
 = 
pÜl_ty_ack_logout
;

865 
auth
->
”r
 = 0;

866 
auth
->
£rŸl
 = 
	`htÚs
(auth->serial);

867 
auth
->
»qid
 = 
	`htÚs
(auth->reqid);

869 
u£r
 = 
	`±l_u£r_fšd
(
±l
, 

);

871 ià(
u£r
) {

872 
jsÚ_objeù
 *
jobj
;

874 
u£r
->
¡
 = 
pÜl_u£r_¡_ack_logout
;

875 
u£r
->
£rŸl
 = 
auth
->serial;

876 
u£r
->
»qid
 = 
auth
->reqid;

877 
	`ems_æag_un£t
(
u£r
->
æg
, 
EMS_FLG_ONLINE
);

879 
jobj
 = 
	`jsÚ_objeù_Ãw_objeù
();

880 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£ºame", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
u£r
->
Çme
)));

881 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£r", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
u£r
->

)));

882 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£rmac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`±l_mac_to_¿dius
(&
u£r
->
mac
)));

883 
	`ems_£nd_mes§ge
(
ty_pÜl
, 
ty_¿dius
, 
EMS_APP_CMD_RADIUS_LOGOUT
, 
jobj
);

885 
	`jsÚ_objeù_put
(
jobj
);

888  
	`±l_evt_ack
(
±l
, 
u£r
, 
auth
, 
NULL
);

889 
	}
}

891 
ems_št


892 
	$±l_evt_aff_ack_auth
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
pÜl_auth_hdr
 *
auth
, 
ems_queue
 *
©Œ
)

894 
pÜl_u£r
 *
u£r
;

895 
ems_ch¬
 

[32];

896 
š_addr
 
addr
;

898 
	`mem£t
(&
addr
, 0, (addr));

899 
	`memıy
(&
addr
.
s_addr
, &
auth
->

, 4);

901 
	`¢´štf
(

, (), "%s", 
	`š‘_Áß
(
addr
));

903 
u£r
 = 
	`±l_u£r_fšd
(
±l
, 

);

905 ià(
u£r
) {

906 
	`ems_æag_£t
(
u£r
->
æg
, 
EMS_FLG_ONLINE
);

907 
u£r
->
¡
 = 
pÜl_u£r_¡_aff_ack_auth
;

908 
	`ems_timeout_ÿnûl
(&
u£r
->
to
);

911  
EMS_OK
;

912 
	}
}

914 
ems_št


915 
	$±l_evt_»q_ch®Ënge
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
pÜl_auth_hdr
 *
auth
, 
ems_queue
 *
©Œ
)

917 
pÜl_u£r
 *
u£r
;

918 
ems_ch¬
 

[32];

919 
š_addr
 
addr
;

921 
	`mem£t
(&
addr
, 0, (addr));

922 
	`memıy
(&
addr
.
s_addr
, &
auth
->

, 4);

924 
	`¢´štf
(

, (), "%s", 
	`š‘_Áß
(
addr
));

926 
u£r
 = 
	`±l_u£r_fšd
(
±l
, 

);

928 ià(!
u£r
) {

929 
pÜl_v®ue_·œ
 *
vp
;

930 
vp
 = 
	`±l_vp_fšd
(
©Œ
, 
ATTR_USERNAME
);

931 ià(!(
vp
 && vp->
v®
)è
”r_out
;

933 
u£r
 = 
	`±l_u£r_Ãw
();

934 ià(!
u£r
è
”r_out
;

936 
u£r
->
±l
 =…tl;

937 
	`¡r_£t
(&
u£r
->
Çme
, 
vp
->
v®
);

938 
	`¡r_£t
(&
u£r
->

, ip);

939 
u£r
->
£rŸl
 = 
auth
->serial;

940 
u£r
->
»qid
 = 
	`¿ndom
() & 0xffff;

941 
	`ems_queue_š£¹_
(&
±l
->
u£rs
, &
u£r
->
’Œy
);

943 
”r_out
;

946 
ems_queue
 
vp
;

948 
	`ems_queue_š™
(&
vp
);

950 
ems_ch¬
 
veùÜ
[32] = {0};

951 
	`rc_¿ndom_veùÜ
((
ems_uch¬
 *)
veùÜ
);

952 
	`±l_vp_­³nd
(&
vp
, 
ATTR_CHALLENGE
,
veùÜ
, 16);

955 
u£r
->
¡
 = 
pÜl_u£r_¡_ack_ch®Ënge
;

956 
u£r
->
auth_ty
 = 
auth
->auth_ty;

957 
auth
->
£rŸl
 = 
	`htÚs
(
u£r
->serial);

958 
auth
->
»qid
 = 
	`htÚs
(
u£r
->reqid);

960 
auth
->
ty
 = 
pÜl_ty_ack_ch®Ënge
;

961 
auth
->
”r
 = 0;

963 
	`±l_evt_ack
(
±l
, 
u£r
, 
auth
, &
vp
);

964 
	`ems_queue_ş—r
(&
vp
, 
pÜl_v®ue_·œ
, 
’Œy
, 
±l_vp_de¡roy
);

967  
EMS_OK
;

969 
”r_out
:

970 ià(
u£r
)

971 
u£r
->
¡
 = 
pÜl_u£r_¡_ack_ch®Ënge
;

973 
auth
->
£rŸl
 = 
	`htÚs
(auth->serial);

974 
auth
->
»qid
 = 
	`htÚs
(auth->reqid);

975 
auth
->
ty
 = 
pÜl_ty_ack_ch®Ënge
;

976 
auth
->
”r
 = 1;

977  
	`±l_evt_ack
(
±l
, 
u£r
, 
auth
, 
NULL
);

978 
	}
}

980 
ems_št


981 
	$±l_´oûss_evt
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
pÜl_auth_hdr
 *
auth
, 
ems_queue
 *
©Œ
)

983 
	`ems_as£¹
(
±l
 && 
£ss
 && 
auth
);

985 
auth
->
ty
) {

986 
pÜl_ty_»q_ch®Ënge
:

987  
	`±l_evt_»q_ch®Ënge
(
±l
, 
£ss
, 
auth
, 
©Œ
);

989 
pÜl_ty_»q_auth
:

990  
	`±l_evt_»q_auth
(
±l
, 
£ss
, 
auth
, 
©Œ
);

992 
pÜl_ty_»q_logout
:

993  
	`±l_evt_»q_logout
(
±l
, 
£ss
, 
auth
, 
©Œ
);

995 
pÜl_ty_aff_ack_auth
:

996  
	`±l_evt_aff_ack_auth
(
±l
, 
£ss
, 
auth
, 
©Œ
);

998 
pÜl_ty_»q_šfo
:

999  
	`±l_evt_»q_šfo
(
±l
, 
£ss
, 
auth
, 
©Œ
);

1002 
	`ems_as£¹
(0 && "never show uphis†ine");

1003 
	`ems_l_Œaû
("[pÜl]nÙ hªdËÑy: 0x%x,ƒ¼: 0x%xèfÜ‚ow", 
auth
->
ty
,‡uth->
”r
);

1007  
EMS_OK
;

1008 
	}
}

1010 
ems_št


1011 
	$±l_´oûss_r¥
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
±l_»cv_cb
 
h
)

1013 
pÜl_auth_hdr
 
auth
;

1014 
ems_cch¬
 *
buf
 = 
NULL
;

1015 
ems_queue
 
vp
;

1016 
ems_št
 
tÙ®
, 
¹n
 = 
EMS_OK
;

1017 
ems_št
 
Ën
 = (
auth
);

1019 
	`ems_queue_š™
(&
vp
);

1021 ià(
	`buf_Ën
(&
£ss
->
buf_š
) <= 0)

1022  
EMS_CONTINUE
;

1024 
buf
 = 
	`buf_rd
(&
£ss
->
buf_š
);

1026 ià((*
buf
 & 0x00ff) == 0x01) {

1027 ià(
	`buf_Ën
(&
£ss
->
buf_š
è< 
Ën
)

1028  
EMS_CONTINUE
;

1030 
	`ems_bufãr_´eãtch
(&
£ss
->
buf_š
, (
ems_ch¬
 *)&
auth
, 
Ën
);

1032 
auth
.
£rŸl
 = 
	`Áohs
(auth.serial);

1033 
auth
.
»qid
 = 
	`Áohs
(auth.reqid);

1035 #ifdeà
DEBUG


1037 
š_addr
 
addr
;

1038 
	`mem£t
(&
addr
, 0, (addr));

1040 
	`memıy
(&
addr
.
s_addr
, &
auth
.

, 4);

1042 
	`ems_l_Œaû
("[portal]evty: %d, serial: 0x%x,„eqid:0x%x, ip: %sƒrr: %d,‚attr: %d",

1043 
auth
.
ty
,‡uth.
£rŸl
,‡uth.
»qid
, 
	`š‘_Áß
(
addr
),‡uth.
”r
,‡uth.
n_©Œ
);

1046 
tÙ®
 = (
auth
);

1048 
¹n
 = 
	`±l_·r£_ùx
(&
vp
, 
buf
 + 
Ën
, 
	`buf_Ën
(&
£ss
->
buf_š
è-†’, 
auth
.
n_©Œ
, 
EMS_YES
);

1049 ià(
¹n
 < 0) {

1050 
	`ems_queue_ş—r
(&
vp
, 
pÜl_v®ue_·œ
, 
’Œy
, 
±l_vp_de¡roy
);

1051  
¹n
;

1053 
tÙ®
 +ğ
¹n
;

1055 
¹n
 = 
	`±l_´oûss_evt
(
±l
, 
£ss
, &
auth
, &
vp
);

1057 
¹n
 = 
	`±l_·r£_ùx
(&
vp
, 
buf
, 
	`buf_Ën
(&
£ss
->
buf_š
), -1, 
EMS_NO
);

1058 ià(
¹n
 <= 0) {

1059 
	`ems_queue_ş—r
(&
vp
, 
pÜl_v®ue_·œ
, 
’Œy
, 
±l_vp_de¡roy
);

1060  
¹n
;

1063 
tÙ®
 = 
¹n
;

1065 
	`ems_as£¹
(
h
);

1066 
	`h
(
±l
, 
£ss
, &
vp
);

1069 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf_š
, 
tÙ®
, 
EMS_BUFFER_SEEK_CUR
);

1070 
	`ems_bufãr_»äesh
(&
£ss
->
buf_š
);

1072 
	`ems_queue_ş—r
(&
vp
, 
pÜl_v®ue_·œ
, 
’Œy
, 
±l_vp_de¡roy
);

1074  
¹n
;

1075 
	}
}

1077 
ems_št


1078 
	$±l_»cv_msg
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
, 
±l_»cv_cb
 
h
)

1080 
ems_št
 
»t
, 
agaš
;

1082 
agaš
 = 
EMS_YES
;

1083 
»cv_agaš
:

1084 
»t
 = 
	`£ss_»cv
(
£ss
, &£ss->
buf_š
);

1085 ià(
»t
 <= 0) {

1086 
»t
) {

1087 -
EAGAIN
:

1088 
agaš
 = 
EMS_NO
;

1091 ià(
	`buf_Ën
(&
£ss
->
buf_š
) > 0)

1092 
	`±l_´oûss_r¥
(
±l
, 
£ss
, 
h
);

1094  
EMS_ERR
;

1099 
»t
 = 
	`±l_´oûss_r¥
(
±l
, 
£ss
, 
h
);

1101 
»t
) {

1102 
EMS_BUFFER_INSUFFICIENT
:

1103 
EMS_ERR
:

1104  
EMS_ERR
;

1106 
EMS_OK
:

1107 
EMS_CONTINUE
:

1111 } 
»t
 !ğ
EMS_CONTINUE
);

1113 ià(
agaš
)

1114 
»cv_agaš
;

1116  
EMS_OK
;

1117 
	}
}

1119 
ems_št


1120 
	$±l_£nd_msg
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1122 
ems_št
 
»t
;

1124 
	`ems_as£¹
(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
));

1125 
»t
 = 
	`£ss_£nd
(
£ss
, &£ss->
buf
);

1126 ià(
»t
 <= 0) {

1127 
»t
) {

1128 -
EAGAIN
:

1132  
EMS_ERR
;

1136 ià(
	`buf_Ën
(&
£ss
->
buf
) <= 0)

1137 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
±l_evt_cb
);

1139  
EMS_OK
;

1140 
	}
}

1143 
ems_št
 
	$±l_»g_r¥
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_queue
 *
li¡
)

1145 
pÜl_v®ue_·œ
 *
vp
 = 
NULL
;

1147 
vp
 = 
	`±l_vp_fšd
(
li¡
, 
ATTR_RESPONSE
);

1149 ià(
vp
 && vp->
v®
 && !
	`¡rcmp
(vp->val, "register")) {

1150  
	`pÜl_chªge_¡©us
(
±l
, 
¡_nÜm®
);

1153 
±l
->
Ï¡”r
 = 
ERR_PORTAL_RESPONSE
;

1154  
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

1155 
	}
}

1157 
ems_št
 
	$pÜl_»g
 (
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1159 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

1160 ià(
	`±l_»cv_msg
(
±l
, 
£ss
, 
æg
, 
±l_»g_r¥
è!ğ
EMS_OK
) {

1161 
±l
->
Ï¡”r
 = 
ERR_PORTAL_NETWORK
;

1162  
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

1165  
EMS_OK
;

1168 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

1169 ià(
	`±l_£nd_msg
(
±l
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

1170 
±l
->
Ï¡”r
 = 
ERR_PORTAL_NETWORK
;

1171  
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

1174  
EMS_OK
;

1177 
	`ems_as£¹
(0 && "never be here");

1178  
EMS_OK
;

1179 
	}
}

1181 
ems_št
 
	$±l_nÜm®_r¥
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_queue
 *
li¡
)

1183  
EMS_OK
;

1184 
	}
}

1186 
ems_št
 
	$pÜl_nÜm®
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1188 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

1189 ià(
	`±l_»cv_msg
(
±l
, 
£ss
, 
æg
, 
±l_nÜm®_r¥
è!ğ
EMS_OK
) {

1190 
±l
->
Ï¡”r
 = 
ERR_PORTAL_NETWORK
;

1191  
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

1194  
EMS_OK
;

1197 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

1198 ià(
	`±l_£nd_msg
(
±l
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

1199 
±l
->
Ï¡”r
 = 
ERR_PORTAL_NETWORK
;

1200  
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

1203  
EMS_OK
;

1206 
	`ems_as£¹
(0 && "never be here");

1207  
EMS_OK
;

1208 
	}
}

1210 
ems_št
 
	$±l_hb_r¥
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_queue
 *
li¡
)

1212 
pÜl_v®ue_·œ
 *
vp
 = 
NULL
;

1214 
vp
 = 
	`±l_vp_fšd
(
li¡
, 
ATTR_RESPONSE
);

1216 ià(
vp
 && vp->
v®
 && !
	`¡rcmp
(vp->val, "active")) {

1217  
	`pÜl_chªge_¡©us
(
±l
, 
¡_nÜm®
);

1220 
±l
->
Ï¡”r
 = 
ERR_PORTAL_RESPONSE
;

1221  
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

1222 
	}
}

1224 
ems_št
 
	$pÜl_hb
 (
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1226 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

1227 ià(
	`±l_»cv_msg
(
±l
, 
£ss
, 
æg
, 
±l_hb_r¥
è!ğ
EMS_OK
) {

1228 
±l
->
Ï¡”r
 = 
ERR_PORTAL_NETWORK
;

1229  
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

1232  
EMS_OK
;

1235 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

1236 ià(
	`±l_£nd_msg
(
±l
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

1237 
±l
->
Ï¡”r
 = 
ERR_PORTAL_NETWORK
;

1238  
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

1241  
EMS_OK
;

1244 
	`ems_as£¹
(0 && "never be here");

1245  
EMS_OK
;

1246 
	}
}

1248 
ems_št
 
	$±l_ş—r_®l_u£rs
(
ems_pÜl
 *
±l
)

1250 
ems_queue
 *
p
, *
q
;

1251 
pÜl_u£r
 *
u£r
;

1253 
	`ems_queue_fÜ—ch_§ã
(&
±l
->
u£rs
, 
p
, 
q
) {

1255 
u£r
 = 
	`ems_cÚš”_of
(
p
, 
pÜl_u£r
, 
’Œy
);

1256 ià(
	`ems_æag_like
(
u£r
->
æg
, 
EMS_FLG_ONLINE
))

1258 
jsÚ_objeù
 *
jobj
;

1259 
jobj
 = 
	`jsÚ_objeù_Ãw_objeù
();

1260 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£ºame", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
u£r
->
Çme
)));

1261 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£r", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
u£r
->

)));

1262 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£rmac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`±l_mac_to_¿dius
(&
u£r
->
mac
)));

1263 
	`ems_£nd_mes§ge
(
ty_pÜl
, 
ty_¿dius
, 
EMS_APP_CMD_RADIUS_LOGOUT
, 
jobj
);

1265 
	`jsÚ_objeù_put
(
jobj
);

1268 
	`ems_queue_»move
(&
u£r
->
’Œy
);

1269 
	`±l_u£r_de¡roy
(
u£r
);

1272  
EMS_OK
;

1273 
	}
}

1275 
ems_št
 
	$pÜl_¡İ³d
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1277 
£ss
 = 
±l
->sess;

1278 ià(
£ss
) {

1279 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
£ss
);

1280 
±l
->
£ss
 = 
NULL
;

1283  
	`±l_ş—r_®l_u£rs
(
±l
);

1284 
	}
}

1286 
ems_št
 
	$pÜl_”r
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

1288 
£ss
 = 
±l
->sess;

1290 ià(
£ss
) {

1291 
	`£ss_ev’t_ÿnûl
(
£ss
);

1292 
	`£ss_timeout_ÿnûl
(
£ss
);

1293 
	`ems_l_Œaû
("[portal]shutdown session(%d) with [%s]",

1294 
	`ems_sock_fd
(&
£ss
->
sock
),

1295 
	`ems_sock_addr
(&
£ss
->
sock
));

1296 
	`ems_sock_şo£
(&
£ss
->
sock
);

1297 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
PORTAL_ERROR_TIMEOUT
, 
±l_timeout_cb
);

1300 
	`ems_£nd_mes§ge
(
ty_pÜl
, 
ty_¿dius
, 
EMS_APP_RADIUS_STOP
, 
NULL
);

1302  
	`±l_ş—r_®l_u£rs
(
±l
);

1303 
	}
}

1305 
ems_št
 
	$pÜl_»Œy_£nd
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

1307 
±l
->
»Œy_times
--;

1308 ià(
±l
->
»Œy_times
) {

1309 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf_out
, 0, 
EMS_BUFFER_SEEK_SET
);

1310 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
±l_evt_cb
);

1311 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
±l
->
»Œy_timeout
 * 1000, 
±l_timeout_cb
);

1312  
EMS_OK
;

1315 
±l
->
Ï¡”r
 = 
ERR_PORTAL_NETWORK
;

1316  
	`pÜl_chªge_¡©us
(
±l
, 
¡_”r
);

1317 
	}
}

1319 
ems_št
 
	$pÜl_to_»g
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

1321  
	`pÜl_»Œy_£nd
(
±l
, 
£ss
, 
to
);

1322 
	}
}

1324 
ems_št
 
	$pÜl_to_nÜm®
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

1326 
±l
->
»g
--;

1327 ià(
±l
->
»g
 > 0)

1328  
	`pÜl_chªge_¡©us
(
±l
, 
¡_hb
);

1330  
	`pÜl_chªge_¡©us
(
±l
, 
¡_»g
);

1331 
	}
}

1333 
ems_št
 
	$pÜl_to_hb
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

1335  
	`pÜl_»Œy_£nd
(
±l
, 
£ss
, 
to
);

1336 
	}
}

1338 
ems_št
 
	$pÜl_to_”r
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

1340  
	`pÜl_chªge_¡©us
(
±l
, 
¡_¡¬t
);

1341 
	}
}

1343 
ems_št
 
	$pÜl_fl_»g_šfo
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
)

1345 
ems_queue
 
vp
;

1346 
ems_ušt
 
tmp
;

1348 
	`ems_queue_š™
(&
vp
);

1350 
tmp
 = 2;

1351 
	`±l_vp_­³nd
(&
vp
, 
ATTR_PKGTYPE
, (
ems_cch¬
 *)&
tmp
, -1);

1352 
	`±l_vp_­³nd
(&
vp
, 
ATTR_AUTHTYPE
, 
PORTAL_AUTH_TYPE
, -1);

1353 
	`±l_vp_­³nd
(&
vp
, 
ATTR_NASNAME
, 
	`cÜe_¢
(), -1);

1355 
	`±l_·ck_li¡
(&
vp
, &
£ss
->
buf
);

1357 
	`ems_queue_ş—r
(&
vp
, 
pÜl_v®ue_·œ
, 
’Œy
, 
±l_vp_de¡roy
);

1359  
EMS_OK
;

1360 
	}
}

1362 
ems_št
 
	$±l_¡©us_što_»g
(
ems_pÜl
 *
±l
)

1364 
ems_£ssiÚ
 *
£ss
 = 
±l
->sess;

1366 
	`ems_as£¹
(
±l
 &&…->
£ss
 && sess);

1368 
	`ems_bufãr_»äesh
(&
£ss
->
buf_out
);

1369 
	`pÜl_fl_»g_šfo
(
±l
, 
£ss
);

1371 
±l
->
»Œy_times
 = 
PORTAL_RETRY_TIMES
;

1372 
±l
->
»Œy_timeout
 = 
PORTAL_RETRY_TIMEOUT
;

1373 
±l
->
Ï¡”r
 = 0;

1375 
±l
->
»g
 =…->
»g_³riod
 /…->
hb_³riod
;

1377 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
±l_evt_cb
);

1378 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
±l
->
»Œy_timeout
 * 1000, 
±l_timeout_cb
);

1380  
EMS_OK
;

1381 
	}
}

1383 
ems_št
 
	$±l_¡©us_što_nÜm®
(
ems_pÜl
 *
±l
)

1385 
ems_£ssiÚ
 *
£ss
 = 
±l
->sess;

1387 
	`£ss_ev’t_ÿnûl
(
£ss
);

1388 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
±l_evt_cb
);

1390 ià(
±l
->
»g
 > 0) {

1391 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
±l
->
hb_³riod
 * 1000, 
±l_timeout_cb
);

1393 
ems_št
 
m£cs
;

1394 
m£cs
 = 
±l
->
»g_³riod
 %…->
hb_³riod
;

1395 ià(
m£cs
 <= 0)

1396 
m£cs
 = 
±l
->
hb_³riod
;

1398 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
m£cs
 * 1000, 
±l_timeout_cb
);

1401  
EMS_OK
;

1402 
	}
}

1404 
ems_št
 
	$pÜl_fl_hb_šfo
(
ems_pÜl
 *
±l
, 
ems_£ssiÚ
 *
£ss
)

1406 
ems_queue
 
vp
;

1407 
ems_ušt
 
tmp
;

1409 
	`ems_queue_š™
(&
vp
);

1411 
tmp
 = 1;

1412 
	`±l_vp_­³nd
(&
vp
, 
ATTR_PKGTYPE
, (
ems_cch¬
 *)&
tmp
, -1);

1413 
	`±l_vp_­³nd
(&
vp
, 
ATTR_AUTHTYPE
, 
PORTAL_AUTH_TYPE
, -1);

1414 
	`±l_vp_­³nd
(&
vp
, 
ATTR_NASNAME
, 
	`cÜe_¢
(), -1);

1416 
	`±l_·ck_li¡
(&
vp
, &
£ss
->
buf
);

1417 
	`ems_queue_ş—r
(&
vp
, 
pÜl_v®ue_·œ
, 
’Œy
, 
±l_vp_de¡roy
);

1419  
EMS_OK
;

1420 
	}
}

1423 
ems_št
 
	$±l_¡©us_što_hb
(
ems_pÜl
 *
±l
)

1425 
ems_£ssiÚ
 *
£ss
 = 
±l
->sess;

1427 
	`ems_as£¹
(
±l
 &&…->
£ss
 && sess);

1429 
	`ems_bufãr_»äesh
(&
£ss
->
buf_out
);

1430 
	`pÜl_fl_hb_šfo
(
±l
, 
£ss
);

1432 
±l
->
»Œy_times
 = 
PORTAL_RETRY_TIMES
;

1433 
±l
->
»Œy_timeout
 = 
PORTAL_RETRY_TIMEOUT
;

1434 
±l
->
Ï¡”r
 = 0;

1436 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
±l_evt_cb
);

1437 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
±l
->
»Œy_timeout
 * 1000, 
±l_timeout_cb
);

1439  
EMS_OK
;

1440 
	}
}

1442 
ems_št
 
	$pÜl_chªge_¡©us
(
ems_pÜl
 *
±l
, 
ems_¡©us
 
¡
)

1444 
	`ems_l_Œaû
("[portal] change status: %s >> %s",

1445 
	`ems_¡©us_¡r
(
±l
->
¡
),ƒms_status_str(st));

1447 
±l
->
¡
 = st;

1449 
±l
->
¡
) {

1450 
¡_¡¬t
:

1451 
¡_¡İ³d
:

1452 
¡_”r
:

1453  
	`±l_evt_run
(
±l
, 
NULL
, 0);

1455 
¡_»g
:

1456  
	`±l_¡©us_što_»g
(
±l
);

1458 
¡_nÜm®
:

1459  
	`±l_¡©us_što_nÜm®
(
±l
);

1461 
¡_hb
:

1462  
	`±l_¡©us_što_hb
(
±l
);

1468  
EMS_OK
;

1469 
	}
}

1471 
ems_št
 
	$±l_u£r_Áf_logout
(
ems_pÜl
 *
±l
, 
pÜl_u£r
 *
u£r
)

1473 
ems_queue
 
vp
;

1474 
pÜl_auth_hdr
 
auth
;

1476 ià(
u£r
) {

1477 
	`ems_queue_š™
(&
vp
);

1479 
	`ems_l_Œaû
("Áàlogout: cu¼’ˆ¡: 0x%x", 
u£r
->
¡
);

1481 
u£r
->
¡
) {

1482 
pÜl_u£r_¡_aff_ack_auth
:

1483 
pÜl_u£r_¡_ack_auth
:

1487  
EMS_OK
;

1491 
	`mem£t
(&
auth
, 0, (auth));

1493 
	`ems_æag_un£t
(
u£r
->
æg
, 
EMS_FLG_ONLINE
);

1494 
u£r
->
¡
 = 
pÜl_u£r_¡_Áf_logout
;

1495 
auth
.
v”
 = 1;

1496 
auth
.
ty
 = 
pÜl_ty_Áf_logout
;

1497 
auth
.
£rŸl
 = 
	`htÚs
(
u£r
->serial);

1498 
auth
.
»qid
 = 
	`htÚs
(
u£r
->reqid);

1499 
auth
.
auth_ty
ğ
u£r
->auth_ty;

1500 
auth
.

 = (
ems_ušt
è
	`š‘_addr
(
	`¡r_‹xt
(&
u£r
->ip));

1501 
auth
.
pÜt
 = 
	`htÚs
(0);

1502 
auth
.
n_©Œ
 = 0;

1503 
auth
.
”r
 = 0;

1505 
ems_ch¬
 
mac
[8];

1506 
	`ems_¡r2bš
(
	`¡r_‹xt
(&
u£r
->
mac
), mac, 8);

1507 
	`±l_vp_­³nd
(&
vp
, 
ATTR_USERMAC
, 
mac
, 6);

1510 
	`±l_evt_ack
(
±l
, 
u£r
, &
auth
, &
vp
);

1511 
	`ems_queue_ş—r
(&
vp
, 
pÜl_v®ue_·œ
, 
’Œy
, 
±l_vp_de¡roy
);

1514  
EMS_OK
;

1515 
	}
}

1517 
ems_št
 
	$±l_u£r_auth_r¥
(
ems_pÜl
 *
±l
, 
pÜl_u£r
 *
u£r
, 
ems_št
 
”r
)

1519 
pÜl_auth_hdr
 
auth
;

1521 ià(
u£r
) {

1522 
	`mem£t
(&
auth
, 0, (auth));

1524 
	`ems_l_Œaû
("auth„¥: cu¼’ˆ¡: 0x%x", 
u£r
->
¡
);

1526 ià(
u£r
->
¡
 !ğ
pÜl_u£r_¡_»q_auth
)

1527  
EMS_OK
;

1529 
auth
.
v”
 = 1;

1530 
auth
.
ty
 = 
pÜl_ty_ack_auth
;

1531 
auth
.
£rŸl
 = 
	`htÚs
(
u£r
->serial);

1532 
auth
.
»qid
 = 
	`htÚs
(
u£r
->reqid);

1533 
auth
.
auth_ty
ğ
u£r
->auth_ty;

1534 
auth
.

 = (
ems_ušt
è
	`š‘_addr
(
	`¡r_‹xt
(&
u£r
->ip));

1535 
auth
.
pÜt
 = 
	`htÚs
(0);

1536 
auth
.
n_©Œ
 = 0;

1537 
auth
.
”r
 =ƒrr;

1538 ià(
”r
è
auth
.err = 4;

1540 
u£r
->
¡
 = 
pÜl_u£r_¡_ack_auth
;

1541 ià(!
”r
)

1542 
	`ems_æag_£t
(
u£r
->
æg
, 
EMS_FLG_ONLINE
);

1544  
	`±l_evt_ack
(
±l
, 
u£r
, &
auth
, 
NULL
);

1547  
EMS_OK
;

1548 
	}
}

1550 
ems_št
 
	$±l_cu¼’t_add»ss
(
ems_pÜl
 *
±l
)

1552 
sockËn_t
 
Ën
;

1553 
sockaddr_š
 
addr
;

1555 ià(!
±l
->
£ss
)

1558 
Ën
 = (
addr
);

1559 
	`mem£t
(&
addr
, 0, (addr));

1561 ià(
	`ems_sock_fd
(&
±l
->
£ss
->
sock
) <= 0)

1564 ià(
	`g‘³”Çme
(
	`ems_sock_fd
(&
±l
->
£ss
->
sock
), (
sockaddr
 *)&
addr
, &
Ën
))

1567  (
ems_št
è
addr
.
sš_addr
.
s_addr
;

1568 
	}
}

	@src/core/ems_portal.h

1 #iâdeà
__PORTAL_H__


2 
	#__PORTAL_H__


	)

4 #´agm¨
·ck
(
push
, 1)

6 
_pÜl_auth_h—d”_s
 
	tpÜl_auth_hdr
;

7 
_ems_pÜl_
 
	tems_pÜl
;

9 
	u_pÜl_auth_h—d”_s
 {

10 
ems_uch¬
 
	mv®
[16];

12 
ems_uch¬
 
	mv”
;

13 
ems_uch¬
 
	mty
;

14 
ems_uch¬
 
	mauth_ty
;

15 
ems_uch¬
 
	mr¤v
;

16 
ems_ushÜt
 
	m£rŸl
;

17 
ems_ushÜt
 
	m»qid
;

18 
ems_ušt
 
	m
;

19 
ems_ushÜt
 
	mpÜt
;

20 
ems_uch¬
 
	m”r
;

21 
ems_uch¬
 
	mn_©Œ
;

25 #´agm¨
·ck
(
pİ
)

27 
	s_pÜl_v®ue_·œ_s
 {

28 
ems_št
 
	m©Œ
;

29 
ems_št
 
	mid
;

30 
ems_št
 
	mty
;

31 
ems_ušt
 
	mlv®
;

32 
ems_ch¬
 *
	mv®
;

33 
ems_queue
 
	m’Œy
;

34 } 
	tpÜl_v®ue_·œ
;

36 
	s_pÜl_u£r_s
 {

37 
ems_¡r
 
	mÇme
;

38 
ems_¡r
 
	m·ss
;

39 
ems_¡r
 
	mmac
;

40 
ems_¡r
 
	m
;

42 
ems_ushÜt
 
	m£rŸl
;

43 
ems_ushÜt
 
	m»qid
;

44 
ems_uch¬
 
	mauth_ty
;

45 
ems_ušt
 
	mæg
;

47 
ems_št
 
	m¡
;

48 
ems_timeout
 
	mto
;

49 
ems_bufãr
 
	mbuf_out
;

50 
ems_št
 
	m»Œy_times
;

51 
ems_št
 
	m»Œy_timeout
;

52 
ems_pÜl
 *
	m±l
;

54 
ems_queue
 
	m’Œy
;

55 } 
	tpÜl_u£r
;

57 
	s_ems_pÜl_


59 
ems_queue
 
	mu£rs
;

60 
ems_£ssiÚ
 *
	m£ss
;

62 
ems_¡r
 
	maddr
;

63 
ems_št
 
	mpÜt
;

64 
ems_št
 
	m»g_³riod
;

65 
ems_št
 
	mhb_³riod
;

66 
ems_št
 
	m»g
;

68 
ems_št
 
	m»Œy_times
;

69 
ems_št
 
	m»Œy_timeout
;

70 
ems_¡©us
 
	m¡
;

71 
ems_št
 
	mÏ¡”r
;

75 
ems_št
 
pÜl_chªge_¡©us
(
ems_pÜl
 *
±l
, 
ems_¡©us
 
¡
);

76 
pÜl_u£r
 *
±l_u£r_fšd
(
ems_pÜl
 *
±l
, 
ems_cch¬
 *

);

77 
ems_void
 
±l_u£r_de¡roy
(
pÜl_u£r
 *
u£r
);

79 
ems_št
 
±l_u£r_Áf_logout
(
ems_pÜl
 *
±l
, 
pÜl_u£r
 *
u£r
);

80 
ems_št
 
±l_u£r_auth_r¥
(
ems_pÜl
 *
±l
, 
pÜl_u£r
 *
u£r
,ƒms_šˆ
”r
);

81 
ems_št
 
±l_cu¼’t_add»ss
(
ems_pÜl
 *
±l
);

	@src/core/ems_radius.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_ş›Á.h
"

4 
	~"­p.h
"

5 
	~"ems_¿dius.h
"

6 
	~"ems_fw.h
"

8 
	~<Ãtš‘/š_sy¡m.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<Ãtš‘/.h
>

11 
	~<Ãtš‘/_icmp.h
>

12 
	~<Ãtdb.h
>

14 
	#PING_TIMEOUT
 2000

	)

15 
	#PING_RETRYTIMES
 3

	)

17 
ems_ch¬
 *
ems_mac_upd©e
Óms_ch¬ *
d¡
, 
ems_cch¬
 *
¤c
);

19 
ems_št
 
¿_¡¬t
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

20 
ems_št
 
¿_auth
 (
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

21 
ems_št
 
¿_acù
 (
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

22 
ems_št
 
¿_nÜm®
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

23 
ems_št
 
¿_pšg
 (
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

24 
ems_št
 
¿_acù_¡İ³d
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

25 
ems_št
 
¿_”r
 (
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
);

27 
	$ems_št
 (*
	t¿_evt_func
)(
	tems_deviû
 *
	tdev
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_ušt
 
	tæg
);

28 
¿_evt_func
 
¿_evt_hªdËr
[] =

30 [
¡_¡¬t
] = 
¿_¡¬t
,

31 [
¡_auth
] = 
¿_auth
,

32 [
¡_acù
] = 
¿_acù
,

33 [
¡_nÜm®
] = 
¿_nÜm®
,

34 [
¡_hb
] = 
¿_pšg
,

35 [
¡_acù_¡İ
] = 
¿_acù_¡İ³d
,

36 [
¡_”r
] = 
¿_”r
,

37 [
¡_max
] = 
NULL


38 
	}
};

40 
ems_št
 
¿_to_auth
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

41 
ems_št
 
¿_to_acù
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

42 
ems_št
 
¿_to_nÜm®
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

43 
ems_št
 
¿_to_pšg
 (
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

44 
ems_št
 
¿_to_acù_¡İ³d
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
);

46 
	$ems_št
 (*
	t¿_timeout_func
)(
	tems_deviû
 *
	tdev
, 
	tems_£ssiÚ
 *
	t£ss
, 
	tems_timeout
 *
	tto
);

47 
¿_timeout_func
 
¿_timeout_hªdËr
[] =

49 [
¡_¡¬t
] = 
NULL
,

50 [
¡_auth
] = 
¿_to_auth
,

51 [
¡_acù
] = 
¿_to_acù
,

52 [
¡_nÜm®
] = 
¿_to_nÜm®
,

53 [
¡_hb
] = 
¿_to_pšg
,

54 [
¡_acù_¡İ
] = 
¿_to_acù_¡İ³d
,

55 [
¡_”r
] = 
NULL
,

56 [
¡_max
] = 
NULL


57 
	}
};

59 
	$ems_št
 (*
	tdev_»cv_cb
)(
	tems_deviû
 *
	tdev
, 
	tems_£ssiÚ
 *
	t£ss
);

61 
ems_št
 
	$dev_evt_run
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

63 
	`ems_as£¹
(
¿_evt_hªdËr
[
dev
->
¡
] !ğ
NULL
);

65  
¿_evt_hªdËr
[
dev
->
¡
](dev, 
£ss
, 
æg
);

66 
	}
}

68 
ems_št
 
	$dev_timeout_run
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

70 
	`ems_as£¹
(
¿_timeout_hªdËr
[
dev
->
¡
] !ğ
NULL
);

72 ià(
¿_timeout_hªdËr
[
dev
->
¡
])

73  
¿_timeout_hªdËr
[
dev
->
¡
](dev, 
£ss
, 
to
);

75  
EMS_OK
;

76 
	}
}

78 
ems_void
 
	$dev_evt_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_št
 
”r
,ƒms_šˆ
æg
)

80 
ems_deviû
 *
dev
 = (ems_deviû *)
	`£ss_cb¬g
(
£ss
);

82 
	`ems_as£¹
(
dev
->
¡
 > 
¡_mš
 && dev->¡ < 
¡_max
);

84 ià(
”r
) {

85 
	`ems_l_Œaû
("[dev]ƒvtƒrr, sess: %d %s",

86 
	`ems_sock_fd
(&
£ss
->
sock
),

87 
	`ems_sock_addr
(&
£ss
->
sock
));

88 
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

92 
	`dev_evt_run
(
dev
, 
£ss
, 
æg
);

93 
	}
}

95 
ems_void
 
	$dev_timeout_cb
(
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

97 
ems_deviû
 *
dev
 = (ems_deviû *)
	`£ss_cb¬g
(
£ss
);

99 
	`ems_as£¹
(
dev
->
¡
 > 
¡_mš
 && dev->¡ < 
¡_max
);

101 
	`dev_timeout_run
(
dev
, 
£ss
, 
to
);

102 
	}
}

104 
	#ems_rc_av·œ_add
(
rh
, 
out
, 
key
, 
v®
, 
v®_Ën
, 
v’
) \

105 
	`rc_av·œ_add
(
rh
, 
out
, 
key
, (
ems_void
 *)
v®
, 
v®_Ën
, 
v’
)

	)

108 
ems_št
 
	$¿_fl_auth_av·œs
(
ems_deviû
 *
dev
, 
ems_¿dius
 *
¿
)

110 
ems_ch¬
 
buf
[253];

111 
ems_ch¬
 
mac
[32] = {0};

112 
ems_ušt
 
tmp
;

113 
ems_£ssiÚ
 *
£ss
 = 
dev
->sess;

115 
	`ems_as£¹
(
dev
 && 
£ss
 !ğ
NULL
);

117 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_USER_NAME
,

118 
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
), 
	`¡r_Ën
(&dev->user.name), 0);

120 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_USER_PASSWORD
,

121 
	`¡r_‹xt
(&
dev
->
u£r
.
·ss
), 
	`¡r_Ën
(&dev->user.pass), 0);

123 ià(
£ss
) {

124 
sockaddr_š
 
addr
;

125 
sockËn_t
 
Ën
;

127 
	`mem£t
(&
addr
, 0, (addr));

128 
Ën
 = (
addr
);

129 
	`g‘sockÇme
(
	`ems_sock_fd
(&
£ss
->
sock
), (
sockaddr
 *)&
addr
, &
Ën
);

131 
tmp
 = 
	`Áohl
(
addr
.
sš_addr
.
s_addr
);

132 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_NAS_IP_ADDRESS
, &
tmp
, 0, 0);

135 
tmp
 = 0;

136 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_NAS_PORT
, &
tmp
, -1, 0);

139 
tmp
 = 19;

140 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_NAS_PORT_TYPE
, &
tmp
, -1, 0);

142 
tmp
 = 
	`Áohl
(
	`š‘_addr
(
	`¡r_‹xt
(&
dev
->
u£r
.

)));

143 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_FRAMED_IP_ADDRESS
, &
tmp
, 0, 0);

146 
	`ems_mac_upd©e
(
mac
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_mac
));

147 
	`¢´štf
(
buf
, (buf), "%s:%s", 
mac
,

148 
	`cfg_g‘
(
	`emscfg
(), 
CFG_wœ–ess_ssid
));

149 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_CALLED_STATION_ID
, 
buf
, 
	`¡¾’
(buf), 0);

151 
	`mem£t
(
mac
, 0, 32);

152 
	`ems_mac_upd©e
(
mac
, 
	`¡r_‹xt
(&
dev
->
u£r
.mac));

153 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_CALLING_STATION_ID
, 
mac
, 
	`¡¾’
(mac), 0);

156 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_CALLING_STATION_ID
,

157 
	`¡r_‹xt
(&
dev
->
u£r
.
mac
), 
	`¡r_Ën
(&dev->user.mac), 0);

160 
	`¢´štf
(
buf
, (buf), "%s", 
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_¢
));

161 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_NAS_IDENTIFIER
, 
buf
, 
	`¡¾’
(buf), 0);

164 
	`mem£t
(
buf
, 0, (buf));

165 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_MESSAGE_AUTHENTICATOR
, 
buf
, 16, 0);

167  
EMS_OK
;

168 
	}
}

174 
ems_št
 
	$¿_fl_auth_»que¡_šfo
(
ems_deviû
 *
dev
)

176 
ems_št
 
tÙ®_Ën
;

177 
ems_¿dius
 *
¿
 = (ems_¿diu *)
dev
->
ùx
;

178 
ems_£ssiÚ
 *
£ss
 = 
dev
->sess;

179 
AUTH_HDR
 *
auth
;

180 
ems_uch¬
 
buf_sign
[
AUTH_VECTOR_LEN
];

182 
	`ems_bufãr_ş—r
(&
£ss
->
buf_out
);

184 
auth
 = (
AUTH_HDR
 *)
	`buf_wr
(&
£ss
->
buf_out
);

186 
auth
->
code
 = 
PW_ACCESS_REQUEST
;

187 
auth
->
id
 = 
¿
->
£q_nbr
++;

189 
dev
->
auth_out
 = 
auth
;

191 
	`rc_¿ndom_veùÜ
(
dev
->
veùÜ
);

192 
	`memıy
(
auth
->
veùÜ
, 
dev
->veùÜ, 
AUTH_VECTOR_LEN
);

194 
	`¿_fl_auth_av·œs
(
dev
, 
¿
);

196 
tÙ®_Ën
 = 
	`rc_·ck_li¡
(
dev
->
vp_out
, 
	`¡r_‹xt
(&
¿
->
£ü‘
), 
auth
è+ 
AUTH_HDR_LEN
;

198 
auth
->
Ëngth
 = 
	`Áohs
((è
tÙ®_Ën
);

200 
	`rc_hmac_md5_ÿlc
((
ems_uch¬
 *)
auth
, 
tÙ®_Ën
,

201 (
ems_uch¬
 *)(
	`¡r_‹xt
(&
¿
->
£ü‘
)), 
	`¡r_Ën
(&¿->£ü‘), 
buf_sign
);

202 
	`memıy
((
ems_ch¬
 *)
auth
 + 
tÙ®_Ën
 - 
AUTH_VECTOR_LEN
, 
buf_sign
, AUTH_VECTOR_LEN);

204 
	`ems_bufãr_£ek_wr
(&
£ss
->
buf_out
, 
tÙ®_Ën
, 
EMS_BUFFER_SEEK_CUR
);

206 
dev
->
tÙ®_Ën
 =otal_len;

208  
EMS_OK
;

209 
	}
}

211 
ems_št
 
	$¿_cÚÃù
(
ems_£ssiÚ
 *
£ss
)

213 
ems_št
 
fd
;

214 
sockËn_t
 
Ën
;

215 
sockaddr_š
 
addr
;

216 
ems_sock
 *
sock
 = &
£ss
->sock;

218 
	`ems_as£¹
(
£ss
);

220 
	`mem£t
(&
addr
, 0, (addr));

221 ià(
	`ems_g‘ho¡byÇme
(
	`ems_sock_addr
(
sock
), &
addr
è!ğ
OK
) {

222 
	`ems_l_Œaû
("gethostbyename failed %s : %s",

223 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

224  
EMS_ERR
;

227 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

228 ià(
fd
 <= 0)

229  
EMS_ERR
;

231 
	`ems_l_Œaû
("[dev] sess(%d) connecto: %s(%s): %d...",

232 
fd
,

233 
	`ems_sock_addr
(
sock
),

234 
	`š‘_Áß
(
addr
.
sš_addr
),

235 
	`ems_sock_pÜt
(
sock
));

237 
addr
.
sš_çmy
 = 
AF_INET
;

238 
addr
.
sš_pÜt
 = 
	`htÚs
(
	`ems_sock_pÜt
(
sock
));

240 
	`ems_£ŠÚblockšg
(
fd
, 
YES
);

241 
Ën
 = (
sockaddr_š
);

242 ià(
	`cÚÃù
(
fd
, (
sockaddr
 *)&
addr
, 
Ën
)) {

243 
	`ems_l_Œaû
("[dev] connecto: %s:%d: failed: %s",

244 
	`ems_sock_addr
(
sock
),

245 
	`ems_sock_pÜt
(
sock
),

246 
	`ems_Ï¡”rmsg
());

247 
	`şo£
(
fd
);

248  
EMS_ERR
;

251 
	`ems_sock_£tfd
(
sock
, 
fd
);

252  
EMS_OK
;

253 
	}
}

255 
ems_št
 
	$¿_¡¬t
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

257 
ems_¿dius
 *
¿
 = (ems_¿diu *)
dev
->
ùx
;

258 ià(!
dev
->
£ss
) {

259 
dev
->
£ss
 = 
	`ems_£ssiÚ_Ãw
();

260 ià(!
dev
->
£ss
) {

261 
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

262  
EMS_ERR
;

265 
	`ems_bufãr_šü—£
(&
dev
->
£ss
->
buf_š
, 
EMS_BUFFER_2K
);

266 
	`ems_bufãr_šü—£
(&
dev
->
£ss
->
buf_out
, 
EMS_BUFFER_2K
);

269 
£ss
 = 
dev
->sess;

270 
	`£ss_cb¬g_£t
(
£ss
, 
dev
);

272 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`¡r_‹xt
(&
¿
->
auth_addr
));

273 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
¿
->
auth_pÜt
);

274 ià(
	`¿_cÚÃù
(
£ss
è!ğ
EMS_OK
) {

275  
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

278 
	`¿_fl_auth_»que¡_šfo
(
dev
);

280 
dev
->
»Œy_times
 = 
¿
->retry_times;

281 
dev
->
»Œy_timeout
 = 
¿
->retry_timeout;

282 
dev
->
»asÚ
 = 0;

284 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
dev_evt_cb
);

285 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
dev
->
»Œy_timeout
 * 1000, 
dev_timeout_cb
);

287  
	`dev_chªge_¡©us
(
dev
, 
¡_auth
);

288 
	}
}

290 
ems_št


291 
	$¿_£nd_msg
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

293 
ems_št
 
»t
;

295 
	`ems_as£¹
(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
));

297 
	`ems_l_Œaû
("[radius] send(%d): (%s,†ength: %d)",

298 
	`ems_sock_fd
(&
£ss
->
sock
),

299 
	`ems_sock_addr
(&
£ss
->
sock
),

300 
	`buf_Ën
(&
£ss
->
buf
));

302 
»t
 = 
	`£ss_£nd
(
£ss
, &£ss->
buf
);

303 ià(
»t
 <= 0) {

304 
»t
) {

305 -
EAGAIN
:

309  
EMS_ERR
;

313 ià(
	`buf_Ën
(&
£ss
->
buf
) <= 0)

314 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
dev_evt_cb
);

316  
EMS_OK
;

317 
	}
}

320 
ems_št


321 
	$dev_´oûss_r¥
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
AUTH_HDR
 *
auth
, 
dev_»cv_cb
 
h
)

323 
ems_¿dius
 *
¿
 = (ems_¿diu *)
dev
->
ùx
;

324 
ems_št
 
¹n
 = 
EMS_OK
;

325 
ems_št
 
Ëngth
 = 0;

327 
dev
->
auth_š
 = (
AUTH_HDR
 *)
	`buf_rd
(&
£ss
->
buf_š
);

329 
¹n
 = 
	`rc_check_»¶y
(
dev
->
auth_š
, 
	`buf_size
(&
£ss
->
buf_š
),

330 (
ems_ch¬
 *)
	`¡r_‹xt
(&
¿
->
£ü‘
),

331 
dev
->
veùÜ
, dev->
auth_out
->
id
);

333 
Ëngth
 = 
	`Áohs
(
dev
->
auth_š
->Ëngthè- 
AUTH_HDR_LEN
;

334 ià(
Ëngth
 > 0) {

335 
dev
->
vp_š
 = 
	`rc_av·œ_g’
(
¿
->
rh
, 
NULL
, dev->
auth_š
->
d©a
, 
Ëngth
, 0);

337 
dev
->
vp_š
 = 
NULL
;

339 ià(
¹n
 !ğ
OK_RC
)

340  
EMS_ERR
;

342 ià(
h
) {

343 
	`h
(
dev
, 
£ss
);

344 
¹n
 = 
EMS_OK
;

347 
¹n
 = 
EMS_ERR
;

349  
¹n
;

350 
	}
}

353 
ems_št


354 
	$dev_´•roûss
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
dev_»cv_cb
 
h
)

356 
AUTH_HDR
 
auth
;

357 
ems_št
 
Ën
 = (
auth
) - 2;

358 
ems_št
 
¹n
;

360 ià(
	`buf_Ën
(&
£ss
->
buf_š
è< 
Ën
)

361  
EMS_CONTINUE
;

363 
	`ems_bufãr_´eãtch
(&
£ss
->
buf_š
, (
ems_ch¬
 *)&
auth
, 
Ën
);

365 
auth
.
Ëngth
 = 
	`Áohs
(auth.length);

367 ià(
auth
.
Ëngth
 >ğ
	`buf_size
(&
£ss
->
buf_š
))

368  
EMS_BUFFER_INSUFFICIENT
;

370 ià(
	`buf_Ën
(&
£ss
->
buf_š
è< 
auth
.
Ëngth
)

371  
EMS_CONTINUE
;

373 
¹n
 = 
	`dev_´oûss_r¥
(
dev
, 
£ss
, &
auth
, 
h
);

375 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf_š
, 
auth
.
Ëngth
, 
EMS_BUFFER_SEEK_CUR
);

376 
	`ems_bufãr_»äesh
(&
£ss
->
buf_š
);

378  
¹n
;

379 
	}
}

381 
ems_št


382 
	$¿_»cv_msg
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
, 
dev_»cv_cb
 
h
)

384 
ems_št
 
»t
, 
agaš
;

386 
agaš
 = 
EMS_YES
;

387 
»cv_agaš
:

388 
»t
 = 
	`£ss_»cv
(
£ss
, &£ss->
buf_š
);

389 ià(
»t
 <= 0) {

390 
»t
) {

391 -
EAGAIN
:

392 
agaš
 = 
EMS_NO
;

395 ià(
	`buf_Ën
(&
£ss
->
buf_š
) > 0)

396  
	`dev_´•roûss
(
dev
, 
£ss
, 
h
);

401 
»t
 = 
	`dev_´•roûss
(
dev
, 
£ss
, 
h
);

403 
»t
) {

404 
EMS_BUFFER_INSUFFICIENT
:

405 
EMS_ERR
:

406  
EMS_ERR
;

408 
EMS_OK
:

409 
EMS_CONTINUE
:

413 } 
»t
 !ğ
EMS_CONTINUE
);

415 ià(
agaš
)

416 
»cv_agaš
;

418  
EMS_OK
;

419 
	}
}

421 
ems_št
 
	$¿_deviû_fœew®l_£t_ruËs
(
ems_deviû
 *
dev
, 
ems_št
 
£t
)

423 
jsÚ_objeù
 *
obj
;

425 
obj
 = 
	`jsÚ_objeù_Ãw_objeù
();

427 
	`jsÚ_objeù_objeù_add
(
obj
, "u£r", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.

)));

428 
	`jsÚ_objeù_objeù_add
(
obj
, "u£rmac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
mac
)));

429 
	`jsÚ_objeù_objeù_add
(
obj
, "add", 
	`jsÚ_objeù_Ãw_št
(
£t
));

431 
	`ems_­p_´oûss
(
ty_¿dius
, 
ty_fw
, 
EMS_APP_FW_RADIUS_DEVICE_FREE
, 
obj
);

433 
	`jsÚ_objeù_put
(
obj
);

434  
EMS_OK
;

435 
	}
}

437 
ems_št
 
	$¿_cÚÃù_to_acù_£rv”
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_¿dius
 *
¿
)

439 
jsÚ_objeù
 *
r¥
;

440 
	`ems_as£¹
(
dev
 && 
£ss
 && dev->sess == sess);

442 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`¡r_‹xt
(&
¿
->
acù_addr
));

443 
	`ems_sock_£Üt
(&
£ss
->
sock
, 
¿
->
acù_pÜt
);

445 ià(
	`¿_cÚÃù
(
£ss
è!ğ
EMS_OK
) {

446 
dev
->
»asÚ
 = 
RADIUS_ERR_NETWORK
;

447  
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

450 
¿
->
Ï¡”r
 = 
RADIUS_ERR_SUCCESS
;

451 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

453 
	`jsÚ_objeù_objeù_add
(
r¥
, "u£ºame",
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
)));

454 
	`jsÚ_objeù_objeù_add
(
r¥
, "u£r", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.

)));

455 
	`jsÚ_objeù_objeù_add
(
r¥
, "u£rmac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
mac
)));

456 
	`jsÚ_objeù_objeù_add
(
r¥
, "”rÜ_code",
	`jsÚ_objeù_Ãw_št
(0));

458 
	`ems_£nd_mes§ge
(
ty_¿dius
, 
ty_pÜl
, 
EMS_APP_CMD_RADIUS_AUTH_RSP
, 
r¥
);

459 
	`jsÚ_objeù_put
(
r¥
);

461 
	`¿_deviû_fœew®l_£t_ruËs
(
dev
, 
EMS_YES
);

464 
dev
->
»asÚ
 = 1;

465  
	`dev_chªge_¡©us
(
dev
, 
¡_acù
);

466 
	}
}

468 
ems_št
 
	$¿_¡¬t_to_acù_u£r
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
)

470 
ems_¿dius
 *
¿
 = (ems_¿diu *)
dev
->
ùx
;

472 
	`ems_as£¹
(
dev
 && 
£ss
 && dev->sess == sess);

473 
	`ems_l_Œaû
("[radius]shutdown session(%d) [%s: %d]",

474 
	`ems_sock_fd
(&
£ss
->
sock
),

475 
	`ems_sock_addr
(&
£ss
->
sock
),

476 
	`ems_sock_pÜt
(&
£ss
->
sock
));

478 
	`£ss_ev’t_ÿnûl
(
£ss
);

479 
	`£ss_timeout_ÿnûl
(
£ss
);

480 
	`ems_sock_şo£
(&
£ss
->
sock
);

482 ià(
dev
->
vp_out
) {

483 
	`rc_av·œ_ä“
(
dev
->
vp_out
);

484 
dev
->
vp_out
 = 
NULL
;

487 ià(
dev
->
vp_š
) {

488 
	`rc_av·œ_ä“
(
dev
->
vp_š
);

489 
dev
->
vp_š
 = 
NULL
;

492 
dev
->
auth_out
 = 
NULL
;

493 
dev
->
auth_š
 = 
NULL
;

494 
	`ems_bufãr_ş—r
(&
£ss
->
buf_out
);

495 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

497  
	`¿_cÚÃù_to_acù_£rv”
(
dev
, 
£ss
, 
¿
);

498 
	}
}

500 
ems_št
 
	$¿_auth_r¥
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
)

502 
AUTH_HDR
 *
auth
 = 
dev
->
auth_š
;

504 
	`ems_as£¹
(
auth
 !ğ
NULL
);

506 
	`ems_l_Œaû
("[¿dius]‡uth->code: %d", 
auth
->
code
);

508 ià(
auth
->
code
 =ğ
PW_ACCESS_ACCEPT
) {

509 
	`ems_l_Œaû
("user: %s@%s†ogin success",

510 
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
),

511 
	`¡r_‹xt
(&
dev
->
u£r
.

));

514  
	`¿_¡¬t_to_acù_u£r
(
dev
, 
£ss
);

516 ià(
auth
->
code
 =ğ
PW_ACCESS_CHALLENGE
) {

517 
	`ems_l_Œaû
("*******server‚eed user: %s@%s‡ccess challenge",

518 
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
),

519 
	`¡r_‹xt
(&
dev
->
u£r
.

));

520 
dev
->
»asÚ
 = 
auth
->
code
;

521 
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

524 
	`ems_l_Œaû
("user: %s@%s failed",

525 
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
),

526 
	`¡r_‹xt
(&
dev
->
u£r
.

));

527 
dev
->
»asÚ
 = 
RADIUS_ERR_REJECT
;

528 
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

530  
EMS_OK
;

531 
	}
}

533 
ems_št
 
	$¿_auth
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

535 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

536 ià(
	`¿_»cv_msg
(
dev
, 
£ss
, 
æg
, 
¿_auth_r¥
è!ğ
EMS_OK
) {

537 
dev
->
»asÚ
 = 
RADIUS_ERR_NETWORK
;

538  
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

541  
EMS_OK
;

544 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

545 ià(
	`¿_£nd_msg
(
dev
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

546 
dev
->
»asÚ
 = 
RADIUS_ERR_NETWORK
;

547  
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

550  
EMS_OK
;

553 
	`ems_as£¹
(0 && "never be here");

554  
EMS_OK
;

555 
	}
}

557 
ems_št
 
	$¿_acù_r¥
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
)

559 
ems_¿dius
 *
¿
 = (ems_¿diu *)
dev
->
ùx
;

560 
AUTH_HDR
 *
auth
 = 
dev
->
auth_š
;

562 
	`ems_as£¹
(
auth
 !ğ
NULL
);

564 
	`ems_l_Œaû
("[¿dius]‡cù->code: %d", 
auth
->
code
);

566 ià(
auth
->
code
 =ğ
PW_ACCOUNTING_RESPONSE
) {

567 
	`ems_l_Œaû
("user: %s@%s‡ccounting success",

568 
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
),

569 
	`¡r_‹xt
(&
dev
->
u£r
.

));

571 
dev
->
»pÜt_³riod
 = 
¿
->report_period;

573 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_READ
, 
dev_evt_cb
);

574 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
dev
->
»pÜt_³riod
 * 1000, 
dev_timeout_cb
);

576 
	`dev_chªge_¡©us
(
dev
, 
¡_nÜm®
);

579 
	`ems_l_Œaû
("[radius]‡cct failed");

580 
dev
->
”r
 = 6;

581 
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

584  
EMS_OK
;

585 
	}
}

587 
ems_št
 
	$¿_acù
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

589 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

590 ià(
	`¿_»cv_msg
(
dev
, 
£ss
, 
æg
, 
¿_acù_r¥
è!ğ
EMS_OK
) {

591 
dev
->
»asÚ
 = 
RADIUS_ERR_NETWORK
;

592  
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

595  
EMS_OK
;

598 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

599 ià(
	`¿_£nd_msg
(
dev
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

600 
dev
->
»asÚ
 = 
RADIUS_ERR_NETWORK
;

601  
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

604  
EMS_OK
;

607 
	`ems_as£¹
(0 && "never be here");

608  
EMS_OK
;

609 
	}
}

611 
ems_št
 
	$¿_nÜm®_r¥
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
)

613 
	`ems_l_Œaû
("[radius]‚ormal got message from„adius server, drop it sliently");

614  
EMS_OK
;

615 
	}
}

617 
ems_št
 
	$¿_nÜm®
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

619 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

620 ià(
	`¿_»cv_msg
(
dev
, 
£ss
, 
æg
, 
¿_nÜm®_r¥
è!ğ
EMS_OK
) {

621 
dev
->
»asÚ
 = 
RADIUS_ERR_NETWORK
;

622  
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

625  
EMS_OK
;

628 
	`ems_as£¹
(0 && "never be here");

629  
EMS_OK
;

630 
	}
}

632 
ems_št
 
	$¿_pšg_»cv_hªdË
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
)

634 

 *ip;

635 
icmp
 *
iı
;

636 
hËn
, 
cc
 = 
	`buf_Ën
(&
£ss
->
buf_š
);

638 

 = ( *è
	`buf_rd
(&
£ss
->
buf_š
);

639 
hËn
 = 

->
_hl
 << 2;

641 ià(
cc
 < 
hËn
 + 
ICMP_MINLEN
)

642  
EMS_OK
;

644 
cc
 -ğ
hËn
;

645 
iı
 = (
icmp
 *)(
	`buf_rd
(&
£ss
->
buf_š
è+ 
hËn
);

647 if(
iı
->
icmp_ty³
 !ğ
ICMP_ECHOREPLY
) {

648 
	`ems_l_Œaû
("[dev] %d bytes from: %s icmp‚ot„eply(%d)",

649 
cc
, 
	`ems_sock_addr
(&
£ss
->
sock
), 
iı
->
icmp_ty³
);

650 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

651  
EMS_CONTINUE
;

654 ifĞ
iı
->
icmp_id
 !ğ
dev
->
id’t
) {

655 
	`ems_l_Œaû
("[dev] %d by‹ icm°id’t: %dƒ¼Ü,‚Ù : %d", 
cc
, 
iı
->
icmp_id
, 
dev
->
id’t
);

656 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

657  
EMS_CONTINUE
;

660 
	`ems_l_Œaû
("icm°»¶›d by (%s),†’gth: %d", 
	`ems_sock_addr
(&
£ss
->
sock
), 
cc
);

663 
ems_¿dius
 *
¿
 = (ems_¿diu *)
dev
->
ùx
;

664 
dev
->
discÚÃù
 = 
¿
->discÚÃù / (¿->
»pÜt_³riod
 + 6) + 1;

667 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

669 
	`£ss_ev’t_ÿnûl
(
£ss
);

670 
	`£ss_timeout_ÿnûl
(
£ss
);

673 
dev
->
»asÚ
 = 3;

674  
	`dev_chªge_¡©us
(
dev
, 
¡_acù
);

675 
	}
}

677 
ems_št


678 
	$¿_pšg_»cv
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
)

680 
ems_št
 
»t
;

681 
ems_ch¬
 *
wr
 = 
	`buf_wr
(&
£ss
->
buf_š
);

682 
ems_št
 
Ën
 = 
	`buf_Ëá
(&
£ss
->
buf_š
);

684 
agaš
:

685 
»t
 = 
	`»cv
(
	`ems_sock_fd
(&
£ss
->
sock
), 
wr
, 
Ën
, 0);

687 ià(
»t
 <= 0) {

688 
”ºo
) {

690 
EAGAIN
:

691 
EINTR
:

692  
EMS_OK
;

695 
	`ems_l_Œaû
("[dev]…šgƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

696  
EMS_ERR
;

700 
	`ems_bufãr_£ek_wr
(&
£ss
->
buf_š
, 
»t
, 
EMS_BUFFER_SEEK_CUR
);

702 
»t
 = 
	`¿_pšg_»cv_hªdË
(
dev
, 
£ss
);

704 
agaš
;

706  
EMS_OK
;

707 
	}
}

710 
ems_št
 
	$¿_pšg
 (
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

712 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

713 ià(
	`¿_pšg_»cv
(
dev
, 
£ss
è!ğ
EMS_OK
) {

714 
dev
->
”r
 = 2;

715  
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

718  
EMS_OK
;

721 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

722 ià(
	`¿_£nd_msg
(
dev
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

723 
dev
->
”r
 = 2;

724  
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

728  
EMS_OK
;

729 
	}
}

731 
ems_št
 
	$¿_acù_¡İ³d_r¥
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
)

733 
AUTH_HDR
 *
auth
 = 
dev
->
auth_š
;

735 
	`ems_as£¹
(
auth
 !ğ
NULL
);

737 
	`ems_l_Œaû
("[¿dius]‡cù->code: %d", 
auth
->
code
);

739 ià(
auth
->
code
 =ğ
PW_ACCOUNTING_RESPONSE
) {

740 
	`ems_l_Œaû
("user: %s@%s‡ccounting stopped success",

741 
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
),

742 
	`¡r_‹xt
(&
dev
->
u£r
.

));

745 
	`ems_l_Œaû
("[radius]‡ccounting stopped failed");

748 
dev
->
»asÚ
 = 0;

749  
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

750 
	}
}

752 
ems_št
 
	$¿_acù_¡İ³d
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

754 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_READ
)) {

755 ià(
	`¿_»cv_msg
(
dev
, 
£ss
, 
æg
, 
¿_acù_¡İ³d_r¥
è!ğ
EMS_OK
) {

756 
dev
->
»asÚ
 = 
RADIUS_ERR_NETWORK
;

757  
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

760  
EMS_OK
;

763 ià(
	`ems_æag_like
(
æg
, 
EMS_EVT_WRITE
)) {

764 ià(
	`¿_£nd_msg
(
dev
, 
£ss
, 
æg
è!ğ
EMS_OK
) {

765 
dev
->
»asÚ
 = 
RADIUS_ERR_NETWORK
;

766  
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

769  
EMS_OK
;

772 
	`ems_as£¹
(0 && "never be here");

773  
EMS_OK
;

774 
	}
}

776 
ems_št
 
	$¿_”r
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_ušt
 
æg
)

778 
ems_¿dius
 *
¿
 = (ems_¿diu *)
dev
->
ùx
;

779 
	`ems_as£¹
(
dev
);

781 
¿
->
Ï¡”r
 = 
dev
->
»asÚ
;

783 
jsÚ_objeù
 *
r¥
;

784 
r¥
 = 
	`jsÚ_objeù_Ãw_objeù
();

786 
	`jsÚ_objeù_objeù_add
(
r¥
, "u£ºame", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
)));

787 
	`jsÚ_objeù_objeù_add
(
r¥
, "u£r", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.

)));

788 
	`jsÚ_objeù_objeù_add
(
r¥
, "u£rmac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
mac
)));

789 
	`jsÚ_objeù_objeù_add
(
r¥
, "”rÜ_code",
	`jsÚ_objeù_Ãw_št
(
dev
->
»asÚ
));

791 
	`ems_£nd_mes§ge
(
ty_¿dius
, 
ty_pÜl
, 
EMS_APP_CMD_RADIUS_AUTH_RSP
, 
r¥
);

792 
	`jsÚ_objeù_put
(
r¥
);

796 
	`ems_l_Œaû
("shutdown device: %s, %s, %s, %s",

797 
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
),

798 
	`¡r_‹xt
(&
dev
->
u£r
.
·ss
),

799 
	`¡r_‹xt
(&
dev
->
u£r
.

),

800 
	`¡r_‹xt
(&
dev
->
u£r
.
mac
));

802 
	`ems_queue_»move
(&
dev
->
’Œy
);

803 
	`ems_deviû_de¡roy
(
dev
);

805  
EMS_OK
;

806 
	}
}

808 
ems_št
 
	$¿_to_auth
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

810 
dev
->
»Œy_times
--;

811 ià(
dev
->
»Œy_times
) {

812 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf_out
, 0, 
EMS_BUFFER_SEEK_SET
);

813 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
dev_evt_cb
);

814 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
dev
->
»Œy_timeout
 * 1000, 
dev_timeout_cb
);

815  
EMS_OK
;

818 
dev
->
»asÚ
 = 
RADIUS_ERR_CANNOT_CONNECT
;

819  
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

820 
	}
}

822 
ems_št
 
	$¿_to_acù
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

824 
dev
->
»Œy_times
--;

825 ià(
dev
->
»Œy_times
) {

826 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf_out
, 0, 
EMS_BUFFER_SEEK_SET
);

827 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
dev_evt_cb
);

828 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
dev
->
»Œy_timeout
 * 1000, 
dev_timeout_cb
);

829  
EMS_OK
;

832 
dev
->
»asÚ
 = 
RADIUS_ERR_CANNOT_CONNECT
;

833  
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

834 
	}
}

836 
ems_št
 
	$¿_to_nÜm®
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

838 
	`ems_l_Œaû
("[radius]imeo„eport status: %s@%s",

839 
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
),

840 
	`¡r_‹xt
(&
dev
->
u£r
.

));

841  
	`dev_chªge_¡©us
(
dev
, 
¡_hb
);

842 
	}
}

844 
ems_št
 
	$¿_to_pšg
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

846 
	`ems_l_Œaû
("[¿dius]imeouˆdeùeù…šg„‘ryimes: %d, discÚÃù: %d", 
dev
->
»Œy_times
, dev->
discÚÃù
);

848 
	`£ss_ev’t_ÿnûl
(
£ss
);

850 ià(
dev
->
»Œy_times
 > 0) {

851 
dev
->
»Œy_times
--;

852 
	`ems_l_Œaû
("»Œy s’d…šg: %d", 
dev
->
»Œy_times
);

853 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf
, 0, 
EMS_BUFFER_SEEK_SET
);

854 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
dev_evt_cb
);

855 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
PING_TIMEOUT
, 
dev_timeout_cb
);

856  
EMS_OK
;

859 
dev
->
discÚÃù
--;

860 ià(
dev
->
discÚÃù
 <= 0) {

861 
	`ems_l_Œaû
("[¿dius]†o¡ u£r: %s@%s", 
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
), sŒ_‹xt(&dev->u£r.

));

863 
dev
->
”r
 = 2;

864  
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

868 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

869 
	`£ss_ev’t_ÿnûl
(
£ss
);

870 
	`£ss_timeout_ÿnûl
(
£ss
);

873 
dev
->
»asÚ
 = 3;

874  
	`dev_chªge_¡©us
(
dev
, 
¡_acù
);

875 
	}
}

877 
ems_št
 
	$¿_to_acù_¡İ³d
(
ems_deviû
 *
dev
, 
ems_£ssiÚ
 *
£ss
, 
ems_timeout
 *
to
)

879 
dev
->
»Œy_times
--;

880 ià(
dev
->
»Œy_times
) {

881 
	`ems_bufãr_£ek_rd
(&
£ss
->
buf_out
, 0, 
EMS_BUFFER_SEEK_SET
);

882 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
dev_evt_cb
);

883 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
dev
->
»Œy_timeout
 * 1000, 
dev_timeout_cb
);

884  
EMS_OK
;

887 
dev
->
»asÚ
 = 
RADIUS_ERR_CANNOT_CONNECT
;

888  
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

889 
	}
}

891 
ems_št
 
	$¿_upd©e_u£r_Œaffic
(
ems_deviû
 *
dev
)

893 
off_t
 
¤c_pkgs
, 
¤c_by‹s
, 
d¡_pkgs
, 
d¡_by‹s
;

894 
ems_ch¬
 
buf
[256] = {0};

895 
ems_ch¬
 
cmd
[256] = {0};

898 
	`¢´štf
(
cmd
, (cmd), "iptaccount -s -f -l†ocus_%s | grep %s | cut -d';' -f2-",

899 
	`¡r_‹xt
(&
dev
->
u£r
.
mac
), sŒ_‹xt(&dev->u£r.

));

901 
	`mem£t
(
buf
, 0, (buf));

902 
	`¢´štf
(
buf
, (buf), "%s", 
	`ems_pİ’_g‘
(
cmd
));

904 ià(
	`¡¾’
(
buf
) > 0) {

905 #iâdeà
GENERIC_LINUX


906 
	`ssÿnf
(
buf
, "%Îd;%Îd;%Îd;%Îd", &
¤c_pkgs
, &
¤c_by‹s
, &
d¡_pkgs
, &
d¡_by‹s
);

908 
	`ssÿnf
(
buf
, "%ld;%ld;%ld;%ld", &
¤c_pkgs
, &
¤c_by‹s
, &
d¡_pkgs
, &
d¡_by‹s
);

911 
dev
->
u£r
.
š_by‹s
 +ğ
d¡_by‹s
;

912 
dev
->
u£r
.
š_pkgs
 +ğ
d¡_pkgs
;

913 
dev
->
u£r
.
out_by‹s
 +ğ
¤c_by‹s
;

914 
dev
->
u£r
.
out_pkgs
 +ğ
¤c_pkgs
;

917  
EMS_OK
;

918 
	}
}

920 
ems_št
 
	$¿_fl_acù_av·œs
(
ems_deviû
 *
dev
, 
ems_¿dius
 *
¿
)

922 
ems_ch¬
 
buf
[253] = {0};

923 
ems_ch¬
 
mac
[32] = {0};

924 
ems_ušt
 
tmp
;

925 
ems_£ssiÚ
 *
£ss
 = 
dev
->sess;

927 
	`ems_as£¹
(
dev
 && 
£ss
 !ğ
NULL
);

929 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_USER_NAME
,

930 
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
), 
	`¡r_Ën
(&dev->user.name), 0);

932 ià(
£ss
) {

933 
sockaddr_š
 
addr
;

934 
sockËn_t
 
Ën
;

936 
	`mem£t
(&
addr
, 0, (addr));

937 
Ën
 = (
addr
);

938 
	`g‘sockÇme
(
	`ems_sock_fd
(&
£ss
->
sock
), (
sockaddr
 *)&
addr
, &
Ën
);

940 
tmp
 = 
	`Áohl
(
addr
.
sš_addr
.
s_addr
);

941 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_NAS_IP_ADDRESS
, &
tmp
, 0, 0);

944 
tmp
 = 0;

945 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_NAS_PORT
, &
tmp
, -1, 0);

948 
tmp
 = 19;

949 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_NAS_PORT_TYPE
, &
tmp
, -1, 0);

951 
tmp
 = 
	`Áohl
(
	`š‘_addr
(
	`¡r_‹xt
(&
dev
->
u£r
.

)));

952 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_FRAMED_IP_ADDRESS
, &
tmp
, 0, 0);

955 
	`ems_mac_upd©e
(
mac
, 
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_mac
));

956 
	`¢´štf
(
buf
, (buf), "%s:%s", 
mac
,

957 
	`cfg_g‘
(
	`emscfg
(), 
CFG_wœ–ess_ssid
));

958 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_CALLED_STATION_ID
, 
buf
, 
	`¡¾’
(buf), 0);

960 
	`mem£t
(
mac
, 0, 32);

961 
	`ems_mac_upd©e
(
mac
, 
	`¡r_‹xt
(&
dev
->
u£r
.mac));

962 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_CALLING_STATION_ID
, 
mac
, 
	`¡¾’
(mac), 0);

964 
	`¢´štf
(
buf
, (buf), "%s", 
	`cfg_g‘
(
	`emscfg
(), 
CFG_ems_¢
));

965 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_NAS_IDENTIFIER
, 
buf
, 
	`¡¾’
(buf), 0);

967 ià(
	`¡r_Ën
(&
dev
->
u£r
.
£ssid
) <= 0) {

968 
	`g‘timeofday
(&
dev
->
u£r
.
¡¬t
, 
NULL
);

970 
	`¢´štf
(
buf
, (buf), "locus%u%ld%ld",

971 
	`ems_g‘pid
(), 
dev
->
u£r
.
¡¬t
.
tv_£c
, dev->u£r.¡¬t.
tv_u£c
);

972 
	`¡r_£t
(&
dev
->
u£r
.
£ssid
, 
buf
);

974 
	`¢´štf
(
buf
, (buf), "%s", 
	`¡r_‹xt
(&
dev
->
u£r
.
£ssid
));

976 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_ACCT_SESSION_ID
, 
buf
, 
	`¡¾’
(buf), 0);

978 
tmp
 = 
dev
->
»asÚ
;

979 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_ACCT_STATUS_TYPE
, &
tmp
, 0, 0);

981 
dev
->
»asÚ
) {

987 
timev®
 
tv
;

988 
	`g‘timeofday
(&
tv
, 
NULL
);

990 
tmp
 = 
	`abs
(
tv
.
tv_£c
 - 
dev
->
u£r
.
¡¬t
.tv_sec);

991 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_ACCT_SESSION_TIME
, &
tmp
, 0, 0);

993 
tmp
 = 
dev
->
»asÚ
;

994 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_ACCT_TERMINATE_CAUSE
, &
tmp
, 0, 0);

999 
ems_ušt
 
b
, 
g
;

1001 
	`¿_upd©e_u£r_Œaffic
(
dev
);

1003 
b
 = (
dev
->
u£r
.
š_by‹s
 & 0x00ffffffff);

1004 
g
 = (
dev
->
u£r
.
š_by‹s
 >> 32);

1005 
tmp
 = 
dev
->
u£r
.
š_pkgs
;

1006 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_ACCT_INPUT_OCTETS
, &
b
, 0, 0);

1007 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_ACCT_INPUT_GIGAWORDS
, &
g
, 0, 0);

1008 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_ACCT_INPUT_PACKETS
, &
tmp
, 0, 0);

1010 
b
 = (
dev
->
u£r
.
out_by‹s
 & 0x00ffffffff);

1011 
g
 = (
dev
->
u£r
.
out_by‹s
 >> 32);

1012 
tmp
 = 
dev
->
u£r
.
out_pkgs
;

1013 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_ACCT_OUTPUT_OCTETS
, &
b
, 0, 0);

1014 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_ACCT_OUTPUT_GIGAWORDS
,&
g
, 0, 0);

1015 
	`ems_rc_av·œ_add
(
¿
->
rh
, &
dev
->
vp_out
, 
PW_ACCT_OUTPUT_PACKETS
, &
tmp
, 0, 0);

1023  
EMS_OK
;

1024 
	}
}

1026 
ems_št
 
	$¿_fl_acù_šfo
(
ems_deviû
 *
dev
, 
ems_¿dius
 *
¿
)

1028 
ems_št
 
tÙ®_Ën
;

1029 
ems_£ssiÚ
 *
£ss
 = 
dev
->sess;

1030 
AUTH_HDR
 *
auth
;

1032 
	`ems_bufãr_ş—r
(&
£ss
->
buf_out
);

1034 
auth
 = (
AUTH_HDR
 *)
	`buf_wr
(&
£ss
->
buf_out
);

1035 
auth
->
code
 = 
PW_ACCOUNTING_REQUEST
;

1036 
auth
->
id
 = 
¿
->
£q_nbr
++;

1037 
dev
->
auth_out
 = 
auth
;

1039 ià(
dev
->
vp_out
) {

1040 
	`rc_av·œ_ä“
(
dev
->
vp_out
);

1041 
dev
->
vp_out
 = 
NULL
;

1044 ià(
dev
->
vp_š
) {

1045 
	`rc_av·œ_ä“
(
dev
->
vp_š
);

1046 
dev
->
vp_š
 = 
NULL
;

1049 
	`¿_fl_acù_av·œs
(
dev
, 
¿
);

1051 
tÙ®_Ën
 = 
	`rc_·ck_li¡
(
dev
->
vp_out
, 
	`¡r_‹xt
(&
¿
->
£ü‘
), 
auth
è+ 
AUTH_HDR_LEN
;

1052 
auth
->
Ëngth
 = 
	`Áohs
((è
tÙ®_Ën
);

1055 
	`mem£t
(
auth
->
veùÜ
, 0, 
AUTH_VECTOR_LEN
);

1056 
	`memıy
((
ems_ch¬
 *)
auth
 + 
tÙ®_Ën
, 
	`¡r_‹xt
(&
¿
->
£ü‘
), 
	`¡r_Ën
(&ra->secret));

1058 
	`rc_md5_ÿlc
(
dev
->
veùÜ
, (
ems_uch¬
 *)
auth
, 
tÙ®_Ën
 + 
	`¡r_Ën
(&
¿
->
£ü‘
));

1059 
	`memıy
(
auth
->
veùÜ
, 
dev
->veùÜ, 
AUTH_VECTOR_LEN
);

1061 
	`ems_bufãr_£ek_wr
(&
£ss
->
buf_out
, 
tÙ®_Ën
, 
EMS_BUFFER_SEEK_CUR
);

1062 
dev
->
tÙ®_Ën
 =otal_len;

1064  
EMS_OK
;

1065 
	}
}

1067 
ems_št
 
	$¡_što_acù
(
ems_deviû
 *
dev
)

1069 
ems_¿dius
 *
¿
 = (ems_¿diu *)
dev
->
ùx
;

1070 
ems_£ssiÚ
 *
£ss
 = 
dev
->sess;

1072 
	`ems_as£¹
(
dev
 && 
¿
 && dev->
£ss
);

1074 
	`¿_fl_acù_šfo
(
dev
, 
¿
);

1076 
dev
->
»Œy_timeout
 = 
¿
->retry_timeout;

1077 
dev
->
»Œy_times
 = 
¿
->retry_times;

1079 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
dev_evt_cb
);

1080 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
dev
->
»Œy_timeout
 * 1000, 
dev_timeout_cb
);

1082  
EMS_OK
;

1083 
	}
}

1085 
ems_št
 
	$¡_što_acù_¡İ
(
ems_deviû
 *
dev
)

1087 
ems_¿dius
 *
¿
 = (ems_¿diu *)
dev
->
ùx
;

1088 
ems_£ssiÚ
 *
£ss
 = 
dev
->sess;

1090 
	`ems_as£¹
(
dev
 && 
¿
 && dev->
£ss
);

1092 
dev
->
»asÚ
) {

1093 
RADIUS_ERR_NETWORK
:

1094 
RADIUS_ERR_CANNOT_CONNECT
:

1099 
dev
->
»asÚ
 = 2;

1100 
	`¿_fl_acù_šfo
(
dev
, 
¿
);

1102 
dev
->
»Œy_timeout
 = 
¿
->retry_timeout;

1103 
dev
->
»Œy_times
 = 
¿
->retry_times;

1105 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
dev_evt_cb
);

1106 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
dev
->
»Œy_timeout
 * 1000, 
dev_timeout_cb
);

1113 
jsÚ_objeù
 *
jobj
;

1114 
jobj
 = 
	`jsÚ_objeù_Ãw_objeù
();

1116 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£ºame",
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
Çme
)));

1117 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£r", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.

)));

1118 
	`jsÚ_objeù_objeù_add
(
jobj
, "u£rmac", 
	`jsÚ_objeù_Ãw_¡ršg
(
	`¡r_‹xt
(&
dev
->
u£r
.
mac
)));

1119 
	`jsÚ_objeù_objeù_add
(
jobj
, "”rÜ_code",
	`jsÚ_objeù_Ãw_št
(
dev
->
»asÚ
));

1121 
	`ems_£nd_mes§ge
(
ty_¿dius
, 
ty_pÜl
, 
EMS_APP_CMD_PORTAL_LOGOUT
, 
jobj
);

1122 
	`jsÚ_objeù_put
(
jobj
);

1125 
	`¿_deviû_fœew®l_£t_ruËs
(
dev
, 
EMS_NO
);

1127 ià(
dev
->
»asÚ
 != 2)

1128  
	`dev_chªge_¡©us
(
dev
, 
¡_”r
);

1130  
EMS_OK
;

1131 
	}
}

1133 
ems_št
 
	$¿_pšg_cÚÃù
(
ems_£ssiÚ
 *
£ss
)

1135 
´ÙÛÁ
 *
´Ùo
;

1136 
ems_sock
 *
sock
 = &
£ss
->sock;

1137 
sockËn_t
 
Ën
;

1138 
sockaddr_š
 
addr
;

1139 
ems_št
 
fd
;

1141 
	`mem£t
(&
addr
, 0, (addr));

1143 ià(
	`ems_g‘ho¡byÇme
(
	`ems_sock_addr
(
sock
), &
addr
è!ğ
OK
) {

1144 
	`ems_l_Œaû
("gethostbyename failed %s : %s",

1145 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

1146  
EMS_ERR
;

1149 ià((
´Ùo
 = 
	`g‘´ÙobyÇme
("icmp")è=ğ
NULL
) {

1150 
	`ems_l_Œaû
("getprotobyname failed %s : %s",

1151 
	`ems_sock_addr
(
sock
), 
	`ems_Ï¡”rmsg
());

1152  
EMS_ERR
;

1155 ià((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_RAW
, 
´Ùo
->
p_´Ùo
)) < 0) {

1156 
	`ems_l_Œaû
("sock‘ƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

1157  
EMS_ERR
;

1160 
addr
.
sš_çmy
 = 
AF_INET
;

1161 
Ën
 = (
sockaddr_š
);

1163 ià(
	`cÚÃù
(
fd
, (
sockaddr
 *)&
addr
, 
Ën
)) {

1164 
	`şo£
(
fd
);

1165 
	`ems_l_Œaû
("cÚÃùƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

1166  
EMS_ERR
;

1169 
	`ems_sock_£tfd
(&
£ss
->
sock
, 
fd
);

1171 
	`ems_l_Œaû
("[ra] sess: %d host‡ddr: %s",

1172 
	`ems_sock_fd
(&
£ss
->
sock
), 
	`ems_sock_addr
(&sess->sock));

1174  
EMS_OK
;

1175 
	}
}

1178 
ems_št
 
	$¡_pšg_´•¬e_£ss
(
ems_deviû
 *
dev
)

1180 
ems_£ssiÚ
 *
£ss
 = 
NULL
;

1182 ià(!
dev
->
£ss_dev
) {

1183 
dev
->
£ss_dev
 = 
	`ems_£ssiÚ_Ãw
();

1184 ià(!
dev
->
£ss_dev
) {

1185 
dev
->
”r
 = 2;

1186  
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

1189 
	`£ss_cb¬g_£t
(
dev
->
£ss_dev
, dev);

1192 
£ss
 = 
dev
->
£ss_dev
;

1194 
	`ems_bufãr_ş—r
(&
£ss
->
buf
);

1195 
	`ems_bufãr_ş—r
(&
£ss
->
buf_š
);

1197 
dev
->
id’t
 = 
	`¿ndom
() & 0xFFFF;

1198 
dev
->
Á¿ns
 = 0;

1200 
	`ems_sock_£ddr
(&
£ss
->
sock
, 
	`¡r_‹xt
(&
dev
->
u£r
.

));

1202  
	`¿_pšg_cÚÃù
(
£ss
);

1203 
	}
}

1205 
u_shÜt
 
	$¿_pšg_chksum
(
u_shÜt
 *
addr
, 
ems_št
 
Ën
)

1207 
u_shÜt
 
ªsw”
, *
w
 = 
addr
;

1208 
ems_št
 
sum
 = 0, 
Æeá
 = 
Ën
;

1216  
Æeá
 > 1 ) {

1217 
sum
 +ğ*
w
++;

1218 
Æeá
 -= 2;

1222 ifĞ
Æeá
 == 1 ) {

1223 
u_shÜt
 
u
 = 0;

1225 *(
u_ch¬
 *)(&
u
èğ*(u_ch¬ *)
w
 ;

1226 
sum
 +ğ
u
;

1232 
sum
 = (sum >> 16) + (sum & 0xffff);

1233 
sum
 += (sum >> 16);

1234 
ªsw”
 = ~
sum
;

1236  
ªsw”
;

1237 
	}
}

1239 
ems_št
 
	$¡_što_pšg
(
ems_deviû
 *
dev
)

1241 
i
, 
cc
, 
Ën
;;

1242 
icmp
 *
iı
;

1243 
timev®
 *

;

1244 
ems_ch¬
 *
wr
;

1245 
ems_£ssiÚ
 *
£ss
 = 
NULL
;

1248 ià(!
dev
->
£ss_dev
) {

1249 ià(
	`¡_pšg_´•¬e_£ss
(
dev
è!ğ
EMS_OK
) {

1250 
dev
->
”r
 = 2;

1251  
	`dev_chªge_¡©us
(
dev
, 
¡_acù_¡İ
);

1255 
£ss
 = 
dev
->
£ss_dev
;

1256 
	`ems_as£¹
(
£ss
 !ğ
NULL
);

1258 
	`ems_bufãr_»£t
(&
£ss
->
buf
);

1260 
iı
 = (
icmp
 *è(
	`buf_wr
(&
£ss
->
buf
));

1261 

 = (
timev®
 *è(
	`buf_wr
(&
£ss
->
buf
) + 8);

1262 
wr
 = (
ems_ch¬
 *è(
	`buf_wr
(&
£ss
->
buf
è+ 8 + (
timev®
));

1264 
iı
->
icmp_ty³
 = 
ICMP_ECHO
;

1265 
iı
->
icmp_code
 = 0;

1266 
iı
->
icmp_cksum
 = 0;

1267 
iı
->
icmp_£q
 = 
	`htÚs
(
dev
->
Á¿ns
++);

1268 
iı
->
icmp_id
 = 
dev
->
id’t
;

1270 
Ën
 = 56;

1271 
cc
 = 
Ën
 + 8;

1272 
	`g‘timeofday
(

, 
NULL
);

1274 
i
 = 8; i < 
Ën
; i++)

1275 *
wr
++ = 
i
;

1277 
iı
->
icmp_cksum
 = 
	`¿_pšg_chksum
((
u_shÜt
 *)iı, 
cc
);

1279 
dev
->
»Œy_times
 = 
PING_RETRYTIMES
;

1281 
	`ems_bufãr_£ek_wr
(&
£ss
->
buf
, 
cc
, 
EMS_BUFFER_SEEK_CUR
);

1282 
	`£ss_ev’t_£t
(
£ss
, 
EMS_EVT_WRITE
, 
dev_evt_cb
);

1283 
	`£ss_timeout_£t_sÜ‹d
(
£ss
, 
PING_TIMEOUT
, 
dev_timeout_cb
);

1285  
EMS_OK
;

1286 
	}
}

1288 
ems_št
 
	$dev_chªge_¡©us
(
ems_deviû
 *
dev
, 
ems_¡©us
 
¡
)

1290 ià(
dev
->
¡
 == st)

1291  
EMS_OK
;

1293 
	`ems_l_Œaû
("[radius] dev(%s) change status: %s --> %s",

1294 
	`¡r_‹xt
(&
dev
->
u£r
.

),

1295 
	`ems_¡©us_¡r
(
dev
->
¡
),

1296 
	`ems_¡©us_¡r
(
¡
));

1298 
dev
->
¡
 = st;

1300 
dev
->
¡
) {

1301 
¡_¡¬t
:

1302 
¡_”r
:

1303  
	`dev_evt_run
(
dev
, 
NULL
, 0);

1306 
¡_acù
:

1307  
	`¡_što_acù
(
dev
);

1309 
¡_acù_¡İ
:

1310  
	`¡_što_acù_¡İ
(
dev
);

1312 
¡_hb
:

1313 
	`¡_što_pšg
(
dev
);

1320  
EMS_OK
;

1321 
	}
}

	@src/core/ems_radius.h

2 #iâdeà
EMS_HEADER_FOR_RADIUS_____


3 
	#EMS_HEADER_FOR_RADIUS_____


	)

5 
	~<r_cÚfig.h
>

6 
	~<šşudes.h
>

7 
	~<ä“¿dius-ş›Á.h
>

10 
	#RADIUS_ERR_SUCCESS
 0

	)

11 
	#RADIUS_ERR_CANNOT_CONNECT
 0x4000

	)

12 
	#RADIUS_ERR_REJECT
 0x4001

	)

13 
	#RADIUS_ERR_NETWORK
 0x4002

	)

16 
_ems_deviû_s
 
	tems_deviû
;

17 
_ems_¿dius_s
 
	tems_¿dius
;

18 
	s_ems_deviû_s
 {

19 
ems_queue
 
	m’Œy
;

20 
ems_£ssiÚ
 *
	m£ss_dev
;

21 
ems_£ssiÚ
 *
	m£ss
;

22 
ems_void
 *
	mùx
;

25 
ems_¡r
 
	mÇme
;

26 
ems_¡r
 
	m·ss
;

27 
ems_¡r
 
	mmac
;

28 
ems_¡r
 
	m
;

29 
ems_¡r
 
	m£ssid
;

30 
timev®
 
	m¡¬t
;

32 
off_t
 
	mš_by‹s
;

33 
off_t
 
	mout_by‹s
;

34 
off_t
 
	mš_pkgs
;

35 
off_t
 
	mout_pkgs
;

36 } 
	mu£r
;

38 
ems_št
 
	m»Œy_times
;

39 
ems_št
 
	m»Œy_timeout
;

40 
ems_št
 
	m»pÜt_³riod
;

41 
ems_št
 
	mdiscÚÃù
;

42 
ems_uch¬
 
	mveùÜ
[
AUTH_VECTOR_LEN
];

43 
ems_št
 
	mtÙ®_Ën
;

44 
ems_št
 
	m»asÚ
;

45 
ems_št
 
	m”r
;

48 
ems_ušt
 
	mÁ¿ns
;

49 
ems_št
 
	mid’t
;

51 
VALUE_PAIR
 *
	mvp_out
;

52 
VALUE_PAIR
 *
	mvp_š
;

53 
AUTH_HDR
 *
	mauth_out
;

54 
AUTH_HDR
 *
	mauth_š
;

55 
ems_¡©us
 
	m¡
;

58 
	s_ems_¿dius_s


60 
ems_queue
 
	mdev_’Œy
;

61 
rc_hªdË
 *
	mrh
;

62 
ems_ušt
 
	m£q_nbr
;

64 
ems_št
 
	mÏ¡”r
;

65 
ems_¡r
 
	m£ü‘
;

66 
ems_¡r
 
	mauth_addr
;

67 
ems_št
 
	mauth_pÜt
;

68 
ems_¡r
 
	macù_addr
;

69 
ems_št
 
	macù_pÜt
;

71 
ems_št
 
	m»Œy_times
;

72 
ems_št
 
	m»Œy_timeout
;

73 
ems_št
 
	m»pÜt_³riod
;

74 
ems_št
 
	mdiscÚÃù
;

78 
ems_št
 
dev_chªge_¡©us
(
ems_deviû
 *
dev
, 
ems_¡©us
 
¡
);

79 
ems_deviû
 *
ems_deviû_Ãw
();

80 
ems_void
 
ems_deviû_de¡roy
(
ems_deviû
 *
dev
);

	@src/core/main.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

5 
	~<libg’.h
>

7 
	$ems_št
 (*
	tems_cmd_’Œy
)(
	tems_št
 
	tcmd
,ƒms_šˆ
	t¬gc
, 
	tems_ch¬
 **
	t¬gv
);

10 
ems_št
 
id
;

11 
ems_¡r
 
cmd
;

12 
ems_cmd_’Œy
 
’Œy
;

13 } 
	tems_cmd
;

16 
ems_št
 
	`ems_maš
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

17 
ems_št
 
	`cmd_maš
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

18 
ems_št
 
	`maš_c
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

19 
ems_št
 
	`maš_ù¾
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

20 
ems_št
 
	`maš_¡©us
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

21 
ems_št
 
	`maš_bwli¡
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

22 
ems_št
 
	`maš_¿dius
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

23 
ems_št
 
	`maš_pÜl
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

24 
ems_št
 
	`maš_qos
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

25 
ems_št
 
	`maš_fw
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

26 
ems_št
 
	`maš_­p
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

27 
ems_št
 
	`maš_u£r
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

28 
ems_št
 
	`maš_wœ–ess
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

29 
ems_št
 
	`maš_ÃtwÜk
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

30 
ems_št
 
	`maš_cÚfig
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

32 
ems_št
 
	`maš_‹¡_¿dius
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

33 #ifdeà
FOR_TEST_INM


34 
ems_št
 
	`maš_‹¡_nm
Óms_šˆ
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
);

37 
ems_cmd
 
ems_cmd_bË
[] =

39 {
CMD_EMS
, 
	`ems_¡ršg
("ems"), 
ems_maš
},

40 {
CMD_EMS_C
, 
	`ems_¡ršg
("ems_c"), 
maš_c
},

41 {
CMD_EMS_CTRL
, 
	`ems_¡ršg
("ems_ù¾"), 
maš_ù¾
},

42 {
CMD_EMS_STATUS
, 
	`ems_¡ršg
("ems_¡©us"), 
maš_¡©us
},

43 {
CMD_EMS_BWLIST
, 
	`ems_¡ršg
("ems_bwli¡"), 
maš_bwli¡
},

44 {
CMD_EMS_RADIUS
, 
	`ems_¡ršg
("ems_¿dius"), 
maš_¿dius
},

45 {
CMD_EMS_PORTAL
, 
	`ems_¡ršg
("ems_pÜl"), 
maš_pÜl
},

46 {
CMD_EMS_QOS
, 
	`ems_¡ršg
("ems_qos"), 
maš_qos
},

47 {
CMD_EMS_FW
, 
	`ems_¡ršg
("ems_fw"), 
maš_fw
},

48 {
CMD_EMS_APP
, 
	`ems_¡ršg
("ems_­p"), 
maš_­p
},

49 {
CMD_EMS_USER
, 
	`ems_¡ršg
("ems_u£r"), 
maš_u£r
},

50 {
CMD_EMS_WIRELESS
,
	`ems_¡ršg
("ems_wœ–ess"), 
maš_wœ–ess
},

51 {
CMD_EMS_NETWORK
,
	`ems_¡ršg
("ems_ÃtwÜk"),
maš_ÃtwÜk
},

52 {
CMD_EMS_CONFIG
, 
	`ems_¡ršg
("ems_cÚfig"), 
maš_cÚfig
},

53 {
CMD_EMS_TEST_RADIUS
, 
	`ems_¡ršg
("ems_‹¡_¿dius"), 
maš_‹¡_¿dius
}

54 
	}
};

56 
	#SIZE_TABLE
 (
ems_cmd_bË
)/(
ems_cmd
)

	)

58 
ems_logg”
 
	g_glog
;

60 
ems_logg”
 *
	$logg”
()

62  &
_glog
;

63 
	}
}

65 #ifdeà
DEBUG


66 
ems_št


67 
	$do_‹¡
(
ems_št
 
¬gc
, 
ems_ch¬
 **
¬gv
)

69 
ems_št
 
i
;

71 
i
 = 0; i < 
¬gc
; i++)

73 
	`´štf
("¬gv[%d] = %s\n", 
i
, 
	`ba£Çme
(
¬gv
[i]));

76  
EMS_OK
;

77 
	}
}

80 
ems_void
 
	$ems_´št_u§ge
()

82 
ems_št
 
i
;

83 
ems_cmd
 *
cmd
;

85 
	`´štf
("help EMS Cmd†ists:\n");

87 
i
 = 0; i < 
SIZE_TABLE
; i++) {

88 
cmd
 = &
ems_cmd_bË
[
i
];

90 
	`´štf
("\À%s", 
	`¡r_‹xt
(&
cmd
->cmd));

93 
	`´štf
("\n");

94 
	}
}

97 
ems_št
 
	$maš
(
ems_št
 
¬gc
, 
ems_ch¬
 **
¬gv
)

99 
ems_št
 
¹n
;

100 
ems_št
 
i
;

101 
ems_cmd
 *
cmd
;

103 #ifdeà
DEBUG


104 
	`ems_»£t_¾im™
();

105 
	`do_‹¡
(
¬gc
, 
¬gv
);

108 
i
 = 0; i < 
SIZE_TABLE
; i++) {

109 
cmd
 = &
ems_cmd_bË
[
i
];

111 ià(!
	`¡rcmp
(
	`¡r_‹xt
(&
cmd
->cmd), 
	`ba£Çme
(
¬gv
[0])))

113 
	`ems_¡¬t_memÜy_Œaû
(
EMS_YES
);

114 
	`ems_logg”_š™
(&
_glog
, 
¡dout
, 
EMS_LOG_TRACE
);

115 
¹n
 = 
cmd
->
	`’Œy
(cmd->
id
, 
¬gc
, 
¬gv
);

116 
	`ems_logg”_unš™
(&
_glog
);

117 
	`ems_¡İ_memÜy_Œaû
();

118 
	`ex™
(
¹n
);

122 
	`ems_´št_u§ge
();

125 
	}
}

	@src/core/main_app.c

3 
	~"ems_cÜe.h
"

4 
	~"ems_cmd.h
"

6 
ems_št
 
	$maš_­p
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

8 
ems_št
 
¹n
;

9 
jsÚ_objeù
 *
»q
, *
obj
;

11 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

13 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

16 
¹n
 = 
MSG_ST_REQUEST_ERR
;

18 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

19 ià(!
obj
) ;

21 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

24 
	`jsÚ_objeù_put
(
»q
);

26 
	`ems_l_Œaû
("maš_­p: %d,„Šğ%d\n", 
cmd
, 
¹n
);

27  
¹n
;

28 
	}
}

	@src/core/main_bwlist.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

7 
ems_št
 
	$bwli¡_upd©e_f›ld
(
ems_cch¬
 *
key
, 
jsÚ_objeù
 *
roÙ
)

9 
ems_bufãr
 
buf
;

10 
ems_cch¬
 *
ùx
;

11 
ems_št
 
Ën
;

12 
jsÚ_objeù
 *
obj
, *
¬y
;

14 
¬y
 = 
	`jsÚ_objeù_Ãw_¬¿y
();

16 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
roÙ
, 
key
);

17 ià(!(
obj
 && 
	`jsÚ_objeù_is_ty³
(obj, 
jsÚ_ty³_¡ršg
))) {

19 
	`jsÚ_objeù_objeù_add
(
roÙ
, 
key
, 
¬y
);

20  
EMS_ERR
;

23 
ùx
 = 
	`jsÚ_objeù_g‘_¡ršg
(
obj
);

25 
Ën
 = 
	`ems_¡¾’
(
ùx
);

26 ià(
Ën
 > 0) {

27 
	`ems_bufãr_š™
(&
buf
, 
Ën
 + 2);

29 
	`¢´štf
(
	`buf_wr
(&
buf
), 
	`buf_Ëá
(&buf), "%s", 
ùx
);

31 
ems_ch¬
 *
p
, *
q
;

33 
p
 = 
	`buf_rd
(&
buf
);

36 *
p
 && (
NULL
 !ğ(
q
 = 
	`¡rchr
(p, ',')))) {

37 *
q
++ = '\0';

38 
	`jsÚ_objeù_¬¿y_add
(
¬y
, 
	`jsÚ_objeù_Ãw_¡ršg
(
p
));

39 
p
 = 
q
;

42 ià(*
p
)

43 
	`jsÚ_objeù_¬¿y_add
(
¬y
, 
	`jsÚ_objeù_Ãw_¡ršg
(
p
));

47 
	`ems_bufãr_unš™
(&
buf
);

50 
	`jsÚ_objeù_objeù_add
(
roÙ
, 
key
, 
¬y
);

52  
EMS_OK
;

53 
	}
}

57 
ems_št
 
	$bwli¡_·r£_äom_fe
(
jsÚ_objeù
 *
roÙ
, 
ems_cch¬
 *
æ
)

59 
ems_bufãr
 
buff
;

60 
ems_ch¬
 *
buf
;

61 
ems_št
 
Ën
, 
size
;

62 
FILE
 *
å
 = 
NULL
;

63 
jsÚ_tok’”
 *
tok
;

64 
jsÚ_objeù
 *
jobj
, *
obj
;

65 
jsÚ_tok’”_”rÜ
 
j”r
;

67 
å
 = 
	`fİ’
(
æ
, "r");

68 ià(!
å
)

69  
MSG_ST_REQUEST_ERR
;

71 
tok
 = 
	`jsÚ_tok’”_Ãw
();

72 ià(!
tok
) {

73 
	`fşo£
(
å
);

74  
EMS_ERR
;

77 
	`ems_bufãr_š™
(&
buff
, 
EMS_BUFFER_1K
);

79 
buf
 = 
	`buf_wr
(&
buff
);

80 
size
 = 
	`buf_Ëá
(&
buff
);

82 
jobj
 = 
NULL
;

84 
Ën
 = 
	`ä—d
(
buf
, 1, 
size
, 
å
);

85 ià(
Ën
 <= 0)

88 
jobj
 = 
	`jsÚ_tok’”_·r£_ex
(
tok
, 
buf
, 
Ën
);

90 } (
j”r
 = 
	`jsÚ_tok’”_g‘_”rÜ
(
tok
)è=ğ
jsÚ_tok’”_cÚtšue
);

92 
	`jsÚ_tok’”_ä“
(
tok
);

93 
	`ems_bufãr_unš™
(&
buff
);

94 
	`fşo£
(
å
);

96 ià(!(
jobj
 && (
j”r
 =ğ
jsÚ_tok’”_sucûss
))) {

97 
	`ems_l_Œaû
("·r£ƒ¼: %s, fe: %s", 
	`jsÚ_tok’”_”rÜ_desc
(
j”r
), 
æ
);

98 ià(
jobj
)

99 
	`jsÚ_objeù_put
(
jobj
);

100  
MSG_ST_REQUEST_ERR
;

103 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
jobj
, "url");

104 ià(
obj
) {

105 
	`jsÚ_objeù_objeù_add
(
roÙ
, "url",

106 
	`ems_jsÚ_tok’”_·r£
(
	`jsÚ_objeù_to_jsÚ_¡ršg
(
obj
)));

109 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
jobj
, "whitemac");

110 ià(
obj
) {

111 
	`jsÚ_objeù_objeù_add
(
roÙ
, "whitemac",

112 
	`ems_jsÚ_tok’”_·r£
(
	`jsÚ_objeù_to_jsÚ_¡ršg
(
obj
)));

115 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
jobj
, "blackmac");

116 ià(
obj
) {

117 
	`jsÚ_objeù_objeù_add
(
roÙ
, "blackmac",

118 
	`ems_jsÚ_tok’”_·r£
(
	`jsÚ_objeù_to_jsÚ_¡ršg
(
obj
)));

121 
	`jsÚ_objeù_put
(
jobj
);

123  
EMS_OK
;

124 
	}
}

126 
ems_št
 
	$maš_bwli¡
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

128 
ems_št
 
¹n
;

129 
jsÚ_objeù
 *
»q
, *
obj
;

130 
ems_ušt
 
æg
;

132 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

134 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

137 
¹n
 = 
MSG_ST_REQUEST_ERR
;

139 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "flag");

140 ià(!
obj
) ;

142 
æg
 = 
	`ems_©oi
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
));

143 
	`jsÚ_objeù_objeù_add
(
»q
, "æag", 
	`jsÚ_objeù_Ãw_št
(
æg
));

145 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

146 ià(!
obj
) ;

148 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

151 ià(
	`ems_æag_like
(
æg
, 0x01 << 0)) {

152 
	`bwli¡_upd©e_f›ld
("u¾", 
»q
);

155 ià(
	`ems_æag_like
(
æg
, 0x01 << 1)) {

156 
	`bwli¡_upd©e_f›ld
("wh™emac", 
»q
);

159 ià(
	`ems_æag_like
(
æg
, 0x01 << 2)) {

160 
	`bwli¡_upd©e_f›ld
("bÏckmac", 
»q
);

164 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "path");

165 ià(!
obj
) ;

167 
¹n
 = 
	`bwli¡_·r£_äom_fe
(
»q
, 
	`jsÚ_objeù_g‘_¡ršg
(
obj
));

168 ià(
¹n
 !ğ
EMS_OK
) ;

170 
	`jsÚ_objeù_objeù_d–
(
»q
, "path");

174 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

177 
	`jsÚ_objeù_put
(
»q
);

179 
	`ems_l_Œaû
("maš_c: %d,„Šğ%d\n", 
cmd
, 
¹n
);

180  
¹n
;

181 
	}
}

	@src/core/main_c.c

1 
	~"ems_cÜe.h
"

2 
	~"ems_cmd.h
"

4 
ems_št
 
	$maš_c
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

6 
ems_št
 
¹n
;

7 
jsÚ_objeù
 *
»q
, *
obj
;

9 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

11 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

14 
¹n
 = 
MSG_ST_REQUEST_ERR
;

16 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

17 ià(!
obj
) ;

19 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

21 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "addr");

22 ià(!
obj
) ;

24 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "port");

27 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

30 
	`jsÚ_objeù_put
(
»q
);

32 
	`ems_l_Œaû
("maš_c: %d,„Šğ%d\n", 
cmd
, 
¹n
);

33  
¹n
;

34 
	}
}

	@src/core/main_config.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

5 
ems_št
 
	$maš_cÚfig
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

7 
ems_št
 
¹n
;

8 
jsÚ_objeù
 *
»q
, *
obj
;

10 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

12 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

15 
¹n
 = 
MSG_ST_REQUEST_ERR
;

17 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

18 ià(!
obj
) ;

20 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

22 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "firstconfig");

23 ià(!
obj
) ;

24 
	`jsÚ_objeù_objeù_add
(
»q
, "firstconfig",

25 
	`jsÚ_objeù_Ãw_št
(

26 
	`ems_©oi
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
))

31 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

34 
	`jsÚ_objeù_put
(
»q
);

36 
	`ems_l_Œaû
("maš_cÚfig: %d,„Šğ%d\n", 
cmd
, 
¹n
);

37  
¹n
;

38 
	}
}

	@src/core/main_ctrl.c

1 
	~"ems_cÜe.h
"

2 
	~"ems_cmd.h
"

5 
ems_št
 
	$maš_ù¾
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

7 
ems_št
 
¹n
;

8 
jsÚ_objeù
 *
»q
, *
obj
;

10 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

12 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

15 
¹n
 = 
MSG_ST_REQUEST_ERR
;

17 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

18 ià(!
obj
) ;

20 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

22 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "auto");

23 ià(!
obj
) ;

24 
	`jsÚ_objeù_objeù_add
(
»q
, "auto",

25 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
))));

27 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "run");

28 ià(!
obj
) ;

30 
	`jsÚ_objeù_objeù_add
(
»q
, "run",

31 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
))));

35 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

38 
	`jsÚ_objeù_put
(
»q
);

40 
	`ems_l_Œaû
("maš_c: %d,„Šğ%d\n", 
cmd
, 
¹n
);

41  
¹n
;

42 
	}
}

	@src/core/main_fw.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

5 
ems_št
 
	$maš_fw
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

7 
ems_št
 
¹n
;

8 
jsÚ_objeù
 *
»q
, *
obj
;

10 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

12 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

15 
¹n
 = 
MSG_ST_REQUEST_ERR
;

17 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

18 ià(!
obj
) ;

20 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

23 
	`jsÚ_objeù_put
(
»q
);

25 
	`ems_l_Œaû
("maš_fw: %d,„Šğ%d\n", 
cmd
, 
¹n
);

26  
¹n
;

27 
	}
}

	@src/core/main_network_flush.c

1 
	~"ems_cÜe.h
"

2 
	~"ems_cmd.h
"

4 
ems_št
 
	$maš_ÃtwÜk
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

6 
ems_št
 
¹n
;

7 
jsÚ_objeù
 *
»q
, *
obj
;

9 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

11 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

14 
¹n
 = 
MSG_ST_REQUEST_ERR
;

16 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

17 ià(!
obj
) ;

19 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

22 
	`jsÚ_objeù_put
(
»q
);

24 
	`ems_l_Œaû
("maš_ÃtwÜk: %d,„Šğ%d\n", 
cmd
, 
¹n
);

25  
¹n
;

26 
	}
}

	@src/core/main_portal.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

5 
ems_št
 
	$maš_pÜl
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

7 
ems_št
 
¹n
;

8 
jsÚ_objeù
 *
»q
, *
obj
;

10 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

12 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

15 
¹n
 = 
MSG_ST_REQUEST_ERR
;

17 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

18 ià(!
obj
) ;

20 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

23 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "auto");

24 ià(!
	`jsÚ_objeù_g‘_št
(
	`jsÚ_objeù_objeù_g‘
(
»q
, "auto")))

26 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "addr");

27 ià(!
obj
) ;

29 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "port");

30 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "redirect_port");

31 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "reg_period");

32 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "hb_period");

36 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

39 
	`jsÚ_objeù_put
(
»q
);

41 
	`ems_l_Œaû
("maš_pÜl: %d,„Šğ%d\n", 
cmd
, 
¹n
);

42  
¹n
;

43 
	}
}

	@src/core/main_qos.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

5 
ems_št
 
	$maš_qos
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

7 
ems_št
 
¹n
;

8 
jsÚ_objeù
 *
»q
, *
obj
;

10 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

12 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

15 
¹n
 = 
MSG_ST_REQUEST_ERR
;

17 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

18 ià(!
obj
) ;

20 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

22 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "enable");

25 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

28 
	`jsÚ_objeù_put
(
»q
);

30 
	`ems_l_Œaû
("maš_qos: %d,„Šğ%d\n", 
cmd
, 
¹n
);

31  
¹n
;

32 
	}
}

	@src/core/main_radius.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

5 
ems_št
 
	$maš_¿dius
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

7 
ems_št
 
¹n
;

8 
jsÚ_objeù
 *
»q
, *
obj
;

10 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

12 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

15 
¹n
 = 
MSG_ST_REQUEST_ERR
;

17 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

18 ià(!
obj
) ;

20 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "set"))

22 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "auto");

24 ià(!
	`jsÚ_objeù_g‘_št
(
	`jsÚ_objeù_objeù_g‘
(
»q
, "auto")))

26 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "addr");

27 ià(!
obj
) ;

29 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "secret");

30 ià(!
obj
) ;

32 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "authport");

33 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "acctport");

34 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "rp_period");

35 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "retry_times");

36 
	`ems_jsÚ_»£t_key
(
obj
, 
»q
, "retry_timeout");

40 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

43 
	`jsÚ_objeù_put
(
»q
);

45 
	`ems_l_Œaû
("maš_¿dius: %d,„Šğ%d\n", 
cmd
, 
¹n
);

46  
¹n
;

47 
	}
}

	@src/core/main_status.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

5 
ems_št
 
	$maš_¡©us
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

7 
ems_št
 
¹n
;

8 
jsÚ_objeù
 *
»q
, *
obj
;

10 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

12 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

15 
¹n
 = 
MSG_ST_REQUEST_ERR
;

17 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "flag");

18 ià(!
obj
) ;

20 
	`jsÚ_objeù_objeù_add
(
»q
, "flag",

21 
	`jsÚ_objeù_Ãw_št
(
	`ems_©oi
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
))));

23 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

26 
	`jsÚ_objeù_put
(
»q
);

28 
	`ems_l_Œaû
("maš_c: %d,„Šğ%d\n", 
cmd
, 
¹n
);

29  
¹n
;

30 
	}
}

	@src/core/main_test_nm.c

2 #ifdeà
FOR_TEST_INM


4 
	~"ems_cÜe.h
"

5 
	~"ems_cmd.h
"

7 
ems_št
 
	$maš_‹¡_nm
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

9 
ems_št
 
¹n
;

10 
jsÚ_objeù
 *
»q
, *
obj
;

12 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

14 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

17 
¹n
 = 
MSG_ST_REQUEST_ERR
;

19 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

20 ià(!
obj
) ;

22 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

25 
	`jsÚ_objeù_put
(
»q
);

27 
	`ems_l_Œaû
("maš_‹¡_nm: %d,„Šğ%d\n", 
cmd
, 
¹n
);

28  
¹n
;

29 
	}
}

	@src/core/main_test_radius.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

5 
ems_št
 
	$maš_‹¡_¿dius
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

7 
ems_št
 
¹n
;

8 
jsÚ_objeù
 *
»q
, *
obj
;

10 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

12 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

15 
¹n
 = 
MSG_ST_REQUEST_ERR
;

17 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

18 ià(!
obj
) ;

20 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "username");

21 ià(!
obj
) ;

23 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "userpass");

24 ià(!
obj
) ;

26 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "userip");

27 ià(!
obj
) ;

29 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "usermac");

30 ià(!
obj
) ;

32 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

35 
	`jsÚ_objeù_put
(
»q
);

37 
	`ems_l_Œaû
("maš_‹¡_¿dius: %d,„Šğ%d\n", 
cmd
, 
¹n
);

38  
¹n
;

39 
	}
}

	@src/core/main_user.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

5 
ems_št
 
	$maš_u£r
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

7 
ems_št
 
¹n
;

8 
jsÚ_objeù
 *
»q
, *
obj
;

10 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

12 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

15 
¹n
 = 
MSG_ST_REQUEST_ERR
;

17 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

18 ià(!
obj
) ;

20 ià(!
	`¡rÿ£cmp
(
	`jsÚ_objeù_g‘_¡ršg
(
obj
), "kickout"))

22 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "userip");

23 ià(!
obj
) ;

26 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

29 
	`jsÚ_objeù_put
(
»q
);

31 
	`ems_l_Œaû
("maš_u£r: %d,„Šğ%d\n", 
cmd
, 
¹n
);

32  
¹n
;

33 
	}
}

	@src/core/main_wireless.c

2 
	~"ems_cÜe.h
"

3 
	~"ems_cmd.h
"

5 
ems_št
 
	$maš_wœ–ess
(
ems_št
 
cmd
,ƒms_šˆ
¬gc
, 
ems_ch¬
 **
¬gv
)

7 
ems_št
 
¹n
;

8 
jsÚ_objeù
 *
»q
, *
obj
;

10 
»q
 = 
	`jsÚ_objeù_Ãw_objeù
();

12 
	`cmd_·r£_cmd
(
¬gc
, 
¬gv
, 
»q
);

15 
¹n
 = 
MSG_ST_REQUEST_ERR
;

17 
obj
 = 
	`jsÚ_objeù_objeù_g‘
(
»q
, "method");

18 ià(!
obj
) ;

20 
¹n
 = 
	`exec_cmd
(
cmd
, 
»q
);

23 
	`jsÚ_objeù_put
(
»q
);

25 
	`ems_l_Œaû
("maš_wœ–ess: %d,„Šğ%d\n", 
cmd
, 
¹n
);

26  
¹n
;

27 
	}
}

	@src/event/ems_event.c

2 
	~"ems_ev’t.h
"

3 
	~"ems_maš.h
"

4 
	~"evt_•Şl.h
"

7 
ems_driv”_ev’t
 *
	gevt_drvs
[] =

9 &
evt_driv”_•Şl
,

10 
NULL


13 
ems_driv”_ev’t
 *
	$ems_ev’t_lßd_driv”
(
ems_ušt
 
evtid
)

15 
ems_driv”_ev’t
 *
drv
;

17 
drv
 = 
evt_drvs
[0]; drv !ğ
NULL
; drv++) {

18 ià(
drv
->
id
 =ğ
evtid
)

19  
drv
;

22  
NULL
;

23 
	}
}

25 
ems_št
 
	$ems_ev’t_š™
(
ems_ev’t
 *
evt
, 
ems_ušt
 
evtid
)

27 
ems_driv”_ev’t
 *
drv
;

28 
	`ems_as£¹
(
evt
 !ğ
NULL
);

30 
	`mem£t
(
evt
, 0, (
ems_ev’t
));

32 
drv
 = 
	`ems_ev’t_lßd_driv”
(
evtid
);

34 ià(!
drv
)

35  -
ERR_EVT_NOT_FOUND_DRIVER
;

37 
	`ems_as£¹
(
drv
->
š™
 && drv->
unš™
 && drv->
hªdË
 && drv->
subsüibe
 && drv->
unsubsüibe
);

39 
	`ems_l_Œaû
("ev’ˆdriv”: %x: %s", 
drv
->
id
, 
	`¡r_‹xt
(&drv->
desc
));

41 ià(
drv
->
	`š™
(drv)) {

42 
	`ems_l_Œaû
("ev’t: % š™ faed", 
	`¡r_‹xt
(&
drv
->
desc
));

43  
EMS_ERR
;

46 
	`ems_queue_š™
(&
evt
->
timeout
);

47 
evt
->
run
 = 
YES
;

48 
evt
->
drv
 = drv;

50  
EMS_OK
;

51 
	}
}

53 
ems_št
 
	$ems_ev’t_dÚe
(
ems_ev’t
 *
evt
)

55 
ems_driv”_ev’t
 *
drv
;

57 
evt
->
run
 = 
NO
;

58 
drv
 = 
evt
->drv;

60 ià(
drv
 && drv->
unš™
) {

61 
drv
->
	`unš™
(drv);

62 
evt
->
drv
 = 
NULL
;

65  
EMS_OK
;

66 
	}
}

68 
ems_št
 
	$ems_ev’t_run
(
ems_ev’t
 *
evt
, 
ems_ev’t_hªdË_exŒa_cb
 
´oc
)

70 
ems_driv”_ev’t
 *
drv
;

71 
timev®
 
tv
;

73 
evt
->
run
 = 
YES
;

74 
drv
 = 
evt
->drv;

76 
	`ems_as£¹
(
drv
 && drv->
hªdË
 && "never show uphis†ine");

78 
evt
->
run
) {

80 ià(
´oc
è{ 
	`´oc
(
evt
); }

82 ià(
evt
->
run
) {

83 
	`g‘timeofday
(&
tv
, 
NULL
);

84 
	`ems_timeout_hªdË
(&
evt
->
timeout
, &
tv
);

85 
drv
->
	`hªdË
(drv, 
	`ems_timeout_Ãxt
(&
evt
->
timeout
, &
tv
));

89  
EMS_OK
;

90 
	}
}

93 
ems_št
 
	$ems_ev’t_add
(
ems_ev’t
 *
evt
,

94 
ems_ev’t_fd
 *
fd
,

95 
ems_ušt
 
ægs
,

96 
ems_ev’t_cb
 
cb
)

98 
ems_ušt
 
æ
;

99 
ems_driv”_ev’t
 *
drv
 = 
evt
->drv;

101 ià(!
fd
->
»g
 && !(
ægs
 & 
EMS_EVT_BLOCKING
)) {

102 
æ
 = 
	`fú
(
fd
->fd, 
F_GETFL
, 0);

103 
æ
 |ğ
O_NONBLOCK
;

104 
	`fú
(
fd
->fd, 
F_SETFL
, 
æ
);

107 ià(
fd
->
»g
) {

108 ià(
fd
->
æg
 =ğ
ægs
)

109  
EMS_OK
;

112 
fd
->
cb
 = cb;

113 ià(
drv
->
	`subsüibe
(drv, 
fd
, 
ægs
))

114  
EMS_ERR
;

116 
fd
->
»g
 = 
YES
;

117 
fd
->
eof
 = 
NO
;

118 
fd
->
æg
 = 
ægs
;

119 
fd
->
”rÜ
 = 
NO
;

121  
EMS_OK
;

122 
	}
}

125 
ems_št
 
	$ems_ev’t_d–
(
ems_ev’t
 *
evt
, 
ems_ev’t_fd
 *
fd
)

127 
	`ems_as£¹
(
evt
 && 
fd
 && "never show uphis†ine");

129  
evt
->
drv
->
	`unsubsüibe
Óvt->drv, 
fd
);

130 
	}
}

132 
ems_št
 
	$ems_ev’t_’d
(
ems_ev’t
 *
evt
)

134  
evt
->
run
 = 
NO
;

135 
	}
}

137 
ems_št
 
	$ems_ev’t_fd_š™
(
ems_ev’t_fd
 *
fd
)

139 
	`mem£t
(
fd
, 0, (
ems_ev’t_fd
));

140  
EMS_OK
;

141 
	}
}

	@src/event/ems_event.h

2 #iâdeà
EMS_EVENT_HANDLER__HEADER___AAAA


3 
	#EMS_EVENT_HANDLER__HEADER___AAAA


	)

5 
	~"ems_commÚ.h
"

6 
	~"ems_tim”.h
"

7 
	~"ems_bufãr.h
"

10 
	#EMS_EVT_READ
 (1 << 0)

	)

11 
	#EMS_EVT_WRITE
 (1 << 1)

	)

12 
	#EMS_EVT_EDGE_TRIGGER
 (1 << 2)

	)

13 
	#EMS_EVT_BLOCKING
 (1 << 3)

	)

15 
	#EVT_DRIVER_EPOLL
 (1 << 0)

	)

16 
	#EVT_DRIVER_SELECT
 (1 << 1)

	)

19 
_ems_ev’t_fd_s
 
	tems_ev’t_fd
;

20 
_ems_ev’t_s
 
	tems_ev’t
;

22 
	$ems_void
 (*
	tems_ev’t_cb
)(
	tems_ev’t_fd
 *
	tevt
, 
	tems_št
 
	tev’ts
);

23 
	$ems_void
 (*
	tems_ev’t_hªdË_exŒa_cb
)(
	tems_ev’t
 *
	tevt
);

25 
_driv”_ev’t_s
 
	tems_driv”_ev’t
;

27 
	s_driv”_ev’t_s
 {

28 
ems_ušt
 
id
;

29 
ems_¡r
 
desc
;

30 
ems_void
 *
ùx
;

32 
	`ems_št
 (*
š™
)(
ems_driv”_ev’t
 *
drv
);

33 
	`ems_št
 (*
unš™
)(
ems_driv”_ev’t
 *
drv
);

34 
	`ems_št
 (*
hªdË
)(
ems_driv”_ev’t
 *
drv
, 
ems_št
 
timeout
);

35 
	`ems_št
 (*
subsüibe
)(
ems_driv”_ev’t
 *
drv
, 
ems_ev’t_fd
 *
fd
, 
ems_ušt
 
æg
);

36 
	`ems_št
 (*
unsubsüibe
)(
ems_driv”_ev’t
 *
drv
, 
ems_ev’t_fd
 *
fd
);

39 
	s_ems_ev’t_fd_s


41 
ems_št
 
fd
;

42 
ems_št
 
eof
;

43 
ems_št
 
»g
;

44 
ems_ušt
 
æg
;

45 
ems_št
 
”rÜ
;

46 
ems_ev’t_cb
 
cb
;

49 
	s_ems_ev’t_s


51 
ems_queue
 
timeout
;

52 
ems_driv”_ev’t
 *
drv
;

53 
ems_št
 
run
;

56 
ems_št
 
	`ems_ev’t_š™
(
ems_ev’t
 *
evt
, 
ems_ušt
 
evtid
);

57 
ems_št
 
	`ems_ev’t_dÚe
(
ems_ev’t
 *
evt
);

58 
ems_št
 
	`ems_ev’t_run
(
ems_ev’t
 *
evt
, 
ems_ev’t_hªdË_exŒa_cb
 
exŒa
);

59 
ems_št
 
	`ems_ev’t_’d
(
ems_ev’t
 *
evt
);

61 
ems_št
 
	`ems_ev’t_add
(
ems_ev’t
 *
evt
,

62 
ems_ev’t_fd
 *
fd
,

63 
ems_ušt
 
æags
,

64 
ems_ev’t_cb
 
cb
);

65 
ems_št
 
	`ems_ev’t_d–
(
ems_ev’t
 *
evt
, 
ems_ev’t_fd
 *
fd
);

67 
ems_št
 
	`ems_ev’t_fd_š™
(
ems_ev’t_fd
 *
fd
);

	@src/event/evt_epoll.c

2 
	~"ems_commÚ.h
"

3 
	~"evt_•Şl.h
"

5 
	~<sys/•Şl.h
>

6 
	~<sys/wa™.h
>

9 #iâdeà
EPOLLRDHUP


10 
	#EPOLLRDHUP
 0x2000

	)

13 
	#EMS_EVT_SIZE
 1024

	)

16 
evt_•Şl_s
 
	tevt_•Şl
;

19 
	sevt_•Şl_s
 {

20 
ems_št
 
	mfd
;

21 
ems_št
 
	mcur_fd
;

22 
ems_št
 
	mcur_nfds
;

23 
ems_št
 
	mn_evt
;

24 
•Şl_ev’t
 *
	mevt
;

27 
ems_št
 
	$evt_d–
(
evt_•Şl
 *
evt
, 
ems_ev’t_fd
 *
fd
)

29 
ems_št
 
i
;

31 
	`ems_as£¹
(
evt
 && 
fd
);

33 ià(!
fd
->
»g
)

34  
EMS_OK
;

36 
i
 = 
evt
->
cur_fd
 + 1; i <ƒvt->
cur_nfds
; i++) {

37 ià(
evt
->evt[
i
].
d©a
.
±r
 !ğ
fd
)

40 
evt
->evt[
i
].
d©a
.
±r
 = 
NULL
;

43 
fd
->
»g
 = 
NO
;

44 
fd
->
æg
 = 0;

46  
	`•Şl_ùl
(
evt
->
fd
, 
EPOLL_CTL_DEL
, fd->fd, 
NULL
);

47 
	}
}

50 
ems_št
 
	$evt_š™
(
ems_driv”_ev’t
 *
drv
)

52 
evt_•Şl
 *
evt
 = 
NULL
;

53 
	`ems_as£¹
(
drv
 !ğ
NULL
);

55 
evt
 = (
evt_•Şl
 *)
	`ems_m®loc
((evt_epoll));

56 ià(!
evt
)

57  
EMS_ERR
;

59 
evt
->
fd
 = 
	`•Şl_ü—‹1
(
EPOLL_CLOEXEC
);

60 ià(
evt
->
fd
 <= 0) {

61 
	`ems_ä“
(
evt
);

62  
EMS_ERR
;

65 
evt
->
n_evt
 = 
EMS_EVT_SIZE
;

67 
evt
->evˆğ(
•Şl_ev’t
 *)

68 
	`ems_m®loc
((
•Şl_ev’t
è* 
evt
->
n_evt
);

69 ià(!
evt
->evt) {

70 
	`şo£
(
evt
->
fd
);

71 
	`ems_ä“
(
evt
);

72  
EMS_ERR
;

75 
evt
->
cur_fd
 = 0;

76 
evt
->
cur_nfds
 = 0;

77 
drv
->
ùx
 = (
ems_void
 *)
evt
;

79  
EMS_OK
;

80 
	}
}

82 
ems_št
 
	$evt_unš™
(
ems_driv”_ev’t
 *
drv
)

84 
evt_•Şl
 *
evt
 = (evt_•ŞÈ*)
drv
->
ùx
;

86 
evt
->
cur_fd
 = 0;

87 
evt
->
cur_nfds
 = 0;

89 ià(
evt
->
fd
 > 0) {

90 
	`şo£
(
evt
->
fd
);

91 
evt
->
fd
 = 0;

94 ià(
evt
->evt) {

95 
	`ems_ä“
(
evt
->evt);

96 
evt
->evˆğ
NULL
;

99 
	`ems_ä“
(
evt
);

100 
drv
->
ùx
 = 
NULL
;

102  
EMS_OK
;

103 
	}
}

105 
ems_št
 
	$evt_hªdË
(
ems_driv”_ev’t
 *
drv
, 
ems_št
 
timeout
)

107 
ems_ušt
 
æg
, 
ev’ts
;

108 
ems_ev’t_fd
 *
fd
 = 
NULL
;

109 
evt_•Şl
 *
evt
 = (evt_•ŞÈ*)
drv
->
ùx
;

111 
	`ems_as£¹
(
drv
 && drv->
ùx
 && "never show uphis†ine");

114 
evt
->
cur_nfds
 = 
	`•Şl_wa™
Óvt->
fd
,ƒvt->evt,ƒvt->
n_evt
, 
timeout
);

116 
evt
->
cur_fd
 = 0;ƒvt->cur_fd <ƒvt->
cur_nfds
;ƒvt->cur_fd++) {

118 
æg
 = 0;

119 
fd
 = 
evt
->evt[evt->
cur_fd
].
d©a
.
±r
;

120 
ev’ts
 = 
evt
->evt[evt->
cur_fd
].events;

122 ià(!
fd
)

125 ià(
ev’ts
 & (
EPOLLERR
 | 
EPOLLHUP
)) {

126 
fd
->
”rÜ
 = 
YES
;

127 
	`evt_d–
(
evt
, 
fd
);

130 ià(!(
ev’ts
 & (
EPOLLRDHUP
 | 
EPOLLIN
 | 
EPOLLOUT
 | 
EPOLLERR
 | 
EPOLLHUP
)))

133 ià(
ev’ts
 & 
EPOLLRDHUP
)

134 
fd
->
eof
 = 
YES
;

136 ià(
ev’ts
 & 
EPOLLIN
)

137 
æg
 |ğ
EMS_EVT_READ
;

139 ià(
ev’ts
 & 
EPOLLOUT
)

140 
æg
 |ğ
EMS_EVT_WRITE
;

142 ià(
fd
->
cb
)

143 
fd
->
	`cb
(fd, 
æg
);

146  
EMS_OK
;

147 
	}
}

150 
ems_št


151 
	$evt_subsüibe
(
ems_driv”_ev’t
 *
drv
, 
ems_ev’t_fd
 *
fd
, 
ems_ušt
 
æg
)

153 
evt_•Şl
 *
evt
;

154 
•Şl_ev’t
 
ev
;

155 
İ
 = 
fd
->
»g
 ? 
EPOLL_CTL_MOD
: 
EPOLL_CTL_ADD
;

157 
evt
 = (
evt_•Şl
 *)
drv
->
ùx
;

159 
	`mem£t
(&
ev
, 0, (
•Şl_ev’t
));

161 ià(
æg
 & 
EMS_EVT_READ
)

162 
ev
.
ev’ts
 |ğ(
EPOLLIN
 | 
EPOLLRDHUP
);

164 ià(
æg
 & 
EMS_EVT_WRITE
)

165 
ev
.
ev’ts
 |ğ
EPOLLOUT
;

167 ià(
æg
 & 
EMS_EVT_EDGE_TRIGGER
)

168 
ev
.
ev’ts
 |ğ
EPOLLET
;

170 
ev
.
d©a
.
fd
 = fd->fd;

171 
ev
.
d©a
.
±r
 = 
fd
;

173  
	`•Şl_ùl
(
evt
->
fd
, 
İ
, fd->fd, &
ev
);

174 
	}
}

176 
ems_št


177 
	$evt_unsubsüibe
(
ems_driv”_ev’t
 *
drv
, 
ems_ev’t_fd
 *
fd
)

179 
evt_•Şl
 *
evt
;

181 
	`ems_as£¹
(
drv
 && drv->
ùx
 && "never show uphis†ine");

182 
evt
 = 
drv
->
ùx
;

184  
	`evt_d–
(
evt
, 
fd
);

185 
	}
}

188 
ems_driv”_ev’t
 
	gevt_driv”_•Şl
 = {

189 .
id
 = 
EVT_DRIVER_EPOLL
,

190 .
	gdesc
 = 
ems_¡ršg
("epoll"),

191 .
	gùx
 = 
NULL
,

193 .
	gš™
 = 
evt_š™
,

194 .
	gunš™
 = 
evt_unš™
,

195 .
	ghªdË
 = 
evt_hªdË
,

196 .
	gsubsüibe
 = 
evt_subsüibe
,

197 .
	gunsubsüibe
 = 
evt_unsubsüibe


	@src/event/evt_epoll.h

2 #iâdeà
EMS_EVENT_EPOLL_HEADER___


3 
	#EMS_EVENT_EPOLL_HEADER___


	)

5 
	~"ems_ev’t.h
"

7 
ems_driv”_ev’t
 
evt_driv”_•Şl
;

	@src/utils/ems_block.c

2 
	~"ems.h
"

3 
	~"ems_block.h
"

4 
	~"ems_uts.h
"

6 #iâdeà
DEBUG


7 
	$¡¬tMemÜyT¿û
(
u£_th»ad_§ã
)

9  
OK
;

10 
	}
}

12 
	$¡İMemÜyT¿û
()

14  
OK
;

15 
	}
}

17 
	$checkMemÜyL—k
()

19 
	}
}

21 *
	$m_m®loc
(
u32_t
 
sz
)

23  (*)
	`m®loc
(
sz
);

24 
	}
}

26 *
	$m_»Îoc
(*
bOld
, 
u32_t
 
sz
)

28  (*)
	`»®loc
(
bOld
, 
sz
);

29 
	}
}

31 
	$m_ä“
(*
b
)

33 iàĞ
b
)

34 
	`ä“
(
b
);

35 
	}
}

37 *
	$m_memdup
(
u8block_t
 *
s
, 
u32_t
 
Ën
)

39 *
b
 = 
NULL
;

41 iàĞ!
s
)

42  
NULL
;

44 
b
 = 
	`m_m®loc
(
Ën
 + 2);

45 iàĞ
b
) {

46 
	`memıy
(
b
, 
s
, 
Ën
);

47 
b
[
Ën
] = '\0';

50  
b
;

51 
	}
}

58 
	#MAX_MALLOC_SIZE
 ((1 << 23è| (1 << 21))

	)

60 
	s_memÜy_m­
 {

61 
u8block_t
 *
	m_¡¬t
;

62 
u32_t
 
	m_sz
;

63 *
	m_desc
;

64 
	m_»f
;

65 
_memÜy_m­
 *
	m_Ãxt
;

66 } 
	tblock_t
, *
	tPBLOCK
;

68 
	s_memÜy_block_
{

69 
block_t
 *
	m_h—d
;

70 
block_t
 *
	m_
;

71 
	m_u£_lock
;

72 
ems_mtx
 
	m_mtx
;

73 } 
	tmemÜy_block_t
;

75 
memÜy_block_t
 *
	gg_block
 = 
NULL
;

77 
	$lockMemÜyBlock
(
memÜy_block_t
 *
mb
)

79 iàĞ
mb
 && mb->
_u£_lock
) {

80 
	`ems_mtx_lock
(
mb
->
_mtx
);

82 
	}
}

84 
	$uÆockMemÜyBlock
(
memÜy_block_t
 *
mb
)

86 iàĞ
mb
 && mb->
_u£_lock
) {

87 
	`ems_mtx_uÆock
(
mb
->
_mtx
);

89 
	}
}

91 
block_t
 *
	$ÃwBlock
(
u8block_t
 *
pb
, 
u32_t
 
sz
, cÚ¡ *
desc
)

93 
block_t
 *
pBlock
 = 
NULL
;

95 
	`As£¹
(
pb
 && 
desc
 && 
sz
 > 0 && "Never show uphis");

96 
pBlock
 = (
block_t
 *è
	`m®loc
((block_t));

97 iàĞ
pBlock
) {

98 
pBlock
->
_¡¬t
 = 
pb
;

99 
pBlock
->
_sz
 = 
sz
;

100 
pBlock
->
_desc
 = 
	`SŒdup
(
desc
);

101 
pBlock
->
_»f
 = 
NO
;

102 
pBlock
->
_Ãxt
 = 
NULL
;

105  
pBlock
;

106 
	}
}

108 
	$»Ëa£Block
(
block_t
 *
pBlock
)

110 iàĞ
pBlock
) {

111 iàĞ
pBlock
->
_desc
) {

112 
	`ä“
(
pBlock
->
_desc
);

113 
pBlock
->
_desc
 = 
NULL
;

116 
	`ä“
(
pBlock
);

117 
pBlock
 = 
NULL
;

119 
	}
}

121 
block_t
 *
	$g‘Block
(
memÜy_block_t
 *
mb
, 
u8block_t
 *
b
)

123 
block_t
 *
h
 = 
NULL
;

124 
u8block_t
 *
’d
 = 
NULL
;

126 iàĞ
mb
 =ğ
NULL
) {

127  
NULL
;

130  
h
 = 
mb
->
_h—d
; h !ğ
NULL
; h=h->
_Ãxt
) {

131 
’d
 = 
h
->
_¡¬t
 + h->
_sz
;

132 iàĞ(
b
 >ğ
h
->
_¡¬t
è&& (b < 
’d
) ) {

137  
h
;

138 
	}
}

140 
	$v®idNode
(
u8block_t
 *
b
, 
u32_t
 
sz
)

142 
block_t
 *
h
 = 
NULL
;

143 
u8block_t
 *
’d
 = 
NULL
;

145  
h
 = 
g_block
->
_h—d
; h !ğ
NULL
; h=h->
_Ãxt
) {

146 
’d
 = 
h
->
_¡¬t
 + h->
_sz
;

147 iàĞ!((
b
 >ğ
’d
è|| (b + 
sz
 <ğ
h
->
_¡¬t
))) {

148 
	`årštf
(
¡d”r
, "\033[01;32m invalid: b: %p, size: %u, b+size: %p "

150 
b
, 
sz
, b+sz, 
’d
, 
h
->
_¡¬t
, h->
_sz
, h->
_desc
);

155  
h
 ? 
NO
:
YES
;

156 
	}
}

158 
	$addBlock
(
u8block_t
 *
pb
, 
u32_t
 
sz
, cÚ¡ *
desc
)

160 
¹n
 = 0;

161 
block_t
 *
b
 = 
NULL
;

163 iàĞ
g_block
 =ğ
NULL
) {

164  
ERR
;

167 
	`As£¹
(
sz
 > 0);

168 
	`lockMemÜyBlock
(
g_block
);

170 
¹n
 = 
ERR
;

171 
	`As£¹
(
pb
 && (
sz
 > 0è&& (sz < 
MAX_MALLOC_SIZE
è&& 
desc
);

172 
	`As£¹
(
	`v®idNode
(
pb
, 
sz
));

174 
b
 = 
	`ÃwBlock
(
pb
, 
sz
, 
desc
);

175 iàĞ
b
) {

176 iàĞ
g_block
->
_h—d
 =ğ
NULL
) {

177 
	`As£¹
(
g_block
->
_
 =ğ
NULL
);

178 
g_block
->
_h—d
 = g_block->
_
 = 
b
;

180 
	`As£¹
(
g_block
->
_
 !ğ
NULL
 );

181 
b
->
_Ãxt
 = 
g_block
->
_
->_next;

182 
g_block
->
_
->
_Ãxt
 = 
b
;

183 
g_block
->
_
 = 
b
;

186 
¹n
 = 
OK
;

189 
	`uÆockMemÜyBlock
(
g_block
);

191  
¹n
;

192 
	}
}

194 
	$d–‘eBlock
(
memÜy_block_t
 *
mb
, 
block_t
 *
b
)

196 
block_t
 *
´ev
 = 
NULL
;

197 
¹n
 = 
ERR
;

199 
	`As£¹
(
mb
 && 
b
 && "Never show uphis†ine");

201 iàĞ
mb
->
_h—d
 =ğ
b
) {

202 
mb
->
_h—d
 = mb->_h—d->
_Ãxt
;

203 iàĞ
b
 =ğ
mb
->
_
)

204 
mb
->
_
 = 
NULL
;

205 
b
->
_Ãxt
 = 
NULL
;

207 
´ev
 = 
mb
->
_h—d
;…»v !ğ
NULL
;…»v =…»v->
_Ãxt
) {

208 iàĞ
´ev
->
_Ãxt
 =ğ
b
) {

209 iàĞ
b
 =ğ
mb
->
_
)

210 
mb
->
_
 = 
´ev
;

211 
´ev
->
_Ãxt
 = 
b
->_next;

212 
b
->
_Ãxt
 = 
NULL
;

219 
	`»Ëa£Block
(
b
);

221  
¹n
;

222 
	}
}

224 
	$d–Block
(
u8block_t
 *
b
)

226 
¹n
 = 
ERR
;

227 
block_t
 *
bk
 = 
NULL
;

229 iàĞ
g_block
 =ğ
NULL
) {

230  
ERR
;

233 
	`lockMemÜyBlock
(
g_block
);

235 
¹n
 = 
ERR
;

236 
bk
 = 
	`g‘Block
(
g_block
, 
b
);

237 iàĞ
bk
) {

238 
¹n
 = 
	`d–‘eBlock
(
g_block
, 
bk
);

241 
	`uÆockMemÜyBlock
(
g_block
);

243  
¹n
;

244 
	}
}

246 
	$m_v®id_block
(*
pb
, cÚ¡ *
func
, 
lše
)

248 
¹n
 = 
YES
;

249 
block_t
 *
b
 = 
NULL
;

251 
	`lockMemÜyBlock
(
g_block
);

252 
¹n
 = 
YES
;

253 
b
 = 
	`g‘Block
(
g_block
, 
pb
);

254 iàĞ!
b
) {

255 
	`As£¹
(0 && "Call startMemoryTrace firstly");

256 
	`årštf
(
¡d”r
, "\033[01;32mInvalid block: [%s: %u], block‡ddress: %p\033[00m",

257 
func
, 
lše
, 
pb
);

258 
¹n
 = 
NO
;

260 
	`uÆockMemÜyBlock
(
g_block
);

262  
¹n
;

263 
	}
}

265 
u32_t
 
	$sizeofBlock
(*
pb
)

267 
u32_t
 
sz
 = 0;

268 
block_t
 *
b
 = 
NULL
;

270 
	`lockMemÜyBlock
(
g_block
);

271 
b
 = 
	`g‘Block
(
g_block
, 
pb
);

272 iàĞ
b
) {

273 
sz
 = 
b
->
_sz
;

275 
	`uÆockMemÜyBlock
(
g_block
);

277  
sz
;

278 
	}
}

280 
	$£tRefBlock
(*
pb
)

282 
block_t
 *
b
 = 
NULL
;

284 
	`lockMemÜyBlock
(
g_block
);

285 
b
 = 
	`g‘Block
(
g_block
, 
pb
);

286 iàĞ
b
) {

287 
b
->
_»f
 = 
YES
;

289 
	`uÆockMemÜyBlock
(
g_block
);

290  
OK
;

291 
	}
}

293 cÚ¡ *
	$descBlock
(*
pb
)

295 
buf
[1024] = {0};

296 
block_t
 *
b
 = 
NULL
;

298 
	`lockMemÜyBlock
(
g_block
);

299 
b
 = 
	`g‘Block
(
g_block
, 
pb
);

300 iàĞ
b
)

301 
	`¢´štf
(
buf
, 1024, "%s", 
b
->
_desc
);

302 
	`uÆockMemÜyBlock
(
g_block
);

304  
buf
;

305 
	}
}

307 #ifdeà
WIN32


308 
	$USHORT
 (
	tWINAPI
 *
	tC­tu»SckBackT¿ûTy³
)(
	tULONG
,ULONG,
	tPVOID
*,
	tPULONG
);

309 
C­tu»SckBackT¿ûTy³
 
_gC­tu»
 = 
NULL
;

313 
	$¡¬tMemÜyT¿û
(
u£_th»ad_§ã
)

315 iàĞ!
g_block
) {

316 
g_block
 = (
memÜy_block_t
 *è
	`m®loc
((memory_block_t));

317 ià(
g_block
) {

318 
	`mem£t
(
g_block
, 
G¬bage
, (
memÜy_block_t
));

319 
g_block
->
_h—d
 = 
NULL
;

320 
g_block
->
_
 = 
NULL
;

321 
g_block
->
_u£_lock
 = 
u£_th»ad_§ã
?
YES
:
NO
;

322 
	`ems_mtx_š™
(
g_block
->
_mtx
);

326 #ifdeà
WIN32


327 iàĞ!
_gC­tu»
) {

328 
_gC­tu»
 = (
C­tu»SckBackT¿ûTy³
)

329 (
	`G‘ProcAdd»ss
(
	`LßdLib¿ry
("kernel32.dll"),

334  
OK
;

335 
	}
}

337 
	$¡İMemÜyT¿û
()

339 
block_t
 *
tmp
 = 
NULL
;

340 
memÜy_block_t
 *
tmp_mb
 = 
NULL
;

342 iàĞ
g_block
 ) {

343 
	`checkMemÜyL—k
();

344 
	`lockMemÜyBlock
(
g_block
);

345 
tmp_mb
 = 
g_block
;

346 
g_block
 = 
NULL
;

348  
NULL
 !ğ(
tmp
 = 
tmp_mb
->
_h—d
) ) {

349 
tmp_mb
->
_h—d
 = 
tmp
->
_Ãxt
;

350 
tmp
->
_Ãxt
 = 
NULL
;

351 
	`»Ëa£Block
(
tmp
);

354 
tmp_mb
->
_h—d
 =mp_mb->
_
 = 
NULL
;

355 
	`uÆockMemÜyBlock
(
tmp_mb
);

357 
	`ems_mtx_de¡roy
(
tmp_mb
->
_mtx
);

358 
	`mem£t
(
tmp_mb
, 
G¬bage
, (
memÜy_block_t
));

359 
	`ä“
(
tmp_mb
);

360 
tmp_mb
 = 
NULL
;

363  
OK
;

364 
	}
}

366 
	$checkMemÜyL—k
()

368 
block_t
 *
tmp
 = 
NULL
;

370 
	`lockMemÜyBlock
(
g_block
);

371 iàĞ
g_block
) {

372  
tmp
 = 
g_block
->
_h—d
;m°!ğ
NULL
;m°ğtmp->
_Ãxt
) {

373 iàĞ
tmp
->
_»f
 =ğ
NO
) {

374 
	`årštf
(
¡d”r
,

375 "\033[01;32m**memÜy†—k***[%s]\033[00m", 
tmp
->
_desc
);

379 
	`uÆockMemÜyBlock
(
g_block
);

380 
	}
}

383 #ifdeà
WIN32


384 
	~<wšdows.h
>

386 #ià
defšed
 (
_MSC_VER
) && (_MSC_VER >= 1500)

387 
	~<DbgH–p.h
>

389 #´agm¨
comm’t
(
lib
, "Dbghelp.lib")

391 
	#g‘BackT¿û
(
A
,
B
èdØ{ \

	)

392 
	gi
; \

393 * 
	g¡ack
[16]; \

394 
	gäames
; \

395 
SYMBOL_INFO
 * 
	gsymbŞ
; \

396 
HANDLE
 
	g´oûss
; \

397 
	g¹n
 = 0; \

398 *
	gpch
 = 
NULL
; \

399 
	gÆeá
 = 0; \

401 iàĞ!
	g_gC­tu»
è{
	gpch
 = 
A
; *pch ='\0';;} \

403 
	g´oûss
 = 
G‘Cu¼’tProûss
(); \

405 
SymIn™Ÿlize
Ğ
´oûss
, 
NULL
, 
TRUE
 ); \

407 
	gäames
 = 
_gC­tu»
Ğ0, 16, 
¡ack
, 
NULL
 ); \

408 
	gsymbŞ
 = (
SYMBOL_INFO
*)
ÿÎoc
((SYMBOL_INFO)+256*(),1);\

409 iàĞ
	gsymbŞ
) { \

410 
	gsymbŞ
->
	gMaxNameL’
 = 255; \

411 
	gsymbŞ
->
	gSizeOfSŒuù
 = Ğ
SYMBOL_INFO
 ); \

413 
	gÆeá
 = 
B
; \

414 
	gpch
 = 
A
; \

416  
	gi
 = 0; i < 
	gäames
; i++ ) { \

417 
SymFromAddr
Ğ
´oûss
, (
DWORD64
)(
¡ack
[
i
]), 0, 
symbŞ
);\

418 
	g¹n
 = 
¢´štf
(
pch
, 
Æeá
, "###%i: %s-0x%0X\n", \

419 
äames
 - 
i
 - 1, 
symbŞ
->
Name
, \

420 
symbŞ
->
Add»ss
); \

421 
	gpch
 +ğ
¹n
; \

422 
	gÆeá
 -ğ
¹n
; \

424 
ä“
Ğ
symbŞ
 ); \

429 
	#g‘BackT¿û
(
A
,
B
)

	)

434 #ifdeà
GENERIC_LINUX


435 
	~<execšfo.h
>

437 
	#g‘BackT¿û
(
A
, 
B
èdØ{ \

	)

438 *
¬¿y
[16]; \

439 
size_t
 
size
; \

440 **
ŒaûSŒšg
; \

441 
size_t
 
i
; \

442 
Æeá
 = 0; \

443 *
pch
 = 
NULL
; \

444 
¹n
 = 0; \

446 
size
 = 
	`backŒaû
 (
¬¿y
, 16); \

447 
ŒaûSŒšg
 = 
	`backŒaû_symbŞs
 (
¬¿y
, 
size
); \

449 
pch
 = 
A
; \

450 
Æeá
 = 
B
; \

452 iàĞ
ŒaûSŒšg
) { \

453 
i
 = 0; i < 
size
 && 
Æeá
 >0; i++) { \

454 
¹n
 = 
	`¢´štf
(
pch
, 
Æeá
, \

456 
ŒaûSŒšg
[
i
]); \

457 
pch
 +ğ
¹n
; \

458 
Æeá
 -ğ
¹n
; \

461 
	`ä“
 (
ŒaûSŒšg
); \

463 
	}

	$}whe
(0)

466 
	#g‘BackT¿û
(
A
,
B
)

	)

471 
	#_®igÃdSize
(
sz
èdØ{ \

	)

472 
u32_t
 
n
 = 0, 
št_s
; \

473 
št_s
 = (); \

474 
n
 = 
sz
 % 
št_s
; \

475 iàĞ
n
) { \

476 
sz
 +ğ
št_s
 - 
n
; \

478 
	}
} 0)

480 *
	$m_m®loc
(
u32_t
 
sz
, cÚ¡ *
æ
, 
l
)

482 *
b
 = 
NULL
;

483 
desc
[1024] = {0};

484 
Œaû
[1024] = {0};

486 
	`As£¹
((
sz
 > 0è&& (sz < 
MAX_MALLOC_SIZE
));

487 
	`_®igÃdSize
(
sz
);

488 
b
 = (*)
	`m®loc
(
sz
);

489 iàĞ
b
) {

490 
	`mem£t
(
b
, 
G¬bage
, 
sz
);

491 
	`g‘BackT¿û
(
Œaû
, 1024);

493 
	`¢´štf
(
desc
, 1024, "threadid: 0x%08lx file: %s, "

495 
	`ems_g‘tid
(), 
æ
, 
l
, 
sz
, 
b
, 
Œaû
);

496 
	`addBlock
(
b
, 
sz
, 
desc
);

499  (*)
b
;

500 
	}
}

502 *
	$m_»Îoc
(*
bOld
, 
u32_t
 
sz
, cÚ¡ *
æ
, 
l
)

504 
u8block_t
 *
b
 = 
NULL
;

506 
	`As£¹
(
	`m_v®id_block
(
bOld
, 
æ
, 
l
è&& (
sz
<
MAX_MALLOC_SIZE
));

507 iàĞ
sz
 > 0 && sz >
	`sizeofBlock
(
bOld
)) {

508 
b
 = 
	`m_m®loc
(
sz
, 
æ
, 
l
);

509 iàĞ!
b
)

510  
NULL
;

511 
	`memıy
(
b
, 
bOld
, 
	`sizeofBlock
(bOld));

512 
	`m_ä“
(
bOld
, 
æ
, 
l
);

515  
b
;

516 
	}
}

518 
	$m_ä“
(*
b
, cÚ¡ *
æ
, 
l
)

520 iàĞ
b
) {

521 
	`As£¹
(
	`m_v®id_block
(
b
, 
æ
, 
l
) && "Never show uphis");

523 
	`mem£t
(
b
, 
G¬bage
, 
	`sizeofBlock
(b));

524 
	`d–Block
(
b
);

525 
	`ä“
(
b
);

526 
b
 = 
NULL
;

528 
	}
}

530 *
	$m_¡rdup
(cÚ¡ *
s
, cÚ¡ *
æ
, 
l
)

532 iàĞ!
s
)

533  
NULL
;

535  
	`m_memdup
((
u8block_t
 *)
s
, 
	`¡¾’
(s), 
æ
, 
l
);

536 
	}
}

538 *
	$m_memdup
(
u8block_t
 *
s
, 
u32_t
 
Ën
, cÚ¡ *
æ
, 
l
)

540 
u8block_t
 *
b
 = 
NULL
;

542 iàĞ!
s
)

543  
NULL
;

545 
b
 = (
u8block_t
 *)
	`m_m®loc
(
Ën
 + 2, 
æ
, 
l
);

546 iàĞ
b
) {

547 
	`memıy
(
b
, 
s
, 
Ën
);

548 ((*)
b
)[
Ën
] = '\0';

551  
b
;

552 
	}
}

554 
	$m_as£¹
(cÚ¡ *
func
, 
l
)

556 
Œaû
[1024] = {0};

558 
	`g‘BackT¿û
(
Œaû
, 1024);

560 
	`årštf
(
¡d”r
,

562 
func
, 
l
, 
Œaû
);

563 
	}
}

	@src/utils/ems_buffer.c

2 
	~"ems_commÚ.h
"

3 
	~"ems_bufãr.h
"

5 
ems_bufãr
 *
	$ems_bufãr_Ãw
(
ems_ušt
 
sz
)

7 
ems_bufãr
 *
buf
 = 
NULL
;

9 
buf
 = (
ems_bufãr
 *)
	`ems_m®loc
((ems_buffer));

11 ià(
buf
) {

13 ià(
	`ems_bufãr_š™
(
buf
, 
sz
è!ğ
EMS_OK
) {

14 
	`ems_ä“
(
buf
);

15 
buf
 = 
NULL
;

19  
buf
;

20 
	}
}

22 
ems_št
 
	$ems_bufãr_š™
(
ems_bufãr
 *
buf
, 
ems_ušt
 
sz
)

24 
	`ems_as£¹
(
buf
 !ğ
NULL
);

26 ià(!
buf
)

27  
EMS_ERR
;

29 
	`buf_h—d
(
buf
èğ
	`buf_
(bufèğ
	`buf_rd
(bufèğ
	`buf_wr
(bufèğ
NULL
;

31 
	`buf_h—d
(
buf
èğ(
ems_ch¬
 *)
	`ems_m®loc
(Óms_ch¬è* 
sz
);

33 ià(!
	`buf_h—d
(
buf
))

34  
EMS_ERR
;

36 
	`buf_
(
buf
èğ
	`buf_h—d
(bufè+ 
sz
;

37 
	`buf_wr
(
buf
èğ
	`buf_rd
(bufèğ
	`buf_h—d
(buf);

39  
EMS_OK
;

40 
	}
}

42 
ems_void
 
	$ems_bufãr_unš™
(
ems_bufãr
 *
buf
)

44 
	`ems_as£¹
(
buf
 !ğ
NULL
);

45 ià(
buf
) {

46 ià(
	`buf_h—d
(
buf
))

47 
	`ems_ä“
(
	`buf_h—d
(
buf
));

48 
	`buf_h—d
(
buf
èğ
	`buf_
(bufèğ
	`buf_rd
(bufèğ
	`buf_wr
(bufèğ
NULL
;

50 
	}
}

52 
ems_void
 
	$ems_bufãr_de¡roy
(
ems_bufãr
 *
buf
)

54 ià(
buf
) {

55 
	`ems_bufãr_unš™
(
buf
);

56 
	`ems_ä“
(
buf
);

58 
	}
}

60 
ems_št
 
	$ems_bufãr_£ek_rd
(
ems_bufãr
 *
buf
, 
ems_št
 
off
,ƒms_šˆ
pos
)

62 
	`ems_as£¹
(
buf
 !ğ
NULL
);

64 ià(!
buf
)

65  
EMS_ERR
;

67 
pos
) {

69 
EMS_BUFFER_SEEK_SET
:

70 ià((
off
 < 0è|| (ofà> (
	`buf_Ën
(
buf
è+ 
	`buf_Œash
(buf))))

71  
EMS_ERR
;

73 
	`buf_rd
(
buf
èğ
	`buf_h—d
(bufè+ 
off
;

76 
EMS_BUFFER_SEEK_CUR
:

77 ià((
off
 > 
	`buf_Ën
(
buf
)è|| (ofà< -
	`buf_Œash
(buf))) {

78  
EMS_ERR
;

81 
	`buf_rd
(
buf
èğbuf_rd(bufè+ 
off
;

84 
EMS_BUFFER_SEEK_END
:

85 ià((
off
 > 0è|| (ofà< - (
	`buf_Ën
(
buf
è+ 
	`buf_Œash
(buf)))) {

86  
EMS_ERR
;

89 
	`buf_rd
(
buf
èğ
	`buf_wr
(bufè+ 
off
;

93 
	`ems_as£¹
(0 && "argƒrror");

94  
EMS_ERR
;

97  
EMS_OK
;

98 
	}
}

100 
ems_št
 
	$ems_bufãr_£ek_wr
(
ems_bufãr
 *
buf
, 
ems_št
 
off
,ƒms_šˆ
pos
)

102 
	`ems_as£¹
(
buf
 !ğ
NULL
);

104 ià(!
buf
)

105  
EMS_ERR
;

107 
pos
) {

109 
EMS_BUFFER_SEEK_SET
:

111 ià(
off
 < 0 || ofà> (
	`buf_Ën
(
buf
è+ 
	`buf_Ëá
(buf)))

112  
EMS_ERR
;

114 
	`buf_wr
(
buf
èğ
	`buf_rd
(bufè+ 
off
;

118 
EMS_BUFFER_SEEK_CUR
:

120 ià(
off
 < -
	`buf_Ën
(
buf
è|| ofà> 
	`buf_Ëá
(buf))

121  
EMS_ERR
;

123 
	`buf_wr
(
buf
èğbuf_wr(bufè+ 
off
;

127 
EMS_BUFFER_SEEK_END
:

129 ià(
off
 > 0 || (ofà< - (
	`buf_Ën
(
buf
è+ 
	`buf_Ëá
(buf))))

130  
EMS_ERR
;

132 
	`buf_wr
(
buf
èğ
	`buf_
(bufè+ 
off
;

137 
	`ems_as£¹
(0 && "argƒrror");

141  
EMS_OK
;

142 
	}
}

144 
ems_št
 
	$ems_bufãr_»äesh
(
ems_bufãr
 *
buf
)

146 
ems_št
 
Ën
;

148 
	`ems_as£¹
(
buf
 && "argƒrror");

150 ià(!
buf
)

151  
EMS_ERR
;

153 ià(
	`buf_Œash
(
buf
) > 0) {

155 
Ën
 = 
	`buf_Ën
(
buf
);

157 
	`ems_as£¹
(
	`buf_h—d
(
buf
è!ğ
	`buf_rd
(buf));

158 
	`memıy
(
	`buf_h—d
(
buf
), 
	`buf_rd
(buf), 
Ën
);

159 
	`buf_rd
(
buf
èğ
	`buf_h—d
(buf);

160 
	`buf_wr
(
buf
èğ
	`buf_rd
(bufè+ 
Ën
;

162 #ifdeà
DEBUG


163 
	`mem£t
(
	`buf_wr
(
buf
), 
G¬bage
, 
	`buf_Ëá
(buf));

167 
	`ems_as£¹
(
	`buf_Œash
(
buf
) == 0);

169  
EMS_OK
;

170 
	}
}

172 
ems_št


173 
	$bufãr_ãtch
(
ems_bufãr
 *
buf
, 
ems_ch¬
 *
de¡
, 
ems_št
 
Ën
,ƒms_šˆ
d¿š
)

175 ià(!(
buf
 && 
de¡
 && 
Ën
 > 0))

176  
EMS_ERR
;

178 ià(
	`buf_Ën
(
buf
è< 
Ën
)

179 
Ën
 = 
	`buf_Ën
(
buf
);

181 
	`memıy
(
de¡
, 
	`buf_rd
(
buf
), 
Ën
);

183 ià(
d¿š
) {

184 #ifdeà
DEBUG


185 
ems_št
 
»t
 =

188 
	`ems_bufãr_£ek_rd
(
buf
, 
Ën
, 
EMS_BUFFER_SEEK_CUR
);

190 #ifdeà
DEBUG


191 
	`ems_as£¹
((
»t
 =ğ
EMS_OK
) && "bug inƒms_buffer_seek_rd");

195  
Ën
;

196 
	}
}

199 
ems_št
 
	$ems_bufãr_»ad
(
ems_bufãr
 *
buf
, 
ems_ch¬
 *
de¡
, 
ems_št
 
Ën
)

201 
	`ems_as£¹
(
buf
 && 
de¡
 && 
Ën
 > 0);

203  
	`bufãr_ãtch
(
buf
, 
de¡
, 
Ën
, 1);

204 
	}
}

206 
ems_št
 
	$ems_bufãr_´eãtch
(
ems_bufãr
 *
buf
, 
ems_ch¬
 *
de¡
, 
ems_št
 
Ën
)

208 
	`ems_as£¹
(
buf
 && 
de¡
 && 
Ën
 > 0);

210  
	`bufãr_ãtch
(
buf
, 
de¡
, 
Ën
, 0);

211 
	}
}

213 
ems_št
 
	$ems_bufãr_wr™e
(
ems_bufãr
 *
buf
, 
ems_cch¬
 *
¤c
, 
ems_št
 
Ën
)

215 #ifdeà
DEBUG


216 
ems_št
 
»t
;

218 
	`ems_as£¹
(
buf
 && 
¤c
 && 
Ën
 >= 0);

220 ià(!(
buf
 && 
¤c
 && 
Ën
 >= 0))

221  
EMS_ERR
;

223 ià(
Ën
 > 
	`buf_Ëá
(
buf
))

224 
Ën
 = 
	`buf_Ëá
(
buf
);

226 
	`memıy
(
	`buf_wr
(
buf
), 
¤c
, 
Ën
);

228 #ifdeà
DEBUG


229 
»t
 =

231 
	`ems_bufãr_£ek_wr
(
buf
, 
Ën
, 
EMS_BUFFER_SEEK_CUR
);

232 #ifdeà
DEBUG


233 
	`ems_as£¹
((
»t
 =ğ
EMS_OK
) && "bug inƒms_buffer_seek_wr");

236  
Ën
;

237 
	}
}

240 
ems_void
 
	$ems_bufãr_ş—r
(
ems_bufãr
 *
buf
)

242 
	`ems_as£¹
(
buf
 && "invlaid‡rg");

244 
	`buf_rd
(
buf
èğ
	`buf_wr
(bufèğ
	`buf_h—d
(buf);

245 #iâdeà
DEBUG


246 
	`mem£t
(
	`buf_rd
(
buf
), 
G¬bage
, 
	`buf_Ëá
(buf));

248 
	}
}

250 
ems_št
 
	$ems_bufãr_šü—£
(
ems_bufãr
 *
buf
, 
ems_ušt
 
šc
)

252 
ems_ušt
 
tÙ®
;

253 
ems_ch¬
 *
tmp
 = 
NULL
;

254 
ems_ušt
 
Ën
;

255 
	`ems_as£¹
(
buf
);

257 
	`ems_bufãr_»äesh
(
buf
);

259 ià(
	`buf_Ëá
(
buf
è> 
šc
)

260  
EMS_OK
;

262 
Ën
 = 
	`buf_Ën
(
buf
);

263 
tÙ®
 = 
	`buf_size
(
buf
è+ 
šc
;

265 
tmp
 = (
ems_ch¬
 *)
	`ems_»®loc
(
	`buf_h—d
(
buf
), 
tÙ®
);

266 ià(
tmp
) {

267 
	`buf_h—d
(
buf
èğ
	`buf_rd
(bufèğ
tmp
;

268 
	`buf_
(
buf
èğ
	`buf_h—d
(bufè+ 
tÙ®
;

269 
	`buf_wr
(
buf
èğ
	`buf_rd
(bufè+ 
Ën
;

271  
EMS_OK
;

274  
EMS_ERR
;

275 
	}
}

	@src/utils/ems_buffer.h

2 #iâdeà
EMS_BUFFER_HEADER____


3 
	#EMS_BUFFER_HEADER____


	)

5 
	#EMS_BUFFER_1K
 1024

	)

6 
	#EMS_BUFFER_2K
 2048

	)

7 
	#EMS_BUFFER_4k
 4096

	)

8 
	#EMS_BUFFER_8k
 8192

	)

9 
	#EMS_BUFFER_16k
 16384

	)

10 
	#EMS_BUFFER_DEFAULT_SIZE
 
EMS_BUFFER_4k


	)

12 
_ems_bufãr_s
 
	tems_bufãr
;

14 
	s_ems_bufãr_s


16 
ems_ch¬
 *
	mh—d
;

17 
ems_ch¬
 *
	m
;

18 
ems_ch¬
 *
	mrd
;

19 
ems_ch¬
 *
	mwr
;

23 
	#buf_h—d
(
buf
è((buf)->
h—d
)

	)

24 
	#buf_
(
buf
è((buf)->

)

	)

25 
	#buf_rd
(
buf
è((buf)->
rd
)

	)

26 
	#buf_wr
(
buf
è((buf)->
wr
)

	)

28 
	#buf_size
(
buf
è
	`abs
(
	`buf_
(bufè- 
	`buf_h—d
(buf))

	)

29 
	#buf_Ëá
(
buf
è
	`abs
(
	`buf_
(bufè- 
	`buf_wr
(buf))

	)

30 
	#buf_Ën
(
buf
è
	`abs
(
	`buf_wr
(bufè- 
	`buf_rd
(buf))

	)

31 
	#buf_Œash
(
buf
è
	`abs
(
	`buf_rd
(bufè- 
	`buf_h—d
(buf))

	)

33 
	#EMS_BUFFER_SEEK_SET
 1

	)

34 
	#EMS_BUFFER_SEEK_CUR
 2

	)

35 
	#EMS_BUFFER_SEEK_END
 3

	)

37 
ems_bufãr
 *
ems_bufãr_Ãw
(
ems_ušt
 
sz
);

38 
ems_št
 
ems_bufãr_š™
(
ems_bufãr
 *, 
ems_ušt
 
sz
);

39 
ems_void
 
ems_bufãr_unš™
(
ems_bufãr
 *);

40 
ems_void
 
ems_bufãr_de¡roy
(
ems_bufãr
 *);

42 
ems_št
 
ems_bufãr_£ek_rd
(
ems_bufãr
 *,ƒms_šˆ
off
,ƒms_šˆ
pos
);

43 
ems_št
 
ems_bufãr_£ek_wr
(
ems_bufãr
 *,ƒms_šˆ
off
,ƒms_šˆ
pos
);

45 
ems_št
 
ems_bufãr_»äesh
(
ems_bufãr
 *);

47 
ems_št
 
ems_bufãr_»ad
(
ems_bufãr
 *, 
ems_ch¬
 *,ƒms_šˆ
Ën
);

48 
ems_št
 
ems_bufãr_´eãtch
(
ems_bufãr
 *, 
ems_ch¬
 *,ƒms_šˆ
Ën
);

49 
ems_št
 
ems_bufãr_wr™e
(
ems_bufãr
 *, 
ems_cch¬
 *,ƒms_šˆ
Ën
);

51 
ems_void
 
ems_bufãr_ş—r
(
ems_bufãr
 *);

53 
	#ems_bufãr_­³nd
 
ems_bufãr_wr™e


	)

54 
	#ems_bufãr_­³nd_¡r
(
buf
, 
¡r
è
	`ems_bufãr_wr™e
(buf, sŒ, 
	`¡¾’
(¡r))

	)

55 
	#ems_bufãr_d¿š
(
buf
, 
Ën
è
	`ems_bufãr_£ek_rd
(buf,†’, 
EMS_BUFFER_SEEK_CUR
)

	)

56 
	#ems_bufãr_»£t
 
ems_bufãr_ş—r


	)

58 
ems_št
 
ems_bufãr_šü—£
(
ems_bufãr
 *, 
ems_ušt
 
sz
);

59 
	#ems_bufãr_ex·nd
(
buf
è
	`ems_bufãr_šü—£
(buf, 
EMS_BUFFER_4k
)

	)

	@src/utils/ems_common.h

2 #iâdeà
EMS_HEADER___ALL_____


3 
	#EMS_HEADER___ALL_____


	)

5 
	~"ems.h
"

7 #ifdeà
_LIBC


8 
	~<’dŸn.h
>

9 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


10 
	#WORDS_BIGENDIAN
 1

	)

15 #´agm¨
·ck
(
push
, 1)

17 
_ems_»que¡_s
 
	tems_»que¡
;

18 
_ems_»¥Ú£_s
 
	tems_»¥Ú£
;

21 
	u_ems_»que¡_s
 {

22 
ems_uch¬
 
	mv®
[8];

25 
ems_ušt
 
	mv®
;

27 #ifdeà
WORDS_BIGENDIAN


29 
	mmod
;

31 
	mems_uch¬
 :7;

32 
ems_uch¬
 
	mty
:1;

35 
ems_ushÜt
 
	mmsg
;

37 
ems_ushÜt
 
	mmsg
;

39 
	mmod
;

41 
	mems_uch¬
 :7;

42 
ems_uch¬
 
	mty
:1;

47 } 
	mg
;

48 
ems_ušt
 
	mËn
;

52 
	u_ems_»¥Ú£_s
 {

53 
ems_uch¬
 
	mv®
[12];

56 
ems_ušt
 
	mv®
;

58 #ifdeà
WORDS_BIGENDIAN


60 
	mmod
;

62 
	mems_ušt
 :7;

63 
ems_ušt
 
	mty
:1;

66 
ems_ushÜt
 
	mmsg
;

68 
ems_ushÜt
 
	mmsg
;

70 
	mmod
;

72 
	mems_ušt
 :7;

73 
ems_ušt
 
	mty
:1;

78 } 
	mg
;

79 
ems_ušt
 
	mËn
;

80 
ems_ušt
 
	m¡
;

85 
	#EMS_CONTINUE
 0xff11¯bb

	)

86 
	#EMS_BUFFER_FULL
 0xff11¯bc

	)

87 
	#EMS_BUFFER_INSUFFICIENT
 0xff11¯bd

	)

88 
	#EMS_REQUEST
 0

	)

89 
	#EMS_RESPONSE
 1

	)

91 
	#SIZE_REQUEST
 (
ems_»que¡
)

	)

92 
	#SIZE_RESPONSE
 (
ems_»¥Ú£
)

	)

94 
	#INTSIZE
 4

	)

95 
	#ALIGNLEN
(
l
è(Ö)%
INTSIZE
==0)?Ö):((Ö)/INTSIZE + 1è* INTSIZE);

	)

97 
	#g‘wÜd
(
buf
, 
w
) do { \

98 
w
 = ()
	`Áohl
(*(*)
buf
); \

99 
buf
 +ğ
INTSIZE
; \

100 } 0)

	)

102 
	#putwÜd
(
buf
, 
w
) do { \

103 *(*)
buf
 = 
	`htÚl
(
w
); \

104 
buf
 +ğ
INTSIZE
; \

105 } 0)

	)

107 
	#putmem
(
buf
, 
m
, 
l
) do { \

108 
	`putwÜd
(
buf
, 
l
); \

109 
	`memıy
(
buf
, 
m
, 
l
); \

110 
buf
 +ğ
	`ALIGNLEN
(
l
); \

111 } 0)

	)

113 
	#g‘mem
(
buf
, 
m
, 
l
) do { \

114 
	`g‘wÜd
(
buf
, 
l
); \

115 
	`memıy
(
m
, 
buf
, 
l
); \

116 
buf
 +ğ
	`ALIGNLEN
(
l
); \

117 } 0)

	)

119 
	#put¡r
(
buf
, 
¡r
) do { \

120 
l
 = (
¡r
 =ğ
NULL
?0:
	`¡¾’
(str)); \

121 
	`putmem
(
buf
, 
¡r
, 
l
); \

122 } 0)

	)

124 
	#g‘¡r
(
buf
, 
¡r
) do { \

125 
l
; \

126 
	`g‘mem
(
buf
, 
¡r
, 
l
); \

127 } 0)

	)

130 #´agm¨
·ck
(
pİ
)

132 
	#ems_¡¬t_memÜy_Œaû
 
¡¬tMemÜyT¿û


	)

133 
	#ems_¡İ_memÜy_Œaû
 
¡İMemÜyT¿û


	)

135 
	#ems_¡¾’
(
a
è×?
	`¡¾’
×):0)

	)

137 #iâdeà
EMS_YES


138 
	#EMS_YES
 1

	)

141 #iâdeà
EMS_NO


142 
	#EMS_NO
 0

	)

145 
	#EMS_FLG_DEFAULT
 (1 << 0)

	)

146 
	#EMS_FLG_ENABLE
 (1 << 1)

	)

147 
	#EMS_FLG_INHERIET
 (1 << 2)

	)

148 
	#EMS_FLG_KICKOFF
 (1 << 3)

	)

149 
	#EMS_FLG_ONLINE
 (1 << 31)

	)

152 
	#ems_æag_like
(
æd
, 
æg
è((ædè& (æg))

	)

153 
	#ems_æag_uÆike
(
æd
, 
æg
è!
	`ems_æag_like
(æd, flg)

	)

154 
	#ems_æag_£t
(
æd
, 
æg
è((ædè|ğ(æg))

	)

155 
	#ems_æag_un£t
(
æd
, 
æg
èif(
	`ems_æag_like
(æd, flg)è((ædè^ğ(æg))

	)

156 
	#ems_æag_‹¡
 
ems_æg_like


	)

159 
	#EMS_MODULE_WEB
 0x01

	)

160 
	#EMS_MODULE_AC
 0x02

	)

161 
	#EMS_MODULE_LOGIC
 0x03

	)

162 
	#EMS_MODULE_AAA
 0x04

	)

165 
	#EMS_TICKET_LEN
 20

	)

	@src/utils/ems_getopt.c

2 #ifdeà
WIN32


4 
	~<¡ršg.h
>

5 
	~<¡dio.h
>

7 
	~"ems_g‘İt.h
"

9 
	#BADCH
 ()'?'

	)

10 
	#BADARG
 ()':'

	)

11 
	#EMSG
 ""

	)

13 
	gİ‹¼
 = 1,

14 
	gİtšd
 = 1,

15 
	gİtİt
,

16 
	gİŒe£t
;

19 
	$ems_g‘İt
(
Çrgc
, * cÚ¡ 
Çrgv
[], cÚ¡ *
o¡r
)

21 *
¶aû
 = 
EMSG
;

22 cÚ¡ *
Şi
;

24 ià(
İŒe£t
 || !*
¶aû
) {

25 
İŒe£t
 = 0;

26 ià(
İtšd
 >ğ
Çrgc
 || *(
¶aû
 = 
Çrgv
[optind]) != '-') {

27 
¶aû
 = 
EMSG
;

30 ià(
¶aû
[1] && *++place == '-') {

31 ++
İtšd
;

32 
¶aû
 = 
EMSG
;

36 ià((
İtİt
 = ()*
¶aû
++) == ()':' ||

37 !(
Şi
 = 
	`¡rchr
(
o¡r
, 
İtİt
))) {

42 ià(
İtİt
 == ()'-')

44 ià(!*
¶aû
)

45 ++
İtšd
;

46 ià(
İ‹¼
 && *
o¡r
 != ':')

47 ()
	`´štf
("Ëg® o±iÚ -- %c\n", 
İtİt
);

48  (
BADCH
);

50 ià(*++
Şi
 != ':') {

51 
İrg
 = 
NULL
;

52 ià(!*
¶aû
)

53 ++
İtšd
;

56 ià(*
¶aû
)

57 
İrg
 = 
¶aû
;

58 ià(
Çrgc
 <ğ++
İtšd
) {

59 
¶aû
 = 
EMSG
;

60 ià(*
o¡r
 == ':')

61  (
BADARG
);

62 ià(
İ‹¼
)

63 ()
	`´štf
("İtiÚ„equœe ª‡rgum’ˆ-- %c\n", 
İtİt
);

64  (
BADCH
);

67 
İrg
 = 
Çrgv
[
İtšd
];

68 
¶aû
 = 
EMSG
;

69 ++
İtšd
;

71  (
İtİt
);

72 
	}
}

	@src/utils/ems_hash.c

2 
	~"ems_commÚ.h
"

3 
	~"ems_hash.h
"

6 
ems_št


7 
	$hash_üc
(
ems_cch¬
 *
¤c
)

9 
ems_ch¬
 
ch
;

10 
ems_št
 
ems_üc
 = 0;

12 *
¤c
) {

13 
ch
 = *
¤c
++;

15 
ems_üc
 ^ğ((
ch
 << 8) ^ ch);

18  
ems_üc
;

19 
	}
}

21 
ems_hash_fd
 *
	$hash_fšd
(
ems_queue
 *
h—d
, 
ems_cch¬
 *
key
)

23 
ems_queue
 *
p
;

24 
ems_hash_fd
 *
fd
;

26 
	`ems_as£¹
(
h—d
 && 
key
);

28 ià(!(
h—d
 && 
key
))

29  
NULL
;

31 
	`ems_queue_fÜ—ch
(
h—d
, 
p
) {

33 
fd
 = 
	`ems_queue_d©a
(
p
, 
ems_hash_fd
, 
li¡
);

35 
	`ems_as£¹
(
	`¡r_‹xt
(&
fd
->
key
));

37 ià(
	`¡rcmp
(
	`¡r_‹xt
(&
fd
->
key
), key) == 0)

38  
fd
;

41  
NULL
;

42 
	}
}

46 
ems_hash
 *
	$ems_hash_ü—‹
(
ems_št
 
n_ba£
)

48 
ems_hash
 *
hash
 = 
NULL
;

50 
hash
 = (
ems_hash
 *)
	`ems_m®loc
((ems_hash));

52 ià(
hash
) {

53 ià(
	`ems_hash_š™
(
hash
, 
n_ba£
è!ğ
EMS_OK
) {

54 
	`ems_ä“
(
hash
);

55 
hash
 = 
NULL
;

59  
hash
;

60 
	}
}

62 
ems_št
 
	$ems_hash_š™
(
ems_hash
 *
hash
, 
ems_št
 
ba£
)

64 
ems_št
 
i
;

66 
	`ems_as£¹
(
hash
 && 
ba£
 > 0 && "invalid‡rg");

68 
	`mem£t
(
hash
, 0, (
ems_hash
));

70 
hash
->
ba£
 = (
ems_queue
 *)
	`ems_m®loc
((ems_queue) * base);

71 ià(!
hash
->
ba£
)

72  
EMS_ERR
;

74 
hash
->
n_ba£
 = 
ba£
;

76 
i
 = 0; i < 
hash
->
n_ba£
; i++) {

77 
	`ems_queue_š™
(&(
hash
->
ba£
[
i
]));

80  
EMS_OK
;

81 
	}
}

83 
ems_void
 
	$ems_hash_unš™
(
ems_hash
 *
hash
)

85 
	`ems_as£¹
(
hash
);

87 ià(
hash
->
ba£
) {

88 
	`ems_ä“
(
hash
->
ba£
);

89 
hash
->
ba£
 = 
NULL
;

92 
hash
->
n_ba£
 = 0;

93 
	}
}

95 
ems_void
 
	$ems_hash_de¡roy
(
ems_hash
 *
hash
)

97 
	`ems_as£¹
(
hash
);

99 ià(
hash
) {

100 
	`ems_hash_unš™
(
hash
);

101 
	`ems_ä“
(
hash
);

103 
	}
}

106 
ems_št
 
	$ems_hash_š£¹
(
ems_hash
 *
hash
, 
ems_hash_fd
 *
fd
)

108 
ems_hash_fd
 *
tmp
;

109 
ems_queue
 *
h—d
;

111 
	`ems_as£¹
(
hash
 && 
fd
);

113 
fd
->
üc
 = fd->üø% 
hash
->
n_ba£
;

115 
	`ems_as£¹
(
fd
->
üc
 >ğ0 && fd->üø< 
hash
->
n_ba£
);

117 
h—d
 = &(
hash
->
ba£
[
fd
->
üc
]);

119 
tmp
 = 
	`hash_fšd
(
h—d
, 
	`¡r_‹xt
(&
fd
->
key
));

120 ià(
tmp
)

121  
EMS_ERR_TICKET_EXIST
;

123 
	`ems_queue_š£¹_h—d
(
h—d
, &
fd
->
li¡
);

124  
EMS_OK
;

125 
	}
}

127 
ems_hash_fd
 *
	$ems_hash_»move
(
ems_hash_fd
 *
fd
)

129 
	`ems_queue_»move
(&
fd
->
li¡
);

130  
fd
;

131 
	}
}

133 
ems_hash_fd
 *
	$ems_hash_fšd
(
ems_hash
 *
hash
, 
ems_cch¬
 *
key
)

135 
ems_št
 
üc
;

136 
ems_queue
 *
h—d
;

138 
üc
 = 
	`hash_üc
(
key
);

140 
	`ems_as£¹
(
hash
->
n_ba£
 > 2 && hash->
ba£
);

142 
üc
 = crø% 
hash
->
n_ba£
;

143 
	`ems_as£¹
(
üc
 >ğ0 && crø< 
hash
->
n_ba£
);

145 
h—d
 = &
hash
->
ba£
[
üc
];

147  
	`hash_fšd
(
h—d
, 
key
);

148 
	}
}

150 
ems_št
 
	$ems_hash_fd_š™
(
ems_hash_fd
 *
fd
)

152 
	`ems_as£¹
(
fd
);

154 
	`mem£t
(
fd
, 0, (
ems_hash_fd
));

156 
	`¡r_š™
(&
fd
->
key
);

157 
	`ems_queue_š™
(&
fd
->
li¡
);

159  
EMS_OK
;

160 
	}
}

162 
ems_št
 
	$ems_hash_fd_£t_key
(
ems_hash_fd
 *
fd
, 
ems_cch¬
 *
key
)

164 
	`ems_as£¹
(
fd
 && 
key
);

166 
fd
->
üc
 = 
	`hash_üc
(
key
);

167 
	`¡r_£t
(&
fd
->
key
, key);

169  
EMS_OK
;

170 
	}
}

172 
ems_void
 
	$ems_hash_fd_unš™
(
ems_hash_fd
 *
fd
)

174 
	`ems_as£¹
(
fd
);

176 
	`¡r_unš™
(&
fd
->
key
);

178 
	`mem£t
(
fd
, 0, (
ems_hash_fd
));

179 
	}
}

182 
ems_št
 
	$ems_hash_ş—n
(
ems_hash
 *
hash
)

184 
ems_št
 
i
;

186 
i
 = 0; i < 
hash
->
n_ba£
; i++) {

187 
	`ems_queue_ş—n
(&
hash
->
ba£
[
i
]);

190  
EMS_OK
;

191 
	}
}

193 
ems_št
 
	$ems_hash_w®k
(
ems_hash
 *
hash
, 
ems_hash_’um_cb
 
cb
, 
ems_void
 *
¬g
)

195 
ems_št
 
i
, 
»t
;

196 
ems_queue
 *
p
, *
n
;

197 
ems_hash_fd
 *
fd
;

199 
	`ems_as£¹
(
hash
 && 
cb
);

201 ià(!(
hash
 && 
cb
))

202  
EMS_ERR
;

204 
i
 = 0; i < 
hash
->
n_ba£
; i++) {

206 
	`ems_queue_fÜ—ch_§ã
(&
hash
->
ba£
[
i
], 
p
, 
n
) {

208 
fd
 = 
	`ems_queue_d©a
(
p
, 
ems_hash_fd
, 
li¡
);

210 
»t
 = 
	`cb
(
fd
, 
¬g
);

212 ià(
»t
 !ğ
EMS_OK
)

213  
»t
;

217  
EMS_OK
;

218 
	}
}

220 
ems_cch¬
 *
	$ems_hash_key
(
ems_ušt
 
n
)

222 
ems_ch¬
 
tmp_buf
[128] = {0};

224 
	`¢´štf
(
tmp_buf
, 128, "%x", 
n
);

225  
tmp_buf
;

226 
	}
}

	@src/utils/ems_hash.h

2 #iâdeà
EMS_HASH_TABLES___HEADER____


3 
	#EMS_HASH_TABLES___HEADER____


	)

5 
	#EMS_HASH_BASE_SIZE
 4096

	)

6 
	#EMS_HASH_BASE_SMALL
 128

	)

7 
	#EMS_HASH_BASE_TINY
 64

	)

8 
	#EMS_HASH_BASE_DEFAULT
 4096

	)

10 
_ems_hash_fd_s
 
	tems_hash_fd
;

11 
_ems_hash_s
 
	tems_hash
;

13 
	$ems_št
 (*
	tems_hash_’um_cb
)(
	tems_hash_fd
 *
	tfd
, 
	tems_void
 *
	t¬g
);

16 
	s_ems_hash_fd_s
 {

17 
ems_queue
 
li¡
;

18 
ems_št
 
üc
;

19 
ems_¡r
 
key
;

23 
	s_ems_hash_s
 {

24 
ems_št
 
n_ba£
;

25 
ems_queue
 *
ba£
;

29 
ems_hash
 *
	`ems_hash_ü—‹
(
ems_št
 
n_ba£
);

30 
ems_št
 
	`ems_hash_š™
(
ems_hash
 *
hash
,ƒms_šˆ
ba£
);

31 
ems_void
 
	`ems_hash_unš™
(
ems_hash
 *
hash
);

32 
ems_void
 
	`ems_hash_de¡roy
(
ems_hash
 *
hash
);

35 
ems_št
 
	`ems_hash_š£¹
(
ems_hash
 *
hash
, 
ems_hash_fd
 *
fd
);

36 
ems_hash_fd
 *
	`ems_hash_»move
Óms_hash_fd *
fd
);

37 
ems_hash_fd
 *
	`ems_hash_fšd
(
ems_hash
 *
hash
, 
ems_cch¬
 *
key
);

39 
ems_št
 
	`ems_hash_fd_š™
(
ems_hash_fd
 *
fd
);

40 
ems_št
 
	`ems_hash_fd_£t_key
(
ems_hash_fd
 *
fd
, 
ems_cch¬
 *
key
);

41 
ems_void
 
	`ems_hash_fd_unš™
(
ems_hash_fd
 *
fd
);

43 
ems_cch¬
 *
	`ems_hash_key
(
ems_ušt
 
n
);

45 
ems_št
 
	`ems_hash_w®k
(
ems_hash
 *
hash
, 
ems_hash_’um_cb
 
cb
, 
ems_void
 *
¬g
);

46 
	#ems_hash_’um
 
ems_hash_w®k


	)

48 
ems_št
 
	`ems_hash_ş—n
(
ems_hash
 *
hash
);

	@src/utils/ems_logger.c

2 
	~"ems_commÚ.h
"

3 
	~"ems_bufãr.h
"

4 
	~"ems_logg”.h
"

5 
	~<¡d¬g.h
>

7 #ifdeà
WIN32


8 
	#NEWLINE
 "\r\n"

	)

10 
	#NEWLINE
 "\n"

	)

13 
ems_št
 
	$ems_logg”_š™
(
ems_logg”
 *
log
, 
FILE
 *
å
, 
ems_št
 
Ëv–
)

15 
	`mem£t
(
log
, 0, (
ems_logg”
));

17 ià(
Ëv–
 < 0)

18 
Ëv–
 = 0;

20 
log
->
å
 = fp;

21 ià(!
log
->
å
)

22 
log
->
å
 = 
¡dout
;

24 
log
->
Ëv–
 =†evel;

26 
	`ems_bufãr_š™
(&
log
->
buf
, 
EMS_BUFFER_1K
);

28  
EMS_OK
;

29 
	}
}

31 
ems_št
 
	$ems_logg”_»£t
(
ems_logg”
 *
log
)

33 
	`ems_as£¹
(
log
 !ğ
NULL
);

35 ià(
log
->
å
)

36 
log
->
å
 = 
¡dout
;

38 
	`ems_bufãr_»£t
(&
log
->
buf
);

40 
log
->
Ëv–
 = 0;

42  
EMS_OK
;

43 
	}
}

45 
ems_void
 
	$ems_logg”_unš™
(
ems_logg”
 *
log
)

47 
	`ems_logg”_»£t
(
log
);

48 
	`ems_bufãr_unš™
(&
log
->
buf
);

49 
	}
}

51 #ifdeà
DEBUG


52 
ems_void
 
	$_ems_logg”
(

53 
ems_št
 
Ëv–
,

54 
ems_cch¬
 *
æ
,

55 
ems_ušt
 
l
,

56 
ems_logg”
 *
log
,

57 
ems_cch¬
 *
fmt
, ...)

59 
ems_void
 
	$_ems_logg”
(
ems_št
 
Ëv–
, 
ems_logg”
 *
log
, 
ems_cch¬
 *
fmt
, ...)

63 
ems_ch¬
 *
p
;

64 
ems_št
 
Ëá
;

65 
ems_št
 
»t
;

66 
va_li¡
 
¬gs
;

67 
time_t
 
tm
;

69 ià(
Ëv–
 > 
log
->level)

72 
p
 = 
	`buf_wr
(&
log
->
buf
);

73 
Ëá
 = 
	`buf_Ëá
(&
log
->
buf
);

75 
	`time
(&
tm
);

76 
»t
 = 
	`¢´štf
(
p
, 
Ëá
, "%s", 
	`ùime
(&
tm
));

78 
Ëá
 -ğ
»t
 -1;

79 
p
 +ğ
»t
 -1;

81 #ifdeà
DEBUG


82 
»t
 = 
	`¢´štf
(
p
, 
Ëá
, "[%s:%d]==%u==\t", 
æ
, 
l
, 
	`ems_g‘pid
());

84 
Ëá
 -ğ
»t
;

85 
p
 +ğ
»t
;

88 
	`va_¡¬t
(
¬gs
, 
fmt
);

89 
»t
 = 
	`v¢´štf
(
p
, 
Ëá
, 
fmt
, 
¬gs
);

90 
	`va_’d
(
¬gs
);

92 ià(
log
->
å
) {

93 
	`fwr™e
(
	`buf_rd
(&
log
->
buf
), 
	`¡¾’
(buf_rd(&log->buf)), 1,†og->
å
);

94 
	`fwr™e
(
NEWLINE
, 
	`¡¾’
(NEWLINE), 1, 
log
->
å
);

95 
	`fæush
(
log
->
å
);

97 
	`årštf
(
¡dout
, "%s\n", 
	`buf_rd
(&
log
->
buf
));

98 
	`fæush
(
¡dout
);

100 
	}
}

	@src/utils/ems_logger.h

2 #iâdeà
EMS_LOGGER_LOGGER_HEADER___


3 
	#EMS_LOGGER_LOGGER_HEADER___


	)

5 
ems_logg”_s_
 
	tems_logg”
;

7 
	sems_logg”_s_


9 
FILE
 *
	må
;

10 
ems_št
 
	mËv–
;

11 
ems_bufãr
 
	mbuf
;

14 
	#EMS_LOG_TRACE
 5

	)

15 
	#EMS_LOG_INFO
 4

	)

16 
	#EMS_LOG_WARN
 3

	)

17 
	#EMS_LOG_ERR
 2

	)

18 
	#EMS_LOG_FAULT
 1

	)

21 #ifdeà
DEBUG


22 
ems_void
 
_ems_logg”
(

23 
ems_št
 
Ëv–
,

24 
ems_cch¬
 *
æ
,

25 
ems_ušt
 
l
,

26 
ems_logg”
 *
log
,

27 
ems_cch¬
 *
fmt
, ...);

30 
	#ems_logg”_Œaû
(
log
, 
fmt
, 
¬gs
...) \

31 
	`_ems_logg”
(
EMS_LOG_TRACE
, 
__FUNCTION__
, 
__LINE__
, 
log
, 
fmt
, ##
¬gs
)

	)

33 
	#ems_logg”_šfo
(
log
, 
fmt
, 
¬gs
...) \

34 
	`_ems_logg”
(
EMS_LOG_INFO
, 
__FUNCTION__
, 
__LINE__
, 
log
, 
fmt
, ##
¬gs
)

	)

36 
	#ems_logg”_w¬n
(
log
, 
fmt
, 
¬gs
...) \

37 
	`_ems_logg”
(
EMS_LOG_WARN
, 
__FUNCTION__
, 
__LINE__
, 
log
, 
fmt
, ##
¬gs
)

	)

39 
	#ems_logg”_”rÜ
(
log
, 
fmt
, 
¬gs
...) \

40 
	`_ems_logg”
(
EMS_LOG_ERR
, 
__FUNCTION__
, 
__LINE__
, 
log
,
fmt
, ##
¬gs
)

	)

42 
	#ems_logg”_çuÉ
(
log
, 
fmt
, 
¬gs
...) \

43 
	`_ems_logg”
(
EMS_LOG_FAULT
, 
__FUNCTION__
, 
__LINE__
, 
log
, 
fmt
, ##
¬gs
)

	)

47 
ems_void
 
_ems_logg”
(
ems_št
 
Ëv–
, 
ems_logg”
 *
log
, 
ems_cch¬
 *
fmt
, ...);

48 
	#ems_logg”_Œaû
(...)

	)

49 
	#ems_logg”_šfo
(
log
, 
fmt
, 
¬gs
...è
	`_ems_logg”
(
EMS_LOG_INFO
,†og, fmt, ##¬gs)

	)

50 
	#ems_logg”_w¬n
(
log
, 
fmt
, 
¬gs
...è
	`_ems_logg”
(
EMS_LOG_WARN
,†og, fmt, ##¬gs)

	)

51 
	#ems_logg”_”rÜ
(
log
, 
fmt
, 
¬gs
...è
	`_ems_logg”
(
EMS_LOG_ERR
,†og, fmt, ##¬gs)

	)

52 
	#ems_logg”_çuÉ
(
log
, 
fmt
, 
¬gs
...è
	`_ems_logg”
(
EMS_LOG_FAULT
,log, fmt, ##¬gs)

	)

57 
ems_št
 
ems_logg”_š™
(
ems_logg”
 *
log
, 
FILE
 *
å
,ƒms_šˆ
Ëv–
);

58 
ems_št
 
ems_logg”_»£t
(
ems_logg”
 *
log
);

59 
ems_void
 
ems_logg”_unš™
(
ems_logg”
 *
log
);

61 
	#ems_logg”_£t_å
(
log
, 
f
è(Öog)->
å
=(f))

	)

62 
	#ems_logg”_£t_Ëv–
(
log
, 
l
è(Öog)->
Ëv–
 = (l))

	)

	@src/utils/ems_main.h

2 #iâdeà
EMS_CHILD_PROCESS_MAIN__HEADER__


3 
	#EMS_CHILD_PROCESS_MAIN__HEADER__


	)

5 
	~"ems_commÚ.h
"

6 
	~"ems_tim”.h
"

7 
	~"ems_hash.h
"

8 
	~"ems_bufãr.h
"

9 
	~"ems_sock.h
"

10 
	~"ems_ev’t.h
"

11 
	~"ems_logg”.h
"

12 
	~"ems_msg.h
"

13 
	~"ems_£ssiÚ.h
"

15 
_ems_time_s
 
	tems_time
;

16 
_ems_­p_ty³_s
 
	tems_­p_ty³
;

18 
	e_ems_­p_ty³_s


20 
	mty_mš
 = -1,

21 
	mty_fw
 = 0,

22 
	mty_pÜl
,

23 
	mty_¿dius
,

24 
	mty_bwli¡
,

25 
	mty_dowÆšk
,

26 
	mty_bridge
,

27 
	mty_ù¾
,

28 
	mty_Ãt
,

29 
	mty_ş›Á
,

30 
	mty_max


33 
	s_ems_time_s


35 
timev®
 
	mü—‹
;

36 
timev®
 
	mmodify
;

37 
timev®
 
	mexpœe
;

42 
	#EMS_TIMEOUT_SESSION_INIT
 (12000)

43 
	#EMS_TIMEOUT_USER_ACCEPTED
 (3000)

44 
	#EMS_TIMEOUT_WAITTING
 (1500)

45 
	#EMS_TIMEOUT_ESTABLISHED
 (12000)

46 
	#EMS_TIMEOUT_SENDMSG
 (3000)

47 
	#EMS_TIMEOUT_RETRY
 (6000)

48 
	#EMS_TIMEOUT_HEARTBEAT
 (3000)

49 
	#EMS_TIMEOUT_AUTH
 (3000)

50 

	)

51 
	#EMS_LOGIC_PORT
 8196

	)

52 
	#EMS_AAA_PORT
 6918

	)

53 
	#EMS_MAX_NOFILE
 61000

	)

59 
ems_logg”
 *
logg”
();

60 
ems_ev’t
 *
ev’‹r
();

61 
ems_queue
 *
timeou‹r
();

64 
	#ems_l_Œaû
(
fmt
, 
¬gs
...è
	`ems_logg”_Œaû
(
	`logg”
(), fmt, ##¬gs)

	)

65 
	#ems_l_šfo
(
fmt
, 
¬gs
...è
	`ems_logg”_šfo
(
	`logg”
(), fmt, ##¬gs)

	)

66 
	#ems_l_w¬n
(
fmt
, 
¬gs
...è
	`ems_logg”_w¬n
(
	`logg”
(), fmt, ##¬gs)

	)

67 
	#ems_l_”rÜ
(
fmt
, 
¬gs
...è
	`ems_logg”_”rÜ
(
	`logg”
(), fmt, ##¬gs)

	)

68 
	#ems_l_çuÉ
(
fmt
, 
¬gs
...è
	`ems_logg”_çuÉ
(
	`logg”
(), fmt, ##¬gs)

	)

70 
	#ems_Œaûlše
(è
	`ems_l_Œaû
("fe: %s,†še: %u", 
__FILE__
, 
__LINE__
)

	)

	@src/utils/ems_md5.c

2 
	~<¡dio.h
>

3 
	~<¡dšt.h
>

5 
	~<¡d®ign.h
>

8 
	~<¡dšt.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

11 
	~<sys/ty³s.h
>

12 
	~"ems_md5.h
"

14 #ifdeà
_LIBC


15 
	~<’dŸn.h
>

16 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


17 
	#WORDS_BIGENDIAN
 1

	)

21 #ifdeà
WORDS_BIGENDIAN


22 
	#SWAP
(
n
) \

23 (((
n
è<< 24è| ((Òè& 0xff00è<< 8è| ((Òè>> 8è& 0xff00è| (Òè>> 24))

	)

25 
	#SWAP
(
n
èÒ)

	)

28 
	#BLOCKSIZE
 32768

	)

29 #ià
BLOCKSIZE
 % 64 != 0

33 
	smd5_ùx


35 
ušt32_t
 
	mA
;

36 
ušt32_t
 
	mB
;

37 
ušt32_t
 
	mC
;

38 
ušt32_t
 
	mD
;

40 
ušt32_t
 
	mtÙ®
[2];

41 
ušt32_t
 
	mbuæ’
;

42 
ušt32_t
 
	mbufãr
[32];

46 cÚ¡ 
	gflbuf
[64] = { 0x80, 0 };

49 
md5_´oûss_block
 (cÚ¡ *
bufãr
, 
size_t
 
Ën
, 
md5_ùx
 *
ùx
);

52 
md5_´oûss_by‹s
 (cÚ¡ *
bufãr
, 
size_t
 
Ën
, 
md5_ùx
 *
ùx
);

58 
	$md5_š™_ùx
 (
md5_ùx
 *
ùx
)

60 
ùx
->
A
 = 0x67452301;

61 
ùx
->
B
 = 0xefcdab89;

62 
ùx
->
C
 = 0x98badcfe;

63 
ùx
->
D
 = 0x10325476;

65 
ùx
->
tÙ®
[0] = ctx->total[1] = 0;

66 
ùx
->
buæ’
 = 0;

67 
	}
}

73 
	$£t_ušt32
 (*
ı
, 
ušt32_t
 
v
)

75 
	`memıy
 (
ı
, &
v
,  v);

76 
	}
}

81 
	$md5_»ad_ùx
 (cÚ¡ 
md5_ùx
 *
ùx
, *
»sbuf
)

83 *
r
 = 
»sbuf
;

84 
	`£t_ušt32
 (
r
 + 0 *  
ùx
->
A
, 
	`SWAP
 (ctx->A));

85 
	`£t_ušt32
 (
r
 + 1 *  
ùx
->
B
, 
	`SWAP
 (ctx->B));

86 
	`£t_ušt32
 (
r
 + 2 *  
ùx
->
C
, 
	`SWAP
 (ctx->C));

87 
	`£t_ušt32
 (
r
 + 3 *  
ùx
->
D
, 
	`SWAP
 (ctx->D));

89  
»sbuf
;

90 
	}
}

95 
	$md5_fšish_ùx
 (
md5_ùx
 *
ùx
, *
»sbuf
)

98 
ušt32_t
 
by‹s
 = 
ùx
->
buæ’
;

99 
size_t
 
size
 = (
by‹s
 < 56) ? 64 / 4 : 64 * 2 / 4;

102 
ùx
->
tÙ®
[0] +ğ
by‹s
;

103 ià(
ùx
->
tÙ®
[0] < 
by‹s
)

104 ++
ùx
->
tÙ®
[1];

107 
ùx
->
bufãr
[
size
 - 2] = 
	`SWAP
 (ùx->
tÙ®
[0] << 3);

108 
ùx
->
bufãr
[
size
 - 1] = 
	`SWAP
 ((ùx->
tÙ®
[1] << 3) | (ctx->total[0] >> 29));

110 
	`memıy
 (&((*è
ùx
->
bufãr
)[
by‹s
], 
flbuf
, (
size
 - 2) * 4 - bytes);

113 
	`md5_´oûss_block
 (
ùx
->
bufãr
, 
size
 * 4, ctx);

115  
	`md5_»ad_ùx
 (
ùx
, 
»sbuf
);

116 
	}
}

120 
	$md5_´oûss_by‹s
 (cÚ¡ *
bufãr
, 
size_t
 
Ën
, 
md5_ùx
 *
ùx
)

124 ià(
ùx
->
buæ’
 != 0)

126 
size_t
 
Ëá_ov”
 = 
ùx
->
buæ’
;

127 
size_t
 
add
 = 128 - 
Ëá_ov”
 > 
Ën
 ?†en : 128 -†eft_over;

129 
	`memıy
 (&((*è
ùx
->
bufãr
)[
Ëá_ov”
], bufãr, 
add
);

130 
ùx
->
buæ’
 +ğ
add
;

132 ià(
ùx
->
buæ’
 > 64)

134 
	`md5_´oûss_block
 (
ùx
->
bufãr
, ctx->
buæ’
 & ~63, ctx);

136 
ùx
->
buæ’
 &= 63;

138 
	`memıy
 (
ùx
->
bufãr
,

139 &((*è
ùx
->
bufãr
)[(
Ëá_ov”
 + 
add
) & ~63],

140 
ùx
->
buæ’
);

143 
bufãr
 = (cÚ¡ *èbufã¸+ 
add
;

144 
Ën
 -ğ
add
;

148 ià(
Ën
 >= 64)

150 #ià!
_STRING_ARCH_uÇligÃd


151 
	#UNALIGNED_P
(
p
è((
ušŒ_t
èÕè% 
	`®ignof
 (
ušt32_t
è!ğ0)

	)

152 ià(
	`UNALIGNED_P
 (
bufãr
))

153 
Ën
 > 64)

155 
	`md5_´oûss_block
 (
	`memıy
 (
ùx
->
bufãr
, buffer, 64), 64, ctx);

156 
bufãr
 = (const *) buffer + 64;

157 
Ën
 -= 64;

162 
	`md5_´oûss_block
 (
bufãr
, 
Ën
 & ~63, 
ùx
);

163 
bufãr
 = (cÚ¡ *èbufã¸+ (
Ën
 & ~63);

164 
Ën
 &= 63;

169 ià(
Ën
 > 0)

171 
size_t
 
Ëá_ov”
 = 
ùx
->
buæ’
;

173 
	`memıy
 (&((*è
ùx
->
bufãr
)[
Ëá_ov”
], bufãr, 
Ën
);

174 
Ëá_ov”
 +ğ
Ën
;

175 ià(
Ëá_ov”
 >= 64)

177 
	`md5_´oûss_block
 (
ùx
->
bufãr
, 64, ctx);

178 
Ëá_ov”
 -= 64;

179 
	`memıy
 (
ùx
->
bufãr
, &ùx->bufãr[16], 
Ëá_ov”
);

181 
ùx
->
buæ’
 = 
Ëá_ov”
;

183 
	}
}

190 
	#FF
(
b
, 
c
, 
d
è(d ^ (b & (ø^ d)))

	)

191 
	#FG
(
b
, 
c
, 
d
è
	`FF
 (d, b, c)

	)

192 
	#FH
(
b
, 
c
, 
d
è(b ^ c ^ d)

	)

193 
	#FI
(
b
, 
c
, 
d
è(ø^ (b | ~d))

	)

199 
	$md5_´oûss_block
 (cÚ¡ *
bufãr
, 
size_t
 
Ën
, 
md5_ùx
 *
ùx
)

201 
ušt32_t
 
cÜ»ù_wÜds
[16];

202 cÚ¡ 
ušt32_t
 *
wÜds
 = 
bufãr
;

203 
size_t
 
nwÜds
 = 
Ën
 /  (
ušt32_t
);

204 cÚ¡ 
ušt32_t
 *
’dp
 = 
wÜds
 + 
nwÜds
;

205 
ušt32_t
 
A
 = 
ùx
->A;

206 
ušt32_t
 
B
 = 
ùx
->B;

207 
ušt32_t
 
C
 = 
ùx
->C;

208 
ušt32_t
 
D
 = 
ùx
->D;

209 
ušt32_t
 
lŞ’
 = 
Ën
;

214 
ùx
->
tÙ®
[0] +ğ
lŞ’
;

215 
ùx
->
tÙ®
[1] +ğ(
Ën
 >> 31 >> 1è+ (ùx->tÙ®[0] < 
lŞ’
);

219 
wÜds
 < 
’dp
)

221 
ušt32_t
 *
cwp
 = 
cÜ»ù_wÜds
;

222 
ušt32_t
 
A_§ve
 = 
A
;

223 
ušt32_t
 
B_§ve
 = 
B
;

224 
ušt32_t
 
C_§ve
 = 
C
;

225 
ušt32_t
 
D_§ve
 = 
D
;

234 
	#OP
(
a
, 
b
, 
c
, 
d
, 
s
, 
T
) \

237 
a
 +ğ
	`FF
 (
b
, 
c
, 
d
è+ (*
cwp
++ = 
	`SWAP
 (*
wÜds
)è+ 
T
; \

238 ++
wÜds
; \

239 
	`CYCLIC
 (
a
, 
s
); \

240 
a
 +ğ
b
; \

242 0)

	)

246 
	#CYCLIC
(
w
, 
s
è(w = (w << sè| (w >> (32 - s)))

	)

259 
	`OP
 (
A
, 
B
, 
C
, 
D
, 7, 0xd76aa478);

260 
	`OP
 (
D
, 
A
, 
B
, 
C
, 12, 0xe8c7b756);

261 
	`OP
 (
C
, 
D
, 
A
, 
B
, 17, 0x242070db);

262 
	`OP
 (
B
, 
C
, 
D
, 
A
, 22, 0xc1bdceee);

263 
	`OP
 (
A
, 
B
, 
C
, 
D
, 7, 0xf57c0faf);

264 
	`OP
 (
D
, 
A
, 
B
, 
C
, 12, 0x4787c62a);

265 
	`OP
 (
C
, 
D
, 
A
, 
B
, 17, 0xa8304613);

266 
	`OP
 (
B
, 
C
, 
D
, 
A
, 22, 0xfd469501);

267 
	`OP
 (
A
, 
B
, 
C
, 
D
, 7, 0x698098d8);

268 
	`OP
 (
D
, 
A
, 
B
, 
C
, 12, 0x8b44f7af);

269 
	`OP
 (
C
, 
D
, 
A
, 
B
, 17, 0xffff5bb1);

270 
	`OP
 (
B
, 
C
, 
D
, 
A
, 22, 0x895cd7be);

271 
	`OP
 (
A
, 
B
, 
C
, 
D
, 7, 0x6b901122);

272 
	`OP
 (
D
, 
A
, 
B
, 
C
, 12, 0xfd987193);

273 
	`OP
 (
C
, 
D
, 
A
, 
B
, 17, 0xa679438e);

274 
	`OP
 (
B
, 
C
, 
D
, 
A
, 22, 0x49b40821);

279 #undeà
OP


280 
	#OP
(
f
, 
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
T
) \

283 
a
 +ğ
	`f
 (
b
, 
c
, 
d
è+ 
cÜ»ù_wÜds
[
k
] + 
T
; \

284 
	`CYCLIC
 (
a
, 
s
); \

285 
a
 +ğ
b
; \

287 0)

	)

290 
	`OP
 (
FG
, 
A
, 
B
, 
C
, 
D
, 1, 5, 0xf61e2562);

291 
	`OP
 (
FG
, 
D
, 
A
, 
B
, 
C
, 6, 9, 0xc040b340);

292 
	`OP
 (
FG
, 
C
, 
D
, 
A
, 
B
, 11, 14, 0x265e5a51);

293 
	`OP
 (
FG
, 
B
, 
C
, 
D
, 
A
, 0, 20, 0xe9b6c7aa);

294 
	`OP
 (
FG
, 
A
, 
B
, 
C
, 
D
, 5, 5, 0xd62f105d);

295 
	`OP
 (
FG
, 
D
, 
A
, 
B
, 
C
, 10, 9, 0x02441453);

296 
	`OP
 (
FG
, 
C
, 
D
, 
A
, 
B
, 15, 14, 0xd8a1e681);

297 
	`OP
 (
FG
, 
B
, 
C
, 
D
, 
A
, 4, 20, 0xe7d3fbc8);

298 
	`OP
 (
FG
, 
A
, 
B
, 
C
, 
D
, 9, 5, 0x21e1cde6);

299 
	`OP
 (
FG
, 
D
, 
A
, 
B
, 
C
, 14, 9, 0xc33707d6);

300 
	`OP
 (
FG
, 
C
, 
D
, 
A
, 
B
, 3, 14, 0xf4d50d87);

301 
	`OP
 (
FG
, 
B
, 
C
, 
D
, 
A
, 8, 20, 0x455a14ed);

302 
	`OP
 (
FG
, 
A
, 
B
, 
C
, 
D
, 13, 5, 0xa9e3e905);

303 
	`OP
 (
FG
, 
D
, 
A
, 
B
, 
C
, 2, 9, 0xfcefa3f8);

304 
	`OP
 (
FG
, 
C
, 
D
, 
A
, 
B
, 7, 14, 0x676f02d9);

305 
	`OP
 (
FG
, 
B
, 
C
, 
D
, 
A
, 12, 20, 0x8d2a4c8a);

308 
	`OP
 (
FH
, 
A
, 
B
, 
C
, 
D
, 5, 4, 0xfffa3942);

309 
	`OP
 (
FH
, 
D
, 
A
, 
B
, 
C
, 8, 11, 0x8771f681);

310 
	`OP
 (
FH
, 
C
, 
D
, 
A
, 
B
, 11, 16, 0x6d9d6122);

311 
	`OP
 (
FH
, 
B
, 
C
, 
D
, 
A
, 14, 23, 0xfde5380c);

312 
	`OP
 (
FH
, 
A
, 
B
, 
C
, 
D
, 1, 4, 0xa4beea44);

313 
	`OP
 (
FH
, 
D
, 
A
, 
B
, 
C
, 4, 11, 0x4bdecfa9);

314 
	`OP
 (
FH
, 
C
, 
D
, 
A
, 
B
, 7, 16, 0xf6bb4b60);

315 
	`OP
 (
FH
, 
B
, 
C
, 
D
, 
A
, 10, 23, 0xbebfbc70);

316 
	`OP
 (
FH
, 
A
, 
B
, 
C
, 
D
, 13, 4, 0x289b7ec6);

317 
	`OP
 (
FH
, 
D
, 
A
, 
B
, 
C
, 0, 11, 0xeaa127fa);

318 
	`OP
 (
FH
, 
C
, 
D
, 
A
, 
B
, 3, 16, 0xd4ef3085);

319 
	`OP
 (
FH
, 
B
, 
C
, 
D
, 
A
, 6, 23, 0x04881d05);

320 
	`OP
 (
FH
, 
A
, 
B
, 
C
, 
D
, 9, 4, 0xd9d4d039);

321 
	`OP
 (
FH
, 
D
, 
A
, 
B
, 
C
, 12, 11, 0xe6db99e5);

322 
	`OP
 (
FH
, 
C
, 
D
, 
A
, 
B
, 15, 16, 0x1fa27cf8);

323 
	`OP
 (
FH
, 
B
, 
C
, 
D
, 
A
, 2, 23, 0xc4ac5665);

326 
	`OP
 (
FI
, 
A
, 
B
, 
C
, 
D
, 0, 6, 0xf4292244);

327 
	`OP
 (
FI
, 
D
, 
A
, 
B
, 
C
, 7, 10, 0x432aff97);

328 
	`OP
 (
FI
, 
C
, 
D
, 
A
, 
B
, 14, 15, 0xab9423a7);

329 
	`OP
 (
FI
, 
B
, 
C
, 
D
, 
A
, 5, 21, 0xfc93a039);

330 
	`OP
 (
FI
, 
A
, 
B
, 
C
, 
D
, 12, 6, 0x655b59c3);

331 
	`OP
 (
FI
, 
D
, 
A
, 
B
, 
C
, 3, 10, 0x8f0ccc92);

332 
	`OP
 (
FI
, 
C
, 
D
, 
A
, 
B
, 10, 15, 0xffeff47d);

333 
	`OP
 (
FI
, 
B
, 
C
, 
D
, 
A
, 1, 21, 0x85845dd1);

334 
	`OP
 (
FI
, 
A
, 
B
, 
C
, 
D
, 8, 6, 0x6fa87e4f);

335 
	`OP
 (
FI
, 
D
, 
A
, 
B
, 
C
, 15, 10, 0xfe2ce6e0);

336 
	`OP
 (
FI
, 
C
, 
D
, 
A
, 
B
, 6, 15, 0xa3014314);

337 
	`OP
 (
FI
, 
B
, 
C
, 
D
, 
A
, 13, 21, 0x4e0811a1);

338 
	`OP
 (
FI
, 
A
, 
B
, 
C
, 
D
, 4, 6, 0xf7537e82);

339 
	`OP
 (
FI
, 
D
, 
A
, 
B
, 
C
, 11, 10, 0xbd3af235);

340 
	`OP
 (
FI
, 
C
, 
D
, 
A
, 
B
, 2, 15, 0x2ad7d2bb);

341 
	`OP
 (
FI
, 
B
, 
C
, 
D
, 
A
, 9, 21, 0xeb86d391);

344 
A
 +ğ
A_§ve
;

345 
B
 +ğ
B_§ve
;

346 
C
 +ğ
C_§ve
;

347 
D
 +ğ
D_§ve
;

351 
ùx
->
A
 = A;

352 
ùx
->
B
 = B;

353 
ùx
->
C
 = C;

354 
ùx
->
D
 = D;

355 
	}
}

362 
	$md5_¡»am
 (
FILE
 *
¡»am
, *
»sblock
)

364 
md5_ùx
 
ùx
;

365 
size_t
 
sum
;

367 *
bufãr
 = 
	`m®loc
 (
BLOCKSIZE
 + 72);

368 ià(!
bufãr
)

372 
	`md5_š™_ùx
 (&
ùx
);

380 
size_t
 
n
;

381 
sum
 = 0;

386 
n
 = 
	`ä—d
 (
bufãr
 + 
sum
, 1, 
BLOCKSIZE
 - sum, 
¡»am
);

388 
sum
 +ğ
n
;

390 ià(
sum
 =ğ
BLOCKSIZE
)

393 ià(
n
 == 0)

398 ià(
	`ã¼Ü
 (
¡»am
))

400 
	`ä“
 (
bufãr
);

403 
´oûss_·¹Ÿl_block
;

409 ià(
	`ãof
 (
¡»am
))

410 
´oûss_·¹Ÿl_block
;

416 
	`md5_´oûss_block
 (
bufãr
, 
BLOCKSIZE
, &
ùx
);

419 
´oûss_·¹Ÿl_block
:

422 ià(
sum
 > 0)

423 
	`md5_´oûss_by‹s
 (
bufãr
, 
sum
, &
ùx
);

426 
	`md5_fšish_ùx
 (&
ùx
, 
»sblock
);

427 
	`ä“
 (
bufãr
);

429 
	}
}

436 
	$md5_bufãr
 (cÚ¡ *
bufãr
, 
size_t
 
Ën
, *
»sblock
)

438 
md5_ùx
 
ùx
;

441 
	`md5_š™_ùx
 (&
ùx
);

444 
	`md5_´oûss_by‹s
 (
bufãr
, 
Ën
, &
ùx
);

447  
	`md5_fšish_ùx
 (&
ùx
, 
»sblock
);

448 
	}
}

450 
	$ems_md5_¡»am
 (
FILE
 *
¡»am
, *
»sblock
)

452  
	`md5_¡»am
(
¡»am
, 
»sblock
);

453 
	}
}

455 *
	$ems_md5_bufãr
 (cÚ¡ *
bufãr
, 
size_t
 
Ën
, *
»sblock
)

457  
	`md5_bufãr
(
bufãr
, 
Ën
, 
»sblock
);

458 
	}
}

461 
	$maš
()

463 #iâdeà
MD5_DIGEST_LENGTH


464 
	#MD5_DIGEST_LENGTH
 16

	)

466 
n
;

467 
buf
[512];

468 
ssize_t
 
by‹s
;

469 
out
[
MD5_DIGEST_LENGTH
];

472 
MD5_CTX
 
c
;

474 
	`MD5_In™
(&
c
);

476 
by‹s
=
	`»ad
(
STDIN_FILENO
, 
buf
, 512);

478 
by‹s
 > 0)

480 
	`MD5_Upd©e
(&
c
, 
buf
, 
by‹s
);

481 
by‹s
=
	`»ad
(
STDIN_FILENO
, 
buf
, 512);

484 
	`MD5_Fš®
(
out
, &
c
);

486 
	`md5_bufãr
("m´oÙ", 
	`¡¾’
("m´oÙ"), 
out
);

489 
n
=0;‚<
MD5_DIGEST_LENGTH
;‚++)

490 
	`´štf
("%02x", ()(0xfà& 
out
[
n
]));

493 
	}
}

	@src/utils/ems_md5.h

2 #iâdeà
EMS_MD5_HEADER_FOR_CRYPT____


3 
	#EMS_MD5_HEADER_FOR_CRYPT____


	)

7 #iâdeà
MD5_DIGEST_SIZE


8 
	#MD5_DIGEST_SIZE
 16

	)

11 #iâdeà
MD5_BLOCK_SIZE


12 
	#MD5_BLOCK_SIZE
 64

	)

15 
ems_md5_¡»am
 (
FILE
 *
¡»am
, *
»sblock
);

16 *
ems_md5_bufãr
 (cÚ¡ *
bufãr
, 
size_t
 
Ën
, *
»sblock
);

	@src/utils/ems_msg.c

2 #ifdeà
WIN32


3 
	~<wšsock2.h
>

4 
	~<ws2tı.h
>

5 
	~<P§pi.h
>

8 
	~"ems.h
"

11 #ifdeà
WIN32


12 #´agm¨
comm’t
(
lib
, "ws2_32.lib")

15 
	~"ems_maš.h
"

16 
	~"ems_msg.h
"

18 
ems_št
 
	$ems_sock_£nd
(
ems_sock
 *
sock
, 
ems_bufãr
 *
buf
)

20 
ems_ch¬
 *
p
;

21 
ems_št
 
Ëá
;

22 
ems_št
 
»t
;

23 
ems_št
 
fd
 = 
	`ems_sock_fd
(
sock
);

25 ià(
	`ems_sock_fd
(
sock
) <= 0)

26  
EMS_ERR
;

28 
p
 = 
	`buf_rd
(
buf
);

29 
Ëá
 = 
	`buf_Ën
(
buf
);

31 
Ëá
 > 0) {

32 
»t
 = 
	`£nd
(
fd
, 
p
, 
Ëá
, 0);

33 ià(
»t
 <= 0) {

34 
”ºo
) {

36 
EAGAIN
:

37 
EINTR
:

38 
	`ems_bufãr_£ek_rd
(
buf
, 
	`abs
(
p
-
	`buf_rd
(buf)), 
EMS_BUFFER_SEEK_CUR
);

39  -
EAGAIN
;

42 
	`ems_l_Œaû
("£ssiÚ[%d]£ndƒ¼Ü: %s", 
fd
, 
	`ems_Ï¡”rmsg
());

43 
	`ems_sock_şo£
(
sock
);

44  
EMS_ERR
;

49 
p
 +ğ
»t
;

50 
Ëá
 -ğ
»t
;

53 
»t
 = 
	`abs
(
p
 - 
	`buf_rd
(
buf
));

54 
	`ems_bufãr_£ek_rd
(
buf
, 
»t
, 
EMS_BUFFER_SEEK_CUR
);

56  
»t
;

57 
	}
}

59 
ems_št
 
	$ems_sock_»ad
(
ems_sock
 *
sock
, 
ems_bufãr
 *
buf
)

61 
ems_št
 
»t
;

62 
ems_št
 
fd
, 
Ëá
;

63 
ems_ch¬
 *
wr
 = 
	`buf_wr
(
buf
);

65 ià(
	`ems_sock_fd
(
sock
) <= 0)

66  
EMS_ERR
;

68 
	`ems_as£¹
(
	`buf_Ëá
(
buf
) > 0);

69 
fd
 = 
	`ems_sock_fd
(
sock
);

70 
Ëá
 = 
	`buf_Ëá
(
buf
);

72 
Ëá
 > 0) {

73 
»t
 = 
	`»cv
(
fd
, 
wr
, 
Ëá
, 0);

75 ià(
»t
 > 0) {

76 
wr
 +ğ
»t
;

77 
Ëá
 -ğ
»t
;

78 } ià(
»t
 == 0) {

79 
	`ems_bufãr_£ek_wr
(
buf
, 
	`abs
(
wr
-
	`buf_wr
(buf)), 
EMS_BUFFER_SEEK_CUR
);

80 
	`ems_l_Œaû
("£ssiÚ[%d] down", 
fd
);

83 
”ºo
) {

85 
EAGAIN
:

86 
EINTR
:

87 
	`ems_bufãr_£ek_wr
(
buf
, 
	`abs
(
wr
-
	`buf_wr
(buf)), 
EMS_BUFFER_SEEK_CUR
);

88  -
EAGAIN
;

91 
	`ems_sock_şo£
(
sock
);

92 
	`ems_l_Œaû
("£ssiÚ[%d]»cvƒ¼Ü %s", 
fd
, 
	`ems_Ï¡”rmsg
());

93  
»t
;

100 
»t
 = 
	`abs
(
wr
 - 
	`buf_wr
(
buf
));

101 
	`ems_bufãr_£ek_wr
(
buf
, 
»t
, 
EMS_BUFFER_SEEK_CUR
);

103  
»t
;

104 
	}
}

107 
ems_void
 
	$ems_´šthex
(
ems_cch¬
 *
s
, 
ems_št
 
Ën
)

109 
ems_št
 
n
, 
»t
;

110 
ems_ch¬
 
buf
[64], *
p
;

112 
n
 = 16;

113 
p
 = 
buf
;

114 
Ën
 > 0) {

116 iàĞ
n
 == 0 ) {

117 
	`ems_l_Œaû
("%s", 
buf
);

118 
n
 = 16;

119 
p
 = 
buf
;

123 ià(
n
 == 8)

124 
»t
 = 
	`¢´štf
(
p
, 64, " %02x", *
s
 & 0xff);

126 
»t
 = 
	`¢´štf
(
p
, 64, " %02x", *
s
 & 0xff);

128 
n
--;

129 
p
 +ğ
»t
;

130 
s
++;

131 
Ën
 --;

134 
	`ems_l_Œaû
("%s", 
buf
);

135 
	}
}

138 
ems_št
 
	$ems_·ck_»q
(
ems_ušt
 
g
, 
ems_cch¬
 *
ùx
, 
ems_št
 
Ën
, 
ems_bufãr
 *
buf
)

140 
ems_ušt
 
tÙ®
;

141 
ems_»que¡
 *
»q
;

142 
ems_ch¬
 *
p
;

144 ià(
Ën
 + 
SIZE_REQUEST
 > 
	`buf_Ëá
(
buf
)) {

145 
	`ems_as£¹
(
Ën
 < 2 * 
EMS_BUFFER_16k
 * 64);

146 ià(
	`ems_bufãr_šü—£
(
buf
, 
Ën
 + 
SIZE_REQUEST
è=ğ
EMS_ERR
)

147  
EMS_ERR
;

150 
»q
 = (
ems_»que¡
 *)
	`buf_wr
(
buf
);

151 
p
 = (
ems_ch¬
 *è(
	`buf_wr
(
buf
è+ 
SIZE_REQUEST
);

153 ià(
ùx
)

154 
	`putmem
(
p
, 
ùx
, 
Ën
);

156 
tÙ®
 = 
	`abs
(
p
 - 
	`buf_wr
(
buf
));

157 
	`ems_bufãr_£ek_wr
(
buf
, 
tÙ®
, 
EMS_BUFFER_SEEK_CUR
);

159 
»q
->
g
.
v®
 = 
	`Áohl
(tag);

160 
»q
->
Ën
 = 
	`Áohl
(
tÙ®
);

162  
EMS_OK
;

163 
	}
}

165 
ems_št
 
	$ems_·ck_r¥
(
ems_ušt
 
g
, 
ems_št
 
¡
, 
ems_cch¬
 *
ùx
,ƒms_šˆ
Ën
, 
ems_bufãr
 *
buf
)

167 
ems_št
 
tÙ®
;

168 
ems_»¥Ú£
 *
r¥
;

169 
ems_ch¬
 *
p
;

171 ià((
Ën
 + 
SIZE_RESPONSE
è> 
	`buf_Ëá
(
buf
)) {

172 
	`ems_as£¹
(
Ën
 < 2 * 
EMS_BUFFER_16k
 * 64);

173 ià(
	`ems_bufãr_šü—£
(
buf
, 
Ën
 + 
SIZE_RESPONSE
è=ğ
EMS_ERR
)

174  
EMS_ERR
;

177 
r¥
 = (
ems_»¥Ú£
 *)
	`buf_wr
(
buf
);

178 
p
 = (
ems_ch¬
 *è(
	`buf_wr
(
buf
è+ 
SIZE_RESPONSE
);

180 ià(
ùx
)

181 
	`putmem
(
p
, 
ùx
, 
Ën
);

183 
tÙ®
 = 
	`abs
(
p
 - 
	`buf_wr
(
buf
));

184 
	`ems_bufãr_£ek_wr
(
buf
, 
tÙ®
, 
EMS_BUFFER_SEEK_CUR
);

186 
r¥
->
g
.
v®
 = 
	`Áohl
(tag | 0x80000000);

187 
r¥
->
Ën
 = 
	`Áohl
(
tÙ®
);

188 
r¥
->
¡
 = 
	`Áohl
(st);

190  
EMS_OK
;

191 
	}
}

194 
ems_št
 
	$ems_g‘ho¡byÇme
(
ems_cch¬
 *
domaš
, 
sockaddr_š
 *
d¡
)

196 
ho¡’t
 *
»mÙe
;

197 
š_addr
 
addr
;

199 
	`ems_as£¹
(
domaš
 && 
d¡
);

201 
»mÙe
 = 
	`g‘ho¡byÇme
(
domaš
);

202 ià(!
»mÙe
 && !
	`i§Íha
(
domaš
[0])) {

203 
addr
.
s_addr
 = 
	`š‘_addr
(
domaš
);

204 ià(
addr
.
s_addr
 !ğ
INADDR_NONE
)

205 
»mÙe
 = 
	`g‘ho¡byaddr
((*è&
addr
, 4, 
AF_INET
);

208 ià(!
»mÙe
)

209  
ERR
;

211 
d¡
->
sš_addr
.
s_addr
 = *(
u_lÚg
 *è
»mÙe
->
h_addr_li¡
[0];

212 
	`memıy
(&
d¡
->
sš_addr
, 
»mÙe
->
h_addr
,„emÙe->
h_Ëngth
);

214  
OK
;

215 
	}
}

217 #ifdeà
WIN32


218 
ems_št
 
	$ems_£ŠÚblockšg
(
ems_št
 
sockfd
,ƒms_šˆ
yes
)

220 
ems_ulÚg
 
İts
 = 1;

222 ià(!
yes
)

223 
İts
 = 0;

225 ià(
SOCKET_ERROR
 =ğ
	`ioùlsock‘
(
sockfd
, 
FIONBIO
, (
ems_ulÚg
 *)&
İts
))

226  
ERR
;

228  
OK
;

229 
	}
}

231 
ems_št
 
	$ems_£ŠÚblockšg
(
ems_št
 
sockfd
,ƒms_šˆ
yes
)

233 
İts
;

235 
İts
 = 
	`fú
(
sockfd
, 
F_GETFL
);

237 
İts
 = (İt | 
O_NONBLOCK
);

238 iàĞ!
yes
 )

239 
İts
 = (İt ^ 
O_NONBLOCK
);

241 ià(
	`fú
(
sockfd
, 
F_SETFL
,
İts
) < 0)

242  
ERR
;

244  
OK
;

245 
	}
}

255 
ems_št
 
	$ems_£tsock_rw_timeout
(
ems_št
 
sockfd
,ƒms_šˆ
m£cs
)

257 #ifdeà
WIN32


258 
ems_št
 
to
 = 
m£cs
;

259 
	`£tsockİt
(
sockfd
, 
SOL_SOCKET
, 
SO_SNDTIMEO
, (
ems_ch¬
*)&
to
, (to));

260 
	`£tsockİt
(
sockfd
, 
SOL_SOCKET
, 
SO_RCVTIMEO
, (
ems_ch¬
*)&
to
, (to));

262 
timev®
 
to
 = {
m£cs
/1000, 0};

264 
	`£tsockİt
(
sockfd
, 
SOL_SOCKET
, 
SO_SNDTIMEO
, &
to
, (to));

265 
	`£tsockİt
(
sockfd
, 
SOL_SOCKET
, 
SO_RCVTIMEO
, &
to
, (to));

268  
OK
;

269 
	}
}

272 
ems_cch¬
 *
	$ems_public_addr
()

274 
sockaddr_š
 
£rv
;

275 
sockaddr_š
 
Çme
;

276 
ems_ch¬
 
bufãr
[100];

277 
sockËn_t
 
Çm–’
;

279 
ems_cch¬
 *
googË_dns_£rv”
 = "8.8.8.8";

280 
ems_št
 
googË_dns_pÜt
 = 53;

281 
ems_št
 
sock
;

283 
sock
 = 
	`sock‘
 (
AF_INET
, 
SOCK_DGRAM
, 0);

285 
	`mem£t
Ğ&
£rv
, 0, (serv) );

286 
£rv
.
sš_çmy
 = 
AF_INET
;

287 
£rv
.
sš_addr
.
s_addr
 = 
	`š‘_addr
Ğ
googË_dns_£rv”
 );

288 
£rv
.
sš_pÜt
 = 
	`htÚs
(
googË_dns_pÜt
);

290 ià(
	`cÚÃù
(
sock
, (
sockaddr
*è&
£rv
, (serv)) == -1) {

291 
	`şo£
(
sock
);

292  
NULL
;

295 
Çm–’
 = (
Çme
);

296 
	`g‘sockÇme
(
sock
, (
sockaddr
*è&
Çme
, &
Çm–’
);

298 
	`mem£t
(
bufãr
, 0, (buffer));

299 
	`š‘_Áİ
(
AF_INET
, &
Çme
.
sš_addr
, 
bufãr
, 100);

301 
	`şo£
(
sock
);

303  
bufãr
;

304 
	}
}

306 
ems_št


307 
	$ems_sock_£tİt_bšd
(
ems_št
 
fd
)

309 
ems_št
 
Ú
;

310 
lšg”
 
so_lšg”
;

312 
Ú
 = 1;

313 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (
ems_cch¬
 *)&
Ú
, (on));

315 
so_lšg”
.
l_Úoff
 = 1;

316 
so_lšg”
.
l_lšg”
 = 30;

317 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_LINGER
, (
ems_cch¬
 *)&
so_lšg”
, (so_linger));

319  
EMS_OK
;

320 
	}
}

323 
ems_št
 
	$ems_sock_be_£rv”
(
ems_sock
 *
sock
)

325 
ems_št
 
»t
;

326 
ems_št
 
fd
;

327 
sockaddr_š
 
addr
;

329 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0);

330 ià(
fd
 <= 0)

331  
EMS_ERR
;

333 
	`ems_sock_£tİt_bšd
(
fd
);

335 
	`mem£t
(&
addr
, 0, (addr));

336 
addr
.
sš_çmy
 = 
AF_INET
;

337 
addr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
	`ems_sock_addr
(
sock
));

338 
addr
.
sš_pÜt
 = 
	`htÚs
(()
	`ems_sock_pÜt
(
sock
));

340 
»t
 = 
	`bšd
(
fd
, (
sockaddr
 *)&
addr
, (sockaddr));

342 ià(
»t
 == -1) {

343 
	`ems_l_w¬n
("[bšd]bšdƒ¼Ü:%d, %s", 
»t
, 
	`ems_Ï¡”rmsg
());

344 
	`şo£
(
fd
);

345  
EMS_ERR
;

348 ià(
	`li¡’
(
fd
, 
SOMAXCONN
)) {

349 
	`ems_l_w¬n
("[bšd]li¡’ƒ¼Ü: %s", 
	`ems_Ï¡”rmsg
());

350 
	`şo£
(
fd
);

351  
EMS_ERR
;

354 
	`ems_sock_£tfd
(
sock
, 
fd
);

356 
	`ems_l_Œaû
("[bind] socket: %d bind @address %s:%d„eady",

357 
	`ems_sock_fd
(
sock
),

358 
	`ems_sock_addr
(
sock
),

359 
	`ems_sock_pÜt
(
sock
));

360  
EMS_OK
;

361 
	}
}

	@src/utils/ems_msg.h

2 #iâdeà
EMS_MSG_HEADER___


3 
	#EMS_MSG_HEADER___


	)

6 
	#ERR_EVT_BASE
 0x0100

	)

7 
	#ERR_EVT_NOT_FOUND_DRIVER
 (
ERR_EVT_BASE
 + 0x01)

	)

10 
	#EMS_WEB_TICKET_TIMEOUT
 120000

	)

11 
	#EMS_AC_TICKET_TIMEOUT
 120000

	)

13 
	#EMS_SYNC_TIMEOUT_AAA_HB
 60000

	)

14 
	#EMS_SYNC_TIMEOUT_LOGIC_HB
 5000

	)

17 
	#MSG_ST_BASE_ERR
 -0x0000

	)

18 
	#MSG_ST_ERR
 -0x0001

	)

19 
	#MSG_ST_UPDATING
 -0x0002

	)

20 
	#MSG_ST_MEM_ERR
 -0x0003

	)

21 
	#MSG_ST_DB_ERR
 -0x0004

	)

22 
	#MSG_ST_CANNOT_CONNECT_TO_AAA
 -0x0005

	)

23 
	#MSG_ST_INVALID_ARG
 -0x0006

	)

24 
	#MSG_ST_TICKET_INVALID
 -0x0007

	)

25 
	#MSG_ST_MSG_UNKNOWN
 -0x0008

	)

26 
	#MSG_ST_USER_OR_PASSWORD_ERROR
 -0x0009

	)

27 
	#MSG_ST_PERMIT_DENIED
 -0x000a

	)

28 
	#MSG_ST_VERIFY_TIMEOUT
 -0x000b

	)

29 
	#MSG_ST_VERIFY_ERROR
 -0x000c

	)

32 
	#MSG_ST_GRP_ERR
 -0x0100

	)

33 
	#MSG_ST_GRP_NOT_FOUND
 -0x0101

	)

34 
	#MSG_ST_GRP_DUP
 -0x0102

	)

35 
	#MSG_ST_GRP_GRP_NOT_NULL
 -0x0103

	)

36 
	#MSG_ST_GRP_AC_NOT_NULL
 -0x0104

	)

37 
	#MSG_ST_GRP_ACTIVE_CODE_NOT_NULL
 -0x0105

	)

38 
	#MSG_ST_GRP_APP_NOT_NULL
 -0x0106

	)

39 
	#MSG_ST_GRP_PROP_NOT_NULL
 -0x0107

	)

41 
	#MSG_ST_AC_ERR
 -0x0200

	)

42 
	#MSG_ST_AC_NOT_FOUND
 -0x0201

	)

43 
	#MSG_ST_AC_MAC_ERROR
 -0x0202

	)

45 
	#MSG_ST_ACTV_ERR
 -0x0300

	)

46 
	#MSG_ST_ACTV_TOO_MUCH
 -0x0301

	)

47 
	#MSG_ST_ACTV_NOT_FOUND
 -0x0302

	)

49 
	#MSG_ST_APP_ERR
 -0x0400

	)

50 
	#MSG_ST_APP_NOT_FOUND
 -0x0401

	)

51 
	#MSG_ST_APP_TYPE_ERROR
 -0x0402

	)

52 
	#MSG_ST_APP_DUP_NICK
 -0x0403

	)

53 
	#MSG_ST_APP_GRP_NOT_NULL
 -0x0404

	)

54 
	#MSG_ST_APP_AC_NOT_NULL
 -0x0405

	)

55 
	#MSG_ST_APP_FILE_MISS
 -0x0406

	)

56 
	#MSG_ST_APP_FILE_COULD_NOT_OPEN
 -0x0407

	)

58 
	#MSG_ST_PROP_ERR
 -0x0500

	)

59 
	#MSG_ST_PROP_NOT_FOUND
 -0x0501

	)

60 
	#MSG_ST_PROP_DUP_NICK
 -0x0502

	)

61 
	#MSG_ST_PROP_GRP_NOT_NULL
 -0x0503

	)

62 
	#MSG_ST_PROP_AC_NOT_NULL
 -0x0504

	)

69 
	#AC_MSG_BASE
 0x0000

	)

70 
	#AC_MSG_REGISTER
 0x0001

	)

71 
	#AC_MSG_LOGOUT
 0x0002

	)

72 
	#AC_MSG_TRYUSING
 0x0003

	)

73 
	#AC_MSG_HB
 0x0004

	)

74 
	#AC_MSG_APPLIST
 0x0005

	)

75 
	#AC_MSG_DOWNLOAD
 0x0006

	)

78 
ems_št
 
ems_sock_£nd
(
ems_sock
 *, 
ems_bufãr
 *
buf
);

79 
ems_št
 
ems_sock_»ad
(
ems_sock
 *, 
ems_bufãr
 *
buf
);

80 
ems_št
 
ems_·ck_r¥
(
ems_ušt
 
g
,ƒms_šˆ
¡
, 
ems_cch¬
 *
ùx
,ƒms_šˆ
Ën
, 
ems_bufãr
 *
buf
);

81 
ems_št
 
ems_·ck_»q
(
ems_ušt
 
g
, 
ems_cch¬
 *
ùx
,ƒms_šˆ
Ën
, 
ems_bufãr
 *
buf
);

82 
ems_št
 
ems_sock_be_£rv”
(
ems_sock
 *
sock
);;

83 
ems_št
 
ems_£tsock_rw_timeout
Óms_šˆ
sockfd
,ƒms_šˆ
m£cs
);

	@src/utils/ems_session.c

2 
	~"ems_maš.h
"

3 
	~"ems_£ssiÚ.h
"

9 
ems_št
 
	$ems_£ssiÚ_š™
(
ems_£ssiÚ
 *
£ss
)

11 
	`ems_as£¹
(
£ss
 && "never show uphis†ine");

13 
	`mem£t
(
£ss
, 0, (
ems_£ssiÚ
));

15 
	`ems_sock_š™
(&
£ss
->
sock
);

16 
£ss
->
obj
 = 
NULL
;

17 
£ss
->
r¤v
 = 
NULL
;

19 
	`ems_bufãr_š™
(&
£ss
->
buf_š
, 
EMS_BUFFER_1K
);

20 
	`ems_bufãr_š™
(&
£ss
->
buf_out
, 
EMS_BUFFER_1K
);

22 
	`ems_timeout_š™
(&
£ss
->
to
);

23 
	`ems_ev’t_fd_š™
(&
£ss
->
evt
);

25 
	`ems_queue_š™
(&
£ss
->
’Œy
);

27 
£ss
->
evt_cb
 = 
NULL
;

28 
£ss
->
timeout_cb
 = 
NULL
;

29 
£ss
->
cb¬g
 = 
NULL
;

31  
EMS_OK
;

32 
	}
}

34 
ems_void
 
	$ems_£ssiÚ_unš™
(
ems_£ssiÚ
 *
£ss
)

36 
	`ems_as£¹
(
£ss
 && "never show uphis†ine");

38 
	`ems_sock_ş—r
(&
£ss
->
sock
);

39 
£ss
->
r¤v
 = 
NULL
;

41 
	`ems_bufãr_unš™
(&
£ss
->
buf_š
);

42 
	`ems_bufãr_unš™
(&
£ss
->
buf_out
);

44 #ifdeà
DEBUG


45 
	`ems_as£¹
(!
£ss
->
to
.
³ndšg
 && !£ss->
evt
.
»g
);

47 ià(
£ss
->
to
.
³ndšg
)

48 
	`ems_l_w¬n
("session'simer did‚ot cancel... seg fault");

50 ià(
£ss
->
evt
.
»g
)

51 
	`ems_l_w¬n
("session'sƒvent did‚ot cancel... seg fault");

53 
£ss
->
evt_cb
 = 
NULL
;

54 
£ss
->
timeout_cb
 = 
NULL
;

55 
£ss
->
cb¬g
 = 
NULL
;

56 
	}
}

58 
ems_£ssiÚ
 *
	$ems_£ssiÚ_Ãw
()

60 
ems_£ssiÚ
 *
£ss
 = 
NULL
;

62 
£ss
 = (
ems_£ssiÚ
 *)
	`ems_m®loc
((ems_session));

63 ià(
£ss
)

64 
	`ems_£ssiÚ_š™
(
£ss
);

66  
£ss
;

67 
	}
}

70 
ems_void
 
	$ems_£ssiÚ_de¡roy
(
ems_£ssiÚ
 *
£ss
)

72 
	`ems_£ssiÚ_unš™
(
£ss
);

73 
	`ems_ä“
(
£ss
);

74 
	}
}

76 
ems_št
 
	$ems_£ssiÚ_shutdown_ªd_de¡roy
(
ems_£ssiÚ
 *
£ss
)

78 
	`ems_as£¹
(
£ss
);

80 
	`ems_l_Œaû
("session(%d) [%s: %d] down",

81 
	`ems_sock_fd
(&
£ss
->
sock
),

82 
	`ems_sock_addr
(&
£ss
->
sock
),

83 
	`ems_sock_pÜt
(&
£ss
->
sock
));

85 
	`£ss_ev’t_ÿnûl
(
£ss
);

86 
	`£ss_timeout_ÿnûl
(
£ss
);

87 
	`ems_sock_şo£
(&
£ss
->
sock
);

89 
	`ems_£ssiÚ_de¡roy
(
£ss
);

90  
EMS_OK
;

91 
	}
}

93 
ems_void
 
	$£ss_ev’t
(
ems_ev’t_fd
 *
ev’t
, 
ems_št
 
æg
)

95 
ems_£ssiÚ
 *
£ss
 = 
	`ems_cÚš”_of
(
ev’t
,ƒms_£ssiÚ, 
evt
);

96 
	`ems_as£¹
(
£ss
->
evt_cb
);

97 
£ss
->
	`evt_cb
(£ss, 
ev’t
->
”rÜ
, 
æg
);

98 
	}
}

100 
ems_void
 
	$£ss_timeout
(
ems_timeout
 *
timeout
)

102 
ems_£ssiÚ
 *
£ss
 = 
	`ems_cÚš”_of
(
timeout
,ƒms_£ssiÚ, 
to
);

103 
	`ems_as£¹
(
£ss
->
timeout_cb
);

104 
£ss
->
	`timeout_cb
(£ss, 
timeout
);

105 
	}
}

	@src/utils/ems_session.h

2 #iâdeà
EMS_SESSION_HEADER___


3 
	#EMS_SESSION_HEADER___


	)

6 
_ems_£ssiÚ_s
 
	tems_£ssiÚ
;

8 
	$ems_void
 (*
	t£ss_evt_cb
)(
	tems_£ssiÚ
 *
	t£ss
, 
	tems_št
 
	t¡
,ƒms_šˆ
	tægs
);

9 
	$ems_void
 (*
	t£ss_timeout_cb
)(
	tems_£ssiÚ
 *
	t£ss
, 
	tems_timeout
 *
	tto
);

12 
	s_ems_£ssiÚ_s


14 
ems_sock
 
sock
;

15 
ems_void
 *
obj
;

16 
ems_void
 *
r¤v
;

17 
ems_ušt
 
æg
;

19 
ems_bufãr
 
buf_š
;

20 
ems_bufãr
 
buf_out
;

21 
	#buf
 
buf_out


	)

23 
ems_timeout
 
to
;

24 
ems_ev’t_fd
 
evt
;

26 
ems_queue
 
’Œy
;

29 
£ss_evt_cb
 
evt_cb
;

30 
£ss_timeout_cb
 
timeout_cb
;

31 
ems_uch¬
 *
cb¬g
;

40 
ems_št
 
	`ems_£ssiÚ_š™
(
ems_£ssiÚ
 *
£ss
);

41 
ems_void
 
	`ems_£ssiÚ_unš™
(
ems_£ssiÚ
 *
£ss
);

42 
ems_£ssiÚ
 *
	`ems_£ssiÚ_Ãw
();

43 
ems_void
 
	`ems_£ssiÚ_de¡roy
(
ems_£ssiÚ
 *
£ss
);

44 
ems_št
 
	`ems_£ssiÚ_shutdown_ªd_de¡roy
(
ems_£ssiÚ
 *
£ss
);

46 
ems_void
 
	`£ss_ev’t
(
ems_ev’t_fd
 *
ev’t
, 
ems_št
 
æg
);

47 
ems_void
 
	`£ss_timeout
(
ems_timeout
 *
timeout
);

49 
	#£ss_ev’t_£t
(
£ss
, 
æg
, 
cb
) do {\

50 (
£ss
)->
evt_cb
 = 
cb
; \

51 (
£ss
)->
evt
.
fd
 = 
	`ems_sock_fd
(&(£ss)->
sock
); \

52 
	`ems_ev’t_add
(
	`ev’‹r
(), &(
£ss
)->
evt
, 
æg
|
EMS_EVT_EDGE_TRIGGER
, 
£ss_ev’t
); \

53 
	}

	`}whe
(0)

	)

55 
	#£ss_ev’t_ÿnûl
(
£ss
) \

56 
	`ems_ev’t_d–
(
	`ev’‹r
(), &(
£ss
)->
evt
)

	)

58 
	#£ss_timeout_£t_ex
(
£ss
, 
m£cs
, 
cb
, 
pos
) \

60 (
£ss
)->
timeout_cb
 = 
cb
; \

61 
	`ems_timeout_£t
(
	`timeou‹r
(), &(
£ss
)->
to
, 
m£cs
, 
£ss_timeout
, 
pos
); \

62 } 0)

	)

64 
	#£ss_timeout_£t
(
£ss
, 
m£cs
, 
cb
) \

65 
	`£ss_timeout_£t_ex
((
£ss
), 
m£cs
, 
cb
, 
EMS_TIMEOUT_TAIL
)

	)

67 
	#£ss_timeout_£t_sÜ‹d
(
£ss
, 
m£cs
, 
cb
) \

68 
	`£ss_timeout_£t_ex
((
£ss
), 
m£cs
, 
cb
, 
EMS_TIMEOUT_SORT
)

	)

70 
	#£ss_timeout_ÿnûl
(
£ss
è
	`ems_timeout_ÿnûl
(&(£ss)->
to
)

	)

72 
	#£ss_cb¬g_£t
(
£ss
, 
¬g
è((£ss)->
cb¬g
 = (
ems_uch¬
 *)×rg))

	)

73 
	#£ss_cb¬g
(
£ss
è((£ss)->
cb¬g
)

	)

77 #ifdeà
DEBUG


78 
	#EMS_SESSION_ACCEPTED_TIMEOUT
 10000

	)

79 
	#EMS_SESSION_NORMAL_TIMEOUT
 10000

	)

81 
	#EMS_SESSION_ACCEPTED_TIMEOUT
 5000

	)

82 
	#EMS_SESSION_NORMAL_TIMEOUT
 5000

	)

85 
	#£ss_»cv
(
£ss
, 
buf
è
	`ems_sock_»ad
(&(£ss)->
sock
, buf)

	)

86 
	#£ss_£nd
(
£ss
, 
buf
è
	`ems_sock_£nd
(&(£ss)->
sock
, buf)

	)

88 
	#£ss_³”
(
£ss
è(
ems_£ssiÚ
 *)((£ss)->
r¤v
)

	)

89 
	#£ss_³”_£t
(
£lf
, 
£ss
è((£lf)->
r¤v
=(
ems_void
 *)(£ss))

	)

91 
	#£ss_·»Á
(
£ss
, 
ty³
èÑy³ *)((£ss)->
obj
)

	)

92 
	#£ss_·»Á_£t
(
£ss
, 
·»Á
è((£ss)->
obj
 = (
ems_void
 *)Õ¬’t))

	)

94 
	#SESSION_FLAG_DIE_AFTER_SEND
 (0x01 << 30)

	)

96 
	#£ss_»¥Ú£_£t
(
£ss
, 
r¥
è((£ss)->
r¤v
 = (
ems_void
 *)Ô¥))

	)

97 
	#£ss_»¥Ú£
(
£ss
è((£ss)->
r¤v
)

	)

99 
	#£ss_»que¡_£t
 
£ss_»¥Ú£_£t


	)

100 
	#£ss_»que¡
 
£ss_»¥Ú£


	)

	@src/utils/ems_sock.c

2 
	~"ems_commÚ.h
"

3 
	~"ems_bufãr.h
"

4 
	~"ems_sock.h
"

6 
ems_št
 
	$ems_sock_š™
(
ems_sock
 *
s
)

8 
	`mem£t
(
s
, 0, (
ems_sock
));

9 
	`¡r_š™
(&
s
->
addr
);

10  
EMS_OK
;

11 
	}
}

13 
ems_void
 
	$ems_sock_ş—r
(
ems_sock
 *
s
)

15 
	`ems_as£¹
(
s
 !ğ
NULL
);

17 
	`¡r_ş—r
(&
s
->
addr
);

18 
	`ems_sock_š™
(
s
);

19 
	}
}

21 
ems_št
 
	$ems_sock_£ddr
(
ems_sock
 *
s
, 
ems_cch¬
 *
addr
)

23 
	`ems_as£¹
(
s
 !ğ
NULL
);

24 
	`¡r_£t
(&
s
->
addr
,‡ddr);

25  
EMS_OK
;

26 
	}
}

28 
ems_št
 
	$ems_sock_£Üt
(
ems_sock
 *
s
, 
ems_št
 
pÜt
)

30 
	`ems_as£¹
(
s
 !ğ
NULL
);

32 
s
->
pÜt
 =…ort;

34  
pÜt
;

35 
	}
}

37 
ems_št
 
	$ems_sock_£tfd
(
ems_sock
 *
s
, 
ems_št
 
fd
)

39 
	`ems_as£¹
(
s
 !ğ
NULL
);

41 
s
->
fd
 = fd;

43  
fd
;

44 
	}
}

46 
ems_cch¬
 *
	$ems_sock_addr
(
ems_sock
 *
s
)

48  
	`¡r_‹xt
(&
s
->
addr
);

49 
	}
}

51 
ems_št
 
	$ems_sock_pÜt
(
ems_sock
 *
s
)

53  
s
->
pÜt
;

54 
	}
}

56 
ems_št
 
	$ems_sock_fd
(
ems_sock
 *
s
)

58  
s
->
fd
;

59 
	}
}

61 
ems_št
 
	$ems_sock_şo£
(
ems_sock
 *
s
)

63 ià(
s
->
fd
 > 0) {

64 
	`şo£
(
s
->
fd
);

65 
s
->
fd
 = 0;

68  
EMS_OK
;

69 
	}
}

	@src/utils/ems_sock.h

2 #iâdeà
EMS_SOCK_ADDR_HEADER___


3 
	#EMS_SOCK_ADDR_HEADER___


	)

5 
_ems_sock_s
 
	tems_sock
;

6 
	s_ems_sock_s
 {

7 
ems_¡r
 
	maddr
;

8 
ems_št
 
	mpÜt
;

9 
ems_št
 
	mfd
;

12 
ems_št
 
ems_sock_š™
(
ems_sock
 *
s
);

13 
ems_void
 
ems_sock_ş—r
(
ems_sock
 *
s
);

15 
ems_št
 
ems_sock_£ddr
(
ems_sock
 *
s
, 
ems_cch¬
 *
addr
);

16 
ems_št
 
ems_sock_£Üt
(
ems_sock
 *
s
,ƒms_šˆ
pÜt
);

17 
ems_št
 
ems_sock_£tfd
(
ems_sock
 *
s
,ƒms_šˆ
fd
);

19 
ems_cch¬
 *
ems_sock_addr
(
ems_sock
 *);

20 
ems_št
 
ems_sock_pÜt
(
ems_sock
 *);

21 
ems_št
 
ems_sock_fd
(
ems_sock
 *);

23 
ems_št
 
ems_sock_şo£
(
ems_sock
 *);

25 
	#ems_sock_»£t
 
ems_sock_ş—r


	)

	@src/utils/ems_str.c

2 
	~"ems.h
"

4 
ems_št
 
	$¡r_£t
(
ems_¡r
 *
¡r
, 
ems_cch¬
 *
‹xt
)

6 ià(
¡r
) {

7 ià(
¡r
->
d©a
)

8 
	`ems_ä“
(
¡r
->
d©a
);

10 ià(
‹xt
) {

11 
¡r
->
Ën
 = 
	`¡¾’
(
‹xt
);

12 
¡r
->
d©a
 = (
ems_uch¬
*)
	`ems_¡rdup
(
‹xt
);

14 
¡r
->
Ën
 = 0;

15 
¡r
->
d©a
 = 
NULL
;

19  
OK
;

20 
	}
}

22 
ems_void
 
	$¡r_ş—r
(
ems_¡r
 *
¡r
)

24 
	`¡r_£t
(
¡r
, 
NULL
);

25 
	}
}

	@src/utils/ems_timer.c

2 
	~"ems_commÚ.h
"

3 
	~"ems_tim”.h
"

5 
ems_št
 
	$ems_time_diff
(
timev®
 *
t1
, timev® *
t2
)

8 (
t1
->
tv_£c
 - 
t2
->tv_sec) * 1000 +

9 (
t1
->
tv_u£c
 - 
t2
->tv_usec) / 1000;

10 
	}
}

12 
ems_št


13 
	$ems_timeout_add
(
ems_queue
 *
timeout
, 
ems_timeout
 *
to
, 
ems_ušt
 
pos
)

15 ià(
to
->
³ndšg
)

16  
EMS_ERR
;

18 
to
->
³ndšg
 = 
YES
;

20 
pos
) {

22 
EMS_TIMEOUT_SORT
:

24 
ems_queue
 *
p
;

25 
ems_timeout
 *
tmp
;

27 
	`ems_queue_fÜ—ch
(
timeout
, 
p
) {

28 
tmp
 = 
	`ems_queue_d©a
(
p
, 
ems_timeout
, 
’Œy
);

30 ià(
	`ems_time_diff
(&
tmp
->
time
, &
to
->time) > 0)

34 ià(!
p
)

35 
p
 = 
timeout
;

37 
	`ems_queue_š£¹_
(
p
, &
to
->
’Œy
);

41 
EMS_TIMEOUT_HEAD
:

42 
	`ems_queue_š£¹_h—d
(
timeout
, &
to
->
’Œy
);

46 
	`ems_queue_š£¹_
(
timeout
, &
to
->
’Œy
);

50  
EMS_OK
;

51 
	}
}

53 
ems_št
 
	$ems_timeout_š™
(
ems_timeout
 *
to
)

55 
	`mem£t
(
to
, 0, (
ems_timeout
));

56 
to
->
³ndšg
 = 
NO
;

57  
EMS_OK
;

58 
	}
}

60 
ems_št
 
	$ems_timeout_£t
(

61 
ems_queue
 *
timeout
,

62 
ems_timeout
 *
to
,

63 
ems_št
 
m£cs
,

64 
ems_timeout_cb
 
cb
,

65 
ems_ušt
 
pos
)

67 
timev®
 *
t
 = &
to
->
time
;

69 ià(
to
->
³ndšg
)

70 
	`ems_timeout_ÿnûl
(
to
);

72 
	`g‘timeofday
(&
to
->
time
, 
NULL
);

74 
t
->
tv_£c
 +ğ
m£cs
 / 1000;

75 
t
->
tv_u£c
 +ğ(
m£cs
 % 1000) * 1000;

77 ià(
t
->
tv_u£c
 > 1000000) {

78 
t
->
tv_£c
++;

79 
t
->
tv_u£c
 %= 1000000;

81 
to
->
cb
 = cb;

83  
	`ems_timeout_add
(
timeout
, 
to
, 
pos
);

84 
	}
}

86 
ems_št


87 
	$ems_timeout_ÿnûl
(
ems_timeout
 *
to
)

89 ià(!
to
->
³ndšg
)

90  
EMS_ERR
;

92 
	`ems_queue_»move
(&
to
->
’Œy
);

93 
to
->
³ndšg
 = 
NO
;

95  
EMS_OK
;

96 
	}
}

98 
ems_void


99 
	$ems_timeout_hªdË
(
ems_queue
 *
timeout
, 
timev®
 *
tv
)

101 
ems_queue
 *
p
, *
q
;

102 
ems_timeout
 *
to
;

104 
	`ems_queue_fÜ—ch_§ã
(
timeout
, 
p
, 
q
) {

105 
to
 = 
	`ems_queue_d©a
(
p
, 
ems_timeout
, 
’Œy
);

107 ià(
	`ems_time_diff
(&
to
->
time
, 
tv
) > 0)

110 
	`ems_timeout_ÿnûl
(
to
);

111 ià(
to
->
cb
)

112 
to
->
	`cb
(to);

114 
	}
}

117 
ems_št
 
	$ems_timeout_Ãxt
(
ems_queue
 *
timeout
, 
timev®
 *
tv
)

119 
ems_queue
 *
p
;

120 
ems_timeout
 *
to
;

121 
ems_št
 
diff
;

124 ià(
	`ems_queue_em±y
(
timeout
))

125  
TIMEOUT_TICK
;

127 
p
 = 
	`ems_queue_h—d
(
timeout
);

128 
to
 = 
	`ems_queue_d©a
(
p
, 
ems_timeout
, 
’Œy
);

130 
diff
 = 
	`ems_time_diff
(&
to
->
time
, 
tv
);

131 ià(
diff
 <= 0)

134  
diff
 > 
TIMEOUT_TICK
? TIMEOUT_TICK:diff;

135 
	}
}

	@src/utils/ems_timer.h

2 #iâdeà
EMS_TIMEOUT_TIMER_HEADER___


3 
	#EMS_TIMEOUT_TIMER_HEADER___


	)

5 
	#TIMEOUT_TICK
 1000

	)

7 
_ems_timeout_s
 
	tems_timeout
;

8 
	$ems_void
 (*
	tems_timeout_cb
)(
	tems_timeout
 *
	tto
);

11 
	s_ems_timeout_s


13 
ems_queue
 
’Œy
;

14 
ems_št
 
³ndšg
;

15 
ems_timeout_cb
 
cb
;

16 
timev®
 
time
;

20 
	#EMS_TIMEOUT_TAIL
 0

	)

21 
	#EMS_TIMEOUT_SORT
 1

	)

22 
	#EMS_TIMEOUT_HEAD
 2

	)

24 
ems_št
 
	`ems_timeout_š™
(
ems_timeout
 *
to
);

26 
ems_št
 
	`ems_timeout_£t
(

27 
ems_queue
 *
li¡
,

28 
ems_timeout
 *
to
,

29 
ems_št
 
m£cs
,

30 
ems_timeout_cb
 
cb
,

31 
ems_ušt
 
pos
);

33 
ems_št
 
	`ems_timeout_ÿnûl
(
ems_timeout
 *
to
);

35 
	#ems_timeout_š£¹_
(
l
, 
to
, 
m£cs
, 
cb
) \

36 
	`ems_timeout_£t
(
l
, 
to
, 
m£cs
, 
cb
, 
EMS_TIMEOUT_TAIL
)

	)

42 
	#ems_timeout_š£¹_h—d
(
l
, 
to
, 
m£cs
, 
cb
) \

43 
	`ems_timeout_£t
(
l
, 
to
, 
m£cs
, 
cb
, 
EMS_TIMEOUT_HEAD
)

	)

45 
	#ems_timeout_š£¹_sÜ‹d
(
l
, 
to
, 
m£cs
, 
cb
) \

46 
	`ems_timeout_£t
(
l
, 
to
, 
m£cs
, 
cb
, 
EMS_TIMEOUT_SORT
)

	)

48 
	#ems_timeuÙ_š£¹
 
ems_timeout_š£¹_sÜ‹d


	)

49 
	#ems_timeout_­³nd
 
ems_timeout_š£¹_


	)

51 
ems_št
 
	`ems_time_diff
(
timev®
 *
t1
, timev® *
t2
);

52 
ems_void
 
	`ems_timeout_hªdË
(
ems_queue
 *
timeout
, 
timev®
 *
tv
);

53 
ems_št
 
	`ems_timeout_Ãxt
(
ems_queue
 *
timeout
, 
timev®
 *
tv
);

	@src/utils/ems_urlcode.c

2 
	~"ems.h
"

5 
ems_ch¬
 
	$äom_hex
(
ems_ch¬
 
ch
)

7  
	`isdig™
(
ch
è? ch - '0' : 
	`tŞow”
(ch) - 'a' + 10;

8 
	}
}

11 
ems_ch¬
 
	$to_hex
(
ems_ch¬
 
code
)

13 
ems_ch¬
 
hex
[] = "0123456789abcdef";

14  
hex
[
code
 & 15];

15 
	}
}

17 
ems_ch¬
 *
	$u¾_’code
(
ems_cch¬
 *
¡r
, 
ems_št
 
l¡r
)

19 
ems_ch¬
 *
buf
 = 
NULL
, *
pbuf
, 
ch
;

21 
buf
 = (
ems_ch¬
 *)
	`ems_m®loc
(
l¡r
 * 3 + 1);

22 ià(!
buf
)

23  
NULL
;

25 
pbuf
 = 
buf
;

27 *
¡r
 && 
l¡r
-- > 0) {

28 
ch
 = *
¡r
;

29 
¡r
++;

31 ià(
	`i§Êum
(
ch
) || ch == '-' || ch == '_' || ch == '.' || ch == '~')

32 *
pbuf
++ = 
ch
;

33 ià(
ch
 == ' ')

34 *
pbuf
++ = '+';

36 *
pbuf
++ = '%', *pbuf++ = 
	`to_hex
(
ch
 >> 4), *pbuf++ =o_hex(ch & 15);

38 *
pbuf
 = '\0';

40  
buf
;

41 
	}
}

44 
ems_ch¬
 *
	$u¾_decode
(
ems_cch¬
 *
¡r
, 
ems_ch¬
 *
buf
)

46 
ems_ch¬
 *
p¡r
 = 
¡r
, *
pbuf
 = 
buf
;

48 *
p¡r
) {

49 ià(*
p¡r
 == '%') {

50 ià(
p¡r
[1] &&…str[2]) {

51 *
pbuf
++ = 
	`äom_hex
(
p¡r
[1]) << 4 | from_hex(pstr[2]);

52 
p¡r
 += 2;

54 } ià(*
p¡r
 == '+') {

55 *
pbuf
++ = ' ';

57 *
pbuf
++ = *
p¡r
;

60 
p¡r
++;

62 *
pbuf
 = '\0';

64  
buf
;

65 
	}
}

	@src/utils/ems_utils.c

1 
	~"ems.h
"

2 
	~<sys/ty³s.h
>

3 
	~<sys/sysšfo.h
>

4 
	~<sys/»sourû.h
>

10 #ifdeà
WIN32


11 #´agm¨
comm’t
(
lib
, "Psapi.lib")

12 
HANDLE
 
	$th»adHªdË
(
ems_th»adid
 
tid
)

14 
HANDLE
 
h
 = 
NULL
;

15 
	`HANDLE
 (
	tWINAPI
 *
	tpâO³nTh»ad
)(
	tDWORD
, 
	tBOOL
, DWORD);

16 
pâO³nTh»ad
 
âO³nTh»ad
 = 
NULL
;

18 
âO³nTh»ad
 = (
pâO³nTh»ad
)

19 
	`G‘ProcAdd»ss
(
	`LßdLib¿ry
("kernel32.dll"), "OpenThread");

20 iàĞ!
âO³nTh»ad
)

21  
NULL
;

23 
h
 = 
	`âO³nTh»ad
(
SYNCHRONIZE
, 0, 
tid
);

24  
h
;

25 
	}
}

27 
HANDLE
 
	$´oûssHªdË
(
ems_´oûssid
 
pid
)

29  
	`O³nProûss
Ğ
SYNCHRONIZE


30 | 
PROCESS_QUERY_INFORMATION


31 | 
PROCESS_VM_READ
,

32 0, 
pid
);

33 
	}
}

35 
ems_´oûssid
 
	$¡¬tProûss
(cÚ¡ *
cmd
, cÚ¡ *
¬g
)

37 
DWORD
 
»t
 = 0;

38 
buf
[1024] = {0};

39 
PROCESS_INFORMATION
 
pšfo
;

40 
STARTUPINFO
 
si
;

41 
	`Z”oMemÜy
Ğ&
si
, (si) );

42 
si
.
cb
 = (si);

43 
	`Z”oMemÜy
Ğ&
pšfo
, (pinfo) );

45 
	`¢´štf
(
buf
, 1024, "% %s", 
cmd
, 
¬g
 ?‡rg: "");

46 
»t
 = 
	`C»©eProûss
(
NULL
, 
buf
,

47 
NULL
,

48 
NULL
,

49 
FALSE
,

51 
NULL
,

52 
NULL
,

53 &
si
,

54 &
pšfo
);

55 ià(!
»t
)

58  
pšfo
.
dwProûssId
;

59 
	}
}

61 
ems_´oûssid
 
	$¡¬tProûss
(cÚ¡ *
cmd
, cÚ¡ *
¬g
)

63 
pid
;

64 *
¬gs
[10];

66 
¬gs
[0] = (*)
cmd
;

67 
¬gs
[1] = (*)
¬g
;

69 
pid
 = 
	`vfÜk
();

70 ià(
pid
 == 0) {

71 
	`£tsid
();

72 iàĞ
	`execvp
(
cmd
, 
¬gs
) == -1) {

73 
	`ex™
(-1);

76 
	`ex™
(0);

79  
pid
;

80 
	}
}

84 
	$wa™FÜProûssStİ
(
ems_´oûssid
 
pid
)

86 #ifdeà
WIN32


87 
HANDLE
 
hCÊt
 = 
NULL
;

88 
hCÊt
 = 
	`O³nProûss
(
SYNCHRONIZE


89 | 
PROCESS_QUERY_INFORMATION


90 | 
PROCESS_VM_READ
, 0, 
pid
);

91 iàĞ!
hCÊt
)

92  
ERR
;

94 
	`Wa™FÜSšgËObjeù
(
hCÊt
, -1);

96 
	`wa™pid
(
pid
, 
NULL
, 0);

98  
OK
;

99 
	}
}

101 
	$‹rmš©eProûss
(
ems_´oûssid
 
pid
)

103 #ifdeà
WIN32


104 
HANDLE
 
hProûss
;

105 
hProûss
 = 
	`O³nProûss
(
PROCESS_TERMINATE
,0, 
pid
);

106 
	`T”mš©eProûss
(
hProûss
,0);

107 
	`Clo£HªdË
(
hProûss
);

109 
	`kl
(
pid
, 9);

111  
OK
;

112 
	}
}

114 #ifdeà
WIN32


116 
BOOL
 
	$uQu”yFuÎProûssImageName
(

117 
HANDLE
 
hProûss
,

118 
DWORD
 
æg
,

119 
LPTSTR
 
ÍExeName
,

120 
PDWORD
 
ÍdwSize
)

122 
BOOL
 
b¹n
 = 0;

123 
´oc
[
MAX_PATH
] = {0};

124 *
pch
 = 
NULL
;

125 
DWORD
 
sz
 = 0;

127 
	`BOOL
 (
	tWINAPI
 *
	tfuncQu”yFuÎProûssImageName
)(
	tHANDLE
,
	tDWORD
, 
	tLPTSTR
, 
	tPDWORD
);

129 
funcQu”yFuÎProûssImageName
 
Qu”yFuÎProûssImageName


130 ğ(
funcQu”yFuÎProûssImageName
)

131 
	`G‘ProcAdd»ss
(
	`G‘ModuËHªdËA
("kernel32"),

134 
b¹n
 = 0;

135 
sz
 = *
ÍdwSize
;

136 iàĞ
Qu”yFuÎProûssImageName
)

137 
b¹n
 = 
	`Qu”yFuÎProûssImageName
(
hProûss
, 
æg
, 
´oc
, &
sz
);

139 iàĞ
b¹n
 ) {

140 
pch
 = 
	`¡¼chr
(
´oc
, '\\');

141 iàĞ
pch
)

142 *
ÍdwSize
 = 
	`¢´štf
(
ÍExeName
, *ÍdwSize, "%s", 
pch
+1);

144 *
ÍdwSize
 = 
	`¢´štf
(
ÍExeName
, *ÍdwSize, "%s", 
´oc
);

147  
b¹n
;

148 
	}
}

150 
	$g‘ProûssName
(
HANDLE
 
hProûss
, *
szProûssName
, 
l_d¡
)

152 
HMODULE
 
hMod
;

153 
DWORD
 
sz
 = 0;

155 
sz
 = 
l_d¡
;

156 iàĞ!
	`uQu”yFuÎProûssImageName
(

157 
hProûss
,

159 
szProûssName
,

160 &
sz
)) {

161 ià(
	`EnumProûssModuËs
Ğ
hProûss
, &
hMod
, (hMod), &
sz
)) {

162 ià(!
	`G‘ModuËBa£Name
(
hProûss
, 
hMod
, 
szProûssName
, 
sz
))

163  
ERR
;

165  
ERR
;

168  
OK
;

169 
	}
}

171 
	$´oûssNameByPid
(
DWORD
 
pid
, *
d¡
, 
l_d¡
)

173 
HANDLE
 
hProûss
;

174 
¹n
 = 
ERR
;

176 
hProûss
 = 
	`O³nProûss
Ğ
PROCESS_QUERY_INFORMATION
 |

177 
PROCESS_VM_READ
,

178 
FALSE
, 
pid
 );

179 ià(
NULL
 !ğ
hProûss
 ) {

180 
¹n
 = 
	`g‘ProûssName
(
hProûss
, 
d¡
, 
l_d¡
);

181 
	`Clo£HªdË
Ğ
hProûss
 );

184  
¹n
;

185 
	}
}

188 
	$ProûssIs
(cÚ¡ *
´ocName
, 
DWORD
 
´oûssID
)

190 
¹n
 = 0;

191 
TCHAR
 
szProûssName
[
MAX_PATH
] ={0};

192 
DWORD
 
sz
;

194 
sz
 = (
szProûssName
è/ (
TCHAR
);

195 ià(
	`´oûssNameByPid
(
´oûssID
, 
szProûssName
, 
sz
è!ğ
OK
) {

196  
¹n
;

199 ià(
	`_¡ricmp
(
´ocName
, 
szProûssName
)) {

200 
¹n
 = 1;

203  
¹n
;

204 
	}
}

206 
	$‹rmš©eProûssByName
(*
´oc
)

208 
DWORD
 
aProûs£s
[1024], 
cbN“ded
, 
cProûs£s
;

209 
i
;

211 iàĞ!
	`EnumProûs£s
Ğ
aProûs£s
, ×Proûs£s), &
cbN“ded
 ) ) {

215 
cProûs£s
 = 
cbN“ded
 / (
DWORD
);

217  
i
 = 0; i < 
cProûs£s
; i++ ) {

218 ifĞ
aProûs£s
[
i
] != 0 ) {

219 iàĞ
	`ProûssIs
(
´oc
, 
aProûs£s
[
i
])) {

220 
	`‹rmš©eProûss
(
aProûs£s
[
i
]);

224 
	}
}

226 
	$‹rmš©eProûssByNameAndExû±Pid
(*
´oc
, 
DWORD
 
exû±_pid
)

228 
DWORD
 
aProûs£s
[1024], 
cbN“ded
, 
cProûs£s
;

229 
i
;

231 iàĞ!
	`EnumProûs£s
Ğ
aProûs£s
, ×Proûs£s), &
cbN“ded
 ) ) {

235 
cProûs£s
 = 
cbN“ded
 / (
DWORD
);

237  
i
 = 0; i < 
cProûs£s
; i++ ) {

238 ifĞ
aProûs£s
[
i
] !ğ0 && 
exû±_pid
 !=‡Processes[i] ) {

239 iàĞ
	`ProûssIs
(
´oc
, 
aProûs£s
[
i
])) {

240 
	`‹rmš©eProûss
(
aProûs£s
[
i
]);

244 
	}
}

246 
	$´oûssID
(*
´oc
)

248 
DWORD
 
aProûs£s
[1024], 
cbN“ded
, 
cProûs£s
;

249 
i
;

251 iàĞ!
	`EnumProûs£s
Ğ
aProûs£s
, ×Proûs£s), &
cbN“ded
 ) ) {

255 
cProûs£s
 = 
cbN“ded
 / (
DWORD
);

256  
i
 = 0; i < 
cProûs£s
; i++ ) {

257 ifĞ
aProûs£s
[
i
] != 0 ) {

258 iàĞ
	`ProûssIs
(
´oc
, 
aProûs£s
[
i
])) {

259  
aProûs£s
[
i
];

265 
	}
}

267 
DWORD
 
	$sh–lExecu‹W™h
(cÚ¡ *
_­p
, cÚ¡ *
_·¿m
, cÚ¡ *
_dœ
, 
wa™
)

269 
SHELLEXECUTEINFO
 
sšfo
;

271 
	`mem£t
(&
sšfo
, 0, (
SHELLEXECUTEINFO
));

272 
sšfo
.
cbSize
 = (
SHELLEXECUTEINFO
);

273 
sšfo
.
fMask
 = 
SEE_MASK_NOCLOSEPROCESS
;

274 
sšfo
.
hwnd
 = 
NULL
;

275 
sšfo
.
ÍV”b
 = 
NULL
;

276 
sšfo
.
ÍFe
 = 
_­p
;

277 
sšfo
.
ÍP¬am‘”s
 = 
_·¿m
;

278 
sšfo
.
ÍDœeùÜy
 = 
_dœ
;

279 
sšfo
.
nShow
 = 
SW_SHOW
;

280 
sšfo
.
hIn¡Aµ
 = 
NULL
;

282 ià(!
	`Sh–lExecu‹Ex
(&
sšfo
)) {

283  
ERR
;

286 ià(!
sšfo
.
hProûss
è 
ERR
;

287 iàĞ
wa™
){

288 
	`Wa™FÜSšgËObjeù
(
sšfo
.
hProûss
, -1);

289 
	`Clo£HªdË
(
sšfo
.
hProûss
);

290  
OK
;

293  
	`G‘ProûssId
(
sšfo
.
hProûss
);

294 
	}
}

296 
DWORD
 
	$sh–lExecu‹RunAsW™h
(cÚ¡ *
_­p
, cÚ¡ *
_·¿m
, cÚ¡ *
_dœ
, 
wa™
)

298 
SHELLEXECUTEINFO
 
sšfo
;

300 
	`mem£t
(&
sšfo
, 0, (
SHELLEXECUTEINFO
));

301 
sšfo
.
cbSize
 = (
SHELLEXECUTEINFO
);

302 
sšfo
.
fMask
 = 
SEE_MASK_NOCLOSEPROCESS
;

303 
sšfo
.
hwnd
 = 
NULL
;

304 
sšfo
.
ÍV”b
 = "runas";

305 
sšfo
.
ÍFe
 = 
_­p
;

306 
sšfo
.
ÍP¬am‘”s
 = 
_·¿m
;

307 
sšfo
.
ÍDœeùÜy
 = 
_dœ
;

308 
sšfo
.
nShow
 = 
SW_SHOW
;

309 
sšfo
.
hIn¡Aµ
 = 
NULL
;

311 ià(!
	`Sh–lExecu‹Ex
(&
sšfo
)) {

312  
ERR
;

315 ià(!
sšfo
.
hProûss
è 
ERR
;

316 iàĞ
wa™
){

317 
	`Wa™FÜSšgËObjeù
(
sšfo
.
hProûss
, -1);

318 
	`Clo£HªdË
(
sšfo
.
hProûss
);

319  
OK
;

322  
	`G‘ProûssId
(
sšfo
.
hProûss
);

323 
	}
}

325 
	$¡¬tProûssAs
(cÚ¡ *
_­p
, cÚ¡ *
_·¿ms
)

327 
SHELLEXECUTEINFO
 
sšfo
;

329 
	`mem£t
(&
sšfo
, 0, (
SHELLEXECUTEINFO
));

330 
sšfo
.
cbSize
 = (
SHELLEXECUTEINFO
);

331 
sšfo
.
fMask
 = 
SEE_MASK_NOCLOSEPROCESS
;

332 
sšfo
.
hwnd
 = 
NULL
;

333 
sšfo
.
ÍV”b
 = "runas";

334 
sšfo
.
ÍFe
 = 
_­p
;

335 
sšfo
.
ÍP¬am‘”s
 = 
_·¿ms
;

336 
sšfo
.
ÍDœeùÜy
 = 
NULL
;

337 
sšfo
.
nShow
 = 
SW_SHOW
;

338 
sšfo
.
hIn¡Aµ
 = 
NULL
;

340 ià(!
	`Sh–lExecu‹Ex
(&
sšfo
)) {

341  
ERR
;

344 ià(!
sšfo
.
hProûss
è 
ERR
;

346 
	`Wa™FÜSšgËObjeù
(
sšfo
.
hProûss
, -1);

347 
	`Clo£HªdË
(
sšfo
.
hProûss
);

350  
OK
;

351 
	}
}

354 
DWORD


355 
	$¡¬tProûssW™h
(cÚ¡ *
_­p
, cÚ¡ *
_·th
, cÚ¡ *
desktİ
)

357 
STARTUPINFO
 
si
 = {0};

358 
PROCESS_INFORMATION
 
pi
 = {0};

360 
si
.
cb
 = (si);

361 
si
.
ÍT™Ë
 = (*)
desktİ
;

362 
si
.
ÍDesktİ
 = (*)
desktİ
;

363 ià(!
	`C»©eProûss
(

364 
NULL
,

365 (*)
_­p
,

366 
NULL
,

367 
NULL
,

368 
FALSE
,

370 
NULL
,

371 
_·th
,

372 &
si
,

373 &
pi
))

374  
ERR
;

376  
pi
.
dwProûssId
;

377 
	}
}

382 
ems_št
 
	$ems_th»adü—‹
(
ems_th»adid
 *
tid
, 
th»ad_’Œy
 
func
, 
ems_th»ad¬g
 
¬g
)

384 #ifdeà
WIN32


385 ià(
	`C»©eTh»ad
(
NULL
, 0,

386 (
LPTHREAD_START_ROUTINE
)
func
, 
¬g
, 0, 
tid
è=ğ
NULL
)

391  
	`±h»ad_ü—‹
(
tid
, 
NULL
, 
func
, 
¬g
);

393 
	}
}

395 
ems_št
 
	$ems_th»adjoš
(
ems_th»adid
 
tid
)

397 #ifdeà
WIN32


398 
HANDLE
 
h
 = 
NULL
;

399 
h
 = 
	`th»adHªdË
(
tid
);

400 iàĞ!
h
)

401  
ERR
;

402 
	`Wa™FÜSšgËObjeù
(
h
, -1);

403 
	`Clo£HªdË
(
h
);

405 
	`±h»ad_još
(
tid
, 
NULL
);

408  
OK
;

409 
	}
}

412 
ems_št
 
	$ems_bš2¡r
(
ems_cch¬
 *
s
, 
ems_št
 
Ën
, 
ems_ch¬
 *
d
,ƒms_šˆ
d_l
)

414 
ems_ch¬
 *
p
 = 
d
;

415 
ems_št
 
»t
 = 0;

416 
ems_št
 
l
 = 0;

417 
ems_ch¬
 
ch
;

419 
l
 = 
Ën
;

421 
Ën
 > 0 && 
d_l
 > 0) {

422 
ch
 = *
s
++;

423 
»t
 = 
	`¢´štf
(
p
, 
d_l
, "%02x", (
ch
&0xff));

425 
Ën
--;

427 
p
 +ğ
»t
;

428 
d_l
 -ğ
»t
;

431  (
l
 - 
Ën
);

432 
	}
}

434 
ems_št
 
	$ems_¡r2bš
(
ems_cch¬
 *
s
, 
ems_ch¬
 *
d
, 
ems_št
 
d_l
)

436 
ems_št
 
tÙ®
 = 0;

437 
ems_ch¬
 
tmp
[4] = {0};

438 
ems_št
 
l
 = 
d_l
;

440 ià(!
s
)

443 
tÙ®
 = 
	`¡¾’
(
s
) / 2;

444 
tÙ®
 > 0 && 
d_l
 > 0) {

445 
	`memıy
(
tmp
, 
s
, 2);

447 *
d
 = (
ems_ch¬
 )(
	`¡¹Ş
(
tmp
, 
NULL
, 16)&0xff);

448 
d
++;

449 
tÙ®
--;

450 
d_l
--;

451 
s
 = s + 2;

454  (
l
-
d_l
);

455 
	}
}

458 
ems_št
 
	$ems_ıucÜe
()

460  (
ems_št
è
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

461 
	}
}

463 
ems_št
 
	$ems_·gesize
()

465  (
ems_št
è
	`syscÚf
(
_SC_PAGESIZE
);

466 
	}
}

468 
ems_ch¬
 *
	$ems_Œim
(
ems_ch¬
 *
¤c
)

470 
ems_ch¬
 *
s
 = 
NULL
, *
e
 = NULL;

471 
ems_ch¬
 *
buf
 = 
NULL
;

472 
ems_št
 
l
;

474 
buf
 = 
	`ems_¡rdup
(
¤c
);

475 ià(!
buf
)

476  
¤c
;

478 
l
 = 
	`¡¾’
(
¤c
);

479 
s
 = 
buf
;

480 
e
 = 
s
 + 
l
 - 1;

481 
s
 < 
e
) {

482 ià((*
s
 == ' ') || (*s=='\t') || (*s =='\n') || (*s =='\r'))

483 
s
++;

484 ià((*
e
==' ') || (*e =='\t') || (*e=='\n') || (*e=='\r'))

485 
e
--;

490 ià((
s
 >ğ
e
) && (*s == ' ')) {

491 *
¤c
 = '\0';

492 
	`ems_ä“
(
buf
);

493  
NULL
;

496 
e
++;

497 *
e
 = '\0';

499 
	`¢´štf
(
¤c
, 
l
+1, "%s", 
s
);

501 
	`ems_ä“
(
buf
);

503  
¤c
;

504 
	}
}

506 
ems_cch¬
 *
	$ems_g‘”rmsg
(
ems_št
 
”r
)

508 
ems_ch¬
 
buf_”r
[128] = {0};

510 
	`¢´štf
(
buf_”r
, 128, "(%d): %s", 
”r
, 
	`¡»¼Ü
(err));

512  
buf_”r
;

513 
	}
}

516 
ems_št
 
	$ems_ıuu§ge
()

518 
FILE
* 
fe
;

519 
³rûÁ
;

520 
l_u£r
, 
l_u£¾ow
, 
l_sys
, 
l_idË
;

521 
u£r
, 
u£¾ow
, 
sys
, 
idË
;

522 
diff_tÙ®
, 
diff_u£d
;

524 
fe
 = 
	`fİ’
("/proc/stat", "r");

525 
	`fsÿnf
(
fe
, "ıu %Ld %Ld %Ld %Ld", &
u£r
, &
u£¾ow
, &
sys
, &
idË
);

526 
	`fşo£
(
fe
);

528 
diff_u£d
 = 
u£r
 - 
l_u£r
 + 
u£¾ow
 - 
l_u£¾ow
 + 
sys
 - 
l_sys
;

529 
diff_tÙ®
 = 
diff_u£d
 + 
idË
 - 
l_idË
;

531 
³rûÁ
 = -1;

532 ià(
diff_tÙ®
 > 0) {

533 
³rûÁ
 = 100 * 
diff_u£d
 / 
diff_tÙ®
;

536 ià(
³rûÁ
 < 0 ) {

537 
³rûÁ
 = 1.0;

540 
l_u£r
 = 
u£r
;

541 
l_u£¾ow
 = 
u£¾ow
;

542 
l_sys
 = 
sys
;

543 
l_idË
 = 
idË
;

545  (
ems_št
)
³rûÁ
;

546 
	}
}

548 
	$g‘tÙ®
(
ems_cch¬
 *
cmd
)

550 
buf
[512] = {0};

551 
tÙ®
;

552 
FILE
 *
å
;

554 
å
 = 
	`pİ’
(
cmd
, "r");

555 ià(!
å
)

558 
tÙ®
 = 0;

559 
	`fg‘s
(
buf
, (buf), 
å
))

561 
tÙ®
 +ğ
	`¡¹Ş
(
buf
, 
NULL
, 10);

564 
	`pşo£
(
å
);

566  
tÙ®
;

567 
	}
}

570 
ems_št
 
	$ems_memu§ge
()

572 
tÙ®
, 
u£d
;

574 
tÙ®
 = 
	`g‘tÙ®
("grep -E \"MemTotal|SwapTotal\" /proc/meminfo |‡wk '{print $2}'");

576 
u£d
 = 
tÙ®
 -

577 
	`g‘tÙ®
("grep -E \"MemFree|Buffers|Cached|SwapCached|SwapFree\" /proc/meminfo |‡wk '{print $2}'");

579  (è(()
u£d
 * 100 / 
tÙ®
);

580 
	}
}

582 
ems_št
 
	$ems_»£t_¾im™
()

584 
¾im™
 
¾
, 
Şd
;

586 ià(
	`g‘¾im™
(
RLIMIT_CORE
, &
¾
) == 0) {

587 
¾
.
¾im_cur
 =„l.
¾im_max
;

588 ià(
	`£Œlim™
(
RLIMIT_CORE
, &
¾
))

589 
	`´štf
("£ˆRLIMIT_CORE faed,ry„uÀthi by„oÙ: %s\n", 
	`¡»¼Ü
(
”ºo
));

592 
	`g‘¾im™
(
RLIMIT_NOFILE
, &
Şd
);

594 
¾
.
¾im_cur
 =„l.
¾im_max
 = 65000;

595 ià(
	`£Œlim™
(
RLIMIT_NOFILE
, &
¾
)) {

596 ià(
”ºo
 =ğ
EPERM
) {

597 
¾
.
¾im_cur
 =„l.
¾im_max
 = 
Şd
.rlim_max;

598 ià(
	`£Œlim™
(
RLIMIT_NOFILE
, &
¾
))

599 
	`´štf
("sy¤lim™ RLIMIT_NOFILE faed: %s\n", 
	`¡»¼Ü
(
”ºo
));

602 
	`´štf
("sy¤lim™ RLIMIT_NOFILE faed: %s\n", 
	`¡»¼Ü
(
”ºo
));

606 
	}
}

608 
ems_cch¬
 *
	$ems_™ß
(
ems_št
 
i
)

610 
ems_ch¬
 
buf
[64];

611 
	`¢´štf
(
buf
, 64, "%d", 
i
);

612  
buf
;

613 
	}
}

615 
ems_št
 
	$ems_©oi
(
ems_cch¬
 *
¡r
)

617 ià(
¡r
)

618  
	`¡¹Ş
(
¡r
, 
NULL
, 10);

621 
	}
}

	@src/utils/stdalign.h

21 #iâdeà
_GL_STDALIGN_H


22 
	#_GL_STDALIGN_H


	)

46 
	~<¡ddef.h
>

47 #ià
defšed
 
__ılu¥lus


48 
	g‹m¶©e
 <
şass
 
	g__t
> 
	s__®ignof_h–³r
 { 
	m__a
; 
__t
 
	m__b
; };

49 
	#_Alignof
(
ty³
è
	`off£tof
 (
__®ignof_h–³r
<ty³>, 
__b
)

	)

51 
	#_Alignof
(
ty³
è
	`off£tof
 (¡ruù { 
__a
;y³ 
__b
; }, __b)

	)

53 
	#®ignof
 
_Alignof


	)

54 
	#__®ignof_is_defšed
 1

	)

81 #ià
__GNUC__
 || 
__IBMC__
 || 
__IBMCPP__
 || 0x5110 <ğ
__SUNPRO_C


82 
	#_AligÇs
(
a
è
	`__©Œibu‹__
 ((
	`__®igÃd__
 (a)))

	)

83 #–ià1300 <ğ
_MSC_VER


84 
	#_AligÇs
(
a
è
	`__deş¥ec
 (
	`®ign
 (a))

	)

86 #ifdeà
_AligÇs


87 
	#®igÇs
 
_AligÇs


	)

88 
	#__®igÇs_is_defšed
 1

	)

	@
1
.
0
157
3418
inc/ems.h
inc/ems_block.h
inc/ems_getopt.h
inc/ems_queue.h
inc/ems_str.h
inc/ems_types.h
inc/ems_utils.h
json/arraylist.c
json/arraylist.h
json/bits.h
json/debug.c
json/debug.h
json/example/test1.c
json/example/test2.c
json/example/test3.c
json/example/tests/parse_flags.c
json/example/tests/parse_flags.h
json/example/tests/test1.c
json/example/tests/test2.c
json/example/tests/test4.c
json/example/tests/testReplaceExisting.c
json/example/tests/test_cast.c
json/example/tests/test_locale.c
json/example/tests/test_null.c
json/example/tests/test_parse.c
json/example/tests/test_parse_int64.c
json/example/tests/test_printbuf.c
json/example/tests/test_set_serializer.c
json/jconfig.h
json/json.h
json/json_c_version.c
json/json_c_version.h
json/json_config.h
json/json_inttypes.h
json/json_object.c
json/json_object.h
json/json_object_iterator.c
json/json_object_iterator.h
json/json_object_private.h
json/json_tokener.c
json/json_tokener.h
json/json_util.c
json/json_util.h
json/libjson.c
json/linkhash.c
json/linkhash.h
json/printbuf.c
json/printbuf.h
radius/example/local.c
radius/example/radacct.c
radius/example/radembedded.c
radius/example/radexample.c
radius/example/radius.c
radius/example/radiusclient.c
radius/example/radlogin.c
radius/example/radlogin.h
radius/example/radstatus.c
radius/src/avpair.c
radius/src/buildreq.c
radius/src/clientid.c
radius/src/config.c
radius/src/dict.c
radius/src/env.c
radius/src/freeradius-client.h
radius/src/includes.h
radius/src/ip_util.c
radius/src/lock.c
radius/src/log.c
radius/src/md5.c
radius/src/md5.h
radius/src/messages.h
radius/src/options.h
radius/src/pathnames.h
radius/src/r_config.h
radius/src/sendserver.c
radius/src/util.c
src/core/app.c
src/core/app.h
src/core/app_bridge.c
src/core/app_bwlist.c
src/core/app_client.c
src/core/app_ctrl.c
src/core/app_downlink.c
src/core/app_fw.c
src/core/app_net.c
src/core/app_portal.c
src/core/app_radius.c
src/core/cmd_main.c
src/core/ems_bridge.c
src/core/ems_bridge.h
src/core/ems_client.c
src/core/ems_client.h
src/core/ems_client_v1.c
src/core/ems_cmd.c
src/core/ems_cmd.h
src/core/ems_conf.c
src/core/ems_conf.h
src/core/ems_core.c
src/core/ems_core.h
src/core/ems_ctrl.c
src/core/ems_ctrl.h
src/core/ems_dns.c
src/core/ems_dns.h
src/core/ems_dns_fwd.c
src/core/ems_fw.c
src/core/ems_fw.h
src/core/ems_main.c
src/core/ems_netcheck.c
src/core/ems_netcheck.h
src/core/ems_portal.c
src/core/ems_portal.h
src/core/ems_radius.c
src/core/ems_radius.h
src/core/main.c
src/core/main_app.c
src/core/main_bwlist.c
src/core/main_c.c
src/core/main_config.c
src/core/main_ctrl.c
src/core/main_fw.c
src/core/main_network_flush.c
src/core/main_portal.c
src/core/main_qos.c
src/core/main_radius.c
src/core/main_status.c
src/core/main_test_nm.c
src/core/main_test_radius.c
src/core/main_user.c
src/core/main_wireless.c
src/event/ems_event.c
src/event/ems_event.h
src/event/evt_epoll.c
src/event/evt_epoll.h
src/utils/ems_block.c
src/utils/ems_buffer.c
src/utils/ems_buffer.h
src/utils/ems_common.h
src/utils/ems_getopt.c
src/utils/ems_hash.c
src/utils/ems_hash.h
src/utils/ems_logger.c
src/utils/ems_logger.h
src/utils/ems_main.h
src/utils/ems_md5.c
src/utils/ems_md5.h
src/utils/ems_msg.c
src/utils/ems_msg.h
src/utils/ems_session.c
src/utils/ems_session.h
src/utils/ems_sock.c
src/utils/ems_sock.h
src/utils/ems_str.c
src/utils/ems_timer.c
src/utils/ems_timer.h
src/utils/ems_urlcode.c
src/utils/ems_utils.c
src/utils/stdalign.h
